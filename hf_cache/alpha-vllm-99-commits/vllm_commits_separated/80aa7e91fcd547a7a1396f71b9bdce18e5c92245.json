{
  "commit_hash": "80aa7e91fcd547a7a1396f71b9bdce18e5c92245",
  "pr_url": "https://github.com/vllm-project/vllm/pull/4971",
  "pr_date": "2024-06-13",
  "timeline_text": "Copy link Member bigPYJ1151 commented May 22, 2024 This PR optimized CPU backend performance and added more performance tips. Optimized input shape of torch_sdpa to use fast code path for better TTFT (~40% reduction). Added tip and example to use TCMalloc, it will significantly improve the performance. Initially integrated Paged attention from Intel Extension for PyTorch. Updated related doc. PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 6 zhouyuan, jikunshang, DamonFool, WoosukKwon, AllenDou, and ivanbaldo reacted with thumbs up emoji ‚ù§Ô∏è 1 ivanbaldo reacted with heart emoji All reactions üëç 6 reactions ‚ù§Ô∏è 1 reaction bigPYJ1151 mentioned this pull request May 22, 2024 [RFC] Initial Support for CPUs #3654 Closed 4 tasks bigPYJ1151 force-pushed the ipex branch\n    from 382dd8a to 49924d7 Compare May 24, 2024 00:14 zhouyuan mentioned this pull request May 29, 2024 [CI/BUILD] enable intel queue for longer CPU tests #4113 Merged liangan1 mentioned this pull request May 31, 2024 [RFC] Speedup vLLM inference with Intel@ Extension for PyTorch* #2526 Closed bigPYJ1151 force-pushed the ipex branch\n      2 times, most recently\n    from 7acb607 to e7b7bb7 Compare June 4, 2024 06:07 bigPYJ1151 and others added 19 commits June 7, 2024 05:15 Add IPEX Paged Att. 980de13 Fix 648d4c0 Fix env cc00133 Refactor QKV shape in torch_sdpa to use fast code path. ‚Ä¶ 5e8b064 Co-authored-by: Jianan Gu <jianan.gu@intel.com> Refine 686a41b Update doc 706d14e Update docker image. 1647c27 Fix doc afe6262 trigger 76d319a trigger 62708ef fix f822617 Fix 5fffea9 Fix 0cda257 update b00a5a9 Fix ‚Ä¶ b88142a Fix\n\nFix\n\ntrigger Revert \"Fix\" ‚Ä¶ fea13c9 This reverts commit 58c036ad079bab6d4a7beccae735c096e2818e37. Revert \"Revert \"Fix\"\" ‚Ä¶ ce00ff0 This reverts commit 3861c15e282062c8c5165ce01aa93972280ca92a. Update IPEX 5779f70 update 3930932 bigPYJ1151 force-pushed the ipex branch\n    from e7b7bb7 to 3930932 Compare June 7, 2024 05:54 WoosukKwon added\n  the x86-cpu Related to Intel & AMD CPU label Jun 8, 2024 zhouyuan mentioned this pull request Jun 13, 2024 [Hardware][Intel] Support CPU inference with AVX2 ISA #5452 Merged Copy link Contributor zhouyuan commented Jun 13, 2024 @WoosukKwon Hi, gentle ping, could you please help to take a look on this patch when available? This patch has a big optimization for CPU backend thanks, -yuan üëç 1 WoosukKwon reacted with thumbs up emoji All reactions üëç 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . update torch 6c77c9e WoosukKwon self-assigned this Jun 13, 2024 WoosukKwon approved these changes Jun 13, 2024 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @bigPYJ1151 LGTM! Thanks for the PR and sorry for the delay. Left minor comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 zhouyuan reacted with thumbs up emoji All reactions üëç 1 reaction vllm/attention/backends/torch_sdpa.py Comment on lines +17 to +18 except ImportError: from vllm.attention.ops.paged_attn import PagedAttention Copy link Collaborator WoosukKwon Jun 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Can't we simply require users to use IPEX? In which case do we have to use the PagedAttention kernel in vLLM? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author bigPYJ1151 Jun 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yes, after the APIs in IPEX become stable we will add IPEX to the requirements so the users can use it directly. We want to leave the native kernel here to evaluate some latest features (e.g., 8bit KV cache) before the IPEX supports them and public release. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 ivanbaldo reacted with thumbs up emoji All reactions üëç 1 reaction Copy link Collaborator WoosukKwon Jun 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I see. Thanks! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions README.md Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/attention/ops/ipex_attn.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Update README.md ‚Ä¶ bdf030a Co-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon merged commit 80aa7e9 into vllm-project : main Jun 13, 2024 Copy link Contributor zhouyuan commented Jun 14, 2024 @WoosukKwon thank you for the review and merge, much appreciated! thanks, -yuan All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor DamonFool commented Jun 14, 2024 Hi @bigPYJ1151 , I tested the IPEX but seems no performance gain on CPU. Could you please tell us how can we test for the performance boost? Thanks. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jun 16, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( v‚Ä¶ ‚Ä¶ 45e1f25 ‚Ä¶llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> joerunde pushed a commit\n        to joerunde/vllm\n      that referenced\n      this pull request Jun 17, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( v‚Ä¶ ‚Ä¶ b51b458 ‚Ä¶llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jun 27, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( v‚Ä¶ ‚Ä¶ 5e1e448 ‚Ä¶llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> kzawora-intel added a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Jul 2, 2024 habana_main rebase ( #71 ) ‚Ä¶ 5e1a565 * [Hardware][Intel] Optimize CPU backend and add more performance tips ( vllm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\n\n* [Docs] Add 4th meetup slides ( vllm-project#5509 )\n\n* [Misc] Add vLLM version getter to utils ( vllm-project#5098 )\n\n* [CI/Build] Simplify OpenAI server setup in tests ( vllm-project#5100 )\n\n* [Doc] Update LLaVA docs ( vllm-project#5437 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Kernel] Factor out epilogues from cutlass kernels ( vllm-project#5391 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\n\n* [MISC] Remove FP8 warning ( vllm-project#5472 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* Seperate dev requirements into lint and test ( vllm-project#5474 )\n\n* Revert \"[Core] Remove unnecessary copies in flash attn backend\" ( vllm-project#5478 )\n\n* [misc] fix format.sh ( vllm-project#5511 )\n\n* [CI/Build] Disable test_fp8.py ( vllm-project#5508 )\n\n* [Kernel] Disable CUTLASS kernels for fp8 ( vllm-project#5505 )\n\n* Add `cuda_device_count_stateless` ( vllm-project#5473 )\n\n* [Hardware][Intel] Support CPU inference with AVX2 ISA ( vllm-project#5452 )\n\n* [Misc] Fix arg names in quantizer script ( vllm-project#5507 )\n\n* bump version to v0.5.0.post1 ( vllm-project#5522 )\n\n* [CI/Build][Misc] Add CI that benchmarks vllm performance on those PRs with `perf-benchmarks` label ( vllm-project#5073 )\n\nCo-authored-by: simon-mo <simon.mo@hey.com>\n\n* [CI/Build] Disable LLaVA-NeXT CPU test ( vllm-project#5529 )\n\n* [Kernel] Fix CUTLASS 3.x custom broadcast load epilogue ( vllm-project#5516 )\n\n* [Misc] Fix arg names ( vllm-project#5524 )\n\n* [ Misc ] Rs/compressed tensors cleanup ( vllm-project#5432 )\n\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\n\n* [Kernel] Suppress mma.sp warning on CUDA 12.5 and later ( vllm-project#5401 )\n\n* [mis] fix flaky test of test_cuda_device_count_stateless ( vllm-project#5546 )\n\n* [Core] Remove duplicate processing in async engine ( vllm-project#5525 )\n\n* [misc][distributed] fix benign error in `is_in_the_same_node` ( vllm-project#5512 )\n\n* [Docs] Add ZhenFund as a Sponsor ( vllm-project#5548 )\n\n* [Doc] Update documentation on Tensorizer ( vllm-project#5471 )\n\n* [Bugfix] Enable loading FP8 checkpoints for gpt_bigcode models  ( vllm-project#5460 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix typo in Pallas backend ( vllm-project#5558 )\n\n* [Core][Distributed] improve p2p cache generation ( vllm-project#5528 )\n\n* Add ccache to amd ( vllm-project#5555 )\n\n* [Core][Bugfix]: fix prefix caching for blockv2 ( vllm-project#5364 )\n\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\n\n* [mypy] Enable type checking for test directory ( vllm-project#5017 )\n\n* [CI/Build] Test both text and token IDs in batched OpenAI Completions API ( vllm-project#5568 )\n\n* [misc] Do not allow to use lora with chunked prefill. ( vllm-project#5538 )\n\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* add gptq_marlin test for bug report vllm-project#5088 ( vllm-project#5145 )\n\n* [BugFix] Don't start a Ray cluster when not using Ray ( vllm-project#5570 )\n\n* [Fix] Correct OpenAI batch response format ( vllm-project#5554 )\n\n* Add basic correctness 2 GPU tests to 4 GPU pipeline ( vllm-project#5518 )\n\n* [CI][BugFix] Flip is_quant_method_supported condition ( vllm-project#5577 )\n\n* [build][misc] limit numpy version ( vllm-project#5582 )\n\n* [Doc] add debugging tips for crash and multi-node debugging ( vllm-project#5581 )\n\n* Fix w8a8 benchmark and add Llama-3-8B ( vllm-project#5562 )\n\n* [Model] Rename Phi3 rope scaling type ( vllm-project#5595 )\n\n* Correct alignment in the seq_len diagram. ( vllm-project#5592 )\n\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\n\n* [Kernel] `compressed-tensors` marlin 24 support ( vllm-project#5435 )\n\n* [Misc] use AutoTokenizer for benchmark serving when vLLM not installed ( vllm-project#5588 )\n\n* [Hardware][Intel GPU] Add Intel GPU(XPU) inference backend ( vllm-project#3814 )\n\nCo-authored-by: Jiang Li <jiang1.li@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\n\n* [CI/BUILD] Support non-AVX512 vLLM building and testing ( vllm-project#5574 )\n\n* [CI] the readability of benchmarking and prepare for dashboard ( vllm-project#5571 )\n\n[CI] Improve the readability of performance benchmarking results and prepare for upcoming performance dashboard ( vllm-project#5571 )\n\n* [bugfix][distributed] fix 16 gpus local rank arrangement ( vllm-project#5604 )\n\n* [Optimization] use a pool to reuse LogicalTokenBlock.token_ids ( vllm-project#5584 )\n\n* [Bugfix] Fix KV head calculation for MPT models when using GQA ( vllm-project#5142 )\n\n* [Fix] Use utf-8 encoding in entrypoints/openai/run_batch.py ( vllm-project#5606 )\n\n* [Speculative Decoding 1/2 ] Add typical acceptance sampling as one of the sampling techniques in the verifier ( vllm-project#5131 )\n\n* [Model] Initialize Phi-3-vision support ( vllm-project#4986 )\n\n* [Kernel] Add punica dimensions for Granite 13b ( vllm-project#5559 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [misc][typo] fix typo ( vllm-project#5620 )\n\n* [Misc] Fix typo ( vllm-project#5618 )\n\n* [CI] Avoid naming different metrics with the same name in performance benchmark ( vllm-project#5615 )\n\n* [bugfix][distributed] improve p2p capability test ( vllm-project#5612 )\n\n[bugfix][distributed] do not error if two processes do not agree on p2p capability ( vllm-project#5612 )\n\n* [Misc] Remove import from transformers logging ( vllm-project#5625 )\n\n* [CI/Build][Misc] Update Pytest Marker for VLMs ( vllm-project#5623 )\n\n* [ci] Deprecate original CI template ( vllm-project#5624 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Add OpenTelemetry support ( vllm-project#4687 )\n\nThis PR adds basic support for OpenTelemetry distributed tracing.\nIt includes changes to enable tracing functionality and improve monitoring capabilities.\n\nI've also added a markdown with print-screens to guide users how to use this feature. You can find it here\n\n* [Misc] Add channel-wise quantization support for w8a8 dynamic per token activation quantization ( vllm-project#5542 )\n\n* [ci] Setup Release pipeline and build release wheels with cache ( vllm-project#5610 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Model] LoRA support added for command-r ( vllm-project#5178 )\n\n* [Bugfix] Fix for inconsistent behaviour related to sampling and repetition penalties  ( vllm-project#5639 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Doc] Added cerebrium as Integration option ( vllm-project#5553 )\n\n* [Bugfix] Fix CUDA version check for mma warning suppression ( vllm-project#5642 )\n\n* [Bugfix] Fix w8a8 benchmarks for int8 case ( vllm-project#5643 )\n\n* [Bugfix] Fix Phi-3 Long RoPE scaling implementation ( vllm-project#5628 )\n\n* [Bugfix] Added test for sampling repetition penalty bug. ( vllm-project#5659 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix][CI/Build][AMD][ROCm]Fixed the cmake build bug which generate garbage on certain devices ( vllm-project#5641 )\n\n* [misc][distributed] use 127.0.0.1 for single-node ( vllm-project#5619 )\n\n* [Model] Add FP8 kv cache for Qwen2 ( vllm-project#5656 )\n\n* [Bugfix] Fix sampling_params passed incorrectly in Phi3v example ( vllm-project#5684 )\n\n* [Misc]Add param max-model-len in benchmark_latency.py ( vllm-project#5629 )\n\n* [CI/Build] Add tqdm to dependencies ( vllm-project#5680 )\n\n* [ci] Add A100 queue into AWS CI template ( vllm-project#5648 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Frontend][Bugfix] Fix preemption_mode -> preemption-mode for CLI arg in arg_utils.py ( vllm-project#5688 )\n\n* [ci][distributed] add tests for custom allreduce ( vllm-project#5689 )\n\n* [Bugfix] AsyncLLMEngine hangs with asyncio.run ( vllm-project#5654 )\n\n* [Doc] Update docker references ( vllm-project#5614 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Misc] Add per channel support for static activation quantization; update w8a8 schemes to share base classes ( vllm-project#5650 )\n\n* [ci] Limit num gpus if specified for A100 ( vllm-project#5694 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Improve conftest ( vllm-project#5681 )\n\n* [Bugfix][Doc] FIx Duplicate Explicit Target Name Errors ( vllm-project#5703 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM90 ( vllm-project#5514 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Model] Port over CLIPVisionModel for VLMs ( vllm-project#5591 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM80 ( vllm-project#5275 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix] Fix the CUDA version check for FP8 support in the CUTLASS kernels ( vllm-project#5715 )\n\n* [Frontend] Add FlexibleArgumentParser to support both underscore and dash in names ( vllm-project#5718 )\n\n* [distributed][misc] use fork by default for mp ( vllm-project#5669 )\n\n* [Model] MLPSpeculator speculative decoding support ( vllm-project#4947 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\n\n* [Kernel] Add punica dimension for Qwen2 LoRA ( vllm-project#5441 )\n\n* [BugFix] Fix test_phi3v.py ( vllm-project#5725 )\n\n* [Bugfix] Add  fully sharded layer for QKVParallelLinearWithLora ( vllm-project#5665 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Core][Distributed] add shm broadcast ( vllm-project#5399 )\n\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Kernel][CPU] Add Quick `gelu` to CPU ( vllm-project#5717 )\n\n* [Doc] Documentation on supported hardware for quantization methods ( vllm-project#5745 )\n\n* [BugFix] exclude version 1.15.0 for modelscope ( vllm-project#5668 )\n\n* [ci][test] fix ca test in main ( vllm-project#5746 )\n\n* [LoRA] Add support for pinning lora adapters in the LRU cache ( vllm-project#5603 )\n\n* [CI][Hardware][Intel GPU] add Intel GPU(XPU) ci pipeline ( vllm-project#5616 )\n\n* [Model] Support Qwen-VL and Qwen-VL-Chat models with text-only inputs ( vllm-project#5710 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Remove vllm-project#4789 workaround left in vllm/entrypoints/openai/run_batch.py ( vllm-project#5756 )\n\n* [Bugfix] Fix pin_lora error in TPU executor ( vllm-project#5760 )\n\n* [Docs][TPU] Add installation tip for TPU ( vllm-project#5761 )\n\n* [core][distributed] improve shared memory broadcast ( vllm-project#5754 )\n\n* [BugFix] [Kernel] Add Cutlass2x fallback kernels ( vllm-project#5744 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Distributed] Add send and recv helpers ( vllm-project#5719 )\n\n* [Bugfix] Add phi3v resize for dynamic shape and fix torchvision requirement ( vllm-project#5772 )\n\n* [doc][faq] add warning to download models for every nodes ( vllm-project#5783 )\n\n* post-rebase api adjustments\n\n* [Doc] Add \"Suggest edit\" button to doc pages ( vllm-project#5789 )\n\n* [Doc] Add Phi-3-medium to list of supported models ( vllm-project#5788 )\n\n* [Bugfix] Fix FlexibleArgumentParser replaces _ with - for actual args ( vllm-project#5795 )\n\n* [ci] Remove aws template ( vllm-project#5757 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Doc] Add notice about breaking changes to VLMs ( vllm-project#5818 )\n\n* [Speculative Decoding] Support draft model on different tensor-parallel size than target model ( vllm-project#5414 )\n\n* add pin_lora to habana components\n\n* add WA for model loader\n\n* fix api mismatches with ray\n\n* tensor parallel fixes\n\n* workers cpu alignment fix\n\n* [Misc] Remove useless code in cpu_worker ( vllm-project#5824 )\n\n* prefill/decode metadata fixes\n\n* [Core] Add fault tolerance for `RayTokenizerGroupPool` ( vllm-project#5748 )\n\n* re-enable attn metadata trimming\n\n* worker_use_ray fix\n\n* [doc][distributed] add both gloo and nccl tests ( vllm-project#5834 )\n\n* [CI/Build] Add unit testing for FlexibleArgumentParser ( vllm-project#5798 )\n\n* [Misc] Update `w4a16` `compressed-tensors` support to include `w8a16` ( vllm-project#5794 )\n\n* [Hardware][TPU] Refactor TPU backend ( vllm-project#5831 )\n\n* [Hardware][AMD][CI/Build][Doc] Upgrade to ROCm 6.1, Dockerfile improvements, test fixes ( vllm-project#5422 )\n\n* [Hardware][TPU] Raise errors for unsupported sampling params ( vllm-project#5850 )\n\n* [CI/Build] Add E2E tests for MLPSpeculator ( vllm-project#5791 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix assertion in NeuronExecutor ( vllm-project#5841 )\n\n* [Core] Refactor Worker and ModelRunner to consolidate control plane communication ( vllm-project#5408 )\n\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Stephanie <swang@anyscale.com>\n\n* [Misc][Doc] Add Example of using OpenAI Server with VLM ( vllm-project#5832 )\n\n* [bugfix][distributed] fix shm broadcast when the queue size is full ( vllm-project#5801 )\n\n* [Bugfix] Fix embedding to support 2D inputs ( vllm-project#5829 )\n\n* [Bugfix][TPU] Fix KV cache size calculation ( vllm-project#5860 )\n\n* [CI/Build] Refactor image test assets ( vllm-project#5821 )\n\n* [Kernel] Adding bias epilogue support for `cutlass_scaled_mm` ( vllm-project#5560 )\n\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Frontend] Add tokenize/detokenize endpoints ( vllm-project#5054 )\n\n* [Hardware][TPU] Support parallel sampling & Swapping ( vllm-project#5855 )\n\n* [Bugfix][TPU] Fix CPU cache allocation ( vllm-project#5869 )\n\n* Support CPU inference with VSX PowerPC ISA ( vllm-project#5652 )\n\n* [doc] update usage of env var to avoid conflict ( vllm-project#5873 )\n\n* [Misc] Add example for LLaVA-NeXT ( vllm-project#5879 )\n\n* [BugFix] Fix cuda graph for MLPSpeculator ( vllm-project#5875 )\n\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\n\n* [Doc] Add note about context length in Phi-3-Vision example ( vllm-project#5887 )\n\n* [VLM][Bugfix] Make sure that `multi_modal_kwargs` is broadcasted properly ( vllm-project#5880 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Model] Add base class for LoRA-supported models ( vllm-project#5018 )\n\n* [Bugfix] Fix img_sizes Parsing in Phi3-Vision ( vllm-project#5888 )\n\n* [CI/Build] [1/3] Reorganize entrypoints tests ( vllm-project#5526 )\n\n* add collective crash WA\n\n* add comment to the weird mark_step\n\n* [Model][Bugfix] Implicit model flags and reenable Phi-3-Vision ( vllm-project#5896 )\n\n* [doc][misc] add note for Kubernetes users ( vllm-project#5916 )\n\n* [BugFix] Fix `MLPSpeculator` handling of `num_speculative_tokens` ( vllm-project#5876 )\n\n* [BugFix] Fix `min_tokens` behaviour for multiple eos tokens ( vllm-project#5849 )\n\n* [CI/Build] Fix Args for `_get_logits_warper` in Sampler Test ( vllm-project#5922 )\n\n* [Model] Add Gemma 2 ( vllm-project#5908 )\n\n* [core][misc] remove logical block ( vllm-project#5882 )\n\n* [Kernel][ROCm][AMD] fused_moe Triton configs v2 for mi300X ( vllm-project#5932 )\n\n* [Hardware][TPU] Optimize KV cache swapping ( vllm-project#5878 )\n\n* [VLM][BugFix] Make sure that `multi_modal_kwargs` can broadcast properly with ring buffer. ( vllm-project#5905 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][Hardware][Intel CPU] Fix unpassed multi_modal_kwargs for CPU runner ( vllm-project#5956 )\n\n* [Core] Registry for processing model inputs ( vllm-project#5214 )\n\nCo-authored-by: ywang96 <ywang@roblox.com>\n\n* Unmark fused_moe config json file as executable ( vllm-project#5960 )\n\n* [Hardware][Intel] OpenVINO vLLM backend ( vllm-project#5379 )\n\n* [Bugfix] Better error message for MLPSpeculator when `num_speculative_tokens` is set too high ( vllm-project#5894 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [CI/Build] [2/3] Reorganize entrypoints tests ( vllm-project#5904 )\n\n* [Distributed] Make it clear that % should not be in tensor dict keys. ( vllm-project#5927 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Spec Decode] Introduce DraftModelRunner ( vllm-project#5799 )\n\n* [Bugfix] Fix compute datatype for cutlass 3.x epilogues ( vllm-project#5931 )\n\n* [ Misc ] Remove `fp8_shard_indexer` from Col/Row Parallel Linear (Simplify Weight Loading) ( vllm-project#5928 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [ Bugfix ] Enabling Loading Models With Fused QKV/MLP on Disk with FP8 ( vllm-project#5921 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* Support Deepseek-V2 ( vllm-project#4650 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* [Bugfix] Only add `Attention.kv_scale` if kv cache quantization is enabled ( vllm-project#5936 )\n\n* Unmark more files as executable ( vllm-project#5962 )\n\n* [Bugfix] Fix Engine Failing After Invalid Request - AsyncEngineDeadError ( vllm-project#5963 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Kernel] Flashinfer for prefill & decode, with Cudagraph support for decode ( vllm-project#4628 )\n\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\n\n* [Bugfix][TPU] Fix TPU sampler output ( vllm-project#5978 )\n\n* [Bugfix][TPU] Fix pad slot id ( vllm-project#5977 )\n\n* [Bugfix] fix missing last itl in openai completions benchmark ( vllm-project#5926 )\n\n* [Misc] Extend vLLM Metrics logging API ( vllm-project#5925 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Kernel] Add punica dimensions for Granite 3b and 8b ( vllm-project#5930 )\n\nSigned-off-by: Joe Runde <joe@joerun.de>\n\n* [Bugfix] Fix precisions in Gemma 1 ( vllm-project#5913 )\n\n* [Misc] Update Phi-3-Vision Example ( vllm-project#5981 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix] Support `eos_token_id` from `config.json` ( vllm-project#5954 )\n\n* [Core] Optimize `SequenceStatus.is_finished` by switching to IntEnum ( vllm-project#5974 )\n\n* [Kernel] Raise an exception in MoE kernel if the batch size is larger then 65k ( vllm-project#5939 )\n\n* [ CI/Build ] Added E2E Test For Compressed Tensors ( vllm-project#5839 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [CI/Build] Add TP test for vision models ( vllm-project#5892 )\n\n* [ CI/Build ] LM Eval Harness Based CI Testing ( vllm-project#5838 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Bugfix][CI/Build][Hardware][AMD] Install matching torchvision to fix AMD tests ( vllm-project#5949 )\n\n* [CI/Build] Temporarily Remove Phi3-Vision from TP Test ( vllm-project#5989 )\n\n* [CI/Build] Reuse code for checking output consistency ( vllm-project#5988 )\n\n* [CI/Build] [3/3] Reorganize entrypoints tests ( vllm-project#5966 )\n\n* [ci][distributed] fix device count call\n\n[ci][distributed] fix some cuda init that makes it necessary to use spawn ( vllm-project#5991 )\n\n* [Frontend]: Support base64 embedding ( vllm-project#5935 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Lora] Use safetensor keys instead of adapter_config.json to find unexpected modules.  ( vllm-project#5909 )\n\nCo-authored-by: sang <sangcho@anyscale.com>\n\n* [ CI ] Temporarily Disable Large LM-Eval Tests ( vllm-project#6005 )\n\nCo-authored-by: rshaw@neuralmagic.com <rshaw@neuralmagic>\n\n* [Misc] Fix `get_min_capability` ( vllm-project#5971 )\n\n* [ Misc ] Refactor w8a8 to use `process_weights_after_load` (Simplify Weight Loading) ( vllm-project#5940 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [misc][cuda] use nvml to avoid accidentally cuda initialization ( vllm-project#6007 )\n\n* [Speculative Decoding 2/2 ] Integrate typical acceptance sampler into Spec Decode Worker ( vllm-project#5348 )\n\n* Revert test changes\n\n* cleanup\n\n* llm engine cleanup\n\n* utils.py cleanup\n\n* custom ops refactor\n\n* move xops to ops\n\n* remove vllm/hpu/attn_bias.py\n\n* whitespace fix\n\n* revert accidental changes in rmsnorm\n\n* Fix hpugraph hashing\n\n* add trim_attn_metadata comment\n\n* fix prompt bucketing:\n\n* [ CI ] Re-enable Large Model LM Eval ( vllm-project#6031 )\n\n* [doc][misc] remove deprecated api server in doc ( vllm-project#6037 )\n\n* [Misc] update benchmark backend for scalellm ( vllm-project#6018 )\n\n* [doc][misc] further lower visibility of simple api server ( vllm-project#6041 )\n\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [Bugfix] Use RayActorError for older versions of Ray in  RayTokenizerGroupPool ( vllm-project#6039 )\n\n* [Bugfix] adding chunking mechanism to fused_moe to handle large inputs ( vllm-project#6029 )\n\n* add FAQ doc under 'serving' ( vllm-project#5946 )\n\n* [Bugfix][Doc] Fix Doc Formatting ( vllm-project#6048 )\n\n* [Bugfix] Add explicit `end_forward` calls to flashinfer ( vllm-project#6044 )\n\n* [BugFix] Ensure worker model loop is always stopped at the right time ( vllm-project#5987 )\n\n* [Frontend] Relax api url assertion for openai benchmarking ( vllm-project#6046 )\n\n* [Model] Changes to MLPSpeculator to support tie_weights and input_scale ( vllm-project#5965 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\n\n* [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 default)  ( vllm-project#5602 )\n\n* [Frontend] Add template related params to request ( vllm-project#5709 )\n\n* [VLM] Remove `image_input_type` from VLM config ( vllm-project#5852 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Reinstate doc dependencies ( vllm-project#6061 )\n\n* guard model loader wa for hpu\n\n---------\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nSigned-off-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\nCo-authored-by: Jie Fu (ÂÇÖÊù∞) <jiefu@tencent.com>\nCo-authored-by: Allen.Dou <allen.dou@hotmail.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: leiwen83 <leiwen83@users.noreply.github.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: SangBin Cho <rkooo567@gmail.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Amit Garg <gargamit@microsoft.com>\nCo-authored-by: Charles Riggins <liqianchen123@foxmail.com>\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\nCo-authored-by: zhyncs <me@zhyncs.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\nCo-authored-by: Bruce Fontaine <bruce@2.7182.net>\nCo-authored-by: zifeitong <zifeitong@gmail.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Ronen Schaffer <ronen.schaffer@ibm.com>\nCo-authored-by: sergey-tinkoff <167607910+sergey-tinkoff@users.noreply.github.com>\nCo-authored-by: milo157 <43028253+milo157@users.noreply.github.com>\nCo-authored-by: Shukant Pal <SukantK2002@outlook.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: DearPlanet <junsong.zhang2021.work@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Joshua Rosenkranz <joshua.rosenkranz@gmail.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Jee Li <pandaleefree@163.com>\nCo-authored-by: rohithkrn <rohith.nallamaddi@gmail.com>\nCo-authored-by: Murali Andoorveedu <37849411+andoorve@users.noreply.github.com>\nCo-authored-by: Woo-Yeon Lee <wooyeonlee0@gmail.com>\nCo-authored-by: Matt Wong <156021403+mawong-amd@users.noreply.github.com>\nCo-authored-by: aws-patlange <90803007+aws-patlange@users.noreply.github.com>\nCo-authored-by: Stephanie Wang <swang@cs.berkeley.edu>\nCo-authored-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Luka Govediƒç <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: sasha0552 <admin@sasha0552.org>\nCo-authored-by: Chip Kerchner <49959681+ChipKerchner@users.noreply.github.com>\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\nCo-authored-by: xwjiang2010 <87673679+xwjiang2010@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\nCo-authored-by: wangding zeng <155410488+zwd003@users.noreply.github.com>\nCo-authored-by: Lily Liu <lilyliupku@gmail.com>\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\nCo-authored-by: mcalman <68564154+mcalman@users.noreply.github.com>\nCo-authored-by: William Lin <SolitaryThinker@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: llmpros <10524065+llmpros@users.noreply.github.com>\nCo-authored-by: sang <sangcho@anyscale.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: James Whedbee <jamesw@telnyx.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\nCo-authored-by: danieljannai21 <100521221+danieljannai21@users.noreply.github.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( v‚Ä¶ ‚Ä¶ 233bf00 ‚Ä¶llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( v‚Ä¶ ‚Ä¶ 610215e ‚Ä¶llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> awangzy mentioned this pull request Mar 11, 2025 [Doc]: Does vllm CPU backend support Intel AMX? #14603 Open 1 task Copy link ivanbaldo commented Jul 30, 2025 So with this, AVX2-only CPUs are supported? Can it be used with the images at public.ecr.aws/q9t5s3a7/vllm-cpu-release-repo:v0.10.0? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-07 17:48:46",
  "has_lm_eval": true,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "LM_EVAL: LM-Eval | PERF: TTFT, itl, benchmark serving | SERVING: serving, serving, API server | TEST: test, test, test",
  "analysis_extracted_at": "2025-09-07 17:48:46",
  "models": [
    "meta-llama/Llama-3.1-8B-Instruct",
    "Qwen/Qwen2.5-7B-Instruct"
  ],
  "lm_eval_commands": [
    "lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100",
    "lm_eval --model vllm --model_args pretrained=Qwen/Qwen2.5-7B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100"
  ],
  "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0",
  "commit_subject": "[Hardware][Intel] Optimize CPU backend and add more performance tips (#4971)",
  "commit_message": "[Hardware][Intel] Optimize CPU backend and add more performance tips (#4971)\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>",
  "commit_date": "2024-06-13T09:33:14-07:00",
  "files_changed": [
    "Dockerfile.cpu",
    "README.md",
    "docs/source/getting_started/cpu-installation.rst",
    "requirements-cpu.txt",
    "vllm/attention/backends/torch_sdpa.py",
    "vllm/attention/ops/ipex_attn.py"
  ],
  "functions_changed": [],
  "stats": {
    "num_test_files": 0,
    "num_non_test_files": 6,
    "only_test_files": 0,
    "only_non_test_files": 1,
    "num_files": 6,
    "num_hunks": 13,
    "num_edited_lines": 178,
    "num_non_test_edited_lines": 178,
    "commit_year": 2024
  },
  "diff_text": "diff --git a/Dockerfile.cpu b/Dockerfile.cpu\nindex 403a1cd03..777bb0829 100644\n--- a/Dockerfile.cpu\n+++ b/Dockerfile.cpu\n@@ -3,9 +3,13 @@\n FROM ubuntu:22.04 AS cpu-test-1\n \n RUN apt-get update  -y \\\n-    && apt-get install -y git wget vim numactl gcc-12 g++-12 python3 python3-pip \\\n+    && apt-get install -y git wget vim numactl gcc-12 g++-12 python3 python3-pip libtcmalloc-minimal4 \\\n     && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10 --slave /usr/bin/g++ g++ /usr/bin/g++-12\n \n+RUN echo 'export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4:$LD_PRELOAD' >> ~/.bashrc\n+\n+RUN pip install https://intel-extension-for-pytorch.s3.amazonaws.com/ipex_dev/cpu/intel_extension_for_pytorch-2.3.100%2Bgit0eb3473-cp310-cp310-linux_x86_64.whl\n+\n RUN pip install --upgrade pip \\\n     && pip install wheel packaging ninja \"setuptools>=49.4.0\" numpy\n \n@@ -21,6 +25,6 @@ RUN VLLM_TARGET_DEVICE=cpu python3 setup.py install\n \n WORKDIR /workspace/\n \n-RUN ln -s /workspace/vllm/tests  && ln -s /workspace/vllm/examples && ln -s /workspace/vllm/benchmarks\n+RUN ln -s /workspace/vllm/tests && ln -s /workspace/vllm/examples && ln -s /workspace/vllm/benchmarks\n \n CMD [\"/bin/bash\"]\ndiff --git a/README.md b/README.md\nindex 57374d279..8e4480ac2 100644\n--- a/README.md\n+++ b/README.md\n@@ -65,7 +65,7 @@ vLLM is flexible and easy to use with:\n - Tensor parallelism support for distributed inference\n - Streaming outputs\n - OpenAI-compatible API server\n-- Support NVIDIA GPUs and AMD GPUs\n+- Support NVIDIA GPUs, AMD GPUs, and Intel CPUs\n - (Experimental) Prefix caching support\n - (Experimental) Multi-lora support\n \ndiff --git a/docs/source/getting_started/cpu-installation.rst b/docs/source/getting_started/cpu-installation.rst\nindex 5270253ca..a9544e8a5 100644\n--- a/docs/source/getting_started/cpu-installation.rst\n+++ b/docs/source/getting_started/cpu-installation.rst\n@@ -10,6 +10,7 @@ Table of contents:\n #. :ref:`Requirements <cpu_backend_requirements>`\n #. :ref:`Quick start using Dockerfile <cpu_backend_quick_start_dockerfile>`\n #. :ref:`Build from source <build_cpu_backend_from_source>`\n+#. :ref:`Intel Extension for PyTorch <ipex_guidance>`\n #. :ref:`Performance tips <cpu_backend_performance_tips>`\n \n .. _cpu_backend_requirements:\n@@ -18,7 +19,7 @@ Requirements\n ------------\n \n * OS: Linux\n-* Compiler: gcc/g++>=12.3.0 (recommended)\n+* Compiler: gcc/g++>=12.3.0 (optional, recommended)\n * Instruction set architecture (ISA) requirement: AVX512 is required.\n \n .. _cpu_backend_quick_start_dockerfile:\n@@ -41,7 +42,7 @@ Quick start using Dockerfile\n Build from source\n -----------------\n \n-- First, install required compiler. We recommend to use ``gcc/g++ >= 12.3.0`` as the default compiler to avoid potential problems. For example, on Ubuntu 22.4, you can run:\n+- First, install recommended compiler. We recommend to use ``gcc/g++ >= 12.3.0`` as the default compiler to avoid potential problems. For example, on Ubuntu 22.4, you can run:\n \n .. code-block:: console\n \n@@ -70,6 +71,15 @@ Build from source\n     \n     - If you want to force enable AVX512_BF16 for the cross-compilation, please set environment variable VLLM_CPU_AVX512BF16=1 before the building.    \n \n+.. _ipex_guidance:\n+\n+Intel Extension for PyTorch\n+---------------------------\n+\n+- `Intel Extension for PyTorch (IPEX) <https://github.com/intel/intel-extension-for-pytorch>`_ extends PyTorch with up-to-date features optimizations for an extra performance boost on Intel hardware.\n+\n+- IPEX after the ``2.3.0`` can be enabled in the CPU backend by default if it is installed.\n+\n .. _cpu_backend_performance_tips:\n \n Performance tips\n@@ -77,6 +87,15 @@ Performance tips\n \n - vLLM CPU backend uses environment variable ``VLLM_CPU_KVCACHE_SPACE`` to specify the KV Cache size (e.g, ``VLLM_CPU_KVCACHE_SPACE=40`` means 40 GB space for KV cache), larger setting will allow vLLM running more requests in parallel. This parameter should be set based on the hardware configuration and memory management pattern of users.\n \n+- We highly recommend to use TCMalloc for high performance memory allocation and better cache locality. For example, on Ubuntu 22.4, you can run:\n+\n+.. code-block:: console\n+\n+    $ sudo apt-get install libtcmalloc-minimal4 # install TCMalloc library\n+    $ find / -name *libtcmalloc* # find the dynamic link library path\n+    $ export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4:$LD_PRELOAD # prepend the library to LD_PRELOAD\n+    $ python examples/offline_inference.py # run vLLM\n+\n - vLLM CPU backend uses OpenMP for thread-parallel computation. If you want the best performance on CPU, it will be very critical to isolate CPU cores for OpenMP threads with other thread pools (like web-service event-loop), to avoid CPU oversubscription. \n \n - If using vLLM CPU backend on a bare-metal machine, it is recommended to disable the hyper-threading.\ndiff --git a/requirements-cpu.txt b/requirements-cpu.txt\nindex b739642d8..8b7d86e68 100644\n--- a/requirements-cpu.txt\n+++ b/requirements-cpu.txt\n@@ -2,5 +2,5 @@\n -r requirements-common.txt\n \n # Dependencies for x86_64 CPUs\n-torch == 2.3.0+cpu\n+torch == 2.3.1+cpu\n triton >= 2.2.0  # FIXME(woosuk): This is a hack to avoid import error.\n\\ No newline at end of file\ndiff --git a/vllm/attention/backends/torch_sdpa.py b/vllm/attention/backends/torch_sdpa.py\nindex 9b50adec5..4b08cce99 100644\n--- a/vllm/attention/backends/torch_sdpa.py\n+++ b/vllm/attention/backends/torch_sdpa.py\n@@ -8,8 +8,16 @@ from torch.nn.functional import scaled_dot_product_attention\n \n from vllm.attention.backends.abstract import (AttentionBackend, AttentionImpl,\n                                               AttentionMetadata)\n-from vllm.attention.ops.paged_attn import (PagedAttention,\n-                                           PagedAttentionMetadata)\n+from vllm.attention.ops.paged_attn import PagedAttentionMetadata\n+from vllm.utils import is_cpu\n+\n+if is_cpu():\n+    try:\n+        from vllm.attention.ops.ipex_attn import PagedAttention\n+    except ImportError:\n+        from vllm.attention.ops.paged_attn import PagedAttention\n+else:\n+    from vllm.attention.ops.paged_attn import PagedAttention\n \n \n class TorchSDPABackend(AttentionBackend):\n@@ -197,13 +205,14 @@ class TorchSDPABackendImpl(AttentionImpl[TorchSDPAMetadata]):\n                                          attn_metadata.attn_bias):\n                     end = start + seq_len\n                     sub_out = scaled_dot_product_attention(\n-                        query[:, start:end, :],\n-                        key[:, start:end, :],\n-                        value[:, start:end, :],\n+                        query[None, :, start:end, :],\n+                        key[None, :, start:end, :],\n+                        value[None, :, start:end, :],\n                         attn_mask=mask,\n                         dropout_p=0.0,\n                         is_causal=not self.need_mask,\n-                        scale=self.scale).movedim(query.dim() - 2, 0)\n+                        scale=self.scale).squeeze(0).movedim(\n+                            query.dim() - 2, 0)\n                     output[start:end, :, :] = sub_out\n                     start = end\n             else:\n@@ -248,7 +257,7 @@ def _make_alibi_bias(\n \n         num_heads = alibi_slopes.shape[0]\n         bias = bias[None, :].repeat((num_heads, 1, 1))\n-        bias.mul_(alibi_slopes[:, None, None])\n+        bias.mul_(alibi_slopes[:, None, None]).unsqueeze_(0)\n         inf_mask = torch.empty(\n             (1, seq_len, seq_len),\n             dtype=bias.dtype).fill_(-torch.inf).triu_(diagonal=1)\ndiff --git a/vllm/attention/ops/ipex_attn.py b/vllm/attention/ops/ipex_attn.py\nnew file mode 100644\nindex 000000000..5a5317b65\n--- /dev/null\n+++ b/vllm/attention/ops/ipex_attn.py\n@@ -0,0 +1,120 @@\n+from typing import Dict, List, Optional, Tuple\n+\n+import intel_extension_for_pytorch.llm.modules as ipex_modules\n+import torch\n+\n+from vllm import _custom_ops as ops\n+\n+\n+class PagedAttention:\n+\n+    @staticmethod\n+    def get_supported_head_sizes() -> List[int]:\n+        return [64, 80, 96, 112, 128, 256]\n+\n+    @staticmethod\n+    def get_kv_cache_shape(\n+        num_blocks: int,\n+        block_size: int,\n+        num_kv_heads: int,\n+        head_size: int,\n+        *args,\n+    ) -> Tuple[int, ...]:\n+        return (2, num_blocks, block_size * num_kv_heads * head_size)\n+\n+    @staticmethod\n+    def split_kv_cache(\n+        kv_cache: torch.Tensor,\n+        num_kv_heads: int,\n+        head_size: int,\n+        *args,\n+    ) -> Tuple[torch.Tensor, torch.Tensor]:\n+        num_blocks = kv_cache.shape[1]\n+\n+        key_cache = kv_cache[0]\n+        key_cache = key_cache.view(num_blocks, num_kv_heads, -1, head_size)\n+        value_cache = kv_cache[1]\n+        value_cache = value_cache.view(num_blocks, num_kv_heads, -1, head_size)\n+        return key_cache, value_cache\n+\n+    @staticmethod\n+    def write_to_paged_cache(\n+        key: torch.Tensor,\n+        value: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        slot_mapping: torch.Tensor,\n+        kv_cache_dtype: str,\n+        kv_scale: float,\n+        *args,\n+    ) -> None:\n+        ipex_modules.PagedAttention.reshape_and_cache(\n+            key, value, key_cache, value_cache,\n+            slot_mapping.flatten().int())\n+\n+    @staticmethod\n+    def forward_decode(\n+        query: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        block_tables: torch.Tensor,\n+        context_lens: torch.Tensor,\n+        max_context_len: int,\n+        kv_cache_dtype: str,\n+        num_kv_heads: int,\n+        scale: float,\n+        alibi_slopes: Optional[torch.Tensor],\n+        kv_scale: float,\n+        *args,\n+    ) -> torch.Tensor:\n+        output = torch.empty_like(query)\n+        block_size = value_cache.shape[2]\n+        head_mapping = torch.arange(\n+            0,\n+            num_kv_heads,\n+            device=\"cpu\",\n+            dtype=torch.int32,\n+        ).view(num_kv_heads,\n+               1).repeat_interleave(query.size(1) // num_kv_heads).flatten()\n+        ipex_modules.PagedAttention.single_query_cached_kv_attention(\n+            output, query.contiguous(), key_cache, value_cache, head_mapping,\n+            scale, block_tables, context_lens, block_size, max_context_len,\n+            alibi_slopes)\n+\n+        return output\n+\n+    @staticmethod\n+    def forward_prefix(\n+        query: torch.Tensor,\n+        key: torch.Tensor,\n+        value: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        block_tables: torch.Tensor,\n+        subquery_start_loc: torch.Tensor,\n+        prompt_lens_tensor: torch.Tensor,\n+        context_lens: torch.Tensor,\n+        max_subquery_len: int,\n+        alibi_slopes: Optional[torch.Tensor],\n+        *args,\n+    ) -> torch.Tensor:\n+        raise NotImplementedError\n+\n+    @staticmethod\n+    def swap_blocks(\n+        src_kv_cache: torch.Tensor,\n+        dst_kv_cache: torch.Tensor,\n+        src_to_dst: Dict[int, int],\n+        *args,\n+    ) -> None:\n+        raise NotImplementedError\n+\n+    @staticmethod\n+    def copy_blocks(\n+        kv_caches: List[torch.Tensor],\n+        src_to_dists: Dict[int, List[int]],\n+        *args,\n+    ) -> None:\n+        key_caches = [kv_cache[0] for kv_cache in kv_caches]\n+        value_caches = [kv_cache[1] for kv_cache in kv_caches]\n+        ops.copy_blocks(key_caches, value_caches, src_to_dists)",
  "apis": [
    "vllm.attention.backends.PagedAttention",
    "vllm.attention.ops.ipex_attn.PagedAttention"
  ],
  "affected_paths": [],
  "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm",
  "llm_reason": "The commit updates several crucial files that are not tests ‚Äì it enhances the Dockerfile (by adding TCMalloc and Intel Extension for PyTorch support), modifies documentation to highlight performance tips for CPU usage, and changes actual source code in the CPU backend (vllm/attention/backends/torch_sdpa.py) and adds a new module (vllm/attention/ops/ipex_attn.py). These changes focus on improving memory allocation efficiency and leveraging Intel's optimized extensions, which directly enhance CPU performance. The modifications are not trivial documentation fixes or mere refactorings; they alter how the high-level CPU APIs perform and include performance-related configuration. All conditions for a performance optimization commit are met.",
  "llm_api_reason": "The commit introduces several CPU backend optimizations targeting Intel hardware. It updates the Dockerfile and documentation for installing Intel Extension for PyTorch and TCMalloc. In the code, it modifies the TorchSDPABackend to conditionally import an optimized version of PagedAttention for CPU usage; it first tries to load PagedAttention from the newly added ipex_attn module and only falls back to the original implementation if needed. These changes affect the core attention API that vLLM uses for managing attention operations."
}