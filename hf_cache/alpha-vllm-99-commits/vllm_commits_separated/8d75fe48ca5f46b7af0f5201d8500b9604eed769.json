{
  "commit_hash": "8d75fe48ca5f46b7af0f5201d8500b9604eed769",
  "pr_url": "https://github.com/vllm-project/vllm/pull/5183",
  "pr_date": "2024-06-07",
  "timeline_text": "Copy link Collaborator tlrmchlsmth commented Jun 1, 2024 ‚Ä¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Switching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8 see https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and #5144 for comparisons across different GEMM sizes. PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 comaniac reacted with thumbs up emoji All reactions üëç 1 reaction Switch fp8 layers to use the cutlass kernels b6809fa Copy link Collaborator robertgshaw2-redhat commented Jun 1, 2024 @tlrmchlsmth models: https://huggingface.co/nm-testing/Meta-Llama-3-70B-Instruct-FP8 https://huggingface.co/neuralmagic/Meta-Llama-3-8B-Instruct-FP8 https://huggingface.co/nm-testing/Meta-Llama-3-8B-Instruct-FP8-KV << with Quantized KV Cache üëÄ 1 tlrmchlsmth reacted with eyes emoji All reactions üëÄ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac reviewed Jun 1, 2024 View reviewed changes vllm/model_executor/layers/quantization/fp8.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author tlrmchlsmth commented Jun 1, 2024 Just ran a quick sanity check for correctness. Output looks good on all three. I tried tensor_parallel_size=2 as well for the 70B model, and that looks good All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Narrow output 2e93b71 robertgshaw2-redhat reviewed Jun 1, 2024 View reviewed changes vllm/model_executor/layers/quantization/fp8.py Outdated return torch.narrow(output, 0, 0, x.shape[0]) # We use the CUTLASS kernels by default but they don't support bias yet if bias is None: Copy link Collaborator robertgshaw2-redhat Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do we also do a branch if we are on ada lovelace and CUDA 12.1? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author tlrmchlsmth Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment We will need to if on CUDA < 12.4. We also need a branch if on CUDA 11.8. @comaniac do you know if torch._scaled_mm is supported in that case? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator comaniac Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I only know that it only supports SM89+. We can try to call this op with torch+cu118 to test out. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author tlrmchlsmth Jun 1, 2024 ‚Ä¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The cutlass kernels need at least SM89 as well, for the record. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator comaniac Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yeah that makes sense. Older architectures don't have native FP8 so we can't get speedup from them, which seems not necessary to be covered. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator robertgshaw2-redhat Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Note: we already have a mechanism for determining if a LinearMethod can run on a specific cuda arch. The LinearMethod exposes get_min_capability which is called during model loading. https://github.com/vllm-project/vllm/blob/main/vllm/model_executor/layers/quantization/fp8.py#L46 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëÄ 1 tlrmchlsmth reacted with eyes emoji All reactions üëÄ 1 reaction Copy link Collaborator pcmoritz commented Jun 1, 2024 Did you run benchmarks to compare the end-to-end performance? ITL for different qps All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator robertgshaw2-redhat commented Jun 1, 2024 Did you run benchmarks to compare the end-to-end performance? ITL for different qps Not yet. But obviously need this before we merge üëç 3 tlrmchlsmth, pcmoritz, and comaniac reacted with thumbs up emoji All reactions üëç 3 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Jun 1, 2024 I'll do a benchmark on Monday anyways. btw it'd be great if this PR is rebased onto the latest main that includes all required changes (it's likely the case already I suppose All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author tlrmchlsmth commented Jun 1, 2024 btw it'd be great if this PR is rebased onto the latest main that includes all required changes (it's likely the case already I suppose It's on a very recent main (from this morning) so it's good to use as is. In particular both #5144 and #5137 were needed for the switchover and they are both in. üëç 1 comaniac reacted with thumbs up emoji All reactions üëç 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Merge branch 'upstream-main' into tms/use_cutlass_4_fp8 33085d9 robertgshaw2-redhat reviewed Jun 3, 2024 View reviewed changes vllm/_custom_ops.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Jun 6, 2024 @tlrmchlsmth @robertgshaw2-neuralmagic per offline discussion, this PR should be ok to go at least for now? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author tlrmchlsmth commented Jun 6, 2024 Yeah, let's get it landed. It needs to check a few more cases for falling back to scaled_mm. I'll get to that today and then mark it ready for review üëç 1 comaniac reacted with thumbs up emoji All reactions üëç 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth added 2 commits June 6, 2024 20:46 Merge branch 'upstream-main' into tms/use_cutlass_4_fp8 43e5bd1 guard against calling cutlass when not supported 81f5372 robertgshaw2-redhat reviewed Jun 6, 2024 View reviewed changes vllm/model_executor/layers/quantization/fp8.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth added 2 commits June 6, 2024 21:59 format 1fe0468 check support during __init__ 2d77ca5 tlrmchlsmth marked this pull request as ready for review June 6, 2024 22:05 tlrmchlsmth added 2 commits June 6, 2024 22:14 Make that function standalone a1ffa09 format e894b21 robertgshaw2-redhat approved these changes Jun 6, 2024 View reviewed changes Copy link Collaborator robertgshaw2-redhat left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions pcmoritz approved these changes Jun 7, 2024 View reviewed changes Copy link Collaborator pcmoritz left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Great work and thanks for adding the benchmarks :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions comaniac approved these changes Jun 7, 2024 View reviewed changes Copy link Collaborator comaniac left a comment ‚Ä¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM. Thanks! I also did some benchmarks with this PR. Note that all results are in TP=4 on H100 and with chunked prefill enabled (this is just my own requirement). Prompts are 550 tokens, decoding 150 tokens. Model QPS scaled_mm-ITL cutlass-ITL scaled_mm-TTFT cutlass-TTFT Llama-3-70B 1 17.3 16.3 68.7 68.7 Llama-3-70B 4 22.7 21.2 72.3 72.6 Llama-3-70B 8 35.9 33.6 83.1 81.2 Mixtral-8x7B 1 9.1 8.9 43.1 40.7 Mixtral-8x7B 4 11.4 10.7 42.6 38.4 Mixtral-8x7B 8 15.6 14.3 43.4 42.8 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 pcmoritz reacted with thumbs up emoji All reactions üëç 1 reaction pcmoritz enabled auto-merge (squash) June 7, 2024 00:32 pcmoritz merged commit 8d75fe4 into vllm-project : main Jun 7, 2024 cli99 mentioned this pull request Jun 7, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS #5352 Merged Copy link Contributor cli99 commented Jun 7, 2024 @tlrmchlsmth Awesome work! Was trying this but ran into a problem when checking the cutlass fp8 support. Made a fix that works in my case in #5352 . All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . pcmoritz pushed a commit\n      that referenced\n      this pull request Jun 8, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( #5352 ) ‚Ä¶ e69ded7 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in #5183 . dtrifiro pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request Jun 10, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 ‚Ä¶ 80ec81e )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. dtrifiro pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request Jun 10, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) ‚Ä¶ 978a73a Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jun 11, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 ‚Ä¶ ed99ec9 )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jun 11, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) ‚Ä¶ e349c2d Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . joerunde pushed a commit\n        to IBM/vllm\n      that referenced\n      this pull request Jun 13, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS (#5352) ‚Ä¶ e0c6dc7 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project/vllm#5183 . tlrmchlsmth deleted the tms/use_cutlass_4_fp8 branch June 14, 2024 17:20 joerunde pushed a commit\n        to joerunde/vllm\n      that referenced\n      this pull request Jun 17, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 ‚Ä¶ df50941 )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jun 27, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 ‚Ä¶ 2e9ab5b )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jun 27, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) ‚Ä¶ ecdf6ef Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 ‚Ä¶ 08faea8 )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) ‚Ä¶ eb6d8a6 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 ‚Ä¶ e9a71eb )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) ‚Ä¶ c975075 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-07 17:48:50",
  "has_lm_eval": false,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "PERF: TTFT, TTFT, qps | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, testing",
  "analysis_extracted_at": "2025-09-07 17:48:50",
  "models": [
    "neuralmagic/Meta-Llama-3-8B-Instruct-FP8",
    "nm-testing/Meta-Llama-3-70B-Instruct-FP8",
    "nm-testing/Meta-Llama-3-8B-Instruct-FP8-KV"
  ],
  "lm_eval_commands": [
    "lm_eval --model vllm --model_args pretrained=neuralmagic/Meta-Llama-3-8B-Instruct-FP8,dtype=float16,tensor_parallel_size=1 --tasks gsm8k --num_fewshot 5"
  ],
  "perf_command": "python benchmarks/benchmark_serving.py --model neuralmagic/Meta-Llama-3-8B-Instruct-FP8 --dataset-name sharegpt --dataset-path ./ShareGPT_V3_unfiltered_cleaned_split.json",
  "commit_subject": "[Kernel] Switch fp8 layers to use the CUTLASS kernels (#5183)",
  "commit_message": "[Kernel] Switch fp8 layers to use the CUTLASS kernels (#5183)\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and #5144 for comparisons across different GEMM sizes.",
  "commit_date": "2024-06-07T08:42:35Z",
  "files_changed": [
    "vllm/_custom_ops.py",
    "vllm/model_executor/layers/quantization/fp8.py"
  ],
  "functions_changed": [],
  "stats": {
    "num_test_files": 0,
    "num_non_test_files": 2,
    "only_test_files": 0,
    "only_non_test_files": 1,
    "num_files": 2,
    "num_hunks": 5,
    "num_edited_lines": 70,
    "num_non_test_edited_lines": 70,
    "commit_year": 2024
  },
  "diff_text": "diff --git a/vllm/_custom_ops.py b/vllm/_custom_ops.py\nindex 462ba8a75..cae682216 100644\n--- a/vllm/_custom_ops.py\n+++ b/vllm/_custom_ops.py\n@@ -179,7 +179,7 @@ def gptq_marlin_24_gemm(a: torch.Tensor, b_q_weight: torch.Tensor,\n \n # cutlass\n def cutlass_scaled_mm_dq(a: torch.Tensor, b: torch.Tensor,\n-                         a_scales: torch.Tensor, b_scales: torch.Tensor,\n+                         scale_a: torch.Tensor, scale_b: torch.Tensor,\n                          out_dtype: Type[torch.dtype]) -> torch.Tensor:\n     assert (b.shape[0] % 16 == 0 and b.shape[1] % 16 == 0)\n     assert (out_dtype is torch.bfloat16 or out_dtype is torch.float16)\n@@ -188,7 +188,7 @@ def cutlass_scaled_mm_dq(a: torch.Tensor, b: torch.Tensor,\n     n = b.shape[1]\n     out = torch.empty((m, n), dtype=out_dtype, device=a.device)\n \n-    vllm_ops.cutlass_scaled_mm_dq(out, a, b, a_scales, b_scales)\n+    vllm_ops.cutlass_scaled_mm_dq(out, a, b, scale_a, scale_b)\n \n     return out\n \ndiff --git a/vllm/model_executor/layers/quantization/fp8.py b/vllm/model_executor/layers/quantization/fp8.py\nindex bf3a59e3d..136a64623 100644\n--- a/vllm/model_executor/layers/quantization/fp8.py\n+++ b/vllm/model_executor/layers/quantization/fp8.py\n@@ -17,6 +17,24 @@ ACTIVATION_SCHEMES = [\"static\", \"dynamic\"]\n logger = init_logger(__name__)\n \n \n+def cutlass_fp8_supported() -> bool:\n+    capability = torch.cuda.get_device_capability()\n+    capability = capability[0] * 10 + capability[1]\n+    version = torch.version.cuda\n+    version = version[0] * 10 + version[1]\n+\n+    # CUTLASS FP8 kernels need at least\n+    #   CUDA 12.0 on SM90 systems (Hopper)\n+    #   CUDA 12.4 on SM89 systems (Lovelace)\n+    gpu_is_supported = False\n+    if capability >= 900:\n+        gpu_is_supported = version > 120\n+    elif capability >= 890:\n+        gpu_is_supported = version > 124\n+\n+    return gpu_is_supported\n+\n+\n class Fp8Config(QuantizationConfig):\n     \"\"\"Config class for FP8.\"\"\"\n \n@@ -92,6 +110,7 @@ class Fp8LinearMethod(LinearMethodBase):\n \n     def __init__(self, quant_config: Fp8Config):\n         self.quant_config = quant_config\n+        self.cutlass_fp8_supported = cutlass_fp8_supported()\n \n     def _create_scale_param(\n         self,\n@@ -233,25 +252,40 @@ class Fp8LinearMethod(LinearMethodBase):\n               layer: torch.nn.Module,\n               x: torch.Tensor,\n               bias: Optional[torch.Tensor] = None) -> torch.Tensor:\n+\n         # ops.scaled_fp8_quant supports both dynamic and static quant.\n         #   If dynamic, layer.act_scale is None and x_scale computed from x.\n         #   If static,  layer.act_scale is scalar and x_scale set to act_scale.\n-        qinput, x_scale = ops.scaled_fp8_quant(x,\n-                                               layer.act_scale,\n-                                               batch_dim_padding=17)\n-\n-        # Fused GEMM_DQ -- note we padded the input above because\n-        # torch._scaled_mm is more performant for matrices with\n-        # batch dimension > 16. Note that this could change\n-        # in the future.\n-        output, _ = torch._scaled_mm(\n-            qinput,\n-            layer.weight,\n-            out_dtype=x.dtype,\n-            scale_a=x_scale,\n-            scale_b=layer.weight_scale,\n-            bias=bias,\n-        )\n+\n+        if bias is None and self.cutlass_fp8_supported:\n+            qinput, x_scale = ops.scaled_fp8_quant(x, layer.act_scale)\n+\n+            # Fused GEMM_DQ\n+            output = ops.cutlass_scaled_mm_dq(\n+                qinput,\n+                layer.weight,\n+                out_dtype=x.dtype,\n+                scale_a=x_scale,\n+                scale_b=layer.weight_scale,\n+            )\n+\n+        else:\n+            qinput, x_scale = ops.scaled_fp8_quant(x,\n+                                                   layer.act_scale,\n+                                                   batch_dim_padding=17)\n+\n+            # Fused GEMM_DQ -- note we padded the input above because\n+            # torch._scaled_mm is more performant for matrices with\n+            # batch dimension > 16. Note that this could change\n+            # in the future.\n+            output, _ = torch._scaled_mm(\n+                qinput,\n+                layer.weight,\n+                out_dtype=x.dtype,\n+                scale_a=x_scale,\n+                scale_b=layer.weight_scale,\n+                bias=bias,\n+            )\n \n         return torch.narrow(output, 0, 0, x.shape[0])",
  "apis": [
    "vllm._custom_ops.cutlass_scaled_mm_dq",
    "vllm.model_executor.layers.quantization.fp8.cutlass_fp8_supported",
    "vllm.model_executor.layers.quantization.fp8.Fp8LinearMethod.apply"
  ],
  "affected_paths": [
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/fp8.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/_custom_ops.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/csrc/cutlass_extensions/vllm_cutlass_library_extension.py"
  ],
  "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm",
  "llm_reason": "The commit modifies non-test source code files‚Äîin particular, it changes functionality in vllm/_custom_ops.py and vllm/model_executor/layers/quantization/fp8.py. The changes conditionally switch the fp8 layer implementation from torch._scaled_mm to use a specialized CUTLASS kernel (cutlass_scaled_mm_dq) for performance gains (with reported 5-15% end-to-end improvement). The modifications are not trivial refactoring; rather, they directly impact the performance of a top-level API by selecting a more efficient kernel when supported. Additionally, the change is CPU/GPU agnostic as it provides a condition for when CUTLASS kernels can be used, and it is not limited to any specific hardware. Therefore, the commit satisfies the conditions for being performance or optimization related.",
  "llm_api_reason": "The commit renames parameters in the low‚Äêlevel custom op function ‚Äúcutlass_scaled_mm_dq‚Äù (changing its argument names from ‚Äúa_scales, b_scales‚Äù to ‚Äúscale_a, scale_b‚Äù) and adds a new helper function ‚Äúcutlass_fp8_supported‚Äù to check CUDA/kernel compatibility. In addition, the FP8 linear quantization layer (Fp8LinearMethod) is modified so that its apply method conditionally calls the new CUTLASS-based GEMM (via ops.cutlass_scaled_mm_dq) when no bias is provided and the GPU supports CUTLASS FP8. These changes collectively affect the FP8 quantization path and its performance optimizations."
}