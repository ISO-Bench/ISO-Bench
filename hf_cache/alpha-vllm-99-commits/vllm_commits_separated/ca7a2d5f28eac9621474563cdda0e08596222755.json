{
  "commit_hash": "ca7a2d5f28eac9621474563cdda0e08596222755",
  "pr_url": "https://github.com/vllm-project/vllm/pull/14471",
  "pr_date": "2025-03-08",
  "timeline_text": "Copy link Collaborator tlrmchlsmth commented Mar 8, 2025 ‚Ä¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Running VLLM_USE_V1=1 vllm serve deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct --tensor_parallel_size=2 --port 8192 --trust-remote-code and then lm_eval --model local-completions --tasks gsm8k --model_args model=deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct,base_url=http://127.0.0.1:8192/v1/completions,num_concurrent=5,max_retries=3,tokenized_requests=False --limit 100 On current main we see: |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|‚Üë  | 0.06|¬±  |0.0239|\n|     |       |strict-match    |     5|exact_match|‚Üë  | 0.00|¬±  |0.0000| This PR: |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|‚Üë  | 0.77|¬±  |0.0423|\n|     |       |strict-match    |     5|exact_match|‚Üë  | 0.77|¬±  |0.0423| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Revert \"[Perf] Reduce MLA CPU overheads in V1 ( #14384 )\" ‚Ä¶ c671cd9 This reverts commit dae6896 . tlrmchlsmth requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners March 8, 2025 03:13 Copy link github-actions bot commented Mar 8, 2025 üëã Hi! Thank you for contributing to the vLLM project. üí¨ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. üöÄ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth mentioned this pull request Mar 8, 2025 [Bugfix][V1] Handle MLA in kv_cache_interface #14462 Merged mergify bot added\n  the v1 label Mar 8, 2025 simon-mo approved these changes Mar 8, 2025 View reviewed changes Hide details View details simon-mo merged commit ca7a2d5 into main Mar 8, 2025 21 of 23 checks passed Uh oh! There was an error while loading. Please reload this page . simon-mo deleted the revert_rope_mla_bug branch March 8, 2025 06:18 simon-mo added a commit\n        to simon-mo/vllm\n      that referenced\n      this pull request Mar 9, 2025 Revert \"Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#1‚Ä¶ ‚Ä¶ ef04b8d ‚Ä¶4384 )\" ( vllm-project#14471 )\"\n\nThis reverts commit ca7a2d5 .\n\nSigned-off-by: simon-mo <simon.mo@hey.com> simon-mo mentioned this pull request Mar 10, 2025 [Perf] Improve MLA on V1 #14540 Merged Alexei-V-Ivanov-AMD added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Mar 11, 2025 Merging in the latest merge from vllm-project to ROCm ( #472 ) ‚Ä¶ a699a11 * Fix `head_dim` not existing in all model configs (Transformers backend) ( vllm-project#14141 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V0][Metrics] Remove unimplemented `vllm:tokens_total` ( vllm-project#14134 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V0][Metrics] Deprecate some KV/prefix cache metrics ( vllm-project#14136 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1] Simplify stats logging ( vllm-project#14082 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [WIP][[V1][Metrics] Implement max_num_generation_tokens,  request_params_n, and request_params_max_tokens metrics ( vllm-project#14055 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Allow shared_experts skip quantization for DeepSeekV2/V3 ( vllm-project#14100 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add GPTQModel ( vllm-project#14056 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Add comments to the new ragged paged attention Pallas kernel ( vllm-project#14155 )\n\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\n\n* [Model] Add support for GraniteMoeShared models ( vllm-project#13313 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [core] moe fp8 block quant tuning support ( vllm-project#14068 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Remove lru_cache in NvmlCudaPlatform ( vllm-project#14156 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] Pass all driver env vars to ray workers unless excluded ( vllm-project#14099 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use math.prod instead of np.prod for trivial ops ( vllm-project#14142 )\n\n* Fix benchmark_moe.py tuning for CUDA devices ( vllm-project#14164 )\n\n* [platform] add debug logging during inferring the device type ( vllm-project#14195 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [sleep mode] error out with expandable_segments ( vllm-project#14189 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [doc] add \"Failed to infer device type\" to faq ( vllm-project#14200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Restrict MacOS CPU detection ( vllm-project#14210 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][BugFix] Fix remaining sync engine client shutdown errors/hangs ( vllm-project#13869 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V0][Metrics] Deprecate some questionable request time metrics ( vllm-project#14135 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][Molmo] Fix get_multimodal_embeddings() in molmo.py ( vllm-project#14161 )\n\n* add cutlass support for blackwell fp8 gemm ( vllm-project#13798 )\n\n* [TPU][Profiler] Support start_profile/stop_profile in TPU worker ( vllm-project#13988 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* Fix performance when `--generation-config` is not `None` ( vllm-project#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] Do `prompt_logprobs` clamping for chat as well as completions ( vllm-project#14225 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Update Dockerfile dependency image ( vllm-project#14215 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1][Metrics] Add design doc ( vllm-project#12745 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Security] Serialize using safetensors instead of pickle in Mooncake Pipe ( vllm-project#14228 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Clean up unused padding_idx variables across many model definitions ( vllm-project#13240 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [ROCm] Disable a few more kernel tests that are broken on ROCm ( vllm-project#14145 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [V1][TPU] TPU multimodal model support for ragged attention ( vllm-project#14158 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [misc] announce china meetup ( vllm-project#14248 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Moved numba from common requirements to cuda/rocm specific requirements ( vllm-project#14199 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* Disable GPTQ AllSpark kernels for CUDA Compiler < 12.0 ( vllm-project#14157 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Bugfix] Fix gptq_marlin for deepseek-v3 ( vllm-project#13750 )\n\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\n\n* [V1][Bugfix] Do not reset prefix caching metrics ( vllm-project#14235 )\n\n* [Model] New model support for Phi-4-multimodal-instruct ( vllm-project#14119 )\n\n* [V1] EP/TP MoE + DP Attention ( vllm-project#13931 )\n\n* [platforms] improve rocm debugging info ( vllm-project#14257 )\n\n* Temporarily disable test_awq_gemm_opcheck ( vllm-project#14251 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Frontend] Allow return_tokens_as_token_ids to be passed as a request param ( vllm-project#14066 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\n\n* [Misc][V1] Avoid using `envs.VLLM_USE_V1` in mm processing ( vllm-project#14256 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][V1] Fix allowed_token_ids for v1 Sampler ( vllm-project#14169 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Update nginx guide: remove privileged from vllm container run and add target GPU ID ( vllm-project#14217 )\n\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\n\n* [Doc] [3/N] Refer code examples for common cases in dev multimodal processor ( vllm-project#14278 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Small update for external_launcher backend docs ( vllm-project#14288 )\n\n* [V1][Frontend] Add Testing For V1 Runtime Parameters ( vllm-project#14159 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [LoRA] Remove linear hack outside transformers backend ( vllm-project#14177 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Add Qwen2MoeForCausalLM moe tuning support  ( vllm-project#14276 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* prefix_caching.md: Fixed typo ( vllm-project#14293 )\n\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\n\n* [Bugfix] Fix broken vision language example ( vllm-project#14292 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Docs] Add Meta Slides ( vllm-project#14297 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [V1][Minor] Remove obsolete FIXME comment ( vllm-project#14304 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* Deprecate `best_of` Sampling Parameter in anticipation for vLLM V1 ( vllm-project#13997 )\n\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][BugFix] Fix for mixed top_k batch ( vllm-project#14301 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\n\n* [misc] Add FlashMLA as a new option of VLLM_ATTENTION_BACKEND env ( vllm-project#14267 )\n\n* [V1][Easy] Add empty allowed_token_ids in the v1 sampler test ( vllm-project#14308 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* init\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Bugfix] Fix DeepSeek MTP crash when using TP1ModelRunner with CUDA graph due to shape mismatch ( vllm-project#14237 )\n\nSigned-off-by: pyc96 <pychen96@gmail.com>\n\n* [Bugfix] Remove num_tokens_across_dp ( vllm-project#14302 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [BugFix] Fix prefix caching V0 MLA ( vllm-project#14255 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\n\n* [CI/Build] Use spawn multiprocessing mode for V1 test pipeline ( vllm-project#14243 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Add benchmark for DeepGEMM and vLLM Block FP8 Dense GEMM ( vllm-project#13917 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Build] Add UV_HTTP_TIMEOUT to avoid timeout during installation ( vllm-project#13850 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] MLA + V1, illegal memory access and accuracy issues ( vllm-project#14253 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [misc] Mention `ray list nodes` command to troubleshoot ray issues ( vllm-project#14318 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [Bugfix][Structured Output] Support outlines engine with reasoning outputs for DeepSeek R1 ( vllm-project#14114 )\n\n* [V1] LoRA - Enable more V1 tests ( vllm-project#14315 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix][CI] ALiBi test case in xformers multi_query_kv_attention ( vllm-project#11301 )\n\n* [Hardware] Update the flash attn tag to support Blackwell ( vllm-project#14244 )\n\n* [Model] Update Paligemma multimodal processing with PromptUpdate  ( vllm-project#14015 )\n\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1][VLM][Pixtral-HF] Support Pixtral-HF on V1 ( vllm-project#14275 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Core] Optimizing cross-attention `QKVParallelLinear` computation ( vllm-project#12325 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\n\n* [Frontend][Docs] Transcription API streaming ( vllm-project#13301 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Doc] Update reasoning with stream example to use OpenAI library ( vllm-project#14077 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Doc] Correct beam_search using in generative_models.md ( vllm-project#14363 )\n\n* [Kernel] [V1] Improved performance for V1 Triton (ROCm) backend  ( vllm-project#14152 )\n\n* [Bugfix][Core] fix abort_seq_group and memory leak when n>1 ( vllm-project#14326 )\n\nSigned-off-by: courage17340 <courage17340@163.com>\n\n* [Core] Don't use cache during multi-modal profiling ( vllm-project#14336 )\n\n* [Doc] Fix date typo in README.md ( vllm-project#14366 )\n\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\n\n* [RLHF] use worker_extension_cls for compatibility with V0 and V1 ( vllm-project#14185 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Reinstate `best_of` for V0 ( vllm-project#14356 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Adding cpu inference with VXE ISA for s390x architecture ( vllm-project#12613 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\n\n* Add authors to license header. ( vllm-project#14371 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\n\n* Fix mla prefill context performance ( vllm-project#13897 )\n\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\n\n* [V1] Do not detokenize if sampling param detokenize is False ( vllm-project#14224 )\n\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Distributed] Add enable_expert_parallel arg ( vllm-project#14305 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build] Use uv python for docker rather than ppa:deadsnakes/ppa ( vllm-project#13569 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [CI] Disable spawn when running V1 Test ( vllm-project#14345 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Kernel] Add needs_fixed_stride_order tag to most GEMMs ( vllm-project#14306 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bugfix] Fix use_direct_call condition in FusedMoE layer for  ( vllm-project#14382 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bug] Fix Attention when ignored in by quant_method ( vllm-project#14313 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][Bugfix] Standardize quantized kv cache rejection for attention backends ( vllm-project#14221 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add nsight guide to profiling docs ( vllm-project#14298 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* cleanup boolean logic\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Hardware][TPU]Enable ragged paged attention kernel and resolve recompilation issue ( vllm-project#14310 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Doc] Fix a typo ( vllm-project#14385 )\n\n* [Bugfix] Correctly call `cudaProfilerStop` in benchmarks script ( vllm-project#14183 )\n\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\n\n* [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [FP8] Refactor apply_fp8_linear and apply_fp8_linear_generic into an object ( vllm-project#14390 )\n\nSigned-off-by: luka <luka@neuralmagic.com>\n\n* [BugFix] Illegal Memory Access in the blockwise cutlass fp8 GEMMs ( vllm-project#14396 )\n\n* [Bugfix] Fix JambaForCausalLM LoRA  ( vllm-project#14370 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Build] Add nightly wheel fallback when latest commit wheel unavailable ( vllm-project#14358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* OpenVINO: added CPU-like conditions ( vllm-project#14338 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [GH] Auto-apply multi-modality label to relevant PRs ( vllm-project#14402 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* correct wrong markdown syntax ( vllm-project#14414 )\n\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\n\n* [Bugfix] Further clean up LoRA test ( vllm-project#14422 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Clean up multi-modal processors ( vllm-project#14417 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Set default value of seed to None ( vllm-project#14274 )\n\nSigned-off-by: ‡ÆÆ‡Æ©‡Øã‡Æú‡Øç‡Æï‡ØÅ‡ÆÆ‡Ææ‡Æ∞‡Øç ‡Æ™‡Æ¥‡Æ©‡Æø‡Æö‡Øç‡Æö‡Ææ‡ÆÆ‡Æø <smartmanoj42857@gmail.com>\n\n* [BUGFIX] Skip tokenization support for throughput benchmark ( vllm-project#12712 )\n\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\n\n* Fix missing `kv_caches` and `attn_metadata` in `OpenVINOCausalLM` ( vllm-project#14271 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Use the optimized block sizes after tuning the kernel. ( vllm-project#14329 )\n\n* [V1][Core] Support for Structured Outputs ( vllm-project#12388 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Doc] Update prefix_caching.md to match the example image ( vllm-project#14420 )\n\n* [Benchmarks] Make detokenization optional in benchmark scripts ( vllm-project#11697 )\n\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\n\n* comments\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Kernel] optimize performance of gptq marlin kernel when n is small ( vllm-project#14138 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [Misc] Add Phi4-MM example ( vllm-project#14343 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [v1] torch.compile integration explanation ( vllm-project#14437 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Eagerly remove finished requests from the batch ( vllm-project#14388 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V1][Metrics] Fix traceback with preemptions+LoRA ( vllm-project#14220 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Fix torch_xla which can't handle None seed introduced in vllm-project#14274 ( vllm-project#14459 )\n\nSigned-off-by: Yarong Mu <ymu@google.com>\n\n* [V1] Prompt logprobs + APC compatibility; prompt logprobs reqs cannot fill APC ( vllm-project#13949 )\n\n* [Bugfix][V1] Handle MLA in kv_cache_interface ( vllm-project#14462 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vllm-project#14471 )\n\n* [Bugfix][Disaggregated] Add a check in send_kv_caches_and_hidden_states and fix the reshape of the KVCache ( vllm-project#14369 )\n\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\n\n* [MISC][V1] Register process killing handler only in the main thread ( vllm-project#14380 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] add `extra_args` to `SamplingParams` ( vllm-project#13300 )\n\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\n\n* [CI/Build] refactor: set timezone of container to UTC ( vllm-project#12888 )\n\nSigned-off-by: Roger Meier <r.meier@siemens.com>\n\n* Default to `generation_config` from model ( vllm-project#12622 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc]add doc for Qwen models tool calling ( vllm-project#14478 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Doc] Added QwQ-32B to the supported models list in the reasoning out‚Ä¶ ( vllm-project#14479 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Bugfix] Make the deviceprofiler include LoRA memory. ( vllm-project#14469 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Add training doc signposting to TRL ( vllm-project#14439 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Build/BugFix] Fix hopper 12.8 build ( vllm-project#14354 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add RLHF document ( vllm-project#14482 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Use a fixed seed to avoid flaky tests ( vllm-project#14480 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] TPU - Add tensor parallel support via Ray ( vllm-project#13618 )\n\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\n\n* [VLM] Add TP support for Phi-4-MM ( vllm-project#14453 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] add `use_tqdm_on_load` to reduce logs ( vllm-project#14407 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [V1][Core] Fix memory issue with logits & sampling ( vllm-project#13776 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [benchmarks] Add option to use unique jsonschema for each request ( vllm-project#14457 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Don't run ruff at all on 3rd party libs ( vllm-project#14493 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Move requirements into their own directory ( vllm-project#12547 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] DeepSeek Accuracy ( vllm-project#14476 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [Bugfix] Fix profiling OOM and decouple encoder multimodal profiling ( vllm-project#14361 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Update CODEOWNERS for structured output ( vllm-project#14496 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Upgrade to Python 3.9 typing for additional directories ( vllm-project#14492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support bad_words in sampler ( vllm-project#13376 )\n\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* Revert \"[V1][Core] Fix memory issue with logits & sampling\" ( vllm-project#14504 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Attention] Default to FlashMLA backend for MLA ( vllm-project#14451 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [V1][TPU] Remove unnecessary padding for running on TPU. ( vllm-project#14467 )\n\n* [Feat] Support chunked prefill for LMCache connector ( vllm-project#14505 )\n\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\n\n* [Bugfix] Fix tqdm progress bar when SamplingParams.n > 1 ( vllm-project#12428 )\n\nSigned-off-by: Yuchen Yan <740987012@qq.com>\n\n* [Bugfix] Revert QKVCrossParallelLinear usage in Mllama to keep BNB quantization work ( vllm-project#14498 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] Fix the recompiling issue in logits processor after warmup ( vllm-project#14510 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Misc] Ensure out-of-tree quantization method recognize by cli args ( vllm-project#14328 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Bugfix] Wrong requirements path - rocm ( vllm-project#14527 )\n\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\n\n* [Feature] Consolidate performance benchmark datasets ( vllm-project#14036 )\n\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Add log information for handle_process_request. ( vllm-project#14130 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Docs] Mention `model_impl` arg when explaining Transformers fallback ( vllm-project#14552 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] support image embeds ( vllm-project#13955 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Kernel] Add more dtype support for GGUF kernels ( vllm-project#14043 )\n\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\n\n* [Doc] Update PaliGemma note to a warning ( vllm-project#14565 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* V1 rocm support ( #469 )\n\n* Initial commit for V1 successfull compilation\n\n* Small improvement for linear\n\n* Small improvement for linear\n\n* making use of forward_cuda for all except ROPE in llama\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* nightly_fixed_aiter_integration_final_20250305 README update ( #470 )\n\n* nightly_fixed_aiter_integration_final_20250305 README update (perf results only)\n\n* Update Docker Manifest git hash\n\n* Update Docker Manifest and added nightly_fixed_aiter_integration_final_20250305\n\n* some more updates\n\n* Update AITER section with example\n\n* Updated AITER command with larger batch size and model name\n\n* Fixing typo\n\n* Removed --max-model-len in AITER command\n\n* Updating AITER instructions\n\n* typo\n\n* Another typo\n\n* Whitespace\n\n* modifying whats new section\n\n* Another typo\n\n---------\n\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: pyc96 <pychen96@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\nSigned-off-by: courage17340 <courage17340@163.com>\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\nSigned-off-by: luka <luka@neuralmagic.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\nSigned-off-by: ‡ÆÆ‡Æ©‡Øã‡Æú‡Øç‡Æï‡ØÅ‡ÆÆ‡Ææ‡Æ∞‡Øç ‡Æ™‡Æ¥‡Æ©‡Æø‡Æö‡Øç‡Æö‡Ææ‡ÆÆ‡Æø <smartmanoj42857@gmail.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Yarong Mu <ymu@google.com>\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\nSigned-off-by: Roger Meier <r.meier@siemens.com>\nSigned-off-by: WangErXiao <863579016@qq.com>\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Yuchen Yan <740987012@qq.com>\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Qubitium-ModelCloud <qubitium@modelcloud.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: iefgnoix <isaacwxf23@gmail.com>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Zhanwen Chen <phil.zhanwen.chen@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: kushanam <42385577+kushanam@users.noreply.github.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: rainkert <93575312+rainkert@users.noreply.github.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: Congcong Chen <congcongchen@microsoft.com>\nCo-authored-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Iacopo Poli <iacopo@lighton.ai>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Zhe Zhang <zhz@apache.org>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: DaividFrank <49250948+DaividFrank@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Vincent <vincentzhongy+githubvincent4@gmail.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\nCo-authored-by: Serena <yangsijia.614@bytedance.com>\nCo-authored-by: pyc96 <pychen96@gmail.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Ce Gao <cegao@tensorchord.ai>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Nicol√≤ Lucchesi <nlucches@redhat.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: kYLe <kylhuang@nvidia.com>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: Yanyi Liu <wolfsonliu@163.com>\nCo-authored-by: Irina Yuryeva <76484191+upayuryeva@users.noreply.github.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: courage17340 <courage17340@users.noreply.github.com>\nCo-authored-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\nCo-authored-by: Himanshu Jaju <hj@mistral.ai>\nCo-authored-by: Chengji Yao <chengjiyao@google.com>\nCo-authored-by: Daniel Li <dyli@google.com>\nCo-authored-by: Luka Govediƒç <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Peng Li <justdoit.pli@gmail.com>\nCo-authored-by: ‡ÆÆ‡Æ©‡Øã‡Æú‡Øç‡Æï‡ØÅ‡ÆÆ‡Ææ‡Æ∞‡Øç ‡Æ™‡Æ¥‡Æ©‡Æø‡Æö‡Øç‡Æö‡Ææ‡ÆÆ‡Æø <smartmanoj42857@gmail.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: York-RDWang <103811994+York-RDWang@users.noreply.github.com>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: yarongmu-google <150371854+yarongmu-google@users.noreply.github.com>\nCo-authored-by: afeldman-nm <156691304+afeldman-nm@users.noreply.github.com>\nCo-authored-by: Mathis Felardos <mathis@mistral.ai>\nCo-authored-by: Aviv Keshet <akeshet@scaledcognition.com>\nCo-authored-by: Roger Meier <r.meier@siemens.com>\nCo-authored-by: Robin <863579016@qq.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-redhat@users.noreply.github.com>\nCo-authored-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Yuchen Yan <50619811+yanyc428@users.noreply.github.com>\nCo-authored-by: Martin Hoyer <mhoyer@redhat.com>\nCo-authored-by: Jennifer Zhao <JenZhao@users.noreply.github.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: Szymon O≈º√≥g <58388001+SzymonOzog@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Mcirino1 <57415822+Mcirino1@users.noreply.github.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com> captainzmc pushed a commit\n        to captainzmc/vllm\n      that referenced\n      this pull request Mar 12, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( v‚Ä¶ ‚Ä¶ f08a8d3 ‚Ä¶llm-project#14471 ) LucasWilkinson mentioned this pull request Mar 13, 2025 [Attention] Remove slow setattr in MLA #14769 Merged lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( v‚Ä¶ ‚Ä¶ 0492d83 ‚Ä¶llm-project#14471 )\n\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( v‚Ä¶ ‚Ä¶ 7e10bb8 ‚Ä¶llm-project#14471 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-07 17:52:06",
  "has_lm_eval": true,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "LM_EVAL: lm_eval, gsm8k, gsm8k | PERF: throughput, improvement, improvement | SERVING: vllm serve, serve, Frontend | TEST: test, test, test",
  "analysis_extracted_at": "2025-09-07 17:52:06",
  "models": [
    "deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct"
  ],
  "lm_eval_commands": [
    "lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"
  ],
  "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct --dtype float16 --num-prompts 300 --seed 0",
  "commit_subject": "Revert \"[Perf] Reduce MLA CPU overheads in V1 (#14384)\" (#14471)",
  "commit_message": "Revert \"[Perf] Reduce MLA CPU overheads in V1 (#14384)\" (#14471)",
  "commit_date": "2025-03-07T22:18:53-08:00",
  "files_changed": [
    "vllm/model_executor/layers/rotary_embedding.py",
    "vllm/v1/attention/backends/mla/common.py"
  ],
  "functions_changed": [],
  "stats": {
    "num_test_files": 0,
    "num_non_test_files": 2,
    "only_test_files": 0,
    "only_non_test_files": 1,
    "num_files": 2,
    "num_hunks": 3,
    "num_edited_lines": 24,
    "num_non_test_edited_lines": 24,
    "commit_year": 2025
  },
  "diff_text": "diff --git a/vllm/model_executor/layers/rotary_embedding.py b/vllm/model_executor/layers/rotary_embedding.py\nindex 48cdebee9..64c2dac52 100644\n--- a/vllm/model_executor/layers/rotary_embedding.py\n+++ b/vllm/model_executor/layers/rotary_embedding.py\n@@ -161,13 +161,8 @@ class RotaryEmbedding(CustomOp):\n     ) -> Tuple[torch.Tensor, torch.Tensor]:\n         from vllm import _custom_ops as ops\n \n-        # __setattr__ in nn.Module (called by `self.cos_sin_cache = ...`)\n-        # is expensive, so avoid calling it if possible\n-        if self.cos_sin_cache.device != query.device or \\\n-            self.cos_sin_cache.dtype != query.dtype:\n-            self.cos_sin_cache = self.cos_sin_cache.to(query.device,\n-                                                       dtype=query.dtype)\n-\n+        self.cos_sin_cache = self.cos_sin_cache.to(query.device,\n+                                                   dtype=query.dtype)\n         # ops.rotary_embedding()/batched_rotary_embedding()\n         # are in-place operations that update the query and key tensors.\n         if offsets is not None:\ndiff --git a/vllm/v1/attention/backends/mla/common.py b/vllm/v1/attention/backends/mla/common.py\nindex f3fff585b..886295ee8 100644\n--- a/vllm/v1/attention/backends/mla/common.py\n+++ b/vllm/v1/attention/backends/mla/common.py\n@@ -222,8 +222,8 @@ from vllm.model_executor.layers.quantization.utils.fp8_utils import (\n     Fp8LinearGenericOp, current_platform_fp8_dtype, is_fp8)\n from vllm.model_executor.layers.quantization.utils.quant_utils import (\n     scaled_quantize)\n-from vllm.model_executor.layers.rotary_embedding import RotaryEmbedding\n-from vllm.platforms import current_platform\n+from vllm.model_executor.layers.rotary_embedding import (\n+    DeepseekScalingRotaryEmbedding, RotaryEmbedding)\n from vllm.utils import cdiv, round_down\n \n try:\n@@ -627,15 +627,8 @@ class MLACommonImpl(MLAAttentionImpl[M], Generic[M]):\n         self.v_head_dim = v_head_dim\n \n         self.rotary_emb = rotary_emb\n-\n-        if current_platform.is_cuda():\n-            # Hack for V1 for now to avoid torch library overhead (since we are\n-            # already inside an attention custom op), pull out the forward\n-            # method from the rotary embedding and call it directly (and avoid\n-            # calling forward_native, when we can call forward_cuda)\n-            # TODO(lucas): we should probably find a cleaner way to do this\n-            self.rotary_emb = rotary_emb.forward_cuda\n-\n+        self.use_yarn_rope = isinstance(rotary_emb,\n+                                        DeepseekScalingRotaryEmbedding)\n         self.q_proj = q_proj\n         self.kv_b_proj = kv_b_proj\n         self.o_proj = o_proj",
  "apis": [
    "vllm.model_executor.layers.rotary_embedding.RotaryEmbedding.forward_cuda",
    "vllm.v1.attention.backends.mla.common.MLACommonImpl.__init__"
  ],
  "affected_paths": [
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/rotary_embedding.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/common.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/mla/common.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/common.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/cutlass_mla.py"
  ],
  "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm",
  "llm_reason": "The commit reverts a previous change tagged as a performance improvement (‚Äú[Perf] Reduce MLA CPU overheads in V1‚Äù). It modifies multiple non-test source files. In rotary_embedding.py, it removes a conditional check before converting tensor types and devices (likely introduced previously as a performance optimization to avoid expensive __setattr__ calls). In mla/common.py it removes a hack that bypassed extra function calls on CUDA devices, reverting to a more standard behavior by using a type-check instead. These changes are non-trivial modifications to internal API behavior and impact CPU performance. They are not merely refactoring, documentation, or bug fixes. Thus, the commit is performance or optimization related.",
  "llm_api_reason": "In the first file the commit removes a conditional check when moving the cos_sin_cache to the query‚Äôs device and dtype inside the RotaryEmbedding.forward_cuda method ‚Äì now the cache is always converted. In the second file the import statement is updated to also import DeepseekScalingRotaryEmbedding, and instead of ‚Äúhacking‚Äù by replacing the rotary_emb with its forward_cuda method on CUDA platforms, the MLACommonImpl initializer now sets an attribute (use_yarn_rope) based on whether the provided rotary embedding is an instance of DeepseekScalingRotaryEmbedding. These changes affect the behavior of rotary positional embedding during inference and how the MLA attention implementation in V1 chooses its rotary method."
}