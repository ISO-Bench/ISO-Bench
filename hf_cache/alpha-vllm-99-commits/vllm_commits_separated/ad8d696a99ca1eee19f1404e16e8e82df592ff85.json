{
  "commit_hash": "ad8d696a99ca1eee19f1404e16e8e82df592ff85",
  "pr_url": "https://github.com/vllm-project/vllm/pull/4270",
  "pr_date": "2024-04-22",
  "timeline_text": "Copy link Collaborator rkooo567 commented Apr 22, 2024 After the scheduler refactoring PR, the scheduler iteration overhead became 2ms -> 11ms. The major overhead was coming from logger.debug added to schedule_running. The main issue I think was that fstring is always evaluated although logger.debug is used, which causes additional overhead. Adding a very small overhead (less than 5us) changes e2e throughput a lot for the scheduler. scheduler after fix\nThroughput: 10.77 requests/s, 5514.02 tokens/s\niter takes 0.8~2.5ms\n\nscheduler before regrssion\nThroughput: 11.37 requests/s, 5821.86 tokens/s\niter takes 0.5~2ms\n\n(5514.02 - 5821.86) / 5821.86 * 100 = -5.28 PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions rkooo567 added 5 commits April 22, 2024 02:20 ip 31c9e5b fix one issue ac78b77 , cc1b303 done d741157 done 915fdde rkooo567 changed the title Scheduler perf fix [Core] Scheduler perf fix Apr 22, 2024 rkooo567 mentioned this pull request Apr 22, 2024 [Core] Fix scheduler perf regression #4261 Closed simon-mo approved these changes Apr 22, 2024 View reviewed changes simon-mo enabled auto-merge (squash) April 22, 2024 16:33 Copy link Collaborator comaniac commented Apr 22, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This is a very good example of logging-fstring-interpolation (W1203) . Could you also try this to see if this performance is preserved? If so, we can enable logging-fstring-interpolation and logging-not-lazy to CI linting. logger.debug(\"add_seq_group %s\", seq_group.request_id) ðŸ‘ 4 simon-mo, richardliaw, AaronFriel, and rkooo567 reacted with thumbs up emoji All reactions ðŸ‘ 4 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . fix test 0fce8f0 simon-mo merged commit ad8d696 into vllm-project : main Apr 22, 2024 Copy link Collaborator Author rkooo567 commented Apr 22, 2024 @comaniac let me try today! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cadedaniel mentioned this pull request Apr 23, 2024 [Core] Enable prefix caching with block manager v2 enabled #4142 Merged rkooo567 mentioned this pull request Apr 24, 2024 [CI] Disable non-lazy string operation on logging #4326 Merged Copy link Collaborator Author rkooo567 commented Apr 24, 2024 @comaniac #4326 Besides, I tried what you suggested on the scheduler, but somehow it is still slower (faster than fstring). So I guess using logger at all is not desirable in the scheduler All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Apr 25, 2024 Thanks for trying that. I guess it means logger overhead cannot be ignored in some very intense places. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Apr 25, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) e8a65e2 robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Apr 26, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) 542dc70 alexeykondrat pushed a commit\n        to alexeykondrat/ci-vllm\n      that referenced\n      this pull request May 1, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) 81e9afe z103cb pushed a commit\n        to z103cb/opendatahub_vllm\n      that referenced\n      this pull request May 7, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) c10e074 dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-07 17:49:06",
  "has_lm_eval": false,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "PERF: throughput, Throughput, Throughput | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, CI",
  "analysis_extracted_at": "2025-09-07 17:49:06",
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "[Core] Scheduler perf fix (#4270)",
  "commit_message": "[Core] Scheduler perf fix (#4270)",
  "commit_date": "2024-04-22T21:11:06Z",
  "files_changed": [
    "tests/core/test_scheduler.py",
    "vllm/core/scheduler.py"
  ],
  "functions_changed": [],
  "stats": {
    "num_test_files": 1,
    "num_non_test_files": 1,
    "only_test_files": 0,
    "only_non_test_files": 0,
    "num_files": 2,
    "num_hunks": 13,
    "num_edited_lines": 25,
    "num_non_test_edited_lines": 7,
    "commit_year": 2024
  },
  "diff_text": "diff --git a/tests/core/test_scheduler.py b/tests/core/test_scheduler.py\nindex 9588a1bea..a25112385 100644\n--- a/tests/core/test_scheduler.py\n+++ b/tests/core/test_scheduler.py\n@@ -540,7 +540,7 @@ def test_decode_schedule_preempted():\n     curr_loras = None\n     for i in range(3):\n         _, seq_group = create_dummy_prompt(str(i), prompt_length=60)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         running.append(seq_group)\n     scheduler.block_manager.can_append_slots = MagicMock()\n@@ -581,7 +581,7 @@ def test_decode_swap_beam_search():\n     budget = create_token_budget()\n     for i in range(3):\n         _, seq_group = create_dummy_prompt(str(i), prompt_length=60, best_of=2)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         running.append(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         budget.add_num_seqs(seq_group.request_id,\n@@ -629,7 +629,7 @@ def test_schedule_decode_blocks_to_copy_update():\n     running = deque()\n     policy = PolicyFactory.get_policy(policy_name=\"fcfs\")\n     curr_loras = None\n-    scheduler._allocate_and_set_running(seq_group, 60)\n+    scheduler._allocate_and_set_running(seq_group)\n     append_new_token_seq_group(60, seq_group, 1)\n     running.append(seq_group)\n \n@@ -659,7 +659,7 @@ def test_schedule_swapped_simple():\n     curr_loras = None\n     blocks_to_swap_out = {}\n     _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-    scheduler._allocate_and_set_running(seq_group, 60)\n+    scheduler._allocate_and_set_running(seq_group)\n     append_new_token_seq_group(60, seq_group, 1)\n     scheduler._swap_out(seq_group, blocks_to_swap_out)\n     swapped.append(seq_group)\n@@ -687,7 +687,7 @@ def test_schedule_swapped_max_token_budget():\n     blocks_to_swap_out = {}\n     for _ in range(2):\n         _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -721,7 +721,7 @@ def test_schedule_swapped_max_seqs():\n     blocks_to_swap_out = {}\n     for i in range(4):\n         _, seq_group = create_dummy_prompt(str(i), prompt_length=60)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -759,7 +759,7 @@ def test_schedule_swapped_max_loras():\n                                                lora_name=str(i),\n                                                lora_int_id=i + 1,\n                                                lora_local_path=\"abc\"))\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -783,7 +783,7 @@ def test_schedule_swapped_cannot_swap_in():\n     blocks_to_swap_out = {}\n     for _ in range(2):\n         _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -808,7 +808,7 @@ def test_schedule_swapped_blocks_to_copy():\n     policy = PolicyFactory.get_policy(policy_name=\"fcfs\")\n     curr_loras = None\n     _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-    scheduler._allocate_and_set_running(seq_group, 60)\n+    scheduler._allocate_and_set_running(seq_group)\n     append_new_token_seq_group(60, seq_group, 1)\n     blocks_to_swap_out = {}\n     scheduler._swap_out(seq_group, blocks_to_swap_out)\ndiff --git a/vllm/core/scheduler.py b/vllm/core/scheduler.py\nindex 419855062..8d7db09bb 100644\n--- a/vllm/core/scheduler.py\n+++ b/vllm/core/scheduler.py\n@@ -297,7 +297,6 @@ class Scheduler:\n \n     def add_seq_group(self, seq_group: SequenceGroup) -> None:\n         # Add sequence groups to the waiting queue.\n-        logger.debug(f\"add_seq_group {seq_group.request_id}\")\n         self.waiting.append(seq_group)\n \n     def abort_seq_group(self, request_id: Union[str, Iterable[str]]) -> None:\n@@ -427,7 +426,6 @@ class Scheduler:\n                         swapped_out.append(seq_group)\n                     break\n             else:\n-                logger.debug(f\"append slot for {seq_group}\")\n                 self._append_slots(seq_group, blocks_to_copy)\n                 is_prefill = seq_group.is_prefill()\n                 if is_prefill:\n@@ -659,7 +657,7 @@ class Scheduler:\n             if curr_loras is not None and lora_int_id > 0:\n                 curr_loras.add(lora_int_id)\n             waiting_queue.popleft()\n-            self._allocate_and_set_running(seq_group, num_new_tokens)\n+            self._allocate_and_set_running(seq_group)\n             seq_groups.append(\n                 ScheduledSequenceGroup(seq_group=seq_group,\n                                        token_chunk_size=num_new_tokens))\n@@ -952,8 +950,7 @@ class Scheduler:\n         self.running = deque(seq_group for seq_group in self.running\n                              if not seq_group.is_finished())\n \n-    def _allocate_and_set_running(self, seq_group: SequenceGroup,\n-                                  num_new_tokens: int) -> None:\n+    def _allocate_and_set_running(self, seq_group: SequenceGroup) -> None:\n         self.block_manager.allocate(seq_group)\n         for seq in seq_group.get_seqs(status=SequenceStatus.WAITING):\n             seq.status = SequenceStatus.RUNNING",
  "apis": [
    "vllm.core.scheduler.Scheduler._allocate_and_set_running"
  ],
  "affected_paths": [
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/scheduler.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/scheduler.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"
  ],
  "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm",
  "llm_reason": "The commit modifies both test files and a core scheduler source file, meaning it changes non-test code. The change involves removing an unnecessary parameter from the _allocate_and_set_running function and adjusting related calls. Although it might superficially appear as a refactor (removing unused parameters and debug logs), the commit message \"[Core] Scheduler perf fix\" indicates a performance-related fix. The modifications potentially remove overhead (e.g. eliminating redundant token count handling) and simplify scheduling which could improve runtime efficiency of a high-level API (the scheduler) running on CPU. Thus, the changes satisfy the conditions as a performance/optimization-related commit.",
  "llm_api_reason": "This commit removes the extra parameter (num_new_tokens) from the internal Scheduler method _allocate_and_set_running â€“ updating its signature and all the call sites (including in tests) to no longer pass a token-count argument. This change simplifies the methodâ€™s API so that token allocation is handled internally rather than requiring a caller-supplied value, thereby improving performance and consistency."
}