{
  "commit_hash": "d55e446d1320d0f5f22bc3584f81f18d7924f166",
  "pr_url": "https://github.com/vllm-project/vllm/pull/18424",
  "pr_date": "2025-05-20",
  "timeline_text": "Copy link Collaborator zixi-qi commented May 20, 2025 ‚Ä¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Applied several small refactors to improve eagle bookkeeping performance: async h2d with pinned memory removed a synchronization point by caching total number of tokens in SpecDecodeMetadata use torch.zeros to replace torch.empty + assignment (h2d) Saves ~50us time per iteration on Llama3 8b w/ bs=2. before after Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 draftbk reacted with thumbs up emoji All reactions üëç 1 reaction zixi-qi requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners May 20, 2025 15:58 Copy link github-actions bot commented May 20, 2025 üëã Hi! Thank you for contributing to the vLLM project. üí¨ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. üöÄ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label May 20, 2025 Copy link mergify bot commented May 21, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @zixi-qi . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label May 21, 2025 WoosukKwon reviewed May 21, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @zixi-qi Thanks for the PR! Left some minor comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/worker/gpu_model_runner.py Outdated Comment on lines 1379 to 1380 num_tokens = spec_decode_metadata.total_num_scheduled_tokens - \\ sum(num_rejected_tokens) Copy link Collaborator WoosukKwon May 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: please refrain from using \\ Suggested change num_tokens = spec_decode_metadata . total_num_scheduled_tokens - \\ sum ( num_rejected_tokens ) num_tokens = ( spec_decode_metadata . total_num_scheduled_tokens - sum ( num_rejected_tokens ) ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 zixi-qi reacted with thumbs up emoji All reactions üëç 1 reaction Copy link Collaborator Author zixi-qi May 23, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks updated! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/worker/gpu_model_runner.py Outdated @@ -883,6 +883,7 @@ def _calc_spec_decode_metadata( target_logits_indices=target_logits_indices, bonus_logits_indices=bonus_logits_indices, logits_indices=logits_indices, total_num_scheduled_tokens=cu_num_scheduled_tokens[-1], Copy link Collaborator WoosukKwon May 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do we actually need to store it in SpecDecodeMetadata ? I'm wondering because the same variable is available in execute_model . Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author zixi-qi May 23, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment You are right, removed the additional field in SpecDecodeMetadata Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link leo-cf-tian commented May 21, 2025 (Follow-up to a deleted comment) I flagged an issue here a few minutes ago and it turns out the error was from the base repo, not this PR. Deleted the earlier comment from earlier and made this one to avoid confusion. Sorry if I cause any trouble. üëç 2 zixi-qi and WoosukKwon reacted with thumbs up emoji All reactions üëç 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot removed\n  the needs-rebase label May 23, 2025 zixi-qi force-pushed the spec_decode_perf branch\n    from 20b3864 to d07a3c5 Compare May 23, 2025 21:03 Copy link mergify bot commented May 23, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @zixi-qi . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label May 23, 2025 zixi-qi added 3 commits May 23, 2025 15:18 small perf improvements ‚Ä¶ 2e5efa8 Signed-off-by: qizixi <qizixi@meta.com> address comments ‚Ä¶ 0e1d9af Signed-off-by: qizixi <qizixi@meta.com> rebase ‚Ä¶ 2945178 Signed-off-by: qizixi <qizixi@meta.com> zixi-qi force-pushed the spec_decode_perf branch\n    from d07a3c5 to 2945178 Compare May 23, 2025 22:21 mergify bot removed\n  the needs-rebase label May 23, 2025 WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label May 24, 2025 WoosukKwon approved these changes May 24, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon enabled auto-merge (squash) May 24, 2025 03:27 Hide details View details WoosukKwon merged commit d55e446 into vllm-project : main May 24, 2025 71 checks passed Uh oh! There was an error while loading. Please reload this page . zzzyq pushed a commit\n        to zzzyq/vllm\n      that referenced\n      this pull request May 24, 2025 [V1][Spec Decode] Small refactors to improve eagle bookkeeping perfor‚Ä¶ ‚Ä¶ be2ab55 ‚Ä¶mance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com> zixi-qi deleted the spec_decode_perf branch May 24, 2025 15:11 zzzyq pushed a commit\n        to zzzyq/vllm\n      that referenced\n      this pull request May 25, 2025 [V1][Spec Decode] Small refactors to improve eagle bookkeeping perfor‚Ä¶ ‚Ä¶ 89c1867 ‚Ä¶mance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com> gshtras added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request May 27, 2025 Upstream merge 2025 05 27 ( #557 ) ‚Ä¶ 1900335 * Add files via uploadAdd fused MoE kernel tuning configs (fp8_w8a8) for DeepSeek V3/R1 on a single-node 8x NVIDIA H20 96GB setup ( vllm-project#18337 )\n\n* [Misc] Fix typo ( vllm-project#18330 )\n\n* Neuron up mistral ( vllm-project#18222 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* fix CUDA_check redefinition in vllm-project#17918 ( vllm-project#18287 )\n\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\n\n* [neuron] fix authorization issue ( vllm-project#18364 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Misc] Allow `AutoWeightsLoader` to skip loading weights with specific substr in name ( vllm-project#18358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] [Bugfix]: tensor parallel with prompt embeds ( vllm-project#18171 )\n\nSigned-off-by: Nan2018 <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\n\n* [release] Change dockerhub username for TPU release ( vllm-project#18389 )\n\n* [Bugfix] fix adding bias twice in ipex GPTQ quantization ( vllm-project#18363 )\n\nSigned-off-by: rand-fly <randfly@outlook.com>\n\n* [doc] update env variable export ( vllm-project#18391 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Add LoRA code owner ( vllm-project#18387 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Update cpu.txt ( vllm-project#18398 )\n\nSigned-off-by: Ê±™ÂøóÈπè <wangzhipeng628@gmail.com>\n\n* [CI] Add mteb testing to test the accuracy of the embedding model ( vllm-project#17175 )\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\n\nCo-authored-by: ÊùæÁÅµ <wpf272043@alibaba-inc.com>\n\n* [Misc] refactor prompt embedding examples ( vllm-project#18405 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Minor] Rename quantization nvfp4 to modelopt_fp4 ( vllm-project#18356 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Model] use AutoWeightsLoader for bloom ( vllm-project#18300 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [Kernel] update comment for KV shape in unified triton attn ( vllm-project#18099 )\n\nSigned-off-by: haochengxia <xhc_1007@163.com>\n\n* fix:Build torch wheel inline rather than picking from nightly ( vllm-project#18351 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\n\n* [TPU] Re-enable the Pallas MoE kernel ( vllm-project#18025 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [Bugfix] config.head_dim is now explicitly set to None ( vllm-project#18432 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [Bug] Fix moe_sum signature ( vllm-project#18440 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* Revert \"[Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\" ( vllm-project#18456 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Failing Test] Fix nixl connector test when promt size < block size ( vllm-project#18429 )\n\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\n\n* [Misc] MultiConnector._connectors type ( vllm-project#18423 )\n\nSigned-off-by: nicklucche <nlucches@redhat.com>\n\n* [Frontend] deprecate `--device` arg ( vllm-project#18399 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [V1] Fix general plugins not loaded in engine for multiproc ( vllm-project#18326 )\n\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\n\n* [Misc] refactor disaggregated-prefill-v1 example ( vllm-project#18474 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Failing Test] Fix test_events.py ( vllm-project#18460 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [MODEL] FalconH1 ( vllm-project#18406 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [Doc] fix arg docstring in linear layers ( vllm-project#18410 )\n\nSigned-off-by: giantcroc <1204449533@qq.com>\n\n* [Bugfix] Reduce moe_sum test size to avoid OOM ( vllm-project#18484 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* [Build] fix Dockerfile shell ( vllm-project#18402 )\n\n* [Misc] Update deprecation message for `--enable-reasoning` ( vllm-project#18404 )\n\n* [ROCm][Kernel][V1] Enable AMD Radeon GPU Custom Paged Attention on v1 ( vllm-project#17004 )\n\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\n\n* Remove incorrect env value\n\n* Revert \"[v1] Support multiple KV cache groups in GPU model runner ( vllm-project#17945 ) ( vllm-project#18459 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [FEAT][ROCm] Upgrade AITER MLA v1 backend ( vllm-project#18338 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka Govediƒç <ProExpertProg@users.noreply.github.com>\n\n* [Bugfix] Consistent ascii handling in tool parsers ( vllm-project#17704 )\n\nSigned-off-by: Sebastian Sch√∂nnenbeck <sebastian.schoennenbeck@comma-soft.com>\n\n* [FalconH1] Fix output dtype in RMSNorm fallback path for Falcon-H1 (e.g. 0.5B) ( vllm-project#18500 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [MISC] update project urls in pyproject.toml ( vllm-project#18519 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [CI] Fix race condition with StatelessProcessGroup.barrier ( vllm-project#18506 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Intialize io_thread_pool attribute in the beginning. ( vllm-project#18331 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [Bugfix] Inconsistent token calculation compared to HF in llava family ( vllm-project#18479 )\n\nSigned-off-by: jaycha <jaycha@ncsoft.com>\n\n* [BugFix][DP] Send DP wave completion only from `dp_rank==0` ( vllm-project#18502 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\n\n* [Bugfix][Model] Make Olmo2Model weight loading return loaded weights ( vllm-project#18504 )\n\nSigned-off-by: Shane A <shanea@allenai.org>\n\n* [Bugfix] Fix LoRA test ( vllm-project#18518 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Doc] Fix invalid JSON in example args ( vllm-project#18527 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Neuron] Update Dockerfile.neuron to use latest neuron release (2.23) ( vllm-project#18512 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* Update default neuron config for speculation ( vllm-project#18274 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* Order sequence ids + config update to support specifying custom quantization layers ( vllm-project#18279 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18526 )\n\nCo-authored-by: ÊùæÁÅµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Add kwargs to RequestOutput __init__ to be forward compatible ( vllm-project#18513 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [CI/Build] Update bamba test model location ( vllm-project#18544 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc] Support --stream arg in openai_completion_client.py script ( vllm-project#18388 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Use random hidden states in dummy sampler run ( vllm-project#18543 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\n\n* [Doc] Add stream flag for chat completion example ( vllm-project#18524 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [BugFix][CPU] Fix x86 SHM distributed module initialization ( vllm-project#18536 )\n\nSigned-off-by: jiang.li <jiang1.li@intel.com>\n\n* [Misc] improve Automatic Prefix Caching example ( vllm-project#18554 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Call `ndarray.tobytes()` directly instead of `ndarray.data.tobytes()` ( vllm-project#18347 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Bugfix] make `test_openai_schema.py` pass ( vllm-project#18224 )\n\nSigned-off-by: David Xia <david@davidxia.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Platform] Move platform check to right place ( vllm-project#18470 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Compile][Platform] Make PiecewiseBackend pluggable and extendable ( vllm-project#18076 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Build/CI] Fix CUDA 11.8 build ( vllm-project#17679 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Tool] Add NIXL installation script ( vllm-project#18172 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [V1][Spec Decode][Bugfix] Load quantize weights for EAGLE ( vllm-project#18290 )\n\n* [Frontend][Bug Fix] Update llama4 pythonic jinja template and llama4_pythonic parser ( vllm-project#17917 )\n\nSigned-off-by: Kai Wu <kaiwu@meta.com>\n\n* [Frontend] [Core] Add Tensorizer support for V1, LoRA adapter serialization and deserialization ( vllm-project#17926 )\n\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\n\n* [AMD] [P/D] Compute num gpus for ROCm correctly in run_accuracy_test.sh ( vllm-project#18568 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* Re-submit: Fix: Proper RGBA -> RGB conversion for PIL images. ( vllm-project#18569 )\n\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\n\n* [V1][Spec Decoding] Use model_loader.get_model() to load models ( vllm-project#18273 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Enable hybrid attention models for Transformers backend ( vllm-project#18494 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] refactor: simplify input validation and num_requests handling in _convert_v1_inputs ( vllm-project#18482 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [BugFix] Increase TP execute_model timeout ( vllm-project#18558 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [Bugfix] Set `KVTransferConfig.engine_id` in post_init ( vllm-project#18576 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Spec Decode] Make EAGLE3 draft token ID mapping optional ( vllm-project#18488 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Neuron] Remove bypass on EAGLEConfig and add a test ( vllm-project#18514 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\n\n* [Bugfix][Benchmarks] Fix a benchmark of deepspeed-mii backend to use api_key ( vllm-project#17291 )\n\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\n\n* [Misc] Replace `cuda` hard code with `current_platform` ( vllm-project#16983 )\n\nSigned-off-by: shen-shanshan <467638484@qq.com>\n\n* [Hardware] correct method signatures for HPU,ROCm,XPU ( vllm-project#18551 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\n\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\n\n* [Feature]Add async tensor parallelism using compilation pass ( vllm-project#17882 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* [Doc] Update quickstart and install for cu128 using `--torch-backend=auto` ( vllm-project#18505 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Feature][V1]: suupports cached_tokens in response usage ( vllm-project#18149 )\n\nCo-authored-by: simon-mo <xmo@berkeley.edu>\n\n* [Bugfix] Add half type support in reshape_and_cache_cpu_impl on x86 cpu platform ( vllm-project#18430 )\n\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\n\n* Migrate docs from Sphinx to MkDocs ( vllm-project#18145 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Revert \"[V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\" ( vllm-project#18600 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Model] Fix baichuan model loader for tp ( vllm-project#18597 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [V0][Bugfix] Fix parallel sampling performance regression when guided decoding is enabled ( vllm-project#17731 )\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\n\n* Add myself as docs code owner ( vllm-project#18605 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Hardware][CPU] Update intel_extension_for_pytorch 2.7.0 and move to `requirements/cpu.txt`  ( vllm-project#18542 )\n\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\n\n* [CI] fix kv_cache_type argument ( vllm-project#18594 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Doc] Fix indent of contributing to vllm ( vllm-project#18611 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* Replace `{func}` with mkdocs style links ( vllm-project#18610 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Fix V1 flag being set in entrypoints tests ( vllm-project#18598 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Fix examples with code blocks in docs ( vllm-project#18609 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix transformers model impl ignored for mixtral quant ( vllm-project#18602 )\n\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\n\n* Include private attributes in API documentation ( vllm-project#18614 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] add Haystack integration ( vllm-project#18601 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Build/CI] Fixup CUDA compiler version check for CUDA_SUPPORTED_ARCHS ( vllm-project#18579 )\n\n* [Doc] Fix markdown list indentation for MkDocs rendering ( vllm-project#18620 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [Doc] Use a different color for the announcement ( vllm-project#18616 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Refactor pplx init logic to make it modular (prepare for deepep) ( vllm-project#18200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix figures in design doc ( vllm-project#18612 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Change mkdocs to not use directory urls ( vllm-project#18622 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Redo \"Support multiple KV cache groups in GPU model runner ( vllm-project#17945 )\" ( vllm-project#18593 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc] fix list formatting ( vllm-project#18624 )\n\nSigned-off-by: David Xia <david@davidxia.com>\n\n* [Doc] Fix top-level API links/docs ( vllm-project#18621 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Avoid documenting dynamic / internal modules ( vllm-project#18626 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix broken links and unlinked docs, add shortcuts to home sidebar ( vllm-project#18627 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support Deepseek MTP ( vllm-project#18435 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use prebuilt FlashInfer x86_64 PyTorch 2.7 CUDA 12.8 wheel for CI ( vllm-project#18537 )\n\nSigned-off-by: Huy Do <huydhn@gmail.com>\n\n* [CI] Enable test_initialization to run on V1 ( vllm-project#16736 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Doc] Update references to doc files ( vllm-project#18637 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ModelOpt] Introduce VLLM_MAX_TOKENS_PER_EXPERT_FP4_MOE env var to control blockscale tensor allocation ( vllm-project#18160 )\n\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\n\n* [Bugfix] Migrate to REGEX Library to prevent catastrophic backtracking ( vllm-project#18454 )\n\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\n\n* [Bugfix][Nixl] Fix Preemption Bug ( vllm-project#18631 )\n\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\n\n* config.py: Clarify that only local GGUF checkpoints are supported. ( vllm-project#18623 )\n\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\n\n* FIX MOE issue in AutoRound format ( vllm-project#18586 )\n\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\n\n* [V1][Spec Decode] Small refactors to improve eagle bookkeeping performance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Frontend] improve vllm serve --help display ( vllm-project#18643 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Model] Add support for Qwen2.5-Omni-7B-AWQ (Qwen2_5OmniForConditionalGeneration) ( vllm-project#18647 )\n\n* [V1][Spec Decode] Support multi-layer eagle draft model ( vllm-project#18030 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Doc] Update README links, mark external links ( vllm-project#18635 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC][pre-commit] Add pre-commit check for triton import ( vllm-project#17716 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Doc] Fix indentation problems in V0 Paged Attention docs ( vllm-project#18659 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Add community links ( vllm-project#18657 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] use AutoWeightsLoader for gpt2 ( vllm-project#18625 )\n\nSigned-off-by: zt2370 <ztang2370@gmail.com>\n\n* [Doc] Reorganize user guide ( vllm-project#18661 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] `chmod +x` to `cleanup_pr_body.sh` ( vllm-project#18650 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC] typo fix and clean import ( vllm-project#18664 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [BugFix] Fix import error for fused_moe ( vllm-project#18642 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [CI] enforce import regex instead of re ( vllm-project#18665 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* fix(regression): clone from reference items ( vllm-project#18662 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [CI/Build] fix permission denied issue ( vllm-project#18645 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [BugFix][Spec Decode] Improve Prefix Caching Logic in Speculative Decoding ( vllm-project#18668 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Fix _pickle.PicklingError: Can't pickle <class 'transformers_modules.deepseek-ai.DeepSeek-V2-Lite... ( vllm-project#18640 )\n\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\n\n* [MISC] correct signature for LoaderFunction ( vllm-project#18670 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc]Replace `cuda` hard code with `current_platform` in Ray ( vllm-project#14668 )\n\nSigned-off-by: noemotiovon <757486878@qq.com>\n\n* [Misc][ModelScope] Change to use runtime VLLM_USE_MODELSCOPE ( vllm-project#18655 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [VLM] Initialize video input support for InternVL models ( vllm-project#18499 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* Speed up the `kernels/quantization/` tests ( vllm-project#18669 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [BUGFIX] catch subclass first for try...except ( vllm-project#18672 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc] Reduce logs on startup ( vllm-project#18649 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] fix broken links ( vllm-project#18671 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [doc] improve readability ( vllm-project#18675 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix cpu usage and cache hit stats reporting on cpu environment ( vllm-project#18674 )\n\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [CI/build] fix no regex ( vllm-project#18676 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] small improve ( vllm-project#18680 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix profiling dummy data for Pixtral ( vllm-project#18677 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Core][Multimodal] Convert PIL Image to array without data copy when hashing ( vllm-project#18682 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [CI/Build][Doc] Update `gte-Qwen2-1.5B-instruct` usage ( vllm-project#18683 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Fixed the abnormally high TTFT issue in the PD disaggregation example ( vllm-project#18644 )\n\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\n\n* refactor: simplify request handler, use positive condition check for handler assignment ( vllm-project#18690 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Fix the lm_head in gpt_bigcode in lora mode ( vllm-project#6357 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\n\n* [CI] add missing argument ( vllm-project#18694 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [GH] Add issue template for reporting CI failures ( vllm-project#18696 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix issue template format ( vllm-project#18699 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Mistral-format models with sliding window ( vllm-project#18693 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Replace `math.isclose` with `pytest.approx` ( vllm-project#18703 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] fix dump_input for str type ( vllm-project#18697 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Model] Add support for YARN in NemotronNAS models ( vllm-project#18427 )\n\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\n\n* [CI/Build] Split pooling and generation extended language models tests in CI ( vllm-project#18705 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Add tensor parallel size = 2 test to HPU CI ( vllm-project#18709 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Misc] add AutoGen integration ( vllm-project#18712 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix]: handle hf-xet CAS error when loading Qwen3 weights in vLLM ( vllm-project#18701 )\n\n* [Doc] Improve API docs ( vllm-project#18713 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples and further reorganize user guide ( vllm-project#18666 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Llama GGUF initialization ( vllm-project#18717 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs ( vllm-project#18608 )\n\n* Convert `examples` to `ruff-format` ( vllm-project#18400 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Model][Gemma3] Simplify image input validation ( vllm-project#18710 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Misc] improve web section group title display ( vllm-project#18684 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [V1][Quantization] Add CUDA graph compatible v1 GGUF support ( vllm-project#18646 )\n\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Model][Gemma3] Cast image pixel values already on CPU ( vllm-project#18732 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [FEAT] [ROCm] Upgrade AITER Fused MoE kernels. ( vllm-project#18271 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Doc] Update OOT model docs ( vllm-project#18742 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Update reproducibility doc and example ( vllm-project#18741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] improve docs ( vllm-project#18734 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* feat(rocm-support): support mamba2 on rocm ( vllm-project#18565 )\n\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Fix multiple containers using the same name in run-hpu-test.sh ( vllm-project#18752 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Doc] cleanup deprecated flag for doc ( vllm-project#18715 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* Minor fix about MooncakeStoreConnector ( vllm-project#18721 )\n\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\n\n* [Build] fix cpu build missing libtbbmalloc.so ( vllm-project#18744 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [BUG FIX] minicpm ( vllm-project#18739 )\n\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\n\n* [Doc]  Convert Sphinx directives ( `{class}`, `{meth}`, `{attr}`, ...) to MkDocs format for better documentation linking ( vllm-project#18663 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [CI/Build] Remove imports of built-in `re` ( vllm-project#18750 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Metrics] Add API for accessing in-memory Prometheus metrics ( vllm-project#17010 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Disable prefix cache by default for benchmark ( vllm-project#18639 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* optimize get_kv_cache_torch_dtype ( vllm-project#18531 )\n\nSigned-off-by: idellzheng <idellzheng@tencent.com>\n\n* [Core] Automatically cast multi-modal input dtype ( vllm-project#18756 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Mistral tool calling when content is list ( vllm-project#18729 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n---------\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Nan2018 <nan@protopia.ai>\nSigned-off-by: rand-fly <randfly@outlook.com>\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Ê±™ÂøóÈπè <wangzhipeng628@gmail.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: calvin chen <120380290@qq.com>\nSigned-off-by: haochengxia <xhc_1007@163.com>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: Bill Nell <bnell@redhat.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\nSigned-off-by: nicklucche <nlucches@redhat.com>\nSigned-off-by: Kebe <mail@kebe7jun.com>\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\nSigned-off-by: rabi <ramishra@redhat.com>\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nSigned-off-by: giantcroc <1204449533@qq.com>\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nSigned-off-by: Sebastian Sch√∂nnenbeck <sebastian.schoennenbeck@comma-soft.com>\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: jaycha <jaycha@ncsoft.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Shane A <shanea@allenai.org>\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nSigned-off-by: Linkun <github@lkchen.net>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: googs1025 <googs1025@gmail.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: jiang.li <jiang1.li@intel.com>\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\nSigned-off-by: David Xia <david@davidxia.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nSigned-off-by: Kai Wu <kaiwu@meta.com>\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\nSigned-off-by: shen-shanshan <467638484@qq.com>\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\nSigned-off-by: cascade812 <cascade812@outlook.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Huy Do <huydhn@gmail.com>\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: zt2370 <ztang2370@gmail.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\nSigned-off-by: noemotiovon <757486878@qq.com>\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nSigned-off-by: idellzheng <idellzheng@tencent.com>\nCo-authored-by: sunyicode0012 <116338547+sunyicode0012@users.noreply.github.com>\nCo-authored-by: Gong Shufan <2624542821@qq.com>\nCo-authored-by: Satyajith Chilappagari <satchill@amazon.com>\nCo-authored-by: Lucia Fang <116399278+luccafong@users.noreply.github.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Nan Qin <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Random Fly <renfei8@live.cn>\nCo-authored-by: Reid <61492567+reidliu41@users.noreply.github.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Ê±™ÂøóÈπè <wangzhipeng628@gmail.com>\nCo-authored-by: wang.yuqi <noooop@126.com>\nCo-authored-by: ÁáÉ <wulipc@163.com>\nCo-authored-by: ÊùæÁÅµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Calvin Chen <45745657+calvin0327@users.noreply.github.com>\nCo-authored-by: Percy <xhc_1007@163.com>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: bnellnm <49004751+bnellnm@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: wwl2755 <wangwenlong2755@gmail.com>\nCo-authored-by: Nicol√≤ Lucchesi <nlucches@redhat.com>\nCo-authored-by: Kebe <mail@kebe7jun.com>\nCo-authored-by: Yong Hoon Shin <48474650+sarckk@users.noreply.github.com>\nCo-authored-by: Rabi Mishra <ramishra@redhat.com>\nCo-authored-by: Dhia Eddine Rhaiem <163106757+dhiaEddineRhaiem@users.noreply.github.com>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\nCo-authored-by: GiantCroc <1204449533@qq.com>\nCo-authored-by: Hyogeun Oh (Ïò§Ìö®Í∑º) <ohg3417@gmail.com>\nCo-authored-by: Hosang <156028780+hyoon1@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka Govediƒç <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Sebastian Schoennenbeck <sebastian.schoennenbeck@comma-soft.com>\nCo-authored-by: Ning Xie <andy.xning@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: youngrok cha <line0930@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\nCo-authored-by: Shane A <shanea@allenai.org>\nCo-authored-by: aws-elaineyz <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: CYJiang <86391540+googs1025@users.noreply.github.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Lukas Geiger <lukas.geiger94@gmail.com>\nCo-authored-by: David Xia <david@davidxia.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ekagra Ranjan <3116519+ekagra-ranjan@users.noreply.github.com>\nCo-authored-by: Kai Wu <kaiwu@meta.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Chenheli Hua <huachenheli@outlook.com>\nCo-authored-by: Benjamin Chislett <chislett.ben@gmail.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Teruaki Ishizaki <tell.ishi@gmail.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: RonaldBXu <72748153+RonaldBXu@users.noreply.github.com>\nCo-authored-by: cascade <cascade812@outlook.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Yuqi Zhang <zhangyuqi94@gmail.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Kay Yan <kay.yan@daocloud.io>\nCo-authored-by: Tristan Leclercq <49700633+tristanleclercq@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\nCo-authored-by: Huy Do <huydhn@gmail.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: Feng XiaoLong <79261065+Crucifixion-Fxl@users.noreply.github.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Mathieu Border√© <mathieu@bordere.org>\nCo-authored-by: Wenhua Cheng <wenhua.cheng@intel.com>\nCo-authored-by: qizixi <22851944+zixi-qi@users.noreply.github.com>\nCo-authored-by: Yuanhao WU <Nalkey@users.noreply.github.com>\nCo-authored-by: ztang2370 <ztang2370@gmail.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: Seiji Eicher <58963096+eicherseiji@users.noreply.github.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: AlexZhao <zhaohaidao2008@hotmail.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Naveassaf <55059536+Naveassaf@users.noreply.github.com>\nCo-authored-by: ≈Åukasz Durejko <lukasz.durejko@intel.com>\nCo-authored-by: dylan <xuhao296@qq.com>\nCo-authored-by: almersawi <43927639+almersawi@users.noreply.github.com>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: ≈Åukasz Durejko <ldurejko@habana.ai>\nCo-authored-by: maobaolong <baoloongmao@tencent.com>\nCo-authored-by: Shawn Huang <57223022+huangyuxiang03@users.noreply.github.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: chunxiaozheng <55471457+chunxiaozheng@users.noreply.github.com> minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [V1][Spec Decode] Small refactors to improve eagle bookkeeping perfor‚Ä¶ ‚Ä¶ e2fbc5c ‚Ä¶mance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-07 17:51:00",
  "has_lm_eval": false,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "PERF: TTFT, profiling | SERVING: vllm serve, serve, Frontend | TEST: test, test, Test",
  "analysis_extracted_at": "2025-09-07 17:51:00",
  "models": [
    "meta-llama/Llama-3-8B"
  ],
  "lm_eval_commands": [
    "lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3-8B --tasks gsm8k --num_fewshot 5"
  ],
  "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3-8B --batch-size 2",
  "commit_subject": "[V1][Spec Decode] Small refactors to improve eagle bookkeeping performance (#18424)",
  "commit_message": "[V1][Spec Decode] Small refactors to improve eagle bookkeeping performance (#18424)\n\nSigned-off-by: qizixi <qizixi@meta.com>",
  "commit_date": "2025-05-24T06:51:22Z",
  "files_changed": [
    "tests/v1/spec_decode/test_eagle.py",
    "vllm/v1/spec_decode/eagle.py",
    "vllm/v1/worker/gpu_model_runner.py"
  ],
  "functions_changed": [],
  "stats": {
    "num_test_files": 1,
    "num_non_test_files": 2,
    "only_test_files": 0,
    "only_non_test_files": 0,
    "num_files": 3,
    "num_hunks": 8,
    "num_edited_lines": 40,
    "num_non_test_edited_lines": 34,
    "commit_year": 2025
  },
  "diff_text": "diff --git a/tests/v1/spec_decode/test_eagle.py b/tests/v1/spec_decode/test_eagle.py\nindex e000d955c..7be1c5b89 100644\n--- a/tests/v1/spec_decode/test_eagle.py\n+++ b/tests/v1/spec_decode/test_eagle.py\n@@ -100,8 +100,12 @@ def test_prepare_inputs():\n         dtype=torch.int32,\n         device=device)\n \n+    # n1 + n2 + n3 - a - b -c\n+    num_tokens = cu_target_query_lens[-1].item() - num_rejected_tokens.sum(\n+    ).item()\n+\n     cu_num_tokens, token_indices = EagleProposer.prepare_inputs(\n-        cu_target_query_lens, num_rejected_tokens)\n+        cu_target_query_lens, num_rejected_tokens, num_tokens)\n \n     assert torch.equal(cu_num_tokens, expected_cu_num_tokens)\n     assert token_indices.shape[0] == expected_cu_num_tokens[-1].item()\ndiff --git a/vllm/v1/spec_decode/eagle.py b/vllm/v1/spec_decode/eagle.py\nindex 3926a86ee..876e1ddd1 100644\n--- a/vllm/v1/spec_decode/eagle.py\n+++ b/vllm/v1/spec_decode/eagle.py\n@@ -271,6 +271,7 @@ class EagleProposer:\n         cu_target_query_lens: torch.Tensor,\n         # [batch_size]\n         num_rejected_tokens: torch.Tensor,\n+        num_tokens: int,\n     ) -> tuple[torch.Tensor, torch.Tensor]:\n         # cu_target_query_lens: [0, a, a + b, a + b + c]\n         # num_rejected_tokens: [n1, n2, n3]\n@@ -288,18 +289,13 @@ class EagleProposer:\n \n         # [a - n1, b - n2, c - n3] ->\n         # [0, a - n1, a + b - n1 - n2, a + b + c - n1 - n2 - n3]\n-        cu_num_tokens = torch.empty_like(cu_target_query_lens)\n+        cu_num_tokens = torch.zeros_like(cu_target_query_lens)\n         torch.cumsum(num_tokens_per_req, dim=0, out=cu_num_tokens[1:])\n-        cu_num_tokens[0] = 0\n-\n-        # FIXME(woosuk): Avoid synchronization.\n-        num_tokens = cu_num_tokens[-1].item()\n         token_indices = torch.empty(\n             num_tokens,\n             dtype=torch.int32,\n-            device=cu_num_tokens.device,\n+            device=cu_target_query_lens.device,\n         )\n-\n         batch_size = num_rejected_tokens.shape[0]\n         BLOCK_SIZE = 1024\n         prepare_eagle_input_kernel[(batch_size, )](\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 42847e2f8..5120495db 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -34,8 +34,8 @@ from vllm.multimodal.utils import group_mm_inputs_by_modality\n from vllm.sampling_params import SamplingType\n from vllm.sequence import IntermediateTensors\n from vllm.utils import (STR_DTYPE_TO_TORCH_DTYPE, DeviceMemoryProfiler,\n-                        GiB_bytes, LazyLoader, cdiv, check_use_alibi,\n-                        is_pin_memory_available)\n+                        GiB_bytes, LazyLoader, async_tensor_h2d, cdiv,\n+                        check_use_alibi, is_pin_memory_available)\n from vllm.v1.attention.backends.flash_attn import FlashAttentionMetadata\n from vllm.v1.attention.backends.utils import CommonAttentionMetadata\n from vllm.v1.core.encoder_cache_manager import compute_encoder_budget\n@@ -281,7 +281,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n     def _may_reorder_batch(self, scheduler_output: \"SchedulerOutput\") -> bool:\n         \"\"\"\n         Update the order of requests in the batch based on the attention\n-        backend's needs. For example, some attention backends (namely MLA) may \n+        backend's needs. For example, some attention backends (namely MLA) may\n         want to separate requests based on if the attention computation will be\n         compute-bound or memory-bound.\n \n@@ -1360,9 +1360,10 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                                scheduler_output.num_scheduled_tokens[req_id])\n                     next_token_id = req_state.get_token_id(seq_len)\n                 next_token_ids.append(next_token_id)\n-            next_token_ids = torch.tensor(next_token_ids,\n-                                          dtype=torch.int32,\n-                                          device=self.device)\n+            next_token_ids = async_tensor_h2d(next_token_ids,\n+                                              dtype=torch.int32,\n+                                              target_device=self.device,\n+                                              pin_memory=True)\n             eagle_attn_metadata = attn_metadata[self.drafter.attn_layer_name]\n \n             # NOTE: deepseek_mtp uses MLA which does not have `block_table`\n@@ -1390,14 +1391,16 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                     n + 1 - len(valid_sampled_token_ids[i]) if n > 0 else 0\n                     for i, n in enumerate(num_draft_tokens)\n                 ]\n-                num_rejected_tokens = torch.tensor(\n+                num_rejected_tokens_tensor = async_tensor_h2d(\n                     num_rejected_tokens,\n                     dtype=torch.int32,\n-                    device=self.device,\n-                )\n+                    target_device=self.device,\n+                    pin_memory=True)\n+                num_tokens = num_scheduled_tokens - sum(num_rejected_tokens)\n                 cu_num_tokens, token_indices = self.drafter.prepare_inputs(\n                     eagle_attn_metadata.query_start_loc,\n-                    num_rejected_tokens,\n+                    num_rejected_tokens_tensor,\n+                    num_tokens,\n                 )\n                 target_token_ids = self.input_ids[token_indices]\n                 target_positions = positions[token_indices]\n@@ -1408,7 +1411,6 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                     target_hidden_states = hidden_states[token_indices]\n                 target_slot_mapping = eagle_attn_metadata.slot_mapping[\n                     token_indices]\n-\n             draft_token_ids = self.drafter.propose(\n                 target_token_ids=target_token_ids,\n                 target_positions=target_positions,",
  "apis": [
    "vllm.v1.spec_decode.eagle.EagleProposer.prepare_inputs",
    "vllm.worker.GPUModelRunner.execute_model"
  ],
  "affected_paths": [
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/eagle.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/configs/eagle.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py"
  ],
  "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm",
  "llm_reason": "The commit modifies non-test files (specifically, vllm/v1/spec_decode/eagle.py and vllm/v1/worker/gpu_model_runner.py) and adjusts the implementation details by replacing torch.empty with torch.zeros_like, removing unnecessary synchronization by passing in a computed num_tokens rather than recomputing it, and replacing blocking tensor creation with asynchronous tensor transfers using async_tensor_h2d. These changes are aimed at improving the internal bookkeeping performance of a core component (EagleProposer) and a performance-sensitive GPU model runner, rather than just refactoring or patching bugs. The modifications target the performance (on CPU) of existing APIs. Therefore, the commit satisfies the conditions for being a performance or optimization related change.",
  "llm_api_reason": "This commit refactors eagle speculative decoding bookkeeping. In tests, the prepare_inputs API of EagleProposer now requires an additional num_tokens parameter and internally uses torch.zeros_like instead of torch.empty_like for clarity. In GPUModelRunner, low‚Äêlevel tensor conversions in the eagle decoding branch are switched to use async_tensor_h2d (improving asynchronous memory transfers), and the computation of num_tokens has been adjusted accordingly. These changes collectively aim at improving bookkeeping and performance in eagle speculative decoding."
}