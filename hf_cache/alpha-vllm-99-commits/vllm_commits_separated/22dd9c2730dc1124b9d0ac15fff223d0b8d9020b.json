{
  "commit_hash": "22dd9c2730dc1124b9d0ac15fff223d0b8d9020b",
  "pr_url": "https://github.com/vllm-project/vllm/pull/20308",
  "pr_date": "2025-07-07",
  "timeline_text": "Copy link Contributor jvlunteren commented Jul 1, 2025 ‚Ä¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR introduces an optimization to the unified triton attention kernel ( #16828 and #19152 ) that enhances prefill attention performance. The key improvement involves reducing the number of tiles processed during the prefill phase by leveraging the causal mask to skip unnecessary computations. This results in more efficient execution, particularly for long prompts. Performance The following results were obtained for meta-llama/Llama-3.1-8B-Instruct on an NVIDIA H100 GPU, by running $ VLLM_ATTENTION_BACKEND=TRITON_ATTN_VLLM_V1 VLLM_USE_V1=1 python benchmarks/benchmark_latency.py \\\n    --model meta-llama/Llama-3.1-8B-Instruct \\\n    --input-len <input-length> --output-len 4 \\\n    --batch-size <batch-size> for the current triton unified attention kernel, and the updated triton unified attention kernel (this PR). Results for a batch size 1 are shown in the following graph. The input (prompt) length (in tokens) was varied in these experiments across the following values: 500, 1000, 1500, 2000, 4000, 8000, and 16000. The number of warmup iterations and measurement iterations were left at the default values of 10 and 30 respectively. As illustrated in the graph above, this PR improves the performance of the Triton Unified Attention Kernel by approximately 1.75 times for a batch size of 1 and an input length of 16000 tokens. Additional results were collected using benchmark_serving.py , which only includes sequence lengths under 2000 tokens: Current triton unified attention kernel: $ python benchmarks/benchmark_serving.py \\\n    --model meta-llama/Llama-3.1-8B-Instruct \\\n    --dataset-name sharegpt \\\n    --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json\n============ Serving Benchmark Result ============\nSuccessful requests:                     984\nBenchmark duration (s):                  22.18\nTotal input tokens:                      210771\nTotal generated tokens:                  195009\nRequest throughput (req/s):              44.37\nOutput token throughput (tok/s):         8793.44\nTotal Token throughput (tok/s):          18297.62\n---------------Time to First Token----------------\nMean TTFT (ms):                          3874.12\nMedian TTFT (ms):                        3715.54\nP99 TTFT (ms):                           7060.57\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          88.60\nMedian TPOT (ms):                        51.50\nP99 TPOT (ms):                           233.82\n---------------Inter-token Latency----------------\nMean ITL (ms):                           40.26\nMedian ITL (ms):                         25.51\nP99 ITL (ms):                            239.07\n================================================== Updated triton unified attention kernel (this PR): $ python benchmarks/benchmark_serving.py \\\n    --model meta-llama/Llama-3.1-8B-Instruct \\\n    --dataset-name sharegpt \\\n    --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json\n============ Serving Benchmark Result ============\nSuccessful requests:                     984\nBenchmark duration (s):                  21.44\nTotal input tokens:                      210460\nTotal generated tokens:                  195875\nRequest throughput (req/s):              45.90\nOutput token throughput (tok/s):         9137.19\nTotal Token throughput (tok/s):          18954.74\n---------------Time to First Token----------------\nMean TTFT (ms):                          3588.36\nMedian TTFT (ms):                        3478.75\nP99 TTFT (ms):                           6540.15\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          83.17\nMedian TPOT (ms):                        47.72\nP99 TPOT (ms):                           220.70\n---------------Inter-token Latency----------------\nMean ITL (ms):                           38.12\nMedian ITL (ms):                         25.28\nP99 ITL (ms):                            223.90 Despite the relatively short prompt lengths used in this benchmark, the results still demonstrate a ~3% improvement in throughput, along with over 5% reductions in latency metrics (TTFT, TPOT, and ITL). Correctness V1 FlashAttention : VLLM_USE_V1=1 lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct --tasks gsm8k --num_fewshot 5 --batch_size auto --limit 500\n\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|‚Üë  |0.794|¬±  |0.0181|\n|     |       |strict-match    |     5|exact_match|‚Üë  |0.772|¬±  |0.0188| Updated triton unified attention kernel (this PR): VLLM_USE_V1=1 VLLM_ATTENTION_BACKEND=TRITON_ATTN_VLLM_V1 lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct --tasks gsm8k --num_fewshot 5 --batch_size auto --limit 500\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|‚Üë  |0.800|¬±  |0.0179|\n|     |       |strict-match    |     5|exact_match|‚Üë  |0.784|¬±  |0.0184| How is this performance improvement achieved? The triton unified attention kernel employs a loop that iteratively processes multiple tiles, computing attention locally for each tile and accumulating the results across tiles to form the final output. During prefill processing, a causal mask is applied to each tile to ensure that attention is computed only over past and current tokens. In the current implementation, up to half of the tiles may be fully masked out during processing, resulting in redundant computation and reduced efficiency. This PR addresses the issue by skipping such tiles, ensuring that only those containing unmasked tokens are processed. cc @tdoublep Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions optimization of causal masking for prefill attention ‚Ä¶ 9641d0f Signed-off-by: Jan van Lunteren <jvl@zurich.ibm.com> gemini-code-assist bot reviewed Jul 1, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @jvlunteren , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request focuses on optimizing the prefill attention phase within the Triton Unified Attention Kernel. The core improvement involves intelligently skipping unnecessary computations for fully masked tiles, leading to enhanced efficiency, especially for processing long input sequences. This results in notable performance gains across various prompt lengths while maintaining model correctness. Highlights Performance Optimization : Implemented an optimization to the Triton Unified Attention Kernel specifically targeting the prefill attention phase. Causal Mask Leveraging : The optimization works by leveraging the causal mask to identify and skip processing of fully masked tiles, thereby reducing redundant computations during prefill. Significant Speedup for Long Prompts : Achieves significant performance improvements for very long prompts, demonstrating up to a 1.75x speedup for 16,000-token inputs on NVIDIA H100 GPUs. General Throughput and Latency Gains : Even for typical serving workloads with shorter prompts, the PR shows measurable gains, including approximately 3% improvement in request throughput and over 5% reductions in Time to First Token (TTFT), Time per Output Token (TPOT), and Inter-token Latency (ITL). Correctness Verified : Correctness benchmarks using lm_eval confirm that the optimization maintains or slightly improves model accuracy metrics, ensuring no regression in output quality. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with üëç and üëé on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . ‚Ü© Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jul 1, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This PR optimizes the unified triton attention kernel by reducing the number of tiles processed during the prefill phase, leading to significant performance improvements, especially for long prompts. The change is well-justified by the performance benchmarks. A suggestion has been made to improve the readability of the core calculation for better maintainability. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/attention/ops/triton_unified_attention.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . formatting ‚Ä¶ 70a6abe Signed-off-by: Jan van Lunteren <jvl@zurich.ibm.com> Copy link github-actions bot commented Jul 1, 2025 üëã Hi! Thank you for contributing to the vLLM project. üí¨ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. üöÄ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . SageMoore approved these changes Jul 1, 2025 View reviewed changes Copy link Contributor SageMoore left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good @jvlunteren . Thanks for the contribution! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 jvlunteren reacted with thumbs up emoji All reactions üëç 1 reaction tlrmchlsmth reviewed Jul 1, 2025 View reviewed changes vllm/attention/ops/triton_unified_attention.py Outdated Comment on lines 148 to 151 num_blocks = cdiv_fn( tl.minimum( context_len + q_block_local_idx * BLOCK_Q + (BLOCK_M - 1) // num_queries_per_kv + 1, seq_len), BLOCK_SIZE) Copy link Collaborator tlrmchlsmth Jul 1, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Worth adding a comment to explain the optimization? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 jvlunteren reacted with thumbs up emoji All reactions üëç 1 reaction Copy link Contributor Author jvlunteren Jul 2, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Done! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tlrmchlsmth approved these changes Jul 1, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Very nice find Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . üëç 1 jvlunteren reacted with thumbs up emoji All reactions üëç 1 reaction added comment ‚Ä¶ d26316e Signed-off-by: Jan van Lunteren <jvl@zurich.ibm.com> LucasWilkinson approved these changes Jul 7, 2025 View reviewed changes LucasWilkinson enabled auto-merge (squash) July 7, 2025 14:05 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 7, 2025 Hide details View details LucasWilkinson merged commit 22dd9c2 into vllm-project : main Jul 7, 2025 82 checks passed Uh oh! There was an error while loading. Please reload this page . huydhn pushed a commit\n        to huydhn/vllm\n      that referenced\n      this pull request Jul 8, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ 1572109 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> Chen-zexi pushed a commit\n        to Chen-zexi/vllm\n      that referenced\n      this pull request Jul 13, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ d1d442e vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> patrickvonplaten pushed a commit\n        to patrickvonplaten/vllm\n      that referenced\n      this pull request Jul 15, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ 182f805 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>\nSigned-off-by: Patrick von Platen <patrick.v.platen@gmail.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ 6dd288b vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ dc7e000 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> jvlunteren deleted the jvl-causal-mask-opt branch August 4, 2025 08:40 Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ 7d742bd vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ bcda609 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ 6d70cdb vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 27, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ 6f1d223 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( ‚Ä¶ 873623a vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-07 17:50:44",
  "has_lm_eval": true,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "LM_EVAL: lm_eval, lm_eval, lm_eval | PERF: TTFT, TTFT, TTFT | SERVING: Serving, Serving, serving | TEST: test, CI, CI",
  "analysis_extracted_at": "2025-09-07 17:50:44",
  "models": [
    "meta-llama/Llama-3.1-8B-Instruct"
  ],
  "lm_eval_commands": [
    "lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"
  ],
  "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0",
  "commit_subject": "[Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel (#20308)",
  "commit_message": "[Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel (#20308)\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>",
  "commit_date": "2025-07-07T19:08:12Z",
  "files_changed": [
    "vllm/attention/ops/triton_unified_attention.py"
  ],
  "functions_changed": [],
  "stats": {
    "num_test_files": 0,
    "num_non_test_files": 1,
    "only_test_files": 0,
    "only_non_test_files": 1,
    "num_files": 1,
    "num_hunks": 1,
    "num_edited_lines": 14,
    "num_non_test_edited_lines": 14,
    "commit_year": 2025
  },
  "diff_text": "diff --git a/vllm/attention/ops/triton_unified_attention.py b/vllm/attention/ops/triton_unified_attention.py\nindex c65f09523..f9645f651 100644\n--- a/vllm/attention/ops/triton_unified_attention.py\n+++ b/vllm/attention/ops/triton_unified_attention.py\n@@ -145,7 +145,19 @@ def kernel_unified_attention_2d(\n                               mask=query_mask_1,\n                               other=0.0)\n \n-    num_blocks = cdiv_fn(seq_len, BLOCK_SIZE)\n+    # compute the length of the longest sequence prefix spanned by any\n+    # query token in the current q_block (q_block_local_idx)\n+    max_seq_prefix_len = context_len + q_block_local_idx * BLOCK_Q + (\n+        BLOCK_M - 1) // num_queries_per_kv + 1\n+\n+    # adjust for potential padding in the last q_block by considering the\n+    # actual sequence length\n+    max_seq_prefix_len = tl.minimum(max_seq_prefix_len, seq_len)\n+\n+    # calculate the number of tiles (blocks) that need to be processed to\n+    # cover the longest sequence prefix (due to causal masking, blocks beyond\n+    # this prefix can be skipped)\n+    num_blocks = cdiv_fn(max_seq_prefix_len, BLOCK_SIZE)\n \n     # iterate through tiles\n     for j in range(0, num_blocks):",
  "apis": [
    "torch.ops.vllm.unified_attention",
    "vllm.attention.ops.triton_unified_attention_2d"
  ],
  "affected_paths": [
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/layer.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/layer.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/prefix_prefill.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py",
    "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"
  ],
  "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm",
  "llm_reason": "The commit modifies a non-test file (triton_unified_attention.py) with non-trivial changes that adjust how many attention blocks (tiles) are processed by computing the longest sequence prefix to potentially skip unnecessary work. Although the commit message mentions ‚Äúoptimize‚Äù and specifies prefill attention, the changes illustrate a careful adjustment of the loop boundaries rather than a mere refactor, bug fix, or documentation update. This is a performance optimization affecting the kernel‚Äôs computation, satisfying the conditions for general performance enhancement on CPU.",
  "llm_api_reason": "The commit updates the internal triton‚Äêbased kernel (kernel_unified_attention_2d) used for ‚Äúunified attention‚Äù in prefill mode. It now computes the number of tiles to process based on the longest sequence prefix spanned by the query block (adjusting for padding) so that blocks beyond the causal mask need not be processed. Although this change is in low‚Äêlevel kernel code, it affects the behavior of the unified attention custom op (exposed as a Python binding via torch.ops.vllm.unified_attention) that is used by the higher‚Äêlevel Attention layer in vLLM."
}