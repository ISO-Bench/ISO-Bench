{"commit_hash": "baeded25699f9f4851843306f27f685c4d4ee7c5", "pr_url": "https://github.com/vllm-project/vllm/pull/12601", "pr_date": "2025-02-01", "timeline_text": "Copy link Collaborator LucasWilkinson commented Jan 31, 2025 Based off of: #12528 that needs to land first Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 7 robertgshaw2-redhat, ywang96, gaocegege, mgoin, tlrmchlsmth, houseroad, and jovany-wang reacted with hooray emoji All reactions ðŸŽ‰ 7 reactions LucasWilkinson and others added 21 commits January 30, 2025 16:57 squashed commits â€¦ 27ad92c Co-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> fix VLLM_MLA_PERFORM_MATRIX_ABSORPTION=0 â€¦ c34e5ca Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> more cleanups â€¦ f2cac91 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> Update utils.py â€¦ 068e672 Co-authored-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> Update vllm/attention/backends/mla/utils.py â€¦ 31b802c Co-authored-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> review comments â€¦ 634eee6 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> renaming for consistency â€¦ 7487429 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> Update vllm/config.py â€¦ d27826d Co-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> review comments â€¦ 8bdc14a Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> review comments â€¦ 09d814c Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> Update vllm/attention/backends/mla/utils.py â€¦ 4a46014 Co-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> disable MLA for v3 for now â€¦ 0881475 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> fix failing test â€¦ 37e39f4 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> fix mypy â€¦ cfb2d26 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> fix mypy â€¦ 5afc1bf Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> add cuda graph support â€¦ 54ba87d Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> ci fix â€¦ 31c34bf Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> Revert \"add cuda graph support\" â€¦ 433322b Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> Fix TP > 1 cuda graphs â€¦ f2b2500 Co-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> cleanup â€¦ 2d61054 Co-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> cleanup â€¦ 645622c Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> LucasWilkinson requested review from tlrmchlsmth , WoosukKwon , mgoin , robertgshaw2-redhat , zhuohan123 , youkaichao , alexm-redhat , comaniac and njhill as code owners January 31, 2025 04:18 35 hidden items Load moreâ€¦ mgoin approved these changes Feb 1, 2025 View reviewed changes vllm/model_executor/model_loader/loader.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . simon-mo and others added 2 commits February 1, 2025 00:56 Update loader.py â€¦ 0d66687 Co-authored-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> format â€¦ 5fe1d1d Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> LucasWilkinson force-pushed the mla-fp8 branch\n    from 282eec1 to 5fe1d1d Compare February 1, 2025 00:57 LucasWilkinson added 2 commits February 1, 2025 01:13 reduce split kv amount â€¦ 5d5071c Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> fix none type error â€¦ 7ac6f52 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> mgoin mentioned this pull request Feb 1, 2025 Disable chunked prefill and/or prefix caching when MLA is enabled #12638 Closed ci fix â€¦ dc0e2af Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> LucasWilkinson mentioned this pull request Feb 1, 2025 [Attention] MLA with chunked prefill #12639 Merged 4 tasks Hide details View details simon-mo merged commit baeded2 into vllm-project : main Feb 1, 2025 42 of 44 checks passed Uh oh! There was an error while loading. Please reload this page . Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [Attention] Deepseek v3 MLA support with FP8 compute ( vllm-project#12601 â€¦ c22f65d )\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights\n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nSigned-off-by: Isotr0py <2037008807@qq.com> srikanthsrnvs pushed a commit\n        to srikanthsrnvs/vllm\n      that referenced\n      this pull request Feb 3, 2025 [Attention] Deepseek v3 MLA support with FP8 compute ( vllm-project#12601 â€¦ bb94260 )\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights\n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> Syst3m1cAn0maly mentioned this pull request Feb 3, 2025 [Bug]: MLA Warnings when using FP8 KV cache in v0.7.1 #12680 Closed 1 task sahelib25 pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Feb 3, 2025 [Attention] Deepseek v3 MLA support with FP8 compute ( vllm-project#12601 â€¦ 06f14ab )\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights\n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com> xuechendi referenced\n      this pull request\n        in yangw1234/habana-vllm-fork Feb 3, 2025 [Attention] Deepseek v3 MLA support with FP8 compute (#12601) â€¦ baf04c8 This PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights\n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com> houseroad mentioned this pull request Feb 4, 2025 DeepSeek: MLA attention pytorch/pytorch#146330 Open NickLucche pushed a commit\n        to NickLucche/vllm\n      that referenced\n      this pull request Feb 7, 2025 [Attention] Deepseek v3 MLA support with FP8 compute ( vllm-project#12601 â€¦ 6bb84bb )\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights \n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com> GWS0428 pushed a commit\n        to GWS0428/VARserve\n      that referenced\n      this pull request Feb 12, 2025 [Attention] Deepseek v3 MLA support with FP8 compute ( vllm-project#12601 â€¦ bd83b50 )\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights \n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com> gshtras reviewed Feb 14, 2025 View reviewed changes vllm/attention/backends/mla/utils.py def get_scale_group_shapes_for_fp8(layer: LinearBase) -> \\ Tuple[Tuple[int, int], Tuple[int, int]]: if isinstance(layer.quant_method, Fp8LinearMethod): if layer.quant_method.block_quant is not None: Copy link Collaborator gshtras Feb 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Fp8LinearMethod.block_quant is a boolean, is there meant to be a check for False instead? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member mgoin Feb 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yes this is a bug, I fixed it here #13181 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions LucasWilkinson mentioned this pull request Feb 25, 2025 Implement MLA for deepseek v3/r1 #12597 Closed yangulei pushed a commit\n        to yangulei/vllm-fork\n      that referenced\n      this pull request Mar 11, 2025 [Attention] Deepseek v3 MLA support with FP8 compute ( vllm-project#12601 â€¦ b339458 )\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights\n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Attention] Deepseek v3 MLA support with FP8 compute ( vllm-project#12601 â€¦ 28320d1 )\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights \n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:46:44", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, ci, ci", "analysis_extracted_at": "2025-09-07 17:46:44", "models": ["deepseek-ai/DeepSeek-V3"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-V3,dtype=float16 --tasks hellaswag --num_fewshot 0"], "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-V3 --dtype float16", "commit_subject": "[Attention] Deepseek v3 MLA support with FP8 compute (#12601)", "commit_message": "[Attention] Deepseek v3 MLA support with FP8 compute (#12601)\n\nThis PR implements the Deepseek V3 support by performing matrix absorption the fp8 weights \n\n---------\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>", "commit_date": "2025-01-31T21:52:51-08:00", "files_changed": ["vllm/attention/backends/mla/utils.py", "vllm/attention/backends/triton_mla.py", "vllm/attention/layer.py", "vllm/config.py", "vllm/envs.py", "vllm/model_executor/layers/quantization/utils/fp8_utils.py", "vllm/model_executor/layers/quantization/utils/quant_utils.py", "vllm/model_executor/model_loader/loader.py", "vllm/model_executor/models/deepseek_v3.py", "vllm/worker/cache_engine.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 10, "only_test_files": 0, "only_non_test_files": 1, "num_files": 10, "num_hunks": 37, "num_edited_lines": 665, "num_non_test_edited_lines": 665, "commit_year": 2025}, "diff_text": "diff --git a/vllm/attention/backends/mla/utils.py b/vllm/attention/backends/mla/utils.py\nindex c6c8a6034..e8fec234c 100644\n--- a/vllm/attention/backends/mla/utils.py\n+++ b/vllm/attention/backends/mla/utils.py\n@@ -1,17 +1,29 @@\n from abc import abstractmethod\n from dataclasses import dataclass\n-from typing import Any, Dict, Generic, List, Optional\n+from typing import Any, Dict, Generic, List, Optional, Tuple\n \n import torch\n+from compressed_tensors.quantization import QuantizationStrategy\n \n from vllm import _custom_ops as ops\n from vllm import envs\n from vllm.attention.backends.abstract import (AttentionLayer,\n                                               AttentionMetadata,\n                                               MLAAttentionImpl, T)\n-from vllm.distributed import get_tensor_model_parallel_world_size\n+from vllm.distributed import (get_tensor_model_parallel_world_size,\n+                              tensor_model_parallel_all_reduce)\n from vllm.model_executor.layers.linear import (ColumnParallelLinear,\n-                                               RowParallelLinear)\n+                                               LinearBase, RowParallelLinear,\n+                                               UnquantizedLinearMethod)\n+from vllm.model_executor.layers.quantization.compressed_tensors.compressed_tensors import (  # noqa: E501\n+    CompressedTensorsLinearMethod)\n+from vllm.model_executor.layers.quantization.compressed_tensors.schemes import (\n+    CompressedTensorsW8A8Fp8)\n+from vllm.model_executor.layers.quantization.fp8 import Fp8LinearMethod\n+from vllm.model_executor.layers.quantization.utils.fp8_utils import (\n+    apply_fp8_linear_generic, current_platform_fp8_dtype, is_fp8)\n+from vllm.model_executor.layers.quantization.utils.quant_utils import (\n+    scaled_dequantize, scaled_quantize)\n from vllm.model_executor.layers.rotary_embedding import RotaryEmbedding\n from vllm.vllm_flash_attn import flash_attn_varlen_func\n \n@@ -25,11 +37,11 @@ class MLACommonMetadata(AttentionMetadata):\n \n class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n     \"\"\"\n-    Common class for implementing repeated parts \n-    \n+    Common class for implementing repeated parts\n+\n     Main reference: DeepseekV2 paper, and FlashInfer Implementation\n     (https://arxiv.org/abs/2405.04434 and https://github.com/flashinfer-ai/flashinfer/pull/551).\n-    \n+\n     Deepseek's MLA attention works the following way:\n     * Use a single latent vector to represent the entire KV cache.\n     * The attention \"simulates\" a multi-head attention, while the compute is\n@@ -46,7 +58,7 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n         * V: V head dim.\n         * kv_c: latent/compressed KV\n         * q_c: latent/compressed Q\n-        \n+\n         #\n         # Outside the MLA attention backend\n         #\n@@ -55,21 +67,21 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n            kv_c_k_pe (B, Lkv+R).\n         2. The kv_c_k_pe is split into kv_c (B, Lkv) and k_pe (B, R). cq\n            and kv_c are normalized.\n-        \n+\n         #\n         # Inside the MLA attention backend\n         #\n \n         * if prefill:\n-        \n-        3. The q_c is then projected up into the multi-head version. \n-           * q_c goes from (B, Lq) to (B, N, (P+R)), which is split into q_nope \n-             (B, N, P) and q_pe (B, N, R). \n+\n+        3. The q_c is then projected up into the multi-head version.\n+           * q_c goes from (B, Lq) to (B, N, (P+R)), which is split into q_nope\n+             (B, N, P) and q_pe (B, N, R).\n         4. q_pe, k_pe are then passed through rotary embeddings.\n         5. kv_c and k_pe are concatenated and inserted into the cache\n-        6. The kv_c is then projected up into the multi-head version. \n-           * kv_c goes from (B, Lkv) to (B, N, (P+V)) which has the nope \n-             dimensions for K and V, which is split into k_nope (B, N, P) \n+        6. The kv_c is then projected up into the multi-head version.\n+           * kv_c goes from (B, Lkv) to (B, N, (P+V)) which has the nope\n+             dimensions for K and V, which is split into k_nope (B, N, P)\n              and v (B, N, V).\n         7. q (B, N, (P+R)) and k (B, N, (P+R)) matrices are assembled from\n            q_nope, q_pe, k_nope, k_pe.\n@@ -112,7 +124,7 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n     From @tsu-bin's calculation, we only want to use the absorption technique\n     for decode. The prefill algorithm should still use the up-projected MHA\n     for less flops and memory usage.\n-    \n+\n     \"\"\"\n \n     def __init__(\n@@ -162,8 +174,19 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n \n     def _v_up_proj_and_o_proj(self, x):\n         if envs.VLLM_MLA_PERFORM_MATRIX_ABSORPTION:\n-            return self.o_proj_absorbed(\n-                x.reshape(-1, self.num_heads * self.kv_lora_rank))[0]\n+            if is_fp8(self.W_UV_O):\n+                output_parallel = apply_fp8_linear_generic(\n+                    x.flatten(start_dim=1), self.W_UV_O, self.W_UV_O_scales,\n+                    self.reqaunt_input_group_shape,\n+                    self.reqaunt_weight_group_shape)\n+            else:\n+                output_parallel = torch.matmul(x.flatten(start_dim=1),\n+                                               self.W_UV_O)\n+            if self.tp_size > 1:\n+                output = tensor_model_parallel_all_reduce(output_parallel)\n+            else:\n+                output = output_parallel\n+            return output\n         else:\n             x = torch.einsum(\"bnl,lnv->bnv\", x, self.W_UV)\n             return self.o_proj(x.reshape(-1,\n@@ -171,6 +194,12 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n \n     def _q_proj_and_k_up_proj(self, x):\n         if envs.VLLM_MLA_PERFORM_MATRIX_ABSORPTION:\n+            if is_fp8(self.W_Q_UK):\n+                return apply_fp8_linear_generic(\n+                    x, self.W_Q_UK, self.W_Q_UK_scales,\n+                    self.reqaunt_input_group_shape,\n+                    self.reqaunt_weight_group_shape).view(\n+                        -1, self.num_heads, self.kv_lora_rank)\n             return torch.matmul(x, self.W_Q_UK)\\\n                 .view(-1, self.num_heads, self.kv_lora_rank)\n         else:\n@@ -179,8 +208,91 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n             return torch.einsum(\"bnp,lnp->bnl\", x, self.W_UK)\\\n                 .view(-1, self.num_heads, self.kv_lora_rank)\n \n-    def process_weights_after_loading(self):\n-        kv_b_proj_weight = self.kv_b_proj.weight.T\n+    def process_weights_after_loading(self, act_dtype: torch.dtype):\n+\n+        def is_layer_fp8(layer: LinearBase) -> bool:\n+            return isinstance(layer.quant_method, Fp8LinearMethod) or\\\n+                (isinstance(layer.quant_method, CompressedTensorsLinearMethod)\\\n+                and isinstance(layer.scheme, CompressedTensorsW8A8Fp8))\n+\n+        def quantization_scheme_supported(layer: LinearBase) -> bool:\n+            return isinstance(layer.quant_method, UnquantizedLinearMethod) or \\\n+                is_layer_fp8(layer)\n+\n+        # TODO(lucas) This is very gross, we need a more wide scale refactor of\n+        # all the FP8 code with a more standard way of\n+        # defining schemes/group-shapes, we should also potentially force\n+        # quant_methods to support a decompress function\n+        #\n+        # returns input_group_shape, weight_group_shape\n+        def get_scale_group_shapes_for_fp8(layer: LinearBase) -> \\\n+            Tuple[Tuple[int, int], Tuple[int, int]]:\n+            if isinstance(layer.quant_method, Fp8LinearMethod):\n+                if layer.quant_method.block_quant is not None:\n+                    weight_block_size = \\\n+                        layer.quant_method.quant_config.weight_block_size\n+                    # per-token-group (1, X), block-quantized (X, Y)\n+                    return (1, weight_block_size[-1]), weight_block_size\n+                else:\n+                    return (-1, -1), (-1, -1)  # per-tensor, per-tensor\n+            elif isinstance(layer.quant_method, CompressedTensorsLinearMethod)\\\n+                and isinstance(layer.scheme, CompressedTensorsW8A8Fp8):\n+                # this is hacky but we always assume the for\n+                # CompressedTensorsW8A8Fp8 the input is dynamic per-token\n+                # we ignore if it is static-per-tensor since we are going to\n+                # requantize after later anyways\n+                strategy = layer.scheme.strategy\n+                if strategy == QuantizationStrategy.TENSOR:\n+                    return (1, -1), (-1, -1)  # per-token, per-tensor\n+                elif strategy == QuantizationStrategy.CHANNEL:\n+                    return (1, -1), (-1, 1)  # per-token, per-channel\n+                else:\n+                    raise NotImplementedError(\n+                        f\"QuantizationStrategy.{strategy} is not supported for \"\n+                        \"fp8 MLA, please run with VLLM_MLA_DISABLE=1\")\n+            else:\n+                raise NotImplementedError(\n+                    \"Can't determine scale group shapes for \"\n+                    f\"{layer.quant_method}, please run with VLLM_MLA_DISABLE=1\"\n+                )\n+\n+        def get_scales(layer: LinearBase) -> torch.Tensor:\n+            if hasattr(layer, \"weight_scale_inv\"):\n+                return layer.weight_scale_inv\n+            return layer.weight_scale\n+\n+        def get_and_maybe_dequant_weights(layer: LinearBase):\n+            if is_layer_fp8(layer):\n+                if isinstance(layer.quant_method, \\\n+                    CompressedTensorsLinearMethod) and \\\n+                    isinstance(layer.scheme, CompressedTensorsW8A8Fp8):\n+                    # NOTE(lucas): note sure why but `CompressedTensorsW8A8Fp8`\n+                    # seems to store weights as (input, output) instead of\n+                    # (output, input) so we need to transpose\n+                    weight = layer.weight.T  # standardize to (output, input)\n+                else:\n+                    weight = layer.weight\n+                _, weight_scale_group_shape = \\\n+                    get_scale_group_shapes_for_fp8(layer)\n+                scales = get_scales(layer)\n+\n+                return scaled_dequantize(weight, scales,\n+                                         weight_scale_group_shape)\n+            else:\n+                return layer.weight\n+\n+        if not (quantization_scheme_supported(self.kv_b_proj) and\\\n+            quantization_scheme_supported(self.q_proj) and\\\n+                quantization_scheme_supported(self.o_proj)):\n+            raise NotImplementedError(\n+                \"Only FP8 and UnquantizedLinearMethod are supported for MLA\"\n+                \", please run with VLLM_MLA_DISABLE=1\")\n+\n+        weight_dtype = self.kv_b_proj.weight.dtype\n+        assert self.o_proj.weight.dtype == weight_dtype\n+        assert self.q_proj.weight.dtype == weight_dtype\n+\n+        kv_b_proj_weight = get_and_maybe_dequant_weights(self.kv_b_proj).T\n         assert kv_b_proj_weight.shape == (\n             self.kv_lora_rank,\n             self.num_heads * (self.qk_nope_head_dim + self.v_head_dim)), (\n@@ -198,18 +310,35 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n         W_UK, W_UV = kv_b_proj_weight.split(\n             [self.qk_nope_head_dim, self.v_head_dim], dim=-1)\n \n-        q_proj = self.q_proj.weight.T\\\n+        q_proj_weight = get_and_maybe_dequant_weights(self.q_proj).T\\\n                 .view(-1, self.num_heads, self.qk_head_dim)\n \n         # can be W_Q or W_UQ depending q_lora_rank, the former if\n         # q_lora_rank is None, the latter otherwise. From the Attention backend\n         # perspective though we call these both W_Q and rely on the layer\n         # to pass in the correct matrix\n-        W_Q = q_proj[..., :self.qk_nope_head_dim]\n-        self.W_QR = q_proj[..., self.qk_nope_head_dim:]\\\n+        W_Q = q_proj_weight[..., :self.qk_nope_head_dim]\n+        self.W_QR = q_proj_weight[..., self.qk_nope_head_dim:]\\\n             .flatten(start_dim=1).contiguous()\n \n+        # W_QR is small so for simplicity we dont bother requantizing it\n+        self.W_QR = self.W_QR.to(act_dtype)\n+\n         if envs.VLLM_MLA_PERFORM_MATRIX_ABSORPTION:\n+            requantization_enabled = not envs.VLLM_MLA_DISABLE_REQUANTIZATION\n+            if is_fp8(weight_dtype) and requantization_enabled:\n+                # This assumes it wise to requantize using the same group shapes\n+                # (i.e. strategy, per-tensor, per-channel, block etc.) that the\n+                # weights were originally quantized\n+                requant_input_group_shape, requant_weight_group_shape = \\\n+                    get_scale_group_shapes_for_fp8(self.q_proj)\n+                assert (requant_input_group_shape, requant_weight_group_shape)\\\n+                    == get_scale_group_shapes_for_fp8(self.kv_b_proj)\n+                assert (requant_input_group_shape, requant_weight_group_shape)\\\n+                    == get_scale_group_shapes_for_fp8(self.o_proj)\n+                self.reqaunt_input_group_shape = requant_input_group_shape\n+                self.reqaunt_weight_group_shape = requant_weight_group_shape\n+\n             #\n             # Perform matrix-absorption following\n             #     https://github.com/flashinfer-ai/flashinfer/pull/551\n@@ -223,25 +352,44 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n             # latter otherwise\n             # basically if q_lora_rank is none we are absorbing into q_proj\n             # instead of UQ\n-            self.W_Q_UK = torch.einsum(\"qnd,lnd -> qnl\", W_Q, W_UK)\\\n+            W_Q_UK = torch.einsum(\"qnd,lnd -> qnl\", W_Q, W_UK)\\\n                 .flatten(start_dim=1).contiguous()\n \n-            W_O = self.o_proj.weight\\\n+            if is_fp8(weight_dtype) and requantization_enabled:\n+                W_Q_UK, W_Q_UK_scales = scaled_quantize(\n+                    W_Q_UK,\n+                    self.reqaunt_weight_group_shape,\n+                    quant_dtype=current_platform_fp8_dtype)\n+                # For FP8 save the transpose so we can use\n+                # `apply_w8a8_block_fp8_linear` directly\n+                self.W_Q_UK = W_Q_UK.T.contiguous()\n+                self.W_Q_UK_scales = W_Q_UK_scales.T.contiguous()\n+            else:\n+                self.W_Q_UK = W_Q_UK.to(act_dtype)\n+\n+            W_O = get_and_maybe_dequant_weights(self.o_proj)\\\n                 .view(-1, self.num_heads, self.v_head_dim)\n-            self.W_UV_O = torch.einsum(\"lnd,hnd -> nlh\", W_UV, W_O)\\\n+            W_UV_O = torch.einsum(\"lnd,hnd -> nlh\", W_UV, W_O)\\\n                 .flatten(start_dim=0, end_dim=1).contiguous()\n \n-            tp_size = get_tensor_model_parallel_world_size()\n-            self.o_proj_absorbed = RowParallelLinear(\n-                self.W_UV_O.shape[0] * tp_size,\n-                self.W_UV_O.shape[1],\n-                bias=False,\n-                # TODO(lucas) figure out how to properly forward quant_method\n-                #quant_config=self.o_proj.quant_method,\n-            )\n-\n-            self.o_proj_absorbed.weight = torch.nn.Parameter(self.W_UV_O.T)\n+            if is_fp8(weight_dtype) and requantization_enabled:\n+                W_UV_O, W_UV_O_scales = scaled_quantize(\n+                    W_UV_O,\n+                    self.reqaunt_weight_group_shape,\n+                    quant_dtype=current_platform_fp8_dtype)\n+                # For FP8 save the transpose so we can use\n+                # `apply_w8a8_block_fp8_linear` directly\n+                self.W_UV_O = W_UV_O.T.contiguous()\n+                self.W_UV_O_scales = W_UV_O_scales.T.contiguous()\n+            else:\n+                self.W_UV_O = W_UV_O.to(act_dtype)\n+\n+            self.tp_size = get_tensor_model_parallel_world_size()\n         else:\n+            if is_fp8(weight_dtype):\n+                raise NotImplementedError(\n+                    \"Currently fp8 requires matrix absorption\")\n+\n             self.W_UV = W_UV\n             self.W_UK = W_UK\n             self.W_Q = W_Q.flatten(start_dim=1)\ndiff --git a/vllm/attention/backends/triton_mla.py b/vllm/attention/backends/triton_mla.py\nindex da09bb70b..95dc119a4 100644\n--- a/vllm/attention/backends/triton_mla.py\n+++ b/vllm/attention/backends/triton_mla.py\n@@ -57,14 +57,12 @@ class TritonMLABackend(AttentionBackend):\n \n     @staticmethod\n     def get_kv_cache_shape(\n-            num_blocks: int,\n-            block_size: int,\n-            num_kv_heads: int,  # assumed to be 1 for MLA\n-            kv_lora_rank: int,  # passed via head_size\n+        num_blocks: int,\n+        block_size: int,\n+        num_kv_heads: int,  # assumed to be 1 for MLA\n+        head_size: int,\n     ) -> Tuple[int, ...]:\n-        # TODO(lucas): remove hardcoding k_pe size as 1/8th of kv_lora_rank\n-        k_pe_size = kv_lora_rank // 8\n-        return (num_blocks, block_size, kv_lora_rank + k_pe_size)\n+        return (num_blocks, block_size, head_size)\n \n     @staticmethod\n     def swap_blocks(\n@@ -83,7 +81,7 @@ class TritonMLABackend(AttentionBackend):\n \n     @staticmethod\n     def get_supported_head_sizes() -> List[int]:\n-        return [512]\n+        return [576]\n \n \n class TritonMLAState(AttentionState):\n@@ -624,8 +622,6 @@ class TritonMLAMetadataBuilder(AttentionMetadataBuilder[TritonMLAMetadata]):\n             self.multimodal_placeholder_maps.items()\n         }\n \n-        num_kv_splits = 8\n-\n         return TritonMLAMetadata(\n             num_prefills=self.num_prefills,\n             slot_mapping=slot_mapping_tensor,\n@@ -645,7 +641,7 @@ class TritonMLAMetadataBuilder(AttentionMetadataBuilder[TritonMLAMetadata]):\n             context_lens_tensor=context_lens_tensor,\n             block_tables=block_tables,\n             use_cuda_graph=use_captured_graph,\n-            num_kv_splits=num_kv_splits,\n+            num_kv_splits=4,  # TODO(lucas) add heuristic\n             head_dim=self.runner.model_config.get_head_size(),\n         )\n \ndiff --git a/vllm/attention/layer.py b/vllm/attention/layer.py\nindex 9b804a29a..b97165f62 100644\n--- a/vllm/attention/layer.py\n+++ b/vllm/attention/layer.py\n@@ -200,9 +200,9 @@ class Attention(nn.Module):\n         s += f\", backend={self.impl.__class__.__name__}\"\n         return s\n \n-    def process_weights_after_loading(self):\n+    def process_weights_after_loading(self, act_dtype: torch.dtype):\n         if hasattr(self.impl, \"process_weights_after_loading\"):\n-            self.impl.process_weights_after_loading()\n+            self.impl.process_weights_after_loading(act_dtype)\n \n \n class MultiHeadAttention(nn.Module):\ndiff --git a/vllm/config.py b/vllm/config.py\nindex f6bd8b1ad..f998502ee 100644\n--- a/vllm/config.py\n+++ b/vllm/config.py\n@@ -739,18 +739,19 @@ class ModelConfig:\n     @property\n     def is_deepseek_mla(self) -> bool:\n         # TODO add deepseek_v3\n-        return hasattr(self.hf_text_config,\n-                       \"model_type\") and (self.hf_text_config.model_type\n-                                          in ('deepseek_v2'))\n+        return (hasattr(self.hf_text_config, \"model_type\")) \\\n+                and (self.hf_text_config.model_type in \\\n+                    ('deepseek_v2', 'deepseek_v3'))\\\n+                and (self.hf_text_config.kv_lora_rank is not None)\n \n     def get_head_size(self) -> int:\n         # TODO remove hard code\n         if self.is_deepseek_mla:\n+            qk_rope_head_dim = getattr(self.hf_text_config, \"qk_rope_head_dim\",\n+                                       0)\n             if self.use_mla:\n-                return self.hf_text_config.kv_lora_rank\n+                return self.hf_text_config.kv_lora_rank + qk_rope_head_dim\n             else:\n-                qk_rope_head_dim = getattr(self.hf_text_config,\n-                                           \"qk_rope_head_dim\", 0)\n                 qk_nope_head_dim = getattr(self.hf_text_config,\n                                            \"qk_nope_head_dim\", 0)\n                 if qk_rope_head_dim and qk_nope_head_dim:\n@@ -969,6 +970,32 @@ class ModelConfig:\n \n     @property\n     def use_mla(self) -> bool:\n+        if self.quantization is not None and self.quantization not in [\\\n+            \"fp8\", \"compressed-tensors\"]:\n+            logger.warning(\n+                \"MLA is not supported with %s quantization. \"\n+                \"Disabling MLA.\", self.quantization)\n+            return False\n+\n+        # If using a \"compressed-tensors\" checkpoint, check that all groups\n+        # have fp8 for both weights and activations.\n+        if self.quantization == \"compressed-tensors\":\n+            quant_config = self._parse_quant_hf_config()\n+            for group_name, cfg in quant_config.get(\"config_groups\",\n+                                                    (\"\", {})).items():\n+                act_cfg = cfg.get(\"input_activations\", {})\n+                act_type = None if act_cfg is None else act_cfg.get(\"type\", \"\")\n+                w_cfg = cfg.get(\"weights\", {})\n+                w_type = None if w_cfg is None else w_cfg.get(\"type\", \"\")\n+                if act_type != \"fp8\" or w_type != \"fp8\":\n+                    logger.warning(\n+                        \"compressed-tensors MLA support requires fp8 \"\n+                        \"activations and weights in group '%s', but got \"\n+                        \"activations type '%s' and weights type '%s'.\\n \"\n+                        \"Full config: %s\", group_name, act_type, w_type,\n+                        quant_config)\n+                    return False\n+\n         use_mla = (self.is_deepseek_mla and not envs.VLLM_MLA_DISABLE)\n         return use_mla\n \ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex 2a18e3b9b..25098070b 100644\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -79,6 +79,7 @@ if TYPE_CHECKING:\n     VLLM_V1_OUTPUT_PROC_CHUNK_SIZE: int = 128\n     VLLM_MLA_DISABLE: bool = False\n     VLLM_MLA_PERFORM_MATRIX_ABSORPTION: bool = True\n+    VLLM_MLA_DISABLE_REQUANTIZATION: bool = False\n \n \n def get_default_cache_root():\n@@ -519,7 +520,16 @@ environment_variables: Dict[str, Callable[[], Any]] = {\n     # storing more weights, W_Q_UK and W_UV_O, so can increase memory usage,\n     # the is enabled by default\n     \"VLLM_MLA_PERFORM_MATRIX_ABSORPTION\":\n-    lambda: bool(int(os.getenv(\"VLLM_MLA_PERFORM_MATRIX_ABSORPTION\", \"1\")))\n+    lambda: bool(int(os.getenv(\"VLLM_MLA_PERFORM_MATRIX_ABSORPTION\", \"1\"))),\n+\n+    # When running MLA with matrix-absorption enabled and fp8 quantized weights\n+    # we perform the matrix-absorption in float32 precision, after the matrices\n+    # are absorbed we requantize the weights back to fp8, this flag can be used\n+    # to disable the requantization step, and instead convert the absorbed\n+    # matrices to match the activation type. This can lead to higher memory and\n+    # compute usage but better preserves the accuracy of the original model.\n+    \"VLLM_MLA_DISABLE_REQUANTIZATION\":\n+    lambda: bool(int(os.getenv(\"VLLM_MLA_DISABLE_REQUANTIZATION\", \"0\")))\n }\n \n # end-env-vars-definition\ndiff --git a/vllm/model_executor/layers/quantization/utils/fp8_utils.py b/vllm/model_executor/layers/quantization/utils/fp8_utils.py\nindex ccebff341..850820f66 100644\n--- a/vllm/model_executor/layers/quantization/utils/fp8_utils.py\n+++ b/vllm/model_executor/layers/quantization/utils/fp8_utils.py\n@@ -2,7 +2,7 @@\n import functools\n import json\n import os\n-from typing import Any, Dict, List, Optional, Tuple\n+from typing import Any, Dict, List, Optional, Tuple, Union\n \n import torch\n import triton\n@@ -10,10 +10,24 @@ import triton.language as tl\n \n from vllm import _custom_ops as ops\n from vllm.logger import init_logger\n+from vllm.model_executor.layers.quantization.utils.quant_utils import (\n+    _normalize_quant_group_shape, scaled_dequantize)\n+from vllm.model_executor.layers.quantization.utils.w8a8_utils import (\n+    apply_fp8_linear)\n from vllm.platforms import current_platform\n \n logger = init_logger(__name__)\n \n+current_platform_fp8_dtype = (torch.float8_e4m3fnuz\n+                              if current_platform.is_rocm() else\n+                              torch.float8_e4m3fn)\n+\n+\n+def is_fp8(x: Union[torch.dtype, torch.Tensor]) -> bool:\n+    if isinstance(x, torch.Tensor):\n+        x = x.dtype\n+    return x == torch.float8_e4m3fn or x == torch.float8_e4m3fnuz\n+\n \n def apply_w8a8_block_fp8_linear(\n     input: torch.Tensor,\n@@ -55,6 +69,42 @@ def apply_w8a8_block_fp8_linear(\n     return output.to(dtype=input.dtype).view(*output_shape)\n \n \n+# Unify the interface between `apply_w8a8_block_fp8_linear` and\n+# `apply_fp8_linear`\n+# NOTE(lucas): this is quite messy, we should think through this more formally\n+def apply_fp8_linear_generic(\n+        input: torch.Tensor,\n+        weight: torch.Tensor,\n+        weight_scale: torch.Tensor,\n+        input_group_shape: Tuple[int, int],\n+        weight_group_shape: Tuple[int, int],\n+        input_scale: Optional[torch.Tensor] = None,  # static scale if one\n+) -> torch.Tensor:\n+    # View input as 2D matrix for fp8 methods\n+    input = input.view(-1, input.shape[-1])\n+\n+    weight_group_shape = _normalize_quant_group_shape(\\\n+        weight, weight_group_shape)\n+    input_group_shape = _normalize_quant_group_shape(input, input_group_shape)\n+\n+    def is_dim_blocked(dim, shape, group_shape):\n+        return group_shape < shape[dim] and group_shape > 1\n+\n+    if is_dim_blocked(0, weight.shape, weight_group_shape[0])\\\n+     and is_dim_blocked(1, weight.shape, weight_group_shape[1]) and\\\n+     input_group_shape == (1, weight_group_shape[1]):\n+        return apply_w8a8_block_fp8_linear(input, weight,\n+                                           list(weight_group_shape),\n+                                           weight_scale)\n+    else:\n+        # Despite having linear in the it doesn't conform to\n+        # `torch.nn.functional.linear` which is defined as `input @ weight.T`\n+        # so we explicitly transpose the weight matrix here\n+        return apply_fp8_linear(input, weight.T, weight_scale.T,\n+                         use_per_token_if_dynamic=\\\n+                             (input_group_shape == (1, input.shape[1])))\n+\n+\n def input_to_float8(\n         x: torch.Tensor,\n         dtype: Optional[torch.dtype] = None\n@@ -75,7 +125,6 @@ def input_to_float8(\n def block_quant_to_tensor_quant(\n     x_q_block: torch.Tensor,\n     x_s: torch.Tensor,\n-    block_size: List[int],\n ) -> Tuple[torch.Tensor, torch.Tensor]:\n     \"\"\"This function converts block-wise quantization to tensor-wise\n     quantization. The inputs are block-wise quantization tensor `x_q_block`,\n@@ -83,26 +132,7 @@ def block_quant_to_tensor_quant(\n     The outputs are tensor-wise quantization tensor and tensor-wise\n     quantization scale. Note only float8 is supported for now.\n     \"\"\"\n-    block_n, block_k = block_size[0], block_size[1]\n-    n, k = x_q_block.shape\n-    n_tiles = (n + block_n - 1) // block_n\n-    k_tiles = (k + block_k - 1) // block_k\n-    assert n_tiles == x_s.shape[0]\n-    assert k_tiles == x_s.shape[1]\n-\n-    x_dq_block = x_q_block.to(torch.float32)\n-\n-    x_dq_block_tiles = [[\n-        x_dq_block[\n-            j * block_n:min((j + 1) * block_n, n),\n-            i * block_k:min((i + 1) * block_k, k),\n-        ] for i in range(k_tiles)\n-    ] for j in range(n_tiles)]\n-\n-    for i in range(k_tiles):\n-        for j in range(n_tiles):\n-            x_dq_block_tiles[j][i][:, :] = x_dq_block_tiles[j][i] * x_s[j][i]\n-\n+    x_dq_block = scaled_dequantize(x_q_block, x_s)\n     x_q_tensor, scale = input_to_float8(x_dq_block, dtype=x_q_block.dtype)\n     return x_q_tensor, scale\n \ndiff --git a/vllm/model_executor/layers/quantization/utils/quant_utils.py b/vllm/model_executor/layers/quantization/utils/quant_utils.py\nindex 83055d600..95e785dcc 100644\n--- a/vllm/model_executor/layers/quantization/utils/quant_utils.py\n+++ b/vllm/model_executor/layers/quantization/utils/quant_utils.py\n@@ -1,5 +1,5 @@\n \"\"\"This file is used for /tests and /benchmarks\"\"\"\n-from typing import List, Optional\n+from typing import List, Optional, Tuple\n \n import numpy\n import torch\n@@ -20,6 +20,120 @@ FUSED_LAYER_NAME_MAPPING = {\n }\n \n \n+# Normalize the group_shape to the full extent for any dims that are -1\n+def _normalize_quant_group_shape(x: torch.Tensor, group_shape: Tuple[int,\n+                                                                     int]):\n+    # -1 means full extent\n+    return (group_shape[0] if group_shape[0] > 0 else x.shape[-2],\n+            group_shape[1] if group_shape[1] > 0 else x.shape[-1])\n+\n+\n+# Useful when treating N-dimensional group scaling as extended numpy-style\n+# broadcasting in numpy simply stretches dimensions with an extent of 1 to match\n+# the target shape by repeating the data along that dimension (broadcasting)\n+# , we extend these semantics to say if the extent of a dimension in the\n+# source shape is not 1 and does not match the target shape we repeat each\n+# element along that dimension src_shape[dim] // target_shape[dim] times\n+# example if we have:\n+#       a = [[1, 2], and target_shape = (2, 4)\n+#            [3, 4]]\n+# then we would expand a to:\n+#       a = [[1, 1, 2, 2],\n+#            [3, 3, 4, 4]]\n+# NOTE this function this function does not explicitly broadcast dimensions\n+# with an extent of 1, since this can be done implicitly by pytorch\n+def group_broadcast(t, shape):\n+    for i, s in enumerate(shape):\n+        if t.shape[i] != s and t.shape[i] != 1:\n+            assert s % t.shape[i] == 0\n+            t = t.unsqueeze(i + 1)\\\n+                .expand(*t.shape[:i+1], s // t.shape[i], *t.shape[i+1:])\\\n+                .flatten(i, i + 1)\n+    return t\n+\n+\n+# Quantize assuming once scale per group of elements with shape group_shape,\n+# example group shapes:\n+#  * (-1, -1)   for per-tensor quantization\n+#  * (1, -1)    for per-row quantization\n+#  * (-1, 1)    for per-column quantization\n+#  * (128, 128) for 128x128 deepseek style block quantization\n+#  * (1, 128)   for deepseek style activation quantization\n+#               (i.e. per-token-per-group)\n+def scaled_quantize(\n+    x: torch.Tensor,\n+    group_shape: Tuple[int, int],\n+    quant_dtype: torch.dtype,\n+) -> Tuple[torch.Tensor, torch.Tensor]:\n+    group_shape = _normalize_quant_group_shape(x, group_shape)\n+    assert quant_dtype.is_floating_point, \\\n+        \"currently `scaled_quantize` only supports floating point dtypes \" \\\n+        \"but could be extended to support other dtypes\"\n+\n+    finfo = torch.finfo(quant_dtype)\n+\n+    # Reshape (M, N) into (BLK_M, BLOCK_SIZE_M, BLK_N, BLOCK_SIZE_N)\n+    assert x.ndim == 2\n+    assert x.shape[0] % group_shape[0] == 0 and x.shape[1] % group_shape[1] == 0\n+    blk_m, blk_n = x.shape[0] // group_shape[0], x.shape[1] // group_shape[1]\n+    x_blkd = x.reshape(blk_m, group_shape[0], blk_n, group_shape[1])\n+\n+    # Permute to (BLK_M, BLK_N, BLOCK_SIZE_M, BLOCK_SIZE_N)\n+    x_blkd_permd = x_blkd.permute(0, 2, 1, 3)\n+    # Flatten to (BLK_M, BLK_N, BLOCK_SIZE_M * BLOCK_SIZE_N)\n+    x_blkd_permd = x_blkd_permd.flatten(start_dim=2)\n+\n+    # Compute scales\n+    min_val, max_val = x_blkd_permd.aminmax(dim=-1)\n+    amax = torch.maximum(min_val.abs(), max_val.abs()).clamp(min=1e-12)\n+    scale = finfo.max / amax\n+\n+    # Apply scale and convert form:\n+    # (BLK_M, BLK_N, BLOCK_SIZE_M * BLOCK_SIZE_N) to (M, N)\n+    x_scl_sat = (x_blkd_permd * scale.unsqueeze(-1))\\\n+        .clamp(min=finfo.min, max=finfo.max)\\\n+        .reshape(blk_m, blk_n, group_shape[0], group_shape[1])\\\n+        .permute(0, 2, 1, 3)\\\n+        .reshape(x.shape)\n+\n+    return x_scl_sat.to(quant_dtype).contiguous(), scale.float().reciprocal()\n+\n+\n+# inverses `scaled_quantize`\n+def scaled_dequantize(\n+    x_q: torch.Tensor,\n+    x_s: torch.Tensor,\n+    group_shape: Optional[Tuple[int, int]] = None,\n+    out_dtype: torch.dtype = torch.float32,\n+) -> Tuple[torch.Tensor, torch.Tensor]:\n+    if group_shape is not None:\n+        group_shape = _normalize_quant_group_shape(x_q, group_shape)\n+\n+    if x_s.ndim == 0:  # scalar\n+        x_s = x_s.unsqueeze(-1).unsqueeze(-1)  # convert to (1, 1) tensor\n+    if x_s.ndim == 1:\n+        if group_shape is None:\n+            raise AssertionError(\n+                \"if x_s is 1D tensor, group_shape must be provided otherwise \"\n+                \"its ambiguous which dimension to broadcast x_s to\")\n+        # unsqueeze the scales for the dimension where we want to broadcast\n+        # across the full extent\n+        if group_shape[0] == x_q.shape[-2]:\n+            x_s = x_s.unsqueeze(-2)\n+        elif group_shape[1] == x_q.shape[-1]:\n+            x_s = x_s.unsqueeze(-1)\n+        else:\n+            raise AssertionError(\n+                \"if x_s is a vector we should be broadcasting it to the full \"\n+                \"extent of one of the dimensions\")\n+\n+    if group_shape is not None:\n+        assert x_s.shape[-1] == x_q.shape[-1] // group_shape[1]\n+        assert x_s.shape[-2] == x_q.shape[-2] // group_shape[0]\n+    x_s = group_broadcast(x_s.to(torch.float32), x_q.shape)\n+    return (x_q.to(torch.float32) * x_s).to(out_dtype)\n+\n+\n def pack_quantized_values_into_int32(w_q: torch.Tensor,\n                                      wtype: ScalarType,\n                                      packed_dim: int = 0):\ndiff --git a/vllm/model_executor/model_loader/loader.py b/vllm/model_executor/model_loader/loader.py\nindex 62babcddd..4be511d12 100644\n--- a/vllm/model_executor/model_loader/loader.py\n+++ b/vllm/model_executor/model_loader/loader.py\n@@ -398,11 +398,13 @@ class DefaultModelLoader(BaseModelLoader):\n                     # parameters onto device for processing and back off after.\n                     with device_loading_context(module, target_device):\n                         quant_method.process_weights_after_loading(module)\n-                elif isinstance(module, Attention) and \\\n+                if isinstance(module, Attention) and \\\n                     hasattr(module, \"process_weights_after_loading\"):\n                     # When attention modules need to process weights after\n                     # currently only used by MLA\n-                    module.process_weights_after_loading()\n+                    # TODO(lucas): see if there is a way to unify the signatures\n+                    # of process_weights_after_loading\n+                    module.process_weights_after_loading(model_config.dtype)\n         return model.eval()\n \n \n@@ -439,6 +441,11 @@ class DummyModelLoader(BaseModelLoader):\n                     with device_loading_context(\n                             module, torch.device(device_config.device)):\n                         quant_method.process_weights_after_loading(module)\n+                if isinstance(module, Attention) and \\\n+                    hasattr(module, \"process_weights_after_loading\"):\n+                    # When attention modules need to process weights after\n+                    # currently only used by MLA\n+                    module.process_weights_after_loading(model_config.dtype)\n         return model.eval()\n \n \n@@ -633,6 +640,12 @@ class ShardedStateLoader(BaseModelLoader):\n                     quant_method = getattr(module, \"quant_method\", None)\n                     if quant_method is not None:\n                         quant_method.process_weights_after_loading(module)\n+                    if isinstance(module, Attention) and \\\n+                        hasattr(module, \"process_weights_after_loading\"):\n+                        # When attention modules need to process weights after\n+                        # currently only used by MLA\n+                        module.process_weights_after_loading(\n+                            model_config.dtype)\n             rank = get_tensor_model_parallel_rank()\n             pattern = os.path.join(\n                 local_model_path,\n@@ -1272,7 +1285,7 @@ class GGUFModelLoader(BaseModelLoader):\n \n class RunaiModelStreamerLoader(BaseModelLoader):\n     \"\"\"\n-        Model loader that can load safetensors \n+        Model loader that can load safetensors\n         files from local FS or S3 bucket.\n     \"\"\"\n \n@@ -1369,6 +1382,11 @@ class RunaiModelStreamerLoader(BaseModelLoader):\n                 if quant_method is not None:\n                     with device_loading_context(module, target_device):\n                         quant_method.process_weights_after_loading(module)\n+                if isinstance(module, Attention) and \\\n+                    hasattr(module, \"process_weights_after_loading\"):\n+                    # When attention modules need to process weights after\n+                    # currently only used by MLA\n+                    module.process_weights_after_loading(model_config.dtype)\n         return model.eval()\n \n \ndiff --git a/vllm/model_executor/models/deepseek_v3.py b/vllm/model_executor/models/deepseek_v3.py\nindex 0b44f0d06..f6ab53c85 100644\n--- a/vllm/model_executor/models/deepseek_v3.py\n+++ b/vllm/model_executor/models/deepseek_v3.py\n@@ -27,7 +27,7 @@ from torch import nn\n from transformers import PretrainedConfig\n \n from vllm.attention import Attention, AttentionMetadata\n-from vllm.config import CacheConfig, VllmConfig\n+from vllm.config import CacheConfig, ModelConfig, VllmConfig\n from vllm.distributed import (get_pp_group,\n                               get_tensor_model_parallel_world_size,\n                               tensor_model_parallel_all_reduce)\n@@ -333,12 +333,156 @@ class DeepseekV3Attention(nn.Module):\n         return output\n \n \n+class DeepseekV3MLAAttention(nn.Module):\n+    \"\"\"\n+    Main reference: DeepseekV2 paper, and FlashInfer Implementation\n+    (https://arxiv.org/abs/2405.04434 and https://github.com/flashinfer-ai/flashinfer/pull/551).\n+    \n+    For more info see MLACommonImpl in: vllm/attention/backends/mla/utils.py\n+    \"\"\"\n+\n+    def __init__(\n+        self,\n+        config: PretrainedConfig,\n+        hidden_size: int,\n+        num_heads: int,\n+        qk_nope_head_dim: int,\n+        qk_rope_head_dim: int,\n+        v_head_dim: int,\n+        q_lora_rank: Optional[int],\n+        kv_lora_rank: int,\n+        rope_theta: float = 10000,\n+        rope_scaling: Optional[Dict[str, Any]] = None,\n+        max_position_embeddings: int = 8192,\n+        cache_config: Optional[CacheConfig] = None,\n+        quant_config: Optional[QuantizationConfig] = None,\n+        prefix: str = \"\",\n+    ) -> None:\n+        super().__init__()\n+        self.hidden_size = hidden_size\n+        self.qk_nope_head_dim = qk_nope_head_dim\n+        self.qk_rope_head_dim = qk_rope_head_dim\n+        self.qk_head_dim = qk_nope_head_dim + qk_rope_head_dim\n+        self.v_head_dim = v_head_dim\n+\n+        self.q_lora_rank = q_lora_rank\n+        self.kv_lora_rank = kv_lora_rank\n+\n+        self.num_heads = num_heads\n+        tp_size = get_tensor_model_parallel_world_size()\n+        assert num_heads % tp_size == 0\n+        self.num_local_heads = num_heads // tp_size\n+\n+        self.scaling = self.qk_head_dim**-0.5\n+        self.rope_theta = rope_theta\n+        self.max_position_embeddings = max_position_embeddings\n+\n+        if self.q_lora_rank is not None:\n+            self.q_a_proj = ReplicatedLinear(self.hidden_size,\n+                                             self.q_lora_rank,\n+                                             bias=False,\n+                                             quant_config=quant_config,\n+                                             prefix=f\"{prefix}.q_a_proj\")\n+            self.q_a_layernorm = RMSNorm(self.q_lora_rank,\n+                                         eps=config.rms_norm_eps)\n+            self.q_b_proj = ColumnParallelLinear(q_lora_rank,\n+                                                 self.num_heads *\n+                                                 self.qk_head_dim,\n+                                                 bias=False,\n+                                                 quant_config=quant_config,\n+                                                 prefix=f\"{prefix}.q_b_proj\")\n+        else:\n+            self.q_proj = ColumnParallelLinear(self.hidden_size,\n+                                               self.num_heads *\n+                                               self.qk_head_dim,\n+                                               bias=False,\n+                                               quant_config=quant_config,\n+                                               prefix=f\"{prefix}.q_proj\")\n+\n+        self.kv_a_proj_with_mqa = ReplicatedLinear(\n+            self.hidden_size,\n+            self.kv_lora_rank + self.qk_rope_head_dim,\n+            bias=False,\n+            quant_config=quant_config,\n+            prefix=f\"{prefix}.kv_a_proj_with_mqa\")\n+        self.kv_a_layernorm = RMSNorm(self.kv_lora_rank,\n+                                      eps=config.rms_norm_eps)\n+        self.kv_b_proj = ColumnParallelLinear(\n+            self.kv_lora_rank,\n+            self.num_heads * (self.qk_nope_head_dim + self.v_head_dim),\n+            bias=False,\n+            quant_config=quant_config,\n+            prefix=f\"{prefix}.kv_b_proj\")\n+        self.o_proj = RowParallelLinear(self.num_heads * self.v_head_dim,\n+                                        self.hidden_size,\n+                                        bias=False,\n+                                        quant_config=quant_config,\n+                                        prefix=f\"{prefix}.o_proj\")\n+\n+        rope_scaling[\"rope_type\"] = 'deepseek_yarn'\n+        self.rotary_emb = get_rope(qk_rope_head_dim,\n+                                   rotary_dim=qk_rope_head_dim,\n+                                   max_position=max_position_embeddings,\n+                                   base=rope_theta,\n+                                   rope_scaling=rope_scaling,\n+                                   is_neox_style=False)\n+        if rope_scaling:\n+            mscale_all_dim = rope_scaling.get(\"mscale_all_dim\", False)\n+            scaling_factor = rope_scaling[\"factor\"]\n+            mscale = yarn_get_mscale(scaling_factor, float(mscale_all_dim))\n+            self.scaling = self.scaling * mscale * mscale\n+\n+        self.mla_attn = Attention(\n+            num_heads=self.num_local_heads,\n+            head_size=self.kv_lora_rank,\n+            scale=self.scaling,\n+            num_kv_heads=1,\n+            cache_config=cache_config,\n+            quant_config=quant_config,\n+            prefix=f\"{prefix}.attn\",\n+            use_mla=True,\n+            # MLA Args\n+            q_lora_rank=self.q_lora_rank,\n+            kv_lora_rank=self.kv_lora_rank,\n+            qk_nope_head_dim=self.qk_nope_head_dim,\n+            qk_rope_head_dim=self.qk_rope_head_dim,\n+            qk_head_dim=self.qk_head_dim,\n+            v_head_dim=self.v_head_dim,\n+            rotary_emb=self.rotary_emb,\n+            q_proj=self.q_proj if self.q_lora_rank is None else self.q_b_proj,\n+            kv_b_proj=self.kv_b_proj,\n+            o_proj=self.o_proj,\n+        )\n+\n+        self.prefix = prefix\n+        self.debug_layer_idx = int(self.prefix.split(\".\")[-2])\n+\n+    def forward(\n+        self,\n+        positions: torch.Tensor,\n+        hidden_states: torch.Tensor,\n+        kv_cache: torch.Tensor,\n+        attn_metadata: AttentionMetadata,\n+    ) -> torch.Tensor:\n+        if self.q_lora_rank is not None:\n+            ckq = self.q_a_proj(hidden_states)[0]\n+            hidden_states_or_q_c = self.q_a_layernorm(ckq)\n+        else:\n+            hidden_states_or_q_c = hidden_states\n+        kv_c, k_pe = self.kv_a_proj_with_mqa(hidden_states)[0].split(\n+            [self.kv_lora_rank, self.qk_rope_head_dim], dim=-1)\n+        kv_c_normed = self.kv_a_layernorm(kv_c.contiguous())\n+        return self.mla_attn(hidden_states_or_q_c, kv_c_normed, k_pe, kv_cache,\n+                             attn_metadata)\n+\n+\n class DeepseekV3DecoderLayer(nn.Module):\n \n     def __init__(\n         self,\n         config: PretrainedConfig,\n         prefix: str,\n+        model_config: ModelConfig,\n         cache_config: Optional[CacheConfig] = None,\n         quant_config: Optional[QuantizationConfig] = None,\n     ) -> None:\n@@ -351,7 +495,11 @@ class DeepseekV3DecoderLayer(nn.Module):\n         # DecoderLayers are created with `make_layers` which passes the prefix\n         # with the layer's index.\n         layer_idx = int(prefix.split(sep='.')[-1])\n-        self.self_attn = DeepseekV3Attention(\n+        if model_config.use_mla:\n+            attn_cls = DeepseekV3MLAAttention\n+        else:\n+            attn_cls = DeepseekV3Attention\n+        self.self_attn = attn_cls(\n             config=config,\n             hidden_size=self.hidden_size,\n             num_heads=config.num_attention_heads,\n@@ -428,6 +576,7 @@ class DeepseekV3Model(nn.Module):\n         super().__init__()\n \n         config = vllm_config.model_config.hf_config\n+        model_config = vllm_config.model_config\n         cache_config = vllm_config.cache_config\n         quant_config = vllm_config.quant_config\n \n@@ -447,6 +596,7 @@ class DeepseekV3Model(nn.Module):\n             lambda prefix: DeepseekV3DecoderLayer(\n                 config,\n                 prefix,\n+                model_config=model_config,\n                 cache_config=cache_config,\n                 quant_config=quant_config,\n             ),\ndiff --git a/vllm/worker/cache_engine.py b/vllm/worker/cache_engine.py\nindex 08316ba74..c427b759b 100644\n--- a/vllm/worker/cache_engine.py\n+++ b/vllm/worker/cache_engine.py\n@@ -110,7 +110,9 @@ class CacheEngine:\n             parallel_config, LayerBlockType.attention)\n \n         key_cache_block = cache_config.block_size * num_heads * head_size\n-        value_cache_block = key_cache_block\n+        # For MLA there is no value cache, since the latent vector\n+        # is joint keys and values.\n+        value_cache_block = key_cache_block if not model_config.use_mla else 0\n         total = num_attention_layers * (key_cache_block + value_cache_block)\n         if cache_config.cache_dtype == \"auto\":\n             dtype = model_config.dtype", "apis": ["vllm.attention.backends.MLACommonImpl.process_weights_after_loading", "vllm.attention.layer.Attention.process_weights_after_loading", "vllm.config.ModelConfig.get_head_size", "vllm.config.ModelConfig.is_deepseek_mla", "vllm.model_executor.models.deepseek_v3.DeepseekV3MLAAttention"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/adapter_commons/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/multimodal/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/profiler/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/online_serving/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/kernels/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/cutlass_benchmarks/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/structured_output/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/model_loader/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/benchmarks/lib/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/punica_wrapper/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/kv_transfer/kv_connector/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/tool_parsers/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/ops/triton_ops/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/quark/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/compressed_tensors/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/layer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/layer.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes non-trivial modifications to multiple core source files in the repository (e.g. attention/backends/mla/utils.py, triton_mla.py, model layer files, etc.), and it introduces changes to the matrix absorption process in the MLA (Multi-Head Attention) implementation. The modifications include handling of FP8 quantization, optimizing weight processing, and adjusting API configurations (e.g., changes in requantization, matrix absorption, and performance flags). These are performance-critical changes and optimizations in the model's attention mechanism, which are intended to improve computational efficiency (especially on CPU) while supporting FP8 compute. The commit does not merely fix bugs, refactor code, or add new features but instead updates internal APIs to enhance performance. Therefore, this commit satisfies the optimization and performance-related conditions.", "llm_api_reason": "This commit introduces Deepseek V3â€™s MLA (Multiâ€Head Latent Attention) support with FP8 compute by updating several parts of the MLA backend. In the MLA utils file, changes adjust quantization logic (including fp8â€specific matrix absorption and conditional reâ€‘quantization) in the common MLA implementation. The API of process_weights_after_loading has been updated to now accept an activation dtype argument, which is then called from the attention layerâ€™s process_weights_after_loading. Also, ModelConfigâ€™s is_deepseek_mla property and get_head_size method now take into account the Deepseek V3 MLA mode (and its additional head-dim contribution) while applying appropriate quantization checks. New DeepseekV3MLAAttention class is introduced in the deepseek_v3 model module so that when the model is configured for MLA it instantiates the appropriate attention module. These changes affect the core attentionâ€loading and weightâ€processing API calls for MLA, as well as model configuration behavior for Deepseek V3 models."}
{"commit_hash": "fc542144c4477ffec1d3de6fa43e54f8fb5351e8", "pr_url": "https://github.com/vllm-project/vllm/pull/12563", "pr_date": "2025-01-31", "timeline_text": "Copy link Contributor xpbowler commented Jan 29, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . [Guided decoding performance optimization] Sending the guided decoding bitmask in xgrammar to the GPU ( self.token_bitmask.to(scores.device) ) is a blocking operation that prevents the CPU from pre-launching the sampler kernels. The CPU waits until decode is complete, then copies the bitmask over. This PR changes the operation to async via setting non-blocking=True . (Current) The CPU is blocked on a cudaStreamSynchronize and only pre-empts the sampling kernels after bitmask application. Below is the Nsys profile for one decode phase from Llama 3.1 8B. With the optimization, this is no longer the case: Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions xpbowler requested a review\n  from mgoin as a code owner January 29, 2025 21:16 Copy link github-actions bot commented Jan 29, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . xpbowler force-pushed the main branch\n    from e91e01a to 99611c5 Compare January 29, 2025 21:26 mgoin approved these changes Jan 29, 2025 View reviewed changes Copy link Member mgoin left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This makes sense, thanks! LGTM pending green CI Showing the profile is great, also showing an e2e speedup (even if small) would be nice Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added structured-output ready ONLY add when PR is ready to merge/full CI is needed labels Jan 29, 2025 Copy link Contributor Author xpbowler commented Jan 29, 2025 This makes sense, thanks! LGTM pending green CI Showing the profile is great, also showing an e2e speedup (even if small) would be nice For single request benchmarks with Llama 3.1 8B running on H100, the improvement in tok/s was ~5%: Single request 87.5tok/s, guided unoptimized 92 tok/s, guided optimized ðŸš€ 2 mgoin and njhill reacted with rocket emoji All reactions ðŸš€ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin added\n  the performance Performance-related issues label Jan 29, 2025 aarnphm approved these changes Jan 29, 2025 View reviewed changes xpbowler force-pushed the main branch\n    from 9bae63f to b9681d4 Compare January 30, 2025 15:40 mgoin enabled auto-merge (squash) January 30, 2025 22:16 Ryan N added 3 commits January 31, 2025 20:26 remove blocking bitmask memcpy â€¦ 4a3d85f Signed-off-by: Ryan N <ryan.nguyen@centml.ai> re-run ci pipeline â€¦ a7914a8 Signed-off-by: Ryan N <ryan.nguyen@centml.ai> pipeline â€¦ f8fa0c6 Signed-off-by: Ryan N <ryan.nguyen@centml.ai> auto-merge was automatically disabled January 31, 2025 20:27 Head branch was pushed to by a user without write access xpbowler force-pushed the main branch\n    from b11a83f to f8fa0c6 Compare January 31, 2025 20:27 Hide details View details simon-mo merged commit fc54214 into vllm-project : main Jan 31, 2025 38 of 44 checks passed Uh oh! There was an error while loading. Please reload this page . Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [Feature] Fix guided decoding blocking bitmask memcpy ( vllm-project#1â€¦ â€¦ df7ab19 â€¦2563 )\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image]( https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824 )\n\nWith the optimization, this is no longer the case:\n\n![image]( https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7 )\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai>\nSigned-off-by: Isotr0py <2037008807@qq.com> srikanthsrnvs pushed a commit\n        to srikanthsrnvs/vllm\n      that referenced\n      this pull request Feb 3, 2025 [Feature] Fix guided decoding blocking bitmask memcpy ( vllm-project#1â€¦ â€¦ d27e55d â€¦2563 )\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image]( https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824 )\n\nWith the optimization, this is no longer the case:\n\n![image]( https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7 )\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> sahelib25 pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Feb 3, 2025 [Feature] Fix guided decoding blocking bitmask memcpy ( vllm-project#1â€¦ â€¦ 51f5127 â€¦2563 )\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image]( https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824 )\n\nWith the optimization, this is no longer the case:\n\n![image]( https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7 )\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai> NickLucche pushed a commit\n        to NickLucche/vllm\n      that referenced\n      this pull request Feb 7, 2025 [Feature] Fix guided decoding blocking bitmask memcpy ( vllm-project#1â€¦ â€¦ 5c21ca9 â€¦2563 )\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image]( https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824 )\n\nWith the optimization, this is no longer the case:\n\n![image]( https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7 )\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai> GWS0428 pushed a commit\n        to GWS0428/VARserve\n      that referenced\n      this pull request Feb 12, 2025 [Feature] Fix guided decoding blocking bitmask memcpy ( vllm-project#1â€¦ â€¦ bea306f â€¦2563 )\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image]( https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824 )\n\nWith the optimization, this is no longer the case:\n\n![image]( https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7 )\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Feature] Fix guided decoding blocking bitmask memcpy ( vllm-project#1â€¦ â€¦ 76bd88f â€¦2563 )\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image]( https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824 )\n\nWith the optimization, this is no longer the case:\n\n![image]( https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7 )\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:46:50", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: tok/s, tok/s, optimization | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:46:50", "models": ["meta-llama/Llama-3.1-8B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --num-prompts 1", "commit_subject": "[Feature] Fix guided decoding blocking bitmask memcpy (#12563)", "commit_message": "[Feature] Fix guided decoding blocking bitmask memcpy (#12563)\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image](https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824)\n\nWith the optimization, this is no longer the case:\n\n![image](https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7)\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai>", "commit_date": "2025-01-31T15:37:30-08:00", "files_changed": ["vllm/model_executor/guided_decoding/xgrammar_decoding.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 4, "num_non_test_edited_lines": 4, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/guided_decoding/xgrammar_decoding.py b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\nindex 2d8594cb8..ee30ce96f 100644\n--- a/vllm/model_executor/guided_decoding/xgrammar_decoding.py\n+++ b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\n@@ -307,8 +307,8 @@ class XGrammarLogitsProcessor:\n         # Note: In this method, if the tensors have different dimensions\n         # on CPU device fails, but on GPU it runs without error. Hence the\n         # unsqueeze above for scores, to match the token bitmask shape\n-        xgr.apply_token_bitmask_inplace(scores,\n-                                        self.token_bitmask.to(scores.device))\n+        xgr.apply_token_bitmask_inplace(\n+            scores, self.token_bitmask.to(scores.device, non_blocking=True))\n         if device_type != \"cuda\":\n             scores = scores.to(dtype).to(device_type).squeeze()", "apis": ["None"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file (xgrammar_decoding.py) in a non-trivial way by replacing a blocking GPU tensor transfer with a non-blocking one. The commit message discusses performance improvements by reducing CPU blocking during guided decoding, and includes profiling evidence to support this performance enhancement. This change directly impacts the performance of a high-level API without introducing new features or mere refactoring, and is testable on CPU (it addresses CPU blocking operations). Hence, it satisfies the conditions as a performance optimization commit.", "llm_api_reason": "This commit adjusts an internal call in the guidedâ€decoding code by adding the non_blocking flag when transferring the token bitmask tensor to the GPU. The change does not modify any public or top-level Python APIâ€”the change is entirely an internal performance optimization in the model executorâ€™s guided decoding logic."}
{"commit_hash": "fa63e710c7fbaae3a445f669d3b5ba6b9a4ef412", "pr_url": "https://github.com/vllm-project/vllm/pull/12094", "pr_date": "2025-01-15", "timeline_text": "Copy link Contributor youngkent commented Jan 15, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . We do some runner bookkeeping CPU operations after decoding iteration. We could parallelize some bookkeeping work while waiting on cuda sync. After the cuda sync, we only need to do simple and fast updates. The change should reduce scheduling overhead between decode iterations by ~20%. (See attached gpu trace) Before the optimization, After the optimization, E2E latency benchmark, ran VLLM_USE_V1=1 python3 benchmarks/benchmark_latency.py --model \"/data/users/ktong/llama/llm_8b_oss\" --tensor-parallel-size 1 --input_len 1000 --batch_size 32 Output (1-2% e2e latency reduction): Avg latency: 2.338167402730323 seconds 10% percentile latency: 2.3207896508742123 seconds 25% percentile latency: 2.3264574960339814 seconds 50% percentile latency: 2.3333765944698825 seconds 75% percentile latency: 2.343035737867467 seconds 90% percentile latency: 2.3567665563430635 seconds 99% percentile latency: 2.3934816433605737 seconds Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 3 WoosukKwon, ywang96, and njhill reacted with rocket emoji All reactions ðŸš€ 3 reactions youngkent requested review from WoosukKwon , njhill , ywang96 and comaniac as code owners January 15, 2025 19:16 Copy link github-actions bot commented Jan 15, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin requested a review\n  from robertgshaw2-redhat January 15, 2025 20:20 youngkent added 3 commits January 15, 2025 12:28 reduce scheduling overhead in model runner after cuda sync â€¦ ff21f9e Signed-off-by: Keyun Tong <tongkeyun@gmail.com> Fix style â€¦ 41dba06 Signed-off-by: Keyun Tong <tongkeyun@gmail.com> fix style typo â€¦ 9ce3d6e Signed-off-by: Keyun Tong <tongkeyun@gmail.com> youngkent force-pushed the main branch\n    from 4dc567b to 9ce3d6e Compare January 15, 2025 20:29 youkaichao reviewed Jan 16, 2025 View reviewed changes vllm/v1/outputs.py @@ -8,7 +8,7 @@ class SamplerOutput: # [num_reqs] sampled_token_ids: List[int] Copy link Member youkaichao Jan 16, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment is this necessary? iirc, @tlrmchlsmth use List[int] because they are cheaper to serialize, and would benefit tensor parallel case, where we need to pass them across processes. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator tlrmchlsmth Jan 16, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This is true  â€” I didnâ€™t look at how it impacts the non-TP case though Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator robertgshaw2-redhat Jan 25, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The ModelRunnerOutput is what we serialize for TP, we don't serialize the SamplerOutput directly, so this is not a concern Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator tlrmchlsmth Jan 25, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Ah, yep that's right -- I did change this line in #9856 , but that was just downstream of changing sampled_token_ids to a List in the ModelRunnerOutput . This looks good to me since that's left as-is! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator robertgshaw2-redhat commented Jan 16, 2025 Wow, great idea. Im going to run some perfomance analysis on this tomorrow. ðŸ‘ 1 youngkent reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon reviewed Jan 16, 2025 View reviewed changes vllm/v1/worker/gpu_model_runner.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . njhill reviewed Jan 16, 2025 View reviewed changes vllm/v1/sample/sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . njhill mentioned this pull request Jan 17, 2025 [V1] Logprobs and prompt logprobs support #9880 Merged remove outdated comment â€¦ 8ca382d Signed-off-by: Keyun Tong <tongkeyun@gmail.com> youngkent force-pushed the main branch\n    from dfd825e to 8ca382d Compare January 17, 2025 18:15 youkaichao reviewed Jan 18, 2025 View reviewed changes vllm/v1/outputs.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . youkaichao reviewed Jan 18, 2025 View reviewed changes vllm/v1/worker/gpu_model_runner.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Merge branch 'main' into youngkent/main 1cc6492 WoosukKwon requested a review\n  from alexm-redhat as a code owner January 25, 2025 22:08 WoosukKwon approved these changes Jan 25, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Thanks for discovering and fixing this! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/worker/gpu_model_runner.py self.input_batch.req_ids[:num_reqs]), \"req_ids contains None\" req_ids = cast(List[str], self.input_batch.req_ids[:num_reqs]) # NOTE: GPU -> CPU Sync happens here. Copy link Collaborator WoosukKwon Jan 25, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Just for a record: If top-p or top-k sampling is used (with the FlashInfer kernel), CPU-GPU synchronization happens inside the sampler at vllm/vllm/v1/sample/ops/topk_topp_sampler.py Lines 193 to 194\n      in 324960a # NOTE: CPU-GPU synchronization happens here. if not success . all (): Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 youngkent reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator robertgshaw2-redhat Jan 25, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do you think we can avoid this in a follow up PR? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator WoosukKwon Jan 26, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I don't think we can. This is a fundamental limitation of the kernel (or the algorithm itself). The rejection sampling method cannot 100% guarantee the success. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jan 25, 2025 tlrmchlsmth approved these changes Jan 25, 2025 View reviewed changes robertgshaw2-redhat reviewed Jan 25, 2025 View reviewed changes vllm/v1/worker/gpu_model_runner.py # NOTE: GPU -> CPU Sync happens here. # Move as many CPU operations as possible before this sync point. sampled_token_ids = sampler_output.sampled_token_ids.tolist() Copy link Collaborator robertgshaw2-redhat Jan 25, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It might be faster to do sampler_output.sampled_token_ids.cpu() and then sampler_output.sampled_token_ids[i].item()` in the inner loop. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator WoosukKwon Jan 26, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment In my experience, item() took considerable time so should be avoided. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 robertgshaw2-redhat reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction mgoin approved these changes Jan 25, 2025 View reviewed changes Merge remote-tracking branch 'upstream/main' f35e80b Hide details View details WoosukKwon merged commit fa63e71 into vllm-project : main Jan 26, 2025 42 of 44 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator WoosukKwon commented Jan 26, 2025 @youngkent Thanks for the PR! This change helps vLLM's performance noticeably. â¤ï¸ 1 youngkent reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tjtanaa pushed a commit\n        to EmbeddedLLM/vllm\n      that referenced\n      this pull request Jan 28, 2025 [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( â€¦ â€¦ 4388fac â€¦vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com> rasmith pushed a commit\n        to rasmith/vllm\n      that referenced\n      this pull request Jan 30, 2025 [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( â€¦ â€¦ 4a21854 â€¦vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com> Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( â€¦ â€¦ 0442131 â€¦vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 3, 2025 [MFM-2025-02-03] Merge Main to llama fp8; With Faster ROCm Paged Atteâ€¦ â€¦ 479b843 â€¦ntion ( #399 )\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 5, 2025 [Bug Fix] Missing vllm.envs ( #405 ) â€¦ 87b3c56 * [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] included missing environment variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> NickLucche pushed a commit\n        to NickLucche/vllm\n      that referenced\n      this pull request Feb 7, 2025 [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( â€¦ â€¦ 42bfed0 â€¦vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com> GWS0428 pushed a commit\n        to GWS0428/VARserve\n      that referenced\n      this pull request Feb 12, 2025 [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( â€¦ â€¦ 75d4b32 â€¦vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 19, 2025 [FEAT] [AITER] Support AITER operators: Fused MoE, Linear, Norm ( #436 ) â€¦ 4c8c86d * [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* Integrated ater: kvcache pa gemm rmsnorm\n\n* fix pa\n\n* fix\n\n* replace topk softmax\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* replace fp moe kernel with aiter kernel\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* change ater to aiter\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config\n\n* Applying scales rename to fp8 config ( #387 )\n\n* Update Dockerfile.rocm\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Using aiter moe kernel\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* fix pa copy\n\n* pa update\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* add fp16 pa support for aiter\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* aiter build instructions\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Copy to the right path\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Add env var toggles to disable AITER MoE or PA (both by default on)\n\n* Update accuracy benchmark for batch size > 1\n\n* Add a few more AITER toggles for norm and linear layers\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Public aiter repo\n\n* Fail if aiter build failed silently\n\n* Aiter can only be built on MI300x\n\n* Typo fix\n\n* Aiter PA off by default\n\n* Changes to support updated aiter FP8 PA\n\n* Support FP8 and INT8 KV cache according to ROCm/aiter#90 * add moe weight shuffle for dynamic quant and unquantized path\n\nSigned-off-by: charlifu <charlifu@amd.com>\n\n* Use FP16-native PA after support in ROCm/aiter#97 * Fix: Use FP8 pertoken quantize if KV cache dtype is FP8\n\n* revert rocm_flash_attn.py line 883\n\n* Don't enable by default to use an RC for main vllm-dev docker\n\n* use ck moe for bf16 and fp16 fused_moe\n\n* Merge remote-tracking branch 'origin/aiter_intergration_final' into merge-aiter-llama-fp8\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] include moe shuffle env variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: charlifu <charlifu@amd.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: amd-ruitang3 <Rui.Tang2@amd.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: chenjun <junchen2@amd.com>\nCo-authored-by: ValarLip <340077269@qq.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Matthew Wong <Matthew.Wong2@amd.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: charlifu <chalifu@amd.com> mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( â€¦ â€¦ bdf42bf â€¦vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:46:54", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: Throughput, Throughput, Throughput | SERVING: serving, serving, serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:46:54", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "VLLM_USE_V1=1 python3 benchmarks/benchmark_latency.py --model \"/data/users/ktong/llama/llm_8b_oss\" --tensor-parallel-size 1 --input_len 1000 --batch_size 32", "commit_subject": "[V1][Perf] Reduce scheduling overhead in model runner after cuda sync (#12094)", "commit_message": "[V1][Perf] Reduce scheduling overhead in model runner after cuda sync (#12094)\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>", "commit_date": "2025-01-26T00:42:37-08:00", "files_changed": ["vllm/v1/outputs.py", "vllm/v1/sample/sampler.py", "vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 1, "num_files": 3, "num_hunks": 6, "num_edited_lines": 34, "num_non_test_edited_lines": 34, "commit_year": 2025}, "diff_text": "diff --git a/vllm/v1/outputs.py b/vllm/v1/outputs.py\nindex acc3a944e..32aee44e3 100644\n--- a/vllm/v1/outputs.py\n+++ b/vllm/v1/outputs.py\n@@ -8,7 +8,7 @@ import torch\n class SamplerOutput:\n \n     # [num_reqs]\n-    sampled_token_ids: List[int]\n+    sampled_token_ids: torch.Tensor\n \n     # [num_reqs, max_num_logprobs + 1]\n     logprob_token_ids: Optional[torch.Tensor]\ndiff --git a/vllm/v1/sample/sampler.py b/vllm/v1/sample/sampler.py\nindex 7cd42ca21..9ad665a64 100644\n--- a/vllm/v1/sample/sampler.py\n+++ b/vllm/v1/sample/sampler.py\n@@ -50,9 +50,8 @@ class Sampler(nn.Module):\n         # Use int32 to reduce the tensor size.\n         sampled = sampled.to(torch.int32)\n \n-        # NOTE: CPU-GPU synchronization happens here.\n         sampler_output = SamplerOutput(\n-            sampled_token_ids=sampled.tolist(),\n+            sampled_token_ids=sampled,\n             logprob_token_ids=topk_indices,\n             logprobs=topk_logprobs,\n             prompt_logprob_token_ids=None,\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 4b3c325de..6339f1f03 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -775,10 +775,10 @@ class GPUModelRunner:\n             sampling_metadata=sampling_metadata,\n         )\n \n-        sampled_token_ids = sampler_output.sampled_token_ids\n         # TODO(woosuk): The following loop can be slow since it iterates over\n         # the requests one by one. Optimize.\n         num_reqs = self.input_batch.num_reqs\n+        request_seq_lens: List[Tuple[int, CachedRequestState, int]] = []\n         for i, req_id in enumerate(self.input_batch.req_ids[:num_reqs]):\n             assert req_id is not None\n             req_state = self.requests[req_id]\n@@ -787,10 +787,10 @@ class GPUModelRunner:\n             assert seq_len <= req_state.num_tokens\n             if seq_len == req_state.num_tokens:\n                 # Append the sampled token to the output token ids.\n-                token_id = sampled_token_ids[i]\n-                self.input_batch.token_ids_cpu[i, seq_len] = token_id\n                 self.input_batch.num_tokens[i] += 1\n-                req_state.output_token_ids.append(token_id)\n+                # OPTIMIZATION: Priming the state updates for later updates.\n+                req_state.output_token_ids.append(0)\n+                request_seq_lens.append((i, req_state, seq_len))\n             else:\n                 # Ignore the sampled token from the partial request.\n                 # Rewind the generator state as if the token was not sampled.\n@@ -799,6 +799,21 @@ class GPUModelRunner:\n                     # This relies on cuda-specific torch-internal impl details\n                     generator.set_offset(generator.get_offset() - 4)\n \n+        # num_reqs entries should be non-None\n+        assert all(\n+            req_id is not None for req_id in\n+            self.input_batch.req_ids[:num_reqs]), \"req_ids contains None\"\n+        req_ids = cast(List[str], self.input_batch.req_ids[:num_reqs])\n+\n+        # NOTE: GPU -> CPU Sync happens here.\n+        # Move as many CPU operations as possible before this sync point.\n+        sampled_token_ids = sampler_output.sampled_token_ids.tolist()\n+        # Update with the actual token ids\n+        for i, req_state, seq_len in request_seq_lens:\n+            token_id = sampled_token_ids[i]\n+            self.input_batch.token_ids_cpu[i, seq_len] = token_id\n+            req_state.output_token_ids[-1] = token_id\n+\n         if sampler_output.logprob_token_ids is None:\n             logprob_token_ids = None\n         else:\n@@ -808,12 +823,6 @@ class GPUModelRunner:\n         else:\n             logprobs = sampler_output.logprobs.cpu()\n \n-        # num_reqs entries should be non-None\n-        assert all(\n-            req_id is not None for req_id in\n-            self.input_batch.req_ids[:num_reqs]), \"req_ids contains None\"\n-        req_ids = cast(List[str], self.input_batch.req_ids[:num_reqs])\n-\n         model_runner_output = ModelRunnerOutput(\n             req_ids=req_ids,\n             req_id_to_index=self.input_batch.req_id_to_index,", "apis": ["vllm.v1.outputs.SamplerOutput", "vllm.v1.sample.sampler.Sampler.forward", "vllm.v1.worker.GPUModelRunner.execute_model"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/outputs.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/outputs.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies several non-test source files (outputs.py, sampler.py, gpu_model_runner.py) and makes non-trivial changes to how data is handled. Specifically, it postpones the conversion of the sampled tokens to Python list until after some CPU operations, and it batches certain state updates to reduce the GPU-to-CPU synchronization overhead. These changes aim at reducing scheduling overhead and optimizing the CPU performance of the model runnerâ€”exactly a performance optimization rather than mere refactoring, bugfixing, or feature addition. Overall, the changes target performance improvements in a high-level API and are testable on CPU without relying on GPU-specific optimizations.", "llm_api_reason": "The commit changes the handling of sampled token IDs to avoid unnecessary CPUâ€“GPU transfers. In outputs.py the SamplerOutputâ€™s sampled_token_ids field is changed from a list of ints to a torch.Tensor. In sampler.py the Sampler.forward method now returns the sampled tokens directly as a tensor (instead of converting them to a list), and in GPUModelRunner.execute_model the logic is updated so that the token IDs are deferred until after a GPUâ€“CPU sync and then patched into the persistent input batch. These changes reduce scheduling overhead and improve performance while maintaining the same external behavior."}
{"commit_hash": "6dd94dbe94c1820a1e224cba65efcf0befa97995", "pr_url": "https://github.com/vllm-project/vllm/pull/12380", "pr_date": "2025-01-24", "timeline_text": "Copy link Member youkaichao commented Jan 24, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . When I made the PR #12253 , I though self.decode_only = True is whether this model is decoder-only model, and therefore it is static. However, it turns out this field means if the current batch is decode only batch (so that we can use cudagraph). The bug makes every batch use previous batch's self.decode_only value, which is set to False when the batch contains prefill. Moving this line into prepare function (which is executed for every batch) solves the perf regression. test command: python benchmarks/benchmark_latency.py --model meta-llama/Meta-Llama-3-8B --load-format dummy main branch: Avg latency: 1.1250504679279403 seconds\n10% percentile latency: 1.1177026848774403 seconds\n25% percentile latency: 1.1233553139027208 seconds\n50% percentile latency: 1.1258818825008348 seconds\n75% percentile latency: 1.127114001486916 seconds\n90% percentile latency: 1.1292839918518438 seconds\n99% percentile latency: 1.1434868656494654 seconds after this PR: Avg latency: 1.0009459006755301 seconds\n10% percentile latency: 1.0002478279871867 seconds\n25% percentile latency: 1.0005546582397074 seconds\n50% percentile latency: 1.001000543939881 seconds\n75% percentile latency: 1.0012907102354802 seconds\n90% percentile latency: 1.00162893619854 seconds\n99% percentile latency: 1.0022530709696003 seconds Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions fix perf â€¦ b900f08 Signed-off-by: youkaichao <youkaichao@gmail.com> Copy link github-actions bot commented Jan 24, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . add comments â€¦ 9ace57c Signed-off-by: youkaichao <youkaichao@gmail.com> comaniac approved these changes Jan 24, 2025 View reviewed changes comaniac added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jan 24, 2025 Copy link Collaborator yeqcharlotte commented Jan 24, 2025 @youkaichao Thanks for putting up the fix quickly! Confirmed the e2e throughput and latency is back to normal after this PR. ðŸ‘ 2 youkaichao and houseroad reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details youkaichao merged commit 6dd94db into vllm-project : main Jan 24, 2025 12 of 18 checks passed Uh oh! There was an error while loading. Please reload this page . youkaichao deleted the fix_perf branch January 24, 2025 03:34 This was referenced Jan 24, 2025 Revert \"[core] separate builder init and builder prepare for each batch\" #12377 Closed Release v0.7.0 #12365 Closed tjtanaa pushed a commit\n        to EmbeddedLLM/vllm\n      that referenced\n      this pull request Jan 28, 2025 [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 ) â€¦ 404466b Signed-off-by: youkaichao <youkaichao@gmail.com> rasmith pushed a commit\n        to rasmith/vllm\n      that referenced\n      this pull request Jan 30, 2025 [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 ) â€¦ 924ae96 Signed-off-by: youkaichao <youkaichao@gmail.com> Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 ) â€¦ 1af1584 Signed-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 3, 2025 [MFM-2025-02-03] Merge Main to llama fp8; With Faster ROCm Paged Atteâ€¦ â€¦ 479b843 â€¦ntion ( #399 )\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 5, 2025 [Bug Fix] Missing vllm.envs ( #405 ) â€¦ 87b3c56 * [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] included missing environment variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> NickLucche pushed a commit\n        to NickLucche/vllm\n      that referenced\n      this pull request Feb 7, 2025 [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 ) â€¦ da3ba9f Signed-off-by: youkaichao <youkaichao@gmail.com> GWS0428 pushed a commit\n        to GWS0428/VARserve\n      that referenced\n      this pull request Feb 12, 2025 [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 ) â€¦ 75c53e3 Signed-off-by: youkaichao <youkaichao@gmail.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 19, 2025 [FEAT] [AITER] Support AITER operators: Fused MoE, Linear, Norm ( #436 ) â€¦ 4c8c86d * [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* Integrated ater: kvcache pa gemm rmsnorm\n\n* fix pa\n\n* fix\n\n* replace topk softmax\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* replace fp moe kernel with aiter kernel\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* change ater to aiter\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config\n\n* Applying scales rename to fp8 config ( #387 )\n\n* Update Dockerfile.rocm\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Using aiter moe kernel\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* fix pa copy\n\n* pa update\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* add fp16 pa support for aiter\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* aiter build instructions\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Copy to the right path\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Add env var toggles to disable AITER MoE or PA (both by default on)\n\n* Update accuracy benchmark for batch size > 1\n\n* Add a few more AITER toggles for norm and linear layers\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Public aiter repo\n\n* Fail if aiter build failed silently\n\n* Aiter can only be built on MI300x\n\n* Typo fix\n\n* Aiter PA off by default\n\n* Changes to support updated aiter FP8 PA\n\n* Support FP8 and INT8 KV cache according to ROCm/aiter#90 * add moe weight shuffle for dynamic quant and unquantized path\n\nSigned-off-by: charlifu <charlifu@amd.com>\n\n* Use FP16-native PA after support in ROCm/aiter#97 * Fix: Use FP8 pertoken quantize if KV cache dtype is FP8\n\n* revert rocm_flash_attn.py line 883\n\n* Don't enable by default to use an RC for main vllm-dev docker\n\n* use ck moe for bf16 and fp16 fused_moe\n\n* Merge remote-tracking branch 'origin/aiter_intergration_final' into merge-aiter-llama-fp8\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] include moe shuffle env variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: charlifu <charlifu@amd.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: amd-ruitang3 <Rui.Tang2@amd.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: chenjun <junchen2@amd.com>\nCo-authored-by: ValarLip <340077269@qq.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Matthew Wong <Matthew.Wong2@amd.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: charlifu <chalifu@amd.com> mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 ) â€¦ 527f2b8 Signed-off-by: youkaichao <youkaichao@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:46:57", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, Throughput, Throughput | SERVING: serving, serving, serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:46:57", "models": ["meta-llama/Meta-Llama-3-8B"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_latency.py --model meta-llama/Meta-Llama-3-8B --load-format dummy", "commit_subject": "[perf] fix perf regression from #12253 (#12380)", "commit_message": "[perf] fix perf regression from #12253 (#12380)\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>", "commit_date": "2025-01-24T11:34:27+08:00", "files_changed": ["vllm/worker/model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 5, "num_non_test_edited_lines": 5, "commit_year": 2025}, "diff_text": "diff --git a/vllm/worker/model_runner.py b/vllm/worker/model_runner.py\nindex cf2f1c6b3..bf1a40d48 100644\n--- a/vllm/worker/model_runner.py\n+++ b/vllm/worker/model_runner.py\n@@ -455,7 +455,6 @@ class ModelInputForGPUBuilder(ModelRunnerInputBuilderBase[ModelInputForGPU]):\n         self.enable_prompt_adapter = (self.runner.prompt_adapter_config\n                                       is not None)\n         self.multi_modal_input_mapper = self.runner.multi_modal_input_mapper\n-        self.decode_only = True\n \n         # Attention metadata inputs.\n         if self.attn_backend is not None:\n@@ -477,6 +476,10 @@ class ModelInputForGPUBuilder(ModelRunnerInputBuilderBase[ModelInputForGPU]):\n                 finished_requests_ids: Optional[List[str]] = None) -> None:\n         self.finished_requests_ids = finished_requests_ids\n \n+        # if the current batch is decode-only.\n+        # will be set to False if there is any non-decode request.\n+        self.decode_only = True\n+\n         # Intermediate data (data in CPU before going to GPU) for\n         # the current sequence group.\n         self.inter_data_list: List[", "apis": ["vllm.worker.model_runner.ModelInputForGPUBuilder.__init__"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_completion.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test file (vllm/worker/model_runner.py) by removing an earlier assignment to self.decode_only and reintroducing it later along with explanatory comments, which indicates a fix to the internal logic affecting performance behavior. The commit message \"[perf] fix perf regression\" explicitly ties the change to performance, and the adjustment is made in a core component that impacts the runtime behavior (CPU-based performance) of the model runner. Although the change may appear minor, it is not a simple refactoring or a bug fix unrelated to performanceâ€”it specifically addresses a performance regression. Therefore, the commit satisfies the conditions for being performance related.", "llm_api_reason": "The commit moves the assignment of the â€œdecode_onlyâ€ flag within the ModelInputForGPUBuilderâ€™s initialization. Originally the builder would set decode_only at the very start, but now that assignment is removed from its original location and instead is performed after setting finished_requests_ids. Although this change is internal and does not add or remove any public functions, it does change the behavior of the builder used in the modelâ€runner API. Since ModelInputForGPUBuilder.__init__ is directly modified, that is the affected API."}
{"commit_hash": "aea94362c9bdd08ed2b346701bdc09d278e85f66", "pr_url": "https://github.com/vllm-project/vllm/pull/12287", "pr_date": "2025-01-22", "timeline_text": "Copy link Member njhill commented Jan 21, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . These help in particular with TTFT, ITL variance, and overall throughput. Break up output processing (detokenization) to avoid blocking the event loop for too long Freeze the heap after startup to reduce GC overhead/pauses Optimize a couple of CPU hotspots seen during profiling Benchmark on A100: VLLM_USE_V1=1 vllm serve meta-llama/Llama-3.2-1B-Instruct --disable-log-requests --port 8001 --max-num-batched-tokens 8192 --no-enable-prefix-caching --uvicorn-log-level=error python benchmarks/benchmark_serving.py \\\n    --backend vllm \\\n    --model meta-llama/Llama-3.2-1B-Instruct \\\n    --dataset-name sharegpt \\\n    --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json \\\n    --ignore-eos \\\n    --port 8001 \\\n    --save-result \\\n    --result-dir results \\\n    --result-filename test.json \\\n    --num-prompts 6000 \\\n    --request-rate inf \\\n    --max-concurrency=400 Before: ============ Serving Benchmark Result ============\nSuccessful requests:                     6000      \nBenchmark duration (s):                  94.31     \nTotal input tokens:                      1350511   \nTotal generated tokens:                  1211959   \nRequest throughput (req/s):              63.62     \nOutput token throughput (tok/s):         12850.45  \nTotal Token throughput (tok/s):          27169.98  \n---------------Time to First Token----------------\nMean TTFT (ms):                          229.23    \nMedian TTFT (ms):                        158.08    \nP99 TTFT (ms):                           1050.70   \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          30.02     \nMedian TPOT (ms):                        29.64     \nP99 TPOT (ms):                           68.90     \n---------------Inter-token Latency----------------\nMean ITL (ms):                           28.77     \nMedian ITL (ms):                         23.19     \nP99 ITL (ms):                            386.30    \n================================================== After: ============ Serving Benchmark Result ============\nSuccessful requests:                     6000      \nBenchmark duration (s):                  88.60     \nTotal input tokens:                      1350511   \nTotal generated tokens:                  1211959   \nRequest throughput (req/s):              67.72     \nOutput token throughput (tok/s):         13679.34  \nTotal Token throughput (tok/s):          28922.50  \n---------------Time to First Token----------------\nMean TTFT (ms):                          197.34    \nMedian TTFT (ms):                        168.03    \nP99 TTFT (ms):                           1059.55   \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          28.30     \nMedian TPOT (ms):                        27.75     \nP99 TPOT (ms):                           47.38     \n---------------Inter-token Latency----------------\nMean ITL (ms):                           26.64     \nMedian ITL (ms):                         24.38     \nP99 ITL (ms):                            65.19     \n================================================== Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 9 jeejeelee, comaniac, simon-mo, WoosukKwon, ywang96, robertgshaw2-redhat, mgoin, drikster80, and nickandbro reacted with heart emoji ðŸš€ 1 tlrmchlsmth reacted with rocket emoji All reactions â¤ï¸ 9 reactions ðŸš€ 1 reaction njhill requested review from WoosukKwon , robertgshaw2-redhat , ywang96 , comaniac and alexm-redhat as code owners January 21, 2025 23:38 Copy link github-actions bot commented Jan 21, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the frontend label Jan 21, 2025 [Frontend][V1] Online serving performance improvements â€¦ 55dd119 These help in particular with TTFT, and ITL variance. Overall throughput doesn't change much.\n\n- Break up output processing (detokenization) to avoid blocking the event loop for too long\n- Freeze the heap after startup to reduce GC overhead/pauses\n- Optimize a couple of CPU hotspots seen during profiling\n\nSigned-off-by: Nick Hill <nhill@redhat.com> njhill force-pushed the v1-perf-smoothing branch\n    from cfc5705 to 55dd119 Compare January 21, 2025 23:39 njhill commented Jan 22, 2025 View reviewed changes vllm/entrypoints/openai/protocol.py @@ -42,23 +42,31 @@ class OpenAIBaseModel(BaseModel): # OpenAI API does allow extra fields model_config = ConfigDict(extra=\"allow\") # Cache class field names field_names: ClassVar[Optional[Set[str]]] = None Copy link Member Author njhill Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment There was noticeable overhead creating this set every time one of these objects is instantiated. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 3 mgoin, DarkLight1337, and ywang96 reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions vllm/v1/request.py def output_token_ids ( self ) -> ConstantList [ int ]: # Prevent directly appending to the output_token_ids since # all_token_ids should also be updated simultaneously. return ConstantList ( self . _output_token_ids ) Copy link Member Author njhill Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Avoid constructing these objects every time the properties are accessed. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 WoosukKwon and DarkLight1337 reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Copy link Collaborator WoosukKwon Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice catch! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member mgoin Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I actually thought properties were cached after the first call, nice call Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member DarkLight1337 Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I actually thought properties were cached after the first call, nice call That would involve the use of cached_property . Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 mgoin and njhill reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Parallelize output socket IO on client side â€¦ 0e92b61 Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Collaborator robertgshaw2-redhat commented Jan 22, 2025 Wow, the impact on P99 ITL is crazy. ðŸš€ 1 mgoin reacted with rocket emoji All reactions ðŸš€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat reviewed Jan 22, 2025 View reviewed changes vllm/entrypoints/openai/api_server.py # Mark the startup heap as static so that it's ignored by GC. # Reduces pause times of oldest generation collections. gc.collect() gc.freeze() Copy link Collaborator robertgshaw2-redhat Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do we need to call unfreeze at some point? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author njhill Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment No, this is mostly static stuff that will be around for the lifetime of the process anyhow. https://www.rippling.com/blog/the-garbage-collector-fights-back Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author njhill commented Jan 22, 2025 Combining with #12298 and increasing the max output processing chunk size to 256 gets higher throughput at the cost of slightly more latency variance. Since the benchmark I've been running is 400 concurrent requests, the 256 chunk size essentially just means those will be split into two chunks of ~400. If I disable the chunking completely, the throughput increases to 80 req/sec (with the coalescing), but the inter-response latencies become larger and more uneven. ============ Serving Benchmark Result ============\nSuccessful requests:                     6000      \nBenchmark duration (s):                  84.70     \nTotal input tokens:                      1350511   \nTotal generated tokens:                  1211959   \nRequest throughput (req/s):              70.84     \nOutput token throughput (tok/s):         14308.94  \nTotal Token throughput (tok/s):          30253.69  \n---------------Time to First Token----------------\nMean TTFT (ms):                          198.28    \nMedian TTFT (ms):                        166.40    \nP99 TTFT (ms):                           1128.75   \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          26.76     \nMedian TPOT (ms):                        26.05     \nP99 TPOT (ms):                           50.04     \n---------------Inter-token Latency----------------\nMean ITL (ms):                           29.41     \nMedian ITL (ms):                         26.83     \nP99 ITL (ms):                            75.34     \n================================================== All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author njhill commented Jan 22, 2025 It would probably be good to also make OUTPUT_PROCESSING_CHUNK_SIZE overridable via an env var. ðŸ‘ 2 mgoin and ywang96 reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin reviewed Jan 22, 2025 View reviewed changes vllm/v1/engine/output_processor.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/request.py def output_token_ids ( self ) -> ConstantList [ int ]: # Prevent directly appending to the output_token_ids since # all_token_ids should also be updated simultaneously. return ConstantList ( self . _output_token_ids ) Copy link Member mgoin Jan 22, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I actually thought properties were cached after the first call, nice call Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions ywang96 reviewed Jan 22, 2025 View reviewed changes vllm/v1/engine/async_llm.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . njhill added 2 commits January 22, 2025 08:56 Make max processing chunk size overridable, fix linting â€¦ aa7f031 Signed-off-by: Nick Hill <nhill@redhat.com> Merge remote-tracking branch 'refs/remotes/origin/main' into v1-perf-â€¦ â€¦ e6fc61f â€¦smoothing mgoin approved these changes Jan 22, 2025 View reviewed changes Copy link Member mgoin left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! I ran an lm-eval test with gsm8k as a smoke test and got the same result as v0 VLLM_USE_V1=1 vllm serve meta-llama/Llama-3.1-8B-Instruct --disable-log-requests --port 8000 --max-num-batched-tokens 8192 --no-enable-prefix-caching\n\nlm_eval --model local-completions --model_args model=meta-llama/Llama-3.1-8B-Instruct,base_url=http://0.0.0.0:8000/v1/completions,num_concurrent=50,tokenized_requests=False --tasks gsm8k --num_fewshot 5\nlocal-completions (model=meta-llama/Llama-3.1-8B-Instruct,base_url=http://0.0.0.0:8000/v1/completions,num_concurrent=50,tokenized_requests=False), gen_kwargs: (None), limit: None, num_fewshot: 5, batch_size: 1\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.7718|Â±  |0.0116|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.6983|Â±  |0.0126| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 WoosukKwon reacted with heart emoji All reactions â¤ï¸ 1 reaction mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jan 22, 2025 Copy link mergify bot commented Jan 22, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @njhill . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jan 22, 2025 Merge remote-tracking branch 'origin/main' into v1-perf-smoothing â€¦ eafe7cb # Conflicts:\n#\tvllm/envs.py mergify bot removed\n  the needs-rebase label Jan 22, 2025 mgoin enabled auto-merge (squash) January 22, 2025 22:18 Hide details View details mgoin merged commit aea9436 into vllm-project : main Jan 22, 2025 51 checks passed Uh oh! There was an error while loading. Please reload this page . njhill deleted the v1-perf-smoothing branch January 22, 2025 23:34 tjtanaa pushed a commit\n        to EmbeddedLLM/vllm\n      that referenced\n      this pull request Jan 28, 2025 [Frontend][V1] Online serving performance improvements ( vllm-project#â€¦ â€¦ d57c673 â€¦12287 ) rasmith pushed a commit\n        to rasmith/vllm\n      that referenced\n      this pull request Jan 30, 2025 [Frontend][V1] Online serving performance improvements ( vllm-project#â€¦ â€¦ f9304d2 â€¦12287 ) Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [Frontend][V1] Online serving performance improvements ( vllm-project#â€¦ â€¦ 1f63490 â€¦12287 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 3, 2025 [MFM-2025-02-03] Merge Main to llama fp8; With Faster ROCm Paged Atteâ€¦ â€¦ 479b843 â€¦ntion ( #399 )\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 5, 2025 [Bug Fix] Missing vllm.envs ( #405 ) â€¦ 87b3c56 * [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] included missing environment variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> NickLucche pushed a commit\n        to NickLucche/vllm\n      that referenced\n      this pull request Feb 7, 2025 [Frontend][V1] Online serving performance improvements ( vllm-project#â€¦ â€¦ 0048cc4 â€¦12287 ) GWS0428 pushed a commit\n        to GWS0428/VARserve\n      that referenced\n      this pull request Feb 12, 2025 [Frontend][V1] Online serving performance improvements ( vllm-project#â€¦ â€¦ a432d0d â€¦12287 ) hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 19, 2025 [FEAT] [AITER] Support AITER operators: Fused MoE, Linear, Norm ( #436 ) â€¦ 4c8c86d * [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* Integrated ater: kvcache pa gemm rmsnorm\n\n* fix pa\n\n* fix\n\n* replace topk softmax\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* replace fp moe kernel with aiter kernel\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* change ater to aiter\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config\n\n* Applying scales rename to fp8 config ( #387 )\n\n* Update Dockerfile.rocm\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Using aiter moe kernel\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* fix pa copy\n\n* pa update\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* add fp16 pa support for aiter\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* aiter build instructions\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Copy to the right path\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Add env var toggles to disable AITER MoE or PA (both by default on)\n\n* Update accuracy benchmark for batch size > 1\n\n* Add a few more AITER toggles for norm and linear layers\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Public aiter repo\n\n* Fail if aiter build failed silently\n\n* Aiter can only be built on MI300x\n\n* Typo fix\n\n* Aiter PA off by default\n\n* Changes to support updated aiter FP8 PA\n\n* Support FP8 and INT8 KV cache according to ROCm/aiter#90 * add moe weight shuffle for dynamic quant and unquantized path\n\nSigned-off-by: charlifu <charlifu@amd.com>\n\n* Use FP16-native PA after support in ROCm/aiter#97 * Fix: Use FP8 pertoken quantize if KV cache dtype is FP8\n\n* revert rocm_flash_attn.py line 883\n\n* Don't enable by default to use an RC for main vllm-dev docker\n\n* use ck moe for bf16 and fp16 fused_moe\n\n* Merge remote-tracking branch 'origin/aiter_intergration_final' into merge-aiter-llama-fp8\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] include moe shuffle env variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: charlifu <charlifu@amd.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: amd-ruitang3 <Rui.Tang2@amd.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: chenjun <junchen2@amd.com>\nCo-authored-by: ValarLip <340077269@qq.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Matthew Wong <Matthew.Wong2@amd.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: charlifu <chalifu@amd.com> mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [Frontend][V1] Online serving performance improvements ( vllm-project#â€¦ â€¦ d7a090a â€¦12287 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:04", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm-eval, lm_eval, gsm8k | PERF: TTFT, TTFT, TTFT | SERVING: vllm serve, vllm serve, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:04", "models": ["meta-llama/Llama-3.1-8B-Instruct", "meta-llama/Llama-3.2-1B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.2-1B-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Frontend][V1] Online serving performance improvements (#12287)", "commit_message": "[Frontend][V1] Online serving performance improvements (#12287)", "commit_date": "2025-01-22T22:22:12Z", "files_changed": ["vllm/entrypoints/openai/api_server.py", "vllm/entrypoints/openai/protocol.py", "vllm/envs.py", "vllm/v1/engine/async_llm.py", "vllm/v1/engine/core_client.py", "vllm/v1/engine/output_processor.py", "vllm/v1/request.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 7, "only_test_files": 0, "only_non_test_files": 1, "num_files": 7, "num_hunks": 17, "num_edited_lines": 146, "num_non_test_edited_lines": 146, "commit_year": 2025}, "diff_text": "diff --git a/vllm/entrypoints/openai/api_server.py b/vllm/entrypoints/openai/api_server.py\nindex 9bb11907f..f510c4150 100644\n--- a/vllm/entrypoints/openai/api_server.py\n+++ b/vllm/entrypoints/openai/api_server.py\n@@ -1,5 +1,6 @@\n import asyncio\n import atexit\n+import gc\n import importlib\n import inspect\n import multiprocessing\n@@ -104,6 +105,11 @@ async def lifespan(app: FastAPI):\n             task.add_done_callback(_running_tasks.remove)\n         else:\n             task = None\n+\n+        # Mark the startup heap as static so that it's ignored by GC.\n+        # Reduces pause times of oldest generation collections.\n+        gc.collect()\n+        gc.freeze()\n         try:\n             yield\n         finally:\ndiff --git a/vllm/entrypoints/openai/protocol.py b/vllm/entrypoints/openai/protocol.py\nindex 14e41346d..80403f77d 100644\n--- a/vllm/entrypoints/openai/protocol.py\n+++ b/vllm/entrypoints/openai/protocol.py\n@@ -3,7 +3,7 @@\n import re\n import time\n from argparse import Namespace\n-from typing import Any, Dict, List, Literal, Optional, Union\n+from typing import Any, ClassVar, Dict, List, Literal, Optional, Set, Union\n \n import torch\n from pydantic import BaseModel, ConfigDict, Field, model_validator\n@@ -42,23 +42,31 @@ class OpenAIBaseModel(BaseModel):\n     # OpenAI API does allow extra fields\n     model_config = ConfigDict(extra=\"allow\")\n \n+    # Cache class field names\n+    field_names: ClassVar[Optional[Set[str]]] = None\n+\n     @model_validator(mode=\"before\")\n     @classmethod\n     def __log_extra_fields__(cls, data):\n-        if isinstance(data, dict):\n+\n+        field_names = cls.field_names\n+        if field_names is None:\n+            if not isinstance(data, dict):\n+                return data\n             # Get all class field names and their potential aliases\n             field_names = set()\n             for field_name, field in cls.model_fields.items():\n                 field_names.add(field_name)\n-                if hasattr(field, 'alias') and field.alias:\n-                    field_names.add(field.alias)\n-\n-            # Compare against both field names and aliases\n-            extra_fields = data.keys() - field_names\n-            if extra_fields:\n-                logger.warning(\n-                    \"The following fields were present in the request \"\n-                    \"but ignored: %s\", extra_fields)\n+                if alias := getattr(field, 'alias', None):\n+                    field_names.add(alias)\n+            cls.field_names = field_names\n+\n+        # Compare against both field names and aliases\n+        if any(k not in field_names for k in data):\n+            logger.warning(\n+                \"The following fields were present in the request \"\n+                \"but ignored: %s\",\n+                data.keys() - field_names)\n         return data\n \n \ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex 1e68326b2..3a15e00e7 100644\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -73,6 +73,7 @@ if TYPE_CHECKING:\n     VLLM_LOG_BATCHSIZE_INTERVAL: float = -1\n     VLLM_DISABLE_COMPILE_CACHE: bool = False\n     VLLM_SERVER_DEV_MODE: bool = False\n+    VLLM_V1_OUTPUT_PROC_CHUNK_SIZE: int = 128\n \n \n def get_default_cache_root():\n@@ -474,6 +475,16 @@ environment_variables: Dict[str, Callable[[], Any]] = {\n     # e.g. `/reset_prefix_cache`\n     \"VLLM_SERVER_DEV_MODE\":\n     lambda: bool(int(os.getenv(\"VLLM_SERVER_DEV_MODE\", \"0\"))),\n+\n+    # Controls the maximum number of requests to handle in a\n+    # single asyncio task when processing per-token outputs in the\n+    # V1 AsyncLLM interface. It is applicable when handling a high\n+    # concurrency of streaming requests.\n+    # Setting this too high can result in a higher variance of\n+    # inter-message latencies. Setting it too low can negatively impact\n+    # TTFT and overall throughput.\n+    \"VLLM_V1_OUTPUT_PROC_CHUNK_SIZE\":\n+    lambda: int(os.getenv(\"VLLM_V1_OUTPUT_PROC_CHUNK_SIZE\", \"128\")),\n }\n \n # end-env-vars-definition\ndiff --git a/vllm/v1/engine/async_llm.py b/vllm/v1/engine/async_llm.py\nindex b4d3e4411..1505b6250 100644\n--- a/vllm/v1/engine/async_llm.py\n+++ b/vllm/v1/engine/async_llm.py\n@@ -2,9 +2,12 @@ import asyncio\n import os\n from typing import AsyncGenerator, List, Mapping, Optional, Type, Union\n \n+import numpy as np\n+\n from vllm.config import ModelConfig, VllmConfig\n from vllm.engine.arg_utils import AsyncEngineArgs\n from vllm.engine.protocol import EngineClient\n+from vllm.envs import VLLM_V1_OUTPUT_PROC_CHUNK_SIZE\n from vllm.inputs import INPUT_REGISTRY, InputRegistry, PromptType\n from vllm.inputs.preprocess import InputPreprocessor\n from vllm.logger import init_logger\n@@ -16,7 +19,7 @@ from vllm.sampling_params import SamplingParams\n from vllm.transformers_utils.tokenizer import AnyTokenizer\n from vllm.transformers_utils.tokenizer_group import init_tokenizer_from_configs\n from vllm.usage.usage_lib import UsageContext\n-from vllm.utils import kill_process_tree\n+from vllm.utils import cdiv, kill_process_tree\n from vllm.v1.engine.core_client import EngineCoreClient\n from vllm.v1.engine.output_processor import OutputProcessor\n from vllm.v1.engine.processor import Processor\n@@ -205,17 +208,15 @@ class AsyncLLM(EngineClient):\n \n             # The output_handler task pushes items into the queue.\n             # This task pulls from the queue and yields to caller.\n-            while True:\n+            finished = False\n+            while not finished:\n                 # Note: drain queue without await if possible (avoids\n                 # task switching under load which helps performance).\n-                out = q.get_nowait() if q.qsize() > 0 else await q.get()\n+                out = q.get_nowait() if not q.empty() else await q.get()\n \n                 # Note: both OutputProcessor and EngineCore handle their\n                 # own request cleanup based on finished.\n-                if out.finished:\n-                    yield out\n-                    break\n-\n+                finished = out.finished\n                 yield out\n \n         # If the request is disconnected by the client, the\n@@ -233,22 +234,41 @@ class AsyncLLM(EngineClient):\n                 # 1) Pull EngineCoreOutputs from the EngineCore.\n                 outputs = await self.engine_core.get_output_async()\n \n-                # 2) Process EngineCoreOutputs.\n-                processed_outputs = self.output_processor.process_outputs(\n-                    outputs.outputs)\n-                # NOTE: RequestOutputs are pushed to their queues.\n-                assert len(processed_outputs.request_outputs) == 0\n-\n-                # 3) Abort any reqs that finished due to stop strings.\n-                await self.engine_core.abort_requests_async(\n-                    processed_outputs.reqs_to_abort)\n+                # Split outputs into chunks of at most\n+                # VLLM_V1_OUTPUT_PROC_CHUNK_SIZE, so that we don't block the\n+                # event loop for too long.\n+                num_outputs = len(outputs.outputs)\n+                if num_outputs <= VLLM_V1_OUTPUT_PROC_CHUNK_SIZE:\n+                    slices = (outputs.outputs, )\n+                else:\n+                    slices = np.array_split(\n+                        outputs.outputs,\n+                        cdiv(num_outputs, VLLM_V1_OUTPUT_PROC_CHUNK_SIZE))\n+\n+                iteration_stats = None\n+                for i, outputs_slice in enumerate(slices):\n+                    # 2) Process EngineCoreOutputs.\n+                    processed_outputs = self.output_processor.process_outputs(\n+                        outputs_slice, iteration_stats)\n+                    # NOTE: RequestOutputs are pushed to their queues.\n+                    assert not processed_outputs.request_outputs\n+                    iteration_stats = processed_outputs.iteration_stats\n+\n+                    # Allow other asyncio tasks to run between chunks\n+                    if i + 1 < len(slices):\n+                        await asyncio.sleep(0)\n+\n+                    # 3) Abort any reqs that finished due to stop strings.\n+                    await self.engine_core.abort_requests_async(\n+                        processed_outputs.reqs_to_abort)\n \n                 # 4) Logging.\n                 # TODO(rob): make into a coroutine and launch it in\n                 # background thread once we add Prometheus.\n+                assert iteration_stats is not None\n                 self._log_stats(\n                     scheduler_stats=outputs.scheduler_stats,\n-                    iteration_stats=processed_outputs.iteration_stats,\n+                    iteration_stats=iteration_stats,\n                 )\n \n         except Exception as e:\ndiff --git a/vllm/v1/engine/core_client.py b/vllm/v1/engine/core_client.py\nindex 19b89003c..f3b992d68 100644\n--- a/vllm/v1/engine/core_client.py\n+++ b/vllm/v1/engine/core_client.py\n@@ -1,8 +1,9 @@\n+import asyncio\n import os\n import signal\n import weakref\n from abc import ABC, abstractmethod\n-from typing import List, Type\n+from typing import List, Optional, Type\n \n import msgspec\n import zmq\n@@ -255,10 +256,24 @@ class AsyncMPClient(MPClient):\n             log_stats=True,\n         )\n \n+        self.outputs_queue: Optional[asyncio.Queue[bytes]] = None\n+        self.queue_task: Optional[asyncio.Task] = None\n+\n     async def get_output_async(self) -> EngineCoreOutputs:\n+        if self.outputs_queue is None:\n+            # Perform IO in separate task to parallelize as much as possible\n+            self.outputs_queue = asyncio.Queue()\n+\n+            async def process_outputs_socket():\n+                assert self.outputs_queue is not None\n+                while True:\n+                    (frame, ) = await self.output_socket.recv_multipart(\n+                        copy=False)\n+                    self.outputs_queue.put_nowait(frame.buffer)\n+\n+            self.queue_task = asyncio.create_task(process_outputs_socket())\n \n-        frames = await self.output_socket.recv_multipart(copy=False)\n-        return self.decoder.decode(frames[0].buffer)\n+        return self.decoder.decode(await self.outputs_queue.get())\n \n     async def _send_input(self, request_type: EngineCoreRequestType,\n                           request: EngineCoreRequestUnion) -> None:\ndiff --git a/vllm/v1/engine/output_processor.py b/vllm/v1/engine/output_processor.py\nindex 749f4f504..564eab51b 100644\n--- a/vllm/v1/engine/output_processor.py\n+++ b/vllm/v1/engine/output_processor.py\n@@ -101,6 +101,7 @@ class OutputProcessor:\n     def process_outputs(\n         self,\n         engine_core_outputs: List[EngineCoreOutput],\n+        iteration_stats: Optional[IterationStats] = None,\n     ) -> OutputProcessorOutput:\n         \"\"\"\n         Process the EngineCoreOutputs:\n@@ -133,7 +134,8 @@ class OutputProcessor:\n \n         request_outputs: List[RequestOutput] = []\n         reqs_to_abort: List[str] = []\n-        iteration_stats = IterationStats(self.log_stats)\n+        if not iteration_stats:\n+            iteration_stats = IterationStats(self.log_stats)\n         for engine_core_output in engine_core_outputs:\n             req_id = engine_core_output.request_id\n             req_state = self.request_states.get(req_id)\n@@ -175,8 +177,8 @@ class OutputProcessor:\n             iteration_stats=iteration_stats,\n         )\n \n+    @staticmethod\n     def _make_request_output(\n-        self,\n         request_state: RequestState,\n         detokenizer_output: Optional[DetokenizerOutput],\n     ) -> Optional[RequestOutput]:\ndiff --git a/vllm/v1/request.py b/vllm/v1/request.py\nindex 45450165e..eefcdaf29 100644\n--- a/vllm/v1/request.py\n+++ b/vllm/v1/request.py\n@@ -64,6 +64,12 @@ class Request:\n         # recomputing.\n         self._kv_block_hashes: List[BlockHashType] = []\n \n+        # Read-only views\n+        # Prevent directly appending to the these lists since\n+        # they should also be updated simultaneously.\n+        self.output_token_ids = ConstantList(self._output_token_ids)\n+        self.all_token_ids = ConstantList(self._all_token_ids)\n+\n     @classmethod\n     def from_engine_core_request(cls, request: EngineCoreRequest) -> \"Request\":\n         return cls(\n@@ -79,18 +85,6 @@ class Request:\n             lora_request=request.lora_request,\n         )\n \n-    @property\n-    def output_token_ids(self) -> ConstantList[int]:\n-        # Prevent directly appending to the output_token_ids since\n-        # all_token_ids should also be updated simultaneously.\n-        return ConstantList(self._output_token_ids)\n-\n-    @property\n-    def all_token_ids(self) -> ConstantList[int]:\n-        # Prevent directly appending to the all_token_ids since\n-        # output_token_ids should also be updated simultaneously\n-        return ConstantList(self._all_token_ids)\n-\n     def append_output_token_ids(\n         self,\n         token_ids: Union[int, List[int]],", "apis": ["AsyncLLM.generate", "AsyncMPClient.get_output_async", "OpenAIBaseModel.__log_extra_fields__"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/protocol.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/protocol.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/async_llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies multiple non-test source files and applies non-trivial changes that adjust runtime behavior for improved online serving performance. For example, it adds garbage collection optimizations in the API server (gc.collect(), gc.freeze()), caches field names to avoid redundant computation in the protocol module, and restructures the asynchronous output processing loop to split outputs into chunks and yield control to avoid event loop blocking. These changes are clearly aimed at reducing latency and improving throughput in CPU-bound online serving without introducing new features or simple refactoring. Hence, it satisfies the conditions for a performance/optimization related commit.", "llm_api_reason": "The commit makes several performanceâ€oriented changes to the vLLM code. In the OpenAI API server entrypoint, it adds garbage collection calls (gc.collect and gc.freeze) during app lifespan startup to reduce GC pause times. In the OpenAI protocol, the __log_extra_fields__ validator is modified to cache field names to reduce repeated work when processing request payloads. Within the v1 engine code, the asynchronous inference loop is optimized by splitting output processing into smaller chunks (controlled by the new VLLM_V1_OUTPUT_PROC_CHUNK_SIZE environment variable) and by improving the â€œgenerateâ€ and â€œget_output_asyncâ€ methods to reduce blocking and overhead. These changes affect the highâ€level inference API and the OpenAI protocol models used for serving results."}
{"commit_hash": "3127e975fb9417d10513e25b80820870f594c627", "pr_url": "https://github.com/vllm-project/vllm/pull/12212", "pr_date": "2025-01-20", "timeline_text": "Copy link Member DarkLight1337 commented Jan 20, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Running mypy on all target Python versions takes too long for local development. This PR reserves manual stage to be only run in pre-commit CI, and moves the mypy checks to manual stage. Meanwhile, a new commit hook is added to run mypy only on the current Python version. This hook is assigned to pre-commit stage so it is automatically run locally. This should make pre-commit take around the same time as the old format.sh . cc @hmellor Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Make pre-commit faster â€¦ 4d4bfa3 Signed-off-by: DarkLight1337 <tlleungac@connect.ust.hk> DarkLight1337 requested a review\n  from youkaichao January 20, 2025 09:25 Copy link github-actions bot commented Jan 20, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the ci/build label Jan 20, 2025 youkaichao reviewed Jan 20, 2025 View reviewed changes .pre-commit-config.yaml @@ -1,3 +1,6 @@ default_stages : - pre-commit # Run locally - manual # Run in CI Copy link Member youkaichao Jan 20, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment stage name: manual or ci ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author DarkLight1337 Jan 20, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stage name is hardcoded: https://pre-commit.com/#confining-hooks-to-run-at-certain-stages I don't think we can change the name... Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link shahedy2276541 Jan 29, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment mostafa Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions youkaichao approved these changes Jan 20, 2025 View reviewed changes Copy link Member youkaichao left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment works for me, thanks for the improvement! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details youkaichao merged commit 3127e97 into vllm-project : main Jan 20, 2025 9 of 12 checks passed Uh oh! There was an error while loading. Please reload this page . DarkLight1337 deleted the pre-commit-fast branch January 20, 2025 09:39 Copy link Member hmellor commented Jan 20, 2025 This is a sensible solution while we are running mypy so many times (60 times across all 4 supported python versions). Once the repo confirms to mypy better we can revert to running all python versions which is only 4 runs of mypy (i.e. quicker than running 1 python version today) All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . kzawora-intel mentioned this pull request Jan 21, 2025 Rebase 2025.01.21 HabanaAI/vllm-fork#714 Merged khluu mentioned this pull request Jan 21, 2025 [ci/lint] Add back default arg for pre-commit #12279 Merged kzawora-intel added a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Jan 28, 2025 Rebase 2025.01.21 ( #714 ) â€¦ c9db39b - **[Bugfix] Fix score api for missing max_model_len validation\n( vllm-project#12119 )**\n- **[Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )**\n- **[AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )**\n- **[torch.compile] disable logging when cache is disabled ( vllm-project#12043 )**\n- **[misc] fix cross-node TP ( vllm-project#12166 )**\n- **[AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )**\n- **[core] further polish memory profiling ( vllm-project#12126 )**\n- **[Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )**\n- **[Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )**\n- **[core] clean up executor class hierarchy between v1 and v0\n( vllm-project#12171 )**\n- **[Misc] Support register quantization method out-of-tree ( vllm-project#11969 )**\n- **[V1] Collect env var for usage stats ( vllm-project#12115 )**\n- **[BUGFIX] Move scores to float32 in case of running xgrammar on cpu\n( vllm-project#12152 )**\n- **[Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )**\n- **[torch.compile] store inductor compiled Python file ( vllm-project#12182 )**\n- **benchmark_serving support --served-model-name param ( vllm-project#12109 )**\n- **[Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )**\n- **[V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )**\n- **[Model] Support for fairseq2 Llama ( vllm-project#11442 )**\n- **[Bugfix] Fix num_heads value for simple connector when tp enabled\n( vllm-project#12074 )**\n- **[torch.compile] fix sym_tensor_indices ( vllm-project#12191 )**\n- **Move linting to `pre-commit` ( vllm-project#11975 )**\n- **[DOC] Fix typo in docstring and assert message ( vllm-project#12194 )**\n- **[DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )**\n- **[Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )**\n- **[Model] Add Qwen2 PRM model support ( vllm-project#12202 )**\n- **[Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )**\n- **[misc] add placeholder format.sh ( vllm-project#12206 )**\n- **[CI/Build] Remove dummy CI steps ( vllm-project#12208 )**\n- **[CI/Build] Make pre-commit faster ( vllm-project#12212 )**\n- **[Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )**\n- **[misc] print a message to suggest how to bypass commit hooks\n( vllm-project#12217 )**\n- **[core][bugfix] configure env var during import vllm ( vllm-project#12209 )**\n- **[V1] Remove `_get_cache_block_size` ( vllm-project#12214 )**\n- **[Misc] Pass `attention` to impl backend ( vllm-project#12218 )**\n- **[Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )**\n- **[CI] Pass local python version explicitly to pre-commit mypy.sh\n( vllm-project#12224 )**\n- **[Misc] Update CODEOWNERS ( vllm-project#12229 )**\n- **fix: update platform detection for M-series arm based MacBook\nprocessors ( vllm-project#12227 )**\n- **[misc] add cuda runtime version to usage data ( vllm-project#12190 )**\n- **[bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )**\n- **[Kernel] optimize moe_align_block_size for cuda graph and large\nnum_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )**\n- **Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )**\n- **[AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )**\n- **[BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64\n( vllm-project#12230 )**\n- **[ci/build] disable failed and flaky tests ( vllm-project#12240 )**\n- **[Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )**\n- **[Misc]Add BNB quantization for PaliGemmaForConditionalGeneration\n( vllm-project#12237 )**\n- **[Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )**\n- **[Bugfix] Fix mm_limits access for merged multi-modal processor\n( vllm-project#12252 )**\n\n---------\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com> rasmith pushed a commit\n        to rasmith/vllm\n      that referenced\n      this pull request Jan 30, 2025 [CI/Build] Make pre-commit faster ( vllm-project#12212 ) â€¦ 1a6c0a5 Signed-off-by: DarkLight1337 <tlleungac@connect.ust.hk> Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [CI/Build] Make pre-commit faster ( vllm-project#12212 ) â€¦ 241dff2 Signed-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 3, 2025 [MFM-2025-02-03] Merge Main to llama fp8; With Faster ROCm Paged Atteâ€¦ â€¦ 479b843 â€¦ntion ( #399 )\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 5, 2025 [Bug Fix] Missing vllm.envs ( #405 ) â€¦ 87b3c56 * [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* [Doc] Fix build from source and installation link in README.md ( vllm-project#12013 )\n\nSigned-off-by: Yikun <yikunkero@gmail.com>\n\n* Using list\n\n* [Bugfix] Fix deepseekv3 gate bias error ( vllm-project#12002 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* [Docs] Add Sky Computing Lab to project intro ( vllm-project#12019 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [HPU][Bugfix] set_forward_context and CI test execution ( vllm-project#12014 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config ( #387 )\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Update Dockerfile.rocm\n\n* [Bugfix]: inclucde the env variables required for running FastSyncLLM\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* fix pre-commit lint\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] included missing environment variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Yikun <yikunkero@gmail.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Yikun Jiang <yikunkero@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Steve Luo <36296769+SunflowerAries@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> GWS0428 pushed a commit\n        to GWS0428/VARserve\n      that referenced\n      this pull request Feb 12, 2025 [CI/Build] Make pre-commit faster ( vllm-project#12212 ) â€¦ 6876c40 Signed-off-by: DarkLight1337 <tlleungac@connect.ust.hk> hongxiayang added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 19, 2025 [FEAT] [AITER] Support AITER operators: Fused MoE, Linear, Norm ( #436 ) â€¦ 4c8c86d * [Doc] Update Quantization Hardware Support Documentation ( vllm-project#12025 )\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [HPU][misc] add comments for explanation ( vllm-project#12034 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix various bugs in multi-modal processor ( vllm-project#12031 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel] Revert the API change of Attention.forward ( vllm-project#12038 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Platform] Add output for Attention Backend ( vllm-project#11981 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix][Kernel] Give unique name to BlockSparseFlashAttention ( vllm-project#12040 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Explain where the engine args go when using Docker ( vllm-project#12041 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Docs lint\n\n* [Doc]: Update the Json Example of the `Engine Arguments` document ( vllm-project#12045 )\n\n* [Misc]  Merge bitsandbytes_stacked_params_mapping and packed_modules_mapping ( vllm-project#11924 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Support MulAndSilu ( vllm-project#11624 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [HPU][Bugfix] Don't use /dev/accel/accel0 for HPU autodetection in setup.py ( vllm-project#12046 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Platform] move current_memory_usage() into platform ( vllm-project#11369 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* [V1][BugFix] Fix edge case in VLM scheduling ( vllm-project#12065 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Add multipstep chunked-prefill support for FlashInfer ( vllm-project#10467 )\n\n* [core] Turn off GPU communication overlap for Ray executor ( vllm-project#12051 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [core] platform agnostic executor via collective_rpc ( vllm-project#11256 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Update examples to remove SparseAutoModelForCausalLM ( vllm-project#12062 )\n\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\n\n* [V1][Prefix Cache] Move the logic of num_computed_tokens into KVCacheManager ( vllm-project#12003 )\n\n* Fix: cases with empty sparsity config ( vllm-project#12057 )\n\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\n\n* Type-fix: make execute_model output type optional ( vllm-project#12020 )\n\n* [Platform] Do not raise error if _Backend is not found ( vllm-project#12023 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [Model]: Support internlm3 ( vllm-project#12037 )\n\n* Misc: allow to use proxy in `HTTPConnection` ( vllm-project#12042 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [Misc][Quark] Upstream Quark format to VLLM ( vllm-project#10765 )\n\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Doc]: Update `OpenAI-Compatible Server` documents ( vllm-project#12082 )\n\n* [Bugfix] use right truncation for non-generative tasks ( vllm-project#12050 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [V1][Core] Autotune encoder cache budget ( vllm-project#11895 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Fix _get_lora_device for HQQ marlin ( vllm-project#12090 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Allow hip sources to be directly included when compiling for rocm. ( vllm-project#12087 )\n\n* [Core] Default to using per_token quantization for fp8 when cutlass is supported. ( vllm-project#8651 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Add documentation for specifying model architecture ( vllm-project#12105 )\n\n* Various cosmetic/comment fixes ( vllm-project#12089 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Bugfix] Remove hardcoded `head_size=256` for Deepseek v2 and v3 ( vllm-project#12067 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Support torchrun and SPMD-style offline inference ( vllm-project#12071 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core] LLM.collective_rpc interface and RLHF example ( vllm-project#12084 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix max image feature size for Llava-one-vision ( vllm-project#12104 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Enable user marker for vllm profiling ( #357 )\n\n* Enable user marker for vllm profiling\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [misc] Add LoRA kernel micro benchmarks ( vllm-project#11579 )\n\n* [Model] Add support for deepseek-vl2-tiny model ( vllm-project#12068 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Deepseek V3 support ( #364 )\n\n* Changing the hard coded datatype to see if it's enough for the model to work\n\n* Picking the upstrteam moe kernel version\n\n* make upstream fix for v3 also works for rocm v2\n\n* Conditional fnuz dtype\n\n* Requantizing from fn to fnuz\n\n* Requantizing moe as well\n\n* Actually requantizing moe weights\n\n* Conditional requantization and assert on padding in block quant\n\n* Format\n\n---------\n\nCo-authored-by: charlifu <charlifu@amd.com>\n\n* [Bugfix] Set enforce_eager automatically for mllama ( vllm-project#12127 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Fix a path bug in disaggregated prefill example script. ( vllm-project#12121 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [CI]add genai-perf benchmark in nightly benchmark ( vllm-project#10704 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [Doc] Add instructions on using Podman when SELinux is active ( vllm-project#12136 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile ( vllm-project#12135 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] add more `is not None` check in VllmConfig.__post_init__ ( vllm-project#12138 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Add deepseek_vl2 chat template ( vllm-project#12143 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [ROCm][MoE] moe tuning support for rocm ( vllm-project#12049 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [V1] Move more control of kv cache initialization from model_executor to EngineCore ( vllm-project#11960 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Misc][LoRA] Improve the readability of LoRA error messages ( vllm-project#12102 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [CI/Build][CPU][Bugfix] Fix CPU CI ( vllm-project#12150 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [core] allow callable in collective_rpc ( vllm-project#12151 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix score api for missing max_model_len validation ( vllm-project#12119 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\n\n* [Bugfix] Mistral tokenizer encode accept list of str ( vllm-project#12149 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [AMD][FP8] Using MI300 FP8 format on ROCm for block_quant ( vllm-project#12134 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [torch.compile] disable logging when cache is disabled ( vllm-project#12043 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] fix cross-node TP ( vllm-project#12166 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [AMD][CI/Build][Bugfix] use pytorch stale wheel ( vllm-project#12172 )\n\nSigned-off-by: hongxyan <hongxyan@amd.com>\n\n* [core] further polish memory profiling ( vllm-project#12126 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Fix broken link in SECURITY.md ( vllm-project#12175 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Model] Port deepseek-vl2 processor, remove dependency ( vllm-project#12169 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] clean up executor class hierarchy between v1 and v0 ( vllm-project#12171 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Support register quantization method out-of-tree ( vllm-project#11969 )\n\n* [V1] Collect env var for usage stats ( vllm-project#12115 )\n\n* [BUGFIX] Move scores to float32 in case of running xgrammar on cpu ( vllm-project#12152 )\n\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [Bugfix] Fix multi-modal processors for transformers 4.48 ( vllm-project#12187 )\n\n* [torch.compile] store inductor compiled Python file ( vllm-project#12182 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* benchmark_serving support --served-model-name param ( vllm-project#12109 )\n\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Misc] Add BNB support to GLM4-V model ( vllm-project#12184 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Add V1 support of Qwen2-VL ( vllm-project#12128 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Support for fairseq2 Llama ( vllm-project#11442 )\n\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\n\n* [Bugfix] Fix num_heads value for simple connector when tp enabled ( vllm-project#12074 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [torch.compile] fix sym_tensor_indices ( vllm-project#12191 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Move linting to `pre-commit` ( vllm-project#11975 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [DOC] Fix typo in docstring and assert message ( vllm-project#12194 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [DOC] Add missing docstring in LLMEngine.add_request() ( vllm-project#12195 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Bugfix] Fix incorrect types in LayerwiseProfileResults ( vllm-project#12196 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Add Qwen2 PRM model support ( vllm-project#12202 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] Interface for accessing model from `VllmRunner` ( vllm-project#10353 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] add placeholder format.sh ( vllm-project#12206 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [CI/Build] Remove dummy CI steps ( vllm-project#12208 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Make pre-commit faster ( vllm-project#12212 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Upgrade Aria to transformers 4.48 ( vllm-project#12203 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] print a message to suggest how to bypass commit hooks ( vllm-project#12217 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][bugfix] configure env var during import vllm ( vllm-project#12209 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Remove `_get_cache_block_size` ( vllm-project#12214 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Misc] Pass `attention` to impl backend ( vllm-project#12218 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Fix `HfExampleModels.find_hf_info` ( vllm-project#12223 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] Pass local python version explicitly to pre-commit mypy.sh ( vllm-project#12224 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* Using ROCm6.3.1 base docker and building hipblas-common ( #366 )\n\n* [Misc] Update CODEOWNERS ( vllm-project#12229 )\n\n* fix: update platform detection for M-series arm based MacBook processors ( vllm-project#12227 )\n\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\n\n* [misc] add cuda runtime version to usage data ( vllm-project#12190 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [bugfix] catch xgrammar unsupported array constraints ( vllm-project#12210 )\n\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\n\n* [Kernel] optimize moe_align_block_size for cuda graph and large num_experts (e.g. DeepSeek-V3) ( vllm-project#12222 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add quantization and guided decoding CODEOWNERS ( vllm-project#12228 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [AMD][Build] Porting dockerfiles from the ROCm/vllm fork ( vllm-project#11777 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [BugFix] Fix GGUF tp>1 when vocab_size is not divisible by 64 ( vllm-project#12230 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [ci/build] disable failed and flaky tests ( vllm-project#12240 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Rename `MultiModalInputsV2 -> MultiModalInputs` ( vllm-project#12244 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]Add BNB quantization for PaliGemmaForConditionalGeneration  ( vllm-project#12237 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Remove redundant TypeVar from base model ( vllm-project#12248 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix mm_limits access for merged multi-modal processor ( vllm-project#12252 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] transparent compilation with more logging ( vllm-project#12246 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][Bugfix] Fix data item ordering in mixed-modality inference ( vllm-project#12259 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* Remove pytorch comments for outlines + compressed-tensors ( vllm-project#12260 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Platform] improve platforms getattr ( vllm-project#12264 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci/build] update nightly torch for gh200 test ( vllm-project#12270 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] fix race condition that leads to wrong order of token returned ( vllm-project#10802 )\n\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\n\n* [Kernel] fix moe_align_block_size error condition ( vllm-project#12239 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [v1][stats][1/n] Add RequestStatsUpdate and RequestStats types  ( vllm-project#10907 )\n\nSigned-off-by: rickyx <rickyx@anyscale.com>\n\n* [Bugfix] Multi-sequence broken ( vllm-project#11898 )\n\nSigned-off-by: Andy Lo <andy@mistral.ai>\n\n* [Misc] Remove experimental dep from tracing.py ( vllm-project#12007 )\n\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\n\n* [Misc] Set default backend to SDPA for get_vit_attn_backend ( vllm-project#12235 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Core] Free CPU pinned memory on environment cleanup ( vllm-project#10477 )\n\n* Update pre-commit.yml ( #374 )\n\n* Update pre-commit.yml\n\n* Reapplying missing format\n\n* New codespell exclude location\n\n---------\n\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\n\n* [bugfix] moe tuning. rm is_navi() ( vllm-project#12273 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [BUGFIX] When skip_tokenize_init and multistep are set, execution crashes ( vllm-project#12277 )\n\nSigned-off-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Documentation][AMD] Add information about prebuilt ROCm vLLM docker for perf validation purpose ( vllm-project#12281 )\n\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\n\n* [VLM] Simplify post-processing of replacement info ( vllm-project#12269 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ci/lint] Add back default arg for pre-commit ( vllm-project#12279 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [CI] add docker volume prune to neuron CI ( vllm-project#12291 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Ci/Build] Fix mypy errors on main ( vllm-project#12296 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Benchmark] More accurate TPOT calc in `benchmark_serving.py` ( vllm-project#12288 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [core] separate builder init and builder prepare for each batch ( vllm-project#12253 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Build] update requirements of no-device ( vllm-project#12299 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Core] Support fully transparent sleep mode ( vllm-project#11743 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Avoid unnecessary tokenization ( vllm-project#12310 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model][Bugfix]: correct Aria model output ( vllm-project#12309 )\n\nSigned-off-by: xffxff <1247714429@qq.com>\n\n* [Bugfix][VLM] Fix mixed-modality inference backward compatibility for V0 ( vllm-project#12313 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Add docs for prompt replacement ( vllm-project#12318 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Fix the error in the tip for the --lora-modules parameter ( vllm-project#12319 )\n\nSigned-off-by: wangerxiao <863579016@qq.com>\n\n* [Misc]  Improve the readability of BNB error messages  ( vllm-project#12320 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Skip tokenize/detokenize when it is disabled by arg --skip-tokenizer-init ( #367 )\n\n* switching detokenize flag to be False\n\n* detokenize = False for benchmarks\n\n* restoring default in main vllm code for detokenize\n\n* removing extra spaces\n\n* moving detokenize to flag\n\n* adding support for token ids\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* [Bugfix] Fix HPU multiprocessing executor ( vllm-project#12167 )\n\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\n\n* [Core] Support `reset_prefix_cache` ( vllm-project#12284 )\n\n* [Frontend][V1] Online serving performance improvements ( vllm-project#12287 )\n\n* [AMD][Quantization] Add TritonScaledMMLinearKernel since int8 is broken for AMD ( vllm-project#12282 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* FP8 FA fixes ( #381 )\n\n* FP8 FA fixes\n\nSummary:\nAdd missing clamp and fix reciprocal scale computation.\n\n* linter\n\n* Returning the use of the proper stream in allreduce ( #382 )\n\n* [Bugfix] Fixing  AMD LoRA CI test. ( vllm-project#12329 )\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* [Docs] Update FP8 KV Cache documentation ( vllm-project#12238 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Docs] Document vulnerability disclosure process ( vllm-project#12326 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1] Add `uncache_blocks` ( vllm-project#12333 )\n\n* [doc] explain common errors around torch.compile ( vllm-project#12340 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][BugFix] Fix dataclass error due to triton package update ( vllm-project#12338 )\n\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\n\n* [Bugfix] Fix k_proj's bias for whisper self attention ( vllm-project#12342 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Kernel] Flash Attention 3 Support ( vllm-project#12093 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Doc] Troubleshooting errors during model inspection ( vllm-project#12351 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Simplify M-RoPE ( vllm-project#12352 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: imkero <kerorek@outlook.com>\n\n* [Bugfix] Fix broken internvl2 inference with v1 ( vllm-project#12360 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [core] add wake_up doc and some sanity check ( vllm-project#12361 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [torch.compile] decouple compile sizes and cudagraph sizes ( vllm-project#12243 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [FP8][Kernel] Dynamic kv cache scaling factors computation ( vllm-project#11906 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\n\n* [TPU] Update TPU CI to use torchxla nightly on 20250122 ( vllm-project#12334 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Docs] Document Phi-4 support ( vllm-project#12362 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [BugFix] Fix parameter names and `process_after_weight_loading` for W4A16 MoE Group Act Order  ( vllm-project#11528 )\n\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [Misc] Fix OpenAI API Compatibility Issues in Benchmark Script ( vllm-project#12357 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Docs] Add meetup slides ( vllm-project#12345 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Using pytorch commit past the point when rowwise PR ( pytorch/pytorch#144432 ) was merged ( #384 )\n\n* Integrated ater: kvcache pa gemm rmsnorm\n\n* fix pa\n\n* fix\n\n* replace topk softmax\n\n* [Docs] Update spec decode + structured output in compat matrix ( vllm-project#12373 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* replace fp moe kernel with aiter kernel\n\n* [V1][Frontend] Coalesce bunched `RequestOutput`s ( vllm-project#12298 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\n\n* Set weights_only=True when using torch.load() ( vllm-project#12366 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Bugfix] Path join when building local path for S3 clone ( vllm-project#12353 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\n\n* change ater to aiter\n\n* Update compressed-tensors version ( vllm-project#12367 )\n\n* [V1] Increase default batch size for H100/H200 ( vllm-project#12369 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [perf] fix perf regression from vllm-project#12253 ( vllm-project#12380 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Use VisionArena Dataset for VLM Benchmarking ( vllm-project#12389 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci/build] fix wheel size check ( vllm-project#12396 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Hardware][Gaudi][Doc] Add missing step in setup instructions ( vllm-project#12382 )\n\n* [ci/build] sync default value for wheel size ( vllm-project#12398 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Enable proxy support in benchmark script ( vllm-project#12356 )\n\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\n\n* [Bugfix][Kernel] Fix CUDA 11.8 being broken by FA3 build ( vllm-project#12375 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Applying scales rename to fp8 config\n\n* Applying scales rename to fp8 config ( #387 )\n\n* Update Dockerfile.rocm\n\n* [Misc] Remove deprecated code ( vllm-project#12383 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Kernel] FA3 Fix - RuntimeError: This flash attention build only supports pack_gqa (for build size reasons). ( vllm-project#12405 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Using aiter moe kernel\n\n* Dev-docker Documentation Updates ( #378 )\n\n* Dev-docker Documentation Updates\n\nMinor updates to several sections, with links to other documents where appropriate.\n\n* Fix formatting of GEMM filename\n\n* README cleanup\n\n- Reorder some sections of the README to make them easier to follow\n- Improve formatting of bash commands\n- Prefer use of huggingface model names instead of hard-coded directories\n- Clean up wording\n\n* Expanded sample commands for Latency and Throughput\n\n* Fix markdown links\n\n* Fix pre-commit errors\n\n* Updates from review\n\nInitial updates to incorporate feedback from a review session held with @t-parry * Update script args to match current recommendations\n\n* Remove recommended max-num-seqs values for now\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* [Bugfix][Kernel] Fix moe align block issue for mixtral ( vllm-project#12413 )\n\n* [Bugfix] Fix BLIP-2 processing ( vllm-project#12412 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ROCm][MoE] MI300 tuned configs Mixtral-8x(7B,22B) | fp16, fp8 ( vllm-project#12408 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Add FA2 support to ViT MHA layer ( vllm-project#12355 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [TPU][CI] Update torchxla version in requirement-tpu.txt ( vllm-project#12422 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\n\n* [Misc][Bugfix] FA3 support to ViT MHA layer ( vllm-project#12435 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Perf] Reduce scheduling overhead in model runner after cuda sync ( vllm-project#12094 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [V1][Bugfix] Fix assertion when mm hashing is turned off ( vllm-project#12439 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* fix pa copy\n\n* pa update\n\n* [Misc] Revert FA on ViT vllm-project#12355 and vllm-project#12435 ( vllm-project#12445 )\n\n* [Frontend] generation_config.json for  maximum tokens( vllm-project#12242 )\n\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] Disable w16a16 2of4 sparse CompressedTensors24 ( vllm-project#12417 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* add fp16 pa support for aiter\n\n* [Bugfix/CI] Fix broken kernels/test_mha.py ( vllm-project#12450 )\n\n* [Bugfix][Kernel] Fix perf regression caused by PR vllm-project#12405 ( vllm-project#12434 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Build/CI] Fix libcuda.so linkage ( vllm-project#12424 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Frontend] Rerank API (Jina- and Cohere-compatible API)  ( vllm-project#12376 )\n\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\n\n* [DOC] Add link to vLLM blog ( vllm-project#12460 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [V1] Avoid list creation in input preparation ( vllm-project#12457 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Frontend] Support scores endpoint in run_batch ( vllm-project#12430 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix Granite 3.0 MoE model loading ( vllm-project#12446 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix missing seq_start_loc in xformers prefill metadata ( vllm-project#12464 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][Minor] Minor optimizations for update_from_output ( vllm-project#12454 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix gpt2 GGUF inference ( vllm-project#12467 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* aiter build instructions\n\n* [Build] Only build 9.0a for scaled_mm and sparse kernels ( vllm-project#12339 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* Copy to the right path\n\n* [V1][Metrics] Add initial Prometheus logger ( vllm-project#12416 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][CI/Test] Do basic test for top-p & top-k sampling ( vllm-project#12469 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [FlashInfer] Upgrade to 0.2.0 ( vllm-project#11194 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* Support FP8 FA from Quark format ( #388 )\n\n* Support FP8 FA from Quark format\n\n* Support FP8 FA from Quark format\n\n* nit: update comment\n\n* Direct call on ROCm\n\n* 20250127 docs update ( #392 )\n\n* updating code blocks\n\n* typo\n\n* updated manifest\n\n* Including feedback\n\n* whitespace\n\n* Deepseek instructions\n\n* hyperlink fix\n\n* hyperlink fix\n\n* updating what is new\n\n* cpx update\n\n* typo\n\n* whitespace\n\n* whitespace\n\n* Add env var toggles to disable AITER MoE or PA (both by default on)\n\n* Update accuracy benchmark for batch size > 1\n\n* Add a few more AITER toggles for norm and linear layers\n\n* Faster Custom Paged Attention kernels ( #372 )\n\n* integrate new cpa kernel, update tests and benchmark\n\n* added comments to mfma4 kernel\n\n* further comments for mfma16 kernel\n\n* clang-format\n\n* Lint\n\n* add flag for logits rtz conversion and disable by default\n\n* lint\n\n* [Bugfix]: Fix paged attention unit tests of #372 ( #389 )\n\n* [Bugfix]: fix paged attention tests based on the updated kernels in `csrc/attention/paged_attention_v1.cu`,`csrc/attention/paged_attention_v2.cu` and  `csrc/rocm/attention.cu`.\n\n* improve code documentation.\n\n* lint\n\n---------\n\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: TJian <tunjian1996@gmail.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Using a more precise profiling on ROCm to properly account for weights padding ( #394 )\n\n* Public aiter repo\n\n* Fail if aiter build failed silently\n\n* Aiter can only be built on MI300x\n\n* Typo fix\n\n* Aiter PA off by default\n\n* Changes to support updated aiter FP8 PA\n\n* Support FP8 and INT8 KV cache according to ROCm/aiter#90 * add moe weight shuffle for dynamic quant and unquantized path\n\nSigned-off-by: charlifu <charlifu@amd.com>\n\n* Use FP16-native PA after support in ROCm/aiter#97 * Fix: Use FP8 pertoken quantize if KV cache dtype is FP8\n\n* revert rocm_flash_attn.py line 883\n\n* Don't enable by default to use an RC for main vllm-dev docker\n\n* use ck moe for bf16 and fp16 fused_moe\n\n* Merge remote-tracking branch 'origin/aiter_intergration_final' into merge-aiter-llama-fp8\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Bugfix] include moe shuffle env variable\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: tjtanaa <tunjian.tan@embeddedllm.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nSigned-off-by: Konrad Zawora <kzawora@habana.ai>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: kewang-xlnx <kewang@xilinx.com>\nSigned-off-by: kewang2 <kewang2@amd.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: hongxyan <hongxyan@amd.com>\nSigned-off-by: Michal Adamczyk <madamczyk@habana.ai>\nSigned-off-by: zibai <zibai.gj@alibaba-inc.com>\nSigned-off-by: Martin Gleize <mgleize@meta.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: isikhi <huseyin.isik000@gmail.com>\nSigned-off-by: Jason Cheng <jasoncky96@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nSigned-off-by: rickyx <rickyx@anyscale.com>\nSigned-off-by: Andy Lo <andy@mistral.ai>\nSigned-off-by: Adrian Cole <adrian.cole@elastic.co>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: Hongxia Yang <hongxyan@amd.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xffxff <1247714429@qq.com>\nSigned-off-by: wangerxiao <863579016@qq.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: zhenwei <zhenweiliu@habana.ai>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: ElizaWszola <eliza@neuralmagic.com>\nSigned-off-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Kyle Mistele <kyle@mistele.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: charlifu <charlifu@amd.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: maang-h <55082429+maang-h@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Konrad Zawora <kzawora@habana.ai>\nCo-authored-by: Elfie Guo <164945471+elfiegg@users.noreply.github.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: RunningLeon <maningsheng@sensetime.com>\nCo-authored-by: kewang-xlnx <73578509+kewang-xlnx@users.noreply.github.com>\nCo-authored-by: kewang2 <kewang2@amd.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: tvirolai-amd <teemu.virolainen@amd.com>\nCo-authored-by: Michael Goin <mgoin@redhat.com>\nCo-authored-by: Zhaoyi Li <36555117+Lzy17@users.noreply.github.com>\nCo-authored-by: charlifu <charlifu@amd.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: yancong <32220263+ice-tong@users.noreply.github.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: gujing <925973396@qq.com>\nCo-authored-by: imkero <kerorek@outlook.com>\nCo-authored-by: Martin Gleize <mgleize@meta.com>\nCo-authored-by: mgleize user <mgleize@a100-st-p4de24xlarge-4.fair-a100.hpcaas>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: IÅŸÄ±k <41375111+isikhi@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cheng Kuan Yong Jason <jasoncky96@gmail.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Jannis SchÃ¶nleber <joennlae@gmail.com>\nCo-authored-by: Ricky Xu <xuchen727@hotmail.com>\nCo-authored-by: Andy Lo <andylolu24@gmail.com>\nCo-authored-by: Adrian Cole <64215+codefromthecrypt@users.noreply.github.com>\nCo-authored-by: Jani Monoses <jani.monoses@gmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: maleksan85 <maleksan@amd.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: zhou fan <1247714429@qq.com>\nCo-authored-by: ilia-cher <30845429+ilia-cher@users.noreply.github.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: liuzhenwei <zhenweiliu@habana.ai>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Micah Williamson <micah.williamson@amd.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: ElizaWszola <eliza@neuralmagic.com>\nCo-authored-by: Junichi Sato <junichi.sato@sbintuitions.co.jp>\nCo-authored-by: amd-ruitang3 <Rui.Tang2@amd.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic.com>\nCo-authored-by: omer-dayan <omer@run.ai>\nCo-authored-by: Mohit Deopujari <mdeopujari@habana.ai>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: chenjun <junchen2@amd.com>\nCo-authored-by: ValarLip <340077269@qq.com>\nCo-authored-by: Matthew Hendrey <matthew.hendrey@gmail.com>\nCo-authored-by: Kyle Mistele <kyle@mistele.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Bowen Bao <bowenbao@amd.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Matthew Wong <Matthew.Wong2@amd.com>\nCo-authored-by: sanyalington <shomy.sanyal@amd.com>\nCo-authored-by: Joe Shajrawi <17753158+shajrawi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: charlifu <chalifu@amd.com> mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [CI/Build] Make pre-commit faster ( vllm-project#12212 ) â€¦ 5659268 Signed-off-by: DarkLight1337 <tlleungac@connect.ust.hk> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:09", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: Throughput, Throughput, Throughput | SERVING: serving, serving, serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:09", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[CI/Build] Make pre-commit faster (#12212)", "commit_message": "[CI/Build] Make pre-commit faster (#12212)\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>", "commit_date": "2025-01-20T17:36:24+08:00", "files_changed": [".github/workflows/pre-commit.yml", ".pre-commit-config.yaml"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 3, "num_edited_lines": 18, "num_non_test_edited_lines": 18, "commit_year": 2025}, "diff_text": "diff --git a/.github/workflows/pre-commit.yml b/.github/workflows/pre-commit.yml\nindex 8c72a709c..bf9460151 100644\n--- a/.github/workflows/pre-commit.yml\n+++ b/.github/workflows/pre-commit.yml\n@@ -15,3 +15,5 @@ jobs:\n         python-version: \"3.12\"\n     - run: echo \"::add-matcher::.github/workflows/matchers/actionlint.json\"\n     - uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd # v3.0.1\n+      with:\n+        extra_args: --hook-stage manual\ndiff --git a/.pre-commit-config.yaml b/.pre-commit-config.yaml\nindex 8ea0f3788..47eddb345 100644\n--- a/.pre-commit-config.yaml\n+++ b/.pre-commit-config.yaml\n@@ -1,3 +1,6 @@\n+default_stages:\n+  - pre-commit # Run locally\n+  - manual # Run in CI\n repos:\n - repo: https://github.com/google/yapf\n   rev: v0.32.0\n@@ -33,30 +36,41 @@ repos:\n     files: docs/.*\n - repo: local\n   hooks:\n+  - id: mypy-local\n+    name: Run mypy for local Python installation\n+    entry: tools/mypy.sh\n+    language: python\n+    types: [python]\n+    additional_dependencies: &mypy_deps [mypy==1.11.1, types-setuptools, types-PyYAML, types-requests]\n+    stages: [pre-commit] # Don't run in CI\n   - id: mypy-3.9 # TODO: Use https://github.com/pre-commit/mirrors-mypy when mypy setup is less awkward\n     name: Run mypy for Python 3.9\n     entry: tools/mypy.sh 1 \"3.9\"\n     language: python\n     types: [python]\n-    additional_dependencies: &mypy_deps [mypy==1.11.1, types-setuptools, types-PyYAML, types-requests]\n+    additional_dependencies: *mypy_deps\n+    stages: [manual] # Only run in CI\n   - id: mypy-3.10 # TODO: Use https://github.com/pre-commit/mirrors-mypy when mypy setup is less awkward\n     name: Run mypy for Python 3.10\n     entry: tools/mypy.sh 1 \"3.10\"\n     language: python\n     types: [python]\n     additional_dependencies: *mypy_deps\n+    stages: [manual] # Only run in CI\n   - id: mypy-3.11 # TODO: Use https://github.com/pre-commit/mirrors-mypy when mypy setup is less awkward\n     name: Run mypy for Python 3.11\n     entry: tools/mypy.sh 1 \"3.11\"\n     language: python\n     types: [python]\n     additional_dependencies: *mypy_deps\n+    stages: [manual] # Only run in CI\n   - id: mypy-3.12 # TODO: Use https://github.com/pre-commit/mirrors-mypy when mypy setup is less awkward\n     name: Run mypy for Python 3.12\n     entry: tools/mypy.sh 1 \"3.12\"\n     language: python\n     types: [python]\n     additional_dependencies: *mypy_deps\n+    stages: [manual] # Only run in CI\n   - id: shellcheck\n     name: Lint shell scripts\n     entry: tools/shellcheck.sh", "apis": ["None"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/online_serving/openai_chat_completion_client.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/api_server.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit updates CI and pre-commit configuration files to adjust hook stages (e.g., adding \"--hook-stage manual\" and specifying 'manual' for mypy hooks) with an intention to reduce the pre-commit runtime. Although it doesn't modify production source code APIs, it targets the performance of the CI/pre-commit pipeline by optimizing when and how these checks are run. These configurations are non-test files and the changes are non-trivial in optimizing CI performance. Therefore, this commit qualifies as performance/optimization related based on the intended speed improvements in the pre-commit process.", "llm_api_reason": "This commit only updates pre-commit configuration files (CI workflows and pre-commit hooks setup) to improve build speed and tweak hook stages. No Python APIs in the repository code are affected."}
{"commit_hash": "310aca88c984983189a57f1b72e3b1dde89fb92f", "pr_url": "https://github.com/vllm-project/vllm/pull/11870", "pr_date": "2025-01-09", "timeline_text": "Copy link Member youkaichao commented Jan 9, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . fix the performance regression reported from #11744 (comment) on my local benchmark: python benchmarks/benchmark_latency.py --model meta-llama/Meta-Llama-3-70B --load-format dummy --enforce-eager -tp 4 main branch: Avg latency: 2.945735554069203 seconds\n10% percentile latency: 2.924619035271462 seconds\n25% percentile latency: 2.937671729727299 seconds\n50% percentile latency: 2.9460502695292234 seconds\n75% percentile latency: 2.955668824230088 seconds\n90% percentile latency: 2.9639973257959356 seconds\n99% percentile latency: 2.979829666109872 seconds this PR: Avg latency: 2.851606635436959 seconds\n10% percentile latency: 2.8231707043829375 seconds\n25% percentile latency: 2.834942308269092 seconds\n50% percentile latency: 2.85484445450129 seconds\n75% percentile latency: 2.8674310567148495 seconds\n90% percentile latency: 2.872856835933635 seconds\n99% percentile latency: 2.875793117735884 seconds it can have 3% perf diff. Hopefully this can fix the perf regression observed in the benchmark: Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions youkaichao added 2 commits January 9, 2025 09:42 fix stream â€¦ f5b7d78 Signed-off-by: youkaichao <youkaichao@gmail.com> fix code â€¦ e16f595 Signed-off-by: youkaichao <youkaichao@gmail.com> youkaichao requested a review\n  from tlrmchlsmth January 9, 2025 02:00 Copy link github-actions bot commented Jan 9, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author youkaichao commented Jan 9, 2025 I find measuring the pure forward time makes more sense, it will not be affected by the scheduling, etc: VLLM_LOG_BATCHSIZE_INTERVAL=1 python benchmarks/benchmark_latency.py --model meta-llama/Meta-Llama-3-70B --load-format dummy --enforce-eager -tp 4 main branch: Batchsize forward time stats (batchsize, count, median_time(ms)): [(8, 4998, 20.77), (256, 40, 28.99)] this PR: Batchsize forward time stats (batchsize, count, median_time(ms)): [(8, 5027, 20.45), (256, 40, 28.95)] The forward time for every step (batchsize 8) reduces from 20.77ms to 20.45ms. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth reviewed Jan 9, 2025 View reviewed changes vllm/utils.py Comment on lines +959 to +970 prev_set_stream = torch.cuda.set_stream _current_stream = None def _patched_set_stream(stream: torch.cuda.Stream) -> None: global _current_stream _current_stream = stream prev_set_stream(stream) torch.cuda.set_stream = _patched_set_stream Copy link Collaborator tlrmchlsmth Jan 9, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It looks like we're not using set_stream anywhere in the vllm codebase. Could you add a unit test for this to make sure it's exercised? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator tlrmchlsmth Jan 9, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment here we patch torch.cuda.set_stream to keep track of the current stream directly, so that we can avoid calling torch.cuda.current_stream() . I might be confused about how utils.current_stream() works though Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author youkaichao Jan 9, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment torch.cuda.graph will call it internally to switch streams. so any test cases with cudagraph + nccl will test the PR's code. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 tlrmchlsmth reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction tlrmchlsmth approved these changes Jan 9, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the fix! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions youkaichao enabled auto-merge (squash) January 9, 2025 03:40 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jan 9, 2025 Hide details View details youkaichao merged commit 310aca8 into vllm-project : main Jan 9, 2025 71 of 73 checks passed Uh oh! There was an error while loading. Please reload this page . youkaichao deleted the fix_current_stream branch January 9, 2025 07:37 gshtras added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Jan 14, 2025 Merge pull request #358 from ROCm/upstream_merge_25_01_13 â€¦ 5976f48 * [Bugfix][V1] Fix molmo text-only inputs ( vllm-project#11676 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Move attn_type to Attention.__init__() ( vllm-project#11690 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [V1] Extend beyond image modality and support mixed-modality inference with Llava-OneVision ( vllm-project#11685 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix LLaVA-NeXT feature size precision error (for real) ( vllm-project#11772 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Future-proof Qwen2-Audio multi-modal processor ( vllm-project#11776 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [XPU] Make pp group initilized for pipeline-parallelism ( vllm-project#11648 )\n\nSigned-off-by: yisheng <yi.sheng@intel.com>\n\n* [Doc][3/N] Reorganize Serving section ( vllm-project#11766 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel][LoRA]Punica prefill  kernels fusion ( vllm-project#11234 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\n\n* [Bugfix] Update attention interface in `Whisper` ( vllm-project#11784 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI] Fix neuron CI and run offline tests ( vllm-project#11779 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* fix init error for MessageQueue when n_local_reader is zero ( vllm-project#11768 )\n\n* [Doc] Create a vulnerability management team ( vllm-project#9925 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [CI][CPU] adding build number to docker image name ( vllm-project#11788 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [V1][Doc] Update V1 support for `LLaVa-NeXT-Video` ( vllm-project#11798 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Comprehensively test and fix LLaVA-NeXT feature size calculation ( vllm-project#11800 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] add doc to explain how to use uv ( vllm-project#11773 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] Support audio language models on V1 ( vllm-project#11733 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] update how pip can install nightly wheels ( vllm-project#11806 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Add note to `gte-Qwen2` models ( vllm-project#11808 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [optimization] remove python function call for custom op ( vllm-project#11750 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] update the prefix for qwen2 ( vllm-project#11795 )\n\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\n\n* [Doc]Add documentation for using EAGLE in vLLM ( vllm-project#11417 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\n\n* [Bugfix] Significant performance drop on CPUs with --num-scheduler-steps > 1 ( vllm-project#11794 )\n\n* [Doc] Group examples into categories ( vllm-project#11782 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix image input for Pixtral-HF ( vllm-project#11741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] sort torch profiler table by kernel timing ( vllm-project#11813 )\n\n* Remove the duplicate imports of MultiModalKwargs and PlaceholderRangeâ€¦ ( vllm-project#11824 )\n\n* Fixed docker build for ppc64le ( vllm-project#11518 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* [OpenVINO] Fixed Docker.openvino build ( vllm-project#11732 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [Bugfix] Add checks for LoRA and CPU offload ( vllm-project#11810 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Docs] reorganize sponsorship page ( vllm-project#11639 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [Bug] Fix pickling of `ModelConfig` when RunAI Model Streamer is used ( vllm-project#11825 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] improve memory profiling ( vllm-project#11809 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [doc] update wheels url ( vllm-project#11830 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Update sponsor name: 'Novita' to 'Novita AI' ( vllm-project#11833 )\n\n* [Hardware][Apple] Native support for macOS Apple Silicon ( vllm-project#11696 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [torch.compile] consider relevant code in compilation cache ( vllm-project#11614 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Reorganize profiling/processing-related code ( vllm-project#11812 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples into categories ( vllm-project#11840 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc][4/N] Reorganize API Reference ( vllm-project#11843 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build][Bugfix] Fix CPU CI image clean up ( vllm-project#11836 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Bugfix][XPU] fix silu_and_mul ( vllm-project#11823 )\n\nSigned-off-by: yan ma <yan.ma@intel.com>\n\n* [Misc] Move some model utils into vision file ( vllm-project#11848 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Expand Multimodal API Reference ( vllm-project#11852 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]add some explanations for BlockHashType ( vllm-project#11847 )\n\n* [TPU][Quantization] TPU `W8A8` ( vllm-project#11785 )\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models ( vllm-project#11698 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* [Docs] Add Google Cloud Meetup ( vllm-project#11864 )\n\n* [CI] Turn on basic correctness tests for V1 ( vllm-project#10864 )\n\n* treat do_lower_case in the same way as the sentence-transformers library ( vllm-project#11815 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\n\n* [Doc] Recommend uv and python 3.12 for quickstart guide ( vllm-project#11849 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc] Move `print_*_once` from utils to logger ( vllm-project#11298 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\n\n* [Doc] Intended links Python multiprocessing library ( vllm-project#11878 )\n\n* [perf]fix current stream ( vllm-project#11870 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Override dunder methods of placeholder modules ( vllm-project#11882 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] fix beam search input errors and latency benchmark script ( vllm-project#11875 )\n\nSigned-off-by: Ye Qi <yeq@meta.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\n\n* [Doc] Add model development API Reference ( vllm-project#11884 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] Allow platform specify attention backend ( vllm-project#11609 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci]try to fix flaky multi-step tests ( vllm-project#11894 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Provide correct Pixtral-HF chat template ( vllm-project#11891 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Docs] Add Modal to deployment frameworks ( vllm-project#11907 )\n\n* [Doc][5/N] Move Community and API Reference to the bottom ( vllm-project#11896 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [VLM] Enable tokenized inputs for merged multi-modal processor ( vllm-project#11900 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Show default pooling method in a table ( vllm-project#11904 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] Hide KV cache behind torch.compile boundary ( vllm-project#11677 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Validate lora adapters to avoid crashing server ( vllm-project#11727 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [BUGFIX] Fix `UnspecifiedPlatform` package name ( vllm-project#11916 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [ci] fix gh200 tests ( vllm-project#11919 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] remove python function call for custom activation op ( vllm-project#11885 )\n\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [platform] support pytorch custom op pluggable ( vllm-project#11328 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* Replace \"online inference\" with \"online serving\" ( vllm-project#11923 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [ci] Fix sampler tests ( vllm-project#11922 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] [1/N] Initial guide for merged multi-modal processor ( vllm-project#11925 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] support custom torch.compile backend key ( vllm-project#11318 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Rename offline inference examples ( vllm-project#11927 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Fix docstring in `get_ip` function ( vllm-project#11932 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* Doc fix in `benchmark_long_document_qa_throughput.py` ( vllm-project#11933 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [Hardware][CPU] Support MOE models on x86 CPU ( vllm-project#11831 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Misc] Clean up debug code in Deepseek-V3 ( vllm-project#11930 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Update benchmark_prefix_caching.py fixed example usage ( vllm-project#11920 )\n\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\n\n* [Bugfix] Check that number of images matches number of <|image|> tokens with mllama ( vllm-project#11939 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\n\n* [mypy] Fix mypy warnings in api_server.py ( vllm-project#11941 )\n\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\n\n* [ci] fix broken distributed-tests-4-gpus ( vllm-project#11937 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][SpecDecode] Adjust Eagle model architecture to align with intended design ( vllm-project#11672 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Bugfix] fused_experts_impl wrong compute type for float32 ( vllm-project#11921 )\n\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\n\n* [CI/Build] Move model-specific multi-modal processing tests ( vllm-project#11934 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Basic guide for writing unit tests for new models ( vllm-project#11951 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix RobertaModel loading ( vllm-project#11940 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Model] Add cogagent model support vLLM ( vllm-project#11742 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* Using list\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Trying to make scales work with compileable attention\n\n* Docs lint\n\n---------\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com> hongxiayang pushed a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Jan 15, 2025 [MFM-20250115] Merge from ROCm/main to llama_fp8 ( #360 ) â€¦ d9385b4 * [Misc] Move weights mapper ( vllm-project#11443 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile. Fixes vllm-project#9182 ( vllm-project#11435 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Automatic conversion of classification and reward models ( vllm-project#11469 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Unify VLLM_ENABLE_V1_MULTIPROCESSING handling in RayExecutor ( vllm-project#11472 )\n\n* [Misc] Update disaggregation benchmark scripts and test logs ( vllm-project#11456 )\n\nSigned-off-by: Jiaxin Shan <seedjeffwan@gmail.com>\n\n* [Frontend] Enable decord to load video from base64 ( vllm-project#11492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Improve GitHub links ( vllm-project#11491 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Move some multimodal utils to modality-specific modules ( vllm-project#11494 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Mypy checking for vllm/compilation ( vllm-project#11496 )\n\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\n\n* [Misc][LoRA] Fix LoRA weight mapper ( vllm-project#11495 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Doc] Add `QVQ` and `QwQ` to the list of supported models ( vllm-project#11509 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1] Adding min tokens/repetition/presence/frequence penalties to V1 sampler ( vllm-project#10681 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Model]  Modify MolmoForCausalLM MLP  ( vllm-project#11510 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Add placeholder module ( vllm-project#11501 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Add video example to openai client for multimodal ( vllm-project#11521 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [1/N] API Server  (Remove Proxy) ( vllm-project#11529 )\n\n* [Model] [Quantization] Support deepseek_v3 w8a8 fp8 block-wise quantization ( vllm-project#11523 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: HandH1998 <1335248067@qq.com>\n\n* [2/N] API Server: Avoid ulimit footgun ( vllm-project#11530 )\n\n* Deepseek v3 ( vllm-project#11502 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: robertgshaw2-neuralmagic <rshaw@neuralmagic.com>\n\n* [Docs] Document Deepseek V3 support ( vllm-project#11535 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* Update openai_compatible_server.md ( vllm-project#11536 )\n\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [V1] Use FlashInfer Sampling Kernel for Top-P & Top-K Sampling ( vllm-project#11394 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Fix yapf ( vllm-project#11538 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [CI] Fix broken CI ( vllm-project#11543 )\n\n* [misc] fix typing ( vllm-project#11540 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][3/N] API Server: Reduce Task Switching + Handle Abort Properly ( vllm-project#11534 )\n\n* [BugFix] Fix quantization for all other methods ( vllm-project#11547 )\n\n* [Platform] Move model arch check to platform ( vllm-project#11503 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* Update deploying_with_k8s.md with AMD ROCm GPU example ( vllm-project#11465 )\n\nSigned-off-by: Alex He <alehe@amd.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix] Fix TeleChat2ForCausalLM weights mapper ( vllm-project#11546 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Abstract the logic for reading and writing media content ( vllm-project#11527 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc]  Add xgrammar in doc ( vllm-project#11549 )\n\nSigned-off-by: ccjincong <chenjincong11@gmail.com>\n\n* [VLM] Support caching in merged multi-modal processor ( vllm-project#11396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MODEL] LoRA support for Jamba model ( vllm-project#11209 )\n\nSigned-off-by: Erez Schwartz <erezs@ai21.com>\n\n* [Misc]Add BNB quantization for MolmoForCausalLM  ( vllm-project#11551 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Improve BNB loader to handle mixture of sharded and merged weights with same suffix ( vllm-project#11566 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Bugfix] Fix for ROCM compressed tensor support ( vllm-project#11561 )\n\n* [Doc] Update mllama example based on official doc ( vllm-project#11567 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [V1] [4/N] API Server: ZMQ/MP Utilities ( vllm-project#11541 )\n\n* [Bugfix] Last token measurement fix ( vllm-project#11376 )\n\nSigned-off-by: rajveerb <46040700+rajveerb@users.noreply.github.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Model] Support InternLM2 Reward models ( vllm-project#11571 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Model] Remove hardcoded image tokens ids from Pixtral ( vllm-project#11582 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Hardware][AMD]: Replace HIPCC version with more precise ROCm version ( vllm-project#11515 )\n\nSigned-off-by: hjwei <hjwei_xd@163.com>\n\n* [V1][Minor] Set pin_memory=False for token_ids_cpu tensor ( vllm-project#11581 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Doc] Minor documentation fixes ( vllm-project#11580 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [bugfix] interleaving sliding window for cohere2 model ( vllm-project#11583 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] [5/N] API Server: unify `Detokenizer` and  `EngineCore` input ( vllm-project#11545 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Doc] Convert list tables to MyST ( vllm-project#11594 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [v1][bugfix] fix cudagraph with inplace buffer assignment ( vllm-project#11596 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] KV cache transfer connector registry ( vllm-project#11481 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Remove print statement in DeepseekScalingRotaryEmbedding ( vllm-project#11604 )\n\n* [v1] fix compilation cache ( vllm-project#11598 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docker] bump up neuron sdk v2.21 ( vllm-project#11593 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Build][Kernel] Update CUTLASS to v3.6.0 ( vllm-project#11607 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build][CPU] Fix CPU CI by lazy importing triton FP8 kernels ( vllm-project#11618 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [platforms] enable platform plugins ( vllm-project#11602 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Abstract out multi-modal data parsing in merged processor ( vllm-project#11620 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] [6/N] API Server: Better Shutdown ( vllm-project#11586 )\n\n* [Bugfix] Validate and concatenate image embeddings in MiniCPMVBaseModel ( vllm-project#11631 )\n\n* [benchmark] Remove dependency for H100 benchmark step ( vllm-project#11572 )\n\n* [Model][LoRA]LoRA support added for MolmoForCausalLM ( vllm-project#11439 )\n\nSigned-off-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Fix OpenAI parallel sampling when using xgrammar ( vllm-project#11637 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc][LoRA] Support Rank Stabilized LoRA (RSLoRA) ( vllm-project#6909 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Move the _touch(computed_blocks) call in the allocate_slots method to after the check for allocating new blocks. ( vllm-project#11565 )\n\n* [V1] Simpify vision block hash for prefix caching by removing offset from hash ( vllm-project#11646 )\n\n* [V1][VLM] V1 support for selected single-image models. ( vllm-project#11632 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Benchmark] Add benchmark script for CPU offloading  ( vllm-project#11533 )\n\nSigned-off-by: ApostaC <yihua98@uchicago.edu>\nCo-authored-by: KuntaiDu <kuntai@uchicago.edu>\n\n* [Bugfix][Refactor] Unify model management in frontend ( vllm-project#11660 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [VLM] Add max-count checking in data parser for single image models ( vllm-project#11661 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Optimize Qwen2-VL LoRA test ( vllm-project#11663 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Replace space with - in the file names ( vllm-project#11667 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Fix typo ( vllm-project#11666 )\n\nSigned-off-by: Kazuhiro Serizawa <nserihiro@gmail.com>\n\n* [V1] Implement Cascade Attention ( vllm-project#11635 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [VLM] Move supported limits and max tokens to merged multi-modal processor ( vllm-project#11669 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [VLM][Bugfix] Multi-modal processor compatible with V1 multi-input ( vllm-project#11674 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [mypy] Pass type checking in vllm/inputs ( vllm-project#11680 )\n\nSigned-off-by: Tobias Pitters <tobias.pitters@gmail.com>\n\n* [VLM] Merged multi-modal processor for LLaVA-NeXT ( vllm-project#11682 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* According to vllm.EngineArgs, the name should be distributed_executor_backend ( vllm-project#11689 )\n\n* [Bugfix] Free cross attention block table for preempted-for-recompute sequence group. ( vllm-project#10013 )\n\nSigned-off-by: Kathy Yu <feiyangyu@google.com>\n\n* [V1][Minor] Optimize token_ids_cpu copy ( vllm-project#11692 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Change kv scaling factor by param json on nvidia gpu ( vllm-project#11688 )\n\nSigned-off-by: bjmsong <bjmsong@126.com>\nCo-authored-by: bjmsong <bjmsong@126.com>\n\n* Resolve race conditions in Marlin kernel ( vllm-project#11493 )\n\nSigned-off-by: wchen61 <wchen61@foxmail.com>\n\n* [Misc] Minimum requirements for SageMaker compatibility ( vllm-project#11576 )\n\n* Update default max_num_batch_tokens for chunked prefill ( vllm-project#11694 )\n\n* [Bugfix] Check chain_speculative_sampling before calling it ( vllm-project#11673 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [perf-benchmark] Fix dependency for steps in benchmark pipeline ( vllm-project#11710 )\n\n* [Model] Whisper model implementation ( vllm-project#11280 )\n\nCo-authored-by: Aurick Qiao <aurick.qiao@snowflake.com>\n\n* [V1] Simplify Shutdown ( vllm-project#11659 )\n\n* [Bugfix] Fix ColumnParallelLinearWithLoRA slice ( vllm-project#11708 )\n\nSigned-off-by: ZincCat <zincchloride@outlook.com>\n\n* [V1] Improve TP>1 Error Handling + Stack Trace ( vllm-project#11721 )\n\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Misc]Add BNB quantization for Qwen2VL ( vllm-project#11719 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* Update requirements-tpu.txt to support python 3.9 and 3.11 ( vllm-project#11695 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [V1] Chore: cruft removal ( vllm-project#11724 )\n\n* [V1] log GPU blocks num for MultiprocExecutor ( vllm-project#11656 )\n\n* Update tool_calling.md ( vllm-project#11701 )\n\n* Update bnb.md with example for OpenAI ( vllm-project#11718 )\n\n* [V1] Add `RayExecutor` support for `AsyncLLM` (api server) ( vllm-project#11712 )\n\n* [V1] Add kv cache utils tests. ( vllm-project#11513 )\n\nSigned-off-by: xcnick <xcnick0412@gmail.com>\n\n* [Core][Bugfix] Use correct device to initialize GPU data during CUDA-graph-capture ( vllm-project#11233 )\n\nSigned-off-by: Yan Burman <yanburman@users.noreply.github.com>\nSigned-off-by: Ido Asraff <idoa@atero.ai>\n\n* [VLM] Merged multi-modal processors for LLaVA-NeXT-Video and LLaVA-OneVision ( vllm-project#11717 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix precision error in LLaVA-NeXT ( vllm-project#11735 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Remove unnecessary weight initialization logic ( vllm-project#11736 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Bugfix][V1] Fix test_kv_cache_utils.py ( vllm-project#11738 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [MISC] Replace c10::optional with std::optional ( vllm-project#11730 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [distributed] remove pynccl's redundant stream ( vllm-project#11744 )\n\n* fix: [doc] fix typo ( vllm-project#11751 )\n\nCo-authored-by: Lancer <maruixiang6688@gmail.com>\n\n* [Frontend] Improve `StreamingResponse` Exception Handling ( vllm-project#11752 )\n\n* [distributed] remove pynccl's redundant change_state ( vllm-project#11749 )\n\n* [Doc] [1/N] Reorganize Getting Started section ( vllm-project#11645 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Remove block size constraint ( vllm-project#11723 )\n\n* [V1] Add BlockTable class ( vllm-project#11693 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Fix typo for valid_tool_parses  ( vllm-project#11753 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [V1] Refactor get_executor_cls ( vllm-project#11754 )\n\n* [mypy] Forward pass function type hints in lora ( vllm-project#11740 )\n\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\n\n* k8s-config: Update the secret to use stringData ( vllm-project#11679 )\n\nSigned-off-by: Suraj Deshmukh <surajd.service@gmail.com>\n\n* [VLM] Separate out profiling-related logic ( vllm-project#11746 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc][2/N] Reorganize Models and Usage sections ( vllm-project#11755 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix max image size for LLaVA-Onevision ( vllm-project#11769 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] explain how to add interleaving sliding window support ( vllm-project#11771 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][V1] Fix molmo text-only inputs ( vllm-project#11676 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Move attn_type to Attention.__init__() ( vllm-project#11690 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* format\n\n* [V1] Extend beyond image modality and support mixed-modality inference with Llava-OneVision ( vllm-project#11685 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* deepseek overflow fix ( #349 )\n\n* [Bugfix] Fix LLaVA-NeXT feature size precision error (for real) ( vllm-project#11772 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Future-proof Qwen2-Audio multi-modal processor ( vllm-project#11776 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [XPU] Make pp group initilized for pipeline-parallelism ( vllm-project#11648 )\n\nSigned-off-by: yisheng <yi.sheng@intel.com>\n\n* [Doc][3/N] Reorganize Serving section ( vllm-project#11766 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel][LoRA]Punica prefill  kernels fusion ( vllm-project#11234 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\n\n* [Bugfix] Update attention interface in `Whisper` ( vllm-project#11784 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI] Fix neuron CI and run offline tests ( vllm-project#11779 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* fix init error for MessageQueue when n_local_reader is zero ( vllm-project#11768 )\n\n* [Doc] Create a vulnerability management team ( vllm-project#9925 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [CI][CPU] adding build number to docker image name ( vllm-project#11788 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [V1][Doc] Update V1 support for `LLaVa-NeXT-Video` ( vllm-project#11798 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Comprehensively test and fix LLaVA-NeXT feature size calculation ( vllm-project#11800 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] add doc to explain how to use uv ( vllm-project#11773 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] Support audio language models on V1 ( vllm-project#11733 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] update how pip can install nightly wheels ( vllm-project#11806 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Add note to `gte-Qwen2` models ( vllm-project#11808 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [optimization] remove python function call for custom op ( vllm-project#11750 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] update the prefix for qwen2 ( vllm-project#11795 )\n\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\n\n* [Doc]Add documentation for using EAGLE in vLLM ( vllm-project#11417 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\n\n* [Bugfix] Significant performance drop on CPUs with --num-scheduler-steps > 1 ( vllm-project#11794 )\n\n* [Doc] Group examples into categories ( vllm-project#11782 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix image input for Pixtral-HF ( vllm-project#11741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] sort torch profiler table by kernel timing ( vllm-project#11813 )\n\n* Remove the duplicate imports of MultiModalKwargs and PlaceholderRangeâ€¦ ( vllm-project#11824 )\n\n* Fixed docker build for ppc64le ( vllm-project#11518 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* [OpenVINO] Fixed Docker.openvino build ( vllm-project#11732 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [Bugfix] Add checks for LoRA and CPU offload ( vllm-project#11810 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Docs] reorganize sponsorship page ( vllm-project#11639 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [Bug] Fix pickling of `ModelConfig` when RunAI Model Streamer is used ( vllm-project#11825 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] improve memory profiling ( vllm-project#11809 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [doc] update wheels url ( vllm-project#11830 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Update sponsor name: 'Novita' to 'Novita AI' ( vllm-project#11833 )\n\n* [Hardware][Apple] Native support for macOS Apple Silicon ( vllm-project#11696 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [torch.compile] consider relevant code in compilation cache ( vllm-project#11614 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Reorganize profiling/processing-related code ( vllm-project#11812 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples into categories ( vllm-project#11840 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc][4/N] Reorganize API Reference ( vllm-project#11843 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build][Bugfix] Fix CPU CI image clean up ( vllm-project#11836 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Bugfix][XPU] fix silu_and_mul ( vllm-project#11823 )\n\nSigned-off-by: yan ma <yan.ma@intel.com>\n\n* [Misc] Move some model utils into vision file ( vllm-project#11848 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Expand Multimodal API Reference ( vllm-project#11852 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]add some explanations for BlockHashType ( vllm-project#11847 )\n\n* [TPU][Quantization] TPU `W8A8` ( vllm-project#11785 )\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models ( vllm-project#11698 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* [Docs] Add Google Cloud Meetup ( vllm-project#11864 )\n\n* Revert nccl changes ( #351 )\n\n* Revert \"[distributed] remove pynccl's redundant change_state ( vllm-project#11749 )\"\n\nThis reverts commit 9e764e7 .\n\n* Revert \"[distributed] remove pynccl's redundant stream ( vllm-project#11744 )\"\n\nThis reverts commit 635b897 .\n\n* [CI] Turn on basic correctness tests for V1 ( vllm-project#10864 )\n\n* treat do_lower_case in the same way as the sentence-transformers library ( vllm-project#11815 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\n\n* [Doc] Recommend uv and python 3.12 for quickstart guide ( vllm-project#11849 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc] Move `print_*_once` from utils to logger ( vllm-project#11298 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\n\n* [Doc] Intended links Python multiprocessing library ( vllm-project#11878 )\n\n* [perf]fix current stream ( vllm-project#11870 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Override dunder methods of placeholder modules ( vllm-project#11882 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] fix beam search input errors and latency benchmark script ( vllm-project#11875 )\n\nSigned-off-by: Ye Qi <yeq@meta.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\n\n* [Doc] Add model development API Reference ( vllm-project#11884 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] Allow platform specify attention backend ( vllm-project#11609 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci]try to fix flaky multi-step tests ( vllm-project#11894 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Provide correct Pixtral-HF chat template ( vllm-project#11891 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* fp8 support ( #352 )\n\nCo-authored-by: Yida Wu <yidawu@amd.com>\n\n* [Docs] Add Modal to deployment frameworks ( vllm-project#11907 )\n\n* [Doc][5/N] Move Community and API Reference to the bottom ( vllm-project#11896 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [VLM] Enable tokenized inputs for merged multi-modal processor ( vllm-project#11900 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Show default pooling method in a table ( vllm-project#11904 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] Hide KV cache behind torch.compile boundary ( vllm-project#11677 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Validate lora adapters to avoid crashing server ( vllm-project#11727 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [BUGFIX] Fix `UnspecifiedPlatform` package name ( vllm-project#11916 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [ci] fix gh200 tests ( vllm-project#11919 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] remove python function call for custom activation op ( vllm-project#11885 )\n\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [platform] support pytorch custom op pluggable ( vllm-project#11328 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* Replace \"online inference\" with \"online serving\" ( vllm-project#11923 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [ci] Fix sampler tests ( vllm-project#11922 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] [1/N] Initial guide for merged multi-modal processor ( vllm-project#11925 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] support custom torch.compile backend key ( vllm-project#11318 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Rename offline inference examples ( vllm-project#11927 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Fix docstring in `get_ip` function ( vllm-project#11932 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* Doc fix in `benchmark_long_document_qa_throughput.py` ( vllm-project#11933 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [Hardware][CPU] Support MOE models on x86 CPU ( vllm-project#11831 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Misc] Clean up debug code in Deepseek-V3 ( vllm-project#11930 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Update benchmark_prefix_caching.py fixed example usage ( vllm-project#11920 )\n\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\n\n* [Bugfix] Check that number of images matches number of <|image|> tokens with mllama ( vllm-project#11939 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\n\n* [mypy] Fix mypy warnings in api_server.py ( vllm-project#11941 )\n\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\n\n* [ci] fix broken distributed-tests-4-gpus ( vllm-project#11937 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][SpecDecode] Adjust Eagle model architecture to align with intended design ( vllm-project#11672 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Bugfix] fused_experts_impl wrong compute type for float32 ( vllm-project#11921 )\n\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\n\n* [CI/Build] Move model-specific multi-modal processing tests ( vllm-project#11934 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Basic guide for writing unit tests for new models ( vllm-project#11951 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix RobertaModel loading ( vllm-project#11940 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Model] Add cogagent model support vLLM ( vllm-project#11742 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* Using list\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* Docs lint\n\n* linter formatting bug fixes\n\n* inherit config file updates under fused_moe from main branch.\n\n* match tests for the MOE layers with main.\n\n---------\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Jiaxin Shan <seedjeffwan@gmail.com>\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Alex He <alehe@amd.com>\nSigned-off-by: ccjincong <chenjincong11@gmail.com>\nSigned-off-by: Erez Schwartz <erezs@ai21.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: rajveerb <46040700+rajveerb@users.noreply.github.com>\nSigned-off-by: hjwei <hjwei_xd@163.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nSigned-off-by: ApostaC <yihua98@uchicago.edu>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Kazuhiro Serizawa <nserihiro@gmail.com>\nSigned-off-by: Tobias Pitters <tobias.pitters@gmail.com>\nSigned-off-by: Kathy Yu <feiyangyu@google.com>\nSigned-off-by: bjmsong <bjmsong@126.com>\nSigned-off-by: wchen61 <wchen61@foxmail.com>\nSigned-off-by: ZincCat <zincchloride@outlook.com>\nSigned-off-by: xcnick <xcnick0412@gmail.com>\nSigned-off-by: Yan Burman <yanburman@users.noreply.github.com>\nSigned-off-by: Ido Asraff <idoa@atero.ai>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Suraj Deshmukh <surajd.service@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Jiaxin Shan <seedjeffwan@gmail.com>\nCo-authored-by: Lucas Tucker <47258766+lucas-tucker@users.noreply.github.com>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: HandH1998 <1335248067@qq.com>\nCo-authored-by: robertgshaw2-neuralmagic <rshaw@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: AlexHe99 <alehe@amd.com>\nCo-authored-by: Chen1022 <112855051+ccjincong@users.noreply.github.com>\nCo-authored-by: ErezSC42 <erezs@ai21.com>\nCo-authored-by: Selali <selali.adobor@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Rajveer Bachkaniwala <46040700+rajveerb@users.noreply.github.com>\nCo-authored-by: hj-wei <hjwei_xd@163.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: whyiug <whyiug@hotmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Matthias Vogler <60004995+ayylemao@users.noreply.github.com>\nCo-authored-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nCo-authored-by: John Giorgi <johnmgiorgi@gmail.com>\nCo-authored-by: sakunkun <zhou.qianjun@zte.com.cn>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Yihua Cheng <yihua98@uchicago.edu>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Kazuhiro Serizawa <nserihiro@gmail.com>\nCo-authored-by: Tobias Pitters <31857876+CloseChoice@users.noreply.github.com>\nCo-authored-by: Chunyang Wen <chunyang.wen@gmail.com>\nCo-authored-by: Kathy Yu <143133934+kathyyu-google@users.noreply.github.com>\nCo-authored-by: bjmsong <wq.songbob@gmail.com>\nCo-authored-by: bjmsong <bjmsong@126.com>\nCo-authored-by: wchen61 <wchen61@foxmail.com>\nCo-authored-by: Nathan Azrak <42650258+nathan-az@users.noreply.github.com>\nCo-authored-by: Sachin Varghese <sachin.mathew31@gmail.com>\nCo-authored-by: Aurick Qiao <aurickq@users.noreply.github.com>\nCo-authored-by: Aurick Qiao <aurick.qiao@snowflake.com>\nCo-authored-by: ZincCat <52513999+zinccat@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Hust_YangXian <bryceyx@gmail.com>\nCo-authored-by: Alberto Ferrer <albertof@barrahome.org>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: xcnick <xcnick0412@gmail.com>\nCo-authored-by: Yan Burman <yanburman@users.noreply.github.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Lancer <402430575@qq.com>\nCo-authored-by: Lancer <maruixiang6688@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Suraj Deshmukh <surajd.service@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Yida Wu <yidawu@amd.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> rasmith pushed a commit\n        to rasmith/vllm\n      that referenced\n      this pull request Jan 30, 2025 [perf]fix current stream ( vllm-project#11870 ) â€¦ 9555dd4 Signed-off-by: youkaichao <youkaichao@gmail.com> Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [perf]fix current stream ( vllm-project#11870 ) â€¦ 2ad182f Signed-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com> mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [perf]fix current stream ( vllm-project#11870 ) â€¦ 9a981e1 Signed-off-by: youkaichao <youkaichao@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:12", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: latency, latency, latency | SERVING: Serving, serving, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:12", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_latency.py --model meta-llama/Meta-Llama-3-70B --load-format dummy --enforce-eager -tp 4", "commit_subject": "[perf]fix current stream (#11870)", "commit_message": "[perf]fix current stream (#11870)\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>", "commit_date": "2025-01-09T07:18:21Z", "files_changed": ["vllm/distributed/device_communicators/pynccl.py", "vllm/distributed/parallel_state.py", "vllm/utils.py", "vllm/worker/multi_step_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 4, "only_test_files": 0, "only_non_test_files": 1, "num_files": 4, "num_hunks": 14, "num_edited_lines": 61, "num_non_test_edited_lines": 61, "commit_year": 2025}, "diff_text": "diff --git a/vllm/distributed/device_communicators/pynccl.py b/vllm/distributed/device_communicators/pynccl.py\nindex fda4d007c..efc599871 100644\n--- a/vllm/distributed/device_communicators/pynccl.py\n+++ b/vllm/distributed/device_communicators/pynccl.py\n@@ -10,6 +10,7 @@ from vllm.distributed.device_communicators.pynccl_wrapper import (\n     ncclRedOpTypeEnum, ncclUniqueId)\n from vllm.distributed.utils import StatelessProcessGroup\n from vllm.logger import init_logger\n+from vllm.utils import current_stream\n \n logger = init_logger(__name__)\n \n@@ -96,7 +97,7 @@ class PyNcclCommunicator:\n             self.comm: ncclComm_t = self.nccl.ncclCommInitRank(\n                 self.world_size, self.unique_id, self.rank)\n \n-            stream = torch.cuda.current_stream()\n+            stream = current_stream()\n             # A small all_reduce for warmup.\n             data = torch.zeros(1, device=device)\n             self.all_reduce(data)\n@@ -119,7 +120,7 @@ class PyNcclCommunicator:\n         out_tensor = torch.empty_like(in_tensor)\n \n         if stream is None:\n-            stream = torch.cuda.current_stream()\n+            stream = current_stream()\n         self.nccl.ncclAllReduce(buffer_type(in_tensor.data_ptr()),\n                                 buffer_type(out_tensor.data_ptr()),\n                                 in_tensor.numel(),\n@@ -141,7 +142,7 @@ class PyNcclCommunicator:\n             f\"this nccl communicator is created to work on {self.device}, \"\n             f\"but the input tensor is on {input_tensor.device}\")\n         if stream is None:\n-            stream = torch.cuda.current_stream()\n+            stream = current_stream()\n         self.nccl.ncclAllGather(\n             buffer_type(input_tensor.data_ptr()),\n             buffer_type(output_tensor.data_ptr()), input_tensor.numel(),\n@@ -162,7 +163,7 @@ class PyNcclCommunicator:\n             f\"this nccl communicator is created to work on {self.device}, \"\n             f\"but the input tensor is on {input_tensor.device}\")\n         if stream is None:\n-            stream = torch.cuda.current_stream()\n+            stream = current_stream()\n         self.nccl.ncclReduceScatter(\n             buffer_type(input_tensor.data_ptr()),\n             buffer_type(output_tensor.data_ptr()), output_tensor.numel(),\n@@ -177,7 +178,7 @@ class PyNcclCommunicator:\n             f\"this nccl communicator is created to work on {self.device}, \"\n             f\"but the input tensor is on {tensor.device}\")\n         if stream is None:\n-            stream = torch.cuda.current_stream()\n+            stream = current_stream()\n         self.nccl.ncclSend(buffer_type(tensor.data_ptr()), tensor.numel(),\n                            ncclDataTypeEnum.from_torch(tensor.dtype), dst,\n                            self.comm, cudaStream_t(stream.cuda_stream))\n@@ -189,7 +190,7 @@ class PyNcclCommunicator:\n             f\"this nccl communicator is created to work on {self.device}, \"\n             f\"but the input tensor is on {tensor.device}\")\n         if stream is None:\n-            stream = torch.cuda.current_stream()\n+            stream = current_stream()\n         self.nccl.ncclRecv(buffer_type(tensor.data_ptr()), tensor.numel(),\n                            ncclDataTypeEnum.from_torch(tensor.dtype), src,\n                            self.comm, cudaStream_t(stream.cuda_stream))\n@@ -201,7 +202,7 @@ class PyNcclCommunicator:\n             f\"this nccl communicator is created to work on {self.device}, \"\n             f\"but the input tensor is on {tensor.device}\")\n         if stream is None:\n-            stream = torch.cuda.current_stream()\n+            stream = current_stream()\n         if src == self.rank:\n             sendbuff = buffer_type(tensor.data_ptr())\n             # NCCL requires the sender also to have a receive buffer\ndiff --git a/vllm/distributed/parallel_state.py b/vllm/distributed/parallel_state.py\nindex a837c1dc5..be7f16ef5 100644\n--- a/vllm/distributed/parallel_state.py\n+++ b/vllm/distributed/parallel_state.py\n@@ -357,10 +357,7 @@ class GroupCoordinator:\n             return out\n         pynccl_comm = self.pynccl_comm\n         assert pynccl_comm is not None\n-        # TODO: pynccl should not use `stream=`\n-        # it can just always use the current stream.\n-        out = pynccl_comm.all_reduce(input_,\n-                                     stream=torch.cuda.current_stream())\n+        out = pynccl_comm.all_reduce(input_)\n         if out is None:\n             # fall back to the default all-reduce using PyTorch.\n             # this usually happens during testing.\ndiff --git a/vllm/utils.py b/vllm/utils.py\nindex a92b77efd..0b0905e67 100644\n--- a/vllm/utils.py\n+++ b/vllm/utils.py\n@@ -944,6 +944,39 @@ def find_nccl_library() -> str:\n     return so_file\n \n \n+prev_set_stream = torch.cuda.set_stream\n+\n+_current_stream = None\n+\n+\n+def _patched_set_stream(stream: torch.cuda.Stream) -> None:\n+    global _current_stream\n+    _current_stream = stream\n+    prev_set_stream(stream)\n+\n+\n+torch.cuda.set_stream = _patched_set_stream\n+\n+\n+def current_stream() -> torch.cuda.Stream:\n+    \"\"\"\n+    replace `torch.cuda.current_stream()` with `vllm.utils.current_stream()`.\n+    it turns out that `torch.cuda.current_stream()` is quite expensive,\n+    as it will construct a new stream object at each call.\n+    here we patch `torch.cuda.set_stream` to keep track of the current stream\n+    directly, so that we can avoid calling `torch.cuda.current_stream()`.\n+\n+    the underlying hypothesis is that we do not call `torch._C._cuda_setStream`\n+    from C/C++ code.\n+    \"\"\"\n+    global _current_stream\n+    if _current_stream is None:\n+        # when this function is called before any stream is set,\n+        # we return the default stream.\n+        _current_stream = torch.cuda.current_stream()\n+    return _current_stream\n+\n+\n def enable_trace_function_call_for_thread(vllm_config: \"VllmConfig\") -> None:\n     \"\"\"Set up function tracing for the current thread,\n     if enabled via the VLLM_TRACE_FUNCTION environment variable\ndiff --git a/vllm/worker/multi_step_model_runner.py b/vllm/worker/multi_step_model_runner.py\nindex a2c2cebf8..acce92349 100644\n--- a/vllm/worker/multi_step_model_runner.py\n+++ b/vllm/worker/multi_step_model_runner.py\n@@ -14,7 +14,7 @@ from vllm.model_executor.layers.sampler import (PromptLogprobs, SampleLogprobs,\n                                                 get_pythonized_sample_results)\n from vllm.sequence import (CompletionSequenceGroupOutput, IntermediateTensors,\n                            Logprob, SequenceGroupMetadata, SequenceOutput)\n-from vllm.utils import PyObjectCache, async_tensor_h2d\n+from vllm.utils import PyObjectCache, async_tensor_h2d, current_stream\n from vllm.worker.model_runner import (GPUModelRunnerBase,\n                                       ModelInputForGPUWithSamplingMetadata)\n from vllm.worker.model_runner_base import (\n@@ -498,7 +498,7 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n         #   appended sampler output from last iteration\n         #   - also maybe pythonize if CPU is ahead of GPU\n \n-        current_stream = torch.cuda.current_stream()\n+        stream = current_stream()\n         if not model_input.is_first_multi_step:\n             # Explicitly block on the previous step's forward to make sure we\n             # don't clobber any GPU tensors still in use.\n@@ -541,7 +541,7 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n                                                        num_steps=1)\n \n         # record the event for the current step so that the next step can sync\n-        model_input.record_step_event(current_stream)\n+        model_input.record_step_event(stream)\n \n         if get_pp_group().is_last_rank and self.is_driver_worker:\n             assert isinstance(output, list)\n@@ -552,7 +552,7 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n             # event for the pythonization so that we only pythonize if the\n             # tensors are ready. May be able to be combined with the step event\n             output_ready_event = torch.cuda.Event()\n-            output_ready_event.record(current_stream)\n+            output_ready_event.record(stream)\n             if self.parallel_config.pipeline_parallel_size > 1:\n                 output[0].sampled_token_ids_cpu = output[\n                     0].sampled_token_ids.cpu()", "apis": ["vllm.distributed.device_communicators.pynccl.PyNcclCommunicator.all_reduce", "vllm.utils.current_stream", "vllm.worker.multi_step_model_runner.MultiStepModelRunner.execute_model"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/device_communicators/pynccl.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/parallel_state.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/multi_step_model_runner.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test source code files in vllm by replacing multiple invocations of torch.cuda.current_stream() with a new, cached function current_stream(), which avoids the expensive construction of new stream objects on every call. This change is aimed at improving performance by reducing overhead in stream handling. The modifications affect performance-sensitive parts of the code (device communicators and model runner) on CPU for GPU workload coordination. The changes are not mere refactoring or bug fixes, but rather an explicit optimization to bypass an expensive operation.", "llm_api_reason": "The commit replaces multiple calls to torch.cuda.current_stream() with a more optimized current_stream() function defined in vllm/utils.py. This change affects the methods in PyNcclCommunicator from the device communicators (all_reduce, all_gather, reduce_scatter, send, recv, broadcast, etc.) as they now call current_stream() to obtain the current CUDA stream. The change is also propagated to the GroupCoordinatorâ€™s all_reduce call and to the MultiStepModelRunner in the worker where stream-capturing and event recording is updated. Overall, the current_stream API is introduced/modified and is now used across these components to improve performance during stream retrieval."}
{"commit_hash": "526de822d501c792b051c864ba873a836d78d5bf", "pr_url": "https://github.com/vllm-project/vllm/pull/11698", "pr_date": "2025-01-08", "timeline_text": "Copy link Contributor rasmith commented Jan 3, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Use the heuristic from scaled_mm_c3x_sm90_int8_dispatch.cuh:116 to choose block-size for triton_scaled_mm instead of always using 32x32x32 for better performance.  This results in average 2.8x speedup. I ran: python benchmarks/benchmark_latency.py --dtype bfloat16 --enable-chunked-prefill False --load-format dummy --batch-size BS --num-iters-warmup 2 --num-iters 5 --input-len INPUT_LEN --output-len OUTPUT_LEN --model MODEL where BS in [ 1 , 16 , 64 ] INPUT_LEN in [ 128 , 1024 , 2048 ] OUTPUT_LEN in [ 1 , 128 , 1024 ] MODEL in [ \"Qwen2-7B-Instruct-quantized.w8a8\" , \"Phi-3-medium-128k-instruct-quantized.w8a8\" , \"Meta-Llama-3.1-8B-Instruct-quantized.w8a8\" , \"Mistral-7B-Instruct-v0.3-quantized.w8a8\" ] to get this number. Here are a few samples for Qwen2-7B-Instruct-quantized.w8a8 with dtype = bfloat16 batch_size input_len output_len avg_latency_old avg_latency_new speedup 1 128 128 1.4206 0.9828 1.4453 1 1024 1024 11.4586 7.8414 1.4612 64 2048 128 14.2707 4.7842 2.9828 I uploaded the full CSV file for all of the models and configs. heuristic_speedups.csv Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Change defeault block size for triton_scaled_mm to 128 for 4-5x speedup â€¦ 5675c6b Signed-off-by: Randall Smith <Randall.Smith@amd.com> Copy link github-actions bot commented Jan 3, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member mgoin commented Jan 3, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This is an impressive improvement! Could you also show comparisons for equal input len/output len workloads, preferably with low batchsize? This could regress the TPOT for small decode batches. It seems there is no tuning for this kernel at the moment, so maybe this could benefit from a simple heuristic for the extreme problem sizes or a few @triton.autotune configs for the blocksizes. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . rasmith added 2 commits January 3, 2025 16:41 Use heuristic based on cutlass_gemm_sm90_int8_dispatch â€¦ a45f569 Signed-off-by: Randall Smith <Randall.Smith@amd.com> Use heuristic to pick block size for better performance across input/â€¦ â€¦ eb8126e â€¦output/batch sizes\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com> rasmith changed the title [Kernel][Triton][AMD] Change default block size for triton_scaled_mm to 128 for 3-5x speedup [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup Jan 7, 2025 Copy link Contributor Author rasmith commented Jan 7, 2025 This is an impressive improvement! Could you also show comparisons for equal input len/output len workloads, preferably with low batchsize? This could regress the TPOT for small decode batches. It seems there is no tuning for this kernel at the moment, so maybe this could benefit from a simple heuristic for the extreme problem sizes or a few @triton.autotune configs for the blocksizes. @mgoin When just using 128x128x128 it gave better performance from some, but not all.  So, I used the heuristic from here: https://github.com/rasmith/vllm/blob/187e32997cdc20bbed5c21d3cef2609ab8ed9080/csrc/quantization/cutlass_w8a8/scaled_mm_c3x_sm90_int8_dispatch.cuh#L116 . I ran across various models and configs and was able to get improvement for all of the configs I tried.  Average speedup is ~ 2.8x. ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . rasmith changed the title [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models Jan 7, 2025 mgoin approved these changes Jan 8, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice work I appreciate the benchmarking, this is a clear win! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jan 8, 2025 mgoin enabled auto-merge (squash) January 8, 2025 18:57 Hide details View details mgoin merged commit 526de82 into vllm-project : main Jan 8, 2025 74 checks passed Uh oh! There was an error while loading. Please reload this page . gshtras added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Jan 14, 2025 Merge pull request #358 from ROCm/upstream_merge_25_01_13 â€¦ 5976f48 * [Bugfix][V1] Fix molmo text-only inputs ( vllm-project#11676 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Move attn_type to Attention.__init__() ( vllm-project#11690 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [V1] Extend beyond image modality and support mixed-modality inference with Llava-OneVision ( vllm-project#11685 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix LLaVA-NeXT feature size precision error (for real) ( vllm-project#11772 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Future-proof Qwen2-Audio multi-modal processor ( vllm-project#11776 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [XPU] Make pp group initilized for pipeline-parallelism ( vllm-project#11648 )\n\nSigned-off-by: yisheng <yi.sheng@intel.com>\n\n* [Doc][3/N] Reorganize Serving section ( vllm-project#11766 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel][LoRA]Punica prefill  kernels fusion ( vllm-project#11234 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\n\n* [Bugfix] Update attention interface in `Whisper` ( vllm-project#11784 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI] Fix neuron CI and run offline tests ( vllm-project#11779 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* fix init error for MessageQueue when n_local_reader is zero ( vllm-project#11768 )\n\n* [Doc] Create a vulnerability management team ( vllm-project#9925 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [CI][CPU] adding build number to docker image name ( vllm-project#11788 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [V1][Doc] Update V1 support for `LLaVa-NeXT-Video` ( vllm-project#11798 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Comprehensively test and fix LLaVA-NeXT feature size calculation ( vllm-project#11800 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] add doc to explain how to use uv ( vllm-project#11773 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] Support audio language models on V1 ( vllm-project#11733 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] update how pip can install nightly wheels ( vllm-project#11806 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Add note to `gte-Qwen2` models ( vllm-project#11808 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [optimization] remove python function call for custom op ( vllm-project#11750 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] update the prefix for qwen2 ( vllm-project#11795 )\n\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\n\n* [Doc]Add documentation for using EAGLE in vLLM ( vllm-project#11417 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\n\n* [Bugfix] Significant performance drop on CPUs with --num-scheduler-steps > 1 ( vllm-project#11794 )\n\n* [Doc] Group examples into categories ( vllm-project#11782 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix image input for Pixtral-HF ( vllm-project#11741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] sort torch profiler table by kernel timing ( vllm-project#11813 )\n\n* Remove the duplicate imports of MultiModalKwargs and PlaceholderRangeâ€¦ ( vllm-project#11824 )\n\n* Fixed docker build for ppc64le ( vllm-project#11518 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* [OpenVINO] Fixed Docker.openvino build ( vllm-project#11732 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [Bugfix] Add checks for LoRA and CPU offload ( vllm-project#11810 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Docs] reorganize sponsorship page ( vllm-project#11639 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [Bug] Fix pickling of `ModelConfig` when RunAI Model Streamer is used ( vllm-project#11825 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] improve memory profiling ( vllm-project#11809 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [doc] update wheels url ( vllm-project#11830 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Update sponsor name: 'Novita' to 'Novita AI' ( vllm-project#11833 )\n\n* [Hardware][Apple] Native support for macOS Apple Silicon ( vllm-project#11696 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [torch.compile] consider relevant code in compilation cache ( vllm-project#11614 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Reorganize profiling/processing-related code ( vllm-project#11812 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples into categories ( vllm-project#11840 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc][4/N] Reorganize API Reference ( vllm-project#11843 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build][Bugfix] Fix CPU CI image clean up ( vllm-project#11836 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Bugfix][XPU] fix silu_and_mul ( vllm-project#11823 )\n\nSigned-off-by: yan ma <yan.ma@intel.com>\n\n* [Misc] Move some model utils into vision file ( vllm-project#11848 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Expand Multimodal API Reference ( vllm-project#11852 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]add some explanations for BlockHashType ( vllm-project#11847 )\n\n* [TPU][Quantization] TPU `W8A8` ( vllm-project#11785 )\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models ( vllm-project#11698 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* [Docs] Add Google Cloud Meetup ( vllm-project#11864 )\n\n* [CI] Turn on basic correctness tests for V1 ( vllm-project#10864 )\n\n* treat do_lower_case in the same way as the sentence-transformers library ( vllm-project#11815 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\n\n* [Doc] Recommend uv and python 3.12 for quickstart guide ( vllm-project#11849 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc] Move `print_*_once` from utils to logger ( vllm-project#11298 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\n\n* [Doc] Intended links Python multiprocessing library ( vllm-project#11878 )\n\n* [perf]fix current stream ( vllm-project#11870 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Override dunder methods of placeholder modules ( vllm-project#11882 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] fix beam search input errors and latency benchmark script ( vllm-project#11875 )\n\nSigned-off-by: Ye Qi <yeq@meta.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\n\n* [Doc] Add model development API Reference ( vllm-project#11884 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] Allow platform specify attention backend ( vllm-project#11609 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci]try to fix flaky multi-step tests ( vllm-project#11894 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Provide correct Pixtral-HF chat template ( vllm-project#11891 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Docs] Add Modal to deployment frameworks ( vllm-project#11907 )\n\n* [Doc][5/N] Move Community and API Reference to the bottom ( vllm-project#11896 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [VLM] Enable tokenized inputs for merged multi-modal processor ( vllm-project#11900 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Show default pooling method in a table ( vllm-project#11904 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] Hide KV cache behind torch.compile boundary ( vllm-project#11677 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Validate lora adapters to avoid crashing server ( vllm-project#11727 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [BUGFIX] Fix `UnspecifiedPlatform` package name ( vllm-project#11916 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [ci] fix gh200 tests ( vllm-project#11919 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] remove python function call for custom activation op ( vllm-project#11885 )\n\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [platform] support pytorch custom op pluggable ( vllm-project#11328 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* Replace \"online inference\" with \"online serving\" ( vllm-project#11923 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [ci] Fix sampler tests ( vllm-project#11922 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] [1/N] Initial guide for merged multi-modal processor ( vllm-project#11925 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] support custom torch.compile backend key ( vllm-project#11318 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Rename offline inference examples ( vllm-project#11927 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Fix docstring in `get_ip` function ( vllm-project#11932 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* Doc fix in `benchmark_long_document_qa_throughput.py` ( vllm-project#11933 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [Hardware][CPU] Support MOE models on x86 CPU ( vllm-project#11831 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Misc] Clean up debug code in Deepseek-V3 ( vllm-project#11930 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Update benchmark_prefix_caching.py fixed example usage ( vllm-project#11920 )\n\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\n\n* [Bugfix] Check that number of images matches number of <|image|> tokens with mllama ( vllm-project#11939 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\n\n* [mypy] Fix mypy warnings in api_server.py ( vllm-project#11941 )\n\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\n\n* [ci] fix broken distributed-tests-4-gpus ( vllm-project#11937 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][SpecDecode] Adjust Eagle model architecture to align with intended design ( vllm-project#11672 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Bugfix] fused_experts_impl wrong compute type for float32 ( vllm-project#11921 )\n\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\n\n* [CI/Build] Move model-specific multi-modal processing tests ( vllm-project#11934 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Basic guide for writing unit tests for new models ( vllm-project#11951 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix RobertaModel loading ( vllm-project#11940 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Model] Add cogagent model support vLLM ( vllm-project#11742 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* Using list\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Trying to make scales work with compileable attention\n\n* Docs lint\n\n---------\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com> hongxiayang pushed a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Jan 15, 2025 [MFM-20250115] Merge from ROCm/main to llama_fp8 ( #360 ) â€¦ d9385b4 * [Misc] Move weights mapper ( vllm-project#11443 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile. Fixes vllm-project#9182 ( vllm-project#11435 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Automatic conversion of classification and reward models ( vllm-project#11469 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Unify VLLM_ENABLE_V1_MULTIPROCESSING handling in RayExecutor ( vllm-project#11472 )\n\n* [Misc] Update disaggregation benchmark scripts and test logs ( vllm-project#11456 )\n\nSigned-off-by: Jiaxin Shan <seedjeffwan@gmail.com>\n\n* [Frontend] Enable decord to load video from base64 ( vllm-project#11492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Improve GitHub links ( vllm-project#11491 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Move some multimodal utils to modality-specific modules ( vllm-project#11494 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Mypy checking for vllm/compilation ( vllm-project#11496 )\n\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\n\n* [Misc][LoRA] Fix LoRA weight mapper ( vllm-project#11495 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Doc] Add `QVQ` and `QwQ` to the list of supported models ( vllm-project#11509 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1] Adding min tokens/repetition/presence/frequence penalties to V1 sampler ( vllm-project#10681 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Model]  Modify MolmoForCausalLM MLP  ( vllm-project#11510 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Add placeholder module ( vllm-project#11501 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Add video example to openai client for multimodal ( vllm-project#11521 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [1/N] API Server  (Remove Proxy) ( vllm-project#11529 )\n\n* [Model] [Quantization] Support deepseek_v3 w8a8 fp8 block-wise quantization ( vllm-project#11523 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: HandH1998 <1335248067@qq.com>\n\n* [2/N] API Server: Avoid ulimit footgun ( vllm-project#11530 )\n\n* Deepseek v3 ( vllm-project#11502 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: robertgshaw2-neuralmagic <rshaw@neuralmagic.com>\n\n* [Docs] Document Deepseek V3 support ( vllm-project#11535 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* Update openai_compatible_server.md ( vllm-project#11536 )\n\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [V1] Use FlashInfer Sampling Kernel for Top-P & Top-K Sampling ( vllm-project#11394 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Fix yapf ( vllm-project#11538 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [CI] Fix broken CI ( vllm-project#11543 )\n\n* [misc] fix typing ( vllm-project#11540 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][3/N] API Server: Reduce Task Switching + Handle Abort Properly ( vllm-project#11534 )\n\n* [BugFix] Fix quantization for all other methods ( vllm-project#11547 )\n\n* [Platform] Move model arch check to platform ( vllm-project#11503 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* Update deploying_with_k8s.md with AMD ROCm GPU example ( vllm-project#11465 )\n\nSigned-off-by: Alex He <alehe@amd.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix] Fix TeleChat2ForCausalLM weights mapper ( vllm-project#11546 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Abstract the logic for reading and writing media content ( vllm-project#11527 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc]  Add xgrammar in doc ( vllm-project#11549 )\n\nSigned-off-by: ccjincong <chenjincong11@gmail.com>\n\n* [VLM] Support caching in merged multi-modal processor ( vllm-project#11396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MODEL] LoRA support for Jamba model ( vllm-project#11209 )\n\nSigned-off-by: Erez Schwartz <erezs@ai21.com>\n\n* [Misc]Add BNB quantization for MolmoForCausalLM  ( vllm-project#11551 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Improve BNB loader to handle mixture of sharded and merged weights with same suffix ( vllm-project#11566 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Bugfix] Fix for ROCM compressed tensor support ( vllm-project#11561 )\n\n* [Doc] Update mllama example based on official doc ( vllm-project#11567 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [V1] [4/N] API Server: ZMQ/MP Utilities ( vllm-project#11541 )\n\n* [Bugfix] Last token measurement fix ( vllm-project#11376 )\n\nSigned-off-by: rajveerb <46040700+rajveerb@users.noreply.github.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Model] Support InternLM2 Reward models ( vllm-project#11571 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Model] Remove hardcoded image tokens ids from Pixtral ( vllm-project#11582 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Hardware][AMD]: Replace HIPCC version with more precise ROCm version ( vllm-project#11515 )\n\nSigned-off-by: hjwei <hjwei_xd@163.com>\n\n* [V1][Minor] Set pin_memory=False for token_ids_cpu tensor ( vllm-project#11581 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Doc] Minor documentation fixes ( vllm-project#11580 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [bugfix] interleaving sliding window for cohere2 model ( vllm-project#11583 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] [5/N] API Server: unify `Detokenizer` and  `EngineCore` input ( vllm-project#11545 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Doc] Convert list tables to MyST ( vllm-project#11594 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [v1][bugfix] fix cudagraph with inplace buffer assignment ( vllm-project#11596 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] KV cache transfer connector registry ( vllm-project#11481 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Remove print statement in DeepseekScalingRotaryEmbedding ( vllm-project#11604 )\n\n* [v1] fix compilation cache ( vllm-project#11598 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docker] bump up neuron sdk v2.21 ( vllm-project#11593 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Build][Kernel] Update CUTLASS to v3.6.0 ( vllm-project#11607 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build][CPU] Fix CPU CI by lazy importing triton FP8 kernels ( vllm-project#11618 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [platforms] enable platform plugins ( vllm-project#11602 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Abstract out multi-modal data parsing in merged processor ( vllm-project#11620 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] [6/N] API Server: Better Shutdown ( vllm-project#11586 )\n\n* [Bugfix] Validate and concatenate image embeddings in MiniCPMVBaseModel ( vllm-project#11631 )\n\n* [benchmark] Remove dependency for H100 benchmark step ( vllm-project#11572 )\n\n* [Model][LoRA]LoRA support added for MolmoForCausalLM ( vllm-project#11439 )\n\nSigned-off-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Fix OpenAI parallel sampling when using xgrammar ( vllm-project#11637 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc][LoRA] Support Rank Stabilized LoRA (RSLoRA) ( vllm-project#6909 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Move the _touch(computed_blocks) call in the allocate_slots method to after the check for allocating new blocks. ( vllm-project#11565 )\n\n* [V1] Simpify vision block hash for prefix caching by removing offset from hash ( vllm-project#11646 )\n\n* [V1][VLM] V1 support for selected single-image models. ( vllm-project#11632 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Benchmark] Add benchmark script for CPU offloading  ( vllm-project#11533 )\n\nSigned-off-by: ApostaC <yihua98@uchicago.edu>\nCo-authored-by: KuntaiDu <kuntai@uchicago.edu>\n\n* [Bugfix][Refactor] Unify model management in frontend ( vllm-project#11660 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [VLM] Add max-count checking in data parser for single image models ( vllm-project#11661 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Optimize Qwen2-VL LoRA test ( vllm-project#11663 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Replace space with - in the file names ( vllm-project#11667 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Fix typo ( vllm-project#11666 )\n\nSigned-off-by: Kazuhiro Serizawa <nserihiro@gmail.com>\n\n* [V1] Implement Cascade Attention ( vllm-project#11635 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [VLM] Move supported limits and max tokens to merged multi-modal processor ( vllm-project#11669 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [VLM][Bugfix] Multi-modal processor compatible with V1 multi-input ( vllm-project#11674 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [mypy] Pass type checking in vllm/inputs ( vllm-project#11680 )\n\nSigned-off-by: Tobias Pitters <tobias.pitters@gmail.com>\n\n* [VLM] Merged multi-modal processor for LLaVA-NeXT ( vllm-project#11682 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* According to vllm.EngineArgs, the name should be distributed_executor_backend ( vllm-project#11689 )\n\n* [Bugfix] Free cross attention block table for preempted-for-recompute sequence group. ( vllm-project#10013 )\n\nSigned-off-by: Kathy Yu <feiyangyu@google.com>\n\n* [V1][Minor] Optimize token_ids_cpu copy ( vllm-project#11692 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Change kv scaling factor by param json on nvidia gpu ( vllm-project#11688 )\n\nSigned-off-by: bjmsong <bjmsong@126.com>\nCo-authored-by: bjmsong <bjmsong@126.com>\n\n* Resolve race conditions in Marlin kernel ( vllm-project#11493 )\n\nSigned-off-by: wchen61 <wchen61@foxmail.com>\n\n* [Misc] Minimum requirements for SageMaker compatibility ( vllm-project#11576 )\n\n* Update default max_num_batch_tokens for chunked prefill ( vllm-project#11694 )\n\n* [Bugfix] Check chain_speculative_sampling before calling it ( vllm-project#11673 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [perf-benchmark] Fix dependency for steps in benchmark pipeline ( vllm-project#11710 )\n\n* [Model] Whisper model implementation ( vllm-project#11280 )\n\nCo-authored-by: Aurick Qiao <aurick.qiao@snowflake.com>\n\n* [V1] Simplify Shutdown ( vllm-project#11659 )\n\n* [Bugfix] Fix ColumnParallelLinearWithLoRA slice ( vllm-project#11708 )\n\nSigned-off-by: ZincCat <zincchloride@outlook.com>\n\n* [V1] Improve TP>1 Error Handling + Stack Trace ( vllm-project#11721 )\n\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Misc]Add BNB quantization for Qwen2VL ( vllm-project#11719 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* Update requirements-tpu.txt to support python 3.9 and 3.11 ( vllm-project#11695 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [V1] Chore: cruft removal ( vllm-project#11724 )\n\n* [V1] log GPU blocks num for MultiprocExecutor ( vllm-project#11656 )\n\n* Update tool_calling.md ( vllm-project#11701 )\n\n* Update bnb.md with example for OpenAI ( vllm-project#11718 )\n\n* [V1] Add `RayExecutor` support for `AsyncLLM` (api server) ( vllm-project#11712 )\n\n* [V1] Add kv cache utils tests. ( vllm-project#11513 )\n\nSigned-off-by: xcnick <xcnick0412@gmail.com>\n\n* [Core][Bugfix] Use correct device to initialize GPU data during CUDA-graph-capture ( vllm-project#11233 )\n\nSigned-off-by: Yan Burman <yanburman@users.noreply.github.com>\nSigned-off-by: Ido Asraff <idoa@atero.ai>\n\n* [VLM] Merged multi-modal processors for LLaVA-NeXT-Video and LLaVA-OneVision ( vllm-project#11717 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix precision error in LLaVA-NeXT ( vllm-project#11735 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Remove unnecessary weight initialization logic ( vllm-project#11736 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Bugfix][V1] Fix test_kv_cache_utils.py ( vllm-project#11738 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [MISC] Replace c10::optional with std::optional ( vllm-project#11730 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [distributed] remove pynccl's redundant stream ( vllm-project#11744 )\n\n* fix: [doc] fix typo ( vllm-project#11751 )\n\nCo-authored-by: Lancer <maruixiang6688@gmail.com>\n\n* [Frontend] Improve `StreamingResponse` Exception Handling ( vllm-project#11752 )\n\n* [distributed] remove pynccl's redundant change_state ( vllm-project#11749 )\n\n* [Doc] [1/N] Reorganize Getting Started section ( vllm-project#11645 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Remove block size constraint ( vllm-project#11723 )\n\n* [V1] Add BlockTable class ( vllm-project#11693 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Fix typo for valid_tool_parses  ( vllm-project#11753 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [V1] Refactor get_executor_cls ( vllm-project#11754 )\n\n* [mypy] Forward pass function type hints in lora ( vllm-project#11740 )\n\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\n\n* k8s-config: Update the secret to use stringData ( vllm-project#11679 )\n\nSigned-off-by: Suraj Deshmukh <surajd.service@gmail.com>\n\n* [VLM] Separate out profiling-related logic ( vllm-project#11746 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc][2/N] Reorganize Models and Usage sections ( vllm-project#11755 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix max image size for LLaVA-Onevision ( vllm-project#11769 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] explain how to add interleaving sliding window support ( vllm-project#11771 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][V1] Fix molmo text-only inputs ( vllm-project#11676 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Move attn_type to Attention.__init__() ( vllm-project#11690 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* format\n\n* [V1] Extend beyond image modality and support mixed-modality inference with Llava-OneVision ( vllm-project#11685 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* deepseek overflow fix ( #349 )\n\n* [Bugfix] Fix LLaVA-NeXT feature size precision error (for real) ( vllm-project#11772 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Future-proof Qwen2-Audio multi-modal processor ( vllm-project#11776 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [XPU] Make pp group initilized for pipeline-parallelism ( vllm-project#11648 )\n\nSigned-off-by: yisheng <yi.sheng@intel.com>\n\n* [Doc][3/N] Reorganize Serving section ( vllm-project#11766 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel][LoRA]Punica prefill  kernels fusion ( vllm-project#11234 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\n\n* [Bugfix] Update attention interface in `Whisper` ( vllm-project#11784 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI] Fix neuron CI and run offline tests ( vllm-project#11779 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* fix init error for MessageQueue when n_local_reader is zero ( vllm-project#11768 )\n\n* [Doc] Create a vulnerability management team ( vllm-project#9925 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [CI][CPU] adding build number to docker image name ( vllm-project#11788 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [V1][Doc] Update V1 support for `LLaVa-NeXT-Video` ( vllm-project#11798 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Comprehensively test and fix LLaVA-NeXT feature size calculation ( vllm-project#11800 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] add doc to explain how to use uv ( vllm-project#11773 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] Support audio language models on V1 ( vllm-project#11733 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] update how pip can install nightly wheels ( vllm-project#11806 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Add note to `gte-Qwen2` models ( vllm-project#11808 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [optimization] remove python function call for custom op ( vllm-project#11750 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] update the prefix for qwen2 ( vllm-project#11795 )\n\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\n\n* [Doc]Add documentation for using EAGLE in vLLM ( vllm-project#11417 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\n\n* [Bugfix] Significant performance drop on CPUs with --num-scheduler-steps > 1 ( vllm-project#11794 )\n\n* [Doc] Group examples into categories ( vllm-project#11782 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix image input for Pixtral-HF ( vllm-project#11741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] sort torch profiler table by kernel timing ( vllm-project#11813 )\n\n* Remove the duplicate imports of MultiModalKwargs and PlaceholderRangeâ€¦ ( vllm-project#11824 )\n\n* Fixed docker build for ppc64le ( vllm-project#11518 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* [OpenVINO] Fixed Docker.openvino build ( vllm-project#11732 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [Bugfix] Add checks for LoRA and CPU offload ( vllm-project#11810 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Docs] reorganize sponsorship page ( vllm-project#11639 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [Bug] Fix pickling of `ModelConfig` when RunAI Model Streamer is used ( vllm-project#11825 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] improve memory profiling ( vllm-project#11809 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [doc] update wheels url ( vllm-project#11830 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Update sponsor name: 'Novita' to 'Novita AI' ( vllm-project#11833 )\n\n* [Hardware][Apple] Native support for macOS Apple Silicon ( vllm-project#11696 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [torch.compile] consider relevant code in compilation cache ( vllm-project#11614 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Reorganize profiling/processing-related code ( vllm-project#11812 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples into categories ( vllm-project#11840 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc][4/N] Reorganize API Reference ( vllm-project#11843 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build][Bugfix] Fix CPU CI image clean up ( vllm-project#11836 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Bugfix][XPU] fix silu_and_mul ( vllm-project#11823 )\n\nSigned-off-by: yan ma <yan.ma@intel.com>\n\n* [Misc] Move some model utils into vision file ( vllm-project#11848 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Expand Multimodal API Reference ( vllm-project#11852 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]add some explanations for BlockHashType ( vllm-project#11847 )\n\n* [TPU][Quantization] TPU `W8A8` ( vllm-project#11785 )\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models ( vllm-project#11698 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* [Docs] Add Google Cloud Meetup ( vllm-project#11864 )\n\n* Revert nccl changes ( #351 )\n\n* Revert \"[distributed] remove pynccl's redundant change_state ( vllm-project#11749 )\"\n\nThis reverts commit 9e764e7 .\n\n* Revert \"[distributed] remove pynccl's redundant stream ( vllm-project#11744 )\"\n\nThis reverts commit 635b897 .\n\n* [CI] Turn on basic correctness tests for V1 ( vllm-project#10864 )\n\n* treat do_lower_case in the same way as the sentence-transformers library ( vllm-project#11815 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\n\n* [Doc] Recommend uv and python 3.12 for quickstart guide ( vllm-project#11849 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc] Move `print_*_once` from utils to logger ( vllm-project#11298 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\n\n* [Doc] Intended links Python multiprocessing library ( vllm-project#11878 )\n\n* [perf]fix current stream ( vllm-project#11870 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Override dunder methods of placeholder modules ( vllm-project#11882 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] fix beam search input errors and latency benchmark script ( vllm-project#11875 )\n\nSigned-off-by: Ye Qi <yeq@meta.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\n\n* [Doc] Add model development API Reference ( vllm-project#11884 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] Allow platform specify attention backend ( vllm-project#11609 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci]try to fix flaky multi-step tests ( vllm-project#11894 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Provide correct Pixtral-HF chat template ( vllm-project#11891 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* fp8 support ( #352 )\n\nCo-authored-by: Yida Wu <yidawu@amd.com>\n\n* [Docs] Add Modal to deployment frameworks ( vllm-project#11907 )\n\n* [Doc][5/N] Move Community and API Reference to the bottom ( vllm-project#11896 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [VLM] Enable tokenized inputs for merged multi-modal processor ( vllm-project#11900 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Show default pooling method in a table ( vllm-project#11904 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] Hide KV cache behind torch.compile boundary ( vllm-project#11677 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Validate lora adapters to avoid crashing server ( vllm-project#11727 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [BUGFIX] Fix `UnspecifiedPlatform` package name ( vllm-project#11916 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [ci] fix gh200 tests ( vllm-project#11919 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] remove python function call for custom activation op ( vllm-project#11885 )\n\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [platform] support pytorch custom op pluggable ( vllm-project#11328 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* Replace \"online inference\" with \"online serving\" ( vllm-project#11923 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [ci] Fix sampler tests ( vllm-project#11922 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] [1/N] Initial guide for merged multi-modal processor ( vllm-project#11925 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] support custom torch.compile backend key ( vllm-project#11318 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Rename offline inference examples ( vllm-project#11927 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Fix docstring in `get_ip` function ( vllm-project#11932 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* Doc fix in `benchmark_long_document_qa_throughput.py` ( vllm-project#11933 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [Hardware][CPU] Support MOE models on x86 CPU ( vllm-project#11831 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Misc] Clean up debug code in Deepseek-V3 ( vllm-project#11930 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Update benchmark_prefix_caching.py fixed example usage ( vllm-project#11920 )\n\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\n\n* [Bugfix] Check that number of images matches number of <|image|> tokens with mllama ( vllm-project#11939 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\n\n* [mypy] Fix mypy warnings in api_server.py ( vllm-project#11941 )\n\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\n\n* [ci] fix broken distributed-tests-4-gpus ( vllm-project#11937 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][SpecDecode] Adjust Eagle model architecture to align with intended design ( vllm-project#11672 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Bugfix] fused_experts_impl wrong compute type for float32 ( vllm-project#11921 )\n\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\n\n* [CI/Build] Move model-specific multi-modal processing tests ( vllm-project#11934 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Basic guide for writing unit tests for new models ( vllm-project#11951 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix RobertaModel loading ( vllm-project#11940 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Model] Add cogagent model support vLLM ( vllm-project#11742 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* Using list\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* Docs lint\n\n* linter formatting bug fixes\n\n* inherit config file updates under fused_moe from main branch.\n\n* match tests for the MOE layers with main.\n\n---------\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Jiaxin Shan <seedjeffwan@gmail.com>\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Alex He <alehe@amd.com>\nSigned-off-by: ccjincong <chenjincong11@gmail.com>\nSigned-off-by: Erez Schwartz <erezs@ai21.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: rajveerb <46040700+rajveerb@users.noreply.github.com>\nSigned-off-by: hjwei <hjwei_xd@163.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nSigned-off-by: ApostaC <yihua98@uchicago.edu>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Kazuhiro Serizawa <nserihiro@gmail.com>\nSigned-off-by: Tobias Pitters <tobias.pitters@gmail.com>\nSigned-off-by: Kathy Yu <feiyangyu@google.com>\nSigned-off-by: bjmsong <bjmsong@126.com>\nSigned-off-by: wchen61 <wchen61@foxmail.com>\nSigned-off-by: ZincCat <zincchloride@outlook.com>\nSigned-off-by: xcnick <xcnick0412@gmail.com>\nSigned-off-by: Yan Burman <yanburman@users.noreply.github.com>\nSigned-off-by: Ido Asraff <idoa@atero.ai>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Suraj Deshmukh <surajd.service@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Jiaxin Shan <seedjeffwan@gmail.com>\nCo-authored-by: Lucas Tucker <47258766+lucas-tucker@users.noreply.github.com>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: HandH1998 <1335248067@qq.com>\nCo-authored-by: robertgshaw2-neuralmagic <rshaw@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: AlexHe99 <alehe@amd.com>\nCo-authored-by: Chen1022 <112855051+ccjincong@users.noreply.github.com>\nCo-authored-by: ErezSC42 <erezs@ai21.com>\nCo-authored-by: Selali <selali.adobor@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Rajveer Bachkaniwala <46040700+rajveerb@users.noreply.github.com>\nCo-authored-by: hj-wei <hjwei_xd@163.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: whyiug <whyiug@hotmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Matthias Vogler <60004995+ayylemao@users.noreply.github.com>\nCo-authored-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nCo-authored-by: John Giorgi <johnmgiorgi@gmail.com>\nCo-authored-by: sakunkun <zhou.qianjun@zte.com.cn>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Yihua Cheng <yihua98@uchicago.edu>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Kazuhiro Serizawa <nserihiro@gmail.com>\nCo-authored-by: Tobias Pitters <31857876+CloseChoice@users.noreply.github.com>\nCo-authored-by: Chunyang Wen <chunyang.wen@gmail.com>\nCo-authored-by: Kathy Yu <143133934+kathyyu-google@users.noreply.github.com>\nCo-authored-by: bjmsong <wq.songbob@gmail.com>\nCo-authored-by: bjmsong <bjmsong@126.com>\nCo-authored-by: wchen61 <wchen61@foxmail.com>\nCo-authored-by: Nathan Azrak <42650258+nathan-az@users.noreply.github.com>\nCo-authored-by: Sachin Varghese <sachin.mathew31@gmail.com>\nCo-authored-by: Aurick Qiao <aurickq@users.noreply.github.com>\nCo-authored-by: Aurick Qiao <aurick.qiao@snowflake.com>\nCo-authored-by: ZincCat <52513999+zinccat@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Hust_YangXian <bryceyx@gmail.com>\nCo-authored-by: Alberto Ferrer <albertof@barrahome.org>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: xcnick <xcnick0412@gmail.com>\nCo-authored-by: Yan Burman <yanburman@users.noreply.github.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Lancer <402430575@qq.com>\nCo-authored-by: Lancer <maruixiang6688@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Suraj Deshmukh <surajd.service@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Yida Wu <yidawu@amd.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> Isotr0py pushed a commit\n        to Isotr0py/vllm\n      that referenced\n      this pull request Feb 2, 2025 [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup fâ€¦ â€¦ c4e6079 â€¦or int8 models ( vllm-project#11698 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Isotr0py <2037008807@qq.com> mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup fâ€¦ â€¦ 5d97676 â€¦or int8 models ( vllm-project#11698 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:15", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: latency, latency, TPOT | SERVING: Serving, serving, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:15", "models": ["Qwen/Qwen2-7B-Instruct", "microsoft/Phi-3-medium-128k-instruct", "meta-llama/Meta-Llama-3.1-8B-Instruct", "mistralai/Mistral-7B-Instruct-v0.3"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_latency.py --dtype bfloat16 --enable-chunked-prefill False --load-format dummy --batch-size BS --num-iters-warmup 2 --num-iters 5 --input-len INPUT_LEN --output-len OUTPUT_LEN --model MODEL", "commit_subject": "[Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models (#11698)", "commit_message": "[Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models (#11698)\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>", "commit_date": "2025-01-08T20:23:15Z", "files_changed": ["vllm/model_executor/layers/quantization/compressed_tensors/triton_scaled_mm.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 17, "num_non_test_edited_lines": 17, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/quantization/compressed_tensors/triton_scaled_mm.py b/vllm/model_executor/layers/quantization/compressed_tensors/triton_scaled_mm.py\nindex 3ff162170..2659afcdc 100644\n--- a/vllm/model_executor/layers/quantization/compressed_tensors/triton_scaled_mm.py\n+++ b/vllm/model_executor/layers/quantization/compressed_tensors/triton_scaled_mm.py\n@@ -128,7 +128,8 @@ def triton_scaled_mm(input: torch.Tensor,\n                      bias: Optional[torch.Tensor] = None,\n                      block_size_m: int = 32,\n                      block_size_n: int = 32,\n-                     block_size_k: int = 32) -> torch.Tensor:\n+                     block_size_k: int = 32,\n+                     use_heuristic=True) -> torch.Tensor:\n     M, K = input.shape\n     N = weight.shape[1]\n \n@@ -152,6 +153,20 @@ def triton_scaled_mm(input: torch.Tensor,\n \n     has_scalar = lambda x: x.shape[0] == 1 and x.shape[1] == 1\n \n+    if use_heuristic:\n+        is_small_N = N < 8192\n+        next_power_of_2_M = max(32, triton.next_power_of_2(M))\n+        if next_power_of_2_M <= 32:\n+            tile_shape = (64, 64, 256) if is_small_N else (64, 128, 256)\n+        elif next_power_of_2_M <= 64:\n+            tile_shape = (64, 64, 256)\n+        elif next_power_of_2_M <= 128:\n+            tile_shape = (64, 128, 128)\n+        else:\n+            tile_shape = (128, 128, 128)\n+\n+    block_size_m, block_size_n, block_size_k = tile_shape\n+\n     block_size_sa = 1 if has_scalar(scale_a) else block_size_m\n     block_size_sb = 1 if has_scalar(scale_b) else block_size_n", "apis": ["triton_scaled_mm"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/compressed_tensors/triton_scaled_mm.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file by adding a block size heuristic (using a new parameter \"use_heuristic\" and tile_shape logic) that directly changes the behavior of the matrix multiplication routine in a performance-critical section. The commit message explicitly mentions a 2.8x speedup for int8 models, indicating that the changes are aimed at performance optimization rather than merely fixing a bug, performing refactoring, or adding new features. The modifications affect CPU operations and the overall performance of a high-level API related component. Hence, it satisfies the performance or optimization commit criteria.", "llm_api_reason": "The commit modifies the function in the file triton_scaled_mm.py, adding a new parameter (use_heuristic) and corresponding heuristic logic to adjust the block sizes dynamically based on the tensor dimensions. This change directly affects the public function triton_scaled_mm, which is used to perform the scaled matrix multiplication kernel computations via Triton."}
{"commit_hash": "b55ed6ef8ab0dce7fb0f79ff292dafdb4d22610c", "pr_url": "https://github.com/vllm-project/vllm/pull/11692", "pr_date": "2025-01-02", "timeline_text": "Copy link Collaborator WoosukKwon commented Jan 2, 2025 Currently, we don't consider the actual lengths in copying rows of token_ids_cpu . This small PR optimizes it by tracking the actual lengths. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [V1][Minor] Optimize token_ids_cpu copy â€¦ 5ecf50a Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jan 2, 2025 WoosukKwon requested review from robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners January 2, 2025 16:43 Copy link github-actions bot commented Jan 2, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac approved these changes Jan 2, 2025 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin approved these changes Jan 2, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Clear improvement Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details mgoin merged commit b55ed6e into main Jan 2, 2025 65 of 66 checks passed Uh oh! There was an error while loading. Please reload this page . mgoin deleted the v1-token-ids branch January 2, 2025 19:05 hongxiayang pushed a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Jan 15, 2025 [MFM-20250115] Merge from ROCm/main to llama_fp8 ( #360 ) â€¦ d9385b4 * [Misc] Move weights mapper ( vllm-project#11443 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Fix issues in CPU build Dockerfile. Fixes vllm-project#9182 ( vllm-project#11435 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Model] Automatic conversion of classification and reward models ( vllm-project#11469 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Unify VLLM_ENABLE_V1_MULTIPROCESSING handling in RayExecutor ( vllm-project#11472 )\n\n* [Misc] Update disaggregation benchmark scripts and test logs ( vllm-project#11456 )\n\nSigned-off-by: Jiaxin Shan <seedjeffwan@gmail.com>\n\n* [Frontend] Enable decord to load video from base64 ( vllm-project#11492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Improve GitHub links ( vllm-project#11491 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Move some multimodal utils to modality-specific modules ( vllm-project#11494 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Mypy checking for vllm/compilation ( vllm-project#11496 )\n\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\n\n* [Misc][LoRA] Fix LoRA weight mapper ( vllm-project#11495 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Doc] Add `QVQ` and `QwQ` to the list of supported models ( vllm-project#11509 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1] Adding min tokens/repetition/presence/frequence penalties to V1 sampler ( vllm-project#10681 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Model]  Modify MolmoForCausalLM MLP  ( vllm-project#11510 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Add placeholder module ( vllm-project#11501 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Add video example to openai client for multimodal ( vllm-project#11521 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [1/N] API Server  (Remove Proxy) ( vllm-project#11529 )\n\n* [Model] [Quantization] Support deepseek_v3 w8a8 fp8 block-wise quantization ( vllm-project#11523 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: HandH1998 <1335248067@qq.com>\n\n* [2/N] API Server: Avoid ulimit footgun ( vllm-project#11530 )\n\n* Deepseek v3 ( vllm-project#11502 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: robertgshaw2-neuralmagic <rshaw@neuralmagic.com>\n\n* [Docs] Document Deepseek V3 support ( vllm-project#11535 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* Update openai_compatible_server.md ( vllm-project#11536 )\n\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [V1] Use FlashInfer Sampling Kernel for Top-P & Top-K Sampling ( vllm-project#11394 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Fix yapf ( vllm-project#11538 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [CI] Fix broken CI ( vllm-project#11543 )\n\n* [misc] fix typing ( vllm-project#11540 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1][3/N] API Server: Reduce Task Switching + Handle Abort Properly ( vllm-project#11534 )\n\n* [BugFix] Fix quantization for all other methods ( vllm-project#11547 )\n\n* [Platform] Move model arch check to platform ( vllm-project#11503 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* Update deploying_with_k8s.md with AMD ROCm GPU example ( vllm-project#11465 )\n\nSigned-off-by: Alex He <alehe@amd.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix] Fix TeleChat2ForCausalLM weights mapper ( vllm-project#11546 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Abstract the logic for reading and writing media content ( vllm-project#11527 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc]  Add xgrammar in doc ( vllm-project#11549 )\n\nSigned-off-by: ccjincong <chenjincong11@gmail.com>\n\n* [VLM] Support caching in merged multi-modal processor ( vllm-project#11396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MODEL] LoRA support for Jamba model ( vllm-project#11209 )\n\nSigned-off-by: Erez Schwartz <erezs@ai21.com>\n\n* [Misc]Add BNB quantization for MolmoForCausalLM  ( vllm-project#11551 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Improve BNB loader to handle mixture of sharded and merged weights with same suffix ( vllm-project#11566 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Bugfix] Fix for ROCM compressed tensor support ( vllm-project#11561 )\n\n* [Doc] Update mllama example based on official doc ( vllm-project#11567 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [V1] [4/N] API Server: ZMQ/MP Utilities ( vllm-project#11541 )\n\n* [Bugfix] Last token measurement fix ( vllm-project#11376 )\n\nSigned-off-by: rajveerb <46040700+rajveerb@users.noreply.github.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Model] Support InternLM2 Reward models ( vllm-project#11571 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Model] Remove hardcoded image tokens ids from Pixtral ( vllm-project#11582 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Hardware][AMD]: Replace HIPCC version with more precise ROCm version ( vllm-project#11515 )\n\nSigned-off-by: hjwei <hjwei_xd@163.com>\n\n* [V1][Minor] Set pin_memory=False for token_ids_cpu tensor ( vllm-project#11581 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Doc] Minor documentation fixes ( vllm-project#11580 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [bugfix] interleaving sliding window for cohere2 model ( vllm-project#11583 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] [5/N] API Server: unify `Detokenizer` and  `EngineCore` input ( vllm-project#11545 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Doc] Convert list tables to MyST ( vllm-project#11594 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [v1][bugfix] fix cudagraph with inplace buffer assignment ( vllm-project#11596 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] KV cache transfer connector registry ( vllm-project#11481 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Remove print statement in DeepseekScalingRotaryEmbedding ( vllm-project#11604 )\n\n* [v1] fix compilation cache ( vllm-project#11598 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docker] bump up neuron sdk v2.21 ( vllm-project#11593 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Build][Kernel] Update CUTLASS to v3.6.0 ( vllm-project#11607 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build][CPU] Fix CPU CI by lazy importing triton FP8 kernels ( vllm-project#11618 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [platforms] enable platform plugins ( vllm-project#11602 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Abstract out multi-modal data parsing in merged processor ( vllm-project#11620 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] [6/N] API Server: Better Shutdown ( vllm-project#11586 )\n\n* [Bugfix] Validate and concatenate image embeddings in MiniCPMVBaseModel ( vllm-project#11631 )\n\n* [benchmark] Remove dependency for H100 benchmark step ( vllm-project#11572 )\n\n* [Model][LoRA]LoRA support added for MolmoForCausalLM ( vllm-project#11439 )\n\nSigned-off-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Fix OpenAI parallel sampling when using xgrammar ( vllm-project#11637 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc][LoRA] Support Rank Stabilized LoRA (RSLoRA) ( vllm-project#6909 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Move the _touch(computed_blocks) call in the allocate_slots method to after the check for allocating new blocks. ( vllm-project#11565 )\n\n* [V1] Simpify vision block hash for prefix caching by removing offset from hash ( vllm-project#11646 )\n\n* [V1][VLM] V1 support for selected single-image models. ( vllm-project#11632 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Benchmark] Add benchmark script for CPU offloading  ( vllm-project#11533 )\n\nSigned-off-by: ApostaC <yihua98@uchicago.edu>\nCo-authored-by: KuntaiDu <kuntai@uchicago.edu>\n\n* [Bugfix][Refactor] Unify model management in frontend ( vllm-project#11660 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [VLM] Add max-count checking in data parser for single image models ( vllm-project#11661 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Optimize Qwen2-VL LoRA test ( vllm-project#11663 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Misc] Replace space with - in the file names ( vllm-project#11667 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Fix typo ( vllm-project#11666 )\n\nSigned-off-by: Kazuhiro Serizawa <nserihiro@gmail.com>\n\n* [V1] Implement Cascade Attention ( vllm-project#11635 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [VLM] Move supported limits and max tokens to merged multi-modal processor ( vllm-project#11669 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [VLM][Bugfix] Multi-modal processor compatible with V1 multi-input ( vllm-project#11674 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [mypy] Pass type checking in vllm/inputs ( vllm-project#11680 )\n\nSigned-off-by: Tobias Pitters <tobias.pitters@gmail.com>\n\n* [VLM] Merged multi-modal processor for LLaVA-NeXT ( vllm-project#11682 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* According to vllm.EngineArgs, the name should be distributed_executor_backend ( vllm-project#11689 )\n\n* [Bugfix] Free cross attention block table for preempted-for-recompute sequence group. ( vllm-project#10013 )\n\nSigned-off-by: Kathy Yu <feiyangyu@google.com>\n\n* [V1][Minor] Optimize token_ids_cpu copy ( vllm-project#11692 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Change kv scaling factor by param json on nvidia gpu ( vllm-project#11688 )\n\nSigned-off-by: bjmsong <bjmsong@126.com>\nCo-authored-by: bjmsong <bjmsong@126.com>\n\n* Resolve race conditions in Marlin kernel ( vllm-project#11493 )\n\nSigned-off-by: wchen61 <wchen61@foxmail.com>\n\n* [Misc] Minimum requirements for SageMaker compatibility ( vllm-project#11576 )\n\n* Update default max_num_batch_tokens for chunked prefill ( vllm-project#11694 )\n\n* [Bugfix] Check chain_speculative_sampling before calling it ( vllm-project#11673 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [perf-benchmark] Fix dependency for steps in benchmark pipeline ( vllm-project#11710 )\n\n* [Model] Whisper model implementation ( vllm-project#11280 )\n\nCo-authored-by: Aurick Qiao <aurick.qiao@snowflake.com>\n\n* [V1] Simplify Shutdown ( vllm-project#11659 )\n\n* [Bugfix] Fix ColumnParallelLinearWithLoRA slice ( vllm-project#11708 )\n\nSigned-off-by: ZincCat <zincchloride@outlook.com>\n\n* [V1] Improve TP>1 Error Handling + Stack Trace ( vllm-project#11721 )\n\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Misc]Add BNB quantization for Qwen2VL ( vllm-project#11719 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* Update requirements-tpu.txt to support python 3.9 and 3.11 ( vllm-project#11695 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [V1] Chore: cruft removal ( vllm-project#11724 )\n\n* [V1] log GPU blocks num for MultiprocExecutor ( vllm-project#11656 )\n\n* Update tool_calling.md ( vllm-project#11701 )\n\n* Update bnb.md with example for OpenAI ( vllm-project#11718 )\n\n* [V1] Add `RayExecutor` support for `AsyncLLM` (api server) ( vllm-project#11712 )\n\n* [V1] Add kv cache utils tests. ( vllm-project#11513 )\n\nSigned-off-by: xcnick <xcnick0412@gmail.com>\n\n* [Core][Bugfix] Use correct device to initialize GPU data during CUDA-graph-capture ( vllm-project#11233 )\n\nSigned-off-by: Yan Burman <yanburman@users.noreply.github.com>\nSigned-off-by: Ido Asraff <idoa@atero.ai>\n\n* [VLM] Merged multi-modal processors for LLaVA-NeXT-Video and LLaVA-OneVision ( vllm-project#11717 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix precision error in LLaVA-NeXT ( vllm-project#11735 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Remove unnecessary weight initialization logic ( vllm-project#11736 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Bugfix][V1] Fix test_kv_cache_utils.py ( vllm-project#11738 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [MISC] Replace c10::optional with std::optional ( vllm-project#11730 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [distributed] remove pynccl's redundant stream ( vllm-project#11744 )\n\n* fix: [doc] fix typo ( vllm-project#11751 )\n\nCo-authored-by: Lancer <maruixiang6688@gmail.com>\n\n* [Frontend] Improve `StreamingResponse` Exception Handling ( vllm-project#11752 )\n\n* [distributed] remove pynccl's redundant change_state ( vllm-project#11749 )\n\n* [Doc] [1/N] Reorganize Getting Started section ( vllm-project#11645 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Remove block size constraint ( vllm-project#11723 )\n\n* [V1] Add BlockTable class ( vllm-project#11693 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Misc] Fix typo for valid_tool_parses  ( vllm-project#11753 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [V1] Refactor get_executor_cls ( vllm-project#11754 )\n\n* [mypy] Forward pass function type hints in lora ( vllm-project#11740 )\n\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\n\n* k8s-config: Update the secret to use stringData ( vllm-project#11679 )\n\nSigned-off-by: Suraj Deshmukh <surajd.service@gmail.com>\n\n* [VLM] Separate out profiling-related logic ( vllm-project#11746 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc][2/N] Reorganize Models and Usage sections ( vllm-project#11755 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix max image size for LLaVA-Onevision ( vllm-project#11769 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] explain how to add interleaving sliding window support ( vllm-project#11771 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][V1] Fix molmo text-only inputs ( vllm-project#11676 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Kernel] Move attn_type to Attention.__init__() ( vllm-project#11690 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* format\n\n* [V1] Extend beyond image modality and support mixed-modality inference with Llava-OneVision ( vllm-project#11685 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* deepseek overflow fix ( #349 )\n\n* [Bugfix] Fix LLaVA-NeXT feature size precision error (for real) ( vllm-project#11772 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] Future-proof Qwen2-Audio multi-modal processor ( vllm-project#11776 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [XPU] Make pp group initilized for pipeline-parallelism ( vllm-project#11648 )\n\nSigned-off-by: yisheng <yi.sheng@intel.com>\n\n* [Doc][3/N] Reorganize Serving section ( vllm-project#11766 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Kernel][LoRA]Punica prefill  kernels fusion ( vllm-project#11234 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\n\n* [Bugfix] Update attention interface in `Whisper` ( vllm-project#11784 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI] Fix neuron CI and run offline tests ( vllm-project#11779 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* fix init error for MessageQueue when n_local_reader is zero ( vllm-project#11768 )\n\n* [Doc] Create a vulnerability management team ( vllm-project#9925 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [CI][CPU] adding build number to docker image name ( vllm-project#11788 )\n\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\n\n* [V1][Doc] Update V1 support for `LLaVa-NeXT-Video` ( vllm-project#11798 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix] Comprehensively test and fix LLaVA-NeXT feature size calculation ( vllm-project#11800 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] add doc to explain how to use uv ( vllm-project#11773 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] Support audio language models on V1 ( vllm-project#11733 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [doc] update how pip can install nightly wheels ( vllm-project#11806 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Add note to `gte-Qwen2` models ( vllm-project#11808 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [optimization] remove python function call for custom op ( vllm-project#11750 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] update the prefix for qwen2 ( vllm-project#11795 )\n\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\n\n* [Doc]Add documentation for using EAGLE in vLLM ( vllm-project#11417 )\n\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\n\n* [Bugfix] Significant performance drop on CPUs with --num-scheduler-steps > 1 ( vllm-project#11794 )\n\n* [Doc] Group examples into categories ( vllm-project#11782 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix image input for Pixtral-HF ( vllm-project#11741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] sort torch profiler table by kernel timing ( vllm-project#11813 )\n\n* Remove the duplicate imports of MultiModalKwargs and PlaceholderRangeâ€¦ ( vllm-project#11824 )\n\n* Fixed docker build for ppc64le ( vllm-project#11518 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* [OpenVINO] Fixed Docker.openvino build ( vllm-project#11732 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [Bugfix] Add checks for LoRA and CPU offload ( vllm-project#11810 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Docs] reorganize sponsorship page ( vllm-project#11639 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [Bug] Fix pickling of `ModelConfig` when RunAI Model Streamer is used ( vllm-project#11825 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [misc] improve memory profiling ( vllm-project#11809 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [doc] update wheels url ( vllm-project#11830 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Docs] Update sponsor name: 'Novita' to 'Novita AI' ( vllm-project#11833 )\n\n* [Hardware][Apple] Native support for macOS Apple Silicon ( vllm-project#11696 )\n\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\n\n* [torch.compile] consider relevant code in compilation cache ( vllm-project#11614 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Reorganize profiling/processing-related code ( vllm-project#11812 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples into categories ( vllm-project#11840 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc][4/N] Reorganize API Reference ( vllm-project#11843 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build][Bugfix] Fix CPU CI image clean up ( vllm-project#11836 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Bugfix][XPU] fix silu_and_mul ( vllm-project#11823 )\n\nSigned-off-by: yan ma <yan.ma@intel.com>\n\n* [Misc] Move some model utils into vision file ( vllm-project#11848 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Expand Multimodal API Reference ( vllm-project#11852 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc]add some explanations for BlockHashType ( vllm-project#11847 )\n\n* [TPU][Quantization] TPU `W8A8` ( vllm-project#11785 )\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Kernel][Triton][AMD] Use block size heuristic for avg 2.8x speedup for int8 models ( vllm-project#11698 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* [Docs] Add Google Cloud Meetup ( vllm-project#11864 )\n\n* Revert nccl changes ( #351 )\n\n* Revert \"[distributed] remove pynccl's redundant change_state ( vllm-project#11749 )\"\n\nThis reverts commit 9e764e7 .\n\n* Revert \"[distributed] remove pynccl's redundant stream ( vllm-project#11744 )\"\n\nThis reverts commit 635b897 .\n\n* [CI] Turn on basic correctness tests for V1 ( vllm-project#10864 )\n\n* treat do_lower_case in the same way as the sentence-transformers library ( vllm-project#11815 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\n\n* [Doc] Recommend uv and python 3.12 for quickstart guide ( vllm-project#11849 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [Misc] Move `print_*_once` from utils to logger ( vllm-project#11298 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\n\n* [Doc] Intended links Python multiprocessing library ( vllm-project#11878 )\n\n* [perf]fix current stream ( vllm-project#11870 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Override dunder methods of placeholder modules ( vllm-project#11882 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] fix beam search input errors and latency benchmark script ( vllm-project#11875 )\n\nSigned-off-by: Ye Qi <yeq@meta.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\n\n* [Doc] Add model development API Reference ( vllm-project#11884 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] Allow platform specify attention backend ( vllm-project#11609 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\n\n* [ci]try to fix flaky multi-step tests ( vllm-project#11894 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Provide correct Pixtral-HF chat template ( vllm-project#11891 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* fp8 support ( #352 )\n\nCo-authored-by: Yida Wu <yidawu@amd.com>\n\n* [Docs] Add Modal to deployment frameworks ( vllm-project#11907 )\n\n* [Doc][5/N] Move Community and API Reference to the bottom ( vllm-project#11896 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [VLM] Enable tokenized inputs for merged multi-modal processor ( vllm-project#11900 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Show default pooling method in a table ( vllm-project#11904 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [torch.compile] Hide KV cache behind torch.compile boundary ( vllm-project#11677 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Bugfix] Validate lora adapters to avoid crashing server ( vllm-project#11727 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [BUGFIX] Fix `UnspecifiedPlatform` package name ( vllm-project#11916 )\n\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\n\n* [ci] fix gh200 tests ( vllm-project#11919 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [misc] remove python function call for custom activation op ( vllm-project#11885 )\n\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [platform] support pytorch custom op pluggable ( vllm-project#11328 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* Replace \"online inference\" with \"online serving\" ( vllm-project#11923 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [ci] Fix sampler tests ( vllm-project#11922 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] [1/N] Initial guide for merged multi-modal processor ( vllm-project#11925 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [platform] support custom torch.compile backend key ( vllm-project#11318 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Rename offline inference examples ( vllm-project#11927 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Fix docstring in `get_ip` function ( vllm-project#11932 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* Doc fix in `benchmark_long_document_qa_throughput.py` ( vllm-project#11933 )\n\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\n\n* [Hardware][CPU] Support MOE models on x86 CPU ( vllm-project#11831 )\n\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\n\n* [Misc] Clean up debug code in Deepseek-V3 ( vllm-project#11930 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Update benchmark_prefix_caching.py fixed example usage ( vllm-project#11920 )\n\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\n\n* [Bugfix] Check that number of images matches number of <|image|> tokens with mllama ( vllm-project#11939 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\n\n* [mypy] Fix mypy warnings in api_server.py ( vllm-project#11941 )\n\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\n\n* [ci] fix broken distributed-tests-4-gpus ( vllm-project#11937 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix][SpecDecode] Adjust Eagle model architecture to align with intended design ( vllm-project#11672 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Bugfix] fused_experts_impl wrong compute type for float32 ( vllm-project#11921 )\n\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\n\n* [CI/Build] Move model-specific multi-modal processing tests ( vllm-project#11934 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Basic guide for writing unit tests for new models ( vllm-project#11951 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix RobertaModel loading ( vllm-project#11940 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Model] Add cogagent model support vLLM ( vllm-project#11742 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [V1] Avoid sending text prompt to core engine ( vllm-project#11963 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [CI/Build] Add markdown linter ( vllm-project#11857 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Model] Initialize support for Deepseek-VL2 models ( vllm-project#11578 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Hardware][CPU] Multi-LoRA implementation for the CPU backend ( vllm-project#11100 )\n\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] workaround fix for MoE on TPU ( vllm-project#11764 )\n\n* [V1][Core][1/n] Logging and Metrics ( vllm-project#11962 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [Model] Support GGUF models newly added in `transformers` 4.46.0 ( vllm-project#9685 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [V1] [2/n] Logging and Metrics - `OutputProcessor` Abstraction ( vllm-project#11973 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [MISC] fix typo in kv transfer send recv test ( vllm-project#11983 )\n\n* [Bug] Fix usage of `.transpose()` and `.view()` consecutively. ( vllm-project#11979 )\n\n* [CI][Spec Decode] fix: broken test for EAGLE model ( vllm-project#11972 )\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\n\n* [Misc] Fix Deepseek V2 fp8 kv-scale remapping ( vllm-project#11947 )\n\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\n\n* [Misc]Minor Changes about Worker ( vllm-project#11555 )\n\nSigned-off-by: Chenguang Li <757486878@qq.com>\n\n* [platform] add ray_device_key ( vllm-project#11948 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix Max Token ID for Qwen-VL-Chat ( vllm-project#11980 )\n\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\n\n* [Kernel] unified_attention for Attention.forward ( vllm-project#11967 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc][V1] Update model implementation guide for V1 support ( vllm-project#11998 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [Doc] Organise installation documentation into categories and tabs ( vllm-project#11935 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [platform] add device_control env var ( vllm-project#12009 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Platform] Move get_punica_wrapper() function to Platform ( vllm-project#11516 )\n\nSigned-off-by: Shanshan Shen <467638484@qq.com>\n\n* bugfix: Fix signature mismatch in benchmark's `get_tokenizer` function ( vllm-project#11982 )\n\nSigned-off-by: elijah <f1renze.142857@gmail.com>\n\n* Using list\n\n* Revert \"[misc] improve memory profiling ( vllm-project#11809 )\"\n\nThis reverts commit 889e662 .\n\n* Multi-lingual P3L ( #356 )\n\n* Commiting the *multilingual* P3L test.\n\n* Created a *multi-lingual* P3L test.\n\n* Making ruff happy.\n\n* .\n\n* Added a reference to the language-scripture Confluence table.\n\n* Typo fixing.\n\n* Harmonizing naming.\n\n* Fixing comments in the header.\n\n---------\n\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n* Trying to make scales work with compileable attention\n\n* Docs lint\n\n* linter formatting bug fixes\n\n* inherit config file updates under fused_moe from main branch.\n\n* match tests for the MOE layers with main.\n\n---------\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Jiaxin Shan <seedjeffwan@gmail.com>\nSigned-off-by: lucast2021 <lucast2021@headroyce.org>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Sourashis Roy <sroy@roblox.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Alex He <alehe@amd.com>\nSigned-off-by: ccjincong <chenjincong11@gmail.com>\nSigned-off-by: Erez Schwartz <erezs@ai21.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: rajveerb <46040700+rajveerb@users.noreply.github.com>\nSigned-off-by: hjwei <hjwei_xd@163.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: jiang1.li <jiang1.li@intel.com>\nSigned-off-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nSigned-off-by: ApostaC <yihua98@uchicago.edu>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Kazuhiro Serizawa <nserihiro@gmail.com>\nSigned-off-by: Tobias Pitters <tobias.pitters@gmail.com>\nSigned-off-by: Kathy Yu <feiyangyu@google.com>\nSigned-off-by: bjmsong <bjmsong@126.com>\nSigned-off-by: wchen61 <wchen61@foxmail.com>\nSigned-off-by: ZincCat <zincchloride@outlook.com>\nSigned-off-by: xcnick <xcnick0412@gmail.com>\nSigned-off-by: Yan Burman <yanburman@users.noreply.github.com>\nSigned-off-by: Ido Asraff <idoa@atero.ai>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Suraj Deshmukh <surajd.service@gmail.com>\nSigned-off-by: yisheng <yi.sheng@intel.com>\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Zhou <yuan.zhou@intel.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: Wallas Santos <wallashss@ibm.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nSigned-off-by: Ye Qi <yeq@meta.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: Kuntai Du <kuntai@uchicago.edu>\nSigned-off-by: Ren MinMin <renmm6@chinaunicom.cn>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Fred Reiss <frreiss@us.ibm.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nSigned-off-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Akshat Tripathi <akshat@krai.ai>\nSigned-off-by: Oleg Mosalov <oleg@krai.ai>\nSigned-off-by: Yida Wu <yidawu@alumni.cmu.edu>\nSigned-off-by: Chenguang Li <757486878@qq.com>\nSigned-off-by: Alex-Brooks <Alex.brooks@ibm.com>\nSigned-off-by: Shanshan Shen <467638484@qq.com>\nSigned-off-by: elijah <f1renze.142857@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Jiaxin Shan <seedjeffwan@gmail.com>\nCo-authored-by: Lucas Tucker <47258766+lucas-tucker@users.noreply.github.com>\nCo-authored-by: lucast2021 <lucast2021@headroyce.org>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: HandH1998 <1335248067@qq.com>\nCo-authored-by: robertgshaw2-neuralmagic <rshaw@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: AlexHe99 <alehe@amd.com>\nCo-authored-by: Chen1022 <112855051+ccjincong@users.noreply.github.com>\nCo-authored-by: ErezSC42 <erezs@ai21.com>\nCo-authored-by: Selali <selali.adobor@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Rajveer Bachkaniwala <46040700+rajveerb@users.noreply.github.com>\nCo-authored-by: hj-wei <hjwei_xd@163.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: whyiug <whyiug@hotmail.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Matthias Vogler <60004995+ayylemao@users.noreply.github.com>\nCo-authored-by: Matthias Vogler <matthias.vogler@joesecurity.org>\nCo-authored-by: John Giorgi <johnmgiorgi@gmail.com>\nCo-authored-by: sakunkun <zhou.qianjun@zte.com.cn>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Yihua Cheng <yihua98@uchicago.edu>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Kazuhiro Serizawa <nserihiro@gmail.com>\nCo-authored-by: Tobias Pitters <31857876+CloseChoice@users.noreply.github.com>\nCo-authored-by: Chunyang Wen <chunyang.wen@gmail.com>\nCo-authored-by: Kathy Yu <143133934+kathyyu-google@users.noreply.github.com>\nCo-authored-by: bjmsong <wq.songbob@gmail.com>\nCo-authored-by: bjmsong <bjmsong@126.com>\nCo-authored-by: wchen61 <wchen61@foxmail.com>\nCo-authored-by: Nathan Azrak <42650258+nathan-az@users.noreply.github.com>\nCo-authored-by: Sachin Varghese <sachin.mathew31@gmail.com>\nCo-authored-by: Aurick Qiao <aurickq@users.noreply.github.com>\nCo-authored-by: Aurick Qiao <aurick.qiao@snowflake.com>\nCo-authored-by: ZincCat <52513999+zinccat@users.noreply.github.com>\nCo-authored-by: WangErXiao <863579016@qq.com>\nCo-authored-by: Hust_YangXian <bryceyx@gmail.com>\nCo-authored-by: Alberto Ferrer <albertof@barrahome.org>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: xcnick <xcnick0412@gmail.com>\nCo-authored-by: Yan Burman <yanburman@users.noreply.github.com>\nCo-authored-by: cennn <61925104+cennn@users.noreply.github.com>\nCo-authored-by: Lancer <402430575@qq.com>\nCo-authored-by: Lancer <maruixiang6688@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Suraj Deshmukh <surajd.service@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Concurrensee <yida.wu@amd.com>\nCo-authored-by: YiSheng5 <yi.sheng@intel.com>\nCo-authored-by: Zhonghua Deng <abatom@163.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan <yuan.zhou@intel.com>\nCo-authored-by: jiangjiadi <34134495+jiangjiadi@users.noreply.github.com>\nCo-authored-by: jiadi.jjd <jiadi.jjd@antgroup.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Wallas Henrique <wallashss@users.noreply.github.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Maxime Fournioux <55544262+mfournioux@users.noreply.github.com>\nCo-authored-by: Guspan Tanadi <36249910+guspan-tanadi@users.noreply.github.com>\nCo-authored-by: Ye (Charlotte) Qi <ye.charlotte.qi@gmail.com>\nCo-authored-by: yeq <yeq@devgpu004.lla3.facebook.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Yida Wu <yidawu@amd.com>\nCo-authored-by: Charles Frye <cfrye59@gmail.com>\nCo-authored-by: minmin <rmm0811@gmail.com>\nCo-authored-by: Ren MinMin <renmm6@chinaunicom.cn>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Fred Reiss <frreiss@us.ibm.com>\nCo-authored-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com>\nCo-authored-by: shaochangxu <85155497+shaochangxu@users.noreply.github.com>\nCo-authored-by: shaochangxu.scx <shaochangxu.scx@antgroup.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: sixgod <evethwillbeok@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Akshat Tripathi <Akshat.tripathi6568@gmail.com>\nCo-authored-by: Oleg Mosalov <oleg@krai.ai>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: Yangcheng Li <liyangcheng.lyc@alibaba-inc.com>\nCo-authored-by: Siyuan Li <94890248+liaoyanqing666@users.noreply.github.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: elijah <30852919+e1ijah1@users.noreply.github.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Alexei V. Ivanov <alivanov@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [V1][Minor] Optimize token_ids_cpu copy ( vllm-project#11692 ) â€¦ b6d0272 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:18", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: latency, optimization, speedup | SERVING: Serving, serving, API Server | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:18", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][Minor] Optimize token_ids_cpu copy (#11692)", "commit_message": "[V1][Minor] Optimize token_ids_cpu copy (#11692)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2025-01-02T12:04:58-07:00", "files_changed": ["vllm/v1/worker/gpu_input_batch.py", "vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 4, "num_edited_lines": 14, "num_non_test_edited_lines": 14, "commit_year": 2025}, "diff_text": "diff --git a/vllm/v1/worker/gpu_input_batch.py b/vllm/v1/worker/gpu_input_batch.py\nindex e79145300..f8a1427c6 100644\n--- a/vllm/v1/worker/gpu_input_batch.py\n+++ b/vllm/v1/worker/gpu_input_batch.py\n@@ -66,8 +66,9 @@ class InputBatch:\n             pin_memory=False,\n         )\n         self.token_ids_cpu = self.token_ids_cpu_tensor.numpy()\n-        self.num_computed_tokens_cpu = np.empty(max_num_reqs, dtype=np.int32)\n+        self.num_tokens = np.zeros(max_num_reqs, dtype=np.int32)\n         self.num_prompt_tokens = np.zeros(max_num_reqs, dtype=np.int32)\n+        self.num_computed_tokens_cpu = np.empty(max_num_reqs, dtype=np.int32)\n \n         # Attention-related.\n         self.block_table = torch.zeros(\n@@ -189,6 +190,7 @@ class InputBatch:\n         end_idx = start_idx + len(request.output_token_ids)\n         self.token_ids_cpu[req_index,\n                            start_idx:end_idx] = request.output_token_ids\n+        self.num_tokens[req_index] = request.num_tokens\n \n         self.num_computed_tokens_cpu[req_index] = request.num_computed_tokens\n         num_blocks = len(request.block_ids)\n@@ -290,14 +292,15 @@ class InputBatch:\n             self.req_ids[last_req_index] = None\n             self.req_id_to_index[req_id] = empty_index\n \n-            # TODO(woosuk): Optimize the copy of token_ids_cpu and\n-            # block_table_cpu.\n-            self.token_ids_cpu[empty_index] = self.token_ids_cpu[\n-                last_req_index]\n+            num_tokens = self.num_tokens[last_req_index]\n+            self.token_ids_cpu[empty_index, :num_tokens] = self.token_ids_cpu[\n+                last_req_index, :num_tokens]\n+            self.num_tokens[empty_index] = num_tokens\n             self.num_prompt_tokens[empty_index] = \\\n                 self.num_prompt_tokens[last_req_index]\n             self.num_computed_tokens_cpu[\n                 empty_index] = self.num_computed_tokens_cpu[last_req_index]\n+            # TODO(woosuk): Optimize the copy of block_table_cpu.\n             self.block_table_cpu[empty_index] = self.block_table_cpu[\n                 last_req_index]\n             self.temperature_cpu[empty_index] = self.temperature_cpu[\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 995de54e8..75098b033 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -644,6 +644,7 @@ class GPUModelRunner:\n                 # Append the sampled token to the output token ids.\n                 token_id = sampled_token_ids[i]\n                 self.input_batch.token_ids_cpu[i, seq_len] = token_id\n+                self.input_batch.num_tokens[i] += 1\n                 req_state.output_token_ids.append(token_id)\n             else:\n                 # Ignore the sampled token from the partial request.", "apis": ["InputBatch.add_request", "InputBatch.condense", "GPUModelRunner._update_states"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_input_batch.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies production source files (gpu_input_batch.py and gpu_model_runner.py) and implements a more efficient token copy operation by introducing and using a 'num_tokens' array to limit the number of elements copied, rather than copying entire buffers. This change is an optimization of an internal routine that is performance-critical (the copying of token data), and it directly affects the performance of CPU workloads without being a mere refactoring or bug fix. Thus, the commit qualifies as a performance optimization change.", "llm_api_reason": "This commit modifies tokenâ€management in the GPU input batch. In the file gpu_input_batch.py, a new numpy array â€œnum_tokensâ€ is initialized (and updated on add_request and during batch condensation) to record the overall number of tokens per request, and the copy logic in condense is updated so that when a batch entry is replaced the token count (as well as the token_ids buffer) is copied properly from the donor index. In gpu_model_runner.py, when a new token is sampled and appended to a requestâ€™s output token list, the corresponding num_tokens counter is incremented. These changes ensure that the total token count per request is updated and tracked correctly across batched operations."}
{"commit_hash": "f26c4aeecba481ce1445be7a998b0b97460a13bb", "pr_url": "https://github.com/vllm-project/vllm/pull/11275", "pr_date": null, "timeline_text": "Copy link Collaborator ruisearch42 commented Dec 18, 2024 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR optimizes ray worker initialization time. In the current code base, ray.get(worker.get_node_ip.remote()) is called for each worker right after we get its handle, and it takes ~3s. This call is expensive because when RayWorkerWrapper.remote() just returns, we get an actor handle, but the actor itself may not be fully initialized yet. At this time, any method call on the actor would need to wait for actor initialization to happen, which can take some time (~3s in this case). And since we are calling ray.get(worker.get_node_ip.remote()) in a serialized manner for each newly created actor handle, this time adds up. For example, when we have TP=4, this would take ~12 seconds. We optimize this by making ray.get(worker.get_node_ip.remote()) calls on all the actor handles after they are created. And since these run in parallel, the total time taken is ~3s. So for TP = 4, this reduces ~9 seconds. I tested the following command: python3 benchmarks/benchmark_latency.py --model meta-llama/Llama-3.1-8B-Instruct --tensor-parallel-size 4  --num-iters-warmup 5 --num-iters 20  --batch-size 8 --input-len 128 --output-len 256 --max-model-len 2048 --no-enable-prefix-caching --distributed-executor-backend ray Without this PR, _init_workers_ray takes ~18 seconds. And with it, it takes ~9 seconds. FIX #10283 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 jjyao reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link github-actions bot commented Dec 18, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ruisearch42 assigned comaniac Dec 18, 2024 comaniac approved these changes Dec 18, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/executor/ray_gpu_executor.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . ruisearch42 force-pushed the opt_ray_worker_init branch\n    from dfa2cb8 to 0f453a7 Compare December 18, 2024 01:54 ruisearch42 added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Dec 18, 2024 ruisearch42 and others added 3 commits December 18, 2024 16:22 [Misc] Optimize ray worker initialization time â€¦ 30c4374 Signed-off-by: Rui Qiao <ruisearch42@gmail.com> up â€¦ 294e710 Signed-off-by: Rui Qiao <ruisearch42@gmail.com> Update vllm/executor/ray_gpu_executor.py â€¦ 8254b41 Co-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com> ruisearch42 force-pushed the opt_ray_worker_init branch\n    from 0f453a7 to 8254b41 Compare December 18, 2024 16:22 comaniac enabled auto-merge (squash) December 18, 2024 16:28 up â€¦ 918f192 Signed-off-by: Rui Qiao <ruisearch42@gmail.com> auto-merge was automatically disabled December 18, 2024 16:32 Head branch was pushed to by a user without write access youkaichao approved these changes Dec 19, 2024 View reviewed changes Copy link Member youkaichao left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment thanks for the fix! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 ruisearch42 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Hide details View details youkaichao merged commit f26c4ae into vllm-project : main Dec 19, 2024 54 checks passed Uh oh! There was an error while loading. Please reload this page . youkaichao reviewed Dec 19, 2024 View reviewed changes vllm/executor/ray_gpu_executor.py @@ -179,7 +188,7 @@ def sort_by_driver_then_worker_ip(worker): 3. Finally, if the work is on a node with smaller IP address, it should be placed first. \"\"\" ip = ray.get( worker .get_node_ip.remote()) ip = worker_to_ip[ worker ] Copy link Member youkaichao Dec 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @ruisearch42 this one looks concerning to me. we should change the tuple to sort, instead of using worker as the key. see the code from #11256 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author ruisearch42 Dec 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I see. Can you elaborate a bit on the concern? The pattern of using an external dict for sorting is not uncommon. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member youkaichao Dec 20, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment using an arbitrary python object as a key introduces quite unpredictable behavior and can have silent bugs. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member youkaichao Dec 20, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment it's not about using an external dict, it's about using the worker object as a dict key, which implicitly calls its __hash__ function. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author ruisearch42 Dec 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think the default behavior without a custom __hash__ function is to use the object's identity (memory address) as __hash__ and __eq__ , so it's pretty safe unless there is some non-standard user overridden __hash__ and __eq__ ? I think your implementation also makes sense. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions ruisearch42 mentioned this pull request Dec 20, 2024 [Bug]: extremely slow launching time possibly due to calling ray.init() again after it has already been called when launching vllm through ray cluster #11208 Closed 1 task mzusman pushed a commit\n        to mzusman/vllm\n      that referenced\n      this pull request Mar 12, 2025 [Misc] Optimize ray worker initialization time ( vllm-project#11275 ) â€¦ 073196d Signed-off-by: Rui Qiao <ruisearch42@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:21", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:47:21", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python3 benchmarks/benchmark_latency.py --model meta-llama/Llama-3.1-8B-Instruct --tensor-parallel-size 4  --num-iters-warmup 5 --num-iters 20  --batch-size 8 --input-len 128 --output-len 256 --max-model-len 2048 --no-enable-prefix-caching --distributed-executor-backend ray", "commit_subject": "[Misc] Optimize ray worker initialization time (#11275)", "commit_message": "[Misc] Optimize ray worker initialization time (#11275)\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>", "commit_date": "2024-12-18T23:38:02-08:00", "files_changed": ["vllm/executor/ray_gpu_executor.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 4, "num_edited_lines": 35, "num_non_test_edited_lines": 35, "commit_year": 2024}, "diff_text": "diff --git a/vllm/executor/ray_gpu_executor.py b/vllm/executor/ray_gpu_executor.py\nindex 4bf5cbbd1..e2c549cbd 100644\n--- a/vllm/executor/ray_gpu_executor.py\n+++ b/vllm/executor/ray_gpu_executor.py\n@@ -123,6 +123,7 @@ class RayGPUExecutor(DistributedGPUExecutor):\n \n         # Create the workers.\n         driver_ip = get_ip()\n+        workers = []\n         for bundle_id, bundle in enumerate(placement_group.bundle_specs):\n             if not bundle.get(\"GPU\", 0):\n                 continue\n@@ -138,20 +139,30 @@ class RayGPUExecutor(DistributedGPUExecutor):\n                 scheduling_strategy=scheduling_strategy,\n                 **ray_remote_kwargs,\n             )(RayWorkerWrapper).remote(vllm_config=self.vllm_config)\n+            workers.append(worker)\n \n-            if self.use_ray_spmd_worker:\n-                self.workers.append(worker)\n-            else:\n-                worker_ip = ray.get(worker.get_node_ip.remote())\n-                if worker_ip == driver_ip and self.driver_dummy_worker is None:\n+        worker_ip_refs = [\n+            worker.get_node_ip.remote()  # type: ignore[attr-defined]\n+            for worker in workers\n+        ]\n+        worker_ips = ray.get(worker_ip_refs)\n+\n+        if not self.use_ray_spmd_worker:\n+            for i in range(len(workers)):\n+                worker = workers[i]\n+                worker_ip = worker_ips[i]\n+                if self.driver_dummy_worker is None and worker_ip == driver_ip:\n                     # If the worker is on the same node as the driver, we use it\n                     # as the resource holder for the driver process.\n                     self.driver_dummy_worker = worker\n                     self.driver_worker = RayWorkerWrapper(\n                         vllm_config=self.vllm_config)\n-                else:\n-                    # Else, added to the list of workers.\n-                    self.workers.append(worker)\n+                    workers.pop(i)\n+                    worker_ips.pop(i)\n+                    self.workers = workers\n+                    break\n+        else:\n+            self.workers = workers\n \n         logger.debug(\"workers: %s\", self.workers)\n         logger.debug(\"driver_dummy_worker: %s\", self.driver_dummy_worker)\n@@ -161,14 +172,12 @@ class RayGPUExecutor(DistributedGPUExecutor):\n                 \"adjusting the Ray placement group or running the driver on a \"\n                 \"GPU node.\")\n \n-        worker_ips = [\n-            ray.get(worker.get_node_ip.remote())  # type: ignore[attr-defined]\n-            for worker in self.workers\n-        ]\n         ip_counts: Dict[str, int] = {}\n         for ip in worker_ips:\n             ip_counts[ip] = ip_counts.get(ip, 0) + 1\n \n+        worker_to_ip = dict(zip(self.workers, worker_ips))\n+\n         def sort_by_driver_then_worker_ip(worker):\n             \"\"\"\n             Sort the workers based on 3 properties:\n@@ -179,7 +188,7 @@ class RayGPUExecutor(DistributedGPUExecutor):\n             3. Finally, if the work is on a node with smaller IP address, it\n                 should be placed first.\n             \"\"\"\n-            ip = ray.get(worker.get_node_ip.remote())\n+            ip = worker_to_ip[worker]\n             return (ip != driver_ip, ip_counts[ip], ip)\n \n         # After sorting, the workers on the same node will be", "apis": ["None"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/executor/ray_distributed_executor.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/executor/ray_distributed_executor.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/api_server.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a source file (ray_gpu_executor.py) and alters the logic for initializing and managing Ray worker objects. In particular, it refactors the worker initialization by batching remote IP calls and streamlining worker management (e.g., the removal of redundant calls to ray.get). These changes are designed to reduce startup overhead and improve the efficiency of worker setupâ€”a performance-related improvement on the CPU. Although the commit message mentions \"Optimize ray worker initialization time,\" the underlying changes go beyond mere refactoring or renaming and tackle a non-trivial performance bottleneck in the initialization process.", "llm_api_reason": "The commit changes the internal logic of the ray worker initialization within the RayGPUExecutor. It refactors how worker references are collected, their IPs are retrieved, and how the driver dummy worker is selectedâ€”all resulting in a performance optimization. No public or highâ€level API interfaces are modified by this change."}
{"commit_hash": "25ebed2f8ca6d747d63f2be9ede023c561851ac8", "pr_url": "https://github.com/vllm-project/vllm/pull/11214", "pr_date": "2024-12-15", "timeline_text": "Copy link Collaborator WoosukKwon commented Dec 15, 2024 No description provided. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [V1][Minor] Cache np arange to reduce input preparation overhead â€¦ 0e1d13d Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Dec 15, 2024 WoosukKwon requested review from robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners December 15, 2024 18:57 Copy link github-actions bot commented Dec 15, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details WoosukKwon merged commit 25ebed2 into main Dec 15, 2024 66 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the v1-arange branch December 15, 2024 21:33 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:24", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:47:24", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][Minor] Cache np arange to reduce input preparation overhead (#11214)", "commit_message": "[V1][Minor] Cache np arange to reduce input preparation overhead (#11214)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2024-12-15T13:33:00-08:00", "files_changed": ["vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 12, "num_non_test_edited_lines": 12, "commit_year": 2024}, "diff_text": "diff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex abcd4b007..67166fb05 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -118,6 +118,12 @@ class GPUModelRunner:\n             dtype=self.dtype,\n             device=self.device)\n \n+        # OPTIMIZATION: Cache the tensors rather than creating them every step.\n+        self.arange_np = np.arange(max(self.max_num_reqs, self.max_model_len),\n+                                   dtype=np.int32)\n+        # NOTE(woosuk): These tensors are \"stateless\", i.e., they are literally\n+        # a faster version of creating a new tensor every time. Thus, we should\n+        # not make any assumptions about the values in these tensors.\n         self.input_ids_cpu = torch.zeros(self.max_num_tokens,\n                                          dtype=torch.int32,\n                                          device=\"cpu\",\n@@ -269,11 +275,13 @@ class GPUModelRunner:\n \n         # Get request indices.\n         # E.g., [2, 5, 3] -> [0, 0, 1, 1, 1, 1, 1, 2, 2, 2]\n-        req_indices = np.repeat(np.arange(num_reqs), num_scheduled_tokens)\n+        req_indices = np.repeat(self.arange_np[:num_reqs],\n+                                num_scheduled_tokens)\n \n         # Get batched arange.\n         # E.g., [2, 5, 3] -> [0, 1, 0, 1, 2, 3, 4, 0, 1, 2]\n-        arange = np.concatenate([np.arange(n) for n in num_scheduled_tokens])\n+        arange = np.concatenate(\n+            [self.arange_np[:n] for n in num_scheduled_tokens])\n \n         # Get positions.\n         positions_np = self.positions_np[:total_num_scheduled_tokens]", "apis": ["GPUModelRunner.__init__", "GPUModelRunner._prepare_inputs"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/api_server.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test file (gpu_model_runner.py) with non-trivial source code changes. The changes cache the creation of np.arange arrays instead of recreating them every step, which reduces overhead during input preparation. Although the commit message mentions caching, the intention is to optimize performance by reducing repetitive computation on the CPU. The optimizations are applied to high-level API routines (the API handling model runner) and are testable without a GPU dependency. Overall, the commit meets the conditions for a performance/optimization related commit.", "llm_api_reason": "This commit introduces a micro-optimization in the GPUModelRunner class by pre-computing and caching a fixed np.arange array (stored in the instance variable â€œself.arange_npâ€) during initialization. It then reuses slices of this cached array instead of repeatedly computing new np.arange arrays in the _prepare_inputs method when calculating request indices and perâ€request arange values. This change improves the input preparation performance without modifying the external API of GPUModelRunner."}
{"commit_hash": "886936837ca89e5645bc1f71cc0e1492b65b1590", "pr_url": "https://github.com/vllm-project/vllm/pull/7209", "pr_date": "2024-12-14", "timeline_text": "Copy link Contributor llsj14 commented Aug 6, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . FIX #6923 Summary I discovered that the eviction logic with the OrderedDict free_table in Evictor V1 and V2 slows down overall performance (especially TTFT ) when using prefix caching mode. In some scenarios, utilizing prefix caching mode makes the system slower compared to when prefix caching is not used. The evict function is frequently called when allocating a new block, as no block is evicted until the block space is full in prefix caching mode. The eviction logic was slow because free_table is declared as an OrderedDict, which is a linked list, and it tries to find a block with content hash (Evictor V1) or block ID (Evictor V2) in this free_table. Utilizing a priority queue and lazy deletion helps find the block faster. Result Verification As shown in the following output, the block ID and content hash had the same value between the as-is and to-be states (which is expected). With this change, I could make the duration of the evict function much faster. ===============================\nevicted_block_id compare:  12010   12010\ncontent_hash_compare:  -7334740008364413937   -7334740008364413937\nas-is evict duration:  7.0807114243507385 ms\nto-be evict duration:  0.012848526239395142 ms\n===============================\nevicted_block_id compare:  12038   12038\ncontent_hash_compare:  -7008894356950570757   -7008894356950570757\nas-is evict duration:  7.1028973907232285 ms\nto-be evict duration:  0.008581206202507019 ms\n=============================== Performance I checked the TTFT performance using llmperf and the Llama3-8B model with an A100 GPU. I benchmarked with 1536 input token length (512 same prefix + 1024 random input) and 512 output token length. By applying this commit, I can make the system faster while utilizing prefix caching. The speed-up metric is calculated based on the performance without prefix caching mode. as-is Model Num Clients Block Manager Prefix Caching TTFT (mean) Speed Up Llama3-8B 16 v2 X 841 ms Llama3-8B 32 v2 X 1441 ms Llama3-8B 64 v2 X 2619 ms Llama3-8B 128 v2 X 4729 ms Llama3-8B 16 v2 O 1962 ms 0.43 (slowed down) Llama3-8B 32 v2 O 8382 ms 0.17 (slowed down) Llama3-8B 64 v2 O 12665 ms 0.21 (slowed down) Llama3-8B 128 v2 O 22439 ms 0.21 (slowed down) to-be Model Num Clients Block Manager Prefix Caching TTFT (mean) Speed Up Llama3-8B 16 v2 O 541 ms 1.55 Llama3-8B 32 v2 O 901 ms 1.60 Llama3-8B 64 v2 O 1563 ms 1.68 Llama3-8B 128 v2 O 2947 ms 1.60 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 4 robertgshaw2-redhat, appleeji, jeongin601, and MonadKai reacted with thumbs up emoji ðŸŽ‰ 2 jeongin601 and nickandbro reacted with hooray emoji All reactions ðŸ‘ 4 reactions ðŸŽ‰ 2 reactions Copy link github-actions bot commented Aug 6, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Aug 6, 2024 thanks for the contribution! cc @alexm-neuralmagic @cadedaniel for block manager related optimization. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 reviewed Aug 6, 2024 View reviewed changes vllm/core/evictor_v2.py Outdated def update(self, block_id: int, last_accessed: float): self.free_table[block_id].last_accessed = last_accessed def _cleanup_if_necessary(self): if len(self.priority_queue) > 50 * len(self.free_table): Copy link Collaborator Yard1 Aug 6, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment that 50 constant should be a defined global. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 llsj14 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author llsj14 Aug 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @Yard1 , thank you for your comments. I have fixed the issue and rebased my code. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Yard1 commented Aug 6, 2024 FYI this PR seems to be optimizing the same path #7193 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator cadedaniel commented Aug 6, 2024 At high level these fixes look great, will need evictor folks to review with more detail (sorry for second ping @robertgshaw2-neuralmagic ) â¤ï¸ 1 llsj14 reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator robertgshaw2-redhat commented Aug 7, 2024 At high level these fixes look great, will need evictor folks to review with more detail (sorry for second ping @robertgshaw2-neuralmagic ) Thanks, Alex is going to take a look from out side, since he most recently has been in this codepath optimizing BMv2 â¤ï¸ 2 cadedaniel and llsj14 reacted with heart emoji All reactions â¤ï¸ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . llsj14 force-pushed the feat/optimize-evict branch\n    from 8071838 to 95495a7 Compare August 7, 2024 00:05 alexm-redhat reviewed Aug 7, 2024 View reviewed changes Copy link Collaborator alexm-redhat left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for revealing this bottleneck and fixing it! It is a good idea to use a heap + dict to quickly access an LRU item. Left some minor comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 llsj14 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/core/evictor_v2.py Outdated def add(self, block_id: int, content_hash: int, num_hashed_tokens: int, last_accessed: float): self.free_table[block_id] = BlockMetaData(content_hash, num_hashed_tokens, last_accessed) heapq.heappush( self.priority_queue, (last_accessed, -num_hashed_tokens, content_hash, block_id)) Copy link Collaborator alexm-redhat Aug 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice trick with the -num_hashed_tokens to provide heap sorting. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/evictor_v2.py Outdated heapq.heappush( self.priority_queue, (last_accessed, -num_hashed_tokens, content_hash, block_id)) self._cleanup_if_necessary() Copy link Collaborator alexm-redhat Aug 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Why it was necessary to delay the cleanup? Did you find it to be too slow? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 llsj14 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author llsj14 Aug 7, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The reason I applied lazy deletion and event triggered cleanup is that searching specific block and deleting outdated blocks from the heap is O(log n) . Thus, I skip and pop outdated blocks by checking the free_table in eviction operation, and only clean up the priority queue when it consumes too much memory with outdated blocks. Since cleanup itself is O(n log n) , calling the cleanup function every time would make the system too slow. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author llsj14 Aug 7, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The ideal scenario is when the cleanup function is not needed, as outdated blocks are naturally popped out during the eviction operation. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author llsj14 Aug 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @alexm-neuralmagic, thanks to your comment, I fixed the data type mistake and optimized the performance of the cleanup operation. I used only the free_table and heapify to create a new priority queue, achieving O(n) complexity. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/evictor_v2.py Outdated @@ -76,7 +79,8 @@ class LRUEvictor(Evictor): \"\"\" def __init__(self): self.free_table: OrderedDict [int, BlockMetaData] = OrderedDict() self.free_table: Dict [int, BlockMetaData] = {} Copy link Collaborator alexm-redhat Aug 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Dict is definitely faster here Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/evictor_v2.py Outdated from typing import OrderedDict, Tuple from typing import Dict, List, Tuple CLEANUP_THRESHOLD = 50 Copy link Collaborator alexm-redhat Aug 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I would make this a static class member, since it is used only inside the scope of the class below. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 llsj14 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author llsj14 Aug 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thank you, I fixed this Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator alexm-redhat commented Aug 7, 2024 btw, I would rename the topic of the PR to \"[Performance] ....\", since it is not a bugfix All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . llsj14 changed the title [Bugfix][Core] Optimize the performance of evictor v1 and v2 by applying a priority queue and lazy deletion [Performance][Core] Optimize the performance of evictor v1 and v2 by applying a priority queue and lazy deletion Aug 7, 2024 Copy link Contributor Author llsj14 commented Aug 9, 2024 /ready All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 9, 2024 llsj14 force-pushed the feat/optimize-evict branch\n    from fd520b2 to 273da1d Compare August 26, 2024 02:41 Copy link Contributor Author llsj14 commented Aug 26, 2024 I rebased codes to resolve the conflict All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . simon-mo requested review from zhuohan123 , youkaichao , comaniac and njhill as code owners November 26, 2024 05:49 Copy link mergify bot commented Nov 26, 2024 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @llsj14 . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Nov 26, 2024 llsj14 force-pushed the feat/optimize-evict branch\n    from 273da1d to 5d2bbcc Compare November 29, 2024 03:55 mergify bot removed\n  the needs-rebase label Nov 29, 2024 llsj14 force-pushed the feat/optimize-evict branch\n    from 5d2bbcc to a7ee9c4 Compare November 29, 2024 04:24 Copy link Contributor Author llsj14 commented Nov 29, 2024 @alexm-neuralmagic @Yard1 I rebased and tested my code again. I would appreciate your reviews. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . llsj14 force-pushed the feat/optimize-evict branch\n    from e5eb212 to 7e6b71c Compare December 11, 2024 14:56 Copy link Contributor Author llsj14 commented Dec 11, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . In my local test, the test_eviction_alloc_mixed sometimes passes and sometimes fails. tests/core/block/test_prefix_caching_block.py ................. [  6%]\n............................................................... [ 29%]\n............................................................... [ 53%]\n............................................................... [ 76%]\n............................................................... [100%]\n=================== 269 passed, 2 warnings in 6.49s =================== I believe the assertion in this part is not strictly necessary, because all blocks can be candidates for eviction if they have same last accessed time. The key difference is that the previous code search blocks from the beginning of the free table, while my implementation does not. @leiwen83 @cadedaniel @comaniac Could you check whether it would be fine to remove the assertion mentioned above and review my PR please? -> I just changed my code to make the test pass. I prioritized the block_id to select the earlier one under the same conditions. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . llsj14 commented Dec 13, 2024 View reviewed changes vllm/core/evictor.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . llsj14 force-pushed the feat/optimize-evict branch\n    from e82e821 to 0038286 Compare December 13, 2024 09:13 Copy link Contributor Author llsj14 commented Dec 13, 2024 @comaniac Could you review this PR, please? This PR was previously reviewed, and I have been testing its stability by running it locally for several months. It has also successfully passed unit tests and CI checks. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac reviewed Dec 13, 2024 View reviewed changes vllm/core/evictor.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/evictor.py Outdated Comment on lines 92 to 106 while self.priority_queue: # Lazy deletion algorithm is applied. last_accessed, _, block_id, content_hash = heapq.heappop( self.priority_queue) if (block_id in self.free_table and self.free_table[block_id].last_accessed == last_accessed): self.free_table.pop(block_id) return block_id, content_hash Copy link Collaborator comaniac Dec 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I'm a bit worry about this lazy deletion algorithm as it is pretty hard to understand for others and easy to introduce bugs in corner cases. Here are some possible questions people may ask by reading this code: How a block in the heap not in the free table? A related question is why we need to cleanup the heap. How a block in the heap and the free table could have different last access time? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 llsj14 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author llsj14 Dec 14, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @comaniac Thank you for the valuable feedback. I've added comments regarding the lazy deletion process. I understand your concerns about the lazy deletion algorithm, as it shows O(n log n) time complexity when triggered. However, since outdated entries are also removed through heap pops, I believe cleanup is not an operation that happens frequently. In fact, I also considered using doubly linked list and dictionary for this optimization. While these structures are generally O(1), I think that if the key value changes(like num_hashed_tokens in this code) from being solely based on the last accessed time (which always increases), adding entries could then take O(n) time (to make doubly linked list sorted). Thatâ€™s why I opted for a priority queue... Nevertheless, I acknowledge the concerns about lazy deletion holding outdated entries. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator comaniac Dec 14, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yes I used doubly linked list in v1 prefix caching and it works well, but it would be tedious for v0. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 llsj14 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author llsj14 Dec 14, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Oh I see. I'll check the v1 implementation later as well. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions comaniac approved these changes Dec 14, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Otherwise LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/evictor.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . llsj14 and others added 14 commits December 14, 2024 01:59 feat: optimize evictor v2 performance using priority queue and lazy dâ€¦ â€¦ 6a28606 â€¦eletion\n\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> refactor: make format â€¦ 461c8fd Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> refactor: use global defined variable for cleanup threshold â€¦ ad9bf4a Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> refactor: make CLEAN_THRESHOLD as a static class member â€¦ a1ef9ec Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> refactor: make format â€¦ c505a93 Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> fix: optimize priority queue cleanup operation â€¦ 02e92f7 Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> trigger test â€¦ 76e4665 Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> prioritize block_id in priority queue â€¦ 840612a Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> make format â€¦ add810e Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> retrigger test â€¦ 1c8c2b8 Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> add comment â€¦ e1d7d7a Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> make format â€¦ 0d554e4 Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> update comments â€¦ b923060 Co-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> make format â€¦ 46798ad Signed-off-by: Sungjae Lee <33976427+llsj14@users.noreply.github.com> llsj14 force-pushed the feat/optimize-evict branch\n    from dd3165c to 46798ad Compare December 14, 2024 01:59 Hide details View details comaniac merged commit 8869368 into vllm-project : main Dec 14, 2024 51 checks passed Uh oh! There was an error while loading. Please reload this page . xiangyuT mentioned this pull request Dec 24, 2024 Refine evictor based on #7209 analytics-zoo/vllm#70 Merged PeaBrane mentioned this pull request May 11, 2025 feat: vllm mock workers, Rusty skeleton ai-dynamo/dynamo#1033 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:28", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, TTFT | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:28", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Performance][Core] Optimize the performance of evictor v1 and v2 by applying a priority queue and lazy deletion (#7209)", "commit_message": "[Performance][Core] Optimize the performance of evictor v1 and v2 by applying a priority queue and lazy deletion (#7209)", "commit_date": "2024-12-14T11:38:10-08:00", "files_changed": ["vllm/core/evictor.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 63, "num_non_test_edited_lines": 63, "commit_year": 2024}, "diff_text": "diff --git a/vllm/core/evictor.py b/vllm/core/evictor.py\nindex ed7e06cab..44adc4158 100644\n--- a/vllm/core/evictor.py\n+++ b/vllm/core/evictor.py\n@@ -1,6 +1,7 @@\n import enum\n+import heapq\n from abc import ABC, abstractmethod\n-from typing import OrderedDict, Tuple\n+from typing import Dict, List, Tuple\n \n \n class EvictionPolicy(enum.Enum):\n@@ -75,8 +76,14 @@ class LRUEvictor(Evictor):\n     highest num_hashed_tokens value, then one will be chose arbitrarily\n     \"\"\"\n \n+    # CLEANUP_THRESHOLD determines the maximum allowable size of the priority\n+    # queue relative to the free table size. When this threshold is exceeded,\n+    # a cleanup operation is triggered to reduce memory usage.\n+    CLEANUP_THRESHOLD = 50\n+\n     def __init__(self):\n-        self.free_table: OrderedDict[int, BlockMetaData] = OrderedDict()\n+        self.free_table: Dict[int, BlockMetaData] = {}\n+        self.priority_queue = []\n \n     def __contains__(self, block_id: int) -> bool:\n         return block_id in self.free_table\n@@ -85,34 +92,50 @@ class LRUEvictor(Evictor):\n         if len(self.free_table) == 0:\n             raise ValueError(\"No usable cache memory left\")\n \n-        evicted_block, evicted_block_id = None, None\n-        # The blocks with the lowest timestamps should be placed consecutively\n-        # at the start of OrderedDict. Loop through all these blocks to\n-        # find the one with maximum number of hashed tokens.\n-        for _id, block in self.free_table.items():\n-            if evicted_block is None:\n-                evicted_block, evicted_block_id = block, _id\n-                continue\n-            if evicted_block.last_accessed < block.last_accessed:\n-                break\n-            if evicted_block.num_hashed_tokens < block.num_hashed_tokens:\n-                evicted_block, evicted_block_id = block, _id\n-\n-        assert evicted_block is not None\n-        assert evicted_block_id is not None\n-        self.free_table.pop(evicted_block_id)\n-\n-        return evicted_block_id, evicted_block.content_hash\n+        while self.priority_queue:\n+            # We do not remove outdated entries from the priority queue at the\n+            # time of updating the last_accessed timestamp. Instead, outdated\n+            # entries are filtered out here during eviction. Outdated entries\n+            # would either not in the free table, or have older last accessed\n+            # time.\n+            last_accessed, _, block_id, content_hash = heapq.heappop(\n+                self.priority_queue)\n+            if (block_id in self.free_table and\n+                    self.free_table[block_id].last_accessed == last_accessed):\n+                self.free_table.pop(block_id)\n+                return block_id, content_hash\n+\n+        raise ValueError(\"No usable cache memory left\")\n \n     def add(self, block_id: int, content_hash: int, num_hashed_tokens: int,\n             last_accessed: float):\n         self.free_table[block_id] = BlockMetaData(content_hash,\n                                                   num_hashed_tokens,\n                                                   last_accessed)\n+        heapq.heappush(\n+            self.priority_queue,\n+            (last_accessed, -num_hashed_tokens, block_id, content_hash))\n+        self._cleanup_if_necessary()\n \n     def update(self, block_id: int, last_accessed: float):\n         self.free_table[block_id].last_accessed = last_accessed\n \n+    def _cleanup_if_necessary(self):\n+        if len(self.priority_queue) > LRUEvictor.CLEANUP_THRESHOLD * len(\n+                self.free_table):\n+            self._cleanup()\n+\n+    def _cleanup(self):\n+        new_priority_queue: List[Tuple[float, int, int, int]] = []\n+\n+        for block_id, block in self.free_table.items():\n+            new_priority_queue.append(\n+                (block.last_accessed, -block.num_hashed_tokens, block_id,\n+                 block.content_hash))\n+        heapq.heapify(new_priority_queue)\n+\n+        self.priority_queue = new_priority_queue\n+\n     def remove(self, block_id: int):\n         if block_id not in self.free_table:\n             raise ValueError(", "apis": ["vllm.core.evictor.LRUEvictor.__init__", "vllm.core.evictor.LRUEvictor.evict", "vllm.core.evictor.LRUEvictor.add"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/evictor.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block_manager.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file (vllm/core/evictor.py) and significantly changes the eviction logic by introducing a heap-based priority queue and lazy deletion mechanism. These changes replace the previous Linear search using OrderedDict with a more efficient algorithm for evicting cache blocks. The modifications are non-trivial as they affect core performance by improving the eviction strategy, reducing overhead, and include a cleanup process to maintain efficiency. This commit clearly serves as a performance optimization on CPU, not merely a refactoring or bug fix.", "llm_api_reason": "The commit refactors the LRUEvictor class to improve eviction performance by switching from an iterative search inside an ordered dictionary to a heap-based (priority queue) approach with lazy deletion. Changes were made in the constructor (__init__) to initialize a new priority queue, in the evict method to pop outdated entries from the heap until a valid candidate is found, and in the add method to push new entries onto the heap along with triggering periodic cleanup. These modifications optimize eviction operations and reduce memory usage overhead."}
{"commit_hash": "f092153fbe349a9a1742940e3703bfcff6aa0a6d", "pr_url": "https://github.com/vllm-project/vllm/pull/11111", "pr_date": "2024-12-12", "timeline_text": "Copy link Collaborator WoosukKwon commented Dec 11, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This PR simplifies the input preparation code further while optimizing it by utilizing more persistent buffers. Creating new tensors can introduce considerable overhead for small-batch inputs, so persistent buffers effectively reduce latency. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tmp â€¦ 73a8b20 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Copy link github-actions bot commented Dec 11, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon added 2 commits December 11, 2024 11:13 comment â€¦ dbac8f5 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> comment â€¦ 734a7b7 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon marked this pull request as ready for review December 11, 2024 19:15 WoosukKwon requested review from robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners December 11, 2024 19:15 WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Dec 11, 2024 Copy link Collaborator alexm-redhat commented Dec 11, 2024 Nice idea! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . alexm-redhat approved these changes Dec 11, 2024 View reviewed changes vllm/v1/worker/gpu_model_runner.py dtype=torch.int32, device=\"cpu\", pin_memory=self.pin_memory) self.slot_mapping_np = self.slot_mapping_cpu.numpy() Copy link Collaborator alexm-redhat Dec 11, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Does the resulting numpy here shares the memory buffer of the source tensor? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author WoosukKwon Dec 12, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The returned ndarray and the tensor will share their storage, so changes to the tensor will be reflected in the ndarray and vice versa. Yes. That's the trick here :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details WoosukKwon merged commit f092153 into main Dec 12, 2024 65 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the v1-opt-prep branch December 12, 2024 07:14 markmc mentioned this pull request Dec 12, 2024 Enable mypy checking on V1 code #11105 Merged sleepwalker2017 pushed a commit\n        to sleepwalker2017/vllm\n      that referenced\n      this pull request Dec 13, 2024 [V1] Use more persistent buffers to optimize input preparation overheâ€¦ â€¦ 2e703c8 â€¦ads ( vllm-project#11111 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:32", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: latency | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:47:32", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1] Use more persistent buffers to optimize input preparation overheads (#11111)", "commit_message": "[V1] Use more persistent buffers to optimize input preparation overheads (#11111)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2024-12-11T23:14:20-08:00", "files_changed": ["vllm/v1/worker/gpu_input_batch.py", "vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 7, "num_edited_lines": 138, "num_non_test_edited_lines": 138, "commit_year": 2024}, "diff_text": "diff --git a/vllm/v1/worker/gpu_input_batch.py b/vllm/v1/worker/gpu_input_batch.py\nindex 25d95ac6e..9046b37f6 100644\n--- a/vllm/v1/worker/gpu_input_batch.py\n+++ b/vllm/v1/worker/gpu_input_batch.py\n@@ -53,14 +53,23 @@ class InputBatch:\n         self.req_ids: List[Optional[str]] = [None] * max_num_reqs\n         self.req_id_to_index: Dict[str, int] = {}\n \n-        self.token_ids_cpu = np.empty((max_num_reqs, max_model_len),\n-                                      dtype=np.int32)\n+        # TODO(woosuk): This buffer could be too large if max_model_len is big.\n+        # Find a way to reduce the CPU memory usage.\n+        self.token_ids_cpu_tensor = torch.zeros(\n+            (max_num_reqs, max_model_len),\n+            device=\"cpu\",\n+            dtype=torch.int32,\n+            pin_memory=pin_memory,\n+        )\n+        self.token_ids_cpu = self.token_ids_cpu_tensor.numpy()\n         self.num_computed_tokens_cpu = np.empty(max_num_reqs, dtype=np.int32)\n \n         # Attention-related.\n-        self.block_table = torch.zeros((max_num_reqs, max_num_blocks_per_req),\n-                                       device=self.device,\n-                                       dtype=torch.int32)\n+        self.block_table = torch.zeros(\n+            (max_num_reqs, max_num_blocks_per_req),\n+            device=self.device,\n+            dtype=torch.int32,\n+        )\n         self.block_table_cpu_tensor = torch.zeros(\n             (max_num_reqs, max_num_blocks_per_req),\n             device=\"cpu\",\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex e75be21ef..aa91255e6 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -67,6 +67,7 @@ class GPUModelRunner:\n         self.max_model_len = model_config.max_model_len\n         self.max_num_blocks_per_req = cdiv(self.max_model_len, self.block_size)\n         self.max_num_tokens = scheduler_config.max_num_batched_tokens\n+        self.max_num_reqs = scheduler_config.max_num_seqs\n \n         # Model-related.\n         self.num_attn_layers = model_config.get_num_layers_by_block_type(\n@@ -88,7 +89,7 @@ class GPUModelRunner:\n         self.requests: Dict[str, CachedRequestState] = {}\n         # Persistent batch.\n         self.input_batch = InputBatch(\n-            max_num_reqs=self.scheduler_config.max_num_seqs,\n+            max_num_reqs=self.max_num_reqs,\n             max_model_len=self.max_model_len,\n             max_num_blocks_per_req=self.max_num_blocks_per_req,\n             device=self.device,\n@@ -117,6 +118,32 @@ class GPUModelRunner:\n             dtype=self.dtype,\n             device=self.device)\n \n+        self.input_ids_cpu = torch.zeros(self.max_num_tokens,\n+                                         dtype=torch.int32,\n+                                         device=\"cpu\",\n+                                         pin_memory=self.pin_memory)\n+        self.input_ids_np = self.input_ids_cpu.numpy()\n+        self.positions_cpu = torch.zeros(self.max_num_tokens,\n+                                         dtype=torch.int64,\n+                                         device=\"cpu\",\n+                                         pin_memory=self.pin_memory)\n+        self.positions_np = self.positions_cpu.numpy()\n+        self.slot_mapping_cpu = torch.zeros(self.max_num_tokens,\n+                                            dtype=torch.int32,\n+                                            device=\"cpu\",\n+                                            pin_memory=self.pin_memory)\n+        self.slot_mapping_np = self.slot_mapping_cpu.numpy()\n+        self.query_start_loc_cpu = torch.zeros(self.max_num_reqs + 1,\n+                                               dtype=torch.int32,\n+                                               device=\"cpu\",\n+                                               pin_memory=self.pin_memory)\n+        self.query_start_loc_np = self.query_start_loc_cpu.numpy()\n+        self.seq_start_loc_cpu = torch.zeros(self.max_num_reqs + 1,\n+                                             dtype=torch.int32,\n+                                             device=\"cpu\",\n+                                             pin_memory=self.pin_memory)\n+        self.seq_start_loc_np = self.seq_start_loc_cpu.numpy()\n+\n     def _update_states(self, scheduler_output: \"SchedulerOutput\") -> None:\n         # Remove stopped requests from the cached states.\n         # Keep the states of the pre-empted requests.\n@@ -241,22 +268,14 @@ class GPUModelRunner:\n \n         # Get request indices.\n         # E.g., [2, 5, 3] -> [0, 0, 1, 1, 1, 1, 1, 2, 2, 2]\n-        indices = np.arange(num_reqs)\n-        req_indices = np.repeat(indices, num_scheduled_tokens)\n+        req_indices = np.repeat(np.arange(num_reqs), num_scheduled_tokens)\n \n         # Get batched arange.\n         # E.g., [2, 5, 3] -> [0, 1, 0, 1, 2, 3, 4, 0, 1, 2]\n-        arange_matrix = np.tile(np.arange(max_num_scheduled_tokens),\n-                                (num_reqs, 1))\n-        mask = arange_matrix < num_scheduled_tokens[:, np.newaxis]\n-        arange = arange_matrix[mask]\n+        arange = np.concatenate([np.arange(n) for n in num_scheduled_tokens])\n \n         # Get positions.\n-        positions = torch.empty((total_num_scheduled_tokens, ),\n-                                dtype=torch.int32,\n-                                device=\"cpu\",\n-                                pin_memory=self.pin_memory)\n-        positions_np = positions.numpy()\n+        positions_np = self.positions_np[:total_num_scheduled_tokens]\n         np.add(self.input_batch.num_computed_tokens_cpu[req_indices],\n                arange,\n                out=positions_np)\n@@ -267,16 +286,13 @@ class GPUModelRunner:\n         # where M is the max_model_len.\n         token_indices = (positions_np +\n                          req_indices * self.input_batch.token_ids_cpu.shape[1])\n-        token_indices = torch.from_numpy(token_indices)\n-        input_ids = torch.empty((total_num_scheduled_tokens, ),\n-                                dtype=torch.int32,\n-                                device=\"cpu\",\n-                                pin_memory=self.pin_memory)\n-        torch.index_select(torch.from_numpy(\n-            self.input_batch.token_ids_cpu).flatten(),\n+        # NOTE(woosuk): We use torch.index_select instead of np.take here\n+        # because torch.index_select is much faster than np.take for large\n+        # tensors.\n+        torch.index_select(self.input_batch.token_ids_cpu_tensor.flatten(),\n                            0,\n-                           token_indices,\n-                           out=input_ids)\n+                           torch.from_numpy(token_indices),\n+                           out=self.input_ids_cpu[:total_num_scheduled_tokens])\n \n         # Calculate the slot mapping.\n         # E.g., [0, 1, 0, 1, 2, 3, 4, 0, 1, 2]\n@@ -284,45 +300,40 @@ class GPUModelRunner:\n         # where K is the max_num_blocks_per_req and the block size is 2.\n         # NOTE(woosuk): We can't simply use `token_indices // block_size` here\n         # because M (max_model_len) is not necessarily divisible by block_size.\n-        block_numbers = self.input_batch.block_table_cpu_tensor.flatten()[\n-            req_indices * self.max_num_blocks_per_req +\n-            positions_np // self.block_size]\n-        block_offsets = torch.from_numpy(positions_np % self.block_size)\n-        slot_mapping = torch.empty((total_num_scheduled_tokens, ),\n-                                   dtype=torch.int32,\n-                                   device=\"cpu\",\n-                                   pin_memory=self.pin_memory)\n-        torch.add(block_numbers * self.block_size,\n-                  block_offsets,\n-                  out=slot_mapping)\n+        block_table_indices = (req_indices * self.max_num_blocks_per_req +\n+                               positions_np // self.block_size)\n+        # NOTE(woosuk): We use torch.index_select instead of np.take here\n+        # because torch.index_select is much faster than np.take for large\n+        # tensors.\n+        block_numbers = (self.input_batch.block_table_cpu_tensor.flatten()\n+                         [block_table_indices].numpy())\n+        block_offsets = positions_np % self.block_size\n+        np.add(block_numbers * self.block_size,\n+               block_offsets,\n+               out=self.slot_mapping_np[:total_num_scheduled_tokens])\n \n         # Prepare the attention metadata.\n-        query_start_loc = torch.empty((num_reqs + 1, ),\n-                                      dtype=torch.int32,\n-                                      device=\"cpu\",\n-                                      pin_memory=self.pin_memory)\n-        query_start_loc_np = query_start_loc.numpy()\n-        query_start_loc_np[0] = 0\n-        np.cumsum(num_scheduled_tokens, out=query_start_loc_np[1:])\n+        self.query_start_loc_np[0] = 0\n+        np.cumsum(num_scheduled_tokens,\n+                  out=self.query_start_loc_np[1:num_reqs + 1])\n \n         seq_lens = (self.input_batch.num_computed_tokens_cpu[:num_reqs] +\n                     num_scheduled_tokens)\n         max_seq_len = seq_lens.max()\n-        seq_start_loc = torch.empty((num_reqs + 1, ),\n-                                    dtype=torch.int32,\n-                                    device=\"cpu\",\n-                                    pin_memory=self.pin_memory)\n-        seq_start_loc_np = seq_start_loc.numpy()\n-        seq_start_loc_np[0] = 0\n-        np.cumsum(seq_lens, out=seq_start_loc_np[1:])\n-\n-        self.input_ids[:total_num_scheduled_tokens].copy_(input_ids,\n-                                                          non_blocking=True)\n-        self.positions[:total_num_scheduled_tokens].copy_(positions,\n-                                                          non_blocking=True)\n-        query_start_loc = query_start_loc.to(self.device, non_blocking=True)\n-        seq_start_loc = seq_start_loc.to(self.device, non_blocking=True)\n-        slot_mapping = slot_mapping.to(self.device, non_blocking=True).long()\n+        self.seq_start_loc_np[0] = 0\n+        np.cumsum(seq_lens, out=self.seq_start_loc_np[1:num_reqs + 1])\n+\n+        # Copy the tensors to the GPU.\n+        self.input_ids[:total_num_scheduled_tokens].copy_(\n+            self.input_ids_cpu[:total_num_scheduled_tokens], non_blocking=True)\n+        self.positions[:total_num_scheduled_tokens].copy_(\n+            self.positions_cpu[:total_num_scheduled_tokens], non_blocking=True)\n+        query_start_loc = self.query_start_loc_cpu[:num_reqs + 1].to(\n+            self.device, non_blocking=True)\n+        seq_start_loc = self.seq_start_loc_cpu[:num_reqs + 1].to(\n+            self.device, non_blocking=True)\n+        slot_mapping = self.slot_mapping_cpu[:total_num_scheduled_tokens].to(\n+            self.device, non_blocking=True).long()\n         attn_metadata = FlashAttentionMetadata(\n             num_actual_tokens=total_num_scheduled_tokens,\n             max_query_len=max_num_scheduled_tokens,", "apis": ["InputBatch.__init__", "GPUModelRunner.__init__", "GPUModelRunner._update_states"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_input_batch.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test source files in the \"vllm/v1/worker\" directory. It replaces existing buffer allocation with persistent buffers using torch tensors (with pinned memory) and adjusts data indexing and copying operations. The changes are non-trivial, modifying data structures to reduce input preparation overheads, which is a performance optimization. It doesnâ€™t merely refactor code or address a bug, but enhances performance on CPU for the high-level API that handles input batching. Although GPU interactions exist, the optimizations primarily target CPU memory operations. Overall, the commit meets the criteria for a performance optimization commit.", "llm_api_reason": "This commit replaces dynamicallyâ€allocated numpy buffers with preâ€allocated persistent torch tensors (later converted to numpy) in the InputBatch constructor and also adds several new persistent CPU buffers in GPUModelRunner (e.g. input_ids_cpu, positions_cpu, slot_mapping_cpu, query_start_loc_cpu, and seq_start_loc_cpu). These changes optimize the input preparation workflow by reducing onâ€‘theâ€‘fly memory allocation overheads during state updates and index computations."}
{"commit_hash": "3b61cb450d899dc423feb264c297d4d18d701678", "pr_url": "https://github.com/vllm-project/vllm/pull/10989", "pr_date": "2024-12-09", "timeline_text": "Copy link Collaborator WoosukKwon commented Dec 8, 2024 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR reduces the CPU ops in V1 flash-attn: two slice ops for key and value by slightly modifying the reshape_and_cache_flash op. Also, it uses kv_cache.unbind(0) instead of kv_cache[0] and kv_cache[1] , to reduce the number of ops. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘€ 1 tlrmchlsmth reacted with eyes emoji All reactions ðŸ‘€ 1 reaction WoosukKwon added 6 commits December 4, 2024 21:06 tmp â€¦ d34c4a8 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ 14e2f77 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ fc025ec Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into v1-cache-opt 001ad42 minor â€¦ 194fa9e Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> comment â€¦ 269901d Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon requested review from robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners December 8, 2024 11:02 Copy link github-actions bot commented Dec 8, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Dec 8, 2024 Hide details View details WoosukKwon merged commit 3b61cb4 into main Dec 9, 2024 90 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the v1-cache-opt branch December 9, 2024 20:38 sleepwalker2017 pushed a commit\n        to sleepwalker2017/vllm\n      that referenced\n      this pull request Dec 13, 2024 [V1] Further reduce CPU overheads in flash-attn ( vllm-project#10989 ) â€¦ 0ad90dd Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:34", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:47:34", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1] Further reduce CPU overheads in flash-attn (#10989)", "commit_message": "[V1] Further reduce CPU overheads in flash-attn (#10989)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2024-12-09T12:38:46-08:00", "files_changed": ["csrc/cache_kernels.cu", "vllm/v1/attention/backends/flash_attn.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 2, "num_edited_lines": 35, "num_non_test_edited_lines": 35, "commit_year": 2024}, "diff_text": "diff --git a/csrc/cache_kernels.cu b/csrc/cache_kernels.cu\nindex 1be806bbf..8a95279f9 100644\n--- a/csrc/cache_kernels.cu\n+++ b/csrc/cache_kernels.cu\n@@ -307,10 +307,20 @@ void reshape_and_cache_flash(\n     torch::Tensor& key_cache,  // [num_blocks, block_size, num_heads, head_size]\n     torch::Tensor&\n         value_cache,  // [num_blocks, block_size, num_heads, head_size]\n-    torch::Tensor& slot_mapping,  // [num_tokens]\n+    torch::Tensor& slot_mapping,  // [num_tokens] or [num_actual_tokens]\n     const std::string& kv_cache_dtype, const double k_scale,\n     const double v_scale) {\n-  int num_tokens = key.size(0);\n+  // NOTE(woosuk): In vLLM V1, key.size(0) can be different from\n+  // slot_mapping.size(0) because of padding for CUDA graphs.\n+  // In vLLM V0, key.size(0) is always equal to slot_mapping.size(0) because\n+  // both include padding.\n+  // In vLLM V1, however, key.size(0) can be larger than slot_mapping.size(0)\n+  // since key includes padding for CUDA graphs, while slot_mapping does not.\n+  // In this case, slot_mapping.size(0) represents the actual number of tokens\n+  // before padding.\n+  // For compatibility with both cases, we use slot_mapping.size(0) as the\n+  // number of tokens.\n+  int num_tokens = slot_mapping.size(0);\n   int num_heads = key.size(1);\n   int head_size = key.size(2);\n   int block_size = key_cache.size(1);\ndiff --git a/vllm/v1/attention/backends/flash_attn.py b/vllm/v1/attention/backends/flash_attn.py\nindex d37989055..251a103e6 100644\n--- a/vllm/v1/attention/backends/flash_attn.py\n+++ b/vllm/v1/attention/backends/flash_attn.py\n@@ -138,14 +138,25 @@ class FlashAttentionImpl(AttentionImpl):\n             # Profiling run.\n             return output\n \n-        num_actual_tokens = attn_metadata.num_actual_tokens\n+        # IMPORTANT!\n+        # NOTE(woosuk): With piece-wise CUDA graphs, this method is executed in\n+        # eager-mode PyTorch. Thus, we need to be careful about any CPU overhead\n+        # in this method. For example, `view` and `slice` (or `[:n]`) operations\n+        # are surprisingly slow even in the case they do not invoke any GPU ops.\n+        # Minimize the PyTorch ops in this method as much as possible.\n+        # Whenever making a change in this method, please benchmark the\n+        # performance to make sure it does not introduce any overhead.\n \n+        num_actual_tokens = attn_metadata.num_actual_tokens\n         # Reshape the input keys and values and store them in the cache.\n-        key_cache = kv_cache[0]\n-        value_cache = kv_cache[1]\n+        # NOTE(woosuk): Here, key and value are padded while slot_mapping is\n+        # not padded. However, we don't need to do key[:num_actual_tokens] and\n+        # value[:num_actual_tokens] because the reshape_and_cache_flash op uses\n+        # the slot_mapping's shape to determine the number of actual tokens.\n+        key_cache, value_cache = kv_cache.unbind(0)\n         torch.ops._C_cache_ops.reshape_and_cache_flash(\n-            key[:num_actual_tokens],\n-            value[:num_actual_tokens],\n+            key,\n+            value,\n             key_cache,\n             value_cache,\n             attn_metadata.slot_mapping,", "apis": ["vllm.v1.attention.backends.flash_attn.FlashAttentionImpl.forward", "torch.ops._C_cache_ops.reshape_and_cache_flash"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/flash_attn.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/flash_attn.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/_custom_ops.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies two source code files (cache_kernels.cu and flash_attn.py) which are non-test files. It focuses on reducing CPU overhead in critical methods by adjusting how the number of tokens is computed and how operations are executed (e.g., using slot_mapping.size() for token count to avoid unnecessary padding-related overhead and making changes in the flash attention implementation to reduce operations like slicing/viewing that can be slow in eager-mode PyTorch). These modifications are performance-specific and aimed at optimizing CPU performance without changing the underlying functionality. Although the commit comments mention benchmarking and careful performance considerations rather than explicitly stating â€œperformanceâ€ everywhere, the changes clearly target optimizing the performance of a high-level API, impacting CPU efficiency. Therefore, this commit meets the performance/optimization-related criteria.", "llm_api_reason": "This commit revises the flashâ€attention caching mechanism by changing the way the number of tokens is computed in the low-level CUDA kernel used for reshaping and caching. In the C++ kernel, it now uses slot_mapping.size(0) instead of key.size(0) to determine the token count since in vLLM V1 the key tensor may include extra padding for CUDA graphs. In the Python layer â€“ in the FlashAttentionImpl in the v1 backend â€“ additional comments regarding eager-mode execution and minimization of CPU overhead were added and the code now calls kv_cache.unbind(0) instead of directly indexing key and value. Thus, the affected highâ€level Python APIs include the flashâ€attention forward method in the V1 backend and the underlying op call wrapped in torch.ops._C_cache_ops.reshape_and_cache_flash."}
{"commit_hash": "9323a3153b20d4a2ca7ac04a2784609d6ce656e0", "pr_url": "https://github.com/vllm-project/vllm/pull/10785", "pr_date": "2024-12-03", "timeline_text": "Copy link Collaborator aarnphm commented Nov 29, 2024 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Add initial support for XGrammar for V0 and makes it the default for grammar and json usage. Written in collaboration with @mgoin I'm using the benchmark scripts from #10557 Results for using XGrammar as backend: Throughput: 0.94 requests/s, 1022.46 total tokens/s, 480.27 output tokens/s Correct rate is 100.0 %\nFirst token latency(msecs):\ncount      10.000000\nmean     4552.206317\nstd       734.671745\nmin      3289.774953\n25%      3864.269087\n50%      5102.686635\n75%      5102.717258\nmax      5114.346570\ndtype: float64\nNext token latency(msecs):\ncount    10.000000\nmean     11.906452\nstd       1.409063\nmin      10.831970\n25%      10.837367\n50%      10.854235\n75%      13.227200\nmax      14.325024\ndtype: float64 Comparing to outlines Throughput: 0.22 requests/s, 241.22 total tokens/s, 113.31 output tokens/s Correct rate is 100.0 %\nFirst token latency(msecs):\ncount       10.000000\nmean     38533.083248\nstd         35.807892\nmin      38491.813741\n25%      38491.826321\n50%      38556.601226\n75%      38556.628519\nmax      38568.547848\ndtype: float64\nNext token latency(msecs):\ncount    10.000000\nmean     12.955556\nstd       0.042220\nmin      12.901755\n25%      12.914099\n50%      12.953058\n75%      12.996646\nmax      13.003127\ndtype: float64 NOTE: Running on A100 80GB, with Llama 3.2 3B with chunked prefill enable and JSON grammar Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 9 zhouyuan, choisioo, xuechendi, ywang96, nickandbro, JakubCerven, saattrupdan, hongqing1986, and suc16 reacted with thumbs up emoji All reactions ðŸ‘ 9 reactions aarnphm added 3 commits November 29, 2024 22:53 --wip-- â€¦ 41c0031 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> fix: update workaround for pickling â€¦ c17da0b Signed-off-by: Aaron Pham <contact@aarnphm.xyz> hack: hmm it is a tuple â€¦ b29dfb3 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> aarnphm requested review from zhuohan123 , youkaichao , alexm-redhat , comaniac and njhill as code owners November 29, 2024 23:45 Copy link github-actions bot commented Nov 29, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added documentation Improvements or additions to documentation ci/build labels Nov 29, 2024 revert: bad merge â€¦ 1be065b Signed-off-by: Aaron Pham <contact@aarnphm.xyz> aarnphm marked this pull request as draft November 29, 2024 23:46 aarnphm added 2 commits November 30, 2024 00:08 fix: correct use apply_token_bitmask interface â€¦ ee8e796 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> fix: correctness for prefill â€¦ cef4201 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> aarnphm marked this pull request as ready for review November 30, 2024 00:16 aarnphm added 3 commits November 30, 2024 00:23 fix: lint error â€¦ 919e5f8 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> fix: annotations â€¦ 4d6585b Signed-off-by: Aaron Pham <contact@aarnphm.xyz> fix: format â€¦ 5d2a43c Signed-off-by: Aaron Pham <contact@aarnphm.xyz> Ubospica reviewed Nov 30, 2024 View reviewed changes Copy link Ubospica left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for your contribution to integrating XGrammar into vLLM! It overall looks good, but there are some minor points to enhance parallelism. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/guided_decoding/__init__.py Outdated guided_params: GuidedDecodingParams, tokenizer ) -> Optional[ LogitsProcessor ] : guided_params: GuidedDecodingParams, tokenizer: PreTrainedTokenizer, model_config: ModelConfig ) -> LogitsProcessor | None : # CFG grammar not supported by LMFE, so we use outlines instead if guided_params.backend == 'outlines' or guided_params.grammar: Copy link Ubospica Nov 30, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment XGrammar can also do grammar decoding and accelerate it. The grammar formats for XGrammar and Outlines are different. XGrammar uses GBNF format, while Outlines uses lark grammar. That might be documented. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author aarnphm Dec 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment i see, I will add this difference into the docs Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author aarnphm Dec 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think we should just remove the grammar check here. If user send grammar they should also specify the backend (probably better to document the cartesian product of the combinations) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 Ubospica reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/model_executor/guided_decoding/xgrammar_decoding.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/guided_decoding/xgrammar_decoding.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . joennlae added a commit\n        to 44ai-labs/vllm\n      that referenced\n      this pull request Dec 1, 2024 [Core] add xgrammar as guided generation provider â€¦ d326148 Essentially a cleaned up version of this `pr`: vllm-project#10785 Especially since `outlines` is rather slow and the new version is though\nto intergrate as they do not focus on being pickleable which is a key\nfeature for us using the multiprocessing engine: dottxt-ai/outlines-core#99 I assume more and more will change over to `xgrammar`.\n\nThis is a minimum implementation. https://arxiv.org/pdf/2411.15100 Signed-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com> joennlae mentioned this pull request Dec 1, 2024 [Core] add xgrammar as guided generation provider #10803 Closed aarnphm and others added 3 commits November 30, 2024 20:54 chore: remove grammar mode branch with outlines â€¦ 3770400 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> Add caching for tokenizer data and grammar compiler â€¦ 865e2a3 Signed-off-by: mgoin <michael@neuralmagic.com> Merge branch 'feat/xgrammar' of https://github.com/aarnphm/vllm into â€¦ â€¦ e5684e2 â€¦feat/xgrammar Copy link Member mgoin commented Dec 1, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Updated this PR with caches for the tokenizer data and the grammar compiler to avoid constructing these data structures for each request. It isn't pretty but it boosts throughput by about 1.4x. I need to perform more profiling but we are limited by the required-serialization architecture that we currently have. We plan to move the FSM initialization out of the frontend to both simplify the implementation and speed up TTFT. Setup: Llama-3.1-8B-Instruct, 1xH100 Command: python benchmark_guided.py --model meta-llama/Llama-3.1-8B-Instruct --dataset xgrammar_bench --async-engine --output-len 512 --num-prompts 20 --enable-chunked-prefill --guided-decoding-ratio 1 Before: Throughput: 1.46 requests/s, 1189.12 total tokens/s, 748.00 output tokens/s Correct rate is 95.0 % \nFirst token latency(msecs):\ncount      20.000000\nmean     7180.142369\nstd      1212.973158\nmin      4644.173431\n25%      7012.610644\n50%      7578.541221\n75%      8079.524654\nmax      8092.886029\ndtype: float64\nNext token latency(msecs):\ncount    20.000000\nmean     12.662371\nstd       2.336552\nmin      10.942158\n25%      10.942283\n50%      11.864077\n75%      12.990130\nmax      17.550802\ndtype: float64 After: Throughput: 2.12 requests/s, 1726.67 total tokens/s, 1086.13 output tokens/s Correct rate is 95.0 % \nFirst token latency(msecs):\ncount      20.000000\nmean     3254.682581\nstd       290.516334\nmin      2869.083916\n25%      2869.120228\n50%      3449.280638\n75%      3477.460549\nmax      3477.504314\ndtype: float64\nNext token latency(msecs):\ncount    20.000000\nmean     12.054585\nstd       0.550868\nmin      11.643879\n25%      11.643967\n50%      11.674903\n75%      12.786106\nmax      12.786302\ndtype: float64 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . joennlae added a commit\n        to 44ai-labs/vllm\n      that referenced\n      this pull request Dec 1, 2024 [Core] add xgrammar as guided generation provider â€¦ caf4289 Essentially a cleaned up version of this `pr`: vllm-project#10785 Especially since `outlines` is rather slow and the new version is though\nto intergrate as they do not focus on being pickleable which is a key\nfeature for us using the multiprocessing engine: dottxt-ai/outlines-core#99 I assume more and more will change over to `xgrammar`.\n\nThis is a minimum implementation. https://arxiv.org/pdf/2411.15100 Signed-off-by: Jannis SchÃ¶nleber <joennlae@gmail.com> dongxiaolong mentioned this pull request Dec 2, 2024 [Feature]: Integrate with XGrammar for zero-overhead structured generation in LLM inference. #10660 Closed 1 task Copy link Member mgoin commented Dec 2, 2024 @Ubospica do you know when XGrammar can support regex? This would help with covering existing use cases All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . 7 hidden items Load moreâ€¦ mgoin added 3 commits December 2, 2024 22:54 Fix tests and support json_object â€¦ 8962301 Signed-off-by: mgoin <michael@neuralmagic.com> Fix test 8d3c671 Merge branch 'main' into feat/xgrammar 9f97093 mgoin requested review from DarkLight1337 , robertgshaw2-redhat and simon-mo as code owners December 2, 2024 22:56 mergify bot added\n  the frontend label Dec 2, 2024 simon-mo changed the title [Core][Performance] Add XGrammar support for guided decoding [Core][Performance] Add XGrammar support for guided decoding and set it as default Dec 3, 2024 simon-mo previously approved these changes Dec 3, 2024 View reviewed changes vllm/entrypoints/llm.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . simon-mo dismissed\n    their stale review December 3, 2024 01:41 if isinstance(params, Sequence) else copy.copy(params), is actually a blocking review. We can only introduce it if it is not perf regression. Move copy down into guided decoding case â€¦ 975e040 Signed-off-by: mgoin <michael@neuralmagic.com> Copy link Member mgoin commented Dec 3, 2024 Thanks for review @simon-mo I moved the copy into a specific if sampling_params.guided_decoding is not None case - ready for re-review All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . aarnphm added 2 commits December 2, 2024 22:11 chore: fix coallesce type â€¦ 59221e6 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> chore: add notes for performance â€¦ 5f49734 Signed-off-by: Aaron Pham <contact@aarnphm.xyz> aarnphm force-pushed the feat/xgrammar branch\n    from 4ee464a to 5f49734 Compare December 3, 2024 03:16 simon-mo approved these changes Dec 3, 2024 View reviewed changes Hide details View details DarkLight1337 merged commit 9323a31 into vllm-project : main Dec 3, 2024 73 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Member hmellor commented Dec 3, 2024 The new dependency in this PR appears to have broken installation on ARM 8.373 ERROR: Could not find a version that satisfies the requirement xgrammar (from versions: none)\n8.419 ERROR: No matching distribution found for xgrammar\n------\nDockerfile.arm:37\n--------------------\n  36 |     \n  37 | >>> RUN --mount=type=cache,target=/root/.cache/pip \\\n  38 | >>>     --mount=type=bind,src=requirements-common.txt,target=requirements-common.txt \\\n  39 | >>>     --mount=type=bind,src=requirements-cpu.txt,target=requirements-cpu.txt \\\n  40 | >>>     pip install -v -r requirements-cpu.txt\n  41 |     \n--------------------\nERROR: failed to solve: process \"/bin/sh -c pip install -v -r requirements-cpu.txt\" did not complete successfully: exit code: 1 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member mgoin commented Dec 3, 2024 Thanks for reporting @hmellor indeed it seems there isn't a manylinux arm wheel available https://pypi.org/project/xgrammar/#files I'll work on a patch fix All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin mentioned this pull request Dec 3, 2024 [Bugfix] Only require XGrammar on x86 #10865 Merged Copy link stefanobranco commented Dec 3, 2024 Obviously super cool to see new integrations, but it does seem a bit hasty to me to immediately change the default? The implementation with outlines core should be able to close the gap after all, and this one does not support regex yet. Or is xgrammar just objectively better? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor joennlae commented Dec 3, 2024 I second this opinion. Currently, the same behaviour cannot be expected from 'grammar`. I added a simple PR with some rudimentary regex + integer range support ( mlc-ai/xgrammar#106 ). I can attest that it is much faster, especially if one uses dynamic schemas. However, we should use outlines as the default, as it supports more cases for now, and the change is not breaking for many. I introduced it as an option in my closed PR ( #10803 ). But I forgot it when I discussed it with @mgoin . ðŸ‘ 1 robcaulk reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member mgoin commented Dec 3, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Hi @stefanobranco and @joennlae thanks for raising your concern. Our primary concern is immediately improving structured output performance where it is easy to do so while maintaining the same behavior. With xgrammar as the default in supported cases, we still fallback to outlines in several cases covered here https://github.com/vllm-project/vllm/blob/main/vllm/model_executor/guided_decoding/__init__.py#L18-L48 Please let me know if a case isn't being accounted for that is affecting your usage. We do not want to change external behavior. We have several integration tests that I have been using to create these rules, but more test points are certainly welcome! We have several fast-followup items to reduce the special cases around using xgrammar and improving performance even further in V0. We are also working on enabling outlines>=0.1.8 support with the devs of that project. Then of course we will enable the usage of structured output in V1. I hope this is helpful context and we will work on making a public roadmap for longer term goals. Please join the #feat-structured-output channel in slack if you want to have more direct discussion with the people working on this. ðŸ‘ 2 stefanobranco and joennlae reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin mentioned this pull request Dec 4, 2024 [Bugfix] Fallback to outlines for complex json schemas #10899 Merged Copy link Ubospica commented Dec 5, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Thanks @stefanobranco , @joennlae , @ @mgoin for great feedbacks. The first initial release of XGrammar focuses on performance across grammar and json schema. We would like to ensure the system is holistically design to ensure zero overhead structure output, which aligns with many users needs we also see. Now that initial release land, we are working full steam to enable full support for JSON schema and regex. Thank you for these great feedbacks and please feel free to open new issues on XGrammar to give us feedbacks. Our general mission is to enable bringing flexible, zero-overhead structured generation everywhere, and we are excited to work with the community here to achieve that mission together, thank you for these feedbacks and we love contributions and collaborations to bring better, zero-overhead structured output for everyone ðŸ‘ 3 Swipe4057, saattrupdan, and WangErXiao reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . sleepwalker2017 pushed a commit\n        to sleepwalker2017/vllm\n      that referenced\n      this pull request Dec 13, 2024 [Core][Performance] Add XGrammar support for guided decoding and set â€¦ â€¦ edebf1d â€¦it as default ( vllm-project#10785 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com> Copy link ktrapeznikov commented Dec 19, 2024 will this support models that use mistral tokenizers? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor robcaulk commented Feb 14, 2025 @joennlae Pointed out correctly that changing the default value from outlines to xgrammar was a breaking change. This should have been highlighted in the release notes as a breaking change. @mgoin you had the foresight to avoid changing behavior, but unfortunately, this change did change the behavior. The issue now is that the quality of output from xgrammar is not as high. It does not conform to Literal definitions in the schema. Outlines does. This broke quite a bit of our pipeline - as we require Literals. We will define outlines explicitly now to avoid the shortcoming of xgrammar, but I highly recommend to the maintainers ( @simon-mo ) that any breaking changes be properly highlighted in release notes in the future. ðŸ‘ 2 aastroza and simon-mo reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . aarnphm deleted the feat/xgrammar branch March 19, 2025 11:02 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:38", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, Throughput, Throughput | SERVING: frontend, frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:38", "models": ["meta-llama/Llama-3.1-8B-Instruct"], "lm_eval_commands": null, "perf_command": "python benchmark_guided.py --model meta-llama/Llama-3.1-8B-Instruct --dataset xgrammar_bench --async-engine --output-len 512 --num-prompts 20 --enable-chunked-prefill --guided-decoding-ratio 1", "commit_subject": "[Core][Performance] Add XGrammar support for guided decoding and set it as default (#10785)", "commit_message": "[Core][Performance] Add XGrammar support for guided decoding and set it as default (#10785)\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>", "commit_date": "2024-12-03T15:17:00+08:00", "files_changed": ["docs/source/conf.py", "requirements-common.txt", "tests/entrypoints/llm/test_guided_generate.py", "tests/model_executor/test_guided_processors.py", "vllm/config.py", "vllm/engine/arg_utils.py", "vllm/engine/async_llm_engine.py", "vllm/engine/llm_engine.py", "vllm/engine/multiprocessing/client.py", "vllm/model_executor/guided_decoding/__init__.py", "vllm/model_executor/guided_decoding/xgrammar_decoding.py"], "functions_changed": [], "stats": {"num_test_files": 2, "num_non_test_files": 9, "only_test_files": 0, "only_non_test_files": 0, "num_files": 11, "num_hunks": 22, "num_edited_lines": 418, "num_non_test_edited_lines": 388, "commit_year": 2024}, "diff_text": "diff --git a/docs/source/conf.py b/docs/source/conf.py\nindex 4a1a5fb45..e9d9ac68c 100644\n--- a/docs/source/conf.py\n+++ b/docs/source/conf.py\n@@ -178,6 +178,7 @@ autodoc_mock_imports = [\n     \"tensorizer\",\n     \"pynvml\",\n     \"outlines\",\n+    \"xgrammar,\"\n     \"librosa\",\n     \"soundfile\",\n     \"gguf\",\ndiff --git a/requirements-common.txt b/requirements-common.txt\nindex 02e3d65fb..818f72e14 100644\n--- a/requirements-common.txt\n+++ b/requirements-common.txt\n@@ -19,6 +19,7 @@ prometheus-fastapi-instrumentator >= 7.0.0\n tiktoken >= 0.6.0  # Required for DBRX tokenizer\n lm-format-enforcer >= 0.10.9, < 0.11\n outlines >= 0.0.43, < 0.1\n+xgrammar\n typing_extensions >= 4.10\n filelock >= 3.16.1 # need to contain https://github.com/tox-dev/filelock/pull/317\n partial-json-parser # used for parsing partial JSON outputs\ndiff --git a/tests/entrypoints/llm/test_guided_generate.py b/tests/entrypoints/llm/test_guided_generate.py\nindex 67c79415f..c3706f696 100644\n--- a/tests/entrypoints/llm/test_guided_generate.py\n+++ b/tests/entrypoints/llm/test_guided_generate.py\n@@ -159,3 +159,30 @@ def test_validation_against_both_guided_decoding_options(sample_regex, llm):\n                      sampling_params=sampling_params,\n                      use_tqdm=True,\n                      guided_options_request=dict(guided_regex=sample_regex))\n+\n+\n+@pytest.mark.skip_global_cleanup\n+def test_guided_json_object(llm):\n+    sampling_params = SamplingParams(\n+        temperature=1.0,\n+        max_tokens=100,\n+        guided_decoding=GuidedDecodingParams(json_object=True))\n+\n+    outputs = llm.generate(\n+        prompts=(\"Generate a JSON object describing a person with name \"\n+                 \"and age for John Smith who is 31 years old.\"),\n+        sampling_params=sampling_params,\n+        use_tqdm=True)\n+\n+    assert outputs is not None\n+    for output in outputs:\n+        assert output is not None\n+        assert isinstance(output, RequestOutput)\n+\n+        generated_text = output.outputs[0].text\n+        print(generated_text)\n+        assert generated_text is not None\n+\n+        # Parse to verify it is valid JSON\n+        parsed_json = json.loads(generated_text)\n+        assert isinstance(parsed_json, dict)\ndiff --git a/tests/model_executor/test_guided_processors.py b/tests/model_executor/test_guided_processors.py\nindex 45fab8e96..9f4d81b58 100644\n--- a/tests/model_executor/test_guided_processors.py\n+++ b/tests/model_executor/test_guided_processors.py\n@@ -36,7 +36,8 @@ def test_guided_logits_processors(sample_regex, sample_json_schema):\n \n \n @pytest.mark.asyncio\n-@pytest.mark.parametrize(\"backend\", [\"outlines\", \"lm-format-enforcer\"])\n+@pytest.mark.parametrize(\"backend\",\n+                         [\"outlines\", \"lm-format-enforcer\", \"xgrammar\"])\n async def test_guided_logits_processor_black_box(backend: str, sample_regex,\n                                                  sample_json_schema):\n     tokenizer = AutoTokenizer.from_pretrained('HuggingFaceH4/zephyr-7b-beta')\ndiff --git a/vllm/config.py b/vllm/config.py\nindex 326340d3f..971eb36d6 100644\n--- a/vllm/config.py\n+++ b/vllm/config.py\n@@ -1789,15 +1789,15 @@ class PoolerConfig:\n \n     step_tag_id: Optional[int] = None\n     \"\"\"\n-    If set, only the score corresponding to the ``step_tag_id`` in the \n+    If set, only the score corresponding to the ``step_tag_id`` in the\n     generated sentence should be returned. Otherwise, the scores for all tokens\n     are returned.\n     \"\"\"\n \n     returned_token_ids: Optional[List[int]] = None\n     \"\"\"\n-    A list of indices for the vocabulary dimensions to be extracted, \n-    such as the token IDs of ``good_token`` and ``bad_token`` in the \n+    A list of indices for the vocabulary dimensions to be extracted,\n+    such as the token IDs of ``good_token`` and ``bad_token`` in the\n     ``math-shepherd-mistral-7b-prm`` model.\n     \"\"\"\n \n@@ -2031,11 +2031,12 @@ def get_served_model_name(model: str,\n class DecodingConfig:\n     \"\"\"Dataclass which contains the decoding strategy of the engine\"\"\"\n \n-    # Which guided decoding algo to use. 'outlines' / 'lm-format-enforcer'\n-    guided_decoding_backend: str = 'outlines'\n+    # Which guided decoding algo to use.\n+    # 'outlines' / 'lm-format-enforcer' / 'xgrammar'\n+    guided_decoding_backend: str = 'xgrammar'\n \n     def __post_init__(self):\n-        valid_guided_backends = ['outlines', 'lm-format-enforcer']\n+        valid_guided_backends = ['outlines', 'lm-format-enforcer', 'xgrammar']\n         backend = self.guided_decoding_backend\n         if backend not in valid_guided_backends:\n             raise ValueError(f\"Invalid guided_decoding_backend '{backend},\"\n@@ -2222,7 +2223,7 @@ class CompilationConfig(BaseModel):\n             from Python, functions can also be passed directly via Python object\n             constructor, e.g. `CompilationConfig(inductor_passes={\"a\": func})`\n         - custom inductor passes: see PassConfig for more details\n-    \n+\n     Why we have different sizes for cudagraph and inductor:\n     - cudagraph: a cudagraph captured for a specific size can only be used\n         for the same size. We need to capture all the sizes we want to use.\ndiff --git a/vllm/engine/arg_utils.py b/vllm/engine/arg_utils.py\nindex 4aa0eebd9..3b776c1d9 100644\n--- a/vllm/engine/arg_utils.py\n+++ b/vllm/engine/arg_utils.py\n@@ -168,7 +168,7 @@ class EngineArgs:\n     scheduler_delay_factor: float = 0.0\n     enable_chunked_prefill: Optional[bool] = None\n \n-    guided_decoding_backend: str = 'outlines'\n+    guided_decoding_backend: str = 'xgrammar'\n     # Speculative decoding configuration.\n     speculative_model: Optional[str] = None\n     speculative_model_quantization: Optional[str] = None\n@@ -364,11 +364,12 @@ class EngineArgs:\n         parser.add_argument(\n             '--guided-decoding-backend',\n             type=str,\n-            default='outlines',\n-            choices=['outlines', 'lm-format-enforcer'],\n+            default='xgrammar',\n+            choices=['outlines', 'lm-format-enforcer', 'xgrammar'],\n             help='Which engine will be used for guided decoding'\n             ' (JSON schema / regex etc) by default. Currently support '\n-            'https://github.com/outlines-dev/outlines and '\n+            'https://github.com/outlines-dev/outlines,'\n+            'https://github.com/mlc-ai/xgrammar, and '\n             'https://github.com/noamgat/lm-format-enforcer.'\n             ' Can be overridden per request via guided_decoding_backend'\n             ' parameter.')\ndiff --git a/vllm/engine/async_llm_engine.py b/vllm/engine/async_llm_engine.py\nindex 4395588d2..60dccd7a0 100644\n--- a/vllm/engine/async_llm_engine.py\n+++ b/vllm/engine/async_llm_engine.py\n@@ -1,4 +1,5 @@\n import asyncio\n+import copy\n import time\n import weakref\n from functools import partial\n@@ -507,7 +508,8 @@ class _AsyncLLMEngine(LLMEngine):\n                 sampling_params=params,\n                 tokenizer=await self.get_tokenizer_async(lora_request),\n                 default_guided_backend=self.decoding_config.\n-                guided_decoding_backend)\n+                guided_decoding_backend,\n+                model_config=self.model_config)\n \n         self._add_processed_request(\n             request_id=request_id,\n@@ -528,22 +530,30 @@ class _AsyncLLMEngine(LLMEngine):\n \n async def build_guided_decoding_logits_processor_async(\n         sampling_params: SamplingParams, tokenizer: AnyTokenizer,\n-        default_guided_backend: str) -> SamplingParams:\n+        default_guided_backend: str,\n+        model_config: ModelConfig) -> SamplingParams:\n     \"\"\"Constructs logits processors based on the guided_decoding,\n     logits_bias, and allowed_token_ids fields in sampling_params. Deletes\n     those fields and adds the constructed logits processors to the\n     logits_processors field. Modifies sampling params in-place and returns\n     the modified sampling params.\"\"\"\n-    if (guided_decoding := sampling_params.guided_decoding) is None:\n+    if sampling_params.guided_decoding is None:\n         return sampling_params\n \n+    # Defensively copy sampling params since guided decoding logits\n+    # processors can have different state for each request\n+    sampling_params = copy.copy(sampling_params)\n+    guided_decoding = sampling_params.guided_decoding\n+\n     logger.debug(\"Building guided decoding logits processor. \"\n                  \"Params: %s\", guided_decoding)\n \n     guided_decoding.backend = guided_decoding.backend or default_guided_backend\n \n     processor = await get_guided_decoding_logits_processor(\n-        guided_params=guided_decoding, tokenizer=tokenizer)\n+        guided_params=guided_decoding,\n+        tokenizer=tokenizer,\n+        model_config=model_config)\n \n     if processor:\n         if sampling_params.logits_processors is None:\ndiff --git a/vllm/engine/llm_engine.py b/vllm/engine/llm_engine.py\nindex dd55aa281..af66b3070 100644\n--- a/vllm/engine/llm_engine.py\n+++ b/vllm/engine/llm_engine.py\n@@ -1,3 +1,4 @@\n+import copy\n import time\n from collections import Counter as collectionsCounter\n from collections import deque\n@@ -1024,9 +1025,9 @@ class LLMEngine:\n         This function updates num_computed_tokens for prompt sequences\n         when Multi-Step is enabled.\n \n-        seq_group: SequenceGroup to update the num_computed_tokens for. \n+        seq_group: SequenceGroup to update the num_computed_tokens for.\n         seq_group_meta: Metadata of the given SequenceGroup.\n-        is_first_step_output: Optional[bool] - \n+        is_first_step_output: Optional[bool] -\n             When available, is_first_step_output indicates if the appended\n             output token is the output of the first-step in multi-step.\n             A value of None indicates that outputs from all steps in\n@@ -2036,7 +2037,11 @@ class LLMEngine:\n \n         logits_processors = []\n \n-        if (guided_decoding := sampling_params.guided_decoding) is not None:\n+        if sampling_params.guided_decoding is not None:\n+            # Defensively copy sampling params since guided decoding logits\n+            # processors can have different state for each request\n+            sampling_params = copy.copy(sampling_params)\n+            guided_decoding = sampling_params.guided_decoding\n \n             logger.debug(\n                 \"Building guided decoding logits processor in \"\n@@ -2047,7 +2052,9 @@ class LLMEngine:\n                 self.decoding_config.guided_decoding_backend\n \n             processor = get_local_guided_decoding_logits_processor(\n-                guided_params=guided_decoding, tokenizer=tokenizer)\n+                guided_params=guided_decoding,\n+                tokenizer=tokenizer,\n+                model_config=self.model_config)\n             if processor:\n                 logits_processors.append(processor)\n \ndiff --git a/vllm/engine/multiprocessing/client.py b/vllm/engine/multiprocessing/client.py\nindex 8383e774d..d21136c03 100644\n--- a/vllm/engine/multiprocessing/client.py\n+++ b/vllm/engine/multiprocessing/client.py\n@@ -474,8 +474,8 @@ class MQLLMEngineClient(EngineClient):\n             trace_headers: OpenTelemetry trace headers.\n             prompt_adapter_request: Prompt Adapter request to use\n                                             for generation, if any.\n-            priority: Priority of the request (lower means earlier handling). \n-                Any priority other than 0 will lead to an error if the \n+            priority: Priority of the request (lower means earlier handling).\n+                Any priority other than 0 will lead to an error if the\n                 scheduling policy is not \"priority\".\n         \"\"\"\n         if inputs is not None:\n@@ -589,6 +589,7 @@ class MQLLMEngineClient(EngineClient):\n                     default_guided_backend=(self.decoding_config.guided_decoding_backend\n                         if self.decoding_config\n                         else DecodingConfig.guided_decoding_backend),\n+                    model_config=self.model_config\n                 )\n \n         # 1) Create output queue for this requests.\ndiff --git a/vllm/model_executor/guided_decoding/__init__.py b/vllm/model_executor/guided_decoding/__init__.py\nindex d7b67425f..23c31fcfd 100644\n--- a/vllm/model_executor/guided_decoding/__init__.py\n+++ b/vllm/model_executor/guided_decoding/__init__.py\n@@ -1,14 +1,54 @@\n-from typing import Optional\n+from __future__ import annotations\n \n-from vllm.logits_process import LogitsProcessor\n-from vllm.sampling_params import GuidedDecodingParams\n+from typing import TYPE_CHECKING\n+\n+from vllm.logger import init_logger\n+\n+if TYPE_CHECKING:\n+    from transformers import PreTrainedTokenizer\n+\n+    from vllm.config import ModelConfig\n+    from vllm.logits_process import LogitsProcessor\n+    from vllm.sampling_params import GuidedDecodingParams\n+\n+logger = init_logger(__name__)\n+\n+\n+def maybe_backend_fallback(\n+        guided_params: GuidedDecodingParams) -> GuidedDecodingParams:\n+    # lm-format-enforce doesn't support grammar, fallback to xgrammar\n+    if (guided_params.backend == \"lm-format-enforcer\"\n+            and guided_params.grammar is not None):\n+        logger.warning(\n+            \"lm-format-enforcer does not support grammar guided decoding. \"\n+            \"Falling back to use xgrammar instead.\")\n+        guided_params.backend = \"xgrammar\"\n+\n+    if guided_params.backend == \"xgrammar\":\n+        # xgrammar doesn't support regex or choice, fallback to outlines\n+        if guided_params.regex is not None or guided_params.choice is not None:\n+            logger.warning(\n+                \"xgrammar only supports json or grammar guided decoding. \"\n+                \"Falling back to use outlines instead.\")\n+            guided_params.backend = \"outlines\"\n+\n+        # xgrammar only supports EBNF grammars and uses the GBNF format\n+        # https://github.com/ggerganov/llama.cpp/blob/master/grammars/README.md\n+        elif (guided_params.grammar is not None\n+              and \"::=\" not in guided_params.grammar):\n+            logger.warning(\"xgrammar only supports EBNF grammars. \"\n+                           \"Falling back to use outlines instead.\")\n+            guided_params.backend = \"outlines\"\n+\n+    return guided_params\n \n \n async def get_guided_decoding_logits_processor(\n-        guided_params: GuidedDecodingParams,\n-        tokenizer) -> Optional[LogitsProcessor]:\n+        guided_params: GuidedDecodingParams, tokenizer: PreTrainedTokenizer,\n+        model_config: ModelConfig) -> LogitsProcessor | None:\n+    guided_params = maybe_backend_fallback(guided_params)\n     # CFG grammar not supported by LMFE, so we use outlines instead\n-    if guided_params.backend == 'outlines' or guided_params.grammar:\n+    if guided_params.backend == 'outlines':\n         # NOTE: lazy import outlines to avoid https://github.com/vllm-project/vllm/issues/4193\n         from vllm.model_executor.guided_decoding.outlines_decoding import (  # noqa\n             get_outlines_guided_decoding_logits_processor)\n@@ -19,17 +59,23 @@ async def get_guided_decoding_logits_processor(\n             get_local_lm_format_enforcer_guided_decoding_logits_processor)\n         return get_local_lm_format_enforcer_guided_decoding_logits_processor(\n             guided_params, tokenizer)\n+    if guided_params.backend == 'xgrammar':\n+        from vllm.model_executor.guided_decoding.xgrammar_decoding import (  # noqa\n+            get_local_xgrammar_guided_decoding_logits_processor)\n+        return get_local_xgrammar_guided_decoding_logits_processor(\n+            guided_params, tokenizer, model_config)\n \n     raise ValueError(\n         f\"Unknown guided decoding backend '{guided_params.backend}'. \"\n-        \"Must be one of 'outlines, 'lm-format-enforcer'\")\n+        \"Must be one of 'outlines, 'lm-format-enforcer', 'xgrammar'\")\n \n \n def get_local_guided_decoding_logits_processor(\n-        guided_params: GuidedDecodingParams,\n-        tokenizer) -> Optional[LogitsProcessor]:\n+        guided_params: GuidedDecodingParams, tokenizer: PreTrainedTokenizer,\n+        model_config: ModelConfig) -> LogitsProcessor | None:\n+    guided_params = maybe_backend_fallback(guided_params)\n     # CFG grammar not supported by LMFE, so we use outlines instead\n-    if guided_params.backend == 'outlines' or guided_params.grammar:\n+    if guided_params.backend == 'outlines':\n         # NOTE: lazy import outlines to avoid https://github.com/vllm-project/vllm/issues/4193\n         from vllm.model_executor.guided_decoding.outlines_decoding import (  # noqa\n             get_local_outlines_guided_decoding_logits_processor)\n@@ -40,7 +86,12 @@ def get_local_guided_decoding_logits_processor(\n             get_local_lm_format_enforcer_guided_decoding_logits_processor)\n         return get_local_lm_format_enforcer_guided_decoding_logits_processor(\n             guided_params, tokenizer)\n+    if guided_params.backend == 'xgrammar':\n+        from vllm.model_executor.guided_decoding.xgrammar_decoding import (  # noqa\n+            get_local_xgrammar_guided_decoding_logits_processor)\n+        return get_local_xgrammar_guided_decoding_logits_processor(\n+            guided_params, tokenizer, model_config)\n \n     raise ValueError(\n         f\"Unknown guided decoding backend '{guided_params.backend}'. \"\n-        \"Must be one of 'outlines, 'lm-format-enforcer'\")\n+        \"Must be one of 'outlines, 'lm-format-enforcer', 'xgrammar'\")\ndiff --git a/vllm/model_executor/guided_decoding/xgrammar_decoding.py b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\nnew file mode 100644\nindex 000000000..8287cd6cf\n--- /dev/null\n+++ b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\n@@ -0,0 +1,251 @@\n+# noqa: UP007\n+from __future__ import annotations\n+\n+import json\n+from dataclasses import dataclass, field\n+from typing import TYPE_CHECKING, Any, NamedTuple\n+\n+import torch\n+from transformers import PreTrainedTokenizerFast\n+\n+try:\n+    import xgrammar as xgr\n+    from xgrammar.base import _core as xgr_core\n+except ImportError:\n+    pass\n+\n+if TYPE_CHECKING:\n+    from transformers import PreTrainedTokenizer\n+\n+    from vllm.config import ModelConfig\n+    from vllm.sampling_params import GuidedDecodingParams\n+\n+\n+# TODO: passing batch size to max threads here\n+def get_local_xgrammar_guided_decoding_logits_processor(\n+        guided_params: GuidedDecodingParams,\n+        tokenizer: PreTrainedTokenizer,\n+        model_config: ModelConfig,\n+        max_threads: int = 8):\n+    config = GrammarConfig.from_guided_params(guided_params=guided_params,\n+                                              model_config=model_config,\n+                                              tokenizer=tokenizer,\n+                                              max_threads=max_threads)\n+    return XGrammarLogitsProcessor(config)\n+\n+\n+class TokenizerData(NamedTuple):\n+    \"\"\"Immutable container for cached tokenizer data.\"\"\"\n+    encoded_vocab: list[str]\n+    stop_token_ids: list[int] | None\n+    backend_str: str\n+\n+\n+class TokenizerDataCache:\n+    \"\"\"Cache manager for tokenizer data to avoid repeated processing.\"\"\"\n+    _cache: dict[int, TokenizerData] = {}\n+\n+    @classmethod\n+    def get_tokenizer_data(cls,\n+                           tokenizer: PreTrainedTokenizer) -> TokenizerData:\n+        tokenizer_hash = hash(tokenizer)\n+\n+        if tokenizer_hash not in cls._cache:\n+            # Vendored from xgrammar logic since we cannot pickle the tokenizer\n+            # https://github.com/mlc-ai/xgrammar/blob/d77c0a0173ef14779c918e3be7966ba852f7910f/python/xgrammar/tokenizer_info.py#L98 # noqa: E501\n+            try:\n+                encoded_vocab = [\n+                    token for token, _ in sorted(tokenizer.get_vocab().items(),\n+                                                 key=lambda x: x[1])\n+                ]\n+            except AttributeError as e:\n+                raise ValueError(\n+                    f\"Cannot get the vocabulary of the tokenizer \"\n+                    f\"{type(tokenizer)}. The tokenizer should have a \"\n+                    \"get_vocab method.\") from e\n+\n+            stop_token_ids = None\n+            backend_str = xgr.VocabType.RAW\n+            if isinstance(tokenizer, PreTrainedTokenizerFast):\n+                backend_str = tokenizer.backend_tokenizer.to_str()\n+                if stop_token_ids is None and hasattr(\n+                        tokenizer,\n+                        \"eos_token_id\") and tokenizer.eos_token_id is not None:\n+                    stop_token_ids = [tokenizer.eos_token_id]\n+\n+            cls._cache[tokenizer_hash] = TokenizerData(\n+                encoded_vocab=encoded_vocab,\n+                stop_token_ids=stop_token_ids,\n+                backend_str=backend_str)\n+\n+        return cls._cache[tokenizer_hash]\n+\n+\n+class GrammarCompilerCache:\n+    \"\"\"\n+    Cache for GrammarCompiler instances based on tokenizer.\n+\n+    This cache reduces the overhead of creating new compiler instances when\n+    using the same tokenizer configuration.\n+    \"\"\"\n+    _cache: dict[str, xgr.GrammarCompiler] = {}\n+\n+    @classmethod\n+    def get_compiler(cls, config: GrammarConfig) -> xgr.GrammarCompiler:\n+        cache_key = str(config.tokenizer_hash)\n+\n+        if cache_key not in cls._cache:\n+            assert config.encoded_vocab is not None\n+            tokenizer_info = xgr.TokenizerInfo._create_from_handle(\n+                xgr_core.TokenizerInfo.from_huggingface(\n+                    config.encoded_vocab, config.backend_str,\n+                    config.vocab_size, config.stop_token_ids))\n+            cls._cache[cache_key] = xgr.GrammarCompiler(\n+                tokenizer_info, max_threads=config.max_threads)\n+\n+        return cls._cache[cache_key]\n+\n+\n+@dataclass\n+class GrammarConfig:\n+    \"\"\"Serializable configuration for grammar compilation\"\"\"\n+    tokenizer_hash: int\n+    vocab_size: int\n+    json_str: str | None = None\n+    grammar_str: str | None = None\n+    json_object: bool | None = None\n+    max_threads: int = 8\n+    # Only populated if tokenizer_hash not in cache\n+    encoded_vocab: list[str] | None = None\n+    stop_token_ids: list[int] | None = None\n+    backend_str: str | None = None\n+\n+    @classmethod\n+    def from_guided_params(cls,\n+                           guided_params: GuidedDecodingParams,\n+                           model_config: ModelConfig,\n+                           tokenizer: PreTrainedTokenizer,\n+                           max_threads: int = 8) -> GrammarConfig:\n+\n+        tokenizer_hash = hash(tokenizer)\n+        # Only get tokenizer data if not already cached\n+        if tokenizer_hash in TokenizerDataCache._cache:\n+            encoded_vocab = None\n+            stop_token_ids = None\n+            backend_str = None\n+        else:\n+            tokenizer_data = TokenizerDataCache.get_tokenizer_data(tokenizer)\n+            encoded_vocab = tokenizer_data.encoded_vocab\n+            stop_token_ids = tokenizer_data.stop_token_ids\n+            backend_str = tokenizer_data.backend_str\n+\n+        if guided_params.json:\n+            if not isinstance(guided_params.json, str):\n+                json_str = json.dumps(guided_params.json)\n+            else:\n+                json_str = guided_params.json\n+            return cls(json_str=json_str,\n+                       vocab_size=model_config.hf_config.vocab_size,\n+                       encoded_vocab=encoded_vocab,\n+                       stop_token_ids=stop_token_ids,\n+                       backend_str=backend_str,\n+                       tokenizer_hash=tokenizer_hash,\n+                       max_threads=max_threads)\n+        elif guided_params.grammar:\n+            return cls(grammar_str=guided_params.grammar,\n+                       vocab_size=model_config.hf_config.vocab_size,\n+                       encoded_vocab=encoded_vocab,\n+                       stop_token_ids=stop_token_ids,\n+                       backend_str=backend_str,\n+                       tokenizer_hash=tokenizer_hash,\n+                       max_threads=max_threads)\n+        elif guided_params.json_object:\n+            return cls(json_object=True,\n+                       vocab_size=model_config.hf_config.vocab_size,\n+                       encoded_vocab=encoded_vocab,\n+                       stop_token_ids=stop_token_ids,\n+                       backend_str=backend_str,\n+                       tokenizer_hash=tokenizer_hash,\n+                       max_threads=max_threads)\n+        else:\n+            raise ValueError(\n+                \"Currently only support JSON and EBNF grammar mode for xgrammar\"\n+            )\n+\n+\n+@dataclass\n+class XGrammarLogitsProcessor:\n+    \"\"\"Wrapper class to support pickle protocol\"\"\"\n+    config: GrammarConfig\n+\n+    ctx: xgr.CompiledGrammar | None = None\n+    token_bitmask: torch.Tensor = None  # type: ignore[assignment]\n+    matchers: list[xgr.GrammarMatcher] = field(default_factory=list)\n+    batch_size: int = field(default=1)\n+    prefilled: bool = field(default=False)\n+\n+    def __getstate__(self) -> dict[str, Any]:\n+        return {'config': self.config}\n+\n+    def __setstate__(self, state: dict[str, Any]):\n+        self.config = state['config']\n+\n+        self.ctx = None\n+        self.matchers = []\n+        self.batch_size = 1\n+        self.token_bitmask = None  # type: ignore[assignment]\n+        self.prefilled = False\n+\n+    def _ensure_ctx(self):\n+        \"\"\"Lazily initialize the processor in the worker process\"\"\"\n+        if self.ctx is None:\n+            compiler = GrammarCompilerCache.get_compiler(self.config)\n+            if self.config.json_str is not None:\n+                self.ctx = compiler.compile_json_schema(self.config.json_str)\n+            elif self.config.grammar_str is not None:\n+                self.ctx = compiler.compile_grammar(self.config.grammar_str)\n+            elif self.config.json_object:\n+                self.ctx = compiler.compile_builtin_json_grammar()\n+            else:\n+                raise ValueError(\n+                    \"Invalid configuration for xgrammar logits processor\")\n+\n+    def __call__(self, input_ids: list[int],\n+                 scores: torch.Tensor) -> torch.Tensor:\n+        if self.ctx is None:\n+            self._ensure_ctx()\n+\n+        if len(self.matchers) == 0:\n+            self.matchers = [\n+                xgr.GrammarMatcher(self.ctx) for _ in range(self.batch_size)\n+            ]\n+            self.token_bitmask = xgr.allocate_token_bitmask(\n+                self.batch_size, self.config.vocab_size)\n+\n+        if not self.prefilled:\n+            # Have not sampled a token yet\n+            self.prefilled = True\n+        else:\n+            for i, matcher in enumerate(self.matchers):\n+                if not matcher.is_terminated():\n+                    sampled_token = input_ids[-1]\n+                    assert self.matchers[i].accept_token(sampled_token)\n+\n+        for i, matcher in enumerate(self.matchers):\n+            if not matcher.is_terminated():\n+                # @ubospica: ideally, fill_next_token_bitmask should be\n+                # parallelized with model decoding\n+                # See https://github.com/vllm-project/vllm/pull/10785/files#r1864278303\n+                matcher.fill_next_token_bitmask(self.token_bitmask, i)\n+\n+        # token_bitmask is a CPU tensor for use with accept_token and\n+        # fill_next_token_bitmask so we move it to the device of scores\n+        device_type = scores.device.type\n+        if device_type != \"cuda\":\n+            scores = scores.to(\"cpu\")\n+        xgr.apply_token_bitmask_inplace(scores,\n+                                        self.token_bitmask.to(scores.device))\n+        if device_type != \"cuda\":\n+            scores = scores.to(device_type)\n+\n+        return scores", "apis": ["vllm.LLM.generate", "vllm.config.DecodingConfig", "vllm.engine.async_llm_engine.AsyncLLMEngine.generate"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/async_llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit introduces a new guided decoding backend called \"xgrammar\" and changes the default backend from 'outlines' to 'xgrammar'. It involves non-trivial modifications to multiple source files (including the core engine and internal API modules) rather than mere documentation or comment fixes. Its changes, including caching mechanisms in the xgrammar implementation, are aimed at optimizing the guided decoding process on CPU. Although it adds a new backend feature, the focus is on enhancing performance by improving the decoding pipeline, and the commit is tagged with [Core][Performance]. Therefore, it satisfies the performance / optimization criteria even though it introduces new functionality as an optimization improvement.", "llm_api_reason": "This commit adds support for a new guided decoding backend called â€œxgrammarâ€ and updates default values and valid choices accordingly. Changes are made in the configuration (e.g. DecodingConfig and EngineArgs), in the synchronous engine (LLMEngine) and in the async engine (AsyncLLMEngine), which are invoked by highâ€level APIs such as generate(). These modifications impact how guided decoding is selected and processed throughout the inference pipeline."}
{"commit_hash": "98f47f2a4032f8c395268de80858c64ffcfc60fa", "pr_url": "https://github.com/vllm-project/vllm/pull/10733", "pr_date": "2024-11-28", "timeline_text": "Copy link Collaborator WoosukKwon commented Nov 28, 2024 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . With piece-wise CUDA graphs, we have to make sure that the attention custom op causes minimal CPU overheads. This PR made a few changes to optimize the CPU overheads in the FlashAttention custom op: We directly use torch.ops.vllm_flash_attn_c.varlen_fwd rather than flash_attn_varlen_func , since FlashAttnFunc which inherits torch.autograd.Function causes unnecessary overheads. We move the reshapes and shape check logics to outside of the custom op, so that they can be done at the CUDA graph capture time. Results of python benchmarks/benchmark_latency.py (opt-125m) on a single H100 GPU: V1 main: 227 ms V1 this PR: 192 ms V0 + 8-step: 130 ms Next step: further reduce the unnecessary CPU ops inside the FlashAttention op. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction WoosukKwon requested review from robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners November 28, 2024 04:05 Copy link github-actions bot commented Nov 28, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Nov 28, 2024 Copy link Member youkaichao commented Nov 28, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . well, I think I forgot to update the v1 flash attention file, after #10558 , you don't need the torch.ops.vllm.unified_v1_flash_attention call. nvm All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . youkaichao reviewed Nov 28, 2024 View reviewed changes vllm/v1/attention/backends/flash_attn.py Outdated @@ -203,23 +209,31 @@ def unified_v1_flash_attention( v_scale, ) attn_output = flash_attn_varlen_func( Copy link Member youkaichao Nov 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment can you also update the corresponding v0 code? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tlrmchlsmth approved these changes Nov 28, 2024 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looking at profile results on #9856 , this saves about 60Âµs off of the CPU time spent in each flash attention call (approx 300Âµs -> 240Âµs) Thanks! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 2 mgoin and WoosukKwon reacted with rocket emoji All reactions ðŸš€ 2 reactions mgoin approved these changes Nov 28, 2024 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM with Kaichao's comment, thanks for quickly improving this. The failing test is due to neuralmagic/Phi-3-medium-128k-instruct-quantized.w4a16 and unrelated Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Re â€¦ 456980b Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon force-pushed the v1-flash-opt branch\n    from e4f8b06 to 456980b Compare November 28, 2024 16:45 Copy link Collaborator Author WoosukKwon commented Nov 28, 2024 @youkaichao @mgoin As we merged vllm-project/flash-attention#30 , we don't have to directly use torch.ops.vllm_flash_attn_c.varlen_fwd . We can just use flash_attn_varlen_func as we currently do. Both V0 and V1 already gets the benefits after vllm-project/flash-attention#30 . ðŸ‘€ 2 mgoin and youkaichao reacted with eyes emoji All reactions ðŸ‘€ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author WoosukKwon commented Nov 28, 2024 One weird phenomenon I found is that V1 has a spike in latency: Avg latency: 0.20093455887205589 seconds\n10% percentile latency: 0.1931818482640665 seconds\n25% percentile latency: 0.19354040725738741 seconds\n50% percentile latency: 0.19391279752017 seconds\n75% percentile latency: 0.19426249974640086 seconds\n90% percentile latency: 0.1961068181961309 seconds\n99% percentile latency: 0.3368887884780999 seconds This is highly reproducible on my dev machine. Can this be because of Python gc or something like that? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details WoosukKwon merged commit 98f47f2 into main Nov 28, 2024 15 of 18 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the v1-flash-opt branch November 28, 2024 17:01 Copy link Collaborator robertgshaw2-redhat commented Nov 29, 2024 One weird phenomenon I found is that V1 has a spike in latency: Avg latency: 0.20093455887205589 seconds\n10% percentile latency: 0.1931818482640665 seconds\n25% percentile latency: 0.19354040725738741 seconds\n50% percentile latency: 0.19391279752017 seconds\n75% percentile latency: 0.19426249974640086 seconds\n90% percentile latency: 0.1961068181961309 seconds\n99% percentile latency: 0.3368887884780999 seconds This is highly reproducible on my dev machine. Can this be because of Python gc or something like that? Itâ€™s probably the prefix caching â€¦ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Nov 29, 2024 Hmm but benchmark_latency.py does sample each prompts separately: https://github.com/vllm-project/vllm/blob/main/benchmarks/benchmark_latency.py#L36 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Nov 29, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Hmm but benchmark_latency.py does sample each prompts separately: https://github.com/vllm-project/vllm/blob/main/benchmarks/benchmark_latency.py#L36 Just found that it has a warmup phase. It's still possible due to prefix caching if all prompts are cached then. Suggest to explicitly disable prefix caching to double check. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author WoosukKwon commented Dec 1, 2024 @comaniac @robertgshaw2-neuralmagic You're right. The latency becomes stable when prefix caching is turned off. Avg latency: 0.1945609479948568 seconds\n10% percentile latency: 0.19310778125654907 seconds\n25% percentile latency: 0.19390572598786093 seconds\n50% percentile latency: 0.19475348049309105 seconds\n75% percentile latency: 0.195164829317946 seconds\n90% percentile latency: 0.19570096801035106 seconds\n99% percentile latency: 0.1962820820847992 seconds All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . afeldman-nm pushed a commit\n        to neuralmagic/vllm\n      that referenced\n      this pull request Dec 2, 2024 [V1] Optimize the CPU overheads in FlashAttention custom op ( vllm-proâ€¦ â€¦ bc6637c â€¦ject#10733 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Andrew Feldman <afeldman@neuralmagic.com> sleepwalker2017 pushed a commit\n        to sleepwalker2017/vllm\n      that referenced\n      this pull request Dec 13, 2024 [V1] Optimize the CPU overheads in FlashAttention custom op ( vllm-proâ€¦ â€¦ 17b4a20 â€¦ject#10733 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> anko-intel pushed a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Feb 12, 2025 [V1] Optimize the CPU overheads in FlashAttention custom op ( vllm-proâ€¦ â€¦ 34de378 â€¦ject#10733 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:41", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: latency, latency, latency | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:47:41", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_latency.py", "commit_subject": "[V1] Optimize the CPU overheads in FlashAttention custom op (#10733)", "commit_message": "[V1] Optimize the CPU overheads in FlashAttention custom op (#10733)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2024-11-28T09:01:02-08:00", "files_changed": ["vllm/v1/attention/backends/flash_attn.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 4, "num_edited_lines": 17, "num_non_test_edited_lines": 17, "commit_year": 2024}, "diff_text": "diff --git a/vllm/v1/attention/backends/flash_attn.py b/vllm/v1/attention/backends/flash_attn.py\nindex 5f8535eaa..e618edf7d 100644\n--- a/vllm/v1/attention/backends/flash_attn.py\n+++ b/vllm/v1/attention/backends/flash_attn.py\n@@ -135,6 +135,13 @@ class FlashAttentionImpl(AttentionImpl):\n         assert k_scale == 1.0 and v_scale == 1.0, (\n             \"key/v_scale is not supported in FlashAttention.\")\n \n+        # Reshape the query, key, and value tensors.\n+        # NOTE(woosuk): We do this outside the custom op to minimize the CPU\n+        # overheads from the non-CUDA-graph regions.\n+        query = query.view(-1, self.num_heads, self.head_size)\n+        key = key.view(-1, self.num_kv_heads, self.head_size)\n+        value = value.view(-1, self.num_kv_heads, self.head_size)\n+\n         output = torch.empty_like(query)\n         torch.ops.vllm.unified_v1_flash_attention(\n             output,\n@@ -153,7 +160,7 @@ class FlashAttentionImpl(AttentionImpl):\n             self.alibi_slopes,\n             self.logits_soft_cap,\n         )\n-        return output\n+        return output.view(-1, self.num_heads * self.head_size)\n \n \n def unified_v1_flash_attention(\n@@ -184,11 +191,6 @@ def unified_v1_flash_attention(\n     attn_metadata: FlashAttentionMetadata = current_metadata\n     num_actual_tokens = attn_metadata.num_actual_tokens\n \n-    # Reshape the query, key, and value tensors.\n-    query = query.view(-1, num_heads, head_size)\n-    key = key.view(-1, num_kv_heads, head_size)\n-    value = value.view(-1, num_kv_heads, head_size)\n-\n     # Reshape the input keys and values and store them in the cache.\n     key_cache = kv_cache[0]\n     value_cache = kv_cache[1]\n@@ -218,8 +220,7 @@ def unified_v1_flash_attention(\n         block_table=attn_metadata.block_table,\n         softcap=logits_soft_cap,\n     )\n-    attn_output = attn_output.view(num_actual_tokens, -1)\n-    # TODO(woosuk): Optimize this.\n+    # TODO(woosuk): Remove this unnecessary copy.\n     output[:num_actual_tokens].copy_(attn_output)", "apis": ["vllm.v1.attention.backends.flash_attn.FlashAttentionImpl.forward", "vllm.v1.attention.backends.flash_attn.unified_v1_flash_attention"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/flash_attn.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/flash_attn.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/_custom_ops.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/csrc/torch_bindings.cpp", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/csrc/cpu/torch_bindings.cpp", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/csrc/rocm/torch_bindings.cpp", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/csrc/moe/torch_bindings.cpp"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file (flash_attn.py) and contains non-trivial code changesâ€”specifically the reshaping of query, key, and value tensors outside the custom opâ€”to reduce CPU overhead in the FlashAttention implementation. The commit message explicitly refers to CPU overhead optimization, and the changes aim to minimize unnecessary CPU operations (e.g., rearranging tensor views), which directly impacts performance. These modifications are intended to improve runtime efficiency rather than fix bugs, perform refactoring, or add new features. Overall, these changes align with performance-related optimization criteria for CPU workloads.", "llm_api_reason": "The commit moves tensor reshaping for the query, key, and value out of the custom op in the FlashAttentionImpl.forward method to reduce CPU overhead, and it adjusts the final returned tensor's shape. Additionally, the internal unified_v1_flash_attention function no longer performs its own reshaping, indicating a change in how tensor dimensions are managed in the attention computation."}
{"commit_hash": "8c1e77fb585c4f42783a3d88c1efc7c9e15fd89f", "pr_url": "https://github.com/vllm-project/vllm/pull/10742", "pr_date": "2024-11-28", "timeline_text": "Copy link Collaborator WoosukKwon commented Nov 28, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Upgrades to vllm-project/flash-attention#30 , which will help reduce CPU overheads in launching the kernels. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Nov 28, 2024 WoosukKwon requested a review\n  from tlrmchlsmth as a code owner November 28, 2024 09:41 Copy link github-actions bot commented Nov 28, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the ci/build label Nov 28, 2024 WoosukKwon mentioned this pull request Nov 28, 2024 Clean up API & Bypass torch.autograd.Function vllm-project/flash-attention#30 Merged Copy link mergify bot commented Nov 28, 2024 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @WoosukKwon . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Nov 28, 2024 fix â€¦ 892cdce Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon force-pushed the test-fa branch\n    from 99c45ad to 892cdce Compare November 28, 2024 10:28 WoosukKwon changed the title test [Kernel] Update vllm-flash-attn version Nov 28, 2024 mergify bot removed\n  the needs-rebase label Nov 28, 2024 Update â€¦ 677ceb2 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Hide details View details WoosukKwon merged commit 8c1e77f into main Nov 28, 2024 9 of 14 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the test-fa branch November 28, 2024 16:31 afeldman-nm pushed a commit\n        to neuralmagic/vllm\n      that referenced\n      this pull request Dec 2, 2024 [Kernel] Update vllm-flash-attn version to reduce CPU overheads ( vllmâ€¦ â€¦ 1362dac â€¦-project#10742 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Andrew Feldman <afeldman@neuralmagic.com> sleepwalker2017 pushed a commit\n        to sleepwalker2017/vllm\n      that referenced\n      this pull request Dec 13, 2024 [Kernel] Update vllm-flash-attn version to reduce CPU overheads ( vllmâ€¦ â€¦ 5496147 â€¦-project#10742 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> anko-intel pushed a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Feb 12, 2025 [Kernel] Update vllm-flash-attn version to reduce CPU overheads ( vllmâ€¦ â€¦ c71b17d â€¦-project#10742 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:44", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:44", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Kernel] Update vllm-flash-attn version to reduce CPU overheads (#10742)", "commit_message": "[Kernel] Update vllm-flash-attn version to reduce CPU overheads (#10742)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2024-11-28T08:31:28-08:00", "files_changed": ["CMakeLists.txt"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 2, "num_non_test_edited_lines": 2, "commit_year": 2024}, "diff_text": "diff --git a/CMakeLists.txt b/CMakeLists.txt\nindex 45a3b484e..f43bf8143 100644\n--- a/CMakeLists.txt\n+++ b/CMakeLists.txt\n@@ -522,7 +522,7 @@ else()\n   FetchContent_Declare(\n           vllm-flash-attn\n           GIT_REPOSITORY https://github.com/vllm-project/flash-attention.git\n-          GIT_TAG d886f88165702b3c7e7744502772cd98b06be9e1\n+          GIT_TAG fdf6d72b48aea41f4ae6a89139a453dae554abc8\n           GIT_PROGRESS TRUE\n           # Don't share the vllm-flash-attn build between build types\n           BINARY_DIR ${CMAKE_BINARY_DIR}/vllm-flash-attn", "apis": ["None"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/flash_attn.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/flash_attn.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/triton_flash_attention.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit updates the version of an external dependency (vllm-flash-attn) by changing the git tag in a non-test file (CMakeLists.txt). The commit message indicates that this update is intended to reduce CPU overheads, meaning it is targeted at performance improvement. Although the change is small (a version update), it is specifically aimed at reducing CPU overheads, which qualifies as a performance optimization. Therefore, the commit meets the conditions specified for being performance-related.", "llm_api_reason": "The commit only updates the vllm-flash-attn git tag in the CMakeLists.txt file, which is part of the build configuration for the underlying C/C++ flash-attention kernel. No changes in the exposed Python APIs were made by this commit."}
{"commit_hash": "b2e0ad3b598ed0e022cdbd678a20821d411873c2", "pr_url": "https://github.com/vllm-project/vllm/pull/10339", "pr_date": null, "timeline_text": "Copy link Collaborator andoorve commented Nov 14, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Maintaining multiple names here will cause both to be refcounted which increases the peak memory. This will manifest as more blocks on top of each other in the memory profile: This change will increase the number of available blocks as a result of profiling especially with longer context lengths. I will follow up with a more detailed investigation in another PR/Issue that discusses this in more depth. However, creating this PR as well now as this is more or less a well-contained low-risk change. Can add to more models as well once we review this. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions andoorve marked this pull request as ready for review November 14, 2024 18:38 Copy link github-actions bot commented Nov 14, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . andoorve requested review from DarkLight1337 and youkaichao November 14, 2024 18:38 [Perf] Reduce peak memory usage â€¦ 5625ebe Maintaining multiple names here will cause both to be refcounted which increases the peak memory. This will manifest as more blocks on top of each other in the memory profile.\n\nSigned-off-by: andoorve <37849411+andoorve@users.noreply.github.com> andoorve force-pushed the llama-memory branch\n    from 358dd7e to 5625ebe Compare November 14, 2024 18:44 Copy link Member mgoin commented Nov 14, 2024 Great idea! We could apply this to many other models â¤ï¸ 1 andoorve reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . andoorve requested a review\n  from mgoin November 14, 2024 20:12 mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Nov 14, 2024 DarkLight1337 enabled auto-merge (squash) November 14, 2024 23:38 DarkLight1337 approved these changes Nov 14, 2024 View reviewed changes youkaichao reviewed Nov 15, 2024 View reviewed changes vllm/model_executor/models/llama.py @@ -90,8 +90,8 @@ def __init__( self.act_fn = SiluAndMul() def forward(self, x): gate_up, _ = self.gate_up_proj(x) Copy link Member youkaichao Nov 15, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think torch.compile can do something similar, without renaming variables. to keep the original semantic, maybe adding del x would be more intuitive. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author andoorve Nov 15, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think torch.compile can do something similar, without renaming variables. Yes, it can completely alleviate this problem, even when we consider cross-function refcounting which I'll cover in my investigation write-up. to keep the original semantic, maybe adding del x would be more intuitive. I think you might mean in this case del gate_up ? Yes indeed we can add del s and make the variable names more descriptive. I just kept it as x to avoid adding extra del s and be similar to style of the rest of the function. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details DarkLight1337 merged commit b2e0ad3 into vllm-project : main Nov 15, 2024 63 checks passed Uh oh! There was an error while loading. Please reload this page . andoorve deleted the llama-memory branch November 15, 2024 00:56 andoorve mentioned this pull request Nov 20, 2024 [DNM][Discussion] Example to decrease live tensors for activation memory. #10473 Closed sleepwalker2017 pushed a commit\n        to sleepwalker2017/vllm\n      that referenced\n      this pull request Dec 13, 2024 [Perf] Reduce peak memory usage of llama ( vllm-project#10339 ) â€¦ d26d246 Signed-off-by: andoorve <37849411+andoorve@users.noreply.github.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:46", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: profile, profile, profiling | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:47:46", "models": ["meta-llama/Llama-3.1-8B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct --tasks hellaswag --num_fewshot 0"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dataset-name sharegpt --num-prompts 100", "commit_subject": "[Perf] Reduce peak memory usage of llama (#10339)", "commit_message": "[Perf] Reduce peak memory usage of llama (#10339)\n\nSigned-off-by: andoorve <37849411+andoorve@users.noreply.github.com>", "commit_date": "2024-11-15T00:38:20Z", "files_changed": ["vllm/model_executor/models/llama.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 4, "num_non_test_edited_lines": 4, "commit_year": 2024}, "diff_text": "diff --git a/vllm/model_executor/models/llama.py b/vllm/model_executor/models/llama.py\nindex 8aed0fead..e53631ef1 100644\n--- a/vllm/model_executor/models/llama.py\n+++ b/vllm/model_executor/models/llama.py\n@@ -90,8 +90,8 @@ class LlamaMLP(nn.Module):\n         self.act_fn = SiluAndMul()\n \n     def forward(self, x):\n-        gate_up, _ = self.gate_up_proj(x)\n-        x = self.act_fn(gate_up)\n+        x, _ = self.gate_up_proj(x)\n+        x = self.act_fn(x)\n         x, _ = self.down_proj(x)\n         return x", "apis": ["LlamaModel.forward", "LlamaForCausalLM.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/llama.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_models.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The patch modifies the source code in a non-test file (llama.py) and performs a non-trivial change in the data flow of the model's MLP layer. While the commit message hints at reducing peak memory usageâ€”a performance optimizationâ€”the actual changes involve rearranging how tensor outputs are assigned and processed. This indicates a subtle change to improve memory usage (and indirectly performance) without adding new features or merely refactoring. The change is related to a core API within the model executor, affecting CPU performance. Thus, the commit satisfies the conditions for being performance related.", "llm_api_reason": "The commit modifies the LlamaMLP.forward method by inlining the projection output directly into the activation function call instead of storing it under a different variable name (â€œgate_upâ€). Although LlamaMLP is an internal helper, its change will affect the overall forward pass of the Llama model. Thus, the high-level inference APIs that users invokeâ€”namely, the forward methods of LlamaModel and LlamaForCausalLMâ€”are indirectly affected."}
{"commit_hash": "81ede99ca44a5b3518932a07ea4a76a719e7416e", "pr_url": "https://github.com/vllm-project/vllm/pull/8704", "pr_date": "2024-10-17", "timeline_text": "Copy link Collaborator KuntaiDu commented Sep 22, 2024 This PR deprecates block manager v1 and makes block manager v2 the default to simplify the code path. This is supported by this benchmark , where block manager v2 is <2% slower than block manager v1 on Llama 8B when no prefix hit, and has significant speedup upon full prefix hit. Summary of changes: Leave --use-v2-block-manager in the EngineArgs for compatibility Remove use_v2_block_manager flag in all tests and configs (except during initialization), so that the value change of use-v2-block-manager has no effect on vLLM behavior. BEFORE SUBMITTING, PLEASE READ THE CHECKLIST BELOW AND FILL IN THE DESCRIPTION ABOVE PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Adding or changing kernels Each custom kernel needs a schema and one or more implementations to be registered with PyTorch. Make sure custom ops are registered following PyTorch guidelines: Custom C++ and CUDA Operators and The Custom Operators Manual Custom operations that return Tensors require meta-functions. Meta-functions should be implemented and registered in python so that dynamic dims can be handled automatically. See above documents for a description of meta-functions. Use torch.libary.opcheck() to test the function registration and meta-function for any registered ops.  See tests/kernels for examples. When changing the C++ signature of an existing op, the schema must be updated to reflect the changes. If a new custom type is needed, see the following document: Custom Class Support in PT2 . Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 1 cadedaniel reacted with hooray emoji All reactions ðŸŽ‰ 1 reaction KuntaiDu added 7 commits September 20, 2024 05:09 remove block_manager_v1 and rename block_manager_v2 to block_manager 53cac04 remove block manager v2 related args f199d95 move the version name of block manager from v2 to main da0f9e3 remove flags that set use-v2-block-manager 59ee8fb remove v2 block manager d12ced7 remove warnings with blockmanagerv1 3203112 remove block manager v2 45d35ba Copy link github-actions bot commented Sep 22, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Sep 22, 2024 FYI: @sroy745 has #8678 verifying the functional correctness. Could you folks coordinate on this? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author KuntaiDu commented Sep 22, 2024 Sure! This PR will be a draft PR until @sroy745 verifies all the tests. I will also talk to @sroy745 and see if I can help. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . KuntaiDu marked this pull request as draft September 22, 2024 06:55 Copy link Collaborator comaniac commented Sep 22, 2024 Sure! This PR will be a draft PR until @sroy745 verifies all the tests. I will also talk to @sroy745 and see if I can help. Thanks! @sroy745 has identified some failed tests and is fixing them. We could have a tracking issue and work together on fixing them. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sroy745 commented Sep 22, 2024 Sure! This PR will be a draft PR until @sroy745 verifies all the tests. I will also talk to @sroy745 and see if I can help. Thanks! @sroy745 has identified some failed tests and is fixing them. We could have a tracking issue and work together on fixing them. I filed #8718 to track the unit test failures. I am currently looking at the test_scheduler.py failures. ðŸ‘ 2 comaniac and KuntaiDu reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . KuntaiDu added 3 commits September 25, 2024 16:07 Merge branch 'main' into kuntai-remove-blockmngerv1 ba12509 remove use_v2_block_manager in Speculative decoding config 479104c make format checker happy 17ccfd6 KuntaiDu added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Sep 25, 2024 Copy link Collaborator Author KuntaiDu commented Sep 25, 2024 Add ready to trigger full set of CI and see which test fails All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sroy745 commented Sep 26, 2024 fyi I have one pr in flight #8824 which fixes the last of the know test failures that I found earlier. ðŸ‘ 1 KuntaiDu reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . KuntaiDu added 6 commits September 26, 2024 01:59 remove v2 block manager flag c97fdac bug fix: change BlockManager to MainBlockManager 25584f7 fix wrong parameters in test, and remove the check for blockmanagerv1 1149e40 remove best_of 2 --- beam search is deprecated now a0e9e36 make ruff happy 243a8bd make yapf happy c95e720 KuntaiDu marked this pull request as ready for review September 26, 2024 03:07 KuntaiDu added 3 commits September 26, 2024 03:08 empty change to trigger CI 4afa3a3 ok 95231af Merge branch 'vllm-project:main' into kuntai-remove-blockmngerv1 46410be Isotr0py mentioned this pull request Sep 29, 2024 [Core][VLM] Add support for prefix caching for multi-modal models #8348 Closed 52 hidden items Load moreâ€¦ KuntaiDu added 4 commits October 16, 2024 06:51 make format checker happy 2e5f091 Make yapf happy ccf9362 Remove the corresponding test for \"CachedBlockAllocator\", which is onâ€¦ â€¦ fe7ea69 â€¦ly for block manager v1. Make ruff happy 3b7005b KuntaiDu requested a review\n  from comaniac October 16, 2024 19:53 Copy link Collaborator Author KuntaiDu commented Oct 16, 2024 @comaniac I fixed merge conflicts and removed some unnecessary flags and functions for block manager v1. PTAL All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac approved these changes Oct 16, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Otherwise LGTM. Also cc @sroy745 for review. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions .buildkite/test-pipeline.yaml Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tests/core/block/e2e/test_correctness.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tests/core/block/e2e/test_correctness.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tests/core/block/e2e/test_correctness.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/arg_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . sroy745 reviewed Oct 17, 2024 View reviewed changes Copy link Collaborator sroy745 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the pr!! LGTM. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tests/core/block/e2e/test_correctness.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tests/core/block/e2e/test_correctness.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/arg_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . KuntaiDu added 5 commits October 17, 2024 02:59 adjust test name and doc string to avoid reusing v1 and v2 in tesâ€¦ â€¦ 178c260 â€¦t name remove \"v2\" in the test name 4ae3567 Adjust docstrings for --use-v2-block-manager 70be1de further adjust the doc string --- use \"block manager v1\" and \"block mâ€¦ â€¦ 755fec3 â€¦anager v2\" in engine args doc string as it is more familiar for people. Merge branch 'main' into kuntai-remove-blockmngerv1 405f415 Hide details View details KuntaiDu merged commit 81ede99 into vllm-project : main Oct 17, 2024 77 checks passed Uh oh! There was an error while loading. Please reload this page . KuntaiDu deleted the kuntai-remove-blockmngerv1 branch October 17, 2024 16:38 KuntaiDu restored the kuntai-remove-blockmngerv1 branch October 17, 2024 16:43 KuntaiDu deleted the kuntai-remove-blockmngerv1 branch October 17, 2024 16:43 DarkLight1337 mentioned this pull request Oct 17, 2024 [Misc] Remove commit id file #9470 Merged KuntaiDu mentioned this pull request Oct 22, 2024 [Core] Remove evictor_v1 #9572 Merged saienduri mentioned this pull request Oct 24, 2024 update block_manager usage in setup_cython ROCm/vllm#243 Merged Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Core] Deprecating block manager v1 and make block manager v2 default ( â€¦ â€¦ 7cd2f07 â€¦vllm-project#8704 )\n\nRemoving the block manager v1. This is the initial piece of prefix-caching-centric design. In order to achieve prefix-caching-centric design, we need to simplify the code path so that we only use v2 block manager (which has much higher performance on prefix caching).\n\nSigned-off-by: Alvant <alvasian@yandex.ru> garg-amit pushed a commit\n        to garg-amit/vllm\n      that referenced\n      this pull request Oct 28, 2024 [Core] Deprecating block manager v1 and make block manager v2 default ( â€¦ â€¦ fdd67ee â€¦vllm-project#8704 )\n\nRemoving the block manager v1. This is the initial piece of prefix-caching-centric design. In order to achieve prefix-caching-centric design, we need to simplify the code path so that we only use v2 block manager (which has much higher performance on prefix caching).\n\nSigned-off-by: Amit Garg <mitgarg17495@gmail.com> FerdinandZhong pushed a commit\n        to FerdinandZhong/vllm\n      that referenced\n      this pull request Oct 29, 2024 [Core] Deprecating block manager v1 and make block manager v2 default ( â€¦ â€¦ c086d36 â€¦vllm-project#8704 )\n\nRemoving the block manager v1. This is the initial piece of prefix-caching-centric design. In order to achieve prefix-caching-centric design, we need to simplify the code path so that we only use v2 block manager (which has much higher performance on prefix caching).\n\nSigned-off-by: qishuai <ferdinandzhong@gmail.com> sumitd2 pushed a commit\n        to sumitd2/vllm\n      that referenced\n      this pull request Nov 14, 2024 [Core] Deprecating block manager v1 and make block manager v2 default ( â€¦ â€¦ 8e864ff â€¦vllm-project#8704 )\n\nRemoving the block manager v1. This is the initial piece of prefix-caching-centric design. In order to achieve prefix-caching-centric design, we need to simplify the code path so that we only use v2 block manager (which has much higher performance on prefix caching).\n\nSigned-off-by: Sumit Dubey <sumit.dubey2@ibm.com> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Core] Deprecating block manager v1 and make block manager v2 default ( â€¦ â€¦ f09498c â€¦vllm-project#8704 )\n\nRemoving the block manager v1. This is the initial piece of prefix-caching-centric design. In order to achieve prefix-caching-centric design, we need to simplify the code path so that we only use v2 block manager (which has much higher performance on prefix caching).\n\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:50", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: speedup | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:47:50", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Core] Deprecating block manager v1 and make block manager v2 default (#8704)", "commit_message": "[Core] Deprecating block manager v1 and make block manager v2 default (#8704)\n\nRemoving the block manager v1. This is the initial piece of prefix-caching-centric design. In order to achieve prefix-caching-centric design, we need to simplify the code path so that we only use v2 block manager (which has much higher performance on prefix caching).", "commit_date": "2024-10-17T11:38:15-05:00", "files_changed": [".buildkite/test-pipeline.yaml", "benchmarks/benchmark_latency.py", "benchmarks/benchmark_prefix_caching.py", "benchmarks/benchmark_throughput.py", "benchmarks/overheads/benchmark_hashing.py", "docs/source/models/spec_decode.rst", "examples/offline_inference_mlpspeculator.py", "tests/basic_correctness/test_chunked_prefill.py", "tests/core/block/e2e/test_correctness.py", "tests/core/block/e2e/test_correctness_sliding_window.py", "tests/core/block/test_block_manager.py", "tests/core/test_block_manager.py", "tests/core/test_chunked_prefill_scheduler.py", "tests/core/test_num_computed_tokens_update.py", "tests/core/test_scheduler.py", "tests/metrics/test_metrics.py", "tests/multi_step/test_correctness_async_llm.py", "tests/multi_step/test_correctness_llm.py", "tests/prefix_caching/test_prefix_caching.py", "tests/spec_decode/e2e/test_compatibility.py", "tests/spec_decode/e2e/test_eagle_correctness.py", "tests/spec_decode/e2e/test_integration.py", "tests/spec_decode/e2e/test_integration_dist_tp2.py", "tests/spec_decode/e2e/test_integration_dist_tp4.py", "tests/spec_decode/e2e/test_logprobs.py", "tests/spec_decode/e2e/test_medusa_correctness.py", "tests/spec_decode/e2e/test_mlp_correctness.py", "tests/spec_decode/e2e/test_multistep_correctness.py", "tests/spec_decode/e2e/test_ngram_correctness.py", "tests/spec_decode/e2e/test_seed.py", "tests/utils.py", "vllm/attention/backends/flash_attn.py", "vllm/attention/backends/flashinfer.py", "vllm/attention/backends/utils.py", "vllm/commit_id.py", "vllm/config.py", "vllm/core/block/utils.py", "vllm/core/block_manager.py", "vllm/core/block_manager_v1.py", "vllm/core/interfaces.py", "vllm/core/scheduler.py", "vllm/engine/arg_utils.py", "vllm/engine/llm_engine.py", "vllm/envs.py", "vllm/worker/model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 24, "num_non_test_files": 21, "only_test_files": 0, "only_non_test_files": 0, "num_files": 45, "num_hunks": 207, "num_edited_lines": 2315, "num_non_test_edited_lines": 952, "commit_year": 2024}, "diff_text": "diff --git a/.buildkite/test-pipeline.yaml b/.buildkite/test-pipeline.yaml\nindex 398fdc5f0..d2324d7ce 100644\n--- a/.buildkite/test-pipeline.yaml\n+++ b/.buildkite/test-pipeline.yaml\n@@ -77,8 +77,8 @@ steps:\n   - vllm/\n   - tests/basic_correctness/test_chunked_prefill\n   commands:\n-  - VLLM_ATTENTION_BACKEND=XFORMERS VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1 pytest -v -s basic_correctness/test_chunked_prefill.py\n-  - VLLM_ATTENTION_BACKEND=FLASH_ATTN VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1 pytest -v -s basic_correctness/test_chunked_prefill.py\n+  - VLLM_ATTENTION_BACKEND=XFORMERS pytest -v -s basic_correctness/test_chunked_prefill.py\n+  - VLLM_ATTENTION_BACKEND=FLASH_ATTN pytest -v -s basic_correctness/test_chunked_prefill.py\n \n - label: Core Test # 10min\n   mirror_hardwares: [amd]\n@@ -88,11 +88,7 @@ steps:\n   - vllm/distributed\n   - tests/core\n   commands:\n-  - VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1  pytest -v -s core/test_scheduler.py\n-  - VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1  pytest -v -s core core/test_chunked_prefill_scheduler.py\n-  - VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1  pytest -v -s core core/block/e2e/test_correctness.py\n-  - VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1  pytest -v -s core core/block/e2e/test_correctness_sliding_window.py\n-  - pytest -v -s core --ignore=core/block/e2e/test_correctness.py --ignore=core/test_scheduler.py --ignore=core/test_chunked_prefill_scheduler.py --ignore=core/block/e2e/test_correctness.py --ignore=core/block/e2e/test_correctness_sliding_window.py\n+  - pytest -v -s core\n \n - label: Entrypoints Test # 40min\n   working_dir: \"/vllm-workspace/tests\"\n@@ -192,8 +188,7 @@ steps:\n   - vllm/\n   - tests/prefix_caching\n   commands:\n-    - VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1 pytest -v -s prefix_caching/test_prefix_caching.py\n-    - pytest -v -s prefix_caching --ignore=prefix_caching/test_prefix_caching.py\n+    - pytest -v -s prefix_caching\n \n - label: Samplers Test # 36min\n   source_file_dependencies:\n@@ -217,8 +212,7 @@ steps:\n   - tests/spec_decode\n   commands:\n     - pytest -v -s spec_decode/e2e/test_multistep_correctness.py\n-    - VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1 pytest -v -s spec_decode/e2e/test_compatibility.py\n-    - VLLM_ATTENTION_BACKEND=FLASH_ATTN pytest -v -s spec_decode --ignore=spec_decode/e2e/test_multistep_correctness.py --ignore=spec_decode/e2e/test_compatibility.py\n+    - VLLM_ATTENTION_BACKEND=FLASH_ATTN pytest -v -s spec_decode --ignore=spec_decode/e2e/test_multistep_correctness.py\n \n - label: LoRA Test %N # 15min each\n   mirror_hardwares: [amd]\n@@ -405,7 +399,7 @@ steps:\n   - pytest -v -s ./compile/test_basic_correctness.py\n   - pytest -v -s ./compile/test_wrapper.py\n   - VLLM_TEST_SAME_HOST=1 torchrun --nproc-per-node=4 distributed/test_same_node.py | grep -q 'Same node test passed'\n-  - TARGET_TEST_SUITE=L4 VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1  pytest basic_correctness/ -v -s -m distributed_2_gpus\n+  - TARGET_TEST_SUITE=L4 pytest basic_correctness/ -v -s -m distributed_2_gpus\n   # Avoid importing model tests that cause CUDA reinitialization error\n   - pytest models/encoder_decoder/language/test_bart.py -v -s -m distributed_2_gpus\n   - pytest models/encoder_decoder/vision_language/test_broadcast.py -v -s -m distributed_2_gpus\ndiff --git a/benchmarks/benchmark_latency.py b/benchmarks/benchmark_latency.py\nindex 79a48b2a1..ea1a7788f 100644\n--- a/benchmarks/benchmark_latency.py\n+++ b/benchmarks/benchmark_latency.py\n@@ -38,7 +38,6 @@ def main(args: argparse.Namespace):\n         quantization_param_path=args.quantization_param_path,\n         device=args.device,\n         ray_workers_use_nsight=args.ray_workers_use_nsight,\n-        use_v2_block_manager=args.use_v2_block_manager,\n         enable_chunked_prefill=args.enable_chunked_prefill,\n         download_dir=args.download_dir,\n         block_size=args.block_size,\n@@ -221,9 +220,6 @@ if __name__ == '__main__':\n     parser.add_argument(\"--enable-prefix-caching\",\n                         action='store_true',\n                         help=\"Enable automatic prefix caching\")\n-    parser.add_argument('--use-v2-block-manager',\n-                        action='store_true',\n-                        default=EngineArgs.use_v2_block_manager)\n     parser.add_argument(\n         \"--ray-workers-use-nsight\",\n         action='store_true',\ndiff --git a/benchmarks/benchmark_prefix_caching.py b/benchmarks/benchmark_prefix_caching.py\nindex f14092d34..a354358e4 100644\n--- a/benchmarks/benchmark_prefix_caching.py\n+++ b/benchmarks/benchmark_prefix_caching.py\n@@ -33,7 +33,6 @@ from typing import List, Optional, Tuple\n from transformers import PreTrainedTokenizerBase\n \n from vllm import LLM, SamplingParams\n-from vllm.engine.arg_utils import EngineArgs\n from vllm.utils import FlexibleArgumentParser\n \n try:\n@@ -134,7 +133,6 @@ def main(args):\n               tokenizer_mode='auto',\n               trust_remote_code=True,\n               enforce_eager=True,\n-              use_v2_block_manager=args.use_v2_block_manager,\n               tensor_parallel_size=args.tensor_parallel_size,\n               enable_prefix_caching=args.enable_prefix_caching)\n \n@@ -176,10 +174,6 @@ if __name__ == \"__main__\":\n     parser.add_argument('--enable-prefix-caching',\n                         action='store_true',\n                         help='enable prefix caching')\n-    parser.add_argument('--use-v2-block-manager',\n-                        action='store_true',\n-                        default=EngineArgs.use_v2_block_manager,\n-                        help='Use BlockSpaceMangerV2')\n     parser.add_argument('--num-prompts',\n                         type=int,\n                         default=1,\ndiff --git a/benchmarks/benchmark_throughput.py b/benchmarks/benchmark_throughput.py\nindex b7bc2a640..e26706af6 100644\n--- a/benchmarks/benchmark_throughput.py\n+++ b/benchmarks/benchmark_throughput.py\n@@ -86,7 +86,6 @@ def run_vllm(\n     distributed_executor_backend: Optional[str],\n     gpu_memory_utilization: float = 0.9,\n     num_scheduler_steps: int = 1,\n-    use_v2_block_manager: bool = False,\n     download_dir: Optional[str] = None,\n     load_format: str = EngineArgs.load_format,\n     disable_async_output_proc: bool = False,\n@@ -113,7 +112,6 @@ def run_vllm(\n         distributed_executor_backend=distributed_executor_backend,\n         load_format=load_format,\n         num_scheduler_steps=num_scheduler_steps,\n-        use_v2_block_manager=use_v2_block_manager,\n         disable_async_output_proc=disable_async_output_proc,\n     )\n \n@@ -176,7 +174,6 @@ async def run_vllm_async(\n     distributed_executor_backend: Optional[str],\n     gpu_memory_utilization: float = 0.9,\n     num_scheduler_steps: int = 1,\n-    use_v2_block_manager: bool = False,\n     download_dir: Optional[str] = None,\n     load_format: str = EngineArgs.load_format,\n     disable_async_output_proc: bool = False,\n@@ -204,7 +201,6 @@ async def run_vllm_async(\n         distributed_executor_backend=distributed_executor_backend,\n         load_format=load_format,\n         num_scheduler_steps=num_scheduler_steps,\n-        use_v2_block_manager=use_v2_block_manager,\n         disable_async_output_proc=disable_async_output_proc,\n         worker_use_ray=False,\n         disable_log_requests=True,\n@@ -341,8 +337,7 @@ def main(args: argparse.Namespace):\n             args.enable_prefix_caching, args.enable_chunked_prefill,\n             args.max_num_batched_tokens, args.distributed_executor_backend,\n             args.gpu_memory_utilization, args.num_scheduler_steps,\n-            args.use_v2_block_manager, args.download_dir, args.load_format,\n-            args.disable_async_output_proc\n+            args.download_dir, args.load_format, args.disable_async_output_proc\n         ]\n \n         if args.async_engine:\n@@ -471,10 +466,6 @@ if __name__ == \"__main__\":\n         type=int,\n         default=1,\n         help=\"Maximum number of forward steps per scheduler call.\")\n-    parser.add_argument(\"--use-v2-block-manager\",\n-                        action='store_true',\n-                        default=EngineArgs.use_v2_block_manager,\n-                        help=\"Enable block manager v2.\")\n     parser.add_argument(\n         \"--enable-prefix-caching\",\n         action='store_true',\ndiff --git a/benchmarks/overheads/benchmark_hashing.py b/benchmarks/overheads/benchmark_hashing.py\nindex 203699e9a..d16d6f9fb 100644\n--- a/benchmarks/overheads/benchmark_hashing.py\n+++ b/benchmarks/overheads/benchmark_hashing.py\n@@ -16,7 +16,6 @@ def main(args):\n         enforce_eager=True,\n         enable_prefix_caching=True,\n         tensor_parallel_size=args.tensor_parallel_size,\n-        use_v2_block_manager=args.use_v2_block_manager,\n     )\n \n     sampling_params = SamplingParams(temperature=0, max_tokens=args.output_len)\n@@ -56,8 +55,5 @@ if __name__ == \"__main__\":\n     parser.add_argument('--enable-prefix-caching',\n                         action='store_true',\n                         help='enable prefix caching')\n-    parser.add_argument('--use-v2-block-manager',\n-                        action='store_true',\n-                        help='Use BlockSpaceMangerV2')\n     args = parser.parse_args()\n     main(args)\ndiff --git a/docs/source/models/spec_decode.rst b/docs/source/models/spec_decode.rst\nindex 0dc9cb383..b02c80aeb 100644\n--- a/docs/source/models/spec_decode.rst\n+++ b/docs/source/models/spec_decode.rst\n@@ -30,7 +30,6 @@ The following code configures vLLM in an offline mode to use speculative decodin\n         tensor_parallel_size=1,\n         speculative_model=\"facebook/opt-125m\",\n         num_speculative_tokens=5,\n-        use_v2_block_manager=True,\n     )\n     outputs = llm.generate(prompts, sampling_params)\n \n@@ -104,7 +103,6 @@ matching n-grams in the prompt. For more information read `this thread. <https:/\n         speculative_model=\"[ngram]\",\n         num_speculative_tokens=5,\n         ngram_prompt_lookup_max=4,\n-        use_v2_block_manager=True,\n     )\n     outputs = llm.generate(prompts, sampling_params)\n \n@@ -135,7 +133,6 @@ For more information see `this blog <https://pytorch.org/blog/hitchhikers-guide-\n         tensor_parallel_size=4,\n         speculative_model=\"ibm-fms/llama3-70b-accelerator\",\n         speculative_draft_tensor_parallel_size=1,\n-        use_v2_block_manager=True,\n     )\n     outputs = llm.generate(prompts, sampling_params)\n \ndiff --git a/examples/offline_inference_mlpspeculator.py b/examples/offline_inference_mlpspeculator.py\nindex 5dec4a76a..8f0eb65e4 100644\n--- a/examples/offline_inference_mlpspeculator.py\n+++ b/examples/offline_inference_mlpspeculator.py\n@@ -50,8 +50,6 @@ if __name__ == \"__main__\":\n     llm = LLM(\n         model=\"meta-llama/Llama-2-13b-chat-hf\",\n         speculative_model=\"ibm-fms/llama-13b-accelerator\",\n-        # These are currently required for MLPSpeculator decoding\n-        use_v2_block_manager=True,\n     )\n \n     print(\"With speculation\")\ndiff --git a/tests/basic_correctness/test_chunked_prefill.py b/tests/basic_correctness/test_chunked_prefill.py\nindex e8819688c..c3e3835af 100644\n--- a/tests/basic_correctness/test_chunked_prefill.py\n+++ b/tests/basic_correctness/test_chunked_prefill.py\n@@ -12,7 +12,7 @@ from contextlib import nullcontext\n import pytest\n \n from ..models.utils import check_logprobs_close, check_outputs_equal\n-from ..utils import check_deprecated_block_manager_usage, multi_gpu_test\n+from ..utils import multi_gpu_test\n \n MODELS = [\n     \"facebook/opt-125m\",\n@@ -20,12 +20,6 @@ MODELS = [\n ]\n \n \n-@pytest.fixture(scope=\"module\", autouse=True)\n-def check_deprecated_block_manager():\n-    check_deprecated_block_manager_usage(\n-        'tests/basic_correctness/test_chunked_prefill.py')\n-\n-\n @pytest.mark.parametrize(\"model\", MODELS)\n @pytest.mark.parametrize(\"dtype\", [\"half\"])\n @pytest.mark.parametrize(\"max_tokens\", [32])\n@@ -197,7 +191,6 @@ def test_models_with_fp8_kv_cache(\n @pytest.mark.parametrize(\"max_tokens\", [16])\n @pytest.mark.parametrize(\"enforce_eager\", [False])\n @pytest.mark.parametrize(\"chunk_size\", [30, 32])\n-@pytest.mark.parametrize(\"use_v2_block_manager\", [False, True])\n # NOTE: Increasing this in this suite will fail CI because we currently cannot\n # reset distributed env properly. Use a value > 1 just when you test.\n @pytest.mark.parametrize(\"tensor_parallel_size\", [1])\n@@ -206,7 +199,6 @@ def test_with_prefix_caching(\n     max_tokens: int,\n     enforce_eager: bool,\n     chunk_size: int,\n-    use_v2_block_manager: bool,\n     tensor_parallel_size: int,\n ) -> None:\n     \"\"\"\n@@ -234,7 +226,6 @@ def test_with_prefix_caching(\n                 enable_chunked_prefill=True,\n                 enable_prefix_caching=enable,\n                 tensor_parallel_size=tensor_parallel_size,\n-                use_v2_block_manager=use_v2_block_manager,\n                 enforce_eager=enforce_eager,\n                 max_num_seqs=max_num_seqs,\n         ) as vllm_model:\ndiff --git a/tests/core/block/e2e/test_correctness.py b/tests/core/block/e2e/test_correctness.py\nindex b3f626714..86502f613 100644\n--- a/tests/core/block/e2e/test_correctness.py\n+++ b/tests/core/block/e2e/test_correctness.py\n@@ -2,18 +2,11 @@ from itertools import cycle\n \n import pytest\n \n-from tests.utils import check_deprecated_block_manager_usage\n from vllm import SamplingParams\n \n from .conftest import get_token_ids_from_llm_generator\n \n \n-@pytest.fixture(scope=\"module\", autouse=True)\n-def check_deprecated_block_manager():\n-    check_deprecated_block_manager_usage(\n-        'tests/core/block/e2e/test_correctness.py')\n-\n-\n @pytest.mark.parametrize(\n     \"common_llm_kwargs\",\n     [{\n@@ -28,32 +21,32 @@ def check_deprecated_block_manager():\n         \"num_gpu_blocks_override\": 5 * (64 + 1),\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n-@pytest.mark.parametrize(\"baseline_llm_kwargs\", [{\n-    \"use_v2_block_manager\": False\n-}])\n+@pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"test_llm_kwargs\", [{\n-    \"use_v2_block_manager\": True,\n     \"preemption_mode\": \"swap\"\n }, {\n-    \"use_v2_block_manager\": True,\n     \"preemption_mode\": \"recompute\"\n }])\n @pytest.mark.parametrize(\"batch_size\", [10])\n @pytest.mark.parametrize(\"seed\", [1])\n-def test_v1_v2_greedy_equality_with_preemption(baseline_llm_generator,\n-                                               test_llm_generator, batch_size):\n-    \"\"\"Verify block manager v2 produces same outputs as block manager v1, even\n-    when there is preemption.\n+def test_block_manager_with_preemption(baseline_llm_generator,\n+                                       test_llm_generator, batch_size):\n+    \"\"\"Verify block manager produces same outputs even when there is preemption.\n \n     This constructs two LLM, each with limited number of GPU blocks. The limit\n     is decided such that as the sequences in the batch grow, sequences must be\n     preempted and removed from cache.\n \n     If the output token ids are equivalent, then we have confidence that the KV\n-    cache is not corrupted in the v2 block manager.\n+    cache is not corrupted.\n \n     NOTE: We want a significant number of generated tokens so that any incorrect\n     KV mapping has time to build up error.\n+\n+    NOTE(Kuntai): Though we have removed block manager v1, this test is still\n+    useful as it asserts the behavior of block manager v2 (now it is called \n+    SelfAttnBlockSpaceManager) is the same when swapping / preemption, so we  \n+    keep this test.\n     \"\"\"\n     output_len = 1024\n     temperature = 0.0\n@@ -77,11 +70,9 @@ def test_v1_v2_greedy_equality_with_preemption(baseline_llm_generator,\n         temperature=temperature,\n     )\n \n-    print('Getting token ids from block manager v1')\n     baseline_token_ids = get_token_ids_from_llm_generator(\n         baseline_llm_generator, prompts, sampling_params)\n \n-    print('Getting token ids from block manager v2')\n     test_token_ids = get_token_ids_from_llm_generator(test_llm_generator,\n                                                       prompts, sampling_params)\n \n@@ -104,9 +95,6 @@ def test_v1_v2_greedy_equality_with_preemption(baseline_llm_generator,\n \n         # skip cuda graph creation for fast test.\n         \"enforce_eager\": True,\n-\n-        # Lookahead scheduling only supported in v2 block manager.\n-        \"use_v2_block_manager\": True,\n     }])\n @pytest.mark.parametrize(\n     \"per_test_common_llm_kwargs\",\n@@ -218,26 +206,22 @@ def test_lookahead_greedy_equality_with_preemption(baseline_llm_generator,\n                              \"max_num_seqs\": 10,\n                          }])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [\n-    {\n-        \"use_v2_block_manager\": False,\n-    },\n+    {},\n ])\n @pytest.mark.parametrize(\"test_llm_kwargs\", [\n     {\n-        \"use_v2_block_manager\": True,\n         \"num_lookahead_slots\": 0,\n     },\n     {\n-        \"use_v2_block_manager\": True,\n         \"num_lookahead_slots\": 5,\n     },\n ])\n @pytest.mark.parametrize(\"batch_size\", [4])\n @pytest.mark.parametrize(\"seed\", [1])\n-def test_chunked_prefill_block_manager_v2(baseline_llm_generator,\n-                                          test_llm_generator, batch_size):\n-    \"\"\"Verify that chunked prefill works with BlockManagerV2, with and without\n-    lookahead scheduling.\n+def test_chunked_prefill_block_manager(baseline_llm_generator,\n+                                       test_llm_generator, batch_size):\n+    \"\"\"Verify that chunked prefill works with SelfAttnBlockSpaceManager, \n+    with and without lookahead scheduling.\n     \"\"\"\n     output_len = 32\n     temperature = 0.0\n@@ -258,11 +242,11 @@ def test_chunked_prefill_block_manager_v2(baseline_llm_generator,\n         temperature=temperature,\n     )\n \n-    print('Getting token ids with BlockManagerV1')\n+    print('Getting token ids with BlockManager')\n     baseline_token_ids = get_token_ids_from_llm_generator(\n         baseline_llm_generator, prompts, sampling_params)\n \n-    print('Getting token ids with BlockManagerV2')\n+    print('Getting token ids with BlockManager, with lookahead slots.')\n     test_token_ids = get_token_ids_from_llm_generator(test_llm_generator,\n                                                       prompts, sampling_params)\n \n@@ -290,32 +274,32 @@ def test_chunked_prefill_block_manager_v2(baseline_llm_generator,\n         \"enable_prefix_caching\": True,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n-@pytest.mark.parametrize(\"baseline_llm_kwargs\", [{\n-    \"use_v2_block_manager\": False\n-}])\n+@pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"test_llm_kwargs\", [{\n-    \"use_v2_block_manager\": True,\n     \"preemption_mode\": \"swap\"\n }, {\n-    \"use_v2_block_manager\": True,\n     \"preemption_mode\": \"recompute\"\n }])\n @pytest.mark.parametrize(\"batch_size\", [10])\n @pytest.mark.parametrize(\"seed\", [1])\n-def test_v1_v2_greedy_equality_prefix_caching_enabled_with_preemption(\n+def test_block_manager_prefix_caching_enabled_with_preemption(\n         baseline_llm_generator, test_llm_generator, batch_size):\n-    \"\"\"Verify block manager v2 produces same outputs as block manager v1, even\n-    when there is preemption.\n+    \"\"\"Verify block manager produces same outputs even when there is preemption.\n \n     This constructs two LLM, each with limited number of GPU blocks. The limit\n     is decided such that as the sequences in the batch grow, sequences must be\n     preempted and removed from cache.\n \n     If the output token ids are equivalent, then we have confidence that the KV\n-    cache is not corrupted in the v2 block manager.\n+    cache is not corrupted.\n \n     NOTE: We want a significant number of generated tokens so that any incorrect\n     KV mapping has time to build up error.\n+\n+    NOTE(Kuntai): Though we have removed block manager v1, this test is still\n+    useful as it asserts the behavior of block manager v2 (now it is called \n+    SelfAttnBlockSpaceManager) is the same when swapping / preemption, so we  \n+    keep this test.\n     \"\"\"\n     output_len = 1024\n     temperature = 0.0\n@@ -339,11 +323,11 @@ def test_v1_v2_greedy_equality_prefix_caching_enabled_with_preemption(\n         temperature=temperature,\n     )\n \n-    print('Getting token ids from block manager v1')\n+    print('Getting token ids from block manager')\n     baseline_token_ids = get_token_ids_from_llm_generator(\n         baseline_llm_generator, prompts, sampling_params)\n \n-    print('Getting token ids from block manager v2')\n+    print('Getting token ids from block manager, with preemption')\n     test_token_ids = get_token_ids_from_llm_generator(test_llm_generator,\n                                                       prompts, sampling_params)\n \n@@ -366,9 +350,6 @@ def test_v1_v2_greedy_equality_prefix_caching_enabled_with_preemption(\n         # Allow only 5 sequences of ~1024 tokens in worst case.\n         \"block_size\": 16,\n         \"num_gpu_blocks_override\": 5 * (64 + 1),\n-\n-        # Test APC in v2 block\n-        \"use_v2_block_manager\": True,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{\n@@ -444,9 +425,6 @@ def test_auto_prefix_caching_with_preemption(baseline_llm_generator,\n         \"max_model_len\": 48,\n         \"block_size\": 16,\n         \"num_gpu_blocks_override\": 3,\n-\n-        # Test APC in v2 block\n-        \"use_v2_block_manager\": True,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{\ndiff --git a/tests/core/block/e2e/test_correctness_sliding_window.py b/tests/core/block/e2e/test_correctness_sliding_window.py\nindex 731131984..9320a9ef6 100644\n--- a/tests/core/block/e2e/test_correctness_sliding_window.py\n+++ b/tests/core/block/e2e/test_correctness_sliding_window.py\n@@ -3,7 +3,6 @@ from typing import List\n \n import pytest\n \n-from tests.utils import check_deprecated_block_manager_usage\n from vllm import LLM, SamplingParams\n \n from .conftest import get_text_from_llm_generator\n@@ -13,12 +12,6 @@ MODEL = \"bigcode/starcoder2-3b\"\n BLOCK_SIZE = 16\n \n \n-@pytest.fixture(scope=\"module\", autouse=True)\n-def check_deprecated_block_manager():\n-    check_deprecated_block_manager_usage(\n-        'tests/core/block/e2e/test_correctness_sliding_window.py')\n-\n-\n @pytest.mark.parametrize(\n     \"common_llm_kwargs\",\n     [{\n@@ -31,10 +24,8 @@ def check_deprecated_block_manager():\n         \"num_gpu_blocks_override\": 100000 // BLOCK_SIZE,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n-@pytest.mark.parametrize(\"baseline_llm_kwargs\", [{\n-    \"use_v2_block_manager\": False\n-}])\n-@pytest.mark.parametrize(\"test_llm_kwargs\", [{\"use_v2_block_manager\": True}])\n+@pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n+@pytest.mark.parametrize(\"test_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"batch_size\", [5])\n @pytest.mark.parametrize(\"seed\", [1])\n def test_sliding_window_retrival(baseline_llm_generator, test_llm_generator,\n@@ -55,7 +46,6 @@ def test_sliding_window_retrival(baseline_llm_generator, test_llm_generator,\n \n     prompts, answer, indices = prep_prompts(batch_size)\n \n-    print('Getting token ids from block manager v1')\n     baseline_texts = get_text_from_llm_generator(baseline_llm_generator,\n                                                  prompts,\n                                                  sampling_params,\n@@ -91,10 +81,7 @@ def test_sliding_window_retrival(baseline_llm_generator, test_llm_generator,\n         \"num_gpu_blocks_override\": 100000 // BLOCK_SIZE,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n-@pytest.mark.parametrize(\"test_llm_kwargs\", [{\n-    \"use_v2_block_manager\": True,\n-    \"enable_chunked_prefill\": True\n-}])\n+@pytest.mark.parametrize(\"test_llm_kwargs\", [{\"enable_chunked_prefill\": True}])\n @pytest.mark.parametrize(\"batch_size\", [5])\n @pytest.mark.parametrize(\"seed\", [1])\n def test_sliding_window_chunked_prefill(test_llm_generator, batch_size, seed):\ndiff --git a/tests/core/block/test_block_manager_v2.py b/tests/core/block/test_block_manager.py\nsimilarity index 91%\nrename from tests/core/block/test_block_manager_v2.py\nrename to tests/core/block/test_block_manager.py\nindex e67883367..cfd749ad5 100644\n--- a/tests/core/block/test_block_manager_v2.py\n+++ b/tests/core/block/test_block_manager.py\n@@ -2,7 +2,7 @@ import pytest\n \n from vllm.core.block.utils import (STR_NOT_IMPL_ENC_DEC_PREFIX_CACHE,\n                                    STR_NOT_IMPL_ENC_DEC_SWA)\n-from vllm.core.block_manager_v2 import BlockSpaceManagerV2\n+from vllm.core.block_manager import SelfAttnBlockSpaceManager\n from vllm.core.interfaces import AllocStatus\n from vllm.sequence import Logprob, SequenceStatus\n from vllm.utils import chunk_list\n@@ -17,7 +17,7 @@ from ..utils import (create_dummy_prompt, create_seq_group,\n @pytest.mark.parametrize(\"watermark\", [0.0, 0.5])\n def test_can_allocate_seq_group(block_size: int, num_seqs_per_group: int,\n                                 num_gpu_blocks: int, watermark: float):\n-    block_manager = BlockSpaceManagerV2(\n+    block_manager = SelfAttnBlockSpaceManager(\n         block_size=block_size,\n         num_gpu_blocks=num_gpu_blocks,\n         num_cpu_blocks=1024,\n@@ -63,7 +63,7 @@ def test_can_allocate_seq_group_encoder_decoder(block_size: int,\n                                                 num_seqs_per_group: int,\n                                                 num_gpu_blocks: int,\n                                                 watermark: float):\n-    block_manager = BlockSpaceManagerV2(\n+    block_manager = SelfAttnBlockSpaceManager(\n         block_size=block_size,\n         num_gpu_blocks=num_gpu_blocks,\n         num_cpu_blocks=1024,\n@@ -117,16 +117,16 @@ def test_can_allocate_encoder_decoder_fails_with_swa(block_size: int,\n     '''\n     SWA short for Sliding Window Attention.\n \n-    At time of writing block manager v2 does not support SWA.\n+    At time of writing block manager does not support SWA.\n \n-    However even when SWA is implemented for block manager v2,\n+    However even when SWA is implemented for block manager,\n     there will still most likely be a separate workstream required\n     to enable SWA for encoder/decoder models.\n \n     Therefore this test enforces that one of the following cases\n     hold true:\n-    1. Block manager v2 does not support SWA at all (true at time of writing)\n-    2. Block manager v2 fails with NotImplementError when SWA is enabled\n+    1. Block manager does not support SWA at all (true at time of writing)\n+    2. Block manager fails with NotImplementError when SWA is enabled\n        AND a SequenceGroup with an encoder sequence (i.e. in support of an\n        encoder/decoder model) is passed into can_allocate() as an argument\n \n@@ -135,7 +135,7 @@ def test_can_allocate_encoder_decoder_fails_with_swa(block_size: int,\n     '''\n \n     with pytest.raises((NotImplementedError, AssertionError)) as exc_info:\n-        block_manager = BlockSpaceManagerV2(\n+        block_manager = SelfAttnBlockSpaceManager(\n             block_size=block_size,\n             num_gpu_blocks=num_gpu_blocks,\n             num_cpu_blocks=1024,\n@@ -158,7 +158,7 @@ def test_can_allocate_encoder_decoder_fails_with_swa(block_size: int,\n         block_manager.can_allocate(seq_group)\n \n     # Assert that either\n-    # 1. Block manager v2 constructor fails with assertion that sliding window\n+    # 1. Block manager constructor fails with assertion that sliding window\n     #    is not yet supported (most likely near-term outcome at time of\n     #    writing), or\n     # 2. can_allocate() fails with NotImplementedError due to combination of\n@@ -177,7 +177,7 @@ def test_can_allocate_encoder_decoder_fails_with_prefix_cache(\n         block_size: int, num_seqs_per_group: int, num_gpu_blocks: int,\n         watermark: float):\n \n-    block_manager = BlockSpaceManagerV2(\n+    block_manager = SelfAttnBlockSpaceManager(\n         block_size=block_size,\n         num_gpu_blocks=num_gpu_blocks,\n         num_cpu_blocks=1024,\n@@ -217,7 +217,7 @@ def test_append_slots(block_size, prompt_len, num_slots_to_append,\n \n     num_gpu_blocks = 1024\n     watermark = 0.1\n-    block_manager = BlockSpaceManagerV2(\n+    block_manager = SelfAttnBlockSpaceManager(\n         block_size=block_size,\n         num_gpu_blocks=num_gpu_blocks,\n         num_cpu_blocks=0,\n@@ -269,14 +269,15 @@ def test_swap(block_size, num_cpu_blocks, num_gpu_blocks, num_lookahead_slots,\n     \"\"\"Verify blocks number on src/desc device is correct after swapping in/out\n         sequence group (not missing or extra blocks).\n     \"\"\"\n-    block_manager = BlockSpaceManagerV2(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0,\n-                                        enable_caching=enable_caching)\n+    block_manager = SelfAttnBlockSpaceManager(block_size,\n+                                              num_cpu_blocks,\n+                                              num_gpu_blocks,\n+                                              watermark=0,\n+                                              enable_caching=enable_caching)\n     prompt, seq_group = create_dummy_prompt(\"1\", prompt_length=block_size - 1)\n     prompt.status = SequenceStatus.WAITING\n     block_manager.allocate(seq_group)\n+\n     # Emulate a forward pass by appending a single token.\n     # The block manager then knows how many unprocessed\n     # tokens will be written in the next forward pass.\n@@ -321,11 +322,11 @@ def test_can_swap(block_size, num_gpu_blocks, num_lookahead_slots,\n         can be swapped in/out.\n     \"\"\"\n     num_cpu_blocks = num_gpu_blocks\n-    block_manager = BlockSpaceManagerV2(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0,\n-                                        enable_caching=enable_caching)\n+    block_manager = SelfAttnBlockSpaceManager(block_size,\n+                                              num_cpu_blocks,\n+                                              num_gpu_blocks,\n+                                              watermark=0,\n+                                              enable_caching=enable_caching)\n     prompt, seq_group = create_dummy_prompt(\n         \"1\", prompt_length=(num_gpu_blocks - 1) * block_size - 1)\n     prompt.status = SequenceStatus.WAITING\n@@ -382,11 +383,11 @@ def test_swap_in_infeasible(num_lookahead_slots, enable_caching):\n     block_size = 8\n     num_cpu_blocks = 1\n     num_gpu_blocks = 1\n-    block_manager = BlockSpaceManagerV2(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0,\n-                                        enable_caching=enable_caching)\n+    block_manager = SelfAttnBlockSpaceManager(block_size,\n+                                              num_cpu_blocks,\n+                                              num_gpu_blocks,\n+                                              watermark=0,\n+                                              enable_caching=enable_caching)\n     prompt_length = block_size - 3\n     assert prompt_length > 0\n     prompt, seq_group = create_dummy_prompt(\"1\", prompt_length=prompt_length)\n@@ -434,7 +435,7 @@ def test_sliding_window(block_size, prompt_len, num_slots_to_append,\n \n     num_gpu_blocks = 1024\n     watermark = 0.1\n-    block_manager = BlockSpaceManagerV2(\n+    block_manager = SelfAttnBlockSpaceManager(\n         block_size=block_size,\n         num_gpu_blocks=num_gpu_blocks,\n         num_cpu_blocks=0,\n@@ -474,7 +475,7 @@ def test_sliding_window(block_size, prompt_len, num_slots_to_append,\n     seq.data.update_num_computed_tokens(prompt_len)\n     check_used(num_blocks(prompt_len))\n \n-    # this is how we compute it in BlockSpaceManagerV2.__init__\n+    # this is how we compute it in SelfAttnBlockSpaceManager.__init__\n     sliding_blocks = (sliding_window // block_size) + 2\n     # plus one block for null block\n     sliding_blocks += 1\ndiff --git a/tests/core/test_block_manager.py b/tests/core/test_block_manager.py\ndeleted file mode 100644\nindex 2ee9f2082..000000000\n--- a/tests/core/test_block_manager.py\n+++ /dev/null\n@@ -1,637 +0,0 @@\n-import time\n-from collections import defaultdict\n-from typing import List\n-\n-import pytest\n-\n-from vllm import SamplingParams\n-from vllm.block import PhysicalTokenBlock\n-from vllm.core.block.utils import (STR_NOT_IMPL_ENC_DEC_PREFIX_CACHE,\n-                                   STR_NOT_IMPL_ENC_DEC_SWA)\n-from vllm.core.block_manager_v1 import (BlockSpaceManagerV1,\n-                                        UncachedBlockAllocator)\n-from vllm.core.interfaces import AllocStatus\n-from vllm.sequence import Logprob, Sequence, SequenceGroup, SequenceStatus\n-from vllm.utils import Device\n-\n-from .utils import create_dummy_prompt, create_dummy_prompt_encoder_decoder\n-\n-\n-def test_block_allocator_allocate():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    cpu_allocator = UncachedBlockAllocator(Device.CPU, block_size,\n-                                           num_cpu_blocks)\n-\n-    # Allocate all available cpu blocks.\n-    num_free = num_cpu_blocks\n-    assert cpu_allocator.get_num_free_blocks() == num_free\n-    for _ in range(num_cpu_blocks):\n-        block = cpu_allocator.allocate()\n-        num_free -= 1\n-\n-        assert block not in cpu_allocator.free_blocks\n-        assert cpu_allocator.get_num_free_blocks() == num_free\n-\n-    with pytest.raises(ValueError):\n-        cpu_allocator.allocate()\n-\n-\n-def test_block_allocator_free():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    cpu_allocator = UncachedBlockAllocator(Device.CPU, block_size,\n-                                           num_cpu_blocks)\n-\n-    # Allocate all available cpu blocks.\n-    blocks: List[PhysicalTokenBlock] = []\n-    for _ in range(num_cpu_blocks):\n-        block = cpu_allocator.allocate()\n-        blocks.append(block)\n-        assert block not in cpu_allocator.free_blocks\n-\n-    # Free all allocated cpu blocks.\n-    num_free = 0\n-    assert cpu_allocator.get_num_free_blocks() == num_free\n-    for block in blocks:\n-        cpu_allocator.free(block)\n-        num_free += 1\n-        assert block in cpu_allocator.free_blocks\n-        assert cpu_allocator.get_num_free_blocks() == num_free\n-\n-        with pytest.raises(ValueError):\n-            cpu_allocator.free(block)\n-\n-\n-def test_allocate():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    # Allocate same sequence group to all available gpu blocks.\n-    for i in range(num_gpu_blocks):\n-        _, seq_group = create_dummy_prompt(str(i), block_size)\n-        assert block_manager.can_allocate(seq_group) == AllocStatus.OK\n-        block_manager.allocate(seq_group)\n-    assert block_manager.can_allocate(seq_group) != AllocStatus.OK\n-\n-    # Allocate same sequence group to all available gpu blocks.\n-    # Use watermark to reserve one gpu block.\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=1 / num_gpu_blocks)\n-    for i in range(num_gpu_blocks - 1):\n-        _, seq_group = create_dummy_prompt(str(i), block_size)\n-        assert block_manager.can_allocate(seq_group) == AllocStatus.OK\n-        block_manager.allocate(seq_group)\n-    assert block_manager.can_allocate(seq_group) != AllocStatus.OK\n-\n-\n-def test_allocate_encoder_decoder():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_req_per_seq_group = 2\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    # Allocate same sequence group to all available gpu blocks.\n-    for i in range(num_gpu_blocks // block_req_per_seq_group):\n-        _, _, seq_group = create_dummy_prompt_encoder_decoder(\n-            str(i),\n-            decoder_prompt_length=block_size,\n-            encoder_prompt_length=block_size)\n-        assert block_manager.can_allocate(seq_group) == AllocStatus.OK\n-        block_manager.allocate(seq_group)\n-    assert block_manager.can_allocate(seq_group) != AllocStatus.OK\n-\n-    # Allocate same sequence group to all available gpu blocks.\n-    # Use watermark to reserve one gpu block.\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=1 / num_gpu_blocks)\n-    for i in range((num_gpu_blocks - 1) // block_req_per_seq_group):\n-        _, _, seq_group = create_dummy_prompt_encoder_decoder(\n-            str(i),\n-            decoder_prompt_length=block_size,\n-            encoder_prompt_length=block_size)\n-        assert block_manager.can_allocate(seq_group) == AllocStatus.OK\n-        block_manager.allocate(seq_group)\n-    assert block_manager.can_allocate(seq_group) != AllocStatus.OK\n-\n-\n-def test_allocate_encoder_decoder_fails_with_swa():\n-    # SWA short for sliding window attention\n-\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0,\n-                                        sliding_window=5)  # swa\n-\n-    # Allocate same sequence group to all available gpu blocks.\n-    _, _, seq_group = create_dummy_prompt_encoder_decoder(\n-        \"0\",\n-        decoder_prompt_length=block_size,\n-        encoder_prompt_length=block_size)\n-\n-    # Assert that can_allocate() fails due to SWA\n-    with pytest.raises(NotImplementedError) as exc_info:\n-        block_manager.can_allocate(seq_group)\n-\n-    assert str(exc_info.value) == STR_NOT_IMPL_ENC_DEC_SWA\n-\n-    # Assert that allocate() fails due to SWA\n-    with pytest.raises(NotImplementedError) as exc_info:\n-        block_manager.allocate(seq_group)\n-\n-    assert str(exc_info.value) == STR_NOT_IMPL_ENC_DEC_SWA\n-\n-\n-def test_allocate_encoder_decoder_fails_with_prefix_caching():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0,\n-                                        enable_caching=True)  # Prefix cache\n-\n-    # Allocate same sequence group to all available gpu blocks.\n-    _, _, seq_group = create_dummy_prompt_encoder_decoder(\n-        \"0\",\n-        decoder_prompt_length=block_size,\n-        encoder_prompt_length=block_size)\n-\n-    # Assert that can_allocate() fails due to prefix caching\n-    with pytest.raises(NotImplementedError) as exc_info:\n-        block_manager.can_allocate(seq_group)\n-\n-    assert str(exc_info.value) == STR_NOT_IMPL_ENC_DEC_PREFIX_CACHE\n-\n-    # Assert that allocate() fails due to prefix caching\n-    with pytest.raises(NotImplementedError) as exc_info:\n-        block_manager.allocate(seq_group)\n-\n-    assert str(exc_info.value) == STR_NOT_IMPL_ENC_DEC_PREFIX_CACHE\n-\n-\n-def test_append_slot_single_seq():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    # Allocate single seq to gpu block.\n-    prompt, seq_group = create_dummy_prompt(\"1\", block_size)\n-    block_manager.allocate(seq_group)\n-\n-    # Nothing to append. Sequence has no new logical blocks.\n-    assert block_manager.can_append_slots(seq_group)\n-    before_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert not block_manager.append_slots(prompt)\n-    after_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert before_blocks == after_blocks\n-\n-    # Add block_size number of new tokens and append slot.\n-    for i in range(block_size):\n-        token_id = i + 5\n-        prompt.append_token_id(token_id, {token_id: Logprob(0.0)})\n-\n-    assert block_manager.can_append_slots(seq_group)\n-    before_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert not block_manager.append_slots(prompt)\n-    after_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert before_blocks - after_blocks == 1\n-\n-\n-def test_append_slot_cow():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size=block_size,\n-                                        num_cpu_blocks=num_cpu_blocks,\n-                                        num_gpu_blocks=num_gpu_blocks,\n-                                        watermark=0)\n-\n-    # Allocate prompt to gpu block. There is one slot left in the block.\n-    prompt = Sequence(seq_id=1,\n-                      inputs={\n-                          \"prompt\": \"one two three\",\n-                          \"prompt_token_ids\": [1, 2, 3],\n-                      },\n-                      block_size=block_size)\n-\n-    # Fork the sequence, such that a COW will be required when we append a new\n-    # token id.\n-    child = prompt.fork(new_seq_id=2)\n-\n-    # Allocate space for the sequence group.\n-    seq_group = SequenceGroup(request_id=\"1\",\n-                              seqs=[prompt, child],\n-                              arrival_time=time.time(),\n-                              sampling_params=SamplingParams())\n-    block_manager.allocate(seq_group)\n-\n-    # Fork and append a new token id. We expect a COW to be scheduled.\n-    token_id = 4\n-    child.append_token_id(token_id, {token_id: Logprob(0.0)})\n-    block_manager.fork(prompt, child)\n-\n-    assert block_manager.can_append_slots(seq_group)\n-    before_blocks = block_manager.get_num_free_gpu_blocks()\n-\n-    cows = block_manager.append_slots(child)\n-    assert cows\n-    dict_cows = defaultdict(list)\n-    for src_block, dst_block in cows:\n-        dict_cows[src_block].append(dst_block)\n-    for src_block, dst_blocks in dict_cows.items():\n-        assert src_block not in dst_blocks\n-\n-    after_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert before_blocks - after_blocks == 1\n-\n-\n-def test_fork():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    prompt, seq_group = create_dummy_prompt(\"1\",\n-                                            block_size - 1,\n-                                            block_size=block_size)\n-    block_manager.allocate(seq_group)\n-\n-    # Fork prompt and copy block tables.\n-    child = prompt.fork(2)\n-    block_manager.fork(prompt, child)\n-    assert block_manager.get_block_table(\n-        prompt) == block_manager.get_block_table(child)\n-    token_id = 4\n-    # Append token to child. Block is shared so copy on write occurs.\n-    child.append_token_id(token_id, {token_id: Logprob(0.0)})\n-    block_manager.append_slots(child)\n-    assert block_manager.get_block_table(\n-        prompt) != block_manager.get_block_table(child)\n-\n-\n-def test_swap():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    prompt, seq_group = create_dummy_prompt(\"1\", prompt_length=block_size - 1)\n-    prompt.status = SequenceStatus.WAITING\n-    block_manager.allocate(seq_group)\n-\n-    # Emulate a forward pass by appending a single token.\n-    # The block manager then knows how many unprocessed\n-    # tokens will be written in the next forward pass.\n-    token_id = 0\n-    prompt.status = SequenceStatus.RUNNING\n-    prompt.append_token_id(token_id, {token_id: Logprob(0.0)})\n-\n-    # Swap seq group from GPU -> CPU.\n-    gpu_blocks = block_manager.get_block_table(prompt)\n-    assert block_manager.can_swap_out(seq_group)\n-    before_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    before_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    mapping = block_manager.swap_out(seq_group)\n-    assert [x[0] for x in mapping] == gpu_blocks\n-    after_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    after_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert before_cpu_blocks == after_cpu_blocks + len(gpu_blocks)\n-    assert before_gpu_blocks + len(gpu_blocks) == after_gpu_blocks\n-    prompt.status = SequenceStatus.SWAPPED\n-\n-    # Swap seq group from CPU -> GPU.\n-    cpu_blocks = block_manager.get_block_table(prompt)\n-    assert block_manager.can_swap_in(seq_group) == AllocStatus.OK\n-    before_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    before_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    mapping = block_manager.swap_in(seq_group)\n-    assert [x[0] for x in mapping] == cpu_blocks\n-    after_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    after_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert before_cpu_blocks + len(cpu_blocks) == after_cpu_blocks\n-    assert before_gpu_blocks == after_gpu_blocks + len(cpu_blocks)\n-\n-\n-def test_swap_encoder_decoder():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    decoder_prompt, encoder_prompt, seq_group = \\\n-        create_dummy_prompt_encoder_decoder(\n-        \"1\",\n-        decoder_prompt_length=block_size,\n-        encoder_prompt_length=block_size)\n-    decoder_prompt.status = SequenceStatus.WAITING\n-    encoder_prompt.status = SequenceStatus.WAITING\n-    block_manager.allocate(seq_group)\n-\n-    # Emulate a forward pass by appending a single token.\n-    # The block manager then knows how many unprocessed\n-    # tokens will be written in the next forward pass.\n-    token_id = 0\n-    decoder_prompt.status = SequenceStatus.RUNNING\n-    decoder_prompt.append_token_id(token_id, {token_id: Logprob(0.0)})\n-\n-    # Swap encoder/decoder seq group from GPU -> CPU.\n-    decoder_gpu_blocks = block_manager.get_block_table(decoder_prompt)\n-    cross_gpu_blocks = block_manager.get_cross_block_table(seq_group)\n-    gpu_blocks = decoder_gpu_blocks + cross_gpu_blocks\n-    assert block_manager.can_swap_out(seq_group)\n-    before_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    before_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    mapping = block_manager.swap_out(seq_group)\n-    assert [x[0] for x in mapping] == gpu_blocks\n-    #assert list(mapping.keys()) == gpu_blocks\n-    after_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    after_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert before_cpu_blocks == after_cpu_blocks + len(gpu_blocks)\n-    assert before_gpu_blocks + len(gpu_blocks) == after_gpu_blocks\n-    decoder_prompt.status = SequenceStatus.SWAPPED\n-\n-    # Swap encoder/decoder seq group from CPU -> GPU.\n-    decoder_cpu_blocks = block_manager.get_block_table(decoder_prompt)\n-    cross_cpu_blocks = block_manager.get_cross_block_table(seq_group)\n-    cpu_blocks = decoder_cpu_blocks + cross_cpu_blocks\n-    assert block_manager.can_swap_in(seq_group) == AllocStatus.OK\n-    before_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    before_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    mapping = block_manager.swap_in(seq_group)\n-    assert [x[0] for x in mapping] == cpu_blocks\n-    after_cpu_blocks = block_manager.get_num_free_cpu_blocks()\n-    after_gpu_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert before_cpu_blocks + len(cpu_blocks) == after_cpu_blocks\n-    assert before_gpu_blocks == after_gpu_blocks + len(cpu_blocks)\n-\n-\n-def test_free():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    prompt, seq_group = create_dummy_prompt(\"1\", block_size)\n-    block_manager.allocate(seq_group)\n-\n-    # Free allocated seq.\n-    prompt_blocks = len(block_manager.get_block_table(prompt))\n-    before_blocks = block_manager.get_num_free_gpu_blocks()\n-    block_manager.free(prompt)\n-    after_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert after_blocks == before_blocks + prompt_blocks\n-\n-    # Block table for freed seq is deleted.\n-    with pytest.raises(KeyError):\n-        block_manager.get_block_table(prompt)\n-\n-\n-def test_free_encoder_decoder():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    decoder_prompt, encoder_prompt, seq_group = \\\n-        create_dummy_prompt_encoder_decoder(\n-        \"1\",\n-        decoder_prompt_length=block_size,\n-        encoder_prompt_length=block_size)\n-    block_manager.allocate(seq_group)\n-\n-    # Free allocated seq.\n-    decoder_prompt_blocks = len(block_manager.get_block_table(decoder_prompt))\n-    encoder_prompt_blocks = len(block_manager.get_cross_block_table(seq_group))\n-    prompt_blocks = decoder_prompt_blocks + encoder_prompt_blocks\n-    before_blocks = block_manager.get_num_free_gpu_blocks()\n-    block_manager.free(decoder_prompt)\n-    block_manager.free_cross(seq_group)\n-    after_blocks = block_manager.get_num_free_gpu_blocks()\n-    assert after_blocks == before_blocks + prompt_blocks\n-\n-    # Block table for freed encoder & decoder seq's are deleted.\n-    with pytest.raises(KeyError):\n-        block_manager.get_block_table(decoder_prompt)\n-\n-    # Block table for freed encoder & decoder seq's are deleted.\n-    with pytest.raises(KeyError):\n-        block_manager.get_block_table(encoder_prompt)\n-\n-\n-def test_reset():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    # Allocate same seq group on all available gpu blocks.\n-    original_blocks = block_manager.get_num_free_gpu_blocks()\n-    for i in range(num_gpu_blocks):\n-        _, seq_group = create_dummy_prompt(str(i), block_size)\n-        block_manager.allocate(seq_group)\n-    assert block_manager.get_num_free_gpu_blocks() == 0\n-\n-    # Resetting block manager frees all allocated blocks.\n-    block_manager.reset()\n-    assert block_manager.get_num_free_gpu_blocks() == original_blocks\n-\n-\n-def test_reset_encoder_decoder():\n-    block_size = 4\n-    num_cpu_blocks = 4\n-    num_gpu_blocks = 4\n-    block_req_per_seq_group = 2\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        watermark=0)\n-\n-    # Allocate same seq group on all available gpu blocks.\n-    original_blocks = block_manager.get_num_free_gpu_blocks()\n-    for i in range(num_gpu_blocks // block_req_per_seq_group):\n-        _, _, seq_group = create_dummy_prompt_encoder_decoder(\n-            f\"{i}\",\n-            decoder_prompt_length=block_size,\n-            encoder_prompt_length=block_size)\n-        block_manager.allocate(seq_group)\n-    assert block_manager.get_num_free_gpu_blocks() == 0\n-\n-    # Resetting block manager frees all allocated blocks.\n-    block_manager.reset()\n-    assert block_manager.get_num_free_gpu_blocks() == original_blocks\n-\n-\n-def test_sliding_window_multi_seq():\n-    \"\"\"\n-    Tests that memory allocation and deallocation is handled\n-    correctly with multiple sequences that exceed the sliding\n-    window's capacity.\n-    \"\"\"\n-    block_size = 1\n-    num_cpu_blocks = 8\n-    num_gpu_blocks = 8\n-    sliding_window = 2\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_cpu_blocks,\n-                                        num_gpu_blocks,\n-                                        sliding_window=sliding_window,\n-                                        watermark=0)\n-\n-    assert block_manager.get_num_free_gpu_blocks() == num_gpu_blocks\n-\n-    parent = Sequence(seq_id=1,\n-                      inputs={\n-                          \"prompt\": \"one two three\",\n-                          \"prompt_token_ids\": [0, 1, 2],\n-                      },\n-                      block_size=block_size)\n-    seq_group = SequenceGroup(request_id=\"1\",\n-                              seqs=[parent],\n-                              arrival_time=time.time(),\n-                              sampling_params=SamplingParams(),\n-                              lora_request=None)\n-    block_manager.allocate(seq_group)\n-\n-    # assert the number of blocks allocated is correct\n-    # the parent seq has len 3, but since sliding_window is 2,\n-    # we will use at most 2 blocks\n-    assert block_manager.get_num_free_gpu_blocks(\n-    ) == num_gpu_blocks - sliding_window\n-\n-    # Fork prompt and copy block tables.\n-    child = parent.fork(2)\n-    block_manager.fork(parent, child)\n-\n-    # assert the number of blocks allocated is correct\n-    # forking does not increase memory consumption\n-    assert block_manager.get_num_free_gpu_blocks(\n-    ) == num_gpu_blocks - sliding_window\n-\n-    # assert both parent and child share all blocks\n-    assert block_manager.get_block_table(\n-        parent) == block_manager.get_block_table(child)\n-\n-    token_id = 4\n-    # Append token to child. Block is shared so copy on write occurs.\n-    child.append_token_id(token_id, {token_id: Logprob(0.0)})\n-    block_manager.append_slots(child)\n-\n-    # assert the number of blocks allocated is correct\n-    # we will use now one block more. Each seq will use 2 blocks,\n-    # but only one can be shared\n-    assert block_manager.get_num_free_gpu_blocks(\n-    ) == num_gpu_blocks - sliding_window - 1\n-\n-    token_id = 5\n-    parent.append_token_id(token_id, {token_id: Logprob(0.0)})\n-    block_manager.append_slots(parent)\n-\n-    # assert the number of blocks allocated is correct\n-    # no change, because both sequences are still just sharing one block\n-    assert block_manager.get_num_free_gpu_blocks(\n-    ) == num_gpu_blocks - sliding_window - 1\n-\n-    block_table_parent = block_manager.get_block_table(parent)\n-    block_table_child = block_manager.get_block_table(child)\n-\n-    assert block_table_parent != block_table_child\n-\n-    # assert both blocks are sharing the second-last block\n-    assert block_table_parent[-2] == block_table_child[-2]\n-\n-    # now let's clean up...\n-    block_manager.free(parent)\n-\n-    # assert the number of blocks allocated is correct\n-    # We have freed one seq, reducing the ref count of two blocks by one.\n-    # One of the two was only used by the parent seq, so this is now free.\n-    # The child seq still consumes sliding_window blocks\n-    assert block_manager.get_num_free_gpu_blocks(\n-    ) == num_gpu_blocks - sliding_window\n-\n-    # free all blocks\n-    block_manager.free(child)\n-\n-    # assert all blocks are free now\n-    assert block_manager.get_num_free_gpu_blocks() == num_gpu_blocks\n-\n-\n-def test_mark_blocks_as_computed_with_prefix_cache_and_chunked_prefill():\n-    \"\"\"When prefix cache and chunked prefill are enabled, the block manager\n-    should only mark a chunk of blocks as computed instead of all blocks.\n-    \"\"\"\n-\n-    block_size = 4\n-    num_cpu_blocks = 0\n-    num_gpu_blocks = 16\n-    block_manager = BlockSpaceManagerV1(block_size,\n-                                        num_gpu_blocks,\n-                                        num_cpu_blocks,\n-                                        watermark=0,\n-                                        enable_caching=True)\n-\n-    # Set prompt size to have num_gpu_blocks - 1 full blocks.\n-    prompt_length = block_size * num_gpu_blocks - 1\n-\n-    # Allocate (reserve) all blocks.\n-    _, seq_group = create_dummy_prompt(\"0\",\n-                                       prompt_length,\n-                                       block_size=block_size)\n-    block_manager.allocate(seq_group)\n-    assert seq_group.seqs[0].n_blocks == num_gpu_blocks\n-\n-    # 1st chunk: Compute 2 and half blocks. Should mark 2 blocks as computed.\n-    token_chunk_size = int(block_size * 2.5)\n-    block_manager.mark_blocks_as_computed(seq_group, token_chunk_size)\n-    computed_blocks = block_manager.get_all_computed_blocks(seq_group.seqs[0])\n-    assert len(computed_blocks) == 2\n-\n-    # Actual computed tokens.\n-    seq_group.seqs[0].data.update_num_computed_tokens(token_chunk_size)\n-\n-    # 2nd chunk: Complete 3rd block and additional 4 blocks.\n-    token_chunk_size = int(block_size * 4.5)\n-    block_manager.mark_blocks_as_computed(seq_group, token_chunk_size)\n-    computed_blocks = block_manager.get_all_computed_blocks(seq_group.seqs[0])\n-    assert len(computed_blocks) == 7\ndiff --git a/tests/core/test_chunked_prefill_scheduler.py b/tests/core/test_chunked_prefill_scheduler.py\nindex c9495fd50..f97caa06f 100644\n--- a/tests/core/test_chunked_prefill_scheduler.py\n+++ b/tests/core/test_chunked_prefill_scheduler.py\n@@ -8,7 +8,6 @@ from vllm.core.interfaces import AllocStatus\n from vllm.core.scheduler import Scheduler\n from vllm.sequence import Logprob, SequenceGroup\n \n-from ..utils import check_deprecated_block_manager_usage\n from .utils import create_dummy_prompt\n \n \n@@ -28,25 +27,16 @@ def schedule_and_update_computed_tokens(scheduler):\n     return metas, out\n \n \n-@pytest.fixture(scope=\"module\", autouse=True)\n-def check_deprecated_block_manager():\n-    check_deprecated_block_manager_usage(\n-        'tests/core/test_chunked_prefill_scheduler.py')\n-\n-\n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_simple(use_v2_block_manager: bool):\n+def test_simple():\n     \"\"\"Verify basic scheduling works.\"\"\"\n     block_size = 4\n     num_seq_group = 4\n     max_model_len = 16\n     max_num_batched_tokens = 64\n-    scheduler_config = SchedulerConfig(\n-        max_num_batched_tokens,\n-        num_seq_group,\n-        max_model_len,\n-        enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    scheduler_config = SchedulerConfig(max_num_batched_tokens,\n+                                       num_seq_group,\n+                                       max_model_len,\n+                                       enable_chunked_prefill=True)\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 8\n     cache_config.num_gpu_blocks = 8\n@@ -81,8 +71,7 @@ def test_simple(use_v2_block_manager: bool):\n     assert len(seq_group_meta) == num_seq_group\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_chunk(use_v2_block_manager: bool):\n+def test_chunk():\n     \"\"\"Verify prefills are chunked properly.\"\"\"\n     block_size = 4\n     max_seqs = 60\n@@ -93,7 +82,7 @@ def test_chunk(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 32\n     cache_config.num_gpu_blocks = 32\n@@ -131,8 +120,7 @@ def test_chunk(use_v2_block_manager: bool):\n     assert out.num_batched_tokens == 57\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_complex(use_v2_block_manager: bool):\n+def test_complex():\n     block_size = 4\n     max_seqs = 60\n     max_model_len = 80\n@@ -142,7 +130,7 @@ def test_complex(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 64\n     cache_config.num_gpu_blocks = 64\n@@ -201,8 +189,7 @@ def test_complex(use_v2_block_manager: bool):\n     assert running[2].is_prefill()\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_maximal_decoding(use_v2_block_manager: bool):\n+def test_maximal_decoding():\n     \"\"\"Verify decoding requests are prioritized.\"\"\"\n     block_size = 4\n     max_seqs = 2\n@@ -213,7 +200,7 @@ def test_maximal_decoding(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 8\n     cache_config.num_gpu_blocks = 8\n@@ -295,8 +282,7 @@ def test_maximal_decoding(use_v2_block_manager: bool):\n     assert out.num_batched_tokens == 2\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_prompt_limit(use_v2_block_manager: bool):\n+def test_prompt_limit():\n     \"\"\"Verify max_num_batched_tokens < max_model_len is possible.\"\"\"\n     block_size = 4\n     max_seqs = 32\n@@ -307,7 +293,7 @@ def test_prompt_limit(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 16\n     cache_config.num_gpu_blocks = 16\n@@ -330,8 +316,7 @@ def test_prompt_limit(use_v2_block_manager: bool):\n     assert out.num_batched_tokens == 32\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_prompt_limit_exceed(use_v2_block_manager: bool):\n+def test_prompt_limit_exceed():\n     block_size = 4\n     max_seqs = 64\n     max_model_len = 32\n@@ -356,8 +341,7 @@ def test_prompt_limit_exceed(use_v2_block_manager: bool):\n     assert out.ignored_seq_groups[0] == seq_group\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_swap(use_v2_block_manager: bool):\n+def test_swap():\n     \"\"\"Verify swapping works with chunked prefill requests\"\"\"\n     block_size = 4\n     max_seqs = 30\n@@ -368,7 +352,7 @@ def test_swap(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 16\n     cache_config.num_gpu_blocks = 16\n@@ -414,8 +398,7 @@ def test_swap(use_v2_block_manager: bool):\n     assert out.blocks_to_swap_out == []\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_running_prefill_prioritized_over_swap(use_v2_block_manager: bool):\n+def test_running_prefill_prioritized_over_swap():\n     block_size = 4\n     max_seqs = 30\n     max_model_len = 200\n@@ -425,7 +408,7 @@ def test_running_prefill_prioritized_over_swap(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 32\n     cache_config.num_gpu_blocks = 32\n@@ -508,8 +491,7 @@ def test_running_prefill_prioritized_over_swap(use_v2_block_manager: bool):\n     assert out.blocks_to_swap_out == []\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_chunked_prefill_preempt(use_v2_block_manager: bool):\n+def test_chunked_prefill_preempt():\n     \"\"\"Verify preempt works with chunked prefill requests\"\"\"\n     block_size = 4\n     max_seqs = 30\n@@ -520,7 +502,7 @@ def test_chunked_prefill_preempt(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 16\n     cache_config.num_gpu_blocks = 16\n@@ -575,8 +557,7 @@ def test_chunked_prefill_preempt(use_v2_block_manager: bool):\n     assert out.num_batched_tokens == max_num_batched_tokens\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_chunked_prefill_max_seqs(use_v2_block_manager: bool):\n+def test_chunked_prefill_max_seqs():\n     block_size = 4\n     max_seqs = 2\n     max_model_len = 80\n@@ -586,7 +567,7 @@ def test_chunked_prefill_max_seqs(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 128\n     cache_config.num_gpu_blocks = 128\n@@ -629,8 +610,7 @@ def test_chunked_prefill_max_seqs(use_v2_block_manager: bool):\n     assert not running[1].is_prefill()\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_perfix_caching(use_v2_block_manager: bool):\n+def test_perfix_caching():\n     \"\"\"Verify allocating full blocks when prefix caching is enabled.\"\"\"\n     block_size = 4\n     max_seqs = 10\n@@ -641,7 +621,7 @@ def test_perfix_caching(use_v2_block_manager: bool):\n         max_seqs,\n         max_model_len,\n         enable_chunked_prefill=True,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size,\n                                1.0,\n                                1,\ndiff --git a/tests/core/test_num_computed_tokens_update.py b/tests/core/test_num_computed_tokens_update.py\nindex f3ec24e7b..bd4accab7 100644\n--- a/tests/core/test_num_computed_tokens_update.py\n+++ b/tests/core/test_num_computed_tokens_update.py\n@@ -31,7 +31,6 @@ def test_num_computed_tokens_update(num_scheduler_steps: int,\n     # Make a vllm engine\n     runner = VllmRunner(model_name=MODEL,\n                         gpu_memory_utilization=0.7,\n-                        use_v2_block_manager=True,\n                         num_scheduler_steps=num_scheduler_steps,\n                         enable_chunked_prefill=enable_chunked_prefill,\n                         enforce_eager=enforce_eager)\ndiff --git a/tests/core/test_scheduler.py b/tests/core/test_scheduler.py\nindex 5cdf743a4..defa6c1bd 100644\n--- a/tests/core/test_scheduler.py\n+++ b/tests/core/test_scheduler.py\n@@ -3,7 +3,7 @@ from collections import deque\n from typing import List, Set, Tuple\n from unittest.mock import MagicMock\n \n-import pytest\n+import pytest  # noqa\n from torch import Use  # noqa\n \n from vllm.config import CacheConfig, LoRAConfig, SchedulerConfig\n@@ -12,23 +12,18 @@ from vllm.core.scheduler import Scheduler, SchedulingBudget\n from vllm.lora.request import LoRARequest\n from vllm.sequence import SequenceGroup, SequenceStatus\n \n-from ..utils import check_deprecated_block_manager_usage\n from .utils import (append_new_token, append_new_token_seq_group,\n                     create_dummy_prompt, get_sequence_groups,\n                     schedule_and_update_computed_tokens)\n \n \n-@pytest.fixture(scope=\"module\", autouse=True)\n-def check_deprecated_block_manager():\n-    check_deprecated_block_manager_usage(\n-        \"tests/core/test_chunked_prefill_scheduler.py\")\n-\n-\n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_scheduler_add_seq_group(use_v2_block_manager: bool):\n+def test_scheduler_add_seq_group():\n     block_size = 4\n     scheduler_config = SchedulerConfig(\n-        100, 64, 1, use_v2_block_manager=use_v2_block_manager)\n+        100,\n+        64,\n+        1,\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, cache_dtype=\"auto\")\n     cache_config.num_cpu_blocks = 4\n     cache_config.num_gpu_blocks = 4\n@@ -44,11 +39,13 @@ def test_scheduler_add_seq_group(use_v2_block_manager: bool):\n         assert scheduler.get_num_unfinished_seq_groups() == i + 1\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_scheduler_abort_seq_group(use_v2_block_manager: bool):\n+def test_scheduler_abort_seq_group():\n     block_size = 4\n     scheduler_config = SchedulerConfig(\n-        100, 64, 1, use_v2_block_manager=use_v2_block_manager)\n+        100,\n+        64,\n+        1,\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 4\n     cache_config.num_gpu_blocks = 4\n@@ -68,8 +65,7 @@ def test_scheduler_abort_seq_group(use_v2_block_manager: bool):\n     assert scheduler.get_num_unfinished_seq_groups() == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_scheduler_schedule_simple(use_v2_block_manager: bool):\n+def test_scheduler_schedule_simple():\n     block_size = 4\n     num_seq_group = 4\n     max_model_len = 16\n@@ -77,7 +73,7 @@ def test_scheduler_schedule_simple(use_v2_block_manager: bool):\n         64,\n         num_seq_group,\n         max_model_len,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 8\n     cache_config.num_gpu_blocks = 8\n@@ -112,8 +108,7 @@ def test_scheduler_schedule_simple(use_v2_block_manager: bool):\n     append_new_token(out, 1)\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_scheduler_prefill_prioritized(use_v2_block_manager: bool):\n+def test_scheduler_prefill_prioritized():\n     \"\"\"Verify running batched tokens are not applied to prefill requests.\"\"\"\n     block_size = 4\n     max_model_len = 30\n@@ -122,7 +117,7 @@ def test_scheduler_prefill_prioritized(use_v2_block_manager: bool):\n         max_batched_num_tokens,\n         2,\n         max_model_len,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 16\n     cache_config.num_gpu_blocks = 16\n@@ -146,12 +141,14 @@ def test_scheduler_prefill_prioritized(use_v2_block_manager: bool):\n     assert get_sequence_groups(out) == [seq_group_b]\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_scheduler_schedule_preempt_abort(use_v2_block_manager: bool):\n+def test_scheduler_schedule_preempt_abort():\n     block_size = 4\n     max_model_len = 16\n     scheduler_config = SchedulerConfig(\n-        64, 2, max_model_len, use_v2_block_manager=use_v2_block_manager)\n+        64,\n+        2,\n+        max_model_len,\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 2\n     cache_config.num_gpu_blocks = 2\n@@ -201,8 +198,7 @@ def test_scheduler_schedule_preempt_abort(use_v2_block_manager: bool):\n     assert scheduler.get_num_unfinished_seq_groups() == 1\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_scheduler_max_seqs(use_v2_block_manager: bool):\n+def test_scheduler_max_seqs():\n     block_size = 4\n     num_seq_group = 4\n     max_seq_group = 2\n@@ -211,7 +207,7 @@ def test_scheduler_max_seqs(use_v2_block_manager: bool):\n         64,\n         max_seq_group,\n         max_model_len,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 8\n     cache_config.num_gpu_blocks = 8\n@@ -249,15 +245,14 @@ def test_scheduler_max_seqs(use_v2_block_manager: bool):\n     assert set(get_sequence_groups(out)) == set([all_seq_groups[1]])\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_scheduler_delay_factor(use_v2_block_manager: bool):\n+def test_scheduler_delay_factor():\n     block_size = 4\n     scheduler_config = SchedulerConfig(\n         100,\n         64,\n         16,\n         delay_factor=0.5,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = 8\n     cache_config.num_gpu_blocks = 8\n@@ -294,12 +289,10 @@ def test_scheduler_delay_factor(use_v2_block_manager: bool):\n     append_new_token(out, 1)\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_swapped_out_prioritized(use_v2_block_manager: bool):\n+def test_swapped_out_prioritized():\n     block_size = 4\n     scheduler = initialize_scheduler(max_num_seqs=6,\n                                      block_size=block_size,\n-                                     use_v2_block_manager=use_v2_block_manager,\n                                      num_cpu_blocks=64,\n                                      num_gpu_blocks=64)\n     # best_of=2 * 3 == 6 sequences.\n@@ -351,7 +344,6 @@ def initialize_scheduler(\n     max_token_budget=1000,\n     max_model_len=1000,\n     lora_config=None,\n-    use_v2_block_manager=False,\n     block_size=4,\n     num_cpu_blocks=8,\n     num_gpu_blocks=8,\n@@ -361,7 +353,7 @@ def initialize_scheduler(\n         max_token_budget,\n         max_num_seqs,\n         max_model_len,\n-        use_v2_block_manager=use_v2_block_manager)\n+    )\n     cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n     cache_config.num_cpu_blocks = num_cpu_blocks\n     cache_config.num_gpu_blocks = num_gpu_blocks\n@@ -386,15 +378,12 @@ def add_token_budget(budget: SchedulingBudget,\n     budget.add_num_seqs(mock_seq_group.request_id, num_curr_seqs)\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_prefill_schedule_max_prompt_len(use_v2_block_manager: bool):\n+def test_prefill_schedule_max_prompt_len():\n     \"\"\"\n     Test prompt longer than max_prompt_len is aborted.\n     \"\"\"\n     block_size = 4\n-    scheduler = initialize_scheduler(max_model_len=30,\n-                                     use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size)\n+    scheduler = initialize_scheduler(max_model_len=30, block_size=block_size)\n     _, seq_group = create_dummy_prompt(\"0\",\n                                        prompt_length=60,\n                                        block_size=block_size)\n@@ -409,14 +398,12 @@ def test_prefill_schedule_max_prompt_len(use_v2_block_manager: bool):\n     assert len(remaining_waiting) == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_prefill_schedule_token_budget(use_v2_block_manager: bool):\n+def test_prefill_schedule_token_budget():\n     \"\"\"\n     Test token budget respected.\n     \"\"\"\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=64,\n                                      num_gpu_blocks=64)\n     budget = create_token_budget(token_budget=0)\n@@ -446,8 +433,7 @@ def test_prefill_schedule_token_budget(use_v2_block_manager: bool):\n     assert len(remaining_waiting) == 1\n \n     # Test when current_batched_tokens respected.\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=16,\n                                      num_gpu_blocks=16)\n     budget = create_token_budget(token_budget=60)\n@@ -474,14 +460,12 @@ def test_prefill_schedule_token_budget(use_v2_block_manager: bool):\n     assert len(remaining_waiting) == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_prefill_schedule_max_seqs(use_v2_block_manager: bool):\n+def test_prefill_schedule_max_seqs():\n     \"\"\"\n     Test max seq respected.\n     \"\"\"\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=64,\n                                      num_gpu_blocks=64)\n     budget = create_token_budget(max_num_seqs=2)\n@@ -515,15 +499,13 @@ def test_prefill_schedule_max_seqs(use_v2_block_manager: bool):\n     assert len(remaining_waiting) == 1\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_prefill_schedule_max_lora(use_v2_block_manager: bool):\n+def test_prefill_schedule_max_lora():\n     \"\"\"\n     Test max lora is respected and prioritized.\n     \"\"\"\n     block_size = 4\n     lora_config = LoRAConfig(max_lora_rank=8, max_loras=1)\n     scheduler = initialize_scheduler(lora_config=lora_config,\n-                                     use_v2_block_manager=use_v2_block_manager,\n                                      block_size=block_size,\n                                      num_cpu_blocks=64,\n                                      num_gpu_blocks=64)\n@@ -570,14 +552,12 @@ def test_prefill_schedule_max_lora(use_v2_block_manager: bool):\n     assert budget.num_batched_tokens == 60\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_prefill_schedule_no_block_manager_capacity(use_v2_block_manager):\n+def test_prefill_schedule_no_block_manager_capacity():\n     \"\"\"\n     Test sequence cannot be scheduled due to block manager has no capacity.\n     \"\"\"\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_gpu_blocks=128,\n                                      num_cpu_blocks=128)\n     budget = create_token_budget()\n@@ -614,14 +594,12 @@ def test_prefill_schedule_no_block_manager_capacity(use_v2_block_manager):\n     assert len(remaining_waiting) == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_decode_schedule_preempted(use_v2_block_manager: bool):\n+def test_decode_schedule_preempted():\n     \"\"\"\n     Test decodes cannot be scheduled and preempted.\n     \"\"\"\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=64,\n                                      num_gpu_blocks=64)\n     curr_loras = None\n@@ -660,14 +638,12 @@ def test_decode_schedule_preempted(use_v2_block_manager: bool):\n     assert output.blocks_to_copy == []\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_decode_swap_beam_search(use_v2_block_manager: bool):\n+def test_decode_swap_beam_search():\n     \"\"\"\n     Test best_of > 1 swap out blocks\n     \"\"\"\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_gpu_blocks=64,\n                                      num_cpu_blocks=64)\n     curr_loras = None\n@@ -716,14 +692,12 @@ def test_decode_swap_beam_search(use_v2_block_manager: bool):\n     assert output.blocks_to_copy == []\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_schedule_decode_blocks_to_copy_update(use_v2_block_manager: bool):\n+def test_schedule_decode_blocks_to_copy_update():\n     \"\"\"\n     Verify blocks_to_copy is updated.\n     \"\"\"\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=4,\n+    scheduler = initialize_scheduler(block_size=4,\n                                      num_cpu_blocks=16,\n                                      num_gpu_blocks=16)\n     _, seq_group = create_dummy_prompt(\"1\",\n@@ -754,11 +728,9 @@ def test_schedule_decode_blocks_to_copy_update(use_v2_block_manager: bool):\n     assert output.blocks_to_copy == [(2, 3)]\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_schedule_swapped_simple(use_v2_block_manager: bool):\n+def test_schedule_swapped_simple():\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size)\n+    scheduler = initialize_scheduler(block_size=block_size)\n     curr_loras = None\n     blocks_to_swap_out: List[Tuple[int, int]] = []\n     _, seq_group = create_dummy_prompt(\"1\",\n@@ -785,11 +757,9 @@ def test_schedule_swapped_simple(use_v2_block_manager: bool):\n     assert blocks_to_swap_out == blocks_to_swap_in_reverse\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_schedule_swapped_max_token_budget(use_v2_block_manager: bool):\n+def test_schedule_swapped_max_token_budget():\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=32,\n                                      num_gpu_blocks=32)\n     curr_loras = None\n@@ -822,11 +792,9 @@ def test_schedule_swapped_max_token_budget(use_v2_block_manager: bool):\n     assert len(output.prefill_seq_groups) == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_schedule_swapped_max_seqs(use_v2_block_manager: bool):\n+def test_schedule_swapped_max_seqs():\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=64,\n                                      num_gpu_blocks=64)\n     curr_loras = None\n@@ -859,12 +827,10 @@ def test_schedule_swapped_max_seqs(use_v2_block_manager: bool):\n     assert len(output.prefill_seq_groups) == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_schedule_swapped_max_loras(use_v2_block_manager: bool):\n+def test_schedule_swapped_max_loras():\n     block_size = 4\n     lora_config = LoRAConfig(max_lora_rank=8, max_loras=1)\n     scheduler = initialize_scheduler(lora_config=lora_config,\n-                                     use_v2_block_manager=use_v2_block_manager,\n                                      block_size=block_size,\n                                      num_cpu_blocks=32,\n                                      num_gpu_blocks=32)\n@@ -894,11 +860,9 @@ def test_schedule_swapped_max_loras(use_v2_block_manager: bool):\n     assert len(curr_loras) == 1\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_schedule_swapped_cannot_swap_in(use_v2_block_manager: bool):\n+def test_schedule_swapped_cannot_swap_in():\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=32,\n                                      num_gpu_blocks=32)\n     curr_loras = None\n@@ -927,11 +891,9 @@ def test_schedule_swapped_cannot_swap_in(use_v2_block_manager: bool):\n     assert len(output.prefill_seq_groups) == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_infeasible_swap(use_v2_block_manager: bool):\n+def test_infeasible_swap():\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=32,\n                                      num_gpu_blocks=32)\n     curr_loras = None\n@@ -961,11 +923,9 @@ def test_infeasible_swap(use_v2_block_manager: bool):\n     assert len(output.prefill_seq_groups) == 0\n \n \n-@pytest.mark.parametrize('use_v2_block_manager', [True, False])\n-def test_schedule_swapped_blocks_to_copy(use_v2_block_manager: bool):\n+def test_schedule_swapped_blocks_to_copy():\n     block_size = 4\n-    scheduler = initialize_scheduler(use_v2_block_manager=use_v2_block_manager,\n-                                     block_size=block_size,\n+    scheduler = initialize_scheduler(block_size=block_size,\n                                      num_cpu_blocks=32,\n                                      num_gpu_blocks=32)\n     curr_loras = None\ndiff --git a/tests/metrics/test_metrics.py b/tests/metrics/test_metrics.py\nindex f1003221a..8798ff078 100644\n--- a/tests/metrics/test_metrics.py\n+++ b/tests/metrics/test_metrics.py\n@@ -185,13 +185,14 @@ def test_metric_spec_decode(\n ) -> None:\n     k = 5\n \n-    with vllm_runner(model,\n-                     dtype=dtype,\n-                     disable_log_stats=False,\n-                     gpu_memory_utilization=0.4,\n-                     speculative_model=model,\n-                     num_speculative_tokens=k,\n-                     use_v2_block_manager=True) as vllm_model:\n+    with vllm_runner(\n+            model,\n+            dtype=dtype,\n+            disable_log_stats=False,\n+            gpu_memory_utilization=0.4,\n+            speculative_model=model,\n+            num_speculative_tokens=k,\n+    ) as vllm_model:\n \n         # Force log interval to be 0 to catch all metrics.\n         stat_logger = vllm_model.model.llm_engine.stat_loggers['prometheus']\n@@ -242,7 +243,6 @@ def test_metric_spec_decode_interval(\n                              gpu_memory_utilization=0.4,\n                              speculative_model=model,\n                              num_speculative_tokens=k,\n-                             use_v2_block_manager=True,\n                              enforce_eager=True)\n \n     engine = LLMEngine.from_engine_args(engine_args)\ndiff --git a/tests/multi_step/test_correctness_async_llm.py b/tests/multi_step/test_correctness_async_llm.py\nindex 000c923ef..7203d635c 100644\n--- a/tests/multi_step/test_correctness_async_llm.py\n+++ b/tests/multi_step/test_correctness_async_llm.py\n@@ -17,7 +17,6 @@ NUM_PROMPTS = [10]\n \n DEFAULT_SERVER_ARGS: List[str] = [\n     \"--disable-log-requests\",\n-    \"--use-v2-block-manager\",\n     \"--worker-use-ray\",\n     \"--gpu-memory-utilization\",\n     \"0.85\",\ndiff --git a/tests/multi_step/test_correctness_llm.py b/tests/multi_step/test_correctness_llm.py\nindex f45428675..cc1fd1925 100644\n--- a/tests/multi_step/test_correctness_llm.py\n+++ b/tests/multi_step/test_correctness_llm.py\n@@ -76,7 +76,6 @@ def test_multi_step_llm(\n             enforce_eager=enforce_eager,\n             gpu_memory_utilization=0.7,\n             tensor_parallel_size=tp_size,\n-            use_v2_block_manager=True,\n             enable_chunked_prefill=enable_chunked_prefill,\n             num_scheduler_steps=num_scheduler_steps,\n     ) as vllm_model:\n@@ -169,7 +168,6 @@ def test_multi_step_llm_w_prompt_logprobs(\n             enforce_eager=enforce_eager,\n             gpu_memory_utilization=0.7,\n             tensor_parallel_size=tp_size,\n-            use_v2_block_manager=True,\n             num_scheduler_steps=num_scheduler_steps,\n     ) as vllm_model:\n         vllm_outputs = vllm_model.generate_greedy_logprobs(\n@@ -305,7 +303,6 @@ def test_multi_step_llm_chunked_prefill_prefix_cache(\n             enforce_eager=enforce_eager,\n             gpu_memory_utilization=0.7,\n             tensor_parallel_size=tp_size,\n-            use_v2_block_manager=True,\n             num_scheduler_steps=num_scheduler_steps,\n             max_model_len=48,\n             max_num_batched_tokens=48,\n@@ -324,7 +321,6 @@ def test_multi_step_llm_chunked_prefill_prefix_cache(\n             enforce_eager=enforce_eager,\n             gpu_memory_utilization=0.7,\n             tensor_parallel_size=tp_size,\n-            use_v2_block_manager=True,\n             enable_chunked_prefill=True,\n             enable_prefix_caching=True,\n             num_scheduler_steps=num_scheduler_steps,\ndiff --git a/tests/prefix_caching/test_prefix_caching.py b/tests/prefix_caching/test_prefix_caching.py\nindex 88437425f..366b030ea 100644\n--- a/tests/prefix_caching/test_prefix_caching.py\n+++ b/tests/prefix_caching/test_prefix_caching.py\n@@ -2,15 +2,9 @@\n \n Run `pytest tests/prefix_caching/test_prefix_caching.py`.\n \"\"\"\n-from typing import List\n-\n import pytest\n \n from tests.kernels.utils import override_backend_env_variable\n-from tests.utils import check_deprecated_block_manager_usage\n-from vllm.block import PhysicalTokenBlock\n-from vllm.core.block_manager_v1 import CachedBlockAllocator\n-from vllm.utils import Device\n \n from ..models.utils import check_outputs_equal\n \n@@ -19,92 +13,11 @@ MODELS = [\n ]\n \n \n-@pytest.fixture(scope=\"module\", autouse=True)\n-def check_deprecated_block_manager():\n-    check_deprecated_block_manager_usage(\n-        'tests/prefix_caching/test_prefix_caching.py')\n-\n-\n-@pytest.mark.parametrize(\"block_size\", [16])\n-@pytest.mark.parametrize(\"num_blocks\", [16])\n-def test_block_allocator(\n-    block_size: int,\n-    num_blocks: int,\n-):\n-    block_hash = 1\n-    block_allocator = CachedBlockAllocator(Device.CPU, block_size, num_blocks)\n-\n-    # Allocate two PysicalTokenBlocks with the same hash and check\n-    # that they are the same PhysicalTokenBlock\n-    first_block = block_allocator.allocate(block_hash, 0)\n-    second_block = block_allocator.allocate(block_hash, 0)\n-    assert (first_block == second_block)\n-    assert (second_block.ref_count == 2)\n-\n-    # Check metric: 1 hit of 2 queries\n-    assert block_allocator.get_prefix_cache_hit_rate() == 0.5\n-\n-    # Free the first_block and confirm that the ref_count is correctly\n-    # decremented on the second block\n-    block_allocator.free(first_block)\n-    assert (second_block.ref_count == 1)\n-\n-    # Free the second block\n-    block_allocator.free(second_block)\n-\n-    # Reallocate the first block and confirm that, even after the block\n-    # had its ref_count go to 0, we still get the same block back\n-    first_block = block_allocator.allocate(block_hash, 0)\n-    assert (first_block == second_block)\n-    assert (first_block.block_hash == block_hash)\n-\n-    # Allocate one more time to get 3/4 hit rate for easy checking\n-    block_allocator.allocate(block_hash, 0)\n-    assert block_allocator.get_prefix_cache_hit_rate() == 0.75\n-\n-\n-@pytest.mark.parametrize(\"num_blocks\", [16])\n-def test_eviction(num_blocks: int, ):\n-    block_size = 16\n-    block_allocator = CachedBlockAllocator(Device.CPU, block_size, num_blocks)\n-    blocks: List[PhysicalTokenBlock] = []\n-\n-    for i in range(num_blocks):\n-        # use i as the block_hash\n-        blocks.append(block_allocator.allocate(i, 0))\n-\n-    #Free all blocks\n-    for block in blocks:\n-        block_allocator.free(block)\n-\n-    # Allocate a new block and confirm that it's the first block freed.\n-    # I.E The Least Recently Used block\n-    new_block_hash = block_size\n-    new_block = block_allocator.allocate(new_block_hash, 0)\n-    assert (new_block == blocks[0])\n-    assert (new_block.block_hash == new_block_hash)\n-\n-    # Reallocate the second in blocks to remove it from the free list\n-    realloc_block_hash = 1\n-    realloc_block = block_allocator.allocate(realloc_block_hash, 0)\n-    assert (realloc_block == blocks[realloc_block_hash])\n-    assert (realloc_block.block_hash == realloc_block_hash)\n-\n-    # Allocate a new block and confirm that it's not the realloc_block,\n-    # since the realloc_block shouldn't be in the free list\n-    new_block_hash = block_size + 1\n-    new_block = block_allocator.allocate(new_block_hash, 0)\n-    assert (realloc_block != new_block)\n-    assert (new_block.block_hash == new_block_hash)\n-    assert (new_block.block_number == 2)\n-\n-\n @pytest.mark.parametrize(\"model\", MODELS)\n @pytest.mark.parametrize(\"backend\", [\"FLASH_ATTN\", \"FLASHINFER\", \"XFORMERS\"])\n @pytest.mark.parametrize(\"dtype\", [\"half\"])\n @pytest.mark.parametrize(\"max_tokens\", [5])\n @pytest.mark.parametrize(\"cached_position\", [0, 1])\n-@pytest.mark.parametrize(\"use_v2_block_manager\", [False, True])\n def test_mixed_requests(\n     hf_runner,\n     vllm_runner,\n@@ -114,7 +27,6 @@ def test_mixed_requests(\n     dtype: str,\n     max_tokens: int,\n     cached_position: int,\n-    use_v2_block_manager: bool,\n     monkeypatch,\n ) -> None:\n     \"\"\"\n@@ -132,7 +44,6 @@ def test_mixed_requests(\n             model,\n             dtype=dtype,\n             enable_prefix_caching=True,\n-            use_v2_block_manager=use_v2_block_manager,\n     ) as vllm_model:\n         # Run the first prompt so the cache is populated\n         vllm_outputs = vllm_model.generate_greedy([cached_prompt], max_tokens)\ndiff --git a/tests/spec_decode/e2e/test_compatibility.py b/tests/spec_decode/e2e/test_compatibility.py\nindex 69ea81cff..629074188 100644\n--- a/tests/spec_decode/e2e/test_compatibility.py\n+++ b/tests/spec_decode/e2e/test_compatibility.py\n@@ -1,27 +1,15 @@\n import pytest\n \n-from tests.utils import check_deprecated_block_manager_usage\n from vllm import SamplingParams\n \n from .conftest import get_output_from_llm_generator\n \n \n-@pytest.fixture(scope=\"module\", autouse=True)\n-def check_deprecated_block_manager():\n-    check_deprecated_block_manager_usage(\n-        'tests/spec_decode/e2e/test_compatibility.py')\n-\n-\n-@pytest.mark.parametrize(\n-    \"common_llm_kwargs\",\n-    [{\n-        \"model\": \"JackFram/llama-68m\",\n-        \"speculative_model\": \"JackFram/llama-68m\",\n-        \"num_speculative_tokens\": 5,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n-    }])\n+@pytest.mark.parametrize(\"common_llm_kwargs\", [{\n+    \"model\": \"JackFram/llama-68m\",\n+    \"speculative_model\": \"JackFram/llama-68m\",\n+    \"num_speculative_tokens\": 5,\n+}])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [\n     {\n         \"enable_chunked_prefill\": True,\n@@ -51,16 +39,11 @@ def test_spec_decode_xfail_chunked_prefill(test_llm_generator):\n                                       sampling_params)\n \n \n-@pytest.mark.parametrize(\n-    \"common_llm_kwargs\",\n-    [{\n-        \"model\": \"meta-llama/Llama-2-7b-chat-hf\",\n-        \"speculative_model\": \"JackFram/llama-68m\",\n-        \"num_speculative_tokens\": 5,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n-    }])\n+@pytest.mark.parametrize(\"common_llm_kwargs\", [{\n+    \"model\": \"meta-llama/Llama-2-7b-chat-hf\",\n+    \"speculative_model\": \"JackFram/llama-68m\",\n+    \"num_speculative_tokens\": 5,\n+}])\n @pytest.mark.parametrize(\n     \"per_test_common_llm_kwargs\",\n     [\n@@ -101,34 +84,3 @@ def test_spec_decode_xfail_spec_max_model_len(test_llm_generator):\n     with pytest.raises(ValueError, match=\"cannot be larger than\"):\n         get_output_from_llm_generator(test_llm_generator, prompts,\n                                       sampling_params)\n-\n-\n-@pytest.mark.parametrize(\"common_llm_kwargs\", [{\n-    \"model\": \"JackFram/llama-68m\",\n-    \"speculative_model\": \"JackFram/llama-68m\",\n-    \"num_speculative_tokens\": 5,\n-    \"use_v2_block_manager\": False,\n-}])\n-@pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n-@pytest.mark.parametrize(\"test_llm_kwargs\", [{}])\n-@pytest.mark.parametrize(\"seed\", [1])\n-def test_spec_decode_xfail_block_manager_v1(test_llm_generator):\n-    \"\"\"Verify that speculative decoding with block manager v1 fails.\n-    \"\"\"\n-    output_len = 128\n-    temperature = 0.0\n-\n-    prompts = [\n-        \"Hello, my name is\",\n-    ]\n-\n-    sampling_params = SamplingParams(\n-        max_tokens=output_len,\n-        ignore_eos=True,\n-        temperature=temperature,\n-    )\n-\n-    with pytest.raises(ValueError,\n-                       match=\"Speculative decoding requires usage of the V2\"):\n-        get_output_from_llm_generator(test_llm_generator, prompts,\n-                                      sampling_params)\ndiff --git a/tests/spec_decode/e2e/test_eagle_correctness.py b/tests/spec_decode/e2e/test_eagle_correctness.py\nindex d7ca8815e..5bc70de9d 100644\n--- a/tests/spec_decode/e2e/test_eagle_correctness.py\n+++ b/tests/spec_decode/e2e/test_eagle_correctness.py\n@@ -43,9 +43,6 @@ PRECISION = \"float32\"\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -86,9 +83,6 @@ def test_eagle_e2e_greedy_correctness(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -143,9 +137,6 @@ def test_eagle_e2e_greedy_logprobs(vllm_runner, common_llm_kwargs,\n     [{\n         \"enforce_eager\": False,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -191,9 +182,6 @@ def test_eagle_e2e_greedy_correctness_cuda_graph(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -235,9 +223,6 @@ def test_eagle_e2e_greedy_correctness_with_preemption(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -283,9 +268,6 @@ def test_eagle_different_k(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \ndiff --git a/tests/spec_decode/e2e/test_integration.py b/tests/spec_decode/e2e/test_integration.py\nindex d04e31268..b89e58497 100644\n--- a/tests/spec_decode/e2e/test_integration.py\n+++ b/tests/spec_decode/e2e/test_integration.py\n@@ -12,8 +12,6 @@ MAIN_MODEL = \"JackFram/llama-68m\"\n @pytest.mark.parametrize(\n     \"common_llm_kwargs\",\n     [{\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n \n         # Verify equality when cuda graphs allowed.\n         \"enforce_eager\": False,\n@@ -57,9 +55,6 @@ def test_spec_decode_cuda_graph(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [\n     {\n@@ -111,9 +106,6 @@ def test_speculative_model_quantization_config(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n         \"speculative_model\": \"JackFram/llama-68m\",\n         \"num_speculative_tokens\": 3,\n     }])\ndiff --git a/tests/spec_decode/e2e/test_integration_dist_tp2.py b/tests/spec_decode/e2e/test_integration_dist_tp2.py\nindex 679a6ded9..b829d1a5b 100644\n--- a/tests/spec_decode/e2e/test_integration_dist_tp2.py\n+++ b/tests/spec_decode/e2e/test_integration_dist_tp2.py\n@@ -17,9 +17,6 @@ from .conftest import run_equality_correctness_test_tp\n     [[\n         # Skip cuda graph recording for fast test.\n         \"--enforce-eager\",\n-\n-        # Required for spec decode.\n-        \"--use-v2-block-manager\",\n         \"--tensor-parallel-size\",\n         \"2\"\n     ]])\n@@ -74,9 +71,6 @@ def test_target_model_tp_gt_1(common_llm_kwargs, per_test_common_llm_kwargs,\n     [[\n         # Skip cuda graph recording for fast test.\n         \"--enforce-eager\",\n-\n-        # Required for spec decode.\n-        \"--use_v2_block_manager\",\n         \"--tensor_parallel_size\",\n         \"2\",\n \ndiff --git a/tests/spec_decode/e2e/test_integration_dist_tp4.py b/tests/spec_decode/e2e/test_integration_dist_tp4.py\nindex 3f7c5d749..555aef992 100644\n--- a/tests/spec_decode/e2e/test_integration_dist_tp4.py\n+++ b/tests/spec_decode/e2e/test_integration_dist_tp4.py\n@@ -19,9 +19,6 @@ SPEC_MODEL = \"JackFram/llama-68m\"\n     [[\n         # Skip cuda graph recording for fast test.\n         \"--enforce_eager\",\n-\n-        # Required for spec decode.\n-        \"--use-v2-block-manager\",\n         \"--tensor-parallel-size\",\n         \"4\",\n     ]])\n@@ -71,9 +68,6 @@ def test_draft_model_tp_lt_target_model_tp4(common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"--enforce-eager\",\n-\n-        # Required for spec decode.\n-        \"--use-v2-block-manager\",\n         \"--tensor-parallel-size\",\n         \"4\",\n     ]])\ndiff --git a/tests/spec_decode/e2e/test_logprobs.py b/tests/spec_decode/e2e/test_logprobs.py\nindex b7d54991e..4cfca8b78 100644\n--- a/tests/spec_decode/e2e/test_logprobs.py\n+++ b/tests/spec_decode/e2e/test_logprobs.py\n@@ -14,9 +14,6 @@ from .conftest import run_equality_correctness_test\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -67,9 +64,6 @@ def test_logprobs_equality(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -119,9 +113,6 @@ def test_logprobs_different_k(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -173,9 +164,6 @@ def test_logprobs_when_skip_speculation(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -251,8 +239,6 @@ def test_logprobs_temp_1(vllm_runner, common_llm_kwargs,\n         \"model_name\": \"JackFram/llama-160m\",\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\ndiff --git a/tests/spec_decode/e2e/test_medusa_correctness.py b/tests/spec_decode/e2e/test_medusa_correctness.py\nindex 0b36e712a..b8965606b 100644\n--- a/tests/spec_decode/e2e/test_medusa_correctness.py\n+++ b/tests/spec_decode/e2e/test_medusa_correctness.py\n@@ -45,9 +45,6 @@ PRECISION = \"float32\"\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -93,9 +90,6 @@ def test_medusa_e2e_greedy_correctness(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -151,9 +145,6 @@ def test_medusa_e2e_greedy_logprobs(vllm_runner, common_llm_kwargs,\n     [{\n         \"enforce_eager\": False,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -204,9 +195,6 @@ def test_medusa_e2e_greedy_correctness_cuda_graph(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -253,9 +241,6 @@ def test_medusa_e2e_greedy_correctness_with_preemption(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -306,9 +291,6 @@ def test_medusa_different_k(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -356,9 +338,6 @@ def test_medusa_disable_queue(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \ndiff --git a/tests/spec_decode/e2e/test_mlp_correctness.py b/tests/spec_decode/e2e/test_mlp_correctness.py\nindex 52b48a33c..5ecc0d4e9 100644\n--- a/tests/spec_decode/e2e/test_mlp_correctness.py\n+++ b/tests/spec_decode/e2e/test_mlp_correctness.py\n@@ -47,9 +47,6 @@ PRECISION = \"float32\"\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -94,9 +91,6 @@ def test_mlp_e2e_greedy_correctness(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -149,9 +143,6 @@ def test_mlp_e2e_greedy_logprobs(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -195,9 +186,6 @@ def test_mlp_e2e_acceptance_rate(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n \n@@ -258,9 +246,6 @@ def test_mlp_e2e_seeded_correctness(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -311,9 +296,6 @@ def test_mlp_e2e_greedy_correctness_with_preemption(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -366,9 +348,6 @@ def test_mlp_e2e_greedy_correctness_with_padding(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -419,9 +398,6 @@ def test_mlp_different_k(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Precision\n         \"dtype\": PRECISION,\n \n@@ -469,9 +445,6 @@ def test_mlp_disable_queue(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n         \"speculative_model\": SPEC_MODEL,\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\ndiff --git a/tests/spec_decode/e2e/test_multistep_correctness.py b/tests/spec_decode/e2e/test_multistep_correctness.py\nindex df6f12d57..5f240d42d 100644\n--- a/tests/spec_decode/e2e/test_multistep_correctness.py\n+++ b/tests/spec_decode/e2e/test_multistep_correctness.py\n@@ -55,9 +55,6 @@ from .conftest import (get_output_from_llm_generator,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n     }])\n @pytest.mark.parametrize(\n     \"per_test_common_llm_kwargs\",\n@@ -124,9 +121,6 @@ def test_spec_decode_e2e_with_detokenization(test_llm_generator,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n     }])\n@@ -190,9 +184,6 @@ def test_spec_decode_e2e_greedy_correctness_tiny_model_bs1(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n     }])\n@@ -246,9 +237,6 @@ def test_spec_decode_e2e_greedy_correctness_tiny_model_large_bs(\n     [{\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\n     \"per_test_common_llm_kwargs\",\n@@ -303,9 +291,6 @@ def test_spec_decode_e2e_greedy_correctness_tiny_model_large_bs_diff_output_len(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n     }])\n@@ -353,9 +338,6 @@ def test_spec_decode_e2e_greedy_correctness_real_model_bs1(\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n     }])\n@@ -404,9 +386,6 @@ def test_spec_decode_e2e_greedy_correctness_real_model_large_bs(\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [\n     {\n@@ -454,9 +433,6 @@ def test_spec_decode_e2e_greedy_correctness_with_preemption(\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\n     \"per_test_common_llm_kwargs\",\n@@ -514,9 +490,6 @@ def test_spec_decode_different_block_size(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -570,9 +543,6 @@ def test_skip_speculation(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -611,9 +581,6 @@ def test_disable_speculation(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -660,9 +627,6 @@ def test_many_k(vllm_runner, common_llm_kwargs, per_test_common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\ndiff --git a/tests/spec_decode/e2e/test_ngram_correctness.py b/tests/spec_decode/e2e/test_ngram_correctness.py\nindex 586245938..31bedad48 100644\n--- a/tests/spec_decode/e2e/test_ngram_correctness.py\n+++ b/tests/spec_decode/e2e/test_ngram_correctness.py\n@@ -35,9 +35,6 @@ from .conftest import run_equality_correctness_test\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n     }])\n@@ -82,9 +79,6 @@ def test_ngram_e2e_greedy_correctness(vllm_runner, common_llm_kwargs,\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # Print spec metrics.\n         \"disable_log_stats\": False,\n     }])\n@@ -145,9 +139,6 @@ def test_ngram_e2e_greedy_logprobs(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [\n     {\n@@ -195,9 +186,6 @@ def test_ngram_e2e_greedy_correctness_with_preemption(\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -254,9 +242,6 @@ def test_ngram_different_k(vllm_runner, common_llm_kwargs,\n \n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n-\n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True\n     }])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\", [{}])\n @pytest.mark.parametrize(\"baseline_llm_kwargs\", [{}])\n@@ -303,7 +288,6 @@ def test_ngram_disable_queue(vllm_runner, common_llm_kwargs,\n         \"enforce_eager\": True,\n \n         # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n         \"speculative_model\": \"[ngram]\",\n         \"num_speculative_tokens\": 5,\n         \"ngram_prompt_lookup_max\": 3,\ndiff --git a/tests/spec_decode/e2e/test_seed.py b/tests/spec_decode/e2e/test_seed.py\nindex b17013216..e42cf416b 100644\n--- a/tests/spec_decode/e2e/test_seed.py\n+++ b/tests/spec_decode/e2e/test_seed.py\n@@ -17,9 +17,6 @@ SPEC_MODEL = \"JackFram/llama-160m\"\n         # Skip cuda graph recording for fast test.\n         \"enforce_eager\": True,\n \n-        # Required for spec decode.\n-        \"use_v2_block_manager\": True,\n-\n         # speculative model\n         \"speculative_model\": \"JackFram/llama-160m\",\n \ndiff --git a/tests/utils.py b/tests/utils.py\nindex 924465057..115cab806 100644\n--- a/tests/utils.py\n+++ b/tests/utils.py\n@@ -678,12 +678,3 @@ def get_client_text_logprob_generations(\n     return [(text_generations, text,\n              (None if x.logprobs is None else x.logprobs.top_logprobs))\n             for completion in completions for x in completion.choices]\n-\n-\n-def check_deprecated_block_manager_usage(test_name: str):\n-    assert envs.VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1 is True, (\n-        f\"To allow the use of deprecated BlockSpaceManagerV1, set the \"\n-        f\"environment variable VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1. \"\n-        f\"You can run the tests with: \"\n-        f\"`VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1 pytest {test_name}`\"  #noqa\n-    )\ndiff --git a/vllm/attention/backends/flash_attn.py b/vllm/attention/backends/flash_attn.py\nindex 8457bde06..d54dbdcb1 100644\n--- a/vllm/attention/backends/flash_attn.py\n+++ b/vllm/attention/backends/flash_attn.py\n@@ -305,8 +305,6 @@ class FlashAttentionMetadataBuilder(\n         self.runner = input_builder.runner\n         self.sliding_window = input_builder.sliding_window\n         self.block_size = input_builder.block_size\n-        self.use_v2_block_manager = (\n-            input_builder.scheduler_config.use_v2_block_manager)\n \n     def _add_seq_group(\n             self, inter_data: \"ModelInputForGPUBuilder.InterDataForSeqGroup\",\n@@ -355,9 +353,9 @@ class FlashAttentionMetadataBuilder(\n \n             # Compute slot mapping.\n             is_profile_run = is_block_tables_empty(block_tables)\n-            start_idx = compute_slot_mapping_start_idx(\n-                is_prompt, query_len, context_len, self.sliding_window,\n-                self.use_v2_block_manager)\n+            start_idx = compute_slot_mapping_start_idx(is_prompt, query_len,\n+                                                       context_len,\n+                                                       self.sliding_window)\n             compute_slot_mapping(is_profile_run, self.slot_mapping, seq_id,\n                                  seq_len, context_len, start_idx,\n                                  self.block_size, inter_data.block_tables)\ndiff --git a/vllm/attention/backends/flashinfer.py b/vllm/attention/backends/flashinfer.py\nindex ba9b2d043..dd9a0fb9d 100644\n--- a/vllm/attention/backends/flashinfer.py\n+++ b/vllm/attention/backends/flashinfer.py\n@@ -475,8 +475,6 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n \n         self.sliding_window = input_builder.sliding_window\n         self.block_size = input_builder.block_size\n-        self.use_v2_block_manager = (\n-            input_builder.scheduler_config.use_v2_block_manager)\n \n         # Please follow https://docs.flashinfer.ai/tutorials/kv_layout.html#page-layout\n         # for the precise definition of the following fields.\n@@ -542,9 +540,9 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n             is_profile_run = is_block_tables_empty(block_tables)\n \n             # Compute slot mapping.\n-            start_idx = compute_slot_mapping_start_idx(\n-                is_prompt, query_len, context_len, self.sliding_window,\n-                self.use_v2_block_manager)\n+            start_idx = compute_slot_mapping_start_idx(is_prompt, query_len,\n+                                                       context_len,\n+                                                       self.sliding_window)\n             compute_slot_mapping(is_profile_run, self.slot_mapping, seq_id,\n                                  seq_len, context_len, start_idx,\n                                  self.block_size, inter_data.block_tables)\ndiff --git a/vllm/attention/backends/utils.py b/vllm/attention/backends/utils.py\nindex 53e3a53ba..358a223e7 100644\n--- a/vllm/attention/backends/utils.py\n+++ b/vllm/attention/backends/utils.py\n@@ -38,18 +38,12 @@ def is_block_tables_empty(block_tables: Union[None, Dict]):\n \n \n def compute_slot_mapping_start_idx(is_prompt: bool, query_len: int,\n-                                   context_len: int, sliding_window: int,\n-                                   use_v2_block_manager: bool):\n+                                   context_len: int, sliding_window: int):\n     \"\"\"\n     Compute the start index of slot mapping.\n     \"\"\"\n     start_idx = 0\n     if is_prompt and sliding_window is not None:\n-        assert use_v2_block_manager or context_len == 0, (\n-            \"Prefix caching is currently not supported with \"\n-            \"sliding window attention in V1 block manager\")\n-        # When prefill, we use it to not write slots to kv cache\n-        # to save memory.\n         start_idx = max(0, query_len - sliding_window)\n     return start_idx\n \n@@ -138,8 +132,6 @@ class CommonMetadataBuilder(AttentionMetadataBuilder[TAttentionMetadata]):\n \n         self.sliding_window = input_builder.sliding_window\n         self.block_size = input_builder.block_size\n-        self.use_v2_block_manager = (\n-            input_builder.scheduler_config.use_v2_block_manager)\n \n     def _add_seq_group(\n             self, inter_data: \"ModelInputForGPUBuilder.InterDataForSeqGroup\",\n@@ -180,9 +172,9 @@ class CommonMetadataBuilder(AttentionMetadataBuilder[TAttentionMetadata]):\n \n             # Compute slot mapping.\n             is_profile_run = is_block_tables_empty(block_tables)\n-            start_idx = compute_slot_mapping_start_idx(\n-                is_prompt, query_len, context_len, self.sliding_window,\n-                self.use_v2_block_manager)\n+            start_idx = compute_slot_mapping_start_idx(is_prompt, query_len,\n+                                                       context_len,\n+                                                       self.sliding_window)\n             compute_slot_mapping(is_profile_run, self.slot_mapping, seq_id,\n                                  seq_len, context_len, start_idx,\n                                  self.block_size, inter_data.block_tables)\ndiff --git a/vllm/commit_id.py b/vllm/commit_id.py\nnew file mode 100644\nindex 000000000..d857066f1\n--- /dev/null\n+++ b/vllm/commit_id.py\n@@ -0,0 +1 @@\n+__commit__ = \"93ec62b8556e279d2c050bdc1c3247831bd39466\"\ndiff --git a/vllm/config.py b/vllm/config.py\nindex 2e98923a3..4533fb017 100644\n--- a/vllm/config.py\n+++ b/vllm/config.py\n@@ -949,7 +949,6 @@ class SchedulerConfig:\n             iteration.\n         max_model_len: Maximum length of a sequence (including prompt\n             and generated text).\n-        use_v2_block_manager: Whether to use the BlockSpaceManagerV2 or not.\n         num_lookahead_slots: The number of slots to allocate per sequence per\n             step, beyond the known token ids. This is used in speculative\n             decoding to store KV activations of tokens which may or may not be\n@@ -976,7 +975,6 @@ class SchedulerConfig:\n                  max_num_batched_tokens: Optional[int],\n                  max_num_seqs: int,\n                  max_model_len: int,\n-                 use_v2_block_manager: bool = True,\n                  num_lookahead_slots: int = 0,\n                  delay_factor: float = 0.0,\n                  enable_chunked_prefill: bool = False,\n@@ -1026,7 +1024,6 @@ class SchedulerConfig:\n \n         self.max_num_seqs = max_num_seqs\n         self.max_model_len = max_model_len\n-        self.use_v2_block_manager = use_v2_block_manager\n         self.num_lookahead_slots = num_lookahead_slots\n         self.delay_factor = delay_factor\n         self.chunked_prefill_enabled = enable_chunked_prefill\n@@ -1067,18 +1064,6 @@ class SchedulerConfig:\n                 f\"({self.num_scheduler_steps}) must be greater than or \"\n                 \"equal to 1.\")\n \n-        if (not self.use_v2_block_manager \\\n-            and not envs.VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1):\n-            raise ValueError(\n-                \"The use of BlockSpaceManagerV1 is deprecated and will \"\n-                \"be removed in a future release. Please switch to \"\n-                \"BlockSpaceManagerV2 by setting --use-v2-block-manager to \"\n-                \"True. If you wish to suppress this error temporarily, \"\n-                \"you can set the environment variable \"\n-                \"`VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1=1. If your use \"\n-                \"case is not supported in BlockSpaceManagerV2, please \"\n-                \"file an issue with detailed information.\")\n-\n     @property\n     def is_multi_step(self) -> bool:\n         return self.num_scheduler_steps > 1\n@@ -1137,7 +1122,6 @@ class SpeculativeConfig:\n         speculative_disable_mqa_scorer: Optional[bool],\n         speculative_max_model_len: Optional[int],\n         enable_chunked_prefill: bool,\n-        use_v2_block_manager: bool,\n         disable_log_stats: bool,\n         speculative_disable_by_batch_size: Optional[int],\n         ngram_prompt_lookup_max: Optional[int],\n@@ -1178,9 +1162,6 @@ class SpeculativeConfig:\n             enable_chunked_prefill (bool): Whether vLLM is configured to use\n                 chunked prefill or not. Used for raising an error since its not\n                 yet compatible with spec decode.\n-            use_v2_block_manager (bool): Whether vLLM is configured to use the\n-                v2 block manager or not. Used for raising an error since the v2\n-                block manager is required with spec decode.\n             speculative_disable_by_batch_size (Optional[int]): Disable\n                 speculative decoding for new incoming requests when the number\n                 of enqueue requests  is larger than this value, if provided.\n@@ -1231,11 +1212,6 @@ class SpeculativeConfig:\n                 \"Speculative decoding and chunked prefill are \"\n                 f\"currently mutually exclusive ({enable_chunked_prefill=}).\")\n \n-        if not use_v2_block_manager:\n-            raise ValueError(\n-                \"Speculative decoding requires usage of the V2 \"\n-                \"block manager. Enable it with --use-v2-block-manager.\")\n-\n         # TODO: The user should be able to specify revision/max model len\n         # for the draft model. It is not currently supported.\n         draft_revision = None\ndiff --git a/vllm/core/block/utils.py b/vllm/core/block/utils.py\nindex 28839437c..1c6578e4c 100644\n--- a/vllm/core/block/utils.py\n+++ b/vllm/core/block/utils.py\n@@ -4,28 +4,6 @@ from vllm.utils import (STR_NOT_IMPL_ENC_DEC_PREFIX_CACHE,\n                         STR_NOT_IMPL_ENC_DEC_SWA)\n \n \n-def _get_block_mgr_sliding_window_attr(block_mgr):\n-    '''\n-    BlockManagerV1 and BlockManagerV2 have slightly different\n-    members related to sliding window attention (SWA). This\n-    function extracts the appropriate member to use for determining\n-    whether SWA is enabled.\n-\n-    Arguments:\n-\n-    * block_mgr: BlockManagerV1 or BlockManagerV2 instance\n-    '''\n-\n-    if hasattr(block_mgr, 'block_sliding_window'):\n-        return block_mgr.block_sliding_window\n-    if hasattr(block_mgr, 'max_block_sliding_window'):\n-        return block_mgr.max_block_sliding_window\n-\n-    raise AttributeError(\"Block manager instance has neither \" + \\\n-                         \"block_sliding_window nor \" + \\\n-                         \"max_block_sliding_window attributes.\")\n-\n-\n def check_no_caching_or_swa_for_blockmgr_encdec(\n         block_mgr, seq_group: SequenceGroup) -> None:\n     '''\n@@ -41,7 +19,7 @@ def check_no_caching_or_swa_for_blockmgr_encdec(\n     '''\n \n     if seq_group.is_encoder_decoder():\n-        if _get_block_mgr_sliding_window_attr(block_mgr) is not None:\n+        if block_mgr.max_block_sliding_window is not None:\n             raise NotImplementedError(STR_NOT_IMPL_ENC_DEC_SWA)\n \n         if block_mgr.enable_caching:\ndiff --git a/vllm/core/block_manager_v2.py b/vllm/core/block_manager.py\nsimilarity index 99%\nrename from vllm/core/block_manager_v2.py\nrename to vllm/core/block_manager.py\nindex cb047c832..61ed7afba 100644\n--- a/vllm/core/block_manager_v2.py\n+++ b/vllm/core/block_manager.py\n@@ -17,7 +17,7 @@ SeqId = int\n EncoderSeqId = str\n \n \n-class BlockSpaceManagerV2(BlockSpaceManager):\n+class SelfAttnBlockSpaceManager(BlockSpaceManager):\n     \"\"\"BlockSpaceManager which manages the allocation of KV cache.\n \n     It owns responsibility for allocation, swapping, allocating memory for\ndiff --git a/vllm/core/block_manager_v1.py b/vllm/core/block_manager_v1.py\ndeleted file mode 100644\nindex 8bc0ce2bc..000000000\n--- a/vllm/core/block_manager_v1.py\n+++ /dev/null\n@@ -1,743 +0,0 @@\n-\"\"\"A block manager that manages token blocks.\"\"\"\n-import math\n-from abc import ABC, abstractmethod\n-from itertools import count, takewhile\n-from os.path import commonprefix\n-from typing import Dict, List, Optional\n-from typing import Sequence as GenericSequence\n-from typing import Set, Tuple\n-\n-from vllm.block import BlockTable, PhysicalTokenBlock\n-from vllm.core.block.common import CacheMetricData\n-from vllm.core.block.utils import check_no_caching_or_swa_for_blockmgr_encdec\n-from vllm.core.evictor_v1 import EvictionPolicy, Evictor, make_evictor\n-from vllm.core.interfaces import AllocStatus, BlockSpaceManager\n-from vllm.logger import init_logger\n-from vllm.sequence import Sequence, SequenceGroup, SequenceStatus\n-from vllm.utils import Device\n-\n-logger = init_logger(__name__)\n-\n-\n-class BlockAllocatorBase(ABC):\n-    \"\"\"Manages free physical token blocks for a device.\n-\n-    The allocator maintains a list of free blocks and allocates a block when\n-    requested. When a block is freed, its reference count is decremented. If\n-    the reference count becomes zero, the block is added back to the free list.\n-    \"\"\"\n-\n-    @abstractmethod\n-    def __init__(self,\n-                 device: Device,\n-                 block_size: int,\n-                 num_blocks: int,\n-                 eviction_policy: EvictionPolicy = EvictionPolicy.LRU):\n-        pass\n-\n-    @abstractmethod\n-    def allocate(self,\n-                 block_hash: Optional[int] = None,\n-                 num_hashed_tokens: int = 0) -> PhysicalTokenBlock:\n-        pass\n-\n-    @abstractmethod\n-    def free(self, block: PhysicalTokenBlock) -> None:\n-        pass\n-\n-    @abstractmethod\n-    def get_num_free_blocks(self) -> int:\n-        pass\n-\n-    @abstractmethod\n-    def get_num_total_blocks(self) -> int:\n-        pass\n-\n-    @abstractmethod\n-    def contains_block(self, block_hash: int) -> bool:\n-        pass\n-\n-    @abstractmethod\n-    def update_hash(self, block_hash: int, block: PhysicalTokenBlock):\n-        pass\n-\n-    @abstractmethod\n-    def get_prefix_cache_hit_rate(self) -> float:\n-        \"\"\"Prefix cache hit rate. -1 means not supported or disabled.\"\"\"\n-        pass\n-\n-\n-class CachedBlockAllocator(BlockAllocatorBase):\n-    \"\"\"Manages free physical token blocks for a device.\n-\n-    The allocator maintains a list of free blocks and allocates a block when\n-    requested. When a block is freed, its reference count is decremented. If\n-    the reference count becomes zero, the block is added back to the free list.\n-    \"\"\"\n-\n-    def __init__(self,\n-                 device: Device,\n-                 block_size: int,\n-                 num_blocks: int,\n-                 eviction_policy: EvictionPolicy = EvictionPolicy.LRU) -> None:\n-        self.device = device\n-        self.block_size = block_size\n-        self.num_blocks = num_blocks\n-\n-        self.current_num_blocks = 0\n-        self.cached_blocks: Dict[int, PhysicalTokenBlock] = {}\n-\n-        self.evictor: Evictor = make_evictor(eviction_policy)\n-\n-        self.default_hash_ctr = count()\n-\n-        self.cache_metric_data = CacheMetricData()\n-\n-    def allocate_block(self, block_hash: int,\n-                       num_hashed_tokens: int) -> PhysicalTokenBlock:\n-        if self.current_num_blocks == self.num_blocks:\n-            block = self.evictor.evict()\n-            block.block_hash = block_hash\n-            block.num_hashed_tokens = num_hashed_tokens\n-            return block\n-        block = PhysicalTokenBlock(device=self.device,\n-                                   block_number=self.current_num_blocks,\n-                                   block_size=self.block_size,\n-                                   block_hash=block_hash,\n-                                   num_hashed_tokens=num_hashed_tokens)\n-        self.current_num_blocks += 1\n-        return block\n-\n-    def allocate(self,\n-                 block_hash: Optional[int] = None,\n-                 num_hashed_tokens: int = 0) -> PhysicalTokenBlock:\n-        if block_hash is None:\n-            block_hash = next(self.default_hash_ctr)\n-\n-        if block_hash in self.evictor:\n-            assert block_hash not in self.cached_blocks\n-            block = self.evictor.remove(block_hash)\n-            assert block.ref_count == 0\n-            self.cached_blocks[block_hash] = block\n-\n-        if block_hash in self.cached_blocks:\n-            self.cache_metric_data.query(hit=True)\n-        else:\n-            self.cache_metric_data.query(hit=False)\n-            self.cached_blocks[block_hash] = self.allocate_block(\n-                block_hash, num_hashed_tokens)\n-        block = self.cached_blocks[block_hash]\n-        assert block.block_hash == block_hash\n-        block.ref_count += 1\n-        return block\n-\n-    def free(self, block: PhysicalTokenBlock) -> None:\n-        if block.ref_count == 0:\n-            raise ValueError(f\"Double free! {block} is already freed.\")\n-        block.ref_count -= 1\n-        if block.ref_count == 0:\n-            assert block.block_hash not in self.evictor\n-            self.evictor.add(block)\n-\n-            # Remove the block from the cached_blocks\n-            del self.cached_blocks[block.block_hash]\n-\n-    def get_num_free_blocks(self) -> int:\n-        return (self.num_blocks - self.current_num_blocks +\n-                self.evictor.num_blocks)\n-\n-    def get_num_total_blocks(self) -> int:\n-        return self.num_blocks\n-\n-    def contains_block(self, block_hash: int) -> bool:\n-        return block_hash in self.cached_blocks or block_hash in self.evictor\n-\n-    def update_hash(self, block_hash: int, block: PhysicalTokenBlock):\n-        # Update the hash of block and the cached_blocks dictionary.\n-        assert not self.contains_block(block_hash)\n-        old_hash = block.block_hash\n-        block.block_hash = block_hash\n-        del self.cached_blocks[old_hash]\n-        self.cached_blocks[block_hash] = block\n-\n-    def get_prefix_cache_hit_rate(self) -> float:\n-        return self.cache_metric_data.get_hit_rate()\n-\n-\n-class UncachedBlockAllocator(BlockAllocatorBase):\n-    \"\"\"Manages free physical token blocks for a device.\n-\n-    The allocator maintains a list of free blocks and allocates a block when\n-    requested. When a block is freed, its reference count is decremented. If\n-    the reference count becomes zero, the block is added back to the free list.\n-    \"\"\"\n-\n-    def __init__(\n-        self,\n-        device: Device,\n-        block_size: int,\n-        num_blocks: int,\n-    ) -> None:\n-        self.device = device\n-        self.block_size = block_size\n-        self.num_blocks = num_blocks\n-\n-        # Initialize the free blocks.\n-        self.free_blocks: List[PhysicalTokenBlock] = []\n-        for i in range(num_blocks):\n-            block = PhysicalTokenBlock(device=device,\n-                                       block_number=i,\n-                                       block_size=block_size,\n-                                       block_hash=-1,\n-                                       num_hashed_tokens=0)\n-            self.free_blocks.append(block)\n-\n-    def allocate(self,\n-                 block_hash: Optional[int] = None,\n-                 num_hashed_tokens: int = 0) -> PhysicalTokenBlock:\n-        if not self.free_blocks:\n-            raise ValueError(\"Out of memory! No free blocks are available.\")\n-        block = self.free_blocks.pop()\n-        block.ref_count = 1\n-        return block\n-\n-    def free(self, block: PhysicalTokenBlock) -> None:\n-        if block.ref_count == 0:\n-            raise ValueError(f\"Double free! {block} is already freed.\")\n-        block.ref_count -= 1\n-        if block.ref_count == 0:\n-            self.free_blocks.append(block)\n-\n-    def get_num_free_blocks(self) -> int:\n-        return len(self.free_blocks)\n-\n-    def get_num_total_blocks(self) -> int:\n-        return self.num_blocks\n-\n-    def contains_block(self, block_hash: int) -> bool:\n-        raise NotImplementedError(\n-            \"Invalid codepath for uncached block allocator.\")\n-\n-    def update_hash(self, block_hash: int, block: PhysicalTokenBlock):\n-        raise NotImplementedError(\n-            \"Invalid codepath for uncached block allocator.\")\n-\n-    def get_prefix_cache_hit_rate(self) -> float:\n-        return -1\n-\n-\n-class BlockSpaceManagerV1(BlockSpaceManager):\n-    \"\"\"Manages the mapping between logical and physical token blocks.\"\"\"\n-\n-    def __init__(\n-        self,\n-        block_size: int,\n-        num_gpu_blocks: int,\n-        num_cpu_blocks: int,\n-        watermark: float = 0.01,\n-        sliding_window: Optional[int] = None,\n-        enable_caching: bool = False,\n-    ) -> None:\n-        self.block_size = block_size\n-        self.num_total_gpu_blocks = num_gpu_blocks\n-        self.num_total_cpu_blocks = num_cpu_blocks\n-\n-        if enable_caching and sliding_window is not None:\n-            raise NotImplementedError(\n-                \"Sliding window is not allowed with prefix caching enabled!\")\n-\n-        self.block_sliding_window = None\n-        if sliding_window is not None:\n-            # Round up to nearest block size to regularize sliding window\n-            # allocation sizes.\n-            self.block_sliding_window = math.ceil(sliding_window / block_size)\n-\n-        self.watermark = watermark\n-        assert watermark >= 0.0\n-\n-        self.enable_caching = enable_caching\n-\n-        self.watermark_blocks = int(watermark * num_gpu_blocks)\n-\n-        if self.enable_caching:\n-            logger.info(\"Automatic prefix caching is enabled.\")\n-            self.gpu_allocator: BlockAllocatorBase = CachedBlockAllocator(\n-                Device.GPU, block_size, num_gpu_blocks)\n-            self.cpu_allocator: BlockAllocatorBase = CachedBlockAllocator(\n-                Device.CPU, block_size, num_cpu_blocks)\n-        else:\n-            self.gpu_allocator = UncachedBlockAllocator(\n-                Device.GPU, block_size, num_gpu_blocks)\n-            self.cpu_allocator = UncachedBlockAllocator(\n-                Device.CPU, block_size, num_cpu_blocks)\n-        # Mapping: seq_id -> BlockTable.\n-        self.block_tables: Dict[int, BlockTable] = {}\n-\n-        # Mapping: req_id -> BlockTable\n-        # Note that each SequenceGroup has a unique\n-        # request ID\n-        self.cross_block_tables: Dict[str, BlockTable] = {}\n-\n-    def _get_seq_num_required_blocks(self, seq: Optional[Sequence]) -> int:\n-        return 0 if seq is None else seq.n_blocks\n-\n-    def can_allocate(self,\n-                     seq_group: SequenceGroup,\n-                     num_lookahead_slots: int = 0) -> AllocStatus:\n-        # FIXME(woosuk): Here we assume that all sequences in the group share\n-        # the same prompt. This may not be true for preempted sequences.\n-\n-        assert (num_lookahead_slots == 0\n-                ), \"lookahead allocation not supported in BlockSpaceManagerV1\"\n-\n-        check_no_caching_or_swa_for_blockmgr_encdec(self, seq_group)\n-\n-        self_num_required_blocks = self._get_seq_num_required_blocks(\n-            seq_group.get_seqs(status=SequenceStatus.WAITING)[0])\n-        cross_num_required_blocks = self._get_seq_num_required_blocks(\n-            seq_group.get_encoder_seq())\n-        num_required_blocks = self_num_required_blocks + \\\n-                              cross_num_required_blocks\n-\n-        if self.block_sliding_window is not None:\n-\n-            num_required_blocks = min(num_required_blocks,\n-                                      self.block_sliding_window)\n-        num_free_gpu_blocks = self.gpu_allocator.get_num_free_blocks()\n-\n-        # Use watermark to avoid frequent cache eviction.\n-        if (self.num_total_gpu_blocks - num_required_blocks <\n-                self.watermark_blocks):\n-            return AllocStatus.NEVER\n-        if num_free_gpu_blocks - num_required_blocks >= self.watermark_blocks:\n-            return AllocStatus.OK\n-        else:\n-            return AllocStatus.LATER\n-\n-    def _allocate_sequence(self, \\\n-                           seq: Optional[Sequence], \\\n-                           ref_count: int, \\\n-                           is_encoder_decoder: bool = True) -> BlockTable:\n-        # Allocate new physical token blocks that will store the prompt tokens.\n-        num_prompt_blocks = self._get_seq_num_required_blocks(seq)\n-\n-        block_table: BlockTable = BlockTable()\n-        assert seq is not None\n-        for logical_idx in range(num_prompt_blocks):\n-            if (self.block_sliding_window is not None\n-                    and logical_idx >= self.block_sliding_window):\n-                block = block_table[logical_idx % self.block_sliding_window]\n-                # Set the reference counts of the token blocks.\n-                block.ref_count = ref_count\n-            elif not is_encoder_decoder and self.enable_caching:\n-                block = self.gpu_allocator.allocate(\n-                    seq.hash_of_block(logical_idx),\n-                    seq.num_hashed_tokens_of_block(logical_idx))\n-            else:\n-                block = self.gpu_allocator.allocate()\n-                # Set the reference counts of the token blocks.\n-                block.ref_count = ref_count\n-            block_table.append(block)\n-\n-        return block_table\n-\n-    def allocate(self, seq_group: SequenceGroup) -> None:\n-        is_encoder_decoder = seq_group.is_encoder_decoder()\n-        check_no_caching_or_swa_for_blockmgr_encdec(self, seq_group)\n-\n-        # Allocate decoder sequences\n-        #\n-        # NOTE: Here we assume that all sequences in the group have the same\n-        # decoder prompt.\n-        wait_seqs = seq_group.get_seqs(status=SequenceStatus.WAITING)\n-        seq = wait_seqs[0]\n-        block_table: BlockTable = \\\n-            self._allocate_sequence(seq,\n-                                    seq_group.num_seqs(),\n-                                    is_encoder_decoder)\n-\n-        # Assign the self-attention block tables for each sequence.\n-        if len(wait_seqs) == 1:\n-            self.block_tables[seq.seq_id] = block_table\n-        else:\n-            for seq in wait_seqs:\n-                self.block_tables[seq.seq_id] = block_table.copy()\n-\n-        # Allocate encoder sequence\n-        if is_encoder_decoder:\n-            # A SequenceGroup has only a single encoder sequence (at most),\n-            # thus allocate with a ref count of 1\n-            block_table = self._allocate_sequence(seq_group.get_encoder_seq(),\n-                                                  1, is_encoder_decoder)\n-            # Assign the cross-attention block table for the SequenceGroup.\n-            self.cross_block_tables[seq_group.request_id] = block_table\n-\n-    def can_append_slots(self,\n-                         seq_group: SequenceGroup,\n-                         num_lookahead_slots: int = 0) -> bool:\n-        assert (num_lookahead_slots == 0\n-                ), \"lookahead allocation not supported in BlockSpaceManagerV1\"\n-\n-        # Simple heuristic: If there is at least one free block\n-        # for each sequence, we can append.\n-        num_free_gpu_blocks = self.gpu_allocator.get_num_free_blocks()\n-        num_seqs = seq_group.num_seqs(status=SequenceStatus.RUNNING)\n-        return num_seqs <= num_free_gpu_blocks\n-\n-    def _promote_last_block(\n-        self,\n-        seq: Sequence,\n-        last_block: PhysicalTokenBlock,\n-    ) -> PhysicalTokenBlock:\n-        assert self.enable_caching\n-\n-        # Compute a new hash for the block so that it can be shared by other\n-        # Sequences\n-        new_hash = seq.hash_of_block(seq.n_blocks - 1)\n-\n-        # if new_hash is already in the cached table, then free last_block\n-        # and return the cached version\n-        if self.gpu_allocator.contains_block(new_hash):\n-            self.gpu_allocator.free(last_block)\n-            return self.gpu_allocator.allocate(new_hash)\n-        else:\n-            self.gpu_allocator.update_hash(new_hash, last_block)\n-            return last_block\n-\n-    def _is_last_block_full(\n-        self,\n-        seq: Sequence,\n-    ) -> bool:\n-        token_ids_len = seq.data.get_len()\n-        return token_ids_len > 0 and token_ids_len % seq.block_size == 0\n-\n-    def _maybe_promote_last_block(\n-        self,\n-        seq: Sequence,\n-        last_block: PhysicalTokenBlock,\n-    ) -> PhysicalTokenBlock:\n-        if self._is_last_block_full(seq):\n-            return self._promote_last_block(seq, last_block)\n-        else:\n-            return last_block\n-\n-    def _allocate_last_physical_block(\n-        self,\n-        seq: Sequence,\n-    ) -> PhysicalTokenBlock:\n-        # Called before a new block is appended.\n-        # This is in charge of allocating a new physical block (to be appended).\n-\n-        # None if the last block is not full. Otherwise, we set it to the\n-        # content hash.\n-        if not self.enable_caching:\n-            return self.gpu_allocator.allocate()\n-        block_hash: Optional[int] = None\n-        n_blocks = seq.n_blocks\n-        if (self._is_last_block_full(seq)):\n-            block_hash = seq.hash_of_block(n_blocks - 1)\n-        num_hashed_tokens = seq.num_hashed_tokens_of_block(n_blocks - 1)\n-\n-        # num_hashed_tokens is used to compute future hashes\n-        # (e.g. in the hashing function, it is used to ask the sequence for\n-        # prefix tokens)\n-        new_block = self.gpu_allocator.allocate(block_hash, num_hashed_tokens)\n-\n-        # If the block_hash is None, then the block is not full.\n-        # If the block is not full, then we expect it to have a refcount of 1.\n-        if block_hash is None:\n-            assert new_block.ref_count == 1\n-        return new_block\n-\n-    def append_slots(\n-        self,\n-        seq: Sequence,\n-        num_lookahead_slots: int = 0,\n-    ) -> List[Tuple[int, int]]:\n-        \"\"\"Allocate a physical slot for a new token.\"\"\"\n-        n_blocks = seq.n_blocks\n-        block_table = self.block_tables[seq.seq_id]\n-        # If we need to allocate a new physical block\n-        if len(block_table) < n_blocks:\n-            # Currently this code only supports adding one physical block\n-            assert len(block_table) == n_blocks - 1\n-\n-            if (self.block_sliding_window\n-                    and len(block_table) >= self.block_sliding_window):\n-                # reuse a block\n-                block_table.append(block_table[len(block_table) %\n-                                               self.block_sliding_window])\n-            else:\n-                # The sequence hash a new logical block.\n-                # Allocate a new physical block.\n-                new_block = self._allocate_last_physical_block(seq)\n-                block_table.append(new_block)\n-                return []\n-\n-        # We want to append the token to the last physical block.\n-        last_block = block_table[-1]\n-        assert last_block.device == Device.GPU\n-        if last_block.ref_count == 1:\n-            # Not shared with other sequences. Appendable.\n-            if self.enable_caching:\n-                # If the last block is now complete, we may reuse an old block\n-                # to save memory.\n-                maybe_new_block = self._maybe_promote_last_block(\n-                    seq, last_block)\n-                block_table[-1] = maybe_new_block\n-            return []\n-        else:\n-            # The last block is shared with other sequences.\n-            # Copy on Write: Allocate a new block and copy the tokens.\n-            new_block = self._allocate_last_physical_block(seq)\n-\n-            block_table[-1] = new_block\n-            self.gpu_allocator.free(last_block)\n-            return [(last_block.block_number, new_block.block_number)]\n-\n-    def fork(self, parent_seq: Sequence, child_seq: Sequence) -> None:\n-        # NOTE: fork does not allocate a new physical block.\n-        # Thus, it is always safe from OOM.\n-        if parent_seq.seq_id not in self.block_tables:\n-            # Parent sequence has either been freed or never existed.\n-            return\n-        src_block_table = self.block_tables[parent_seq.seq_id]\n-        self.block_tables[child_seq.seq_id] = src_block_table.copy()\n-\n-        # When using a sliding window, blocks will be eventually reused.\n-        # In this case the block tables will contain repeated blocks.\n-        # When forking, we must make sure that each block's `ref_count`\n-        # is only incremented by one, so we deduplicate them by wrapping\n-        # them in a set.\n-        for block in set(src_block_table):\n-            block.ref_count += 1\n-\n-    def _get_physical_blocks(\n-            self, seq_group: SequenceGroup) -> List[PhysicalTokenBlock]:\n-\n-        # NOTE: Here, we assume that the physical blocks are only shared by\n-        # the sequences in the same group.\n-        request_id = seq_group.request_id\n-        blocks: Set[PhysicalTokenBlock] = set()\n-        for seq in seq_group.get_seqs():\n-            if seq.is_finished():\n-                continue\n-            blocks.update(self.block_tables[seq.seq_id])\n-        # Cross-attention blocks\n-        if seq_group.is_encoder_decoder():\n-            blocks.update(self.cross_block_tables[request_id])\n-        return list(blocks)\n-\n-    def can_swap_in(self,\n-                    seq_group: SequenceGroup,\n-                    num_lookahead_slots: int = 0) -> AllocStatus:\n-        assert (num_lookahead_slots == 0\n-                ), \"BlockSpaceManagerV1 does not support lookahead allocation\"\n-\n-        blocks = self._get_physical_blocks(seq_group)\n-        num_swapped_seqs = seq_group.num_seqs(status=SequenceStatus.SWAPPED)\n-        if seq_group.is_encoder_decoder():\n-            num_swapped_seqs += 1\n-        num_free_blocks = self.gpu_allocator.get_num_free_blocks()\n-        # NOTE: Conservatively, we assume that every sequence will allocate\n-        # at least one free block right after the swap-in.\n-        # NOTE: This should match the logic in can_append_slot().\n-        num_required_blocks = len(blocks) + num_swapped_seqs\n-        if self.gpu_allocator.get_num_total_blocks() < num_required_blocks:\n-            return AllocStatus.NEVER\n-        elif num_free_blocks - num_required_blocks >= self.watermark_blocks:\n-            return AllocStatus.OK\n-        else:\n-            return AllocStatus.LATER\n-\n-    def _swap_block_table(\n-            self, block_table: BlockTable, src_allocator: BlockAllocatorBase,\n-            dest_allocator: BlockAllocatorBase,\n-            mapping: Dict[PhysicalTokenBlock,\n-                          PhysicalTokenBlock]) -> BlockTable:\n-        new_block_table: BlockTable = BlockTable()\n-\n-        for from_block in block_table:\n-            if from_block in mapping:\n-                to_block = mapping[from_block]\n-                to_block.ref_count += 1\n-            else:\n-                to_block = dest_allocator.allocate(\n-                    from_block.block_hash, from_block.num_hashed_tokens)\n-                mapping[from_block] = to_block\n-            new_block_table.append(to_block)\n-            # Free the source block swapped in to destination.\n-            src_allocator.free(from_block)\n-\n-        return new_block_table\n-\n-    def swap_in(self, seq_group: SequenceGroup) -> List[Tuple[int, int]]:\n-\n-        request_id = seq_group.request_id\n-\n-        # CPU block -> GPU block.\n-        # dict is efficient in lookup `if cpu_block in mapping`\n-        mapping: Dict[PhysicalTokenBlock, PhysicalTokenBlock] = {}\n-        for seq in seq_group.get_seqs(status=SequenceStatus.SWAPPED):\n-            self.block_tables[seq.seq_id] = \\\n-                self._swap_block_table(self.block_tables[seq.seq_id],\n-                                       self.cpu_allocator, self.gpu_allocator,\n-                                       mapping)\n-\n-        if seq_group.is_encoder_decoder():\n-            self.cross_block_tables[request_id] = \\\n-                self._swap_block_table(self.cross_block_tables[request_id],\n-                                       self.cpu_allocator,\n-                                       self.gpu_allocator,\n-                                       mapping)\n-\n-        return [(cpu_block.block_number, gpu_block.block_number)\n-                for cpu_block, gpu_block in mapping.items()]\n-\n-    def can_swap_out(self, seq_group: SequenceGroup) -> bool:\n-        blocks = self._get_physical_blocks(seq_group)\n-        return len(blocks) <= self.cpu_allocator.get_num_free_blocks()\n-\n-    def swap_out(self, seq_group: SequenceGroup) -> List[Tuple[int, int]]:\n-        request_id = seq_group.request_id\n-\n-        # GPU block -> CPU block.\n-        # dict is efficient in lookup `if gpu_block in mapping`\n-        mapping: Dict[PhysicalTokenBlock, PhysicalTokenBlock] = {}\n-        for seq in seq_group.get_seqs(status=SequenceStatus.RUNNING):\n-            self.block_tables[seq.seq_id] = \\\n-                self._swap_block_table(self.block_tables[seq.seq_id],\n-                                       self.gpu_allocator, self.cpu_allocator,\n-                                       mapping)\n-\n-        if seq_group.is_encoder_decoder():\n-            self.cross_block_tables[request_id] = \\\n-                self._swap_block_table(self.cross_block_tables[request_id],\n-                                       self.gpu_allocator,\n-                                       self.cpu_allocator,\n-                                       mapping)\n-\n-        return [(cpu_block.block_number, gpu_block.block_number)\n-                for cpu_block, gpu_block in mapping.items()]\n-\n-    def _free_block_table(self, block_table: BlockTable) -> None:\n-        # when using a sliding window, each seq will only use up\n-        # to `self.block_sliding_window` blocks. When freeing\n-        # the block table, we must make sure to not free blocks more\n-        # than once. If no sliding window is used, there is no block\n-        # reuse in the block table, so we must free all blocks.\n-        blocks_to_free = (block_table[-self.block_sliding_window:]\n-                          if self.block_sliding_window is not None else\n-                          block_table)\n-        for block in set(blocks_to_free):\n-            if block.device == Device.GPU:\n-                self.gpu_allocator.free(block)\n-            else:\n-                self.cpu_allocator.free(block)\n-\n-    def free(self, seq: Sequence) -> None:\n-        if seq.seq_id not in self.block_tables:\n-            # Already freed or haven't been scheduled yet.\n-            return\n-        block_table = self.block_tables[seq.seq_id]\n-        self._free_block_table(block_table)\n-        del self.block_tables[seq.seq_id]\n-\n-    def free_cross(self, seq_group: SequenceGroup) -> None:\n-        if seq_group.request_id not in self.cross_block_tables:\n-            # Already freed or hasn't ben scheduled yet.\n-            return\n-        block_table = self.cross_block_tables[seq_group.request_id]\n-        self._free_block_table(block_table)\n-        del self.cross_block_tables[seq_group.request_id]\n-\n-    def reset(self) -> None:\n-        # Free decoder block tables\n-        for block_table in self.block_tables.values():\n-            self._free_block_table(block_table)\n-        self.block_tables.clear()\n-        # Free cross-attention block tables\n-        for block_table in self.cross_block_tables.values():\n-            self._free_block_table(block_table)\n-        self.cross_block_tables.clear()\n-\n-    def get_block_table(self, seq: Sequence) -> List[int]:\n-        return self.block_tables[seq.seq_id].ids()\n-\n-    def get_cross_block_table(self, seq_group: SequenceGroup) -> List[int]:\n-        block_table = self.cross_block_tables[seq_group.request_id]\n-        return [block.block_number for block in block_table]\n-\n-    def get_num_free_gpu_blocks(self) -> int:\n-        return self.gpu_allocator.get_num_free_blocks()\n-\n-    def get_num_free_cpu_blocks(self) -> int:\n-        return self.cpu_allocator.get_num_free_blocks()\n-\n-    def access_all_blocks_in_seq(\n-        self,\n-        seq: Sequence,\n-        access_time: float,\n-    ) -> None:\n-        if self.enable_caching:\n-            # Update the last accessed time of all the blocks accessed\n-            # in this step.\n-            block_table = self.block_tables[seq.seq_id]\n-            for block in block_table:\n-                block.last_accessed = access_time\n-\n-    def compute_full_blocks_in_seq(self, seq: Sequence, token_chunk_size: int):\n-        if seq.seq_id not in self.block_tables:\n-            return\n-\n-        # When chunked prefill is enabled, the computed full blocks\n-        # should be calculated based on the number of computed tokens.\n-        max_computed_tokens = (seq.data.get_num_computed_tokens() +\n-                               token_chunk_size)\n-        computed_full_blocks = max_computed_tokens // self.block_size\n-\n-        block_table = self.block_tables[seq.seq_id]\n-        if computed_full_blocks == 0:\n-            return\n-        for i in reversed(range(computed_full_blocks)):\n-            if block_table[i].computed:\n-                break\n-            block_table[i].computed = True\n-\n-    def get_all_computed_blocks(self, seq: Sequence) -> List[int]:\n-        if seq.seq_id not in self.block_tables:\n-            return []\n-        block_table = self.block_tables[seq.seq_id]\n-        # NOTE We exclude the last block to avoid the case where the entire\n-        # prompt is cached. This would cause erroneous behavior in model\n-        # runner.\n-        return [\n-            b.block_number\n-            for b in takewhile(lambda b: b.computed, block_table[:-1])\n-        ]\n-\n-    def get_common_computed_block_ids(\n-            self, seqs: List[Sequence]) -> GenericSequence[int]:\n-        \"\"\"Return the block ids that are common for a given sequence group.\n-\n-        Used in prefill (can skip prefill of some blocks).\n-        \"\"\"\n-        # Can return non-empty result only with prefix caching enabled.\n-        if not self.enable_caching:\n-            return []\n-\n-        ids_list = [self.get_all_computed_blocks(seq) for seq in seqs]\n-        return commonprefix([ids for ids in ids_list if ids != []])\n-\n-    def mark_blocks_as_computed(self, seq_group: SequenceGroup,\n-                                token_chunk_size: int):\n-        if self.enable_caching:\n-            for seq in seq_group.get_seqs():\n-                self.compute_full_blocks_in_seq(seq, token_chunk_size)\n-\n-    def get_prefix_cache_hit_rate(self, device: Device) -> float:\n-        if device == Device.GPU:\n-            return self.gpu_allocator.get_prefix_cache_hit_rate()\n-        if device == Device.CPU:\n-            return self.cpu_allocator.get_prefix_cache_hit_rate()\n-        raise ValueError(f\"Invalid device: {device}\")\ndiff --git a/vllm/core/interfaces.py b/vllm/core/interfaces.py\nindex 9e1d1b02f..9501a516b 100644\n--- a/vllm/core/interfaces.py\n+++ b/vllm/core/interfaces.py\n@@ -28,13 +28,9 @@ class BlockSpaceManager(ABC):\n     def get_block_space_manager_class(version: str):\n         version = version.lower()\n \n-        if version == \"v1\":\n-            from vllm.core.block_manager_v1 import BlockSpaceManagerV1\n-            return BlockSpaceManagerV1\n-\n-        if version == \"v2\":\n-            from vllm.core.block_manager_v2 import BlockSpaceManagerV2\n-            return BlockSpaceManagerV2\n+        if version == \"selfattn\":\n+            from vllm.core.block_manager import SelfAttnBlockSpaceManager\n+            return SelfAttnBlockSpaceManager\n \n         if version == \"placeholder\":\n             from vllm.core.placeholder_block_space_manager import (\ndiff --git a/vllm/core/scheduler.py b/vllm/core/scheduler.py\nindex e7eaaf122..f0c8e6bab 100644\n--- a/vllm/core/scheduler.py\n+++ b/vllm/core/scheduler.py\n@@ -312,9 +312,7 @@ class Scheduler:\n         # LoRAs. This should be improved in the future.\n         self.lora_config = lora_config\n \n-        version = \"v1\"\n-        if self.scheduler_config.use_v2_block_manager:\n-            version = \"v2\"\n+        version = \"selfattn\"\n         if (self.scheduler_config.embedding_mode\n                 or self.cache_config.is_attention_free):\n             version = \"placeholder\"\ndiff --git a/vllm/engine/arg_utils.py b/vllm/engine/arg_utils.py\nindex 1ce9e6200..41963dcb1 100644\n--- a/vllm/engine/arg_utils.py\n+++ b/vllm/engine/arg_utils.py\n@@ -373,12 +373,13 @@ class EngineArgs:\n                             action='store_true',\n                             help='Disables sliding window, '\n                             'capping to sliding window size')\n-        parser.add_argument(\n-            '--use-v2-block-manager',\n-            default=EngineArgs.use_v2_block_manager,\n-            action='store_true',\n-            help='Use BlockSpaceMangerV2. By default this is set to True. '\n-            'Set to False to use BlockSpaceManagerV1')\n+        parser.add_argument('--use-v2-block-manager',\n+                            action='store_true',\n+                            help='[DEPRECATED] block manager v1 has been '\n+                            'removed and SelfAttnBlockSpaceManager (i.e. '\n+                            'block manager v2) is now the default. '\n+                            'Setting this flag to True or False'\n+                            ' has no effect on vLLM behavior.')\n         parser.add_argument(\n             '--num-lookahead-slots',\n             type=int,\n@@ -969,12 +970,6 @@ class EngineArgs:\n                 \"in low performance due to small KV cache space. Consider \"\n                 \"setting --max-model-len to a smaller value.\", max_model_len)\n \n-        if self.num_scheduler_steps > 1 and not self.use_v2_block_manager:\n-            self.use_v2_block_manager = True\n-            logger.warning(\n-                \"Enabled BlockSpaceManagerV2 because it is \"\n-                \"required for multi-step (--num-scheduler-steps > 1)\")\n-\n         speculative_config = SpeculativeConfig.maybe_create_spec_config(\n             target_model_config=model_config,\n             target_parallel_config=parallel_config,\n@@ -990,7 +985,6 @@ class EngineArgs:\n             speculative_disable_by_batch_size,\n             speculative_max_model_len=self.speculative_max_model_len,\n             enable_chunked_prefill=self.enable_chunked_prefill,\n-            use_v2_block_manager=self.use_v2_block_manager,\n             disable_log_stats=self.disable_log_stats,\n             ngram_prompt_lookup_max=self.ngram_prompt_lookup_max,\n             ngram_prompt_lookup_min=self.ngram_prompt_lookup_min,\n@@ -1021,11 +1015,20 @@ class EngineArgs:\n             if speculative_config is None \\\n             else speculative_config.num_lookahead_slots\n \n+        if not self.use_v2_block_manager:\n+            logger.warning(\n+                \"[DEPRECATED] Block manager v1 has been removed, \"\n+                \"and setting --use-v2-block-manager to True or False has \"\n+                \"no effect on vLLM behavior. Please remove \"\n+                \"--use-v2-block-manager in your engine argument. \"\n+                \"If your use case is not supported by \"\n+                \"SelfAttnBlockSpaceManager (i.e. block manager v2),\"\n+                \" please file an issue with detailed information.\")\n+\n         scheduler_config = SchedulerConfig(\n             max_num_batched_tokens=self.max_num_batched_tokens,\n             max_num_seqs=self.max_num_seqs,\n             max_model_len=model_config.max_model_len,\n-            use_v2_block_manager=self.use_v2_block_manager,\n             num_lookahead_slots=num_lookahead_slots,\n             delay_factor=self.scheduler_delay_factor,\n             enable_chunked_prefill=self.enable_chunked_prefill,\n@@ -1081,13 +1084,6 @@ class EngineArgs:\n             or \"all\" in detailed_trace_modules,\n         )\n \n-        if (model_config.get_sliding_window() is not None\n-                and scheduler_config.chunked_prefill_enabled\n-                and not scheduler_config.use_v2_block_manager):\n-            raise ValueError(\n-                \"Chunked prefill is not supported with sliding window. \"\n-                \"Set --disable-sliding-window to disable sliding window.\")\n-\n         return EngineConfig(\n             model_config=model_config,\n             cache_config=cache_config,\ndiff --git a/vllm/engine/llm_engine.py b/vllm/engine/llm_engine.py\nindex a570d096d..61c21887e 100644\n--- a/vllm/engine/llm_engine.py\n+++ b/vllm/engine/llm_engine.py\n@@ -247,7 +247,7 @@ class LLMEngine:\n             \"enforce_eager=%s, kv_cache_dtype=%s, \"\n             \"quantization_param_path=%s, device_config=%s, \"\n             \"decoding_config=%r, observability_config=%r, \"\n-            \"seed=%d, served_model_name=%s, use_v2_block_manager=%s, \"\n+            \"seed=%d, served_model_name=%s, \"\n             \"num_scheduler_steps=%d, chunked_prefill_enabled=%s \"\n             \"multi_step_stream_outputs=%s, enable_prefix_caching=%s, \"\n             \"use_async_output_proc=%s, use_cached_outputs=%s, \"\n@@ -280,7 +280,6 @@ class LLMEngine:\n             observability_config,\n             model_config.seed,\n             model_config.served_model_name,\n-            scheduler_config.use_v2_block_manager,\n             scheduler_config.num_scheduler_steps,\n             scheduler_config.chunked_prefill_enabled,\n             scheduler_config.multi_step_stream_outputs,\ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex 45a999961..2d283fae2 100644\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -64,7 +64,6 @@ if TYPE_CHECKING:\n     VLLM_USE_TRITON_AWQ: bool = False\n     VLLM_ALLOW_RUNTIME_LORA_UPDATING: bool = False\n     VLLM_SKIP_P2P_CHECK: bool = False\n-    VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1: bool = False\n     VLLM_TORCH_COMPILE_LEVEL: int = 0\n     VLLM_DISABLED_KERNELS: List[str] = []\n \n@@ -427,11 +426,6 @@ environment_variables: Dict[str, Callable[[], Any]] = {\n     \"VLLM_SKIP_P2P_CHECK\":\n     lambda: os.getenv(\"VLLM_SKIP_P2P_CHECK\", \"0\") == \"1\",\n \n-    # If set, allowing the use of deprecated block manager V1\n-    \"VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1\":\n-    lambda: os.environ.get(\"VLLM_ALLOW_DEPRECATED_BLOCK_MANAGER_V1\", \"0\"\n-                           ) == \"1\",\n-\n     # List of quantization kernels that should be disabled, used for testing\n     # and performance comparisons. Currently only affects MPLinearKernel\n     # selection\ndiff --git a/vllm/worker/model_runner.py b/vllm/worker/model_runner.py\nindex 36753b858..a82956985 100644\n--- a/vllm/worker/model_runner.py\n+++ b/vllm/worker/model_runner.py\n@@ -574,17 +574,12 @@ class ModelInputForGPUBuilder(ModelRunnerInputBuilderBase[ModelInputForGPU]):\n             # paged attn. We can remove it if we make paged attn kernel\n             # to properly handle slinding window attn.\n             curr_sliding_window_block = self.sliding_window_blocks\n-            if self.scheduler_config.use_v2_block_manager:\n-                # number of elements in last block\n-                suff_len = inter_data.seq_lens[seq_idx] % self.block_size\n-                sliding_seq_len = min(\n-                    inter_data.seq_lens[seq_idx],\n-                    self.block_aligned_sliding_window + suff_len)\n-                if suff_len > 0:\n-                    curr_sliding_window_block += 1\n-            else:\n-                sliding_seq_len = min(inter_data.seq_lens[seq_idx],\n-                                      self.sliding_window)\n+            # number of elements in last block\n+            suff_len = inter_data.seq_lens[seq_idx] % self.block_size\n+            sliding_seq_len = min(inter_data.seq_lens[seq_idx],\n+                                  self.block_aligned_sliding_window + suff_len)\n+            if suff_len > 0:\n+                curr_sliding_window_block += 1\n \n         inter_data.curr_sliding_window_blocks[\n             seq_idx] = curr_sliding_window_block", "apis": ["vllm.engine.arg_utils.EngineArgs", "vllm.core.block_manager.SelfAttnBlockSpaceManager"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block_manager.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit removes flags and code paths associated with the deprecated block manager v1 and makes block manager v2 the default. The v2 block manager is described in the message as having \"much higher performance on prefix caching,\" implying a direct performance optimization improvement. Although many of the changes update test and benchmark files (as well as documentation and examples), they also affect non-test source code (benchmarks, core tests, docs) and simplify code paths to exclusively use the optimized block manager. This change is aimed at optimizing the performance (specifically for prefix caching) of the system on the CPU, not just a simple refactoring or bug fix. Therefore, the commit satisfies the conditions for being performance/optimization related.", "llm_api_reason": "This commit removes the legacy flag and configuration for enabling the v1 block manager and cleans up all invocations that depended on the â€œuse_v2_block_managerâ€ parameter. In essence, the codebase now defaults to using the newer block manager implementation (v2), specifically via the SelfAttnBlockSpaceManager, and the EngineArgs configuration no longer accepts or passes the deprecated flag. These changes affect test pipelines, benchmark scripts, and test cases that used to toggle between block manager versions."}
{"commit_hash": "83450458339b07765b0e72a822e5fe93eeaf5258", "pr_url": "https://github.com/vllm-project/vllm/pull/9333", "pr_date": "2024-10-16", "timeline_text": "Copy link Collaborator LiuXiaoxuanPKU commented Oct 14, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . After benchmarking the performance of ngram in vllm, it seems that the proposal time is longer than expected. The main reason is that there are (1) CPU <-> GPU communication when building the ngram lookup table. (2) Building the ngram contains many small kernels (duration < 5 microseconds) as show below: Zoom in the propose time: The PR tries to (1) perform lookup operation on CPU. (2) trigger CPU <-> GPU communication only when there is a match in lookup. Some performance numbers on a single H100: input_len: 550, output_len: 150 I changed the prompt to try different system efficiency (which might include the number of CPU <-> GPU sync). System efficiency propose time before this PR propose time after this PR end2end latency before this PR end2end latency after this PR 0.31 4.4ms 2.2ms 6.4s 5.6s 0.63 3.3ms 1.5ms 3.8s 3.2s 0.80 2.6 ms 1.5ms 3.0s 2.6s input_len: 2048, output_len: 150 System efficiency propose time before this PR propose time after this PR end2end latency before this PR end2end latency after this PR 0.30 6.00ms 4.54ms 9.83s 9.25s 0.63 2.90ms 2.70ms 5.84s 5.45s Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 3 comaniac, trianxy, and exceedzhang reacted with thumbs up emoji ðŸš€ 2 mgoin and trianxy reacted with rocket emoji All reactions ðŸ‘ 3 reactions ðŸš€ 2 reactions LiuXiaoxuanPKU added 2 commits October 13, 2024 22:45 lookup on cpu 7d631fb remove comments cc8e7a6 Copy link github-actions bot commented Oct 14, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . format 083897a comaniac approved these changes Oct 14, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator comaniac commented Oct 14, 2024 btw does this approach still have speedup if the prompt length is much longer? I'm just thinking about the trade off between CPU-GPU sync overhead and (maybe) slower CPU computation. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author LiuXiaoxuanPKU commented Oct 14, 2024 btw does this approach still have speedup if the prompt length is much longer? I'm just thinking about the trade off between CPU-GPU sync overhead and (maybe) slower CPU computation. Yeah will do more benchmarks here All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin approved these changes Oct 14, 2024 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think this is worth considering just for the aspect of simplicity. It could even make sense to write a CPU kernel in C++ instead of trying to do it on GPU Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Oct 14, 2024 Copy link Collaborator Author LiuXiaoxuanPKU commented Oct 16, 2024 Will change the PR so that we can change the device based on the sequence length. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . switch device based on seq_len 44ae31d Hide details View details mgoin merged commit 8345045 into vllm-project : main Oct 16, 2024 53 checks passed Uh oh! There was an error while loading. Please reload this page . Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Performance][Spec Decode] Optimize ngram lookup performance ( vllm-prâ€¦ â€¦ 86678fd â€¦oject#9333 )\n\nSigned-off-by: Alvant <alvasian@yandex.ru> garg-amit pushed a commit\n        to garg-amit/vllm\n      that referenced\n      this pull request Oct 28, 2024 [Performance][Spec Decode] Optimize ngram lookup performance ( vllm-prâ€¦ â€¦ 10d88b1 â€¦oject#9333 )\n\nSigned-off-by: Amit Garg <mitgarg17495@gmail.com> FerdinandZhong pushed a commit\n        to FerdinandZhong/vllm\n      that referenced\n      this pull request Oct 29, 2024 [Performance][Spec Decode] Optimize ngram lookup performance ( vllm-prâ€¦ â€¦ b55f889 â€¦oject#9333 )\n\nSigned-off-by: qishuai <ferdinandzhong@gmail.com> sumitd2 pushed a commit\n        to sumitd2/vllm\n      that referenced\n      this pull request Nov 14, 2024 [Performance][Spec Decode] Optimize ngram lookup performance ( vllm-prâ€¦ â€¦ 1e9f47e â€¦oject#9333 )\n\nSigned-off-by: Sumit Dubey <sumit.dubey2@ibm.com> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Performance][Spec Decode] Optimize ngram lookup performance ( vllm-prâ€¦ â€¦ 2a3ec7b â€¦oject#9333 )\n\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:54", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: latency, latency, latency | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:47:54", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Performance][Spec Decode] Optimize ngram lookup performance (#9333)", "commit_message": "[Performance][Spec Decode] Optimize ngram lookup performance (#9333)", "commit_date": "2024-10-16T13:37:45-06:00", "files_changed": ["vllm/spec_decode/ngram_worker.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 17, "num_non_test_edited_lines": 17, "commit_year": 2024}, "diff_text": "diff --git a/vllm/spec_decode/ngram_worker.py b/vllm/spec_decode/ngram_worker.py\nindex 36e5e1774..a777e5c3f 100644\n--- a/vllm/spec_decode/ngram_worker.py\n+++ b/vllm/spec_decode/ngram_worker.py\n@@ -67,9 +67,16 @@ class NGramWorker(NonLLMProposerWorkerBase):\n                 execute_model_req.seq_group_metadata_list):\n             seq_data = next(iter(seq_group_metadata.seq_data.values()))\n \n+            seq_len = seq_data.get_len()\n+            # When seq_len is less than 3072 (3K), we use CPU to perform\n+            # the ngram match. Otherwise, we use the device specified in\n+            # the model config (normally GPU). 3072 is a rough threshold\n+            # based on profiling on H100, and it can be adjusted based\n+            # on the actual performance on different hardware.\n+            cur_device = \"cpu\" if seq_len < 3072 else self.device\n             input_ids = torch.as_tensor(seq_data.get_token_ids(),\n                                         dtype=torch.long,\n-                                        device=self.device)\n+                                        device=cur_device)\n             input_length = seq_data.get_len()\n \n             for ngram_size in range(\n@@ -91,17 +98,15 @@ class NGramWorker(NonLLMProposerWorkerBase):\n                 # first_match includes \"values\" (bool), indicating whether\n                 # the match is found, and \"indices\", indicating the index\n                 # of the first match.\n-                # Note that \"first_match.values.item()\" triggers GPU-CPU\n-                # sync so it is a bit inefficient, but we have not found\n-                # a better way to do this.\n                 first_match = matches.max(dim=-1)\n                 if first_match.values.item():\n                     proposal_start_idx = first_match.indices.add_(ngram_size)\n                     spec_indices = (\n                         proposal_start_idx).repeat(sample_len) + torch.arange(\n-                            sample_len, device=self.device)\n+                            sample_len, device=cur_device)\n                     spec_indices.clamp_(max=input_ids.shape[-1] - 1)\n-                    res = input_ids.gather(dim=-1, index=spec_indices)\n+                    res = input_ids.gather(dim=-1,\n+                                           index=spec_indices).to(self.device)\n                     token_id_list.append(res)\n                     token_prob_list.append(\n                         torch.nn.functional.one_hot(", "apis": ["None"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/ngram_proposer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a core non-test file (ngram_worker.py) altering how n-gram lookups are handled by conditionally using the CPU over the GPU for sequences shorter than 3072 tokens. It changes the device assignment logic to potentially mitigate costly GPU-CPU synchronization, which is a clear performance optimization. The changes are non-trivial and affect the underlying implementation of a primary API used for inference, making it testable on CPU without dependency on specialized GPUs. Thus, based on the performance optimization criteria, this commit qualifies as performance related.", "llm_api_reason": "This commit optimizes the internal nâ€‘gram matching in the speculative decoding worker by dynamically picking the device (CPU for short sequences and GPU otherwise) and ensuring that the gathered results are later transferred to the expected device. Although it improves performance for speculative decoding, it does not change any public or highâ€‘level API (e.g. vllm.LLM.generate or similar) exposed by vLLM."}
{"commit_hash": "6d646d08a2e0e73e83e313a5ae470c1f9e4f200e", "pr_url": "https://github.com/vllm-project/vllm/pull/8050", "pr_date": "2024-09-03", "timeline_text": "Copy link Collaborator alexm-redhat commented Aug 31, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This PR optimizes the async + multi-step further by implementing a \"fully\" async behavior between the postprocessor and the multi-step execution. Before that, the async was done only for the previous decode steps of the multi-step, where in this PR, the async is done on all previous steps of decode, including the last step of decode (that generates results), and also on the previous prompt executions. For Llama3 8B on H100 with ShareGPT dataset, performance improves by about ~28% vs current main with multi-step + async.  Here are the new results for this benchmark, the TPOT of multi-step is 44.48ms and for multi-step + async is 32.38ms, which is 37% improvement (before that @KuntaiDu reported improvement < 10%) Multi-step, no-async, Llama3 8B on H100 with ShareGPT ============ Serving Benchmark Result ============\nSuccessful requests:                     500       \nBenchmark duration (s):                  18.82     \nTotal input tokens:                      100895    \nTotal generated tokens:                  100377    \nRequest throughput (req/s):              26.57     \nInput token throughput (tok/s):          5361.68   \nOutput token throughput (tok/s):         5334.15   \n---------------Time to First Token----------------\nMean TTFT (ms):                          2991.94   \nMedian TTFT (ms):                        2314.58   \nP99 TTFT (ms):                           8385.04   \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          44.48     \nMedian TPOT (ms):                        31.98     \nP99 TPOT (ms):                           199.97    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           272.29    \nMedian ITL (ms):                         244.50    \nP99 ITL (ms):                            1175.28   \n================================================== Multi-step + async, Llama3 8B on H100 with ShareGPT ============ Serving Benchmark Result ============\nSuccessful requests:                     500       \nBenchmark duration (s):                  16.04     \nTotal input tokens:                      100895    \nTotal generated tokens:                  100403    \nRequest throughput (req/s):              31.18     \nInput token throughput (tok/s):          6291.68   \nOutput token throughput (tok/s):         6261.00   \n---------------Time to First Token----------------\nMean TTFT (ms):                          2896.11   \nMedian TTFT (ms):                        2157.79   \nP99 TTFT (ms):                           7457.77   \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          32.38     \nMedian TPOT (ms):                        24.64     \nP99 TPOT (ms):                           149.36    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           217.58    \nMedian ITL (ms):                         201.78    \nP99 ITL (ms):                            999.50    \n================================================== TODO Cleanup the PR Verify all tests pass Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 4 SolitaryThinker, Juelianqvq, yudian0504, and WoosukKwon reacted with rocket emoji All reactions ðŸš€ 4 reactions Copy link github-actions bot commented Aug 31, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author alexm-redhat commented Aug 31, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @robertgshaw2-neuralmagic @WoosukKwon @megha95 @KuntaiDu @comaniac @SolitaryThinker @njhill All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author alexm-redhat commented Aug 31, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . The PR is still in rough shape, since I just made it finally work after fixing some complicated race conditions. Will work on cleaning it up tomorrow. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator robertgshaw2-redhat commented Aug 31, 2024 nice job alex All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author alexm-redhat commented Aug 31, 2024 /ready All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 31, 2024 Copy link Collaborator Author alexm-redhat commented Aug 31, 2024 The PR is ready for review All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . alexm-redhat added 2 commits August 31, 2024 20:18 Optimize async + multi-step by making async fully async with respect â€¦ â€¦ dafa498 â€¦to all operations format ca993c7 alexm-redhat force-pushed the async_multi_step_opt branch\n    from e269cc7 to ca993c7 Compare August 31, 2024 20:41 Copy link Collaborator Author alexm-redhat commented Aug 31, 2024 rebased over Andy's logprobs changes, all works All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cleanup f054d70 alexm-redhat changed the title [Performance][Core] Optimize Async + Multi-step [Core] Optimize Async + Multi-step Sep 1, 2024 alexm-redhat added 3 commits September 1, 2024 01:38 fix tests 98a55d7 ping 4474b12 Improve asyncio queues append of request outputs 904006a Copy link Collaborator KuntaiDu commented Sep 2, 2024 Nice job Alex! I am rerunning the benchmark using ur PR and thank you for the great work!!! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac approved these changes Sep 3, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM. Only nits Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/engine/llm_engine.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/llm_engine.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/llm_engine.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/llm_engine.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/llm_engine.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/llm_engine.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/async_llm_engine.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/engine/output_processor/multi_step.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Cody's review comments 3a8726a comaniac enabled auto-merge (squash) September 3, 2024 16:34 More Cody's comments 997c525 auto-merge was automatically disabled September 3, 2024 16:55 Head branch was pushed to by a user without write access comaniac enabled auto-merge (squash) September 3, 2024 17:20 SolitaryThinker approved these changes Sep 3, 2024 View reviewed changes megha95 reviewed Sep 3, 2024 View reviewed changes tests/multi_step/test_correctness_async_llm.py @@ -103,13 +103,13 @@ async def test_multi_step( model, server_args + distributed_args, num_logprobs, max_wait_seconds=3 * 240) Copy link Contributor megha95 Sep 3, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment why was this change needed? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Sep 3, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It was increased originally for multi-step tests, but I think it was still sensitive, so I had one instance when I had a timeout. Increasing more did make the test stable. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details comaniac merged commit 6d646d0 into vllm-project : main Sep 3, 2024 39 checks passed Uh oh! There was an error while loading. Please reload this page . Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Core] Optimize Async + Multi-step ( vllm-project#8050 ) â€¦ 4284212 Signed-off-by: Alvant <alvasian@yandex.ru> WhoisZihan reviewed Nov 1, 2024 View reviewed changes vllm/worker/multi_step_model_runner.py @@ -237,14 +265,22 @@ def _async_process_outputs(self, model_input: StatefulModelInput, output_proc_callback: Callable): # Proceed with pythonization and output_proc in order. # Stop on the first one that fails to pythonize output_proc_callback() Copy link WhoisZihan Nov 1, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Why do we need this extra output callback before we call it for each cached output below? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Core] Optimize Async + Multi-step ( vllm-project#8050 ) â€¦ 5f4e3ee Signed-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:47:57", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, TTFT | SERVING: Serving, Serving | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:47:57", "models": ["meta-llama/Llama-3-8B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3-8B-Instruct --tasks hellaswag --limit 1000"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3-8B-Instruct --dataset ShareGPT_V3_unfiltered_cleaned_split.json", "commit_subject": "[Core] Optimize Async + Multi-step (#8050)", "commit_message": "[Core] Optimize Async + Multi-step (#8050)", "commit_date": "2024-09-03T18:50:29Z", "files_changed": ["tests/multi_step/test_correctness_async_llm.py", "vllm/engine/async_llm_engine.py", "vllm/engine/llm_engine.py", "vllm/engine/output_processor/multi_step.py", "vllm/sequence.py", "vllm/worker/model_runner.py", "vllm/worker/multi_step_model_runner.py", "vllm/worker/multi_step_worker.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 7, "only_test_files": 0, "only_non_test_files": 0, "num_files": 8, "num_hunks": 43, "num_edited_lines": 574, "num_non_test_edited_lines": 570, "commit_year": 2024}, "diff_text": "diff --git a/tests/multi_step/test_correctness_async_llm.py b/tests/multi_step/test_correctness_async_llm.py\nindex d054ca341..0cbe8371e 100644\n--- a/tests/multi_step/test_correctness_async_llm.py\n+++ b/tests/multi_step/test_correctness_async_llm.py\n@@ -103,13 +103,13 @@ async def test_multi_step(\n         model,\n         server_args + distributed_args,\n         num_logprobs,\n-        max_wait_seconds=3 * 240)\n+        max_wait_seconds=5 * 240)\n     test_completions = await completions_with_server_args(\n         prompts,\n         model,\n         ms_server_args + distributed_args,\n         num_logprobs,\n-        max_wait_seconds=3 * 240)\n+        max_wait_seconds=5 * 240)\n \n     # Assert multi-step scheduling produces identical tokens\n     # to single-step scheduling.\ndiff --git a/vllm/engine/async_llm_engine.py b/vllm/engine/async_llm_engine.py\nindex 159281dab..7fe8053ff 100644\n--- a/vllm/engine/async_llm_engine.py\n+++ b/vllm/engine/async_llm_engine.py\n@@ -280,40 +280,27 @@ class _AsyncLLMEngine(LLMEngine):\n         scheduler_outputs = cached_outputs.scheduler_outputs\n         allow_async_output_proc = cached_outputs.allow_async_output_proc\n \n-        # Detect async + multi-step\n-        use_async_and_multi_step = (self.scheduler_config.is_multi_step\n-                                    and allow_async_output_proc)\n-\n         ctx = self.scheduler_contexts[virtual_engine]\n \n+        # Clear outputs for each new scheduler iteration\n+        ctx.request_outputs.clear()\n+\n         # skip the scheduler if there are any remaining steps in the seq groups.\n         # This ensures that the scheduler is only called again when the current\n         # batch has completed.\n         if not self._has_remaining_steps(seq_group_metadata_list):\n \n-            # Clear outputs on scheduler iteration start\n-            ctx.request_outputs.clear()\n-\n             # Schedule iteration\n             (seq_group_metadata_list, scheduler_outputs,\n              allow_async_output_proc\n              ) = self.scheduler[virtual_engine].schedule()\n \n-            # Detect async + multi-step\n-            use_async_and_multi_step = (self.scheduler_config.is_multi_step\n-                                        and allow_async_output_proc)\n+            ctx.seq_group_metadata_list = seq_group_metadata_list\n+            ctx.scheduler_outputs = scheduler_outputs\n \n             # Maybe switch from async mode to sync mode\n             if not allow_async_output_proc and len(ctx.output_queue) > 0:\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=True)\n-\n-            # For async + multi-step, init the queue\n-            if use_async_and_multi_step:\n-                assert len(ctx.output_queue) == 0\n-                assert seq_group_metadata_list is not None\n-                ctx.output_queue.append(\n-                    (None, seq_group_metadata_list, scheduler_outputs))\n+                self._process_model_outputs(ctx=ctx)\n \n             if (self.scheduler_config.is_multi_step\n                     and scheduler_outputs.num_lookahead_slots > 0):\n@@ -351,26 +338,20 @@ class _AsyncLLMEngine(LLMEngine):\n                 last_sampled_token_ids=last_sampled_token_ids)\n \n             if allow_async_output_proc:\n-                async_callback = self.async_callback_multi_step[\n-                    virtual_engine] if use_async_and_multi_step \\\n-                    else self.async_callback[virtual_engine]\n-\n-                execute_model_req.async_callback = async_callback\n-                execute_model_req.use_async_and_multi_step = \\\n-                    use_async_and_multi_step\n+                execute_model_req.async_callback = self.async_callbacks[\n+                    virtual_engine]\n \n             # Execute the model.\n             output = await self.model_executor.execute_model_async(\n                 execute_model_req)\n+\n             # we need to do this here so that last step's sampled_token_ids can\n             # be passed to the next iteration for PP.\n             if self.scheduler_config.is_multi_step:\n                 self._update_cached_scheduler_output(virtual_engine, output)\n         else:\n-            if not use_async_and_multi_step and len(ctx.output_queue) > 0:\n-                assert not self.scheduler_config.is_multi_step\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=True)\n+            if len(ctx.output_queue) > 0:\n+                self._process_model_outputs(ctx=ctx)\n             output = []\n \n         # Finish the current step for all the sequence groups.\n@@ -384,24 +365,22 @@ class _AsyncLLMEngine(LLMEngine):\n                 self.cached_scheduler_outputs[\n                     virtual_engine] = SchedulerOutputState()\n \n-            if use_async_and_multi_step:\n-                # For async + multi-step, clear the queue\n-                ctx.output_queue.clear()\n-            else:\n-                ctx.output_queue.append(\n-                    (output, seq_group_metadata_list, scheduler_outputs))\n+            is_async = allow_async_output_proc\n+            is_last_step = True\n+            ctx.output_queue.append(\n+                (output, seq_group_metadata_list, scheduler_outputs, is_async,\n+                 is_last_step))\n \n-                if output and allow_async_output_proc:\n-                    assert len(\n-                        output\n-                    ) == 1, \"Multi step decoding does not work with async output processing.\"  # noqa: E501\n-                    self._advance_to_next_step(\n-                        output[0], seq_group_metadata_list,\n-                        scheduler_outputs.scheduled_seq_groups)\n+            if output and allow_async_output_proc:\n+                assert len(\n+                    output\n+                ) == 1, \"Async postprocessor expects only a single output set\"\n+                self._advance_to_next_step(\n+                    output[0], seq_group_metadata_list,\n+                    scheduler_outputs.scheduled_seq_groups)\n \n             if not allow_async_output_proc:\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=False)\n+                self._process_model_outputs(ctx=ctx)\n \n                 # Log stats.\n                 self.do_log_stats(scheduler_outputs, output)\n@@ -411,17 +390,12 @@ class _AsyncLLMEngine(LLMEngine):\n \n         else:\n             # Multi-step case\n-            if use_async_and_multi_step:\n-                return []\n-            else:\n-                ctx.request_outputs = []\n+            return ctx.request_outputs\n \n         if not self.has_unfinished_requests():\n             # Drain async postprocessor (if exists)\n             if len(ctx.output_queue) > 0:\n-                assert not self.scheduler_config.is_multi_step\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=True)\n+                self._process_model_outputs(ctx=ctx)\n             assert len(ctx.output_queue) == 0\n \n         return ctx.request_outputs\n@@ -640,6 +614,17 @@ class AsyncLLMEngine:\n         self.log_requests = log_requests\n         self.engine = self._init_engine(*args, **kwargs)\n \n+        # This ensures quick processing of request outputs\n+        # so the append to asyncio queues is not delayed,\n+        # especially for multi-step.\n+        #\n+        # TODO: Currently, disabled for engine_use_ray, ask\n+        # Cody/Will/Woosuk about this case.\n+        self.use_process_request_outputs_callback = not self.engine_use_ray\n+        if self.use_process_request_outputs_callback:\n+            self.engine.process_request_outputs_callback = \\\n+                self.process_request_outputs\n+\n         if self.engine_use_ray:\n             print_warning_once(\n                 \"DEPRECATED. `--engine-use-ray` is deprecated and will \"\n@@ -883,13 +868,27 @@ class AsyncLLMEngine:\n             request_outputs = await self.engine.step_async(virtual_engine)\n \n         # Put the outputs into the corresponding streams.\n-        finished = True\n+        # If used as a callback, then already invoked inside\n+        # LLMEngine's _process_model_outputs\n+        if not self.use_process_request_outputs_callback:\n+            all_finished = self.process_request_outputs(request_outputs)\n+        else:\n+            # For callback case, we only need to detect when all\n+            # requests are finished\n+            all_finished = all(request_output.finished\n+                               for request_output in request_outputs)\n+\n+        return not all_finished\n+\n+    def process_request_outputs(self, request_outputs) -> bool:\n+        # Put the outputs into the corresponding streams.\n+        all_finished = True\n         for request_output in request_outputs:\n             self._request_tracker.process_request_output(\n                 request_output, verbose=self.log_requests)\n-            finished = finished and request_output.finished\n+            all_finished = all_finished and request_output.finished\n \n-        return not finished\n+        return all_finished\n \n     async def _engine_abort(self, request_ids: Iterable[str]):\n         if self.engine_use_ray:\ndiff --git a/vllm/engine/llm_engine.py b/vllm/engine/llm_engine.py\nindex 1eab83f3b..8c5ca81fb 100644\n--- a/vllm/engine/llm_engine.py\n+++ b/vllm/engine/llm_engine.py\n@@ -93,13 +93,14 @@ class SchedulerOutputState:\n @dataclass\n class SchedulerContext:\n     output_queue: Deque[Tuple[Optional[List[SamplerOutput]],\n-                              List[SequenceGroupMetadata],\n-                              SchedulerOutputs]] = field(\n-                                  default_factory=lambda: deque())\n-\n+                              List[SequenceGroupMetadata], SchedulerOutputs,\n+                              bool,\n+                              bool]] = field(default_factory=lambda: deque())\n     request_outputs: List[Union[RequestOutput,\n                                 EmbeddingRequestOutput]] = field(\n                                     default_factory=lambda: [])\n+    seq_group_metadata_list: Optional[List[SequenceGroupMetadata]] = None\n+    scheduler_outputs: Optional[SchedulerOutputs] = None\n \n \n class LLMEngine:\n@@ -357,6 +358,26 @@ class LLMEngine:\n             # different process.\n             self.tokenizer.ping()\n \n+        self.cached_scheduler_outputs = [\n+            SchedulerOutputState()\n+            for _ in range(self.parallel_config.pipeline_parallel_size)\n+        ]\n+\n+        self.scheduler_contexts = [\n+            SchedulerContext()\n+            for _ in range(self.parallel_config.pipeline_parallel_size)\n+        ]\n+\n+        self.async_callbacks = [\n+            functools.partial(self._process_model_outputs,\n+                              ctx=self.scheduler_contexts[v_id])\n+            for v_id in range(self.parallel_config.pipeline_parallel_size)\n+        ]\n+\n+        # Currently used by AsyncLLMEngine to ensure quick append\n+        # of request outputs to asyncio queues\n+        self.process_request_outputs_callback = None\n+\n         # Create the scheduler.\n         # NOTE: the cache_config here have been updated with the numbers of\n         # GPU and CPU blocks, which are profiled in the distributed executor.\n@@ -364,9 +385,7 @@ class LLMEngine:\n             Scheduler(\n                 scheduler_config, cache_config, lora_config,\n                 parallel_config.pipeline_parallel_size,\n-                functools.partial(self._process_model_outputs,\n-                                  virtual_engine=v_id,\n-                                  is_async=True)\n+                self.async_callbacks[v_id]\n                 if model_config.use_async_output_proc else None)\n             for v_id in range(parallel_config.pipeline_parallel_size)\n         ]\n@@ -417,30 +436,6 @@ class LLMEngine:\n                 ),\n             ))\n \n-        self.cached_scheduler_outputs = [\n-            SchedulerOutputState()\n-            for _ in range(self.parallel_config.pipeline_parallel_size)\n-        ]\n-\n-        self.scheduler_contexts = [\n-            SchedulerContext()\n-            for _ in range(self.parallel_config.pipeline_parallel_size)\n-        ]\n-\n-        self.async_callback = [\n-            functools.partial(self._process_model_outputs,\n-                              virtual_engine=v_id,\n-                              is_async=True)\n-            for v_id in range(self.parallel_config.pipeline_parallel_size)\n-        ]\n-\n-        self.async_callback_multi_step = [\n-            functools.partial(self._process_model_outputs,\n-                              virtual_engine=v_id,\n-                              is_async=False)\n-            for v_id in range(self.parallel_config.pipeline_parallel_size)\n-        ]\n-\n     def _initialize_kv_caches(self) -> None:\n         \"\"\"Initialize the KV cache in the worker(s).\n \n@@ -1249,11 +1244,7 @@ class LLMEngine:\n \n         return\n \n-    def _process_model_outputs(self,\n-                               virtual_engine: int,\n-                               is_async: bool,\n-                               sampler_output: Optional[SamplerOutput] = None,\n-                               is_last_output: bool = False) -> None:\n+    def _process_model_outputs(self, ctx: SchedulerContext) -> None:\n         \"\"\"Apply the model output to the sequences in the scheduled seq groups.\n \n         virtual_engine: The engine id to operate on\n@@ -1273,24 +1264,12 @@ class LLMEngine:\n         \"\"\"\n         now = time.time()\n \n-        is_multi_step = sampler_output is not None\n-\n-        ctx: SchedulerContext = self.scheduler_contexts[virtual_engine]\n-\n         if len(ctx.output_queue) == 0:\n             return None\n \n-        if is_multi_step:\n-            # Async + multi-step case\n-            (outputs, seq_group_metadata_list,\n-             scheduler_outputs) = ctx.output_queue[0]\n-            assert outputs is None\n-            outputs = [sampler_output]\n-        else:\n-            # Async standard case\n-            (outputs, seq_group_metadata_list,\n-             scheduler_outputs) = ctx.output_queue.popleft()\n-\n+        # Get pending async postprocessor\n+        (outputs, seq_group_metadata_list, scheduler_outputs, is_async,\n+         is_last_step) = ctx.output_queue.popleft()\n         assert outputs is not None\n \n         # Sanity check\n@@ -1306,6 +1285,7 @@ class LLMEngine:\n             outputs_by_sequence_group = outputs\n \n         finished_before: List[int] = []\n+        finished_now: List[int] = []\n         for i, seq_group_meta in enumerate(seq_group_metadata_list):\n             scheduled_seq_group = scheduler_outputs.scheduled_seq_groups[i]\n \n@@ -1343,26 +1323,44 @@ class LLMEngine:\n \n             if self.model_config.embedding_mode:\n                 self._process_sequence_group_outputs(seq_group, output)\n-                continue\n+            else:\n+                self.output_processor.process_prompt_logprob(seq_group, output)\n+                if seq_group_meta.do_sample:\n+                    self.output_processor.process_outputs(\n+                        seq_group, output, is_async)\n \n-            self.output_processor.process_prompt_logprob(seq_group, output)\n-            if seq_group_meta.do_sample:\n-                self.output_processor.process_outputs(seq_group, output,\n-                                                      is_async)\n+            if seq_group.is_finished():\n+                finished_now.append(i)\n \n-        # For async + multi-step, free finished seqs and create outputs\n-        # only on the final step.\n-        if is_multi_step and not is_last_output:\n-            return\n+        # Generate outputs for the requests that finished this iteration\n+        for i in finished_now:\n+            scheduled_seq_group = scheduler_outputs.scheduled_seq_groups[i]\n \n-        for scheduler in self.scheduler:\n-            scheduler.free_finished_seq_groups()\n+            seq_group = scheduled_seq_group.seq_group\n+            seq_group.maybe_set_first_token_time(now)\n+            request_output = RequestOutputFactory.create(seq_group)\n+            ctx.request_outputs.append(request_output)\n \n-        # Create the outputs.\n-        for i, _ in enumerate(seq_group_metadata_list):\n-            scheduled_seq_group = scheduler_outputs.scheduled_seq_groups[i]\n+        # Free currently finished requests\n+        if finished_now:\n+            for scheduler in self.scheduler:\n+                scheduler.free_finished_seq_groups()\n+\n+        # For multi-step, do not create outputs each iteration\n+        if not is_last_step:\n+            # Immediately process request outputs here (if callback is given)\n+            if (finished_now\n+                    and self.process_request_outputs_callback is not None):\n+                self.process_request_outputs_callback(ctx.request_outputs)\n+            return\n+\n+        # Create the outputs\n+        # Note: scheduled_seq_groups and seq_group_metadata_list\n+        # must match with the indices\n+        for i, scheduled_seq_group in enumerate(\n+                scheduler_outputs.scheduled_seq_groups):\n \n-            if not is_multi_step and i in finished_before:\n+            if i in finished_before or i in finished_now:\n                 continue  # Avoids double processing\n \n             seq_group = scheduled_seq_group.seq_group\n@@ -1376,11 +1374,15 @@ class LLMEngine:\n             request_output = RequestOutputFactory.create(seq_group)\n             ctx.request_outputs.append(request_output)\n \n-        # For async + multi-step, do stats only on the last output.\n-        # Otherwise, do stats if the execution is async\n-        do_stats = is_multi_step or is_async\n+        # Immediately process request outputs here (if callback is given)\n+        if (ctx.request_outputs\n+                and self.process_request_outputs_callback is not None):\n+            self.process_request_outputs_callback(ctx.request_outputs)\n \n-        if do_stats:\n+        # For async case, we need to record the stats here.\n+        # For non-async case, the stats are done in the\n+        # LLMEngine/AsyncLLMEngine directly\n+        if is_async:\n             # Log stats.\n             self.do_log_stats(scheduler_outputs, outputs, finished_before)\n \n@@ -1485,40 +1487,26 @@ class LLMEngine:\n         scheduler_outputs = cached_outputs.scheduler_outputs\n         allow_async_output_proc = cached_outputs.allow_async_output_proc\n \n-        # Detect async + multi-step\n-        use_async_and_multi_step = (self.scheduler_config.is_multi_step\n-                                    and allow_async_output_proc)\n-\n         ctx = self.scheduler_contexts[virtual_engine]\n \n+        # Clear outputs for each new scheduler iteration\n+        ctx.request_outputs.clear()\n+\n         # Skip the scheduler if there are any remaining steps in the seq groups.\n         # This ensures that the scheduler is only called again when the current\n         # batch has completed.\n         if not self._has_remaining_steps(seq_group_metadata_list):\n-\n-            # Clear outputs on scheduler iteration start\n-            ctx.request_outputs.clear()\n-\n             # Schedule iteration\n             (seq_group_metadata_list, scheduler_outputs,\n              allow_async_output_proc\n              ) = self.scheduler[virtual_engine].schedule()\n \n-            # Detect async + multi-step\n-            use_async_and_multi_step = (self.scheduler_config.is_multi_step\n-                                        and allow_async_output_proc)\n+            ctx.seq_group_metadata_list = seq_group_metadata_list\n+            ctx.scheduler_outputs = scheduler_outputs\n \n             # Maybe switch from async mode to sync mode\n             if not allow_async_output_proc and len(ctx.output_queue) > 0:\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=True)\n-\n-            # For async + multi-step, init the queue\n-            if use_async_and_multi_step:\n-                assert len(ctx.output_queue) == 0\n-                assert seq_group_metadata_list is not None\n-                ctx.output_queue.append(\n-                    (None, seq_group_metadata_list, scheduler_outputs))\n+                self._process_model_outputs(ctx=ctx)\n \n             if (self.scheduler_config.is_multi_step\n                     and scheduler_outputs.num_lookahead_slots > 0):\n@@ -1555,13 +1543,8 @@ class LLMEngine:\n                 last_sampled_token_ids=last_sampled_token_ids)\n \n             if allow_async_output_proc:\n-                async_callback = self.async_callback_multi_step[\n-                    virtual_engine] if use_async_and_multi_step \\\n-                    else self.async_callback[virtual_engine]\n-\n-                execute_model_req.async_callback = async_callback\n-                execute_model_req.use_async_and_multi_step = \\\n-                    use_async_and_multi_step\n+                execute_model_req.async_callback = self.async_callbacks[\n+                    virtual_engine]\n \n             output = self.model_executor.execute_model(\n                 execute_model_req=execute_model_req)\n@@ -1573,10 +1556,8 @@ class LLMEngine:\n         else:\n             # Nothing scheduled => If there is pending async postprocessor,\n             # then finish it here.\n-            if not use_async_and_multi_step and len(ctx.output_queue) > 0:\n-                assert not self.scheduler_config.is_multi_step\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=True)\n+            if len(ctx.output_queue) > 0:\n+                self._process_model_outputs(ctx=ctx)\n             # No outputs in this case\n             output = []\n \n@@ -1590,28 +1571,24 @@ class LLMEngine:\n             if self.scheduler_config.is_multi_step:\n                 self.cached_scheduler_outputs[0] = SchedulerOutputState()\n \n-            if use_async_and_multi_step:\n-                # For async + multi-step, clear the queue\n-                ctx.output_queue.clear()\n-            else:\n-                # Add results to the output_queue\n-                # (for async or non-async postprocessing)\n-                ctx.output_queue.append(\n-                    (output, seq_group_metadata_list, scheduler_outputs))\n+            # Add results to the output_queue\n+            is_async = allow_async_output_proc\n+            is_last_step = True\n+            ctx.output_queue.append(\n+                (output, seq_group_metadata_list, scheduler_outputs, is_async,\n+                 is_last_step))\n \n-                if output and allow_async_output_proc:\n-                    assert len(output) == 1, (\n-                        \"Multi step decoding does not work \"\n-                        \"with async output processing.\")\n+            if output and allow_async_output_proc:\n+                assert len(output) == 1, (\n+                    \"Async postprocessor expects only a single output set\")\n \n-                    self._advance_to_next_step(\n-                        output[0], seq_group_metadata_list,\n-                        scheduler_outputs.scheduled_seq_groups)\n+                self._advance_to_next_step(\n+                    output[0], seq_group_metadata_list,\n+                    scheduler_outputs.scheduled_seq_groups)\n \n             # Check if need to run the usual non-async path\n             if not allow_async_output_proc:\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=False)\n+                self._process_model_outputs(ctx=ctx)\n \n                 # Log stats.\n                 self.do_log_stats(scheduler_outputs, output)\n@@ -1620,17 +1597,12 @@ class LLMEngine:\n                 self.do_tracing(scheduler_outputs)\n         else:\n             # Multi-step case\n-            if use_async_and_multi_step:\n-                return []\n-            else:\n-                ctx.request_outputs = []\n+            return ctx.request_outputs\n \n         if not self.has_unfinished_requests():\n             # Drain async postprocessor (if exists)\n             if len(ctx.output_queue) > 0:\n-                assert not self.scheduler_config.is_multi_step\n-                self._process_model_outputs(virtual_engine=virtual_engine,\n-                                            is_async=True)\n+                self._process_model_outputs(ctx=ctx)\n             assert len(ctx.output_queue) == 0\n \n             # Stop the execute model loop in parallel workers until there are\ndiff --git a/vllm/engine/output_processor/multi_step.py b/vllm/engine/output_processor/multi_step.py\nindex e182cee8b..c73db765f 100644\n--- a/vllm/engine/output_processor/multi_step.py\n+++ b/vllm/engine/output_processor/multi_step.py\n@@ -85,9 +85,6 @@ class MultiStepOutputProcessor(SequenceGroupOutputProcessor):\n             no tokens need to be appended since it is already done\n             externally (before the next schedule() call)\n         \"\"\"\n-        # TODO: Add support for async if necessary\n-        assert not is_async\n-\n         # Sequences can be in RUNNING or FINISHED_ABORTED state\n         # once scheduled, as a sequence is moved to FINSIHED_ABORTED\n         # if a client disconnects from the api server.\n@@ -101,19 +98,41 @@ class MultiStepOutputProcessor(SequenceGroupOutputProcessor):\n             \"Beam search not supported in multi-step decoding.\")\n         seq = seqs[0]\n \n-        # Since there's only one sequence per sequence group, we can take the\n-        # first sample.\n-        samples = [output.samples[0] for output in outputs]\n-\n-        # -1 means the output token is not valid (eg. due to spec decode\n-        # rejecting tokens).\n-        valid_samples = [\n-            sample for sample in samples if sample.output_token != -1\n-        ]\n-        assert valid_samples\n-\n-        self._process_seq_outputs(seq, valid_samples,\n-                                  sequence_group.sampling_params)\n+        if is_async:\n+            # Async case: We process tokens one by one. Here, we know the token\n+            # was already appended, so we only need to do the rest of the\n+            # postprocessor: Detokenization + stopping logic\n+            self._process_decode_and_stop(seq, sequence_group.sampling_params)\n+        else:\n+            # Standard multi-step case\n+\n+            # Since there's only one sequence per sequence group,\n+            # we can take the first sample.\n+            samples = [output.samples[0] for output in outputs]\n+\n+            # -1 means the output token is not valid (eg. due to spec decode\n+            # rejecting tokens).\n+            valid_samples = [\n+                sample for sample in samples if sample.output_token != -1\n+            ]\n+            assert valid_samples\n+\n+            self._process_seq_outputs(seq, valid_samples,\n+                                      sequence_group.sampling_params)\n+\n+    def _process_decode_and_stop(self, seq: Sequence,\n+                                 sampling_params: SamplingParams) -> None:\n+        new_char_count = 0\n+        if sampling_params.detokenize:\n+            new_char_count = self.detokenizer.decode_sequence_inplace(\n+                seq, sampling_params)\n+\n+        # TODO(sang): Support lora.\n+        self.stop_checker.maybe_stop_sequence(\n+            seq,\n+            new_char_count=new_char_count,\n+            sampling_params=sampling_params,\n+        )\n \n     def _process_seq_outputs(self, seq: Sequence,\n                              valid_samples: List[SequenceOutput],\n@@ -151,16 +170,7 @@ class MultiStepOutputProcessor(SequenceGroupOutputProcessor):\n                 logprobs=output_logprob,\n             )\n \n-            new_char_count = 0\n-            if sampling_params.detokenize:\n-                new_char_count = self.detokenizer.decode_sequence_inplace(\n-                    seq, sampling_params)\n+            self._process_decode_and_stop(seq, sampling_params)\n \n-            # TODO(sang): Support lora.\n-            self.stop_checker.maybe_stop_sequence(\n-                seq,\n-                new_char_count=new_char_count,\n-                sampling_params=sampling_params,\n-            )\n             if seq.is_finished():\n                 break\ndiff --git a/vllm/sequence.py b/vllm/sequence.py\nindex 87b3d21fa..a5ebf152c 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -1225,7 +1225,6 @@ class ExecuteModelRequest(\n     last_sampled_token_ids: Optional[torch.Tensor] = None\n     # Async callback\n     async_callback: Optional[Callable] = None\n-    use_async_and_multi_step: bool = False\n \n     @property\n     def is_first_multi_step(self) -> bool:\n@@ -1272,5 +1271,4 @@ class ExecuteModelRequest(\n             finished_requests_ids=self.finished_requests_ids,\n             last_sampled_token_ids=self.last_sampled_token_ids.clone()\n             if self.last_sampled_token_ids is not None else None,\n-            async_callback=self.async_callback,\n-            use_async_and_multi_step=self.use_async_and_multi_step)\n+            async_callback=self.async_callback)\ndiff --git a/vllm/worker/model_runner.py b/vllm/worker/model_runner.py\nindex 8a3c99a45..74f7d4e08 100644\n--- a/vllm/worker/model_runner.py\n+++ b/vllm/worker/model_runner.py\n@@ -21,6 +21,7 @@ from vllm.attention.backends.utils import CommonAttentionState\n from vllm.config import (CacheConfig, DeviceConfig, LoadConfig, LoRAConfig,\n                          ModelConfig, ObservabilityConfig, ParallelConfig,\n                          PromptAdapterConfig, SchedulerConfig)\n+from vllm.core.scheduler import SchedulerOutputs\n from vllm.distributed import get_pp_group\n from vllm.distributed.parallel_state import graph_capture\n from vllm.inputs import INPUT_REGISTRY, InputRegistry\n@@ -96,7 +97,8 @@ class ModelInputForGPU(ModelRunnerInputBase):\n     finished_requests_ids: Optional[List[str]] = None\n     virtual_engine: int = 0\n     async_callback: Optional[Callable] = None\n-    use_async_and_multi_step: bool = False\n+    seq_group_metadata_list: Optional[List[SequenceGroupMetadata]] = None\n+    scheduler_outputs: Optional[SchedulerOutputs] = None\n \n     def as_broadcastable_tensor_dict(self) -> Dict[str, Any]:\n         tensor_dict = {\ndiff --git a/vllm/worker/multi_step_model_runner.py b/vllm/worker/multi_step_model_runner.py\nindex be0c75bc0..b52f2a07e 100644\n--- a/vllm/worker/multi_step_model_runner.py\n+++ b/vllm/worker/multi_step_model_runner.py\n@@ -22,6 +22,7 @@ from vllm.model_executor.layers.sampler import (PromptLogprobs, SampleLogprobs,\n                                                 get_pythonized_sample_results)\n from vllm.sequence import (CompletionSequenceGroupOutput, IntermediateTensors,\n                            Logprob, SequenceGroupMetadata, SequenceOutput)\n+from vllm.utils import PyObjectCache\n from vllm.worker.model_runner import (GPUModelRunnerBase,\n                                       ModelInputForGPUWithSamplingMetadata)\n from vllm.worker.model_runner_base import (\n@@ -37,6 +38,29 @@ if TYPE_CHECKING:\n logger = init_logger(__name__)\n \n \n+def seq_output_builder():\n+    return SequenceOutput(\n+        0, 0,\n+        {0: Logprob(logprob=float('inf'), rank=None, decoded_token=None)})\n+\n+\n+def completion_seq_group_output_builder():\n+    return CompletionSequenceGroupOutput([], None)\n+\n+\n+# Used by pythonization to reduce python object allocations\n+class PythonizationCache:\n+\n+    def __init__(self):\n+        self.cached_seq_output = PyObjectCache(seq_output_builder)\n+        self.cached_completion_seq_group_output = PyObjectCache(\n+            completion_seq_group_output_builder)\n+\n+    def reset(self):\n+        self.cached_seq_output.reset()\n+        self.cached_completion_seq_group_output.reset()\n+\n+\n @dataclass\n class ModelOutput:\n     \"\"\"The output of a single model forward pass.\n@@ -59,6 +83,7 @@ class ModelOutput:\n     pythonized: bool = False\n     # On-device tensor containing the logprobs of each token.\n     logprobs: Optional[\"torch.Tensor\"] = None\n+    pythonization_cache: Optional[PythonizationCache] = None\n \n     def pythonize(self, input_metadata: \"StatefulModelInput\",\n                   copy_stream: torch.cuda.Stream,\n@@ -97,7 +122,8 @@ class ModelOutput:\n         with torch.cuda.stream(copy_stream):\n             _pythonize_sampler_output(input_metadata, self.sampler_output,\n                                       pinned_sampled_token_buffer,\n-                                      self.sampled_token_ids, self.logprobs)\n+                                      self.sampled_token_ids, self.logprobs,\n+                                      self.pythonization_cache)\n \n         # Erase the logprobs GPU-side tensor.\n         # Note that although _pythonize_sampler_output() runs in its\n@@ -209,6 +235,8 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n         self._copy_stream = torch.cuda.Stream()\n         self.pinned_sampled_token_ids: Optional[torch.Tensor] = None\n \n+        self.pythonization_cache = PythonizationCache()\n+\n     def make_model_input_from_broadcasted_tensor_dict(\n             self, tensor_dict: Dict[str, Any]) -> StatefulModelInput:\n         model_input = (StatefulModelInput.from_broadcasted_tensor_dict(\n@@ -237,14 +265,22 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n                                output_proc_callback: Callable):\n         # Proceed with pythonization and output_proc in order.\n         # Stop on the first one that fails to pythonize\n+        output_proc_callback()\n+\n         cont = True\n         for model_output in model_input.cached_outputs:\n             if not model_output.pythonized:\n                 model_output.maybe_pythonize(model_input, self._copy_stream,\n                                              self.pinned_sampled_token_ids)\n                 if model_output.pythonized:\n-                    output_proc_callback(\n-                        sampler_output=model_output.sampler_output)\n+                    ctx = output_proc_callback.keywords[\"ctx\"]\n+                    is_async = False\n+                    is_last_step = False\n+                    ctx.output_queue.append(\n+                        ([model_output.sampler_output\n+                          ], ctx.seq_group_metadata_list,\n+                         ctx.scheduler_outputs, is_async, is_last_step))\n+                    output_proc_callback()\n                 else:\n                     cont = False\n \n@@ -255,21 +291,46 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n                                output_proc_callback: Optional[Callable]):\n         assert model_input.frozen_model_input is not None\n \n+        has_async_callback = output_proc_callback is not None\n+\n         outputs = []\n         for output_id in range(len(model_input.cached_outputs)):\n-            is_last_output = output_id == len(model_input.cached_outputs) - 1\n-\n             output = model_input.cached_outputs[output_id]\n-            if not output.pythonized:\n+            is_last_step = output_id == len(model_input.cached_outputs) - 1\n+\n+            # For non-async case:\n+            #   -- We simply add the outputs\n+            # For async case:\n+            #   -- Invoke callback, pythonize, add to callback queue and repeat\n+            #   -- For last output, just add to callback queue\n+            if has_async_callback:\n+                assert output_proc_callback is not None\n+\n+                # Invoke callback before pythonize (to overlap with GPU)\n+                output_proc_callback()\n+\n+                # Pythonize\n+                if not output.pythonized:\n+                    output.pythonize(model_input, self._copy_stream,\n+                                     self.pinned_sampled_token_ids)\n+\n+                    # For non last step, add to callback queue to chain\n+                    # callbacks=>pythonize pairs (for GPU overlap)\n+                    if not is_last_step:\n+                        ctx = output_proc_callback.keywords[  # type: ignore\n+                            \"ctx\"]  # type: ignore\n+                        is_async = False\n+                        is_last_step = False\n+                        ctx.output_queue.append(\n+                            ([output.sampler_output\n+                              ], ctx.seq_group_metadata_list,\n+                             ctx.scheduler_outputs, is_async, is_last_step))\n+                    else:\n+                        outputs.append(output.sampler_output)\n+            else:\n                 output.pythonize(model_input, self._copy_stream,\n                                  self.pinned_sampled_token_ids)\n-\n-                if model_input.frozen_model_input.use_async_and_multi_step:\n-                    assert output_proc_callback is not None\n-                    output_proc_callback(sampler_output=output.sampler_output,\n-                                         is_last_output=is_last_output)\n-\n-            outputs.append(output.sampler_output)\n+                outputs.append(output.sampler_output)\n \n         return outputs\n \n@@ -330,7 +391,7 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n                 model_input, model_input.cached_outputs[-1].sampler_output)\n \n         output_proc_callback = None\n-        if frozen_model_input.use_async_and_multi_step:\n+        if frozen_model_input.async_callback is not None:\n             output_proc_callback = frozen_model_input.async_callback\n             assert output_proc_callback is not None\n             async_callback = functools.partial(\n@@ -367,7 +428,7 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n             model_input.cached_outputs.append(\n                 ModelOutput(output[0], output_ready_event,\n                             output[0].sampled_token_ids, False,\n-                            output[0].logprobs))\n+                            output[0].logprobs, self.pythonization_cache))\n \n             # These GPU tensors are not required by multi-step;\n             # erase them to ensure they are not pythonized or\n@@ -378,7 +439,7 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n \n             # Pythonize the output if CPU is ahead and the previous step is\n             # ready.\n-            if not frozen_model_input.use_async_and_multi_step:\n+            if frozen_model_input.async_callback is None:\n                 for model_output in model_input.cached_outputs:\n                     model_output.maybe_pythonize(model_input,\n                                                  self._copy_stream,\n@@ -397,6 +458,7 @@ class MultiStepModelRunner(GPUModelRunnerBase[StatefulModelInput]):\n         if model_input.is_last_step:\n             outputs = self._final_process_outputs(model_input,\n                                                   output_proc_callback)\n+            self.pythonization_cache.reset()\n             return outputs\n \n         # should be [SamplerOutput]\n@@ -537,6 +599,7 @@ def _pythonize_sampler_output(\n     pinned_sampled_token_buffer: torch.Tensor,\n     sampled_token_ids: torch.Tensor,\n     logprobs_tensor: Optional[torch.Tensor],\n+    cache: Optional[PythonizationCache],\n ) -> None:\n     \"\"\" This function is only called when the output tensors are ready. \n     See :class:`ModelOutput`. \n@@ -597,6 +660,9 @@ def _pythonize_sampler_output(\n \n     for sgdx, (seq_group,\n                sample_result) in enumerate(zip(seq_groups, samples_list)):\n+        if seq_group.sampling_params.logits_processors:\n+            assert len(seq_group.sampling_params.logits_processors) == 0, (\n+                \"Logits Processors are not supported in multi-step decoding\")\n \n         if do_pythonize_logprobs:\n             assert prompt_logprobs is not None\n@@ -621,23 +687,56 @@ def _pythonize_sampler_output(\n         seq_ids = seq_group.seq_ids\n         next_token_ids = sample_result\n         parent_ids = [0]\n-        seq_outputs: List[SequenceOutput] = []\n-        if seq_group.sampling_params.logits_processors:\n-            assert len(seq_group.sampling_params.logits_processors) == 0, (\n-                \"Logits Processors are not supported in multi-step decoding\")\n+\n+        if cache is not None:\n+            completion_seq_group_output: CompletionSequenceGroupOutput = \\\n+                cache.cached_completion_seq_group_output.get_object()\n+            completion_seq_group_output.samples.clear()\n+            seq_outputs: List[\n+                SequenceOutput] = completion_seq_group_output.samples\n+        else:\n+            seq_outputs = []\n+\n         for tdx, (parent_id,\n                   next_token_id) in enumerate(zip(parent_ids, next_token_ids)):\n-            seq_outputs.append(\n-                SequenceOutput(seq_ids[parent_id], next_token_id,\n-                               (group_sample_logprobs[tdx]\n-                                if logprobs_are_requested else {\n-                                    next_token_id:\n-                                    Logprob(logprob=float('inf'),\n-                                            rank=None,\n-                                            decoded_token=None)\n-                                })))\n-        output.outputs.append(\n-            CompletionSequenceGroupOutput(\n-                seq_outputs,\n-                (group_prompt_logprobs if logprobs_are_requested else None)))\n+            if cache is not None:\n+                seq_output: SequenceOutput = cache.cached_seq_output.get_object(\n+                )\n+                seq_output.parent_seq_id = seq_ids[parent_id]\n+                seq_output.output_token = next_token_id\n+\n+                if logprobs_are_requested:\n+                    seq_output.logprobs = group_sample_logprobs[tdx]\n+                else:\n+                    logprobs = next(iter(seq_output.logprobs.values()))\n+                    seq_output.logprobs.clear()\n+\n+                    logprobs.logprob = float('inf')\n+                    logprobs.rank = None\n+                    logprobs.decoded_token = None\n+\n+                    seq_output.logprobs[next_token_id] = logprobs\n+\n+                seq_outputs.append(seq_output)\n+\n+            else:\n+                seq_outputs.append(\n+                    SequenceOutput(seq_ids[parent_id], next_token_id,\n+                                   (group_sample_logprobs[tdx]\n+                                    if logprobs_are_requested else {\n+                                        next_token_id:\n+                                        Logprob(logprob=float('inf'),\n+                                                rank=None,\n+                                                decoded_token=None)\n+                                    })))\n+        if cache is not None:\n+            completion_seq_group_output.prompt_logprobs = \\\n+                group_prompt_logprobs if logprobs_are_requested else None\n+            output.outputs.append(completion_seq_group_output)\n+        else:\n+            output.outputs.append(\n+                CompletionSequenceGroupOutput(\n+                    seq_outputs, (group_prompt_logprobs\n+                                  if logprobs_are_requested else None)))\n+\n     assert len(output.outputs) > 0\ndiff --git a/vllm/worker/multi_step_worker.py b/vllm/worker/multi_step_worker.py\nindex 517b0ab78..562285f82 100644\n--- a/vllm/worker/multi_step_worker.py\n+++ b/vllm/worker/multi_step_worker.py\n@@ -67,9 +67,7 @@ class MultiStepWorker(Worker):\n             if execute_model_req.async_callback:\n                 model_input.frozen_model_input = dataclasses.replace(  # type: ignore\n                     model_input.frozen_model_input,\n-                    async_callback=execute_model_req.async_callback,\n-                    use_async_and_multi_step=execute_model_req.\n-                    use_async_and_multi_step)\n+                    async_callback=execute_model_req.async_callback)\n         else:\n             # on subsequent steps we reuse the worker input and model input\n             multi_step_state = self.multi_step_states[virtual_engine]", "apis": ["vllm.AsyncLLMEngine.generate", "vllm.LLMEngine.step", "vllm.MultiStepModelRunner.execute_model"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/async_llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/multi_step_model_runner.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies multiple non-test source files in the core engine, worker, and async processing modules of the project. It refactors the handling of async and multi-step decoding, clears context outputs earlier, introduces a Pythonization cache to reduce object allocations, and ensures quicker processing of appended outputs (for example, by optimizing callback chaining and queue management). These changes are implemented to reduce latency and overhead in the asynchronous scheduling and output processing path, thus improving overall CPU performance of high-level APIs. Although the commit message mentions â€œOptimize Async + Multi-step,â€ the changes are not mere refactoring or bug fixes but are specific improvements aimed at reducing delays and enhancing throughput. Therefore, it satisfies the conditions for a performance/optimization commit.", "llm_api_reason": "The commit adjusts several core modules to optimize the async multiâ€step decoding flow. In particular, changes were made in the asynchronous engine implementation (in async_llm_engine.py) to simplify how the asynchronous callbacks and queue processing are handled (for example, removing the separate â€œuse_async_and_multi_stepâ€ flag and reworking the outputâ€queue processing). Similar modifications were made in LLMEngine and its scheduler context, as well as in the workerâ€™s multiâ€step model runner where a PythonizationCache was added to reduce object allocations. These changes affect the internal processing flow when high-level API methods are invoked. For users of vLLM the exposed public APIs â€“ such as the asynchronous generation endpoint and the engine step function â€“ now benefit from these optimizations."}
{"commit_hash": "6e36f4fa6ce64619b9ea94c88a157f5783a63a65", "pr_url": "https://github.com/vllm-project/vllm/pull/7874", "pr_date": "2024-08-26", "timeline_text": "Copy link Contributor noooop commented Aug 26, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . SUMMARY: vllm 0.5.4 enable_chunked_prefill throughput is slightly lower than 0.5.3~0.5.0. Prioritizing prefill causes and aggravate system thrashing. FILL IN THE PR DESCRIPTION HERE FIX #7592 by definition By default, vLLM scheduler prioritizes prefills ... Once chunked prefill is enabled, the policy is changed to prioritize decode requests. The easiest fix is sort the running queue. Keeping chunked prefill performance the untouched, everyone is happy. BEFORE SUBMITTING, PLEASE READ THE CHECKLIST BELOW AND FILL IN THE DESCRIPTION ABOVE PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 lambdaq reacted with thumbs up emoji ðŸš€ 2 Juelianqvq and simon-mo reacted with rocket emoji All reactions ðŸ‘ 1 reaction ðŸš€ 2 reactions Copy link github-actions bot commented Aug 26, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 26, 2024 @youkaichao All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Aug 26, 2024 thanks for the contribution! please fix the format issue. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Aug 26, 2024 I don't get it though, why this would affect chunked prefill so much ðŸ‘€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Aug 26, 2024 Thanks for the fix! I have the same question as Kaichao. Why sorting running requests by their arrival time impacts the throughput significantly? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 27, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Putting definitions and conventions aside first, let's discuss the pros and cons of chunked_prefill prioritizing scheduling prefill and prioritizing decoding. GPU memory limitations (gpu cache block limitations) When the GPU memory is sufficient, or max_num_batched_tokens and max_num_seqs are within a reasonable range, priority scheduling prefill can allow as many tasks as possible to enter decode mode, and even the entire batch is in decode mode, triggering CUDA graph optimization to improve throughput, but This (CUDA graph) is particularly effective for small models and when using tensor parallelism. , and when the batch is less than 256 (_BATCH_SIZES_TO_CAPTURE[-1]). So.Scenarios that favor priority scheduling of prefill are difficult to satisfy. In reality, when llm is deployed, the GPU memory is often limited, or max_num_batched_tokens and max_num_seqs are set too large, and preemption inevitably occurs. Priority scheduling decode can finish running tasks as soon as possible and release GPU memory, while priority scheduling prefill increases the number of tasks that are running at the same time, increasing the possibility of preemption. When preemption occurs, scheduling decode first means that tasks in the prefill phase are preempted and the cost is relatively small. When scheduling prefill first, tasks in the decode phase are preempted and the cost is relatively high. In short, when the GPU memory is limited, scheduling prefill first is Disaster, this is what I encountered. User satisfaction Prioritize scheduling decode, As mentioned in the documentation, \"It improves ITL and generation decode because decode requests are prioritized.\" Why sorting matters? Give an example max_num_seqs = max_num_batched_tokens= 256 input_len = output_len = 511 init request 0: num_computed_tokens: 0, num_uncomputed_tokens 511 request 1: num_computed_tokens: 0, num_uncomputed_tokens 511 step 1: Scheduled [0] request 0: num_computed_tokens: 256, num_uncomputed_tokens 255 request 1: num_computed_tokens: 0, num_uncomputed_tokens 511 step 2: Scheduled [0, 1] request 0: num_computed_tokens: 511, num_uncomputed_tokens 1, (to enter decode mode,) request 1: num_computed_tokens: 1, num_uncomputed_tokens 510 step 3: prioritizing scheduling prefill ï¼ˆ0.5.4~0.5.5 Scheduled [1]  (Why not let request 0 decode ??????? request 0: num_computed_tokens: 511, num_uncomputed_tokens 1 request 1: num_computed_tokens: 257, num_uncomputed_tokens 254 prioritizing scheduling decode ï¼ˆ0.5.0~0.5.3 Scheduled [0, 1] request 0: num_computed_tokens: 512, num_uncomputed_tokens 1 request 1: num_computed_tokens: 256, num_uncomputed_tokens 255 sorting matters All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 27, 2024 by the way prioritizing scheduling prefill and prioritizing decoding. the order of running_queue is exactly the opposite. But you can't just reverse the running_queue, you need modify every self.running.extend or as i said 'The easiest fix is sort the running queue.' All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 27, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Add more It is also a normal performance tuning behavior to set max_num_batched_tokens and max_num_seqs slightly larger ï¼ˆto slightly trigger preemptionï¼‰, increase parallelism, and improve throughput. But prioritizing prefill causes and aggravate system thrashing. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Aug 27, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . LGTM to add the sorting to get back to the behavior of 0.5.3. Please fix the format. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . noooop force-pushed the main branch\n    from 408b727 to dd12bc8 Compare August 27, 2024 02:42 Copy link Contributor Author noooop commented Aug 27, 2024 Submit code to vllm for the first time. Is there anything else I need to do? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Aug 27, 2024 as long as it does not break any tests, we can merge it. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 27, 2024 Thanks All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator rkooo567 commented Aug 27, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @noooop I think the issue is that after the refactoring, we should've changed the order of these lines to guarantee the ordering. Before the refactoring, the order was guranteed because we always sorted. Now we should more carefully extend the queue to preserve the right order. https://github.com/vllm-project/vllm/blob/ed6f002d3340888142cb67c13a37c060b51fa889/vllm/core/scheduler.py#L1029C1-L1029C72 I think if we change the order to be extend(swapped_in.decode)\nextend(swapped_in.prefill)\nextend(running.decode)\nextend(running.prefill)\nextend(new_prefill) The same behavior is preserved. can you test it? Note: without sorting, it may be difficult to always guarantee the right ordering when preemption happens, but I think that's the tradeoff ðŸ‘ 1 comaniac reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator rkooo567 commented Aug 27, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . more specifically, change these lines self.running.extend([s.seq_group for s in prefills.seq_groups])\n        self.running.extend(\n            [s.seq_group for s in running_scheduled.decode_seq_groups])\n        self.running.extend(\n            [s.seq_group for s in running_scheduled.prefill_seq_groups])\n        self.running.extend(\n            [s.seq_group for s in swapped_in.decode_seq_groups])\n        self.running.extend(\n            [s.seq_group for s in swapped_in.prefill_seq_groups]) to self.running.extend(\n            [s.seq_group for s in swapped_in.decode_seq_groups])\n        self.running.extend(\n            [s.seq_group for s in swapped_in.prefill_seq_groups])\n        self.running.extend(\n            [s.seq_group for s in running_scheduled.decode_seq_groups])\n        self.running.extend(\n            [s.seq_group for s in running_scheduled.prefill_seq_groups])\n        self.running.extend([s.seq_group for s in prefills.seq_groups]) can you try testing it and see if it works? ðŸ‘ 1 youkaichao reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 28, 2024 @rkooo567 We need to maintain the priority order of the queue. There are at least four methods to choose from. We can choose the best method from efficiency, readability, ease of use, scalability, and maybe minimal modification. Sorting when dequeue.  Although slightly inefficient, no one can break itï¼Œease to useï¼Œease to readï¼Œand minimal modification. use PriorityQueue.  Priority queue is very good optionï¼Œwe need priority queue, we use priority queue. The following methods are not recommended Manually maintain queue order when inqueueï¼Œwith online check.  maybe efficient. code that maintains order is everywhere, difficult to useï¼Œ difficult to readï¼Œ difficult to modification. Manually maintain queue order when inqueueï¼Œwithout check.  ????? No one can modify this code in the future The performance bottleneck is in the GPU. I think there won't be much performance difference between Sorting and PriorityQueue, even manually maintaining queue order when inqueue. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Aug 28, 2024 The performance bottleneck is in the GPU. I think there won't be much performance difference between Sorting and PriorityQueue, even manually maintaining queue order when inqueue. This may not be true especially for online serving which we are talking about a few millisecond ITL. In fact, Python overheads like these are the main performance bottleneck. We now even need to pre-allocate and reuse Python objects, use array.array, or add a branch for edge cases (e.g., do not call sum , count when there's only one element in a list). The easiest way to verify whether this sort creates ineligible overhead is running a performance benchmark. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator rkooo567 commented Aug 28, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Sorting when dequeue. Although slightly inefficient, no one can break itï¼Œease to useï¼Œease to readï¼Œand minimal modification. Also to be clear, we used this implementation originally for exactly this reason, but vLLM currently has python overhead, and that's why we removed the sorting logic that requires repetitive queue copy. Often times, model forward only takes 10-20ms overhead only, and having 2-3ms overhead in the scheduler is critical in this kind of scenario. (if we eventually support async scheduler, we can probably come back to this implementation) I think manual sorting is the best workaround. I am not opposed to use priority queue as well if it turns out that it has no perf impact. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 28, 2024 I understand that strict orderliness is not necessary. I'm testing to see if certain queues may need to be reversed. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 28, 2024 Actually I was implementing async scheduler and stumbled upon this bug ðŸ‘ 2 rkooo567 and QuantumGhost reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . noooop force-pushed the main branch\n    from dd12bc8 to 5245f4f Compare August 28, 2024 05:41 Copy link Contributor Author noooop commented Aug 28, 2024 It works,  in fact I love is  tradeoff . My own manual sorting method required too many changes, so I gave up. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac approved these changes Aug 28, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM. Thanks Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author noooop commented Aug 28, 2024 this manual sorting  comparison with 0.5.3 and sorting on 1,000 requestsï¼Œscheduling sequence exactly the same â¤ï¸ 1 rkooo567 reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . rkooo567 approved these changes Aug 28, 2024 View reviewed changes Copy link Collaborator rkooo567 commented Aug 28, 2024 Awesome to hear that! btw I don't know if basic correctness test failure is related. can you try merging the latest master? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 28, 2024 ok All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . noooop force-pushed the main branch\n    from 370de52 to 90885c2 Compare August 28, 2024 06:46 Copy link Contributor Author noooop commented Aug 28, 2024 By the way I was implementing async scheduler. During this process, I made a huge modularization and added dynamic workflow to vllm. I don't know if you want to see it. https://github.com/noooop/light-vllm ðŸš€ 2 Juelianqvq and youkaichao reacted with rocket emoji All reactions ðŸš€ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 28, 2024 I don't know why the test failed. This pr is too simple to break anything. Or the test is set up based on the wrong scheduling method All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . 25 hidden items Load moreâ€¦ noooop reopened this Aug 30, 2024 Copy link Contributor Author noooop commented Aug 30, 2024 merg to the latest master Can anyone help me with the test? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 30, 2024 @jon-chuang Can you give me some suggestions to pass the test. Can I delete test7? Howï¼Ÿ I can't find example.txt All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor jon-chuang commented Aug 30, 2024 For this test, try making NUM_LOGPROBS contingent on fp8 dtype and set to 8 if e5m2 and something higher (16 or 32) for e4m3. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor jon-chuang commented Aug 30, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . If you can't fix it this way, you can mark that specific parameters for the test which fail (model type, dtype) as pytest.mark.skip(\"flakey test, see: #XXX\") or create an issue and link to that and I can fix it in another PR. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . noooop mentioned this pull request Aug 31, 2024 [Bug]: flakey test found in #7874 #8051 Closed 1 task Copy link Contributor Author noooop commented Aug 31, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . # We use float32 for probabilities and log probabilities. In Sampler float32 precise is is high enough. Can NUM_LOGPROBS be enlarged to achieve the original testing purpose? I choose to skip this test and let professionals solve it. @jon-chuang #8051 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . noooop force-pushed the main branch\n    from 95aab1c to 57dc722 Compare August 31, 2024 04:33 noooop force-pushed the main branch\n    from 57dc722 to a05dd0b Compare August 31, 2024 04:36 flakey test, see: vllm-project#7874 vllm-project#8051 ad5f1db noooop force-pushed the main branch\n    from a05dd0b to ad5f1db Compare August 31, 2024 04:48 Copy link Contributor Author noooop commented Aug 31, 2024 @youkaichao @rkooo567 @comaniac Is it ready to launch? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author noooop commented Aug 31, 2024 /ready All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 31, 2024 Copy link Member youkaichao commented Sep 2, 2024 thanks for the contribution! I triggered the test again, as long as the tests pass, we can merge it. ðŸ‘ 1 noooop reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details youkaichao merged commit 6e36f4f into vllm-project : main Sep 2, 2024 45 of 47 checks passed Uh oh! There was an error while loading. Please reload this page . gongdao123 pushed a commit\n        to bartsolutions/vllm\n      that referenced\n      this pull request Oct 18, 2024 improve chunked prefill performance â€¦ 100fcc9 [Bugfix] Fix vllm-project#7592 vllm 0.5.4 enable_chunked_prefill throughput is slightly lower than 0.5.3~0.5.0. ( vllm-project#7874 ) Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 improve chunked prefill performance â€¦ 5a69ab1 [Bugfix] Fix vllm-project#7592 vllm 0.5.4 enable_chunked_prefill throughput is slightly lower than 0.5.3~0.5.0. ( vllm-project#7874 )\n\nSigned-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 improve chunked prefill performance â€¦ 9e6de1c [Bugfix] Fix vllm-project#7592 vllm 0.5.4 enable_chunked_prefill throughput is slightly lower than 0.5.3~0.5.0. ( vllm-project#7874 )\n\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:01", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, throughput, throughput | SERVING: serving, API server, OpenAI API server | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:48:01", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "improve chunked prefill performance", "commit_message": "improve chunked prefill performance\n\n[Bugfix] Fix #7592 vllm 0.5.4 enable_chunked_prefill throughput is slightly lower than 0.5.3~0.5.0. (#7874)", "commit_date": "2024-09-02T14:20:12-07:00", "files_changed": ["tests/basic_correctness/test_chunked_prefill.py", "vllm/core/scheduler.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 0, "num_files": 2, "num_hunks": 2, "num_edited_lines": 18, "num_non_test_edited_lines": 15, "commit_year": 2024}, "diff_text": "diff --git a/tests/basic_correctness/test_chunked_prefill.py b/tests/basic_correctness/test_chunked_prefill.py\nindex fc6f829c3..a63ac380e 100644\n--- a/tests/basic_correctness/test_chunked_prefill.py\n+++ b/tests/basic_correctness/test_chunked_prefill.py\n@@ -116,6 +116,9 @@ def test_models_with_fp8_kv_cache(\n         pytest.skip(\n             \"#7378: CUDA illegal memory access (undiagnosed) facebook/opt-125m\"\n         )\n+    if ((model, kv_cache_dtype, chunked_prefill_token_size) == (\n+            \"nm-testing/Qwen2-1.5B-Instruct-FP8-K-V\", \"fp8_e4m3\", 4)):\n+        pytest.skip(\"flakey test, see: #7874 #8051\")\n \n     max_num_seqs = chunked_prefill_token_size\n     max_num_batched_tokens = chunked_prefill_token_size\ndiff --git a/vllm/core/scheduler.py b/vllm/core/scheduler.py\nindex 4c2f71582..81c78bda3 100644\n--- a/vllm/core/scheduler.py\n+++ b/vllm/core/scheduler.py\n@@ -1027,16 +1027,21 @@ class Scheduler:\n \n         # Update waiting requests.\n         self.waiting.extendleft(running_scheduled.preempted)\n+\n         # Update new running requests.\n-        self.running.extend([s.seq_group for s in prefills.seq_groups])\n-        self.running.extend(\n-            [s.seq_group for s in running_scheduled.decode_seq_groups])\n-        self.running.extend(\n-            [s.seq_group for s in running_scheduled.prefill_seq_groups])\n+        # By default, vLLM scheduler prioritizes prefills.\n+        # Once chunked prefill is enabled,\n+        # the policy is changed to prioritize decode requests.\n         self.running.extend(\n             [s.seq_group for s in swapped_in.decode_seq_groups])\n         self.running.extend(\n             [s.seq_group for s in swapped_in.prefill_seq_groups])\n+        self.running.extend(\n+            [s.seq_group for s in running_scheduled.decode_seq_groups])\n+        self.running.extend(\n+            [s.seq_group for s in running_scheduled.prefill_seq_groups])\n+        self.running.extend([s.seq_group for s in prefills.seq_groups])\n+\n         # Update swapped requests.\n         self.swapped.extend(running_scheduled.swapped_out)\n         return SchedulerOutputs(", "apis": ["vllm.core.scheduler.Scheduler.schedule", "vllm.core.scheduler.SchedulerOutputs"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/scheduler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/scheduler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/chunked_prefill_paged_decode.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test file (vllm/core/scheduler.py) where scheduling logic for handling requests is changed, effectively reordering elements and adjusting the prioritization, which is aimed at improving throughput and overall performance. Although the commit message also mentions fixing a throughput regression in a bugfix context, the changes directly target performance improvement of a core component affecting high-level API usage on CPU. Therefore, the commit meets the criteria for performance or optimization related changes.", "llm_api_reason": "This commit changes the scheduling logic in the vLLM scheduler by reordering how sequence groups are added to the running queue. Instead of simply concatenating prefills then decode groups, the updated code now prepends swappedâ€in decode and prefill groups first and then adds running decoded and prefill groups followed by the original prefills. This reordering, which is enabled when chunked prefill is active, prioritizes decode requests to improve throughput performance. The test file was also modified to skip a flaky test case for a specific model configuration."}
{"commit_hash": "ce6bf3a2cff4860c5661cac2280e0a28bedb6440", "pr_url": "https://github.com/vllm-project/vllm/pull/7898", "pr_date": "2024-08-28", "timeline_text": "Copy link Member youkaichao commented Aug 27, 2024 We have 2 types of runtime overhead in TPU: Dynamo guard evaluation overhead, chooses which code to run torch xla overhead, convert function input to xla input We can manage to remove the first one, via adding one layer dispatcher above Dynamo. I did systematic measurement this time, and find that: pure xla execution takes 7ms for every decoding step combining both overhead ( the current main branch), it takes 8.2ms for every decoding step removing Dynamo overhead (this PR), it takes 8.0ms for every decoding step It turns out the xla overhead is the main overhead. But I think it is still worthwhile to get rid of the Dynamo overhead before we remove the xla overhead. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions custom dispatch 248d4db Copy link github-actions bot commented Aug 27, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . refine 8f4ed39 Copy link Member Author youkaichao commented Aug 27, 2024 NOTE: my test code is still https://github.com/vllm-project/vllm/blob/main/examples/offline_inference_tpu.py All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author youkaichao commented Aug 27, 2024 this looks surprisingly effective. I run python benchmarks/benchmark_throughput.py  --input-len 256 --output-len 256 --model google/gemma-2b main: Throughput: 16.70 requests/s, 8549.39 tokens/s this PR: Throughput: 17.39 requests/s, 8902.73 tokens/s it counts as 4% throughput improvement All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . youkaichao added 17 commits August 27, 2024 00:57 add wrapper 2d8b20a update 9f752fd add wrapper test 4be616a fix 026a525 update wrapper 7a1dd38 separate tests 1f0f148 add tests 7531186 update tests 31e9e7b multi wrappers ace38e2 use wrapper 31a9e06 fix 0a349f5 fix 12cb164 more explanation f483660 add tests ec52afc add package fabce9a update tests b9fff4c add tests f5019fc youkaichao requested a review\n  from WoosukKwon August 27, 2024 18:12 add init e3692ba WoosukKwon approved these changes Aug 28, 2024 View reviewed changes vllm/worker/tpu_model_runner.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/worker/tpu_model_runner.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/compilation/wrapper.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . youkaichao and others added 3 commits August 28, 2024 15:26 Update vllm/worker/tpu_model_runner.py â€¦ 746036c Co-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into custom_dispatch 80ce2bd fix args a0bac86 youkaichao enabled auto-merge (squash) August 28, 2024 23:09 youkaichao disabled auto-merge August 28, 2024 23:09 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 28, 2024 Hide details View details youkaichao merged commit ce6bf3a into vllm-project : main Aug 28, 2024 26 of 31 checks passed Uh oh! There was an error while loading. Please reload this page . youkaichao deleted the custom_dispatch branch August 28, 2024 23:10 youkaichao mentioned this pull request Aug 28, 2024 [torch.compile] remove reset #7975 Merged Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [torch.compile] avoid Dynamo guard evaluation overhead ( vllm-project#â€¦ â€¦ 7da14a0 â€¦7898 )\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [torch.compile] avoid Dynamo guard evaluation overhead ( vllm-project#â€¦ â€¦ 74301d6 â€¦7898 )\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:04", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: Throughput, Throughput, throughput | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:48:04", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_throughput.py  --input-len 256 --output-len 256 --model google/gemma-2b", "commit_subject": "[torch.compile] avoid Dynamo guard evaluation overhead (#7898)", "commit_message": "[torch.compile] avoid Dynamo guard evaluation overhead (#7898)\n\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2024-08-28T16:10:12-07:00", "files_changed": [".buildkite/run-tpu-test.sh", ".buildkite/test-pipeline.yaml", "tests/compile/test_wrapper.py", "tests/tpu/__init__.py", "tests/tpu/test_custom_dispatcher.py", "vllm/compilation/__init__.py", "vllm/compilation/wrapper.py", "vllm/envs.py", "vllm/worker/tpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 3, "num_non_test_files": 6, "only_test_files": 0, "only_non_test_files": 0, "num_files": 9, "num_hunks": 11, "num_edited_lines": 201, "num_non_test_edited_lines": 133, "commit_year": 2024}, "diff_text": "diff --git a/.buildkite/run-tpu-test.sh b/.buildkite/run-tpu-test.sh\nindex 335ffd83f..6989c94d4 100644\n--- a/.buildkite/run-tpu-test.sh\n+++ b/.buildkite/run-tpu-test.sh\n@@ -12,4 +12,4 @@ remove_docker_container\n # For HF_TOKEN.\n source /etc/environment\n # Run a simple end-to-end example.\n-docker run --privileged --net host --shm-size=16G -it -e HF_TOKEN=$HF_TOKEN --name tpu-test vllm-tpu /bin/bash -c \"python3 -m pip install git+https://github.com/thuml/depyf.git && python3 /workspace/vllm/tests/tpu/test_compilation.py && python3 /workspace/vllm/examples/offline_inference_tpu.py\"\n+docker run --privileged --net host --shm-size=16G -it -e HF_TOKEN=$HF_TOKEN --name tpu-test vllm-tpu /bin/bash -c \"python3 -m pip install git+https://github.com/thuml/depyf.git && python3 -m pip install pytest  && pytest -v -s /workspace/vllm/tests/tpu/test_custom_dispatcher.py && python3 /workspace/vllm/tests/tpu/test_compilation.py && python3 /workspace/vllm/examples/offline_inference_tpu.py\"\ndiff --git a/.buildkite/test-pipeline.yaml b/.buildkite/test-pipeline.yaml\nindex 9f449ff65..235db72ee 100644\n--- a/.buildkite/test-pipeline.yaml\n+++ b/.buildkite/test-pipeline.yaml\n@@ -173,6 +173,7 @@ steps:\n   - vllm/\n   commands:\n     - pytest -v -s ./compile/test_full_graph.py\n+    - pytest -v -s ./compile/test_wrapper.py\n \n \n - label: Vision Language Models Test # 42min\ndiff --git a/tests/compile/test_wrapper.py b/tests/compile/test_wrapper.py\nnew file mode 100644\nindex 000000000..cef516ade\n--- /dev/null\n+++ b/tests/compile/test_wrapper.py\n@@ -0,0 +1,59 @@\n+from typing import Optional\n+\n+import torch\n+\n+from vllm.compilation.wrapper import TorchCompileWrapperWithCustomDispacther\n+\n+\n+class MyMod(torch.nn.Module):\n+\n+    def forward(self, x: torch.Tensor, cache: Optional[torch.Tensor] = None):\n+        if cache is not None:\n+            return x + cache\n+        return x * 2\n+\n+\n+class MyWrapper(TorchCompileWrapperWithCustomDispacther):\n+\n+    def __init__(self, model):\n+        self.model = model\n+        compiled_callable = torch.compile(self.forward, backend=\"eager\")\n+        super().__init__(compiled_callable)\n+\n+    def forward(self, x: torch.Tensor, cache: Optional[torch.Tensor] = None):\n+        # this is the function to be compiled\n+        return self.model(x, cache)\n+\n+    def __call__(self, x: torch.Tensor, cache: Optional[torch.Tensor] = None):\n+        # let torch.compile compile twice\n+        if len(self.compiled_codes) == 2:\n+            dispatch_id = 0 if cache is None else 1\n+            with self.dispatch_to_code(dispatch_id):\n+                return self.forward(x, cache)\n+        else:\n+            return self.compiled_callable(x, cache)\n+\n+\n+def test_torch_compile_wrapper():\n+    mod = MyMod()\n+    wrappers = []\n+    for i in range(3):\n+        torch._dynamo.reset()\n+        wrapper = MyWrapper(mod)\n+        wrappers.append(wrapper)\n+        x = torch.tensor([1])\n+        wrapper(x, None)  # profile run, compile\n+        # create a cache tensor\n+        cache = torch.tensor([2])\n+        wrapper(x, cache)  # warm up with cache, recompile\n+\n+        # for new input, dispatch to the compiled code directly\n+        new_x = torch.tensor([3])\n+        assert wrapper(new_x,\n+                       None).item() == 6  # dispatch to the first compiled code\n+        assert wrapper(\n+            new_x, cache).item() == 5  # dispatch to the second compiled code\n+\n+    for wrapper in wrappers:\n+        # make sure they have independent compiled codes\n+        assert len(wrapper.compiled_codes) == 2\ndiff --git a/tests/tpu/__init__.py b/tests/tpu/__init__.py\nnew file mode 100644\nindex 000000000..e69de29bb\ndiff --git a/tests/tpu/test_custom_dispatcher.py b/tests/tpu/test_custom_dispatcher.py\nnew file mode 100644\nindex 000000000..7f3fb5953\n--- /dev/null\n+++ b/tests/tpu/test_custom_dispatcher.py\n@@ -0,0 +1,9 @@\n+from ..utils import compare_two_settings\n+\n+\n+def test_custom_dispatcher():\n+    compare_two_settings(\"google/gemma-2b\",\n+                         arg1=[\"--enforce-eager\"],\n+                         arg2=[\"--enforce-eager\"],\n+                         env1={\"VLLM_DYNAMO_USE_CUSTOM_DISPATCHER\": \"0\"},\n+                         env2={})\ndiff --git a/vllm/compilation/__init__.py b/vllm/compilation/__init__.py\nnew file mode 100644\nindex 000000000..e69de29bb\ndiff --git a/vllm/compilation/wrapper.py b/vllm/compilation/wrapper.py\nnew file mode 100644\nindex 000000000..c3d863299\n--- /dev/null\n+++ b/vllm/compilation/wrapper.py\n@@ -0,0 +1,81 @@\n+import os\n+import sys\n+from abc import abstractmethod\n+from contextlib import contextmanager\n+from types import CodeType\n+from typing import Callable, List\n+\n+import torch\n+\n+import vllm.envs as envs\n+\n+\n+class TorchCompileWrapperWithCustomDispacther:\n+    \"\"\"\n+    A wrapper class for torch.compile, with a custom dispatch logic.\n+    Subclasses should:\n+    1. Implement the forward method\n+    2. Implement the dispatch logic in the __call__ method\n+        It can use `self.compiled_codes` to access the compiled bytecode,\n+        and `with self.dispatch_to_code(index):` to dispatch to\n+        the compiled code.\n+    3. Implement the `__init__` method to determine how to call\n+        `torch.compile` over the forward method.\n+    \"\"\"\n+\n+    def __init__(self, compiled_callable: Callable):\n+        self.compiled_callable = compiled_callable\n+        self.original_code_object = self.__class__.forward.__code__\n+        self.compiled_codes: List[CodeType] = []\n+        torch._dynamo.convert_frame.register_bytecode_hook(self.bytecode_hook)\n+\n+        # read the env var to determine whether to use the custom dispatcher\n+        # subclasses can use this to switch between the custom dispatcher\n+        # and the default Dynamo guard mechanism.\n+        self.use_custom_dispatcher: bool = \\\n+            envs.VLLM_DYNAMO_USE_CUSTOM_DISPATCHER\n+\n+    def __call__(self, *args, **kwargs):\n+        \"\"\"Implement the dispatch logic here, beyond the torch.compile level.\n+        NOTE: this function can have additional arguments beyond the forward\n+         method, for directly dispatching to the compiled code.\n+        \"\"\"\n+        return self.compiled_callable(*args, **kwargs)\n+\n+    @abstractmethod\n+    def forward(self, *args, **kwargs):\n+        ...\n+\n+    def bytecode_hook(self, old_code: CodeType, new_code: CodeType):\n+        \"\"\"Hook to save the compiled bytecode for direct execution.\"\"\"\n+        if old_code is not self.original_code_object:\n+            return\n+        # code borrowed from https://github.com/thuml/depyf/blob/f4ad79fadee27ea113b4c75202db1eb1a11c0dbc/depyf/explain/enable_debugging.py#L25\n+        frame = sys._getframe()\n+        while True:\n+            frame = frame.f_back\n+            code_name = frame.f_code.co_name\n+            file_name = frame.f_code.co_filename.split(os.path.sep)[-1]\n+            if code_name == \"_compile\" and file_name == \"convert_frame.py\":\n+                break\n+        frame = frame.f_locals[\"frame\"]\n+        assert frame.f_code == old_code\n+\n+        if frame.f_locals[\"self\"] is not self:\n+            return\n+\n+        self.compiled_codes.append(new_code)\n+\n+    @contextmanager\n+    def dispatch_to_code(self, index: int):\n+        \"\"\"Context manager to dispatch to the compiled code.\n+        Why does this work? Because Dynamo guarantees that the compiled\n+        bytecode has exactly the same arguments, cell variables, and free\n+        variables as the original code. Therefore we can directly switch\n+        the code object in the function and call it.\n+\n+        See https://dev-discuss.pytorch.org/t/what-is-the-relationship-requirement-among-original-bytecode-transformed-bytecode-and-bytecode-returned-by-hooks-in-dynamo/1693/7 for more details.\n+        \"\"\" # noqa\n+        self.__class__.forward.__code__ = self.compiled_codes[index]\n+        yield\n+        self.__class__.forward.__code__ = self.original_code_object\ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex 4faafd9da..590698416 100644\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -196,6 +196,10 @@ environment_variables: Dict[str, Callable[[], Any]] = {\n     # Internal flag to enable Dynamo graph capture\n     \"VLLM_TEST_DYNAMO_GRAPH_CAPTURE\":\n     lambda: int(os.environ.get(\"VLLM_TEST_DYNAMO_GRAPH_CAPTURE\", \"0\")),\n+    \"VLLM_DYNAMO_USE_CUSTOM_DISPATCHER\":\n+    lambda:\n+    (os.environ.get(\"VLLM_DYNAMO_USE_CUSTOM_DISPATCHER\", \"True\").lower() in\n+     (\"true\", \"1\")),\n \n     # local rank of the process in the distributed setting, used to determine\n     # the GPU device id\ndiff --git a/vllm/worker/tpu_model_runner.py b/vllm/worker/tpu_model_runner.py\nindex 01daa64b5..a7ceb84ef 100644\n--- a/vllm/worker/tpu_model_runner.py\n+++ b/vllm/worker/tpu_model_runner.py\n@@ -10,6 +10,7 @@ import torch_xla.core.xla_model as xm\n import torch_xla.runtime as xr\n \n from vllm.attention import AttentionMetadata, get_attn_backend\n+from vllm.compilation.wrapper import TorchCompileWrapperWithCustomDispacther\n from vllm.config import (CacheConfig, DeviceConfig, LoadConfig, ModelConfig,\n                          ParallelConfig, SchedulerConfig)\n from vllm.logger import init_logger\n@@ -144,11 +145,7 @@ class TPUModelRunner(ModelRunnerBase[ModelInputForTPU]):\n             )\n         model = model.eval()\n         xm.wait_device_ops()\n-        model = ModelWrapper(model)\n-        self.model = torch.compile(model,\n-                                   backend=\"openxla\",\n-                                   fullgraph=True,\n-                                   dynamic=False)\n+        self.model = ModelWrapper(model)\n \n     def _dummy_run(\n         self,\n@@ -235,8 +232,15 @@ class TPUModelRunner(ModelRunnerBase[ModelInputForTPU]):\n             torch._dynamo.mark_dynamic(t, 0)\n             torch._dynamo.mark_dynamic(p, 0)\n         # Dummy run.\n-        self.model(token_ids, position_ids, attn_metadata, input_lens, t, p,\n-                   num_samples, kv_caches)\n+        self.model(token_ids,\n+                   position_ids,\n+                   attn_metadata,\n+                   input_lens,\n+                   t,\n+                   p,\n+                   num_samples,\n+                   kv_caches,\n+                   is_prompt=is_prompt)\n \n     def warmup_model(\n         self,\n@@ -530,7 +534,7 @@ class TPUModelRunner(ModelRunnerBase[ModelInputForTPU]):\n                     if getattr(arg, \"context_lens\", None) is not None:\n                         arg.context_lens = arg.context_lens.to(self.device)\n                 new_args.append(arg)\n-            return self.model(*new_args)\n+            return self.model(*new_args, is_prompt=is_prompt)\n \n         num_prefills = model_input.attn_metadata.num_prefills\n         is_prompt = num_prefills > 0\n@@ -601,11 +605,32 @@ class TPUModelRunner(ModelRunnerBase[ModelInputForTPU]):\n         return [SamplerOutput(sampler_outputs)]\n \n \n-class ModelWrapper(nn.Module):\n+class ModelWrapper(TorchCompileWrapperWithCustomDispacther):\n \n     def __init__(self, model: nn.Module):\n-        super().__init__()\n         self.model = model\n+        compiled_callable = torch.compile(self.forward,\n+                                          backend=\"openxla\",\n+                                          fullgraph=True,\n+                                          dynamic=False)\n+        super().__init__(compiled_callable)\n+\n+    def __call__(self, *args, is_prompt: bool, **kwargs):\n+        if len(self.compiled_codes) < 3 or not self.use_custom_dispatcher:\n+            # not fully compiled yet, or not using the custom dispatcher,\n+            # let PyTorch handle it\n+            return self.compiled_callable(*args, **kwargs)\n+        # the 3 compiled codes are:\n+        # 0: for profiling\n+        # 1: for prompt\n+        # 2: for decode\n+        # dispatch to the compiled code directly, skip PyTorch\n+        if is_prompt:\n+            with self.dispatch_to_code(1):\n+                return self.forward(*args, **kwargs)\n+        else:\n+            with self.dispatch_to_code(2):\n+                return self.forward(*args, **kwargs)\n \n     def forward(\n         self,", "apis": ["vllm.compilation.wrapper.TorchCompileWrapperWithCustomDispacther", "vllm.worker.tpu_model_runner.ModelWrapper"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/compilation/wrapper.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/tpu_model_runner.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit introduces a custom dispatcher for torch.compile to avoid the Dynamo guard evaluation overhead. It adds new functionality in the compilation wrapper and modifies the ModelWrapper in the TPU model runner, which are non-test source files. These changes are geared toward reducing runtime overhead by dispatching directly to precompiled code paths and, thus, have a performance optimization focus. The modifications are non-trivial and affect top-level API behavior, meeting the performance-related criteria.", "llm_api_reason": "This commit introduces a custom dispatcher for torch.compile by adding a new wrapper class (with a slight typo in its name) in the vllm/compilation module. The changes add tests in the compile and TPU test suites to verify that the custom dispatch behavior works as intended (with dispatching based on whether a cache is provided) and to ensure that multiple compiled bytecodes are maintained independently. In addition, the TPU model runnerâ€™s ModelWrapper has been updated to subclass this new custom dispatcher so that it can dispatch to different compiled graphs (profiling, prompt, and decode) based on input parameters. Overall, the change aims to avoid the Dynamo guard evaluation overhead by switching directly between precompiled â€œcode objects.â€"}
{"commit_hash": "e3580537a41a46b0f3cd750b86b633c1857a8c90", "pr_url": "https://github.com/vllm-project/vllm/pull/7753", "pr_date": "2024-08-28", "timeline_text": "Copy link Collaborator comaniac commented Aug 21, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Reference PRs: #6144 , #6819 Make @sighingnow and @Juelianqvq as co-authors of this PR. This PR supports prefix caching and chunked prefill to be enabled together. Different from the reference PRs, this PR simplifies the logic of dealing with partial blocks (thanks to @rkooo567 for the suggestion). Here is the execution flow: In scheduler, when determining the new tokens to be scheduled and both chunked prefill and prefix caching are enabled. If all uncomputed tokens can be scheduled (i.e., the last chunk of the prompt), then schedule them all. Otherwise, we always schedule the number of tokens that is divisible by the block size. For example, if the remaining budget is 133 tokens and the block size is 16, we will only schedule (133//16)*16=112 tokens. Although this approach wastes some token budget, it makes the following process straightforward. In prepare input, if all scheduled tokens are cached, we only compute the last block. Note that: We cannot skip all blocks at this moment because model runner doesn't support this case. Currently when block manager determines prefix cache blocks, it will also skip the last block due to the same reason (e.g., https://github.com/vllm-project/vllm/blob/main/vllm/core/block/prefix_caching_block.py#L556 ). This can be improved in the future if we move prefix caching to scheduler so that this case won't happen anymore. Since we guarantee the scheduled tokens are divisible by block size, we don't need to consider partial blocks in prepare input. A test case for functional correctness is also added. Throughput benchmarking results: Model: neuralmagic/Meta-Llama-3-8B-Instruct-FP8 GPU: 1xL4 Number of requests: 600 Average prompt length: 637 (shared prefix ~180, cache hit rate ~20%) Max output length: 200 Block manager v1 Chunked prefill size 2048 Branch ChunkedPrefill PrefixCaching Elapsed Time (s) Throughput (tok/s) main x v 154.37 3631.2 main v x 173.84 3215.1 PR x v 155.88 3596.2 PR v x 174.18 3298.8 PR v v 142.81 3929.7 cc @rkooo567 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 6 rkooo567, Juelianqvq, sam-h-bean, zachzzc, ldmiao, and ywang96 reacted with thumbs up emoji ðŸš€ 5 cadedaniel, mgoin, sam-h-bean, ywang96, and hibukipanim reacted with rocket emoji All reactions ðŸ‘ 6 reactions ðŸš€ 5 reactions Copy link github-actions bot commented Aug 21, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac requested review from zhuohan123 and rkooo567 August 21, 2024 19:22 comaniac changed the title Prefix cache chunked prefill [Performance] Enable chunked prefill and prefix caching together Aug 21, 2024 Copy link Collaborator rkooo567 commented Aug 21, 2024 result seems very good!! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sighingnow commented Aug 21, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Hi @comaniac @rkooo567 I would like you folks to notice my last commit on #6144 ( a043643 ). Without it, this PR is still incorrect, and the error can be reproduced with even a single request: request 1: length 120 chunked prefill enabled prefix caching enabled max_num_batched_tokens = 64, max_num_seqs = 64 You will find that with this PR, at the first round, tokens[0:64] is prefilled, at the second round, tokens[96:119] is prefilled, and the tokens between 64 and 96 are skipped. This is because the num_computed_blocks is incorrectly updated as the whole block table for prompt tokens, rather than tokens that are prefilled at the first round. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 21, 2024 IIUC, this PR already guarantees every sequence will have at least one block to compute even it fully hits the cache, so it shouldn't trigger the issue you mentioned? If I missed anything, can you modify the unit test added in this PR so that the problem can be exposed and tested? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sighingnow commented Aug 21, 2024 IIUC, this PR already guarantees every sequence will have at least one block to compute even it fully hits the cache, so it shouldn't trigger the issue you mentioned? It is not about fully matched. In the case commented above, there are only 1 request, and the prefill are spited to [0:64] and [64:120], and the second part is treated as prefix matched as the computed_block_nums are updated to [0,1,2,3,4,5,6,7] after the first chunk prefill. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sighingnow commented Aug 21, 2024 IIUC, this PR already guarantees every sequence will have at least one block to compute even it fully hits the cache, so it shouldn't trigger the issue you mentioned? If I missed anything, can you modify the unit test added in this PR so that the problem can be exposed and tested? The test case in this PR didn't fail just because the max_num_batched_tokens (14) is smaller than the block size (16). Try larger value like 64. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 21, 2024 IIUC, this PR already guarantees every sequence will have at least one block to compute even it fully hits the cache, so it shouldn't trigger the issue you mentioned? If I missed anything, can you modify the unit test added in this PR so that the problem can be exposed and tested? The test case in this PR didn't fail just because the max_num_batched_tokens (14) is smaller than the block size (16). Try larger value like 64. The size 14 is used to test invalid size. The actual size being tested in this case is 16. Meanwhile, I tried all 16, 32 and 64 but none of them failed. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sighingnow commented Aug 21, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . IIUC, this PR already guarantees every sequence will have at least one block to compute even it fully hits the cache, so it shouldn't trigger the issue you mentioned? If I missed anything, can you modify the unit test added in this PR so that the problem can be exposed and tested? The test case in this PR didn't fail just because the max_num_batched_tokens (14) is smaller than the block size (16). Try larger value like 64. The size 14 is used to test invalid size. The actual size being tested in this case is 16. Meanwhile, I tried all 16, 32 and 64 but none of them failed. With max_num_batched_tokens=64, you need sequence length at least to 64 + 2 * block_size to reproduce the problem, 41 is not enough. max_num_batched_tokens=16/32 cannot reproduce the issue, too, as the second block are guaranteed to be recomputed in this PR. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 21, 2024 Ok I could reproduce the issue you pointed out. It actually only happens in block manager v1 as block manager v2 doesn't use this mechanism to mark computed blocks. This may also explain the too good speedup I got. I'll apply your fix in this PR and try to make the test cover this case. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 21, 2024 @sighingnow I applied your commit with some modifications. The test is also changed so that it will fail without fixing the issue in block manager v1. PTAL. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sighingnow commented Aug 22, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @sighingnow I applied your commit with some modifications. The test is also changed so that it will fail without fixing the issue in block manager v1. PTAL. Thanks! LGTM. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . rkooo567 reviewed Aug 22, 2024 View reviewed changes Copy link Collaborator rkooo567 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good. One question is should we just make scheduler handle prefix caching + chunked prefill correctly and make logics in model_runner simplified? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager_v1.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/scheduler.py Outdated raise ValueError(\"When enabling chunked prefill and \" \"prefix caching, max_num_batched_tokens \" \"(chunk size) must be dividable by \" \"block size, but got \" Copy link Collaborator rkooo567 Aug 22, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment can you also print chunk size and block size along with budget.token_budget % block_size ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author comaniac Aug 23, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It now looks like ValueError: When enabling chunked prefill and prefix caching, max_num_batched_tokens (chunk size) must be dividable by block size, but got chunk_size (30) % block_size (16) = 14 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/scheduler.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/scheduler.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/worker/model_runner.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sighingnow commented Aug 22, 2024 @sighingnow I applied your commit with some modifications. The test is also changed so that it will fail without fixing the issue in block manager v1. PTAL. Will the fix for v2 block manager be addressed by this PR as well? The behavior of v2-block-manager looks quite strange and I'm wondering if #7619 is related. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 22, 2024 @sighingnow I applied your commit with some modifications. The test is also changed so that it will fail without fixing the issue in block manager v1. PTAL. Will the fix for v2 block manager be addressed by this PR as well? The behavior of v2-block-manager looks quite strange and I'm wondering if #7619 is related. I have a fix in my local but it would be a separate PR â¤ï¸ 1 sighingnow reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link JaheimLee commented Aug 22, 2024 Is it for flash-attn backend only or for all backends? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 22, 2024 Is it for flash-attn backend only or for all backends? I've tested flash-attn and FlashInfer so at least these 2 backends work. Need to test xformers later. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Juelianqvq commented Aug 23, 2024 I've tested flash-attn and FlashInfer so at least these 2 backends work. Need to test xformers later. @comaniac https://github.com/vllm-project/vllm/blob/main/vllm/attention/backends/flashinfer.py#L360 Really supported here? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 23, 2024 I've tested flash-attn and FlashInfer so at least these 2 backends work. Need to test xformers later. @comaniac https://github.com/vllm-project/vllm/blob/main/vllm/attention/backends/flashinfer.py#L360 Really supported here? Yeah I noticed that too so not fully sure what's going on. Will find some time tomorrow for it. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 23, 2024 Updates: More tests are added. Chunk prefill does only support flash attention backend for now. My local test passed because it didn't schedule prefill and decode in the same batch. However, there shouldn't be a blocker for FlashInfer to support chunked prefill, so we should add this support in a follow-up PR. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator sighingnow commented Aug 24, 2024 Updates: More tests are added. Chunk prefill does only support flash attention backend for now. My local test passed because it didn't schedule prefill and decode in the same batch. However, there shouldn't be a blocker for FlashInfer to support chunked prefill, so we should add this support in a follow-up PR. May I know more why you choose to recompute the whole block if it is fully matched? Only recompute the last token is enough and requires no changes in scheduler, and it would be a bit more efficient. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 24, 2024 You're right it would be a bit more efficient to compute only the last token. Meanwhile I found that it might not be that hard to deal with prefix matching in scheduler so that this case would never happen in model runner. I'll give it a try All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac and others added 6 commits August 26, 2024 11:25 done d893717 test 1f16ece Add co-authors â€¦ 94315d4 Co-authored-by: Tao He <sighingnow@gmail.com>\nCo-authored-by: Juelianqvq <Juelianqvq@noreply.github.com> final 1daa758 fix 79563bf clean up f1e9548 comaniac added 2 commits August 26, 2024 11:26 comments and tests d57951f computel ast 324fcec comaniac force-pushed the prefix-cache-chunked-prefill branch\n    from b305e0d to 324fcec Compare August 26, 2024 19:59 Copy link Collaborator Author comaniac commented Aug 26, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @sighingnow changed to re-compute only the last token. PTAL. @rkooo567 I've tried to move prefix caching to scheduler and it's actually easy for default scheduler. For chunked prefill, we have to refactor the scheduler (e.g., .schedule() , ._schedule_prefill() , .get_new_tokens() ) and block manager (e.g., .can_allocate() ). Since we have to be careful with this refactor and it can be decoupled from this PR, I'll put it in a follow-up PR tracked by #7883 â¤ï¸ 2 sighingnow and rkooo567 reacted with heart emoji All reactions â¤ï¸ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 26, 2024 rkooo567 approved these changes Aug 28, 2024 View reviewed changes Copy link Collaborator rkooo567 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Generally looks good. I'd like to actually also add a warning if the block size is big and prefix caching + CP is enabled (because it can waste a lot of tokens). Maybe if block_size >32, we can print a warning? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tests/core/test_block_manager.py @@ -595,3 +595,43 @@ def test_sliding_window_multi_seq(): # assert all blocks are free now assert block_manager.get_num_free_gpu_blocks() == num_gpu_blocks def test_mark_blocks_as_computed_with_prefix_cache_and_chunked_prefill(): Copy link Collaborator rkooo567 Aug 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment do we have corresponding test in v2? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author comaniac Aug 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment We don't need to test v2 because v2 automatically mark touched blocks as computed. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/scheduler.py # to avoid partial block matching. block_size = self.cache_config.block_size reminder = budget.token_budget % block_size if reminder != 0: Copy link Collaborator rkooo567 Aug 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Btw, should we raise this exception at the engine start time instead and just add assert here? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author comaniac Aug 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I feel we could just raise here for now because this constraint should be able to be removed once we refactor the schedule to consider prefix caching. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author comaniac commented Aug 28, 2024 Generally looks good. I'd like to actually also add a warning if the block size is big and prefix caching + CP is enabled (because it can waste a lot of tokens). Maybe if block_size >32, we can print a warning? Sure I'll add the warning in a follow-up PR. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details comaniac merged commit e358053 into vllm-project : main Aug 28, 2024 54 checks passed Uh oh! There was an error while loading. Please reload this page . comaniac deleted the prefix-cache-chunked-prefill branch August 28, 2024 07:36 Copy link Contributor Juelianqvq commented Aug 28, 2024 Since this PR has been merged, both #6144 and #6819 can be closed, and are you willing to add me and @sighingnow as the co-authors? @comaniac All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Aug 28, 2024 Ah I intended to do that. Actually I put you two as co-authors in one commit of this PR and I thought it should work when the PR is merged but somehow it didn't...let me try to figure out how to fix that. Also cc @simon-mo All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . kushanam pushed a commit\n        to kushanam/vllm\n      that referenced\n      this pull request Aug 28, 2024 [Performance] Enable chunked prefill and prefix caching together ( vllâ€¦ â€¦ 1fcd098 â€¦m-project#7753 ) kushanam pushed a commit\n        to kushanam/vllm\n      that referenced\n      this pull request Aug 28, 2024 [Performance] Enable chunked prefill and prefix caching together ( vllâ€¦ â€¦ 2497d44 â€¦m-project#7753 ) Copy link Collaborator sighingnow commented Aug 29, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . To whom it may concern: after this PR there are still occasional crashes when prefix caching and chunked prefill are enabled at the same time on Nvidia GPUs (inside the flash_attn_varlen_func function in the prefix-enabled attention branch). I investigated the kernel input and find nothing wrong and cannot reproduce it when run the kernel standalone with the pickle saved inputs. I think there are still overflow bugs inside vllm-flash-attention, set the block_size to 256 could fix the issue and the crash disappeared under high pressure. ðŸ‘ 3 elfiegg, comaniac, and ashgold reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . flozi00 mentioned this pull request Sep 3, 2024 [WIP] Multi Step Chunked Prefill - Prefill Steps #8001 Closed comaniac added a commit\n        to comaniac/vllm\n      that referenced\n      this pull request Sep 3, 2024 Add co-authors of vllm-project#7753 â€¦ f13313c Co-authored-by: Tao He <sighingnow@gmail.com>\nCo-authored-by: Juelianqvq <Juelianqvq@noreply.github.com> comaniac mentioned this pull request Sep 3, 2024 [Performance] Enable chunked prefill and prefix caching together #8120 Merged Copy link ashgold commented Sep 3, 2024 To whom it may concern: after this PR there are still occasional crashes when prefix caching and chunked prefill are enabled at the same time on Nvidia GPUs (inside the flash_attn_varlen_func function in the prefix-enabled attention branch). I investigated the kernel input and find nothing wrong and cannot reproduce it when run the kernel standalone with the pickle saved outputs. I think there are still overflow bugs inside vllm-flash-attention, set the block_size to 256 could fix the issue and the crash disappeared under high pressure. This looks like a serious bug that needs to be fixed before it can go to production. Thanks for sharing the workaround solution as well. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member hmellor commented Sep 10, 2024 If you are using a model with max_model_len > 32K (i.e. Llama 3.1) then chunked prefill is enabled by default. However, this PR leaves the and not self.enable_prefix_caching condition in this automatic enabling of chunked prefill. This means that a user relying on the automatic enabling of chunked prefill might not notice it becoming disabled when they enable prefix caching. vllm/vllm/engine/arg_utils.py Lines 866 to 891\n      in da1a844 if self . enable_chunked_prefill is None : # If not explicitly set, enable chunked prefill by default for # long context (> 32K) models. This is to avoid OOM errors in the # initial memory profiling phase. if use_long_context : is_gpu = device_config . device_type == \"cuda\" use_sliding_window = ( model_config . get_sliding_window () is not None ) use_spec_decode = self . speculative_model is not None has_seqlen_agnostic_layers = ( model_config . contains_seqlen_agnostic_layers ( parallel_config )) if ( is_gpu and not use_sliding_window and not use_spec_decode and not self . enable_lora and not self . enable_prompt_adapter and not self . enable_prefix_caching and not has_seqlen_agnostic_layers ): self . enable_chunked_prefill = True logger . warning ( \"Chunked prefill is enabled by default for models with \" \"max_model_len > 32K. Currently, chunked prefill might \" \"not work with some features or models. If you \" \"encounter any issues, please disable chunked prefill \" \"by setting --enable-chunked-prefill=False.\" ) if self . enable_chunked_prefill is None : self . enable_chunked_prefill = False cc @comaniac All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author comaniac commented Sep 10, 2024 Good point. I'll file another PR to fix it. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac mentioned this pull request Sep 10, 2024 [MISC] Keep chunked prefill enabled by default with long context when prefix caching is enabled #8342 Merged Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Performance] Enable chunked prefill and prefix caching together ( vllâ€¦ â€¦ 4b6fa2b â€¦m-project#7753 )\n\nSigned-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Performance] Enable chunked prefill and prefix caching together ( vllâ€¦ â€¦ 49603e3 â€¦m-project#7753 )\n\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:09", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: Throughput, Throughput, tok/s | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:48:09", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Performance] Enable chunked prefill and prefix caching together (#7753)", "commit_message": "[Performance] Enable chunked prefill and prefix caching together (#7753)", "commit_date": "2024-08-28T00:36:31-07:00", "files_changed": ["tests/basic_correctness/test_chunked_prefill.py", "tests/core/test_block_manager.py", "tests/core/test_chunked_prefill_scheduler.py", "vllm/core/block_manager_v1.py", "vllm/core/block_manager_v2.py", "vllm/core/embedding_model_block_manager.py", "vllm/core/interfaces.py", "vllm/core/scheduler.py", "vllm/worker/model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 3, "num_non_test_files": 6, "only_test_files": 0, "only_non_test_files": 0, "num_files": 9, "num_hunks": 12, "num_edited_lines": 252, "num_non_test_edited_lines": 107, "commit_year": 2024}, "diff_text": "diff --git a/tests/basic_correctness/test_chunked_prefill.py b/tests/basic_correctness/test_chunked_prefill.py\nindex 1211e6ba5..fc6f829c3 100644\n--- a/tests/basic_correctness/test_chunked_prefill.py\n+++ b/tests/basic_correctness/test_chunked_prefill.py\n@@ -6,6 +6,7 @@ prefill requests are chunked.\n \n Run `pytest tests/models/test_chunked_prefill.py`.\n \"\"\"\n+from contextlib import nullcontext\n \n import pytest\n \n@@ -156,3 +157,68 @@ def test_models_with_fp8_kv_cache(\n         name_0=\"no_chunked_prefill\",\n         name_1=\"chunked_prefill\",\n     )\n+\n+\n+@pytest.mark.parametrize(\"max_tokens\", [16])\n+@pytest.mark.parametrize(\"enforce_eager\", [False])\n+@pytest.mark.parametrize(\"chunk_size\", [30, 32])\n+@pytest.mark.parametrize(\"use_v2_block_manager\", [False, True])\n+# NOTE: Increasing this in this suite will fail CI because we currently cannot\n+# reset distributed env properly. Use a value > 1 just when you test.\n+@pytest.mark.parametrize(\"tensor_parallel_size\", [1])\n+def test_with_prefix_caching(\n+    vllm_runner,\n+    max_tokens: int,\n+    enforce_eager: bool,\n+    chunk_size: int,\n+    use_v2_block_manager: bool,\n+    tensor_parallel_size: int,\n+) -> None:\n+    \"\"\"\n+    Checks exact match decode with and without prefix caching\n+    with chunked prefill enabled.\n+    \"\"\"\n+    model = \"meta-llama/Llama-2-7b-chat-hf\"\n+    # The common prompt has 142 tokens with Llama-2 tokenizer.\n+    common_prompt = \"You are a helpful AI assistant \" * 20\n+    unique_prompts = [\n+        \"Question\",  # Warmup\n+        \"Question\",  # Fully cached\n+        \"Another question\",  # Partial cached\n+    ]\n+    full_prompts = [f\"{common_prompt}\\n{p}\" for p in unique_prompts]\n+\n+    max_num_batched_tokens = max_num_seqs = chunk_size\n+    outputs = {}  # type: ignore\n+    check_result = True\n+    for enable in (True, False):\n+        with vllm_runner(\n+                model,\n+                dtype=\"half\",\n+                max_num_batched_tokens=max_num_batched_tokens,\n+                enable_chunked_prefill=True,\n+                enable_prefix_caching=enable,\n+                tensor_parallel_size=tensor_parallel_size,\n+                use_v2_block_manager=use_v2_block_manager,\n+                enforce_eager=enforce_eager,\n+                max_num_seqs=max_num_seqs,\n+        ) as vllm_model:\n+            # It should fail when prefix caching is enable and chunk\n+            # size is not a multiple of block size (16).\n+            should_fail = chunk_size % 16 != 0 and enable\n+            check_result &= not should_fail\n+            outputs[enable] = []\n+            # Send the request one-by-one to ensure the cache is populated.\n+            with pytest.raises(ValueError) if should_fail else nullcontext():\n+                for prompt in full_prompts:\n+                    outputs[enable] += vllm_model.generate_greedy([prompt],\n+                                                                  max_tokens)\n+\n+    # Check results only if we did not expect a failure.\n+    if check_result:\n+        check_outputs_equal(\n+            outputs_0_lst=outputs[False],\n+            outputs_1_lst=outputs[True],\n+            name_0=\"w/o prefix caching\",\n+            name_1=\"with prefix caching\",\n+        )\ndiff --git a/tests/core/test_block_manager.py b/tests/core/test_block_manager.py\nindex cd306b9e4..2ee9f2082 100644\n--- a/tests/core/test_block_manager.py\n+++ b/tests/core/test_block_manager.py\n@@ -595,3 +595,43 @@ def test_sliding_window_multi_seq():\n \n     # assert all blocks are free now\n     assert block_manager.get_num_free_gpu_blocks() == num_gpu_blocks\n+\n+\n+def test_mark_blocks_as_computed_with_prefix_cache_and_chunked_prefill():\n+    \"\"\"When prefix cache and chunked prefill are enabled, the block manager\n+    should only mark a chunk of blocks as computed instead of all blocks.\n+    \"\"\"\n+\n+    block_size = 4\n+    num_cpu_blocks = 0\n+    num_gpu_blocks = 16\n+    block_manager = BlockSpaceManagerV1(block_size,\n+                                        num_gpu_blocks,\n+                                        num_cpu_blocks,\n+                                        watermark=0,\n+                                        enable_caching=True)\n+\n+    # Set prompt size to have num_gpu_blocks - 1 full blocks.\n+    prompt_length = block_size * num_gpu_blocks - 1\n+\n+    # Allocate (reserve) all blocks.\n+    _, seq_group = create_dummy_prompt(\"0\",\n+                                       prompt_length,\n+                                       block_size=block_size)\n+    block_manager.allocate(seq_group)\n+    assert seq_group.seqs[0].n_blocks == num_gpu_blocks\n+\n+    # 1st chunk: Compute 2 and half blocks. Should mark 2 blocks as computed.\n+    token_chunk_size = int(block_size * 2.5)\n+    block_manager.mark_blocks_as_computed(seq_group, token_chunk_size)\n+    computed_blocks = block_manager.get_all_computed_blocks(seq_group.seqs[0])\n+    assert len(computed_blocks) == 2\n+\n+    # Actual computed tokens.\n+    seq_group.seqs[0].data.update_num_computed_tokens(token_chunk_size)\n+\n+    # 2nd chunk: Complete 3rd block and additional 4 blocks.\n+    token_chunk_size = int(block_size * 4.5)\n+    block_manager.mark_blocks_as_computed(seq_group, token_chunk_size)\n+    computed_blocks = block_manager.get_all_computed_blocks(seq_group.seqs[0])\n+    assert len(computed_blocks) == 7\ndiff --git a/tests/core/test_chunked_prefill_scheduler.py b/tests/core/test_chunked_prefill_scheduler.py\nindex 6d9c2f3eb..2f6ea632a 100644\n--- a/tests/core/test_chunked_prefill_scheduler.py\n+++ b/tests/core/test_chunked_prefill_scheduler.py\n@@ -562,3 +562,42 @@ def test_chunked_prefill_max_seqs():\n     assert len(get_sequence_groups(out)) == max_seqs\n     assert not running[0].is_prefill()\n     assert not running[1].is_prefill()\n+\n+\n+def test_perfix_caching():\n+    \"\"\"Verify allocating full blocks when prefix caching is enabled.\"\"\"\n+    block_size = 4\n+    max_seqs = 10\n+    max_model_len = 80\n+    max_num_batched_tokens = 64\n+    scheduler_config = SchedulerConfig(max_num_batched_tokens,\n+                                       max_seqs,\n+                                       max_model_len,\n+                                       enable_chunked_prefill=True)\n+    cache_config = CacheConfig(block_size,\n+                               1.0,\n+                               1,\n+                               \"auto\",\n+                               enable_prefix_caching=True)\n+    cache_config.num_cpu_blocks = 0\n+    cache_config.num_gpu_blocks = 32\n+    scheduler = Scheduler(scheduler_config, cache_config, None)\n+    running: List[SequenceGroup] = []\n+\n+    # Add seq groups to scheduler.\n+    for i in range(2):\n+        _, seq_group = create_dummy_prompt(str(i),\n+                                           block_size=block_size,\n+                                           prompt_length=50)\n+        scheduler.add_seq_group(seq_group)\n+        running.append(seq_group)\n+\n+    seq_group_meta, out = schedule_and_update_computed_tokens(scheduler)\n+    assert set(get_sequence_groups(out)) == set(running)\n+    assert seq_group_meta[0].token_chunk_size == 50\n+    # Verify it is chunked. Note that although the budget is 64-50=14,\n+    # we only allocate full blocks for prefix caching, so only 4*(14//4)=12\n+    # tokens are allocated.\n+    assert seq_group_meta[1].token_chunk_size == 12\n+    assert out.num_prefill_groups == 2\n+    assert out.num_batched_tokens == 62\ndiff --git a/vllm/core/block_manager_v1.py b/vllm/core/block_manager_v1.py\nindex 666723313..24ab9eb66 100644\n--- a/vllm/core/block_manager_v1.py\n+++ b/vllm/core/block_manager_v1.py\n@@ -681,14 +681,20 @@ class BlockSpaceManagerV1(BlockSpaceManager):\n             for block in block_table:\n                 block.last_accessed = access_time\n \n-    def compute_full_blocks_in_seq(self, seq: Sequence):\n+    def compute_full_blocks_in_seq(self, seq: Sequence, token_chunk_size: int):\n         if seq.seq_id not in self.block_tables:\n             return\n-        max_full_block = seq.get_len() // self.block_size - 1\n+\n+        # When chunked prefill is enabled, the computed full blocks\n+        # should be calculated based on the number of computed tokens.\n+        max_computed_tokens = (seq.data.get_num_computed_tokens() +\n+                               token_chunk_size)\n+        computed_full_blocks = max_computed_tokens // self.block_size\n+\n         block_table = self.block_tables[seq.seq_id]\n-        if max_full_block == -1:\n+        if computed_full_blocks == 0:\n             return\n-        for i in reversed(range(max_full_block)):\n+        for i in reversed(range(computed_full_blocks)):\n             if block_table[i].computed:\n                 break\n             block_table[i].computed = True\n@@ -718,10 +724,11 @@ class BlockSpaceManagerV1(BlockSpaceManager):\n         ids_list = [self.get_all_computed_blocks(seq) for seq in seqs]\n         return commonprefix([ids for ids in ids_list if ids != []])\n \n-    def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n+    def mark_blocks_as_computed(self, seq_group: SequenceGroup,\n+                                token_chunk_size: int):\n         if self.enable_caching:\n             for seq in seq_group.get_seqs():\n-                self.compute_full_blocks_in_seq(seq)\n+                self.compute_full_blocks_in_seq(seq, token_chunk_size)\n \n     def get_prefix_cache_hit_rate(self, device: Device) -> float:\n         if device == Device.GPU:\ndiff --git a/vllm/core/block_manager_v2.py b/vllm/core/block_manager_v2.py\nindex 7d2db43cb..b06385b06 100644\n--- a/vllm/core/block_manager_v2.py\n+++ b/vllm/core/block_manager_v2.py\n@@ -290,7 +290,8 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n             self._last_access_blocks_tracker.update_last_access(\n                 seq.seq_id, now)\n \n-    def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n+    def mark_blocks_as_computed(self, seq_group: SequenceGroup,\n+                                token_chunk_size: int):\n         # If prefix caching is enabled, mark immutable blocks as computed\n         # right after they have been scheduled (for prefill). This assumes\n         # the scheduler is synchronous so blocks are actually computed when\ndiff --git a/vllm/core/embedding_model_block_manager.py b/vllm/core/embedding_model_block_manager.py\nindex f16f66e99..c47d7d8df 100644\n--- a/vllm/core/embedding_model_block_manager.py\n+++ b/vllm/core/embedding_model_block_manager.py\n@@ -80,7 +80,8 @@ class EmbeddingModelBlockSpaceManager(BlockSpaceManager):\n                                       seq_group: List[Sequence]) -> List[int]:\n         return []\n \n-    def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n+    def mark_blocks_as_computed(self, seq_group: SequenceGroup,\n+                                token_chunk_size: int):\n         pass\n \n     def get_prefix_cache_hit_rate(self, device: Device) -> float:\ndiff --git a/vllm/core/interfaces.py b/vllm/core/interfaces.py\nindex becd0d2e7..96f8dd851 100644\n--- a/vllm/core/interfaces.py\n+++ b/vllm/core/interfaces.py\n@@ -115,7 +115,8 @@ class BlockSpaceManager(ABC):\n         pass\n \n     @abstractmethod\n-    def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n+    def mark_blocks_as_computed(self, seq_group: SequenceGroup,\n+                                token_chunk_size: int):\n         pass\n \n     @abstractmethod\ndiff --git a/vllm/core/scheduler.py b/vllm/core/scheduler.py\nindex fbc53afa3..51fde6e4e 100644\n--- a/vllm/core/scheduler.py\n+++ b/vllm/core/scheduler.py\n@@ -1226,7 +1226,8 @@ class Scheduler:\n         # will crash the vLLM instance / will not retry.\n         for scheduled_seq_group in scheduler_outputs.scheduled_seq_groups:\n             self.block_manager.mark_blocks_as_computed(\n-                scheduled_seq_group.seq_group)\n+                scheduled_seq_group.seq_group,\n+                scheduled_seq_group.token_chunk_size)\n \n         self._seq_group_metadata_cache[self.next_cache_id].reset()\n \n@@ -1457,10 +1458,27 @@ class Scheduler:\n         for seq in seqs:\n             num_new_tokens += seq.get_num_new_tokens()\n         assert num_new_tokens > 0\n-        # Chunk if a running request cannot fit in.\n-        # If number of seq > 1, it means it is doing beam search in a\n-        # decode phase. Do not chunk in that case.\n+        # Chunk if a running request cannot fit in the given budget.\n+        # If number of seq > 1, it means it is doing beam search\n+        # in a decode phase. Do not chunk.\n         if enable_chunking and len(seqs) == 1:\n-            num_new_tokens = min(num_new_tokens,\n-                                 budget.remaining_token_budget())\n+            remaining_token_budget = budget.remaining_token_budget()\n+            if self.cache_config.enable_prefix_caching:\n+                # When prefix caching is enabled, we always allocate\n+                # the number of new tokens that is dividable by the block size\n+                # to avoid partial block matching.\n+                block_size = self.cache_config.block_size\n+                reminder = budget.token_budget % block_size\n+                if reminder != 0:\n+                    raise ValueError(\"When enabling chunked prefill and \"\n+                                     \"prefix caching, max_num_batched_tokens \"\n+                                     \"(chunk size) must be dividable by \"\n+                                     \"block size, but got chunk_size \"\n+                                     f\"({budget.token_budget}) % block_size \"\n+                                     f\"({block_size}) = {reminder}\")\n+                if remaining_token_budget < num_new_tokens:\n+                    num_new_tokens = (remaining_token_budget //\n+                                      block_size) * block_size\n+            else:\n+                num_new_tokens = min(num_new_tokens, remaining_token_budget)\n         return num_new_tokens\ndiff --git a/vllm/worker/model_runner.py b/vllm/worker/model_runner.py\nindex f556e4ea1..2b287a5d2 100644\n--- a/vllm/worker/model_runner.py\n+++ b/vllm/worker/model_runner.py\n@@ -501,23 +501,48 @@ class ModelInputForGPUBuilder(ModelRunnerInputBuilderBase[ModelInputForGPU]):\n                             and self.sliding_window is None\n                             and inter_data.is_prompt)\n         inter_data.prefix_cache_hit = prefix_cache_hit\n-        if self.chunked_prefill_enabled and prefix_cache_hit:\n-            raise RuntimeError(\n-                \"chunked prefill cannot be used with prefix caching now.\")\n-\n-        # If prefix cache is hit, advance context length to bypass\n-        # hit blocks. Accordingly, input tokens, position and query length\n-        # have to be updated.\n-        if prefix_cache_hit:\n-            assert computed_block_nums is not None\n-            context_len = len(computed_block_nums) * self.block_size\n+\n+        if not prefix_cache_hit:\n+            return\n+\n+        assert computed_block_nums is not None\n+        # The cache hit prompt tokens in this sequence. Note that\n+        # this may be larger than the sequence length if chunked\n+        # prefill is enabled.\n+        prefix_cache_len = len(computed_block_nums) * self.block_size\n+        # The number of so far computed prompt tokens in this sequence.\n+        context_len = inter_data.context_lens[seq_idx]\n+        # The total number of prompt tokens in this sequence.\n+        # When chunked prefill is enabled, this is the token number of\n+        # computed chunks + current chunk.\n+        seq_len = inter_data.seq_lens[seq_idx]\n+        if prefix_cache_len <= context_len:\n+            # We already passed the cache hit region,\n+            # so do normal computation.\n+            pass\n+        elif context_len < prefix_cache_len < seq_len:\n+            # Partial hit. Compute the missing part.\n+            uncomputed_start = prefix_cache_len - context_len\n             inter_data.input_tokens[seq_idx] = inter_data.input_tokens[\n-                seq_idx][context_len:]\n+                seq_idx][uncomputed_start:]\n             inter_data.input_positions[seq_idx] = inter_data.input_positions[\n-                seq_idx][context_len:]\n+                seq_idx][uncomputed_start:]\n+            context_len = prefix_cache_len\n+\n             inter_data.context_lens[seq_idx] = context_len\n             inter_data.query_lens[\n                 seq_idx] = inter_data.seq_lens[seq_idx] - context_len\n+        elif seq_len <= prefix_cache_len:\n+            # Full hit. Only compute the last token to avoid\n+            # erroneous behavior. FIXME: Ideally we should directly\n+            # mark all tokens as computed in the scheduler and do not\n+            # schedule this sequence, so this case should not happen.\n+            inter_data.input_tokens[seq_idx] = inter_data.input_tokens[\n+                seq_idx][-1:]\n+            inter_data.input_positions[seq_idx] = inter_data.input_positions[\n+                seq_idx][-1:]\n+            inter_data.query_lens[seq_idx] = 1\n+            inter_data.context_lens[seq_idx] = inter_data.seq_lens[seq_idx] - 1\n \n     def _compute_for_sliding_window(self, inter_data: InterDataForSeqGroup,\n                                     seq_idx: int,", "apis": ["ModelRunner.generate_greedy", "Scheduler.schedule", "BlockSpaceManager.mark_blocks_as_computed"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/scheduler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/scheduler.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit introduces changes to core components (block manager, scheduler, model_runner) as well as test cases to support running with both chunked prefill and prefix caching enabled. These modifications update internal APIs to compute and mark blocks based on token chunks, adjusting block computation based on performance-related parameters. The changes are non-trivial and modify non-test source code (in modules like block_manager_v1.py, scheduler.py, etc.) that affect runtime request batching and token processing performance on CPU. The commit message categorizes it as a performance improvement, and the modifications aim to optimize resource allocation and computation scheduling. Therefore, the conditions for a performance/optimization commit are met.", "llm_api_reason": "The commit enables chunked prefill to work in tandem with prefix caching by modifying both the test suite and underlying components. In tests, new parametrized cases validate that generating outputs via greedy decoding behaves correctly when prefix caching is enabled (or not) with different chunk sizes. In the core code, methods in the block manager (both in v1 and v2, as well as via the common BlockSpaceManager interface) and in the scheduler are updated so that the number of computed blocks is now determined using a token_chunk_size parameter. In addition, the logic in the workerâ€™s model runner that handles prefix cache hits is refined to properly adjust the input tokens, positions, and query lengths when the computed prefix comes partly from cached blocks. Overall, these changes allow the libraryâ€™s highâ€level inference APIs to deliver correct token batching under the new combined optimization strategy while preserving performance."}
{"commit_hash": "2deb029d115dadd012ce5ea70487a207cb025493", "pr_url": "https://github.com/vllm-project/vllm/pull/7822", "pr_date": null, "timeline_text": "Copy link Collaborator comaniac commented Aug 23, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Closes #7619 With the investigation in #7619 , the root cause of block manager v2 low throughput with prefix caching is that block manager v2 doesn't mark prefix cache hit blocks as computed right after scheduling a batch. Specifically, the life cycle of a prefix cache block is as follows: The block is allocated by the first sequence of a batch. At this moment it will be added to  \"cached blocks\", but won't be marked as computed; otherwise the rest sequences in the same batch will skip the computation of this block and result in incorrect output. When the batch of sequence is finished (prefill+decode), the blocks are freed and added to the evictor. When the sequence of a following batch allocates the same block, it will be activated from the evictor and marked as computed. Here is a simple illustration. Note that we assume each sequence is in different batch. seq 1: [allocate-block-uncomputed] -- [prefill] --[decode1] --  ... -- [decodeN] -- [free-block]\nseq 2:                                [allocate-block-uncomputed] -- ...\n...\nseq N:                                                                                          [allocate-block-computed] -- ... Meanwhile, block manager v1 marks the block as computed right after the prefill is scheduled: seq 1: [allocate-block-uncomputed] -- [prefill] --[decode1] --  ... -- [decodeN] -- [free-block]\nseq 2:                                [allocate-block-computed] -- ...\n... This PR fixes this issue by marking allocated blocks as touched, and let scheduler mark them as computed to achieve the same behavior of block manager v1. Benchmark on L4 Command python3 benchmarks/benchmark_prefix_caching.py \\\n    --model neuralmagic/Meta-Llama-3-8B-Instruct-FP8 \\\n    --output-len 200 \\\n    --enable-prefix-caching \\\n    [--use-v2-block-manager] Branch Block Manager Warmup (s) Processed (s) main v1 14.5 13.4 main v2 23.6 13.4 PR v1 14.5 13.3 PR v2 14.4 13.3 cc @cadedaniel @rkooo567 @Yard1 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link github-actions bot commented Aug 23, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 reviewed Aug 23, 2024 View reviewed changes Copy link Collaborator Yard1 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM, some comments Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block/prefix_caching_block.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block/prefix_caching_block.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . comaniac added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 23, 2024 comaniac added 3 commits August 26, 2024 09:29 done w/o test 5daf36c add test 6d8a610 use set 020ac13 comaniac force-pushed the fix-v2-prefix-cache branch\n    from fd9c7c7 to 020ac13 Compare August 26, 2024 16:30 Yard1 approved these changes Aug 26, 2024 View reviewed changes Hide details View details comaniac merged commit 2deb029 into vllm-project : main Aug 26, 2024 42 checks passed Uh oh! There was an error while loading. Please reload this page . comaniac deleted the fix-v2-prefix-cache branch August 26, 2024 18:24 Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Performance][BlockManagerV2] Mark prefix cache block as computed aftâ€¦ â€¦ ed30706 â€¦er schedule ( vllm-project#7822 )\n\nSigned-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Performance][BlockManagerV2] Mark prefix cache block as computed aftâ€¦ â€¦ 9e9c3a0 â€¦er schedule ( vllm-project#7822 )\n\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:12", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: throughput | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:48:12", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python3 benchmarks/benchmark_prefix_caching.py --model neuralmagic/Meta-Llama-3-8B-Instruct-FP8 --output-len 200 --enable-prefix-caching [--use-v2-block-manager]", "commit_subject": "[Performance][BlockManagerV2] Mark prefix cache block as computed after schedule (#7822)", "commit_message": "[Performance][BlockManagerV2] Mark prefix cache block as computed after schedule (#7822)", "commit_date": "2024-08-26T11:24:53-07:00", "files_changed": ["tests/core/block/test_prefix_caching_block.py", "vllm/core/block/prefix_caching_block.py", "vllm/core/block_manager_v2.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 0, "num_files": 3, "num_hunks": 6, "num_edited_lines": 63, "num_non_test_edited_lines": 32, "commit_year": 2024}, "diff_text": "diff --git a/tests/core/block/test_prefix_caching_block.py b/tests/core/block/test_prefix_caching_block.py\nindex c2226870c..25be2dd13 100644\n--- a/tests/core/block/test_prefix_caching_block.py\n+++ b/tests/core/block/test_prefix_caching_block.py\n@@ -708,6 +708,37 @@ class TestPrefixCachingBlockAllocator:\n                                                token_ids=token_ids)\n         assert allocator.get_prefix_cache_hit_rate() > 0.99\n \n+    # Test case for marking cache hit blocks as computed right after\n+    # a batch of prefill sequences are scheduled.\n+    @staticmethod\n+    def test_touch_block():\n+        block_size = 16\n+        common_blocks = 4\n+        allocator = PrefixCachingBlockAllocator(num_blocks=8,\n+                                                block_size=block_size)\n+\n+        common_token_ids = list(range(block_size * common_blocks))\n+\n+        # Mimic the behavior of allocating the same block chain\n+        # (i.e., common prefix) for a batch of 3 different prefill sequences.\n+        for _ in range(3):\n+            blocks = TestPrefixCachingBlockAllocator.create_immutable_chain(\n+                block_size=block_size,\n+                token_ids=common_token_ids,\n+                allocator=allocator,\n+            )\n+            block_ids = [block.block_id for block in blocks]\n+            # The allocated blocks should  be marked as touched\n+            # but not computed.\n+            computed_block_ids = allocator.get_computed_block_ids(\n+                [], block_ids, skip_last_block_id=False)\n+            assert len(computed_block_ids) == 0\n+\n+        allocator.mark_blocks_as_computed([])\n+        computed_block_ids = allocator.get_computed_block_ids(\n+            [], block_ids, skip_last_block_id=False)\n+        assert len(computed_block_ids) == common_blocks\n+\n     @staticmethod\n     def create_immutable_chain(\n         block_size: int,\ndiff --git a/vllm/core/block/prefix_caching_block.py b/vllm/core/block/prefix_caching_block.py\nindex 432a6651a..a87e814cf 100644\n--- a/vllm/core/block/prefix_caching_block.py\n+++ b/vllm/core/block/prefix_caching_block.py\n@@ -1,6 +1,6 @@\n \"\"\"Token blocks.\"\"\"\n from os.path import commonprefix\n-from typing import Dict, FrozenSet, Iterable, List, Optional, Tuple\n+from typing import Dict, FrozenSet, Iterable, List, Optional, Set, Tuple\n \n from vllm.core.block.common import (CacheMetricData, CopyOnWriteTracker,\n                                     get_all_blocks_recursively)\n@@ -73,6 +73,11 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         # prefix hash will be in this dict, even if they have refcount 0.\n         self._cached_blocks: Dict[PrefixHash, BlockId] = {}\n \n+        # A list of immutable block IDs that have been touched by scheduler\n+        # and should be marked as computed after an entire batch of sequences\n+        # are scheduled.\n+        self._touched_blocks: Set[BlockId] = set()\n+\n         # Used to track status of each physical block id\n         self._block_tracker: Dict[BlockId, BlockTracker] = {}\n         for block_id in block_ids:\n@@ -438,10 +443,14 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         assert self._refcounter.get(block.block_id) > 0\n \n         if block.content_hash not in self._cached_blocks:\n-            # No cached content hash => Set this block as cached\n-            # (Note that this block is not computed yet =>\n-            #  Will be computed after free())\n+            # No cached content hash => Set this block as cached.\n+            # Note that this block cannot be marked as computed yet\n+            # because other sequences in the same batch cannot reuse\n+            # this block.\n             self._cached_blocks[block.content_hash] = block.block_id\n+            # Mark this block as touched so that it can be marked as\n+            # computed after the entire batch of sequences are scheduled.\n+            self._touched_blocks.add(block.block_id)\n             return block.block_id\n \n         # Reuse the cached content hash\n@@ -507,7 +516,10 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n                     \"Mark block as accessed which is not belonged to GPU\")\n \n     def mark_blocks_as_computed(self, block_ids: List[int]) -> None:\n-        raise NotImplementedError(\"Marking as computed is incremental\")\n+        # Mark all touched blocks as computed.\n+        for block_id in self._touched_blocks:\n+            self._block_tracker[block_id].computed = True\n+        self._touched_blocks.clear()\n \n     def _track_block_id(self, block_id: Optional[BlockId],\n                         computed: bool) -> None:\ndiff --git a/vllm/core/block_manager_v2.py b/vllm/core/block_manager_v2.py\nindex b7d9451f1..7d4919a0d 100644\n--- a/vllm/core/block_manager_v2.py\n+++ b/vllm/core/block_manager_v2.py\n@@ -287,11 +287,11 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n                 seq.seq_id, now)\n \n     def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n-        # The only need for mark block as computed is for prefix caching,\n-        # while currently we could determine whether one block is computed\n-        # or not by check whether it has content hash.\n-        # So this function is useless for block_v2.\n-        pass\n+        # If prefix caching is enabled, mark immutable blocks as computed\n+        # right after they have been scheduled (for prefill). This assumes\n+        # the scheduler is synchronous so blocks are actually computed when\n+        # scheduling the next batch.\n+        self.block_allocator.mark_blocks_as_computed([])\n \n     def get_common_computed_block_ids(\n             self, seqs: List[Sequence]) -> GenericSequence[int]:", "apis": ["PrefixCachingBlockAllocator.mark_blocks_as_computed", "BlockSpaceManagerV2.mark_blocks_as_computed"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/prefix_caching_block.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block_manager.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies both production code (in vllm/core/block/prefix_caching_block.py and vllm/core/block_manager_v2.py) and tests (in tests/core/block/test_prefix_caching_block.py). The changes include implementing logic to mark blocks as computed based on a touched blocks set, which streamlines the caching mechanism after scheduling, thus likely reducing redundant computation. Although the commit message mentions \"[Performance]\", our analysis confirms that the changes adjust internal handling to improve caching efficiencyâ€”a fundamental performance optimization. The modifications impact core APIs and address CPU-based performance improvements. Therefore, it satisfies the conditions for a performance-related commit.", "llm_api_reason": "The commit adds a new implementation for marking blocks as computed right after scheduling a batch of prefill sequences. In PrefixCachingBlockAllocator, the method mark_blocks_as_computed is now implemented to iterate over the touched blocks, mark them computed, and clear the touched blocks list. Meanwhile, in BlockSpaceManagerV2 the previously empty mark_blocks_as_computed method is updated to call the allocatorâ€™s new implementation. These changes affect the respective publicly exposed APIs."}
{"commit_hash": "fc7b8d1eefcbe837a56b7c080509417fe5167e6c", "pr_url": "https://github.com/vllm-project/vllm/pull/7364", "pr_date": "2024-08-09", "timeline_text": "Copy link Collaborator alexm-redhat commented Aug 9, 2024 This PR is a followup for #7162 to address leftover review comments and add some more small improvements. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 youkaichao reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction review comments from Kaichao and hengxinCheung acb7235 Copy link github-actions bot commented Aug 9, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . alexm-redhat mentioned this pull request Aug 9, 2024 [Performance] Optimize e2e overheads: Reduce python allocations #7162 Merged njhill reviewed Aug 9, 2024 View reviewed changes vllm/core/block_manager_v1.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Nick's comment 6297040 njhill approved these changes Aug 9, 2024 View reviewed changes Copy link Collaborator Author alexm-redhat commented Aug 9, 2024 /ready All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 9, 2024 comaniac enabled auto-merge (squash) August 9, 2024 15:47 Hide details View details comaniac merged commit fc7b8d1 into vllm-project : main Aug 9, 2024 58 of 60 checks passed Uh oh! There was an error while loading. Please reload this page . Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Performance] e2e overheads reduction: Small followup diff ( vllm-projâ€¦ â€¦ a1ff013 â€¦ect#7364 )\n\nSigned-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Performance] e2e overheads reduction: Small followup diff ( vllm-projâ€¦ â€¦ 87c9e4c â€¦ect#7364 )\n\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:14", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: CI, CI, CI", "analysis_extracted_at": "2025-09-07 17:48:14", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Performance] e2e overheads reduction: Small followup diff (#7364)", "commit_message": "[Performance] e2e overheads reduction: Small followup diff (#7364)", "commit_date": "2024-08-09T15:49:36Z", "files_changed": ["vllm/core/block_manager_v1.py", "vllm/sequence.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 2, "num_edited_lines": 7, "num_non_test_edited_lines": 7, "commit_year": 2024}, "diff_text": "diff --git a/vllm/core/block_manager_v1.py b/vllm/core/block_manager_v1.py\nindex 622aca66a..ad26d3c51 100644\n--- a/vllm/core/block_manager_v1.py\n+++ b/vllm/core/block_manager_v1.py\n@@ -336,9 +336,9 @@ class BlockSpaceManagerV1(BlockSpaceManager):\n \n         # Assign the self-attention block tables for each sequence.\n         if len(wait_seqs) == 1:\n-            self.block_tables[wait_seqs[0].seq_id] = block_table\n+            self.block_tables[seq.seq_id] = block_table\n         else:\n-            for seq in seq_group.get_seqs(status=SequenceStatus.WAITING):\n+            for seq in wait_seqs:\n                 self.block_tables[seq.seq_id] = block_table.copy()\n \n         # Allocate encoder sequence\ndiff --git a/vllm/sequence.py b/vllm/sequence.py\nindex ba477efc5..fd2dc9656 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -655,6 +655,9 @@ class SequenceGroup:\n         return [seq for seq in self.seqs if not seq.is_finished()]\n \n     def get_finished_seqs(self) -> List[Sequence]:\n+        if self.is_single_seq:\n+            return self.seqs if self.seqs[0].is_finished() else []\n+\n         return [seq for seq in self.seqs if seq.is_finished()]\n \n     def update_num_computed_tokens(self, num_new_computed_tokens: int):", "apis": ["BlockSpaceManagerV1", "SequenceGroup.get_finished_seqs"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/sequence.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies two source files (vllm/core/block_manager_v1.py and vllm/sequence.py), which are non-test files. The diff changes the way block tables are assigned and adds a fast-track branch in get_finished_seqs for the single-sequence case, both of which are internal optimizations to reduce overhead in end-to-end operations. Although the changes are small, they are intended to reduce runtime overhead and improve performance operations on CPU, as indicated by the commit message. These modifications are performance-related optimizations and not mere refactoring or bug fixes.", "llm_api_reason": "This commit improves performance by tweaking internal logic. In the BlockSpaceManagerV1 class (in vllm/core/block_manager_v1.py), the code now assigns a block table using the current sequenceâ€™s ID (using \"seq.seq_id\") rather than always taking the first waiting sequence; in the multi-sequence branch, it now iterates directly over the waiting sequences. In vllm/sequence.py, the get_finished_seqs method of the SequenceGroup class is modified to return the finished sequence in a singleâ€sequence group only if it is actually finished (empty otherwise), avoiding unnecessary overhead. These changes refine block table management and sequence status retrieval for end-to-end performance improvement."}
{"commit_hash": "660470e5a36b8e52083615ad7c85e9b4fd4c72ce", "pr_url": "https://github.com/vllm-project/vllm/pull/7193", "pr_date": "2024-08-06", "timeline_text": "Copy link Contributor xiaobochen123 commented Aug 6, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Using the AutoPrefixCache, the block_manager_v2 performs worse than v1. llama-3.1-8b, H800 Test 3510 cases from mmlu dataset llm = LLM(\n Â  Â  Â   model=path,\n Â  Â  Â   tensor_parallel_size=1,\n Â  Â  Â   trust_remote_code=True,\n Â  Â  Â   gpu_memory_utilization=0.8,\n Â  Â  Â   max_num_seqs=512,\n Â  Â  Â   enable_prefix_caching=True,\n Â  Â  Â   use_v2_block_manager=XXXX,\n Â   )\nâ€‹\nsampling_params = SamplingParams(temperature=1.0, max_tokens=1)\nâ€‹\nmmlu_dataset = [...] # 3510 cases from mmlu\nâ€‹\noutputs = llm.generate(\n Â  Â  Â   sampling_params=sampling_params,\n Â  Â  Â   prompt_token_ids=mmlu_dataset,\n Â   ) The self.free_table in evictor_v2::LRUEvictor is OrderedDict class that remembers the order in which keys were first inserted. The larger timestamps will be at the end. The reason V2 slower than V1 , is that V2 will go through all the free_table, in evict. V2 has the 'update',  It breaks the order. So we can move the block to the end when update. That can keep the lowest timestamp at the start. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 4 youkaichao, jon-chuang, mgoin, and shixianc reacted with thumbs up emoji All reactions ðŸ‘ 4 reactions Copy link github-actions bot commented Aug 6, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Aug 6, 2024 thanks for the contribution! cc @cadedaniel @zhuohan123 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . xiaobochen123 force-pushed the opt_evictor branch\n    from 52379a2 to 8f387b2 Compare August 6, 2024 08:04 opt evictor-v2 performance 0856f66 xiaobochen123 force-pushed the opt_evictor branch\n    from 8f387b2 to 0856f66 Compare August 6, 2024 08:19 Yard1 mentioned this pull request Aug 6, 2024 [Performance][Core] Optimize the performance of evictor v1 and v2 by applying a priority queue and lazy deletion #7209 Merged cadedaniel approved these changes Aug 6, 2024 View reviewed changes Copy link Collaborator cadedaniel commented Aug 6, 2024 Looks good to me, although the NeuralMagic folks have better understanding of the prefix caching paths. cc @robertgshaw2-neuralmagic All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Aug 6, 2024 Looks pretty reasonable to me, and the test also passed. I will go ahead to merge this. thanks again @xiaobochen123 for the contribution! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details youkaichao merged commit 660470e into vllm-project : main Aug 6, 2024 28 checks passed Uh oh! There was an error while loading. Please reload this page . comaniac mentioned this pull request Aug 16, 2024 [MISC] Add prefix cache hit rate to metrics #7606 Merged Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Core] Optimize evictor-v2 performance ( vllm-project#7193 ) â€¦ 1ed56fb Signed-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Core] Optimize evictor-v2 performance ( vllm-project#7193 ) â€¦ ba80305 Signed-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:19", "has_lm_eval": true, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: mmlu, mmlu | TEST: Test, test, CI", "analysis_extracted_at": "2025-09-07 17:48:19", "models": ["meta-llama/Llama-3.1-8B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,tensor_parallel_size=1,gpu_memory_utilization=0.8,max_num_seqs=512,enable_prefix_caching=True,use_v2_block_manager=True --tasks mmlu --batch_size auto"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --tensor-parallel-size 1 --enable-prefix-caching --use-v2-block-manager", "commit_subject": "[Core] Optimize evictor-v2 performance (#7193)", "commit_message": "[Core] Optimize evictor-v2 performance (#7193)", "commit_date": "2024-08-06T12:34:25-07:00", "files_changed": ["vllm/core/evictor_v2.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 6, "num_non_test_edited_lines": 6, "commit_year": 2024}, "diff_text": "diff --git a/vllm/core/evictor_v2.py b/vllm/core/evictor_v2.py\nindex 3dd12e2e2..5b1a208b7 100644\n--- a/vllm/core/evictor_v2.py\n+++ b/vllm/core/evictor_v2.py\n@@ -91,8 +91,9 @@ class LRUEvictor(Evictor):\n         # at the start of OrderedDict. Loop through all these blocks to\n         # find the one with maximum number of hashed tokens.\n         for _id, block in self.free_table.items():\n-            if evicted_block.last_accessed > block.last_accessed or (\n-                    evicted_block.last_accessed == block.last_accessed and\n+            if evicted_block.last_accessed < block.last_accessed:\n+                break\n+            if (evicted_block.last_accessed == block.last_accessed and\n                     evicted_block.num_hashed_tokens < block.num_hashed_tokens):\n                 evicted_block = block\n                 evicted_block_id = _id\n@@ -109,6 +110,7 @@ class LRUEvictor(Evictor):\n \n     def update(self, block_id: int, last_accessed: float):\n         self.free_table[block_id].last_accessed = last_accessed\n+        self.free_table.move_to_end(block_id)\n \n     def remove(self, block_id: int):\n         if block_id not in self.free_table:", "apis": ["None"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/api_server.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test file (vllm/core/evictor_v2.py) by altering the logic in the eviction loop (changing the condition from \">\" to \"<\" and reorganizing the conditional checks) and by adding a move_to_end call in the update method. These changes are non-trivial and target the core eviction algorithm's efficiency, likely to reduce unnecessary iterations or improve cache behavior. Although the commit message mentions \"Optimize evictor-v2 performance,\" the changes themselves are substantive algorithm improvements and not merely refactoring or minor fixes. They affect high-level internal performance on the CPU without specific hardware constraints. [ANSWER] YES [/ANSWER]", "llm_api_reason": "The commit optimizes the internal eviction logic in the LRUEvictor class (located in vllm/core/evictor_v2.py) by modifying the block selection conditions and updating the free_table ordering in the update() method. These changes are internal optimizations that do not alter any high-level or public Python APIs exposed by the repository."}
{"commit_hash": "6ce01f30667bbae33f112152e07a3b66b841078f", "pr_url": "https://github.com/vllm-project/vllm/pull/7051", "pr_date": "2024-08-01", "timeline_text": "Copy link Collaborator WoosukKwon commented Aug 1, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This PR optimizes the overhead of seq_group.get_seqs() , which was reported by @youkaichao . The solution is simple: We maintain seqs: List[Sequence] in addition to seqs_dict: Dict[int, Sequence] , and use seqs for all get_seqs calls. This leads to small performance boost (llama3 8B, 1xH100) Before: Throughput: 23.98 requests/s, 9914.65 tokens/s After: Throughput: 24.52 requests/s, 10138.92 tokens/s Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 2 njhill and mgoin reacted with rocket emoji All reactions ðŸš€ 2 reactions WoosukKwon added 2 commits August 1, 2024 16:13 [Performance] Optimize get_seqs 6aae340 yapf 1f5b63d WoosukKwon requested a review\n  from youkaichao August 1, 2024 23:19 Copy link github-actions bot commented Aug 1, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 1, 2024 njhill approved these changes Aug 1, 2024 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment lgtm! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/sequence.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/sequence.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Address review 4d3d3b9 youkaichao reviewed Aug 2, 2024 View reviewed changes vllm/sequence.py @@ -458,25 +459,24 @@ def __init__( self.prompt_adapter_request = prompt_adapter_request self.encoder_seq = encoder_seq self.trace_headers = trace_headers self._first_seq = next(iter(self.seqs_dict.values())) Copy link Member youkaichao Aug 2, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think you can still keep self._first_seq = seqs[0] , and use it to replace self.seqs[0] Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author WoosukKwon Aug 2, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think it doesn't hurt much to use seqs[0] without caching it? _first_seq was introduced to avoid the overhead of retrieving a value from the dictionary. I believe the overhead of seqs[0] will be negligible even if it's Python. Also, since the sequence can be removed, I feel more comfortable with self.seqs[0] than caching the sequence. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions youkaichao reviewed Aug 2, 2024 View reviewed changes Copy link Member youkaichao left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Glad to see it helps performance. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details WoosukKwon merged commit 6ce01f3 into main Aug 2, 2024 60 of 63 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the optimize-get-seqs branch August 2, 2024 01:29 youkaichao mentioned this pull request Aug 4, 2024 [Performance]: From SequenceGroup-native code to Sequence-native code #7116 Closed dtrifiro mentioned this pull request Aug 5, 2024 Sync with upstream@v0.5.4-7-g9118217f opendatahub-io/vllm#120 Closed mawong-amd mentioned this pull request Sep 3, 2024 Reconcile merge differences [fix Custom All Reduce; remove Torchrun & Cython] ROCm/vllm#163 Closed Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Performance] Optimize get_seqs ( vllm-project#7051 ) â€¦ a02da52 Signed-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Performance] Optimize get_seqs ( vllm-project#7051 ) â€¦ 2f46dfc Signed-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:23", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: Throughput, Throughput | TEST: CI, CI, CI", "analysis_extracted_at": "2025-09-07 17:48:23", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Performance] Optimize `get_seqs` (#7051)", "commit_message": "[Performance] Optimize `get_seqs` (#7051)", "commit_date": "2024-08-01T18:29:52-07:00", "files_changed": ["vllm/core/block_manager_v1.py", "vllm/sequence.py", "vllm/transformers_utils/detokenizer.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 1, "num_files": 3, "num_hunks": 9, "num_edited_lines": 44, "num_non_test_edited_lines": 44, "commit_year": 2024}, "diff_text": "diff --git a/vllm/core/block_manager_v1.py b/vllm/core/block_manager_v1.py\nindex e29eba375..d81648caa 100644\n--- a/vllm/core/block_manager_v1.py\n+++ b/vllm/core/block_manager_v1.py\n@@ -700,5 +700,5 @@ class BlockSpaceManagerV1(BlockSpaceManager):\n \n     def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n         if self.enable_caching:\n-            for seq in seq_group.seqs_dict.values():\n+            for seq in seq_group.get_seqs():\n                 self.compute_full_blocks_in_seq(seq)\ndiff --git a/vllm/sequence.py b/vllm/sequence.py\nindex ab50cfdfd..7ef9387c6 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -444,6 +444,7 @@ class SequenceGroup:\n         prompt_adapter_request: Optional[PromptAdapterRequest] = None,\n     ) -> None:\n         self.request_id = request_id\n+        self.seqs = seqs\n         self.seqs_dict = {seq.seq_id: seq for seq in seqs}\n         self.sampling_params = sampling_params\n         self.metrics = RequestMetrics(arrival_time=arrival_time,\n@@ -458,25 +459,24 @@ class SequenceGroup:\n         self.prompt_adapter_request = prompt_adapter_request\n         self.encoder_seq = encoder_seq\n         self.trace_headers = trace_headers\n-        self._first_seq = next(iter(self.seqs_dict.values()))\n \n     @property\n     def prompt(self) -> Optional[str]:\n         # All sequences in the group should have the same prompt.\n         # We use the prompt of an arbitrary sequence.\n-        return self._first_seq.prompt\n+        return self.seqs[0].prompt\n \n     @property\n     def prompt_token_ids(self) -> List[int]:\n         # All sequences in the group should have the same prompt.\n         # We use the prompt of an arbitrary sequence.\n-        return self._first_seq.prompt_token_ids\n+        return self.seqs[0].prompt_token_ids\n \n     @property\n     def multi_modal_data(self) -> \"MultiModalDataDict\":\n         # All sequences in the group should have the same multi-modal data.\n         # We use the multi-modal data of an arbitrary sequence.\n-        return self._first_seq.multi_modal_data\n+        return self.seqs[0].multi_modal_data\n \n     @property\n     def lora_int_id(self) -> int:\n@@ -512,7 +512,7 @@ class SequenceGroup:\n         #   in TPOT, rather than recalculating TTFT (since from the )\n         #   POV of the user, there is simply a long generation delay.\n         if (self.metrics.first_token_time is None\n-                and self.get_seqs()[0].get_output_len() == 1):\n+                and self.seqs[0].get_output_len() == 1):\n             self.metrics.first_token_time = time\n \n     def maybe_set_first_scheduled_time(self, time: float) -> None:\n@@ -548,9 +548,9 @@ class SequenceGroup:\n         self,\n         status: Optional[SequenceStatus] = None,\n     ) -> List[Sequence]:\n-        return list(self.seqs_dict.values()) if status is None else [\n-            seq for seq in self.seqs_dict.values() if seq.status == status\n-        ]\n+        if status is None:\n+            return self.seqs\n+        return [seq for seq in self.seqs if seq.status == status]\n \n     def is_encoder_decoder(self) -> bool:\n         return self.encoder_seq is not None\n@@ -559,22 +559,20 @@ class SequenceGroup:\n         return self.encoder_seq\n \n     def get_unfinished_seqs(self) -> List[Sequence]:\n-        return [\n-            seq for seq in self.seqs_dict.values() if not seq.is_finished()\n-        ]\n+        return [seq for seq in self.seqs if not seq.is_finished()]\n \n     def get_finished_seqs(self) -> List[Sequence]:\n-        return [seq for seq in self.seqs_dict.values() if seq.is_finished()]\n+        return [seq for seq in self.seqs if seq.is_finished()]\n \n     def update_num_computed_tokens(self, num_new_computed_tokens: int):\n         \"\"\"Update number of tokens computed so far.\"\"\"\n-        for seq in self.seqs_dict.values():\n+        for seq in self.seqs:\n             if not seq.is_finished():\n                 seq.data.update_num_computed_tokens(num_new_computed_tokens)\n \n     def get_num_uncomputed_tokens(self) -> int:\n         num_uncomputed_tokens = 0\n-        for seq in self.get_seqs():\n+        for seq in self.seqs:\n             if not seq.is_finished():\n                 num_uncomputed_tokens += seq.data.get_num_uncomputed_tokens()\n         return num_uncomputed_tokens\n@@ -583,7 +581,7 @@ class SequenceGroup:\n         # Optimization. We don't need to call get_seqs if we don't need to\n         # filter by states.\n         if status is None:\n-            return len(self.seqs_dict)\n+            return len(self.seqs)\n \n         return len(self.get_seqs(status))\n \n@@ -602,23 +600,25 @@ class SequenceGroup:\n         if seq.seq_id in self.seqs_dict:\n             raise ValueError(f\"Sequence {seq.seq_id} already exists.\")\n         self.seqs_dict[seq.seq_id] = seq\n+        self.seqs.append(seq)\n \n     def remove(self, seq_id: int) -> None:\n-        if seq_id not in self.seqs_dict:\n+        seq = self.seqs_dict.pop(seq_id, None)\n+        if seq is None:\n             raise ValueError(f\"Sequence {seq_id} not found.\")\n-        del self.seqs_dict[seq_id]\n+        self.seqs.remove(seq)\n \n     def is_finished(self) -> bool:\n-        return all(seq.is_finished() for seq in self.get_seqs())\n+        return all(seq.is_finished() for seq in self.seqs)\n \n     def is_prefill(self) -> bool:\n         # Every sequence should be in the same stage.\n-        return self.get_seqs()[0].is_prefill()\n+        return self.seqs[0].is_prefill()\n \n     def __repr__(self) -> str:\n         return (f\"SequenceGroup(request_id={self.request_id}, \"\n                 f\"sampling_params={self.sampling_params}, \"\n-                f\"num_seqs={len(self.seqs_dict)})\")\n+                f\"num_seqs={len(self.seqs)})\")\n \n \n class SequenceGroupMetadata:\ndiff --git a/vllm/transformers_utils/detokenizer.py b/vllm/transformers_utils/detokenizer.py\nindex 76f418674..001af67f3 100644\n--- a/vllm/transformers_utils/detokenizer.py\n+++ b/vllm/transformers_utils/detokenizer.py\n@@ -40,7 +40,7 @@ class Detokenizer:\n         assert prms is not None\n \n         # We can pick any sequence for the prompt.\n-        seq = next(iter(seq_group.seqs_dict.values()))\n+        seq = seq_group.get_seqs()[0]\n         # Only prompt, without the generated token.\n         all_token_ids = seq.get_token_ids()\n         prompt_token_ids = all_token_ids[:-1]", "apis": ["SequenceGroup.get_seqs", "SequenceGroup.prompt", "SequenceGroup.prompt_token_ids", "BlockSpaceManagerV1.mark_blocks_as_computed", "Detokenizer.decode_prompt_logprobs_inplace"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/sequence.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/detokenizer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/detokenizer.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The changes introduce an additional list (self.seqs) to store sequences and update various methods to use this list instead of iterating over a dictionary, which reduces overhead when fetching sequences. This modification is applied to key internal APIs (e.g., get_seqs, prompt, get_unfinished_seqs) that can impact performance by reducing unnecessary dictionary operations. Though the commit message contains the word \"Optimize\", careful examination shows that the changes modify core logic to improve performance rather than just renaming functions or refactoring without performance benefits. Additionally, the changes are applied to non-test source files and affect CPU performance in a testable way, satisfying the conditions for a performance-related commit.", "llm_api_reason": "This commit refactors how SequenceGroup exposes its sequences. Previously methods and properties (such as prompt, prompt_token_ids, and get_seqs) relied on an internal dictionary (seqs_dict) and a cached â€œ_first_seqâ€, but now they directly use the list (seqs). Similarly, BlockSpaceManagerV1.mark_blocks_as_computed and Detokenizer.decode_prompt_logprobs_inplace have been updated to fetch sequences from the optimized get_seqs() method. These changes improve performance by avoiding the overhead of reconstructing lists from a dict repeatedly."}
{"commit_hash": "89a84b0bb7b30706a02836234a94493ea8f780bf", "pr_url": "https://github.com/vllm-project/vllm/pull/6779", "pr_date": "2024-07-25", "timeline_text": "Copy link Contributor peng1999 commented Jul 25, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Using array.array in SequenceData greatly improves performance of make_tensor_with_pad in Sampler. Micro-benchmark using 1024 input length and 2048 batch size shows a great latency improvment (79ms to 22ms): Before: After: End-to-end test on qwen-1.5-0.5b model also shows improvement on throughput: main: Processed prompts: 100%|â–ˆâ–ˆâ–ˆ| 2048/2048 [01:22<00:00, 24.76it/s, est. speed input: 25352.26 toks/s, output: 3165.44 toks/s] This PR: Processed prompts: 100%|â–ˆâ–ˆâ–ˆ| 2048/2048 [01:09<00:00, 29.44it/s, est. speed input: 30150.97 toks/s, output: 3764.60 toks/s] BEFORE SUBMITTING, PLEASE READ THE CHECKLIST BELOW AND FILL IN THE DESCRIPTION ABOVE PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 8 casper-hansen, mgoin, robertgshaw2-redhat, LiuXiaoxuanPKU, comaniac, akai-shuuichi, Xu-Chen, and Shang-QY reacted with rocket emoji All reactions ðŸš€ 8 reactions Use array to speedup padding d2ab931 Copy link github-actions bot commented Jul 25, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which consists a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of default ones by unblocking the steps in your fast-check build on Buildkite UI. Once the PR is approved and ready to go, please make sure to run full CI as it is required to merge (or just use auto-merge). To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . reformat code d9c591e peng1999 changed the title Use array to speedup padding [Core] Use array to speedup padding Jul 25, 2024 Copy link Contributor casper-hansen commented Jul 25, 2024 Nice to see an 18% speedup from this optimization. Is it mainly for small models? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin reviewed Jul 25, 2024 View reviewed changes vllm/model_executor/sampling_metadata.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 25, 2024 Copy link Contributor Author peng1999 commented Jul 25, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Is it mainly for small models? Yes. This PR is for small models and large batch sizes. The from_sampling_metadata function, optimized by this PR, primarily runs on the CPU and is independent of logists. Therefore, it can overlap with the GPU work of model inference. It will only be on the critical path if its execution time exceeds that of model inference, which occurs with smaller models. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin approved these changes Jul 25, 2024 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM any concerns @youkaichao ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor daquexian commented Jul 25, 2024 Great PR! Would you mind sharing what tool you used to get this image, is it nsight system? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . youkaichao reviewed Jul 25, 2024 View reviewed changes vllm/sequence.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author peng1999 commented Jul 26, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Great PR! Would you mind sharing what tool you used to get this image, is it nsight system? Yes. The blue spans are recorded using NVTX. ðŸ‘ 1 daquexian reacted with thumbs up emoji â¤ï¸ 1 daquexian reacted with heart emoji All reactions ðŸ‘ 1 reaction â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . youkaichao approved these changes Jul 26, 2024 View reviewed changes Copy link Member youkaichao left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the great job!  Please merge the latest main to pass the tests. I once tried to replace the whole prompt/output tokens to numpy array, but it involves changing too much code, so I gave it up due to limited bandwidth. It's good to see this speedup with a self-contained change. cc @alexm-neuralmagic if you are planning to change the underlying data structure in block managers. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Merge remote-tracking branch 'upstream/main' into opt-array fb63840 Hide details View details youkaichao merged commit 89a84b0 into vllm-project : main Jul 26, 2024 72 checks passed Uh oh! There was an error while loading. Please reload this page . peng1999 deleted the opt-array branch July 30, 2024 09:58 dtrifiro mentioned this pull request Aug 5, 2024 Sync with upstream@v0.5.4-7-g9118217f opendatahub-io/vllm#120 Closed Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Core] Use array to speedup padding ( vllm-project#6779 ) â€¦ 62afef0 Signed-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Core] Use array to speedup padding ( vllm-project#6779 ) â€¦ 3f840ef Signed-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:26", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, latency, optimization | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:48:26", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Core] Use array to speedup padding (#6779)", "commit_message": "[Core] Use array to speedup padding (#6779)", "commit_date": "2024-07-25T21:31:31-07:00", "files_changed": ["vllm/model_executor/layers/sampler.py", "vllm/model_executor/sampling_metadata.py", "vllm/sequence.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 1, "num_files": 3, "num_hunks": 9, "num_edited_lines": 46, "num_non_test_edited_lines": 46, "commit_year": 2024}, "diff_text": "diff --git a/vllm/model_executor/layers/sampler.py b/vllm/model_executor/layers/sampler.py\nindex 5c376797a..121458f81 100644\n--- a/vllm/model_executor/layers/sampler.py\n+++ b/vllm/model_executor/layers/sampler.py\n@@ -220,7 +220,7 @@ def _apply_min_tokens_penalty(\n             seqs_to_penalize: List[int] = []\n             for j, seq_id in enumerate(seq_ids):\n                 seq_data = seq_group.seq_data[seq_id]\n-                if len(seq_data.output_token_ids) < min_tokens:\n+                if len(seq_data.output_token_ids_array) < min_tokens:\n                     seqs_to_penalize.append(j)\n \n             if seqs_to_penalize:\ndiff --git a/vllm/model_executor/sampling_metadata.py b/vllm/model_executor/sampling_metadata.py\nindex 390b5d173..27b37a9d5 100644\n--- a/vllm/model_executor/sampling_metadata.py\n+++ b/vllm/model_executor/sampling_metadata.py\n@@ -1,4 +1,5 @@\n import random\n+from array import array\n from dataclasses import dataclass\n from typing import Dict, List, Optional, Tuple\n \n@@ -329,8 +330,8 @@ class SamplingTensors:\n             user-defined seed for each sequence.\n         extra_entropy: extra entropy to use when generating seeds.\n         \"\"\"\n-        prompt_tokens: List[List[int]] = []\n-        output_tokens: List[List[int]] = []\n+        prompt_tokens: List[array] = []\n+        output_tokens: List[array] = []\n         top_ks: List[int] = []\n         temperatures: List[float] = []\n         top_ps: List[float] = []\n@@ -432,13 +433,15 @@ class SamplingTensors:\n                 if (seq_group.is_prompt\n                         and sampling_params.prompt_logprobs is not None):\n                     prefill_len = len(seq_group.prompt_logprob_indices)\n-                    prompt_tokens.extend([] for _ in range(prefill_len))\n-                    output_tokens.extend([] for _ in range(prefill_len))\n+                    prompt_tokens.extend(\n+                        array('l') for _ in range(prefill_len))\n+                    output_tokens.extend(\n+                        array('l') for _ in range(prefill_len))\n                 if seq_group.do_sample:\n                     for seq_id in seq_ids:\n                         seq_data = seq_group.seq_data[seq_id]\n-                        prompt_tokens.append(list(seq_data.prompt_token_ids))\n-                        output_tokens.append(list(seq_data.output_token_ids))\n+                        prompt_tokens.append(seq_data.prompt_token_ids_array)\n+                        output_tokens.append(seq_data.output_token_ids_array)\n \n         sampling_tensors = SamplingTensors.from_lists(\n             temperatures, top_ps, top_ks, min_ps, presence_penalties,\n@@ -454,9 +457,9 @@ class SamplingTensors:\n                    frequency_penalties: List[float],\n                    repetition_penalties: List[float],\n                    sampling_seeds: List[int], sample_indices: List[int],\n-                   prompt_tokens: List[List[int]],\n-                   output_tokens: List[List[int]], vocab_size: int,\n-                   extra_seeds_to_generate: int, device: torch.device,\n+                   prompt_tokens: List[array], output_tokens: List[array],\n+                   vocab_size: int, extra_seeds_to_generate: int,\n+                   device: torch.device,\n                    dtype: torch.dtype) -> \"SamplingTensors\":\n         # Note that the performance will be very bad without\n         # pinned memory.\ndiff --git a/vllm/sequence.py b/vllm/sequence.py\nindex 0cd4c7e71..72821ecea 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -3,6 +3,7 @@ import copy\n import enum\n import math\n from abc import ABC, abstractmethod\n+from array import array\n from collections import defaultdict\n from dataclasses import dataclass, field\n from typing import (TYPE_CHECKING, Dict, List, Mapping, Optional, Set, Tuple,\n@@ -119,10 +120,10 @@ class SequenceData:\n         prompt_token_ids: List[int],\n         output_token_ids: Optional[List[int]] = None,\n     ) -> None:\n-        self._prompt_token_ids: List[int] = list(prompt_token_ids)\n+        self._prompt_token_ids = array('l', prompt_token_ids)\n         self._prompt_token_ids_tuple: Tuple[int, ...] = tuple(prompt_token_ids)\n-        self._output_token_ids: List[int] = (\n-            list(output_token_ids) if output_token_ids is not None else [])\n+        self._output_token_ids = array(\n+            'l', output_token_ids if output_token_ids is not None else [])\n \n         self.cumulative_logprob = 0.0\n         # The number of tokens that are computed (that run against the model).\n@@ -132,8 +133,8 @@ class SequenceData:\n         self._update_cached_all_tokens()\n \n     def _update_cached_all_tokens(self):\n-        self._cached_all_token_ids: List[int] = (self._prompt_token_ids +\n-                                                 self._output_token_ids)\n+        self._cached_all_token_ids: List[int] = list(self._prompt_token_ids +\n+                                                     self._output_token_ids)\n \n     @property\n     def prompt_token_ids(self) -> Tuple[int, ...]:\n@@ -141,19 +142,27 @@ class SequenceData:\n \n     @prompt_token_ids.setter\n     def prompt_token_ids(self, new_prompt_token_ids) -> None:\n-        self._prompt_token_ids = list(new_prompt_token_ids)\n+        self._prompt_token_ids = array('l', new_prompt_token_ids)\n         self._prompt_token_ids_tuple = tuple(new_prompt_token_ids)\n         self._update_cached_all_tokens()\n \n+    @property\n+    def prompt_token_ids_array(self) -> array:\n+        return self._prompt_token_ids\n+\n     @property\n     def output_token_ids(self) -> Tuple[int, ...]:\n         return tuple(self._output_token_ids)\n \n     @output_token_ids.setter\n     def output_token_ids(self, new_output_token_ids) -> None:\n-        self._output_token_ids = list(new_output_token_ids)\n+        self._output_token_ids = array('l', new_output_token_ids)\n         self._update_cached_all_tokens()\n \n+    @property\n+    def output_token_ids_array(self) -> array:\n+        return self._output_token_ids\n+\n     def append_token_id(self, token_id: int, logprob: float) -> None:\n         self._output_token_ids.append(token_id)\n         self._cached_all_token_ids.append(token_id)", "apis": ["vllm.sequence.SequenceData.prompt_token_ids_array", "vllm.sequence.SequenceData.output_token_ids_array", "vllm.model_executor.sampling_metadata.SamplingTensors.from_lists"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/sequence.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/sampling_metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies several non-test source files (sampler.py, sampling_metadata.py, sequence.py) and replaces list-based token id storage and appending with the use of Python's built-in \"array\" type. This change likely reduces memory overhead and may provide speed improvements when padding or concatenating sequences, thus improving the performance of core operations. The commit message \"[Core] Use array to speedup padding (#6779)\" aligns with the technical modifications, which are non-trivial and affect high-level API performance. These changes are aimed at CPU performance improvement and are testable without specialized GPU or hardware requirements. Therefore, the commit qualifies as a performance or optimization related change.", "llm_api_reason": "The commit updates several files to change the underlying type used for storing token ID lists from Python lists to array objects. In the sequence module, the initialization and setters for prompt and output token IDs now convert to arrays (â€œlâ€ type) and additional properties (prompt_token_ids_array and output_token_ids_array) are provided for access. In the sampling metadata module, the expected types for prompt_tokens and output_tokens are changed from List[List[int]] to List[array] (again â€œlâ€ type) to optimize padding operations. Also, in the sampler layer, the logic now uses the new output_token_ids_array property rather than output_token_ids. These changes affect the public APIs related to token ID access and the API for constructing sampling tensors from lists of token IDs via arrays."}
{"commit_hash": "9ed82e7074a18e25680ab106fc846364ad97bc00", "pr_url": "https://github.com/vllm-project/vllm/pull/6520", "pr_date": "2024-07-17", "timeline_text": "Copy link Collaborator Yard1 commented Jul 17, 2024 Small performance improvements in different components, discovered during profiling. Look at commit list for details! PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Yard1 added 4 commits July 17, 2024 14:11 Cache importlib in ModelRegistry c5e350b Fast return for get_common_computed_block_ids f269738 chunk_list into an iterator a36da80 Cache _first_seq in SequenceGroup 47ce44f Copy link github-actions bot commented Jul 17, 2024 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only trigger fastcheck CI to run, which consists only a small and essential subset of tests to quickly catch errors with the flexibility to run extra individual tests on top (you can do this by unblocking test steps in the Buildkite run). Full CI run is still required to merge this PR so once the PR is ready to go, please make sure to run it. If you need all test signals in between PR commits, you can trigger full CI as well. To run full CI, you can do one of these: Comment /ready on the PR Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 requested a review\n  from njhill July 17, 2024 21:15 Copy link Collaborator Author Yard1 commented Jul 17, 2024 /ready All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 17, 2024 Yard1 added 3 commits July 17, 2024 14:16 Lint 69d73a3 Lint bbef0e1 Lint 34c30df comaniac approved these changes Jul 17, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Yard1 enabled auto-merge (squash) July 17, 2024 21:52 rkooo567 approved these changes Jul 17, 2024 View reviewed changes Yard1 added 4 commits July 17, 2024 15:06 Fix test 6b45138 Fix f27f653 Lint 31e4c76 Fix dd897db cadedaniel approved these changes Jul 18, 2024 View reviewed changes Copy link Collaborator cadedaniel left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Some test failure Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member DarkLight1337 commented Jul 18, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . It looks like you are calling list after chunk_list in each case. Wouldn't that defeat the point of making it a generator function? Edit: Never mind, I see it being used in https://github.com/vllm-project/vllm/blob/main/vllm/core/block/block_table.py#L265 To make the code a bit cleaner (by reducing the number of list calls), I suggest adding a new generator function iter_chunk_list to be used in for loops (e.g. in the above case), while keeping the existing semantics of chunk_list . All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin approved these changes Jul 18, 2024 View reviewed changes Fix ebf4794 Yard1 disabled auto-merge July 18, 2024 20:13 Yard1 enabled auto-merge (squash) July 18, 2024 20:13 Yard1 added 2 commits July 18, 2024 20:17 Merge branch 'upstream_main' into small_improvements 5eddc37 Merge branch 'upstream_main' into small_improvements e39f05c simon-mo disabled auto-merge July 19, 2024 19:10 simon-mo merged commit 9ed82e7 into main Jul 19, 2024 Yard1 deleted the small_improvements branch July 19, 2024 22:17 xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Misc] Small perf improvements ( vllm-project#6520 ) 2660a29 mawong-amd mentioned this pull request Sep 3, 2024 Reconcile merge differences [fix Custom All Reduce; remove Torchrun & Cython] ROCm/vllm#163 Closed Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Misc] Small perf improvements ( vllm-project#6520 ) â€¦ b1401bc Signed-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Misc] Small perf improvements ( vllm-project#6520 ) â€¦ b0b4998 Signed-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:29", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: profiling | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:48:29", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Misc] Small perf improvements (#6520)", "commit_message": "[Misc] Small perf improvements (#6520)", "commit_date": "2024-07-19T12:10:56-07:00", "files_changed": ["tests/core/block/test_block_manager_v2.py", "tests/core/block/test_cpu_gpu_block_allocator.py", "vllm/core/block/block_table.py", "vllm/core/block/prefix_caching_block.py", "vllm/model_executor/models/__init__.py", "vllm/sequence.py", "vllm/utils.py"], "functions_changed": [], "stats": {"num_test_files": 2, "num_non_test_files": 5, "only_test_files": 0, "only_non_test_files": 0, "num_files": 7, "num_hunks": 11, "num_edited_lines": 69, "num_non_test_edited_lines": 50, "commit_year": 2024}, "diff_text": "diff --git a/tests/core/block/test_block_manager_v2.py b/tests/core/block/test_block_manager_v2.py\nindex d0ca09c4b..d7863a9ae 100644\n--- a/tests/core/block/test_block_manager_v2.py\n+++ b/tests/core/block/test_block_manager_v2.py\n@@ -249,10 +249,13 @@ def test_append_slots(block_size, prompt_len, num_slots_to_append,\n \n     # Expect consumed blocks to be new blocks required to support the new slots.\n     expected_consumed_blocks = len(\n-        chunk_list(\n-            list(\n-                range(prompt_len + num_slots_to_append + num_lookahead_slots)),\n-            block_size)) - len(chunk_list(list(range(prompt_len)), block_size))\n+        list(\n+            chunk_list(\n+                list(\n+                    range(prompt_len + num_slots_to_append +\n+                          num_lookahead_slots)),\n+                block_size))) - len(\n+                    list(chunk_list(list(range(prompt_len)), block_size)))\n     assert num_consumed_blocks == expected_consumed_blocks\n \n \ndiff --git a/tests/core/block/test_cpu_gpu_block_allocator.py b/tests/core/block/test_cpu_gpu_block_allocator.py\nindex 15b76d909..a9e38d404 100644\n--- a/tests/core/block/test_cpu_gpu_block_allocator.py\n+++ b/tests/core/block/test_cpu_gpu_block_allocator.py\n@@ -58,10 +58,10 @@ def test_allocate_immutable_block(num_cpu_blocks: int, num_gpu_blocks: int,\n \n     unique_token_ids = list(\n         range((num_cpu_blocks + num_gpu_blocks) * block_size))\n-    gpu_token_ids = chunk_list(unique_token_ids[:num_gpu_blocks * block_size],\n-                               block_size)\n-    cpu_token_ids = chunk_list(unique_token_ids[num_gpu_blocks * block_size:],\n-                               block_size)\n+    gpu_token_ids = list(\n+        chunk_list(unique_token_ids[:num_gpu_blocks * block_size], block_size))\n+    cpu_token_ids = list(\n+        chunk_list(unique_token_ids[num_gpu_blocks * block_size:], block_size))\n \n     assert allocator.get_num_free_blocks(Device.CPU) == num_cpu_blocks\n     assert allocator.get_num_free_blocks(Device.GPU) == num_gpu_blocks\ndiff --git a/vllm/core/block/block_table.py b/vllm/core/block/block_table.py\nindex 49e63c231..06b816eb3 100644\n--- a/vllm/core/block/block_table.py\n+++ b/vllm/core/block/block_table.py\n@@ -1,3 +1,4 @@\n+import math\n from typing import List, Optional\n \n from vllm.core.block.common import BlockList\n@@ -337,10 +338,17 @@ class BlockTable:\n         This is required for the scheduler to determine whether a sequence can\n         continue generation, or if it must be preempted.\n         \"\"\"\n+        # Math below is equivalent to:\n+        # all_token_ids = token_ids + [-1] * num_lookahead_slots\n+        # token_blocks = self._chunk_token_blocks_for_append(all_token_ids)\n+        # return len(token_blocks)\n \n-        all_token_ids = token_ids + [-1] * num_lookahead_slots\n-        token_blocks = self._chunk_token_blocks_for_append(all_token_ids)\n-        return len(token_blocks)\n+        num_token_ids = len(token_ids) + num_lookahead_slots\n+        first_chunk_size = self._block_size - (self._num_full_slots %\n+                                               self._block_size)\n+        num_token_blocks = (1 + math.ceil(\n+            (num_token_ids - first_chunk_size) / self._block_size))\n+        return num_token_blocks\n \n     def _chunk_token_blocks_for_append(\n             self, token_ids: List[int]) -> List[List[int]]:\n@@ -351,6 +359,7 @@ class BlockTable:\n         \"\"\"\n         first_chunk_size = self._block_size - (self._num_full_slots %\n                                                self._block_size)\n-        token_blocks = [token_ids[:first_chunk_size]] + chunk_list(\n-            token_ids[first_chunk_size:], self._block_size)\n+        token_blocks = [token_ids[:first_chunk_size]]\n+        token_blocks.extend(\n+            chunk_list(token_ids[first_chunk_size:], self._block_size))\n         return token_blocks\ndiff --git a/vllm/core/block/prefix_caching_block.py b/vllm/core/block/prefix_caching_block.py\nindex f272e23ee..d102ad404 100644\n--- a/vllm/core/block/prefix_caching_block.py\n+++ b/vllm/core/block/prefix_caching_block.py\n@@ -552,9 +552,12 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         # runner.\n \n         # It returns a list of int although type annotation says list of string.\n+        if len(computed_seq_block_ids) == 1:\n+            return computed_seq_block_ids[0]\n+\n         return commonprefix([\n             ids for ids in computed_seq_block_ids  # type: ignore\n-            if ids != []\n+            if ids\n         ])\n \n     def get_num_blocks_touched(self,\ndiff --git a/vllm/model_executor/models/__init__.py b/vllm/model_executor/models/__init__.py\nindex 87508a116..aa5a70757 100644\n--- a/vllm/model_executor/models/__init__.py\n+++ b/vllm/model_executor/models/__init__.py\n@@ -1,3 +1,4 @@\n+import functools\n import importlib\n from typing import Dict, List, Optional, Type\n \n@@ -98,6 +99,14 @@ _ROCM_PARTIALLY_SUPPORTED_MODELS: Dict[str, str] = {\n \n class ModelRegistry:\n \n+    @staticmethod\n+    @functools.lru_cache(maxsize=128)\n+    def _get_model(model_arch: str):\n+        module_name, model_cls_name = _MODELS[model_arch]\n+        module = importlib.import_module(\n+            f\"vllm.model_executor.models.{module_name}\")\n+        return getattr(module, model_cls_name, None)\n+\n     @staticmethod\n     def load_model_cls(model_arch: str) -> Optional[Type[nn.Module]]:\n         if model_arch in _OOT_MODELS:\n@@ -114,10 +123,7 @@ class ModelRegistry:\n                     \"Model architecture %s is partially supported by ROCm: %s\",\n                     model_arch, _ROCM_PARTIALLY_SUPPORTED_MODELS[model_arch])\n \n-        module_name, model_cls_name = _MODELS[model_arch]\n-        module = importlib.import_module(\n-            f\"vllm.model_executor.models.{module_name}\")\n-        return getattr(module, model_cls_name, None)\n+        return ModelRegistry._get_model(model_arch)\n \n     @staticmethod\n     def get_supported_archs() -> List[str]:\ndiff --git a/vllm/sequence.py b/vllm/sequence.py\nindex 1cebf68d4..6c12a01bd 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -457,24 +457,25 @@ class SequenceGroup:\n         self.prompt_adapter_request = prompt_adapter_request\n         self.encoder_seq = encoder_seq\n         self.trace_headers = trace_headers\n+        self._first_seq = next(iter(self.seqs_dict.values()))\n \n     @property\n     def prompt(self) -> Optional[str]:\n         # All sequences in the group should have the same prompt.\n         # We use the prompt of an arbitrary sequence.\n-        return next(iter(self.seqs_dict.values())).prompt\n+        return self._first_seq.prompt\n \n     @property\n     def prompt_token_ids(self) -> List[int]:\n         # All sequences in the group should have the same prompt.\n         # We use the prompt of an arbitrary sequence.\n-        return next(iter(self.seqs_dict.values())).prompt_token_ids\n+        return self._first_seq.prompt_token_ids\n \n     @property\n     def multi_modal_data(self) -> \"MultiModalDataDict\":\n         # All sequences in the group should have the same multi-modal data.\n         # We use the multi-modal data of an arbitrary sequence.\n-        return next(iter(self.seqs_dict.values())).multi_modal_data\n+        return self._first_seq.multi_modal_data\n \n     @property\n     def lora_int_id(self) -> int:\ndiff --git a/vllm/utils.py b/vllm/utils.py\nindex f3025a68d..f906d8258 100644\n--- a/vllm/utils.py\n+++ b/vllm/utils.py\n@@ -415,9 +415,10 @@ def init_kmp_env():\n     os.environ['KMP_REDUCTION_BARRIER_PATTERN'] = \"dist,dist\"\n \n \n-def chunk_list(lst: List[T], chunk_size: int) -> List[List[T]]:\n+def chunk_list(lst: List[T], chunk_size: int):\n     \"\"\"Yield successive chunk_size chunks from lst.\"\"\"\n-    return [lst[i:i + chunk_size] for i in range(0, len(lst), chunk_size)]\n+    for i in range(0, len(lst), chunk_size):\n+        yield lst[i:i + chunk_size]\n \n \n def cdiv(a: int, b: int) -> int:", "apis": ["BlockTable.get_num_token_blocks", "ModelRegistry.load_model_cls", "SequenceGroup.prompt", "SequenceGroup.prompt_token_ids", "SequenceGroup.multi_modal_data"], "affected_paths": [], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes modifications in multiple non-test source files (e.g., in vllm/core/block/block_table.py, vllm/model_executor/models/__init__.py, vllm/sequence.py, and vllm/utils.py) with changes aimed at improving performance. For instance, it replaces a list-building approach with a mathematical calculation for token chunks, introduces caching via lru_cache to avoid repetitive imports, and optimizes repeated dictionary iteration by storing a value. These modifications are non-trivial changes to production code and target CPU performance improvements rather than bug fixes or simple refactoring. Hence, the commit satisfies the specified conditions.", "llm_api_reason": "The commit makes several minor performance and code cleanup improvements. In tests, it wraps generator calls from a modified chunk_list to ensure correct list conversion. In the core, it updates the block tableâ€™s logic for computing token blocks using math.ceil instead of recomputing list lengths. It also caches the first sequence in SequenceGroup to avoid repeatedly iterating over the sequence dictionary for properties like prompt, prompt_token_ids and multi_modal_data. Finally, it adds an lru_cache wrapper to the model lookup in ModelRegistry.load_model_cls. These changes affect the public interfaces that users rely on for model loading and sequence management."}
{"commit_hash": "3476ed0809ec91a3457da0cb90543133a4f4b519", "pr_url": "https://github.com/vllm-project/vllm/pull/5602", "pr_date": "2024-07-02", "timeline_text": "Copy link Collaborator alexm-redhat commented Jun 17, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This PR optimizes block_manager_v2 python logic to make it comparable to block_manager_v1. The goal is to enable block_manager_v2 by default as part of the spec decode project. The issues optimized are: Python Block object allocations/deallocations are expensive on the hot-path of iterative batching, so a block pool is used to cache block objects. Any string/list duplication should be avoided, especially for token id lists Modified Prefix Caching Block/Allocator to avoid any full traversals of block_ids by using dynamic/incremental style computations Redid the way access all blocks updates timestamps by deferring the actual updates to free(..) of sequences Here is initial performance comparison for both standard and prefix-cache enabled runs: Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 cadedaniel reacted with heart emoji ðŸš€ 5 cadedaniel, mgoin, robertgshaw2-redhat, zhuohan123, and CatherineSue reacted with rocket emoji All reactions â¤ï¸ 1 reaction ðŸš€ 5 reactions robertgshaw2-redhat requested a review\n  from cadedaniel June 17, 2024 14:58 alexm-redhat marked this pull request as draft June 17, 2024 15:02 cadedaniel reviewed Jun 18, 2024 View reviewed changes vllm/sequence.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block_manager_v2.py block_ids = self.block_tables[seq.seq_id].physical_block_ids assert all(b is not None for b in block_ids) Copy link Collaborator cadedaniel Jun 17, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment can we keep these in for correctness? can have a flag strict_mode which checks these only in testing / not in production Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I have added \"assert block_id is not None\" checks into BlockList so the invariant of \"assert all(b is not None for b in block_ids)\" is always kept. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jun 25, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment awesome Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/naive_block.py Outdated block_size: int, block_id: Optional[int] = None): # Please keep sync with the __init__() # (Calling __init__() directly raises linter errors) Copy link Collaborator cadedaniel Jun 17, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Can we ignore the linter error instead of duplicating code ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This actually works! Thanks for the suggestion Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated if block_token_ids: blocks.extend( self._allocator.allocate_immutable_group( Copy link Collaborator cadedaniel Jun 17, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: we can name it allocate_immutable_blocks to reduce new concepts. can also rename the bs=1 path to be allocate_immutable_block so contrast is clear. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good idea, renamed the functions as you proposed. In addition renamed allocate_mutable => allocate_mutable_block Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated Comment on lines 143 to 196 blocks = self. _blocks [self._num_full_slots // self._block_size:] blocks = self. blocks [self._num_full_slots // self._block_size:] Copy link Collaborator cadedaniel Jun 17, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment is this working? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yeah, this invokes the property blocks(..) and it returns self._blocks.list() Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jun 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment oh gotcha Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions 3 hidden conversations Load moreâ€¦ vllm/core/block/naive_block.py Outdated token_ids=token_ids, block_size=block_size, block_id=physical_block_id) block.block_pool_id = block_pool_id Copy link Collaborator cadedaniel Jun 17, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment can we avoid extending the block API for this optimization? we can keep a mapping of object address to block pool id in this class Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yeah, just replaced with simple class member Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 cadedaniel reacted with heart emoji All reactions â¤ï¸ 1 reaction vllm/core/block/naive_block.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block/naive_block.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block/naive_block.py Outdated assert block.block_id is not None self._free_block_id(block.block_id) block.block_id = None def free(self, block: Block) -> None: Copy link Collaborator cadedaniel Jun 17, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: for readability, have this invoke free_block_id instead of _free_block_id Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good catch, modified to invoke free_block_id directly Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/cpu_gpu_block_allocator.py Outdated @@ -149,6 +169,17 @@ def allocate_immutable(self, prev_block: Optional[Block], return self._allocators[device].allocate_immutable( prev_block, token_ids) def free_block_id(self, block: Block) -> None: Copy link Collaborator cadedaniel Jun 18, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I ran out of time to review today. Can you help me understand why we need a new API for this // if there's no way to combine free_block and free_block_id ? ideally we have one way of freeing Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The issue is that inside cow_block_if_not_appendable(..) (in common.py) we decrement ref count for the block_id for this block, and then in the caller, we reuse the same block object while assigning to its block_id the newly allocated block id (self._block_id = (self._allocator.cow_block_if_not_appendable(..)). Same happens in prefix caching inside _free_block_id_for_block(..) when we promote a naive block to the immutable (prefix block) => we call return self._hashless_allocator.free_block_id(block), and at the caller reuse the same block object. Without the block pool a free() was simply setting block.block_id = None, but with block pool, free(..) is actually releasing the block itself, so the second free_block_id() is behaving more similar to block.block_id = None Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 19, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I will try to restructure the code a bit, so that we don't have the free_block_id. Will keep you posted about this issue. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jun 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Sounds good. It sounds like my original design should have had more thought on the distinction between Python block objects and block ids themselves. It's OK if we have some suboptimality given that, but also hope you're able to find a simple solution :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 20, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I was able to refactor the code so that only free() is used at all places. I think it is a good change since it forces an explicit free/alloc calls for block objects, and this avoids potential memory leaks (due to previous separation between the block_id and block - currently they are \"more fused\"). The main things I needed to change is CoW and promote_to_immutable (in prefix-caching). The change moves these two functions to the allocator level (outside of the block itself), since these functions free-and-reallocate a new block, which needs to be updated in the associated lists in block_table.py. To make this cleaner, I added a function in block_table.py that is called \"append_token_ids_and_update_allocator\". In addition, I redid the free() procedure of prefix-caching since it was a bit complicated, by separating the two main cases there: (1) immutable/promoted block and (2) mutable/hashless block. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 20, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I have verified performance it is even a little better now. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 20, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Also, I have squashed the relevant commits to \"refactor code so that only free() is used\" so it will be easier to see the changes I did only for this change. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 cadedaniel reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator cadedaniel commented Jun 18, 2024 Great work btw! thanks! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author alexm-redhat commented Jun 18, 2024 Updated the PR with performance fixes for prefix-caching block_manager_v2. The table above is updated with new numbers for both standard run and prefix-cache enabled run. ðŸŽ‰ 1 cadedaniel reacted with hooray emoji All reactions ðŸŽ‰ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author alexm-redhat commented Jun 18, 2024 Will start addressing review comments and cleaning up the PR ðŸ‘ 1 cadedaniel reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 reviewed Jun 18, 2024 View reviewed changes vllm/core/block/block_table.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link hibukipanim commented Jun 19, 2024 As the PR touches prefix caching and preparing v2-block-manager to be default, I was curious to see if the PR might resolve this correctness issue: #5543 (comment) . and you might be interested to know that when running with this branch (commit c1f650fa7f162eb48763d8eeb70081986379f7e1) with --enable-prefix-caching --use-v2-block-manager , the snippet in the linked issue crashes the server with: ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] Engine background task failed ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] Traceback ( most recent call last ): ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 40 , in _raise_exception_on_finish ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] task . result () ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 521 , in run_engine_loop ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] has_requests_in_progress = await asyncio . wait_for ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/lib/python3.10/asyncio/tasks.py\" , line 445 , in wait_for ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return fut . result () ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 495 , in engine_step ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] request_outputs = await self . engine . step_async () ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 226 , in step_async ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] output = await self . model_executor . execute_model_async ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/executor/gpu_executor.py\" , line 117 , in execute_model_async ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] output = await make_async ( self . driver_worker . execute_model ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/lib/python3.10/concurrent/futures/thread.py\" , line 58 , in run ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] result = self . fn ( * self . args , ** self . kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/utils/_contextlib.py\" , line 115 , in decorate_context ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return func ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/worker/worker.py\" , line 272 , in execute_model ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] output = self . model_runner . execute_model ( seq_group_metadata_list , ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/utils/_contextlib.py\" , line 115 , in decorate_context ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return func ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/worker/model_runner.py\" , line 736 , in execute_model ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] hidden_states = model_executable ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return self . _call_impl ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return forward_call ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 371 , in forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] hidden_states = self . model ( input_ids , positions , kv_caches , ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return self . _call_impl ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return forward_call ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 288 , in forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] hidden_states , residual = layer ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return self . _call_impl ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return forward_call ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 227 , in forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] hidden_states = self . self_attn ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return self . _call_impl ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return forward_call ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 161 , in forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] attn_output = self . attn ( q , k , v , kv_cache , attn_metadata ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return self . _call_impl ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return forward_call ( * args , ** kwargs ) ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/attention/layer.py\" , line 89 , in forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return self . impl . forward ( query , key , value , kv_cache , attn_metadata , ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/workspace/nm-vllm/vllm/attention/backends/flash_attn.py\" , line 338 , in forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] flash_attn_varlen_func ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/vllm_flash_attn/flash_attn_interface.py\" , line 1099 , in flash_attn_varlen_func ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return FlashAttnVarlenFunc . apply ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/torch/autograd/function.py\" , line 598 , in apply ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] return super (). apply ( * args , ** kwargs ) # type: ignore[misc] ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/vllm_flash_attn/flash_attn_interface.py\" , line 596 , in forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] out , q , k , v , out_padded , softmax_lse , S_dmask , rng_state = _flash_attn_varlen_forward ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] File \"/usr/local/lib/python3.10/dist-packages/vllm_flash_attn/flash_attn_interface.py\" , line 88 , in _flash_attn_varlen_forward ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] out , q , k , v , out_padded , softmax_lse , S_dmask , rng_state = flash_attn_cuda . varlen_fwd ( ERROR 06 - 19 07 : 45 : 58 async_llm_engine . py : 45 ] RuntimeError : out must have shape ( total_q , num_heads , head_size_og ) Exception in callback functools . partial ( < function _raise_exception_on_finish at 0x7f2bc22f4160 > , error_callback = < bound method AsyncLLMEngine . _error_callback of < vllm . engine . async_llm_engine . AsyncLLMEngine object at 0x7f2bb73e0910 >> ) handle : < Handle functools . partial ( < function _raise_exception_on_finish at 0x7f2bc22f4160 > , error_callback = < bound method AsyncLLMEngine . _error_callback of < vllm . engine . async_llm_engine . AsyncLLMEngine object at 0x7f2bb73e0910 >> ) > Traceback ( most recent call last ): File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 40 , in _raise_exception_on_finish task . result () File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 521 , in run_engine_loop has_requests_in_progress = await asyncio . wait_for ( File \"/usr/lib/python3.10/asyncio/tasks.py\" , line 445 , in wait_for return fut . result () File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 495 , in engine_step request_outputs = await self . engine . step_async () File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 226 , in step_async output = await self . model_executor . execute_model_async ( File \"/workspace/nm-vllm/vllm/executor/gpu_executor.py\" , line 117 , in execute_model_async output = await make_async ( self . driver_worker . execute_model File \"/usr/lib/python3.10/concurrent/futures/thread.py\" , line 58 , in run result = self . fn ( * self . args , ** self . kwargs ) File \"/usr/local/lib/python3.10/dist-packages/torch/utils/_contextlib.py\" , line 115 , in decorate_context return func ( * args , ** kwargs ) File \"/workspace/nm-vllm/vllm/worker/worker.py\" , line 272 , in execute_model output = self . model_runner . execute_model ( seq_group_metadata_list , File \"/usr/local/lib/python3.10/dist-packages/torch/utils/_contextlib.py\" , line 115 , in decorate_context return func ( * args , ** kwargs ) File \"/workspace/nm-vllm/vllm/worker/model_runner.py\" , line 736 , in execute_model hidden_states = model_executable ( File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl return self . _call_impl ( * args , ** kwargs ) File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl return forward_call ( * args , ** kwargs ) File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 371 , in forward hidden_states = self . model ( input_ids , positions , kv_caches , File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl return self . _call_impl ( * args , ** kwargs ) File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl return forward_call ( * args , ** kwargs ) File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 288 , in forward hidden_states , residual = layer ( File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl return self . _call_impl ( * args , ** kwargs ) File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl return forward_call ( * args , ** kwargs ) File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 227 , in forward hidden_states = self . self_attn ( File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl return self . _call_impl ( * args , ** kwargs ) File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl return forward_call ( * args , ** kwargs ) File \"/workspace/nm-vllm/vllm/model_executor/models/llama.py\" , line 161 , in forward attn_output = self . attn ( q , k , v , kv_cache , attn_metadata ) File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1532 , in _wrapped_call_impl return self . _call_impl ( * args , ** kwargs ) File \"/usr/local/lib/python3.10/dist-packages/torch/nn/modules/module.py\" , line 1541 , in _call_impl return forward_call ( * args , ** kwargs ) File \"/workspace/nm-vllm/vllm/attention/layer.py\" , line 89 , in forward return self . impl . forward ( query , key , value , kv_cache , attn_metadata , File \"/workspace/nm-vllm/vllm/attention/backends/flash_attn.py\" , line 338 , in forward flash_attn_varlen_func ( File \"/usr/local/lib/python3.10/dist-packages/vllm_flash_attn/flash_attn_interface.py\" , line 1099 , in flash_attn_varlen_func return FlashAttnVarlenFunc . apply ( File \"/usr/local/lib/python3.10/dist-packages/torch/autograd/function.py\" , line 598 , in apply return super (). apply ( * args , ** kwargs ) # type: ignore[misc] File \"/usr/local/lib/python3.10/dist-packages/vllm_flash_attn/flash_attn_interface.py\" , line 596 , in forward out , q , k , v , out_padded , softmax_lse , S_dmask , rng_state = _flash_attn_varlen_forward ( File \"/usr/local/lib/python3.10/dist-packages/vllm_flash_attn/flash_attn_interface.py\" , line 88 , in _flash_attn_varlen_forward out , q , k , v , out_padded , softmax_lse , S_dmask , rng_state = flash_attn_cuda . varlen_fwd ( RuntimeError : out must have shape ( total_q , num_heads , head_size_og ) The above exception was the direct cause of the following exception : Traceback ( most recent call last ): File \"uvloop/cbhandles.pyx\" , line 63 , in uvloop . loop . Handle . _run File \"/workspace/nm-vllm/vllm/engine/async_llm_engine.py\" , line 47 , in _raise_exception_on_finish raise AsyncEngineDeadError ( vllm . engine . async_llm_engine . AsyncEngineDeadError : Task finished unexpectedly . This should never happen ! Please open an issue on Github . See stack trace above for the actual cause . INFO 06 - 19 07 : 45 : 58 async_llm_engine . py : 158 ] Aborted request cmpl - 4 ce91102896f49d598ec6313f9629a10 - 0. INFO : 172.17 .0 . 1 : 47640 - \"POST /v1/completions HTTP/1.1\" 500 Internal Server Error ERROR : Exception in ASGI application All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author alexm-redhat commented Jun 19, 2024 @hibukipanim thanks for pointing this issue, I will check â¤ï¸ 1 hibukipanim reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . alexm-redhat marked this pull request as ready for review June 19, 2024 19:03 alexm-redhat force-pushed the block_manager_v2_perf branch\n      2 times, most recently\n    from 0148b6e to e08d643 Compare June 20, 2024 21:34 Yard1 reviewed Jun 21, 2024 View reviewed changes vllm/sequence.py Outdated @property def prompt_token_ids(self) -> List[int]: return self._prompt_token_ids Copy link Collaborator Yard1 Jun 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think we should return a tuple/shallow copy so that this and also output_token_ids doesn't get modified by mistake (and thus bypass _update_cached_all_tokens ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jun 25, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment yeah, what happens if someone modifies the prompt token ids / output token ids list? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good catch, changed the return types to be tuples. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I have changed the approach here to protect accesses to prompt_token_ids and output_token_ids. Now, it uses a class MonitoredList that records a timestamp of the last update, and based on that, the cached all tokens is updated. I did in this way to avoid changing all usages of the prompt/output token ids due to tuple change and also it avoids unnecessary copies of list => tuples which are also expensive. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 Yard1 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator Author alexm-redhat Jun 29, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @Yard1 found out that there is actually an issue with the deserialization with ray, so I have removed this and made the prompt/output token_ids accessors return tuples. It introduces a conversion for the output_token_ids to tuple but it seems not to be bad and the performance is still good. To make it work, I have propagated the tuple type upward in the vllm software stack, since we don't expect seq_data users to use these accessors to change data (but only via the append_token() function) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel commented Jun 21, 2024 ok looking All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cadedaniel reviewed Jun 26, 2024 View reviewed changes Copy link Collaborator cadedaniel left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment most comments are nits. big question is the design change around CoW/promotion (I think it's actually a bad design change). let's schedule some time to go over this sync as I think it will be faster than back and forth. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions examples/offline_inference.py Outdated Comment on lines 14 to 16 llm = LLM(model=\"facebook/opt-125m\") llm = LLM(model=\"facebook/opt-125m\", use_v2_block_manager=True, enable_prefix_caching=True) Copy link Collaborator cadedaniel Jun 20, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Let's leave this out for now Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 26, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment good catch, removed Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tests/core/block/test_prefix_caching_block.py first_chain = TestPrefixCachingBlockAllocator.create_immutable_chain( block_size=block_size, token_ids=token_ids, allocator=allocator, ) # mark all blocks in first chain as computed allocator.mark_blocks_as_computed(blocks) Copy link Collaborator cadedaniel Jun 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment TODO(cade) see why this api is no longer required Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated from vllm.utils import Device, cdiv, chunk_list # This class is an optimization to allow fast-access to physical block ids Copy link Collaborator cadedaniel Jun 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Let's write this as a docstring Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jun 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment suggest writing also how it achieves the optimization (can write docstrings for individual functions but it's more tedious) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Added Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated from vllm.utils import Device, cdiv, chunk_list # This class is an optimization to allow fast-access to physical block ids class BlockList: Copy link Collaborator cadedaniel Jun 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: would be great to have basic unit tests for this helper Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated from vllm.utils import Device, cdiv, chunk_list # This class is an optimization to allow fast-access to physical block ids class BlockList: Copy link Collaborator cadedaniel Jun 21, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: I have preference for putting helper methods/functions below the main class of the file, so the file can be read top-down Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment moved to block/common.py Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions 15 hidden conversations Load moreâ€¦ vllm/core/block_manager_v2.py Outdated Comment on lines 103 to 104 self._cached_computed_seq_blocks: Dict[SeqId, List[int]] = {} self._seq_last_access: Dict[SeqId, float] = {} Copy link Collaborator cadedaniel Jun 25, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment what's the motivation for raising these to BlockManger level? we should keep things simple at this layer unless there's good reason not to Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment There was a significant overhead in these function calls, since they traversed the full block lists. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Can we modify the API such that it allows caching the result // we don't have to traverse the full block lists? Two downsides: we expose more complexity in this layer than is necessary (this is tech debt we can live with, if it's too hard) we make it harder for other block managers to use prefix caching (we may have a block manager which specializes for another type, e.g. the newer models which use sliding window + normal attention). Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 30, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This is a good idea. I have refactored this logic out to two classes: ComputedBlocksTracker and LastAccessBlocksTracker so it will be easier to port the logic to other places. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager_v2.py Outdated Comment on lines 239 to 240 # TODO: Ask Cade how it may be possible to have # allocated block id inside the evictor Copy link Collaborator cadedaniel Jun 25, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment let's go over this Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager_v2.py block_ids = self.block_tables[seq.seq_id].physical_block_ids assert all(b is not None for b in block_ids) Copy link Collaborator cadedaniel Jun 25, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment awesome Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager_v2.py Outdated @@ -274,6 +285,43 @@ def mark_blocks_as_computed(self, seq_group: SequenceGroup): # So this function is useless for block_v2. pass def get_and_update_computed_block_ids(self, seqs): Copy link Collaborator cadedaniel Jun 25, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment docstring / typing Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment added Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/sequence.py Outdated @property def prompt_token_ids(self) -> List[int]: return self._prompt_token_ids Copy link Collaborator cadedaniel Jun 25, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment yeah, what happens if someone modifies the prompt token ids / output token ids list? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions alexm-redhat commented Jun 27, 2024 View reviewed changes Copy link Collaborator Author alexm-redhat left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Updated the PR with addressed review comments from Cade and Yard1. I have moved the CoW and Promo functionality back to the block and ensured that there is no new _free_block_id() interface to minimize interface changes. Also, I had moved the code a bit inside the prefix-caching allocator to make it more readable and easier to maintain. Verified that performance is still good, for both standard and prefix-cached runs. TODO: Fixing tests now Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/naive_block.py Outdated Comment on lines 12 to 19 # Used to pre-allocate block objects, in order to avoid excessive python # object allocations/deallocations. # The pool starts from \"pool_size\" objects and will increase to more objects # if necessary # # Note that multiple block objects may point to the same physical block id, # which is why this pool is needed, so that it will be easier to support # prefix caching and more complicated sharing of physical blocks. Copy link Collaborator Author alexm-redhat Jun 26, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Added docstring and moved BlockPool class to block/common.py Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py @@ -19,6 +19,28 @@ _DEFAULT_LAST_ACCESSED_TIME = -1 class BlockTracker: Copy link Collaborator Author alexm-redhat Jun 26, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Added Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated from vllm.utils import Device, cdiv, chunk_list # This class is an optimization to allow fast-access to physical block ids class BlockList: Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment moved to block/common.py Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated return self._block_ids def append_token_ids_and_update_allocator( Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Removed this function in favor of moving this logic back into block class Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated block: Block, token_ids: List[int], allocator: DeviceAwareBlockAllocator) -> Block: new_block = allocator.cow_block_if_not_appendable(block) if new_block: Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Removed Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions 7 hidden conversations Load moreâ€¦ vllm/sequence.py Outdated @property def prompt_token_ids(self) -> List[int]: return self._prompt_token_ids Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good catch, changed the return types to be tuples. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated from vllm.utils import Device, cdiv, chunk_list # This class is an optimization to allow fast-access to physical block ids Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Added Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py elif block_id in self.evictor: self.evictor.update(block_id, now) else: raise ValueError( \"Mark block as accessed which is not belonged to GPU\") def mark_blocks_as_computed(self, block_ids: List[int]) -> None: \"\"\"Mark blocks as computed , used in prefix caching.\"\"\" raise NotImplementedError(\"Marking as computed is incremental\") Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment For prefix caching, a block is \"computed\" when it is full, so it is possible to use the block.content_hash as the indicator for computed or not computed without the need from the scheduler to explicitly state it. Which is why the original implementation was not doing anything for that case, and this function was never called. I simply replaced the code with an error exception just to make sure it is indeed not used. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py Outdated self._update_num_token_ids() def _update_num_token_ids(self): Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment added Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager_v2.py Outdated Comment on lines 103 to 104 self._cached_computed_seq_blocks: Dict[SeqId, List[int]] = {} self._seq_last_access: Dict[SeqId, float] = {} Copy link Collaborator Author alexm-redhat Jun 27, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment There was a significant overhead in these function calls, since they traversed the full block lists. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member DarkLight1337 commented Jun 28, 2024 To speed up the CI queue for #5905 , I've cancelled the distributed tests for the latest CI run in this PR since they won't pass anyway until #5905 has been merged. Please merge main into your branch after that happens so that the CI can pass once again. ðŸ‘ 2 cadedaniel and alexm-redhat reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cadedaniel reviewed Jun 28, 2024 View reviewed changes vllm/core/block/block_table.py Outdated self._num_full_slots = len(token_ids) def update(self, blocks): Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: typing Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 30, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment added Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py elif block_id in self.evictor: self.evictor.update(block_id, now) else: raise ValueError( \"Mark block as accessed which is not belonged to GPU\") def mark_blocks_as_computed(self, block_ids: List[int]) -> None: \"\"\"Mark blocks as computed , used in prefix caching.\"\"\" raise NotImplementedError(\"Marking as computed is incremental\") Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Sounds good. let's delete the API? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/common.py allocator=self._allocator, block_id=None)) def increase_pool(self): Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: docstrings on public methods Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 30, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment mark_blocks_as_computed still used in block_manager_v1 added docstring Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 cadedaniel reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/core/block/block_table.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block/cpu_gpu_block_allocator.py Outdated Comment on lines 298 to 328 raise NotImplementedError device = Device.GPU return self._allocators[device].promote_to_immutable_block(block) Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment do we need this implementation and cow_block_if_not_appendable ? technically, vLLM does not support modification of block content for CPU-based allocators Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I assume this method is only invoked when appending tokens Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 30, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment yeah Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment add some comment when it's used? (I think they should be removed but seems I miss a case) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment You actually right, this is cpu-gpu allocator, so it is not doing the actual CoW or promo, since it is done only by the specific Naive or Prefix allocators, and they have these functions define via the base class BlockAllocator. Good catch! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 cadedaniel reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/core/block/cpu_gpu_block_allocator.py Outdated Comment on lines 376 to 379 if self._proxy.token_ids: return len(self._proxy.token_ids) else: return 0 Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Did you see my comment about token_ids being optional? It adds more complexity to the API, and leaks abstraction details here and other places that need to check if it's None before deciding behavior. If we want a no-op token id List for the undefined blocks, we can have a class which implements List and always returns 0 for len / raises NotImplemented for anything that writes. that way we don't have Optional / no branches checking for it everywhere Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 29, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I was able to remove the Optional from token_ids. Now it is the same as before. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 cadedaniel reacted with heart emoji All reactions â¤ï¸ 1 reaction vllm/core/block_manager_v2.py Outdated Comment on lines 103 to 104 self._cached_computed_seq_blocks: Dict[SeqId, List[int]] = {} self._seq_last_access: Dict[SeqId, float] = {} Copy link Collaborator cadedaniel Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Can we modify the API such that it allows caching the result // we don't have to traverse the full block lists? Two downsides: we expose more complexity in this layer than is necessary (this is tech debt we can live with, if it's too hard) we make it harder for other block managers to use prefix caching (we may have a block manager which specializes for another type, e.g. the newer models which use sliding window + normal attention). Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Yard1 reviewed Jun 28, 2024 View reviewed changes vllm/core/block_manager_v2.py Outdated Comment on lines 315 to 326 self._cached_computed_seq_blocks[seq_id] = computed_block_ids else: computed_block_ids = self._cached_computed_seq_blocks[seq_id] if len(computed_block_ids) < len(block_ids): # Incremental init for seq_id => Look only at the new blocks computed_block_ids = self.block_allocator.get_computed_block_ids(  # noqa: E501 computed_block_ids, block_ids) self._cached_computed_seq_blocks[ seq_id] = computed_block_ids else: # Cache HIT assert len(computed_block_ids) == len(block_ids) Copy link Collaborator Yard1 Jun 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This will still result in constant recomputation in the worst case. I think we can do the following: After the first run, if len(computed_block_ids) != len(block_ids) , we know that we will never add any extra blocks to computed_block_ids (since we'd have a gap otherwise). Therefore, we should save that as a boolean in the cache alongside the computed block ids In the subsequent runs, if the seq_id is present in cache, but the boolean is False, we just return the cached computed block ids without calling get_computed_block_ids . Otherwise, if the boolean is true, we call get_computed_block_ids for the new blocks and save in cache, with the len(computed_block_ids) == len(block_ids) boolean. let me know if this makes sense? I may be missing something here. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Yard1 Jun 28, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Here's the suggested change: def _get_and_update_computed_block_ids ( self , seqs ): \"\"\"Handles caching of per-sequence computed block ids. When a sequence appears for the first time, it traverses all of the blocks and detects the prefix of blocks that is computed. On the subsequent times, it only traverses the new blocks that were added and updates the already recorded prefix of blocks with the newly computed blocks. \"\"\" ret = [] for seq in seqs : seq_id = seq . seq_id # Get block ids of this sequence, while not considering the # last block block_ids = self . block_tables [ seq_id ]. physical_block_ids [: - 1 ] # Here we cache the detection of computed_block_ids for seq_id. # Since computed_block_ids form a prefix of block_ids, # the first time we see seq_id, we detect computed_block_ids # fully and store them in the cache. In the next times we see # seq_id, we detect computed_block_ids incrementally, by looking # only at the new blocks that come after the cached # computed_block_ids if seq_id not in self . _cached_computed_seq_blocks : # First time init for seq_id => Detect fully computed_block_ids = self . block_allocator . get_computed_block_ids ( # noqa: E501 [], block_ids ) self . _cached_computed_seq_blocks [ seq_id ] = ( computed_block_ids , len ( computed_block_ids ) >= len ( block_ids ) - 1 ) else : computed_block_ids , should_continue_adding = self . _cached_computed_seq_blocks [ seq_id ] if should_continue_adding : if len ( computed_block_ids ) < len ( block_ids ): # Incremental init for seq_id => Look only at the new blocks computed_block_ids = self . block_allocator . get_computed_block_ids ( # noqa: E501 computed_block_ids , block_ids ) self . _cached_computed_seq_blocks [ seq_id ] = ( computed_block_ids , len ( computed_block_ids ) >= len ( block_ids ) - 1 ) else : # Cache HIT assert len ( computed_block_ids ) == len ( block_ids ) ret . append ( computed_block_ids ) return ret Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 cadedaniel reacted with heart emoji All reactions â¤ï¸ 1 reaction Copy link Collaborator Author alexm-redhat Jun 29, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @Yard1 and I discussed this in more detail and this is a really good suggestion that should help with performance. Will add this to the algorithm. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jun 30, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @Yard1 Added your idea inside. All works. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions alexm-redhat force-pushed the block_manager_v2_perf branch\n    from 0cd4aae to ac9cbdc Compare June 30, 2024 11:50 Copy link Collaborator Author alexm-redhat commented Jun 30, 2024 @cadedaniel @Yard1 I have addressed the review comments, the PR is ready for a pass. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . alexm-redhat added 9 commits July 1, 2024 00:02 Optimize block_manager_v2 so it becomes the default 007b32d cleanups ea94e85 refactor code so that only free() is used e21c410 prefix_caching: refactor self._blocks to tracked blocks b5872d2 format 54d76ba cpu bug fix 0aecdb2 fixes d649055 fixes 92550b0 fix immutable promotion 4100268 23 hidden items Load moreâ€¦ alexm-redhat added 14 commits July 1, 2024 00:02 Refactor back token_ids based on Cade comments. b74d834 use tuples for seq_data prompt/output token_ids 179542b sync 7c0ce65 fix 4dd957e fix tests 325226f fix tests 29e9683 add Antoni's idea for improving caching of computed block ids by usinâ€¦ â€¦ c36f353 â€¦g the gap detection Based on Cade comment, refactored the seq last_access and cached compâ€¦ â€¦ d0b2ef9 â€¦uted blocks dicts to be encapsulated inside classes instead of simply embedded in block_manager_v2 cleanup bd65468 Cade's comments 3064208 fix test 2236d5e fix fork_seq 4ea6938 ping 82b31e8 ping2 3f1c2a1 alexm-redhat force-pushed the block_manager_v2_perf branch\n    from 6854308 to 3f1c2a1 Compare July 1, 2024 00:03 cadedaniel mentioned this pull request Jul 1, 2024 [misc][optimization] optimize data structure in allocator #5968 Closed cadedaniel reviewed Jul 1, 2024 View reviewed changes Copy link Collaborator cadedaniel left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment small comments only, let's go! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated block.append_token_ids(token_block) self._blocks[idx] = block  # Refresh the cached block_id Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment is this still necessary? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I redid the code so it is hidden inside the BlockList (by adding append_token_ids(block_idx, tokens) api func) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 1 cadedaniel reacted with hooray emoji All reactions ðŸŽ‰ 1 reaction vllm/core/block/block_table.py Outdated Comment on lines 301 to 303 cur_token_ids = block.token_ids if cur_token_ids is not None: token_ids.extend(cur_token_ids) Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Remove check now that it can't be None? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good catch! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/block_table.py Outdated Comment on lines 308 to 309 if not self._is_allocated: return 0 Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: I think we don't need this branch anymore. if it's not allocated, self.blocks will be empty Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice, removed Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/common.py Comment on lines +129 to +130 assert src_block_id is not None assert trg_block_id is not None Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: a little weird that we check a non-Optional is not None. but my guess it's due to python typing weakness... can ignore Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I changed the type to Optional[BlockId], I think it makes more sense Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 cadedaniel reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/core/block/cpu_gpu_block_allocator.py Outdated Comment on lines 298 to 328 raise NotImplementedError device = Device.GPU return self._allocators[device].promote_to_immutable_block(block) Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment add some comment when it's used? (I think they should be removed but seems I miss a case) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions 1 hidden conversation Load moreâ€¦ vllm/core/block/interfaces.py Outdated pass @abstractmethod def promote_to_immutable_block(self, block: Block) -> BlockId: \"\"\"NOTE: This should not be used besides Block\"\"\" Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment suggest keeping the NOTE in Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Added Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py Comment on lines +315 to +321 \"\"\"Decrements the refcount of the block. The block may be in two possible states: (1) immutable/cached or (2) mutable/hashless. In the first case, the refcount is decremented directly and the block may be possibly added to the evictor. In other case, hashless allocator free(..) with keep_block_object=True is called to only free the block id (since the block object may be reused by the caller) \"\"\" Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment love this :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py Outdated @@ -658,6 +801,7 @@ def content_hash(self) -> Optional[int]: if prev_block_hash is None and not is_first_block: return None assert len(self.token_ids) > 0 Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: do we need this assert given if not self.is_full ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment You right, removed Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block/prefix_caching_block.py Comment on lines +850 to +851 Note that currently, for a given sequence, we also skip the last block id for caching purposes, to avoid caching of a full sequence Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment does this work with lookahead scheduling (where potenially >1 block is modified in single step)? don't have to fix now but in the future we want speculative decoding x prefix caching to work Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think it should work since the blocks that are used for appending or speculative tokens won't be marked as computed, so they won't go into the common cache prefix. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 cadedaniel reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/core/block/prefix_caching_block.py Comment on lines +918 to +921 class LastAccessBlocksTracker: \"\"\"Manages the last access time of the tracked sequences, in order to allow an efficient update of allocator's block last access times \"\"\" Copy link Collaborator cadedaniel Jul 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment â¤ï¸ Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions alexm-redhat added 2 commits July 1, 2024 15:03 Cade's comments 2ff442d more Cade commants 3322f8c Copy link Collaborator Author alexm-redhat commented Jul 1, 2024 @cadedaniel fixed the nits, thanks for catching these issues! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cadedaniel approved these changes Jul 2, 2024 View reviewed changes Copy link Collaborator cadedaniel left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the excellent contribution! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions cadedaniel merged commit 3476ed0 into vllm-project : main Jul 2, 2024 kzawora-intel added a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Jul 2, 2024 habana_main rebase ( #71 ) â€¦ 5e1a565 * [Hardware][Intel] Optimize CPU backend and add more performance tips ( vllm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\n\n* [Docs] Add 4th meetup slides ( vllm-project#5509 )\n\n* [Misc] Add vLLM version getter to utils ( vllm-project#5098 )\n\n* [CI/Build] Simplify OpenAI server setup in tests ( vllm-project#5100 )\n\n* [Doc] Update LLaVA docs ( vllm-project#5437 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Kernel] Factor out epilogues from cutlass kernels ( vllm-project#5391 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\n\n* [MISC] Remove FP8 warning ( vllm-project#5472 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* Seperate dev requirements into lint and test ( vllm-project#5474 )\n\n* Revert \"[Core] Remove unnecessary copies in flash attn backend\" ( vllm-project#5478 )\n\n* [misc] fix format.sh ( vllm-project#5511 )\n\n* [CI/Build] Disable test_fp8.py ( vllm-project#5508 )\n\n* [Kernel] Disable CUTLASS kernels for fp8 ( vllm-project#5505 )\n\n* Add `cuda_device_count_stateless` ( vllm-project#5473 )\n\n* [Hardware][Intel] Support CPU inference with AVX2 ISA ( vllm-project#5452 )\n\n* [Misc] Fix arg names in quantizer script ( vllm-project#5507 )\n\n* bump version to v0.5.0.post1 ( vllm-project#5522 )\n\n* [CI/Build][Misc] Add CI that benchmarks vllm performance on those PRs with `perf-benchmarks` label ( vllm-project#5073 )\n\nCo-authored-by: simon-mo <simon.mo@hey.com>\n\n* [CI/Build] Disable LLaVA-NeXT CPU test ( vllm-project#5529 )\n\n* [Kernel] Fix CUTLASS 3.x custom broadcast load epilogue ( vllm-project#5516 )\n\n* [Misc] Fix arg names ( vllm-project#5524 )\n\n* [ Misc ] Rs/compressed tensors cleanup ( vllm-project#5432 )\n\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\n\n* [Kernel] Suppress mma.sp warning on CUDA 12.5 and later ( vllm-project#5401 )\n\n* [mis] fix flaky test of test_cuda_device_count_stateless ( vllm-project#5546 )\n\n* [Core] Remove duplicate processing in async engine ( vllm-project#5525 )\n\n* [misc][distributed] fix benign error in `is_in_the_same_node` ( vllm-project#5512 )\n\n* [Docs] Add ZhenFund as a Sponsor ( vllm-project#5548 )\n\n* [Doc] Update documentation on Tensorizer ( vllm-project#5471 )\n\n* [Bugfix] Enable loading FP8 checkpoints for gpt_bigcode models  ( vllm-project#5460 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix typo in Pallas backend ( vllm-project#5558 )\n\n* [Core][Distributed] improve p2p cache generation ( vllm-project#5528 )\n\n* Add ccache to amd ( vllm-project#5555 )\n\n* [Core][Bugfix]: fix prefix caching for blockv2 ( vllm-project#5364 )\n\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\n\n* [mypy] Enable type checking for test directory ( vllm-project#5017 )\n\n* [CI/Build] Test both text and token IDs in batched OpenAI Completions API ( vllm-project#5568 )\n\n* [misc] Do not allow to use lora with chunked prefill. ( vllm-project#5538 )\n\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* add gptq_marlin test for bug report vllm-project#5088 ( vllm-project#5145 )\n\n* [BugFix] Don't start a Ray cluster when not using Ray ( vllm-project#5570 )\n\n* [Fix] Correct OpenAI batch response format ( vllm-project#5554 )\n\n* Add basic correctness 2 GPU tests to 4 GPU pipeline ( vllm-project#5518 )\n\n* [CI][BugFix] Flip is_quant_method_supported condition ( vllm-project#5577 )\n\n* [build][misc] limit numpy version ( vllm-project#5582 )\n\n* [Doc] add debugging tips for crash and multi-node debugging ( vllm-project#5581 )\n\n* Fix w8a8 benchmark and add Llama-3-8B ( vllm-project#5562 )\n\n* [Model] Rename Phi3 rope scaling type ( vllm-project#5595 )\n\n* Correct alignment in the seq_len diagram. ( vllm-project#5592 )\n\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\n\n* [Kernel] `compressed-tensors` marlin 24 support ( vllm-project#5435 )\n\n* [Misc] use AutoTokenizer for benchmark serving when vLLM not installed ( vllm-project#5588 )\n\n* [Hardware][Intel GPU] Add Intel GPU(XPU) inference backend ( vllm-project#3814 )\n\nCo-authored-by: Jiang Li <jiang1.li@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\n\n* [CI/BUILD] Support non-AVX512 vLLM building and testing ( vllm-project#5574 )\n\n* [CI] the readability of benchmarking and prepare for dashboard ( vllm-project#5571 )\n\n[CI] Improve the readability of performance benchmarking results and prepare for upcoming performance dashboard ( vllm-project#5571 )\n\n* [bugfix][distributed] fix 16 gpus local rank arrangement ( vllm-project#5604 )\n\n* [Optimization] use a pool to reuse LogicalTokenBlock.token_ids ( vllm-project#5584 )\n\n* [Bugfix] Fix KV head calculation for MPT models when using GQA ( vllm-project#5142 )\n\n* [Fix] Use utf-8 encoding in entrypoints/openai/run_batch.py ( vllm-project#5606 )\n\n* [Speculative Decoding 1/2 ] Add typical acceptance sampling as one of the sampling techniques in the verifier ( vllm-project#5131 )\n\n* [Model] Initialize Phi-3-vision support ( vllm-project#4986 )\n\n* [Kernel] Add punica dimensions for Granite 13b ( vllm-project#5559 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [misc][typo] fix typo ( vllm-project#5620 )\n\n* [Misc] Fix typo ( vllm-project#5618 )\n\n* [CI] Avoid naming different metrics with the same name in performance benchmark ( vllm-project#5615 )\n\n* [bugfix][distributed] improve p2p capability test ( vllm-project#5612 )\n\n[bugfix][distributed] do not error if two processes do not agree on p2p capability ( vllm-project#5612 )\n\n* [Misc] Remove import from transformers logging ( vllm-project#5625 )\n\n* [CI/Build][Misc] Update Pytest Marker for VLMs ( vllm-project#5623 )\n\n* [ci] Deprecate original CI template ( vllm-project#5624 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Add OpenTelemetry support ( vllm-project#4687 )\n\nThis PR adds basic support for OpenTelemetry distributed tracing.\nIt includes changes to enable tracing functionality and improve monitoring capabilities.\n\nI've also added a markdown with print-screens to guide users how to use this feature. You can find it here\n\n* [Misc] Add channel-wise quantization support for w8a8 dynamic per token activation quantization ( vllm-project#5542 )\n\n* [ci] Setup Release pipeline and build release wheels with cache ( vllm-project#5610 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Model] LoRA support added for command-r ( vllm-project#5178 )\n\n* [Bugfix] Fix for inconsistent behaviour related to sampling and repetition penalties  ( vllm-project#5639 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Doc] Added cerebrium as Integration option ( vllm-project#5553 )\n\n* [Bugfix] Fix CUDA version check for mma warning suppression ( vllm-project#5642 )\n\n* [Bugfix] Fix w8a8 benchmarks for int8 case ( vllm-project#5643 )\n\n* [Bugfix] Fix Phi-3 Long RoPE scaling implementation ( vllm-project#5628 )\n\n* [Bugfix] Added test for sampling repetition penalty bug. ( vllm-project#5659 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix][CI/Build][AMD][ROCm]Fixed the cmake build bug which generate garbage on certain devices ( vllm-project#5641 )\n\n* [misc][distributed] use 127.0.0.1 for single-node ( vllm-project#5619 )\n\n* [Model] Add FP8 kv cache for Qwen2 ( vllm-project#5656 )\n\n* [Bugfix] Fix sampling_params passed incorrectly in Phi3v example ( vllm-project#5684 )\n\n* [Misc]Add param max-model-len in benchmark_latency.py ( vllm-project#5629 )\n\n* [CI/Build] Add tqdm to dependencies ( vllm-project#5680 )\n\n* [ci] Add A100 queue into AWS CI template ( vllm-project#5648 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Frontend][Bugfix] Fix preemption_mode -> preemption-mode for CLI arg in arg_utils.py ( vllm-project#5688 )\n\n* [ci][distributed] add tests for custom allreduce ( vllm-project#5689 )\n\n* [Bugfix] AsyncLLMEngine hangs with asyncio.run ( vllm-project#5654 )\n\n* [Doc] Update docker references ( vllm-project#5614 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Misc] Add per channel support for static activation quantization; update w8a8 schemes to share base classes ( vllm-project#5650 )\n\n* [ci] Limit num gpus if specified for A100 ( vllm-project#5694 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Improve conftest ( vllm-project#5681 )\n\n* [Bugfix][Doc] FIx Duplicate Explicit Target Name Errors ( vllm-project#5703 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM90 ( vllm-project#5514 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Model] Port over CLIPVisionModel for VLMs ( vllm-project#5591 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM80 ( vllm-project#5275 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix] Fix the CUDA version check for FP8 support in the CUTLASS kernels ( vllm-project#5715 )\n\n* [Frontend] Add FlexibleArgumentParser to support both underscore and dash in names ( vllm-project#5718 )\n\n* [distributed][misc] use fork by default for mp ( vllm-project#5669 )\n\n* [Model] MLPSpeculator speculative decoding support ( vllm-project#4947 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\n\n* [Kernel] Add punica dimension for Qwen2 LoRA ( vllm-project#5441 )\n\n* [BugFix] Fix test_phi3v.py ( vllm-project#5725 )\n\n* [Bugfix] Add  fully sharded layer for QKVParallelLinearWithLora ( vllm-project#5665 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Core][Distributed] add shm broadcast ( vllm-project#5399 )\n\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Kernel][CPU] Add Quick `gelu` to CPU ( vllm-project#5717 )\n\n* [Doc] Documentation on supported hardware for quantization methods ( vllm-project#5745 )\n\n* [BugFix] exclude version 1.15.0 for modelscope ( vllm-project#5668 )\n\n* [ci][test] fix ca test in main ( vllm-project#5746 )\n\n* [LoRA] Add support for pinning lora adapters in the LRU cache ( vllm-project#5603 )\n\n* [CI][Hardware][Intel GPU] add Intel GPU(XPU) ci pipeline ( vllm-project#5616 )\n\n* [Model] Support Qwen-VL and Qwen-VL-Chat models with text-only inputs ( vllm-project#5710 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Remove vllm-project#4789 workaround left in vllm/entrypoints/openai/run_batch.py ( vllm-project#5756 )\n\n* [Bugfix] Fix pin_lora error in TPU executor ( vllm-project#5760 )\n\n* [Docs][TPU] Add installation tip for TPU ( vllm-project#5761 )\n\n* [core][distributed] improve shared memory broadcast ( vllm-project#5754 )\n\n* [BugFix] [Kernel] Add Cutlass2x fallback kernels ( vllm-project#5744 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Distributed] Add send and recv helpers ( vllm-project#5719 )\n\n* [Bugfix] Add phi3v resize for dynamic shape and fix torchvision requirement ( vllm-project#5772 )\n\n* [doc][faq] add warning to download models for every nodes ( vllm-project#5783 )\n\n* post-rebase api adjustments\n\n* [Doc] Add \"Suggest edit\" button to doc pages ( vllm-project#5789 )\n\n* [Doc] Add Phi-3-medium to list of supported models ( vllm-project#5788 )\n\n* [Bugfix] Fix FlexibleArgumentParser replaces _ with - for actual args ( vllm-project#5795 )\n\n* [ci] Remove aws template ( vllm-project#5757 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Doc] Add notice about breaking changes to VLMs ( vllm-project#5818 )\n\n* [Speculative Decoding] Support draft model on different tensor-parallel size than target model ( vllm-project#5414 )\n\n* add pin_lora to habana components\n\n* add WA for model loader\n\n* fix api mismatches with ray\n\n* tensor parallel fixes\n\n* workers cpu alignment fix\n\n* [Misc] Remove useless code in cpu_worker ( vllm-project#5824 )\n\n* prefill/decode metadata fixes\n\n* [Core] Add fault tolerance for `RayTokenizerGroupPool` ( vllm-project#5748 )\n\n* re-enable attn metadata trimming\n\n* worker_use_ray fix\n\n* [doc][distributed] add both gloo and nccl tests ( vllm-project#5834 )\n\n* [CI/Build] Add unit testing for FlexibleArgumentParser ( vllm-project#5798 )\n\n* [Misc] Update `w4a16` `compressed-tensors` support to include `w8a16` ( vllm-project#5794 )\n\n* [Hardware][TPU] Refactor TPU backend ( vllm-project#5831 )\n\n* [Hardware][AMD][CI/Build][Doc] Upgrade to ROCm 6.1, Dockerfile improvements, test fixes ( vllm-project#5422 )\n\n* [Hardware][TPU] Raise errors for unsupported sampling params ( vllm-project#5850 )\n\n* [CI/Build] Add E2E tests for MLPSpeculator ( vllm-project#5791 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix assertion in NeuronExecutor ( vllm-project#5841 )\n\n* [Core] Refactor Worker and ModelRunner to consolidate control plane communication ( vllm-project#5408 )\n\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Stephanie <swang@anyscale.com>\n\n* [Misc][Doc] Add Example of using OpenAI Server with VLM ( vllm-project#5832 )\n\n* [bugfix][distributed] fix shm broadcast when the queue size is full ( vllm-project#5801 )\n\n* [Bugfix] Fix embedding to support 2D inputs ( vllm-project#5829 )\n\n* [Bugfix][TPU] Fix KV cache size calculation ( vllm-project#5860 )\n\n* [CI/Build] Refactor image test assets ( vllm-project#5821 )\n\n* [Kernel] Adding bias epilogue support for `cutlass_scaled_mm` ( vllm-project#5560 )\n\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Frontend] Add tokenize/detokenize endpoints ( vllm-project#5054 )\n\n* [Hardware][TPU] Support parallel sampling & Swapping ( vllm-project#5855 )\n\n* [Bugfix][TPU] Fix CPU cache allocation ( vllm-project#5869 )\n\n* Support CPU inference with VSX PowerPC ISA ( vllm-project#5652 )\n\n* [doc] update usage of env var to avoid conflict ( vllm-project#5873 )\n\n* [Misc] Add example for LLaVA-NeXT ( vllm-project#5879 )\n\n* [BugFix] Fix cuda graph for MLPSpeculator ( vllm-project#5875 )\n\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\n\n* [Doc] Add note about context length in Phi-3-Vision example ( vllm-project#5887 )\n\n* [VLM][Bugfix] Make sure that `multi_modal_kwargs` is broadcasted properly ( vllm-project#5880 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Model] Add base class for LoRA-supported models ( vllm-project#5018 )\n\n* [Bugfix] Fix img_sizes Parsing in Phi3-Vision ( vllm-project#5888 )\n\n* [CI/Build] [1/3] Reorganize entrypoints tests ( vllm-project#5526 )\n\n* add collective crash WA\n\n* add comment to the weird mark_step\n\n* [Model][Bugfix] Implicit model flags and reenable Phi-3-Vision ( vllm-project#5896 )\n\n* [doc][misc] add note for Kubernetes users ( vllm-project#5916 )\n\n* [BugFix] Fix `MLPSpeculator` handling of `num_speculative_tokens` ( vllm-project#5876 )\n\n* [BugFix] Fix `min_tokens` behaviour for multiple eos tokens ( vllm-project#5849 )\n\n* [CI/Build] Fix Args for `_get_logits_warper` in Sampler Test ( vllm-project#5922 )\n\n* [Model] Add Gemma 2 ( vllm-project#5908 )\n\n* [core][misc] remove logical block ( vllm-project#5882 )\n\n* [Kernel][ROCm][AMD] fused_moe Triton configs v2 for mi300X ( vllm-project#5932 )\n\n* [Hardware][TPU] Optimize KV cache swapping ( vllm-project#5878 )\n\n* [VLM][BugFix] Make sure that `multi_modal_kwargs` can broadcast properly with ring buffer. ( vllm-project#5905 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][Hardware][Intel CPU] Fix unpassed multi_modal_kwargs for CPU runner ( vllm-project#5956 )\n\n* [Core] Registry for processing model inputs ( vllm-project#5214 )\n\nCo-authored-by: ywang96 <ywang@roblox.com>\n\n* Unmark fused_moe config json file as executable ( vllm-project#5960 )\n\n* [Hardware][Intel] OpenVINO vLLM backend ( vllm-project#5379 )\n\n* [Bugfix] Better error message for MLPSpeculator when `num_speculative_tokens` is set too high ( vllm-project#5894 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [CI/Build] [2/3] Reorganize entrypoints tests ( vllm-project#5904 )\n\n* [Distributed] Make it clear that % should not be in tensor dict keys. ( vllm-project#5927 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Spec Decode] Introduce DraftModelRunner ( vllm-project#5799 )\n\n* [Bugfix] Fix compute datatype for cutlass 3.x epilogues ( vllm-project#5931 )\n\n* [ Misc ] Remove `fp8_shard_indexer` from Col/Row Parallel Linear (Simplify Weight Loading) ( vllm-project#5928 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [ Bugfix ] Enabling Loading Models With Fused QKV/MLP on Disk with FP8 ( vllm-project#5921 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* Support Deepseek-V2 ( vllm-project#4650 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* [Bugfix] Only add `Attention.kv_scale` if kv cache quantization is enabled ( vllm-project#5936 )\n\n* Unmark more files as executable ( vllm-project#5962 )\n\n* [Bugfix] Fix Engine Failing After Invalid Request - AsyncEngineDeadError ( vllm-project#5963 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Kernel] Flashinfer for prefill & decode, with Cudagraph support for decode ( vllm-project#4628 )\n\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\n\n* [Bugfix][TPU] Fix TPU sampler output ( vllm-project#5978 )\n\n* [Bugfix][TPU] Fix pad slot id ( vllm-project#5977 )\n\n* [Bugfix] fix missing last itl in openai completions benchmark ( vllm-project#5926 )\n\n* [Misc] Extend vLLM Metrics logging API ( vllm-project#5925 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Kernel] Add punica dimensions for Granite 3b and 8b ( vllm-project#5930 )\n\nSigned-off-by: Joe Runde <joe@joerun.de>\n\n* [Bugfix] Fix precisions in Gemma 1 ( vllm-project#5913 )\n\n* [Misc] Update Phi-3-Vision Example ( vllm-project#5981 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix] Support `eos_token_id` from `config.json` ( vllm-project#5954 )\n\n* [Core] Optimize `SequenceStatus.is_finished` by switching to IntEnum ( vllm-project#5974 )\n\n* [Kernel] Raise an exception in MoE kernel if the batch size is larger then 65k ( vllm-project#5939 )\n\n* [ CI/Build ] Added E2E Test For Compressed Tensors ( vllm-project#5839 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [CI/Build] Add TP test for vision models ( vllm-project#5892 )\n\n* [ CI/Build ] LM Eval Harness Based CI Testing ( vllm-project#5838 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Bugfix][CI/Build][Hardware][AMD] Install matching torchvision to fix AMD tests ( vllm-project#5949 )\n\n* [CI/Build] Temporarily Remove Phi3-Vision from TP Test ( vllm-project#5989 )\n\n* [CI/Build] Reuse code for checking output consistency ( vllm-project#5988 )\n\n* [CI/Build] [3/3] Reorganize entrypoints tests ( vllm-project#5966 )\n\n* [ci][distributed] fix device count call\n\n[ci][distributed] fix some cuda init that makes it necessary to use spawn ( vllm-project#5991 )\n\n* [Frontend]: Support base64 embedding ( vllm-project#5935 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Lora] Use safetensor keys instead of adapter_config.json to find unexpected modules.  ( vllm-project#5909 )\n\nCo-authored-by: sang <sangcho@anyscale.com>\n\n* [ CI ] Temporarily Disable Large LM-Eval Tests ( vllm-project#6005 )\n\nCo-authored-by: rshaw@neuralmagic.com <rshaw@neuralmagic>\n\n* [Misc] Fix `get_min_capability` ( vllm-project#5971 )\n\n* [ Misc ] Refactor w8a8 to use `process_weights_after_load` (Simplify Weight Loading) ( vllm-project#5940 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [misc][cuda] use nvml to avoid accidentally cuda initialization ( vllm-project#6007 )\n\n* [Speculative Decoding 2/2 ] Integrate typical acceptance sampler into Spec Decode Worker ( vllm-project#5348 )\n\n* Revert test changes\n\n* cleanup\n\n* llm engine cleanup\n\n* utils.py cleanup\n\n* custom ops refactor\n\n* move xops to ops\n\n* remove vllm/hpu/attn_bias.py\n\n* whitespace fix\n\n* revert accidental changes in rmsnorm\n\n* Fix hpugraph hashing\n\n* add trim_attn_metadata comment\n\n* fix prompt bucketing:\n\n* [ CI ] Re-enable Large Model LM Eval ( vllm-project#6031 )\n\n* [doc][misc] remove deprecated api server in doc ( vllm-project#6037 )\n\n* [Misc] update benchmark backend for scalellm ( vllm-project#6018 )\n\n* [doc][misc] further lower visibility of simple api server ( vllm-project#6041 )\n\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [Bugfix] Use RayActorError for older versions of Ray in  RayTokenizerGroupPool ( vllm-project#6039 )\n\n* [Bugfix] adding chunking mechanism to fused_moe to handle large inputs ( vllm-project#6029 )\n\n* add FAQ doc under 'serving' ( vllm-project#5946 )\n\n* [Bugfix][Doc] Fix Doc Formatting ( vllm-project#6048 )\n\n* [Bugfix] Add explicit `end_forward` calls to flashinfer ( vllm-project#6044 )\n\n* [BugFix] Ensure worker model loop is always stopped at the right time ( vllm-project#5987 )\n\n* [Frontend] Relax api url assertion for openai benchmarking ( vllm-project#6046 )\n\n* [Model] Changes to MLPSpeculator to support tie_weights and input_scale ( vllm-project#5965 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\n\n* [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 default)  ( vllm-project#5602 )\n\n* [Frontend] Add template related params to request ( vllm-project#5709 )\n\n* [VLM] Remove `image_input_type` from VLM config ( vllm-project#5852 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Reinstate doc dependencies ( vllm-project#6061 )\n\n* guard model loader wa for hpu\n\n---------\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nSigned-off-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Allen.Dou <allen.dou@hotmail.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: leiwen83 <leiwen83@users.noreply.github.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: SangBin Cho <rkooo567@gmail.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Amit Garg <gargamit@microsoft.com>\nCo-authored-by: Charles Riggins <liqianchen123@foxmail.com>\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\nCo-authored-by: zhyncs <me@zhyncs.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\nCo-authored-by: Bruce Fontaine <bruce@2.7182.net>\nCo-authored-by: zifeitong <zifeitong@gmail.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Ronen Schaffer <ronen.schaffer@ibm.com>\nCo-authored-by: sergey-tinkoff <167607910+sergey-tinkoff@users.noreply.github.com>\nCo-authored-by: milo157 <43028253+milo157@users.noreply.github.com>\nCo-authored-by: Shukant Pal <SukantK2002@outlook.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: DearPlanet <junsong.zhang2021.work@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Joshua Rosenkranz <joshua.rosenkranz@gmail.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Jee Li <pandaleefree@163.com>\nCo-authored-by: rohithkrn <rohith.nallamaddi@gmail.com>\nCo-authored-by: Murali Andoorveedu <37849411+andoorve@users.noreply.github.com>\nCo-authored-by: Woo-Yeon Lee <wooyeonlee0@gmail.com>\nCo-authored-by: Matt Wong <156021403+mawong-amd@users.noreply.github.com>\nCo-authored-by: aws-patlange <90803007+aws-patlange@users.noreply.github.com>\nCo-authored-by: Stephanie Wang <swang@cs.berkeley.edu>\nCo-authored-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: sasha0552 <admin@sasha0552.org>\nCo-authored-by: Chip Kerchner <49959681+ChipKerchner@users.noreply.github.com>\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\nCo-authored-by: xwjiang2010 <87673679+xwjiang2010@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\nCo-authored-by: wangding zeng <155410488+zwd003@users.noreply.github.com>\nCo-authored-by: Lily Liu <lilyliupku@gmail.com>\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\nCo-authored-by: mcalman <68564154+mcalman@users.noreply.github.com>\nCo-authored-by: William Lin <SolitaryThinker@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: llmpros <10524065+llmpros@users.noreply.github.com>\nCo-authored-by: sang <sangcho@anyscale.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: James Whedbee <jamesw@telnyx.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\nCo-authored-by: danieljannai21 <100521221+danieljannai21@users.noreply.github.com> CatherineSue reviewed Jul 2, 2024 View reviewed changes vllm/core/block/prefix_caching_block.py from os.path import commonprefix from typing import Dict, FrozenSet, Iterable, List, Optional, Tuple from vllm.core.block.common import (CopyOnWriteTracker, get_all_blocks_recursively) from vllm.core.block.interfaces import Block, BlockAllocator, BlockId, Device from vllm.core.block.naive_block import NaiveBlock, NaiveBlockAllocator from vllm.core.block.naive_block import (BlockPool, NaiveBlock, Copy link Contributor CatherineSue Jul 2, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment qq: Why import BlockPool from vllm.core.block.naive_block instead of vllm.core.block.common ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author alexm-redhat Jul 2, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Forgot to change it. It was originally in naive_block. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 CatherineSue reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction prashantgupta24 pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request Jul 3, 2024 [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 defaâ€¦ â€¦ 549c660 â€¦ult) ( vllm-project#5602 ) robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jul 7, 2024 [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 defaâ€¦ â€¦ 77f588c â€¦ult) ( vllm-project#5602 ) xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 defaâ€¦ â€¦ efecae2 â€¦ult) ( vllm-project#5602 ) xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 defaâ€¦ â€¦ efceec4 â€¦ult) ( vllm-project#5602 ) Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 defaâ€¦ â€¦ 4795da5 â€¦ult) ( vllm-project#5602 )\n\nSigned-off-by: Alvant <alvasian@yandex.ru> LeiWang1999 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Mar 26, 2025 [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 defaâ€¦ â€¦ a93ba05 â€¦ult) ( vllm-project#5602 )\n\nSigned-off-by: LeiWang1999 <leiwang1999@outlook.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:40", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: LM-Eval | PERF: itl, benchmark serving, optimization | SERVING: serving, serving, api server | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:48:40", "models": ["meta-llama/Llama-3.1-8B-Instruct", "Qwen/Qwen2.5-7B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=Qwen/Qwen2.5-7B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 default)  (#5602)", "commit_message": "[Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 default)  (#5602)", "commit_date": "2024-07-01T20:10:37-07:00", "files_changed": ["benchmarks/benchmark_latency.py", "tests/conftest.py", "tests/core/block/test_block_table.py", "tests/core/block/test_cpu_gpu_block_allocator.py", "tests/core/block/test_naive_block.py", "tests/core/block/test_prefix_caching_block.py", "tests/spec_decode/test_batch_expansion.py", "vllm/core/block/block_table.py", "vllm/core/block/common.py", "vllm/core/block/cpu_gpu_block_allocator.py", "vllm/core/block/interfaces.py", "vllm/core/block/naive_block.py", "vllm/core/block/prefix_caching_block.py", "vllm/core/block_manager_v2.py", "vllm/engine/llm_engine.py", "vllm/entrypoints/openai/serving_completion.py", "vllm/model_executor/sampling_metadata.py", "vllm/outputs.py", "vllm/sequence.py"], "functions_changed": [], "stats": {"num_test_files": 6, "num_non_test_files": 13, "only_test_files": 0, "only_non_test_files": 0, "num_files": 19, "num_hunks": 107, "num_edited_lines": 1721, "num_non_test_edited_lines": 1570, "commit_year": 2024}, "diff_text": "diff --git a/benchmarks/benchmark_latency.py b/benchmarks/benchmark_latency.py\nindex a46ee1581..8d0554b0f 100644\n--- a/benchmarks/benchmark_latency.py\n+++ b/benchmarks/benchmark_latency.py\n@@ -46,6 +46,7 @@ def main(args: argparse.Namespace):\n         load_format=args.load_format,\n         distributed_executor_backend=args.distributed_executor_backend,\n         otlp_traces_endpoint=args.otlp_traces_endpoint,\n+        enable_prefix_caching=args.enable_prefix_caching,\n     )\n \n     sampling_params = SamplingParams(\n@@ -220,6 +221,9 @@ if __name__ == '__main__':\n         action='store_true',\n         help='If True, the prefill requests can be chunked based on the '\n         'max_num_batched_tokens')\n+    parser.add_argument(\"--enable-prefix-caching\",\n+                        action='store_true',\n+                        help=\"Enable automatic prefix caching\")\n     parser.add_argument('--use-v2-block-manager', action='store_true')\n     parser.add_argument(\n         \"--ray-workers-use-nsight\",\ndiff --git a/tests/conftest.py b/tests/conftest.py\nindex 0bd24905e..ac802d03b 100644\n--- a/tests/conftest.py\n+++ b/tests/conftest.py\n@@ -474,7 +474,7 @@ class VllmRunner:\n             req_sample_output_strs: List[str] = []\n             for sample in req_output.outputs:\n                 output_str = sample.text\n-                output_ids = sample.token_ids\n+                output_ids = list(sample.token_ids)\n                 req_sample_output_ids.append(prompt_ids + output_ids)\n                 req_sample_output_strs.append(prompt_str + output_str)\n             outputs.append((req_sample_output_ids, req_sample_output_strs))\ndiff --git a/tests/core/block/test_block_table.py b/tests/core/block/test_block_table.py\nindex 496774c8d..e2391a568 100644\n--- a/tests/core/block/test_block_table.py\n+++ b/tests/core/block/test_block_table.py\n@@ -373,8 +373,9 @@ def test_cow(block_size: int, sequence_len: int, append_len: int,\n                                    block_size) - (sequence_len // block_size)\n \n     original_block_table.allocate(token_ids=token_ids, device=Device.GPU)\n-    original_block_ids = original_block_table.physical_block_ids\n+    original_block_ids = original_block_table.physical_block_ids[:]\n \n+    print(\"original_block_ids = {}\".format(original_block_ids))\n     forked_block_table = original_block_table.fork()\n \n     # Expect no additional allocation (copy on _write_).\n@@ -457,7 +458,7 @@ def test_cow_lookahead_simple(block_size: int, sequence_len: int,\n \n     # Allocate lookahead slots.\n     original_block_table.ensure_num_empty_slots(lookahead_slots)\n-    original_block_ids = original_block_table.physical_block_ids\n+    original_block_ids = original_block_table.physical_block_ids[:]\n \n     forked_block_table = original_block_table.fork()\n \ndiff --git a/tests/core/block/test_cpu_gpu_block_allocator.py b/tests/core/block/test_cpu_gpu_block_allocator.py\nindex 44a5be6c1..15b76d909 100644\n--- a/tests/core/block/test_cpu_gpu_block_allocator.py\n+++ b/tests/core/block/test_cpu_gpu_block_allocator.py\n@@ -8,8 +8,8 @@ from vllm.utils import Device, chunk_list\n @pytest.mark.parametrize(\"num_gpu_blocks\", [1024])\n @pytest.mark.parametrize(\"block_size\", [16])\n @pytest.mark.parametrize(\"allocator_type\", [\"naive\", \"prefix_caching\"])\n-def test_allocate_mutable(num_cpu_blocks: int, num_gpu_blocks: int,\n-                          block_size: int, allocator_type: str):\n+def test_allocate_mutable_block(num_cpu_blocks: int, num_gpu_blocks: int,\n+                                block_size: int, allocator_type: str):\n     allocator = CpuGpuBlockAllocator.create(\n         allocator_type=allocator_type,\n         num_gpu_blocks=num_gpu_blocks,\n@@ -21,14 +21,14 @@ def test_allocate_mutable(num_cpu_blocks: int, num_gpu_blocks: int,\n     assert allocator.get_num_free_blocks(Device.GPU) == num_gpu_blocks\n \n     cpu_blocks = [\n-        allocator.allocate_mutable(prev_block=None, device=Device.CPU)\n+        allocator.allocate_mutable_block(prev_block=None, device=Device.CPU)\n         for _ in range(num_cpu_blocks)\n     ]\n     assert allocator.get_num_free_blocks(Device.CPU) == 0\n     assert allocator.get_num_free_blocks(Device.GPU) == num_gpu_blocks\n \n     gpu_blocks = [\n-        allocator.allocate_mutable(prev_block=None, device=Device.GPU)\n+        allocator.allocate_mutable_block(prev_block=None, device=Device.GPU)\n         for _ in range(num_gpu_blocks)\n     ]\n     assert allocator.get_num_free_blocks(Device.CPU) == 0\n@@ -47,8 +47,8 @@ def test_allocate_mutable(num_cpu_blocks: int, num_gpu_blocks: int,\n @pytest.mark.parametrize(\"num_gpu_blocks\", [1024])\n @pytest.mark.parametrize(\"block_size\", [2])\n @pytest.mark.parametrize(\"allocator_type\", [\"naive\", \"prefix_caching\"])\n-def test_allocate_immutable(num_cpu_blocks: int, num_gpu_blocks: int,\n-                            block_size: int, allocator_type: str):\n+def test_allocate_immutable_block(num_cpu_blocks: int, num_gpu_blocks: int,\n+                                  block_size: int, allocator_type: str):\n     allocator = CpuGpuBlockAllocator.create(\n         allocator_type=allocator_type,\n         num_gpu_blocks=num_gpu_blocks,\n@@ -67,18 +67,18 @@ def test_allocate_immutable(num_cpu_blocks: int, num_gpu_blocks: int,\n     assert allocator.get_num_free_blocks(Device.GPU) == num_gpu_blocks\n \n     cpu_blocks = [\n-        allocator.allocate_immutable(prev_block=None,\n-                                     token_ids=token_ids,\n-                                     device=Device.CPU)\n+        allocator.allocate_immutable_block(prev_block=None,\n+                                           token_ids=token_ids,\n+                                           device=Device.CPU)\n         for token_ids in cpu_token_ids\n     ]\n     assert allocator.get_num_free_blocks(Device.CPU) == 0\n     assert allocator.get_num_free_blocks(Device.GPU) == num_gpu_blocks\n \n     gpu_blocks = [\n-        allocator.allocate_immutable(prev_block=None,\n-                                     token_ids=token_ids,\n-                                     device=Device.GPU)\n+        allocator.allocate_immutable_block(prev_block=None,\n+                                           token_ids=token_ids,\n+                                           device=Device.GPU)\n         for token_ids in gpu_token_ids\n     ]\n     assert allocator.get_num_free_blocks(Device.CPU) == 0\ndiff --git a/tests/core/block/test_naive_block.py b/tests/core/block/test_naive_block.py\nindex edcdc0c7d..9821ac41b 100644\n--- a/tests/core/block/test_naive_block.py\n+++ b/tests/core/block/test_naive_block.py\n@@ -14,11 +14,11 @@ class TestNaiveBlockAllocator:\n                                prev_block: Optional[Block],\n                                token_ids: List[int]):\n         if allocate_type == \"immutable\":\n-            allocate_block = lambda: allocator.allocate_immutable(\n+            allocate_block = lambda: allocator.allocate_immutable_block(\n                 prev_block=prev_block, token_ids=token_ids)\n         elif allocate_type == \"mutable\":\n-            allocate_block = lambda: allocator.allocate_mutable(prev_block=\n-                                                                prev_block)\n+            allocate_block = lambda: allocator.allocate_mutable_block(\n+                prev_block=prev_block)\n         else:\n             raise ValueError()\n \ndiff --git a/tests/core/block/test_prefix_caching_block.py b/tests/core/block/test_prefix_caching_block.py\nindex fcf32cbe9..95858268a 100644\n--- a/tests/core/block/test_prefix_caching_block.py\n+++ b/tests/core/block/test_prefix_caching_block.py\n@@ -26,11 +26,10 @@ class TestPrefixCachingBlock:\n         token_ids = list(range(num_to_fill))\n         mock_allocator = MagicMock(spec=PrefixCachingBlockAllocator)\n \n-        block_with_prev = PrefixCachingBlock(\n-            prev_block=None,\n-            token_ids=token_ids,\n-            block_size=block_size,\n-            prefix_caching_allocator=mock_allocator)\n+        block_with_prev = PrefixCachingBlock(prev_block=None,\n+                                             token_ids=token_ids,\n+                                             block_size=block_size,\n+                                             allocator=mock_allocator)\n \n         if is_curr_block_full:\n             # Expect hash since block is full.\n@@ -71,7 +70,7 @@ class TestPrefixCachingBlock:\n             prev_block=previous_block,\n             token_ids=token_ids,\n             block_size=block_size,\n-            prefix_caching_allocator=mock_allocator,\n+            allocator=mock_allocator,\n         )\n \n         if is_curr_block_full and prev_block_has_hash:\n@@ -138,7 +137,7 @@ class TestPrefixCachingBlock:\n                 prev_block=prev_block,\n                 token_ids=[],\n                 block_size=block_size,\n-                prefix_caching_allocator=allocator,\n+                allocator=allocator,\n             )\n \n             tokens_to_append = token_ids[block_number *\n@@ -159,11 +158,11 @@ class TestPrefixCachingBlockAllocator:\n                                prev_block: Optional[Block],\n                                token_ids: List[int]):\n         if allocate_type == \"immutable\":\n-            allocate_block = lambda: allocator.allocate_immutable(\n+            allocate_block = lambda: allocator.allocate_immutable_block(\n                 prev_block=prev_block, token_ids=token_ids)\n         elif allocate_type == \"mutable\":\n-            allocate_block = lambda: allocator.allocate_mutable(prev_block=\n-                                                                prev_block)\n+            allocate_block = lambda: allocator.allocate_mutable_block(\n+                prev_block=prev_block)\n         else:\n             raise ValueError()\n \n@@ -233,12 +232,13 @@ class TestPrefixCachingBlockAllocator:\n \n         # Expect allocation with unseen hash to fail.\n         with pytest.raises(BlockAllocator.NoFreeBlocksError):\n-            allocator.allocate_immutable(prev_block=chain[-1],\n-                                         token_ids=list(range(block_size)))\n+            allocator.allocate_immutable_block(prev_block=chain[-1],\n+                                               token_ids=list(\n+                                                   range(block_size)))\n \n         # Expect mutable allocation to fail.\n         with pytest.raises(BlockAllocator.NoFreeBlocksError):\n-            allocator.allocate_mutable(prev_block=chain[-1])\n+            allocator.allocate_mutable_block(prev_block=chain[-1])\n \n         # Expect allocation of exact same chain to pass.\n         second_chain = TestPrefixCachingBlockAllocator.create_immutable_chain(\n@@ -270,7 +270,7 @@ class TestPrefixCachingBlockAllocator:\n \n         # Expect mutable allocation to fail.\n         with pytest.raises(BlockAllocator.NoFreeBlocksError):\n-            allocator.allocate_mutable(prev_block=None)\n+            allocator.allocate_mutable_block(prev_block=None)\n \n         block_to_free = chain[-1]\n \n@@ -280,11 +280,11 @@ class TestPrefixCachingBlockAllocator:\n             allocator.free(block_to_free)\n             assert block_to_free.block_id is None, i\n \n-            new_block = allocator.allocate_mutable(prev_block=None)\n+            new_block = allocator.allocate_mutable_block(prev_block=None)\n             assert new_block.block_id == block_id, i\n \n             with pytest.raises(BlockAllocator.NoFreeBlocksError):\n-                allocator.allocate_mutable(prev_block=None)\n+                allocator.allocate_mutable_block(prev_block=None)\n \n             block_to_free = new_block\n \n@@ -376,7 +376,6 @@ class TestPrefixCachingBlockAllocator:\n \n         # Create token ids that will exhaust all blocks.\n         token_ids = list(range(num_blocks_to_consume * block_size))\n-        blocks = list(range(num_blocks_to_consume))\n \n         first_chain = TestPrefixCachingBlockAllocator.create_immutable_chain(\n             block_size=block_size,\n@@ -384,9 +383,6 @@ class TestPrefixCachingBlockAllocator:\n             allocator=allocator,\n         )\n \n-        # mark all blocks in first chain as computed\n-        allocator.mark_blocks_as_computed(blocks)\n-\n         # After zero_point, second_chain's token_ids would be set -1, which\n         # make it different from here comparing with first_chain\n         zero_point = random.randint(1, len(token_ids) - 1)\n@@ -424,15 +420,16 @@ class TestPrefixCachingBlockAllocator:\n                                                 block_size=block_size)\n         token_ids = list(range(block_size))\n \n-        block = allocator.allocate_immutable(prev_block=None,\n-                                             token_ids=token_ids)\n+        block = allocator.allocate_immutable_block(prev_block=None,\n+                                                   token_ids=token_ids)\n \n         assert allocator._refcounter.get(block.block_id) == 1\n-        m = allocator.allocate_mutable(prev_block=None)\n+        m = allocator.allocate_mutable_block(prev_block=None)\n \n         block_id = m.block_id\n         for i in range(block_size):\n             m.append_token_ids([i])\n+\n         # After block get promoted to immutable from mutable, if there is\n         # already same content hash block, then it shall be released into\n         # hashless_allocator\n@@ -452,48 +449,79 @@ class TestPrefixCachingBlockAllocator:\n \n         all_blocks_list = [i for i in range(num_blocks)]\n         zero_ref = {i: 0 for i in range(num_blocks)}\n+        one_ref = {i: 1 for i in range(num_blocks)}\n         allocator = PrefixCachingBlockAllocator(num_blocks=num_blocks,\n                                                 block_size=block_size)\n         token_ids = list(range(num_blocks * block_size))\n \n-        # now we have num_blocks free blocks in hashless allocator\n-        # with internal tracking list _blocks _cached_blocks and evictor\n-        # empty and block's ref shall be 0\n+        # Verify initial/pre-alloc state\n+\n+        # Ensure all blocks are free inside hashless allocator\n         assert list(allocator._hashless_allocator._free_block_indices\n                     ) == all_blocks_list\n-        assert len(allocator._blocks.keys()) == 0\n+        # Ensure no tracked blocks\n+        assert len(allocator._block_tracker.keys()) == num_blocks\n+        for block_id in range(num_blocks):\n+            assert not allocator._block_tracker[block_id].active\n+        # Ensure no cached blocks\n         assert len(allocator._cached_blocks.values()) == 0\n+        # Ensure no evicted blocks\n         assert len(allocator.evictor.free_table.keys()) == 0\n+        # Ensure 0s ref counts for all blocks\n         assert allocator._refcounter._refcounts == zero_ref\n \n         # Allocate immutable chains with only one block residuled in\n         new_block = []\n         for i in range(num_blocks):\n-            block = allocator.allocate_immutable(\n+            block = allocator.allocate_immutable_block(\n                 prev_block=None,\n                 token_ids=token_ids[block_size * i:block_size * (i + 1)])\n             new_block.append(block)\n \n+        # Verify post-alloc state\n+\n+        # Ensure no blocks are free inside hashless allocator\n+        assert (len(allocator._hashless_allocator._free_block_indices) == 0)\n+        # Ensure all blocks are tracked\n+        assert len(allocator._block_tracker.keys()) == num_blocks\n+        for block_id in range(num_blocks):\n+            assert allocator._block_tracker[block_id].active\n+        # Ensure all blocks are cached (all promoted)\n+        assert len(allocator._cached_blocks.values()) == num_blocks\n+        # Ensure no evicted blocks\n+        assert len(allocator.evictor.free_table.keys()) == 0\n+        # Ensure 1s ref counts for all blocks\n+        assert allocator._refcounter._refcounts == one_ref\n+\n         # Free all blocks, and now all blocks shall be in the evictor\n-        # there shall be no tracking data left in _blocks\n+        # there shall be no tracking data left in _block_tracker\n         # all blocks shall be tracked in _cached_blocks\n         # all blocks' ref shall be zero\n         for block in new_block:\n             allocator.free(block)\n \n-        assert len(allocator._blocks.keys()) == 0\n+        # Verify post-free state\n+\n+        # Ensure no tracked blocks\n+        assert len(allocator._block_tracker.keys()) == num_blocks\n+        for block_id in range(num_blocks):\n+            assert not allocator._block_tracker[block_id].active\n+        # Ensure no blocks in hashless allocator (all promoted)\n         assert len(allocator._hashless_allocator._free_block_indices) == 0\n+        # Ensure all blocks are cached\n         assert list(allocator._cached_blocks.values()) == all_blocks_list\n+        # Ensure all blocks are inside the evictor\n         assert list(allocator.evictor.free_table.keys()) == all_blocks_list\n+        # Ensure 0s refcounts\n         assert allocator._refcounter._refcounts == zero_ref\n \n         # Allocate a mutable block, and the first block shall be evicted\n         # and set its content hash into None, ref to 1\n-        mutable = allocator.allocate_mutable(prev_block=None)\n+        mutable = allocator.allocate_mutable_block(prev_block=None)\n \n         assert mutable.block_id == 0\n         assert mutable.content_hash is None\n-        assert 0 in allocator._blocks\n+        assert allocator._block_tracker[0].active\n         assert allocator._refcounter.get(0) == 1\n         assert 0 not in allocator._cached_blocks\n         assert 0 not in allocator.evictor\n@@ -502,27 +530,27 @@ class TestPrefixCachingBlockAllocator:\n         # hashless allocator\n         allocator.free(mutable)\n \n-        assert len(allocator._blocks.keys()) == 0\n+        assert not allocator._block_tracker[0].active\n         assert allocator._refcounter._refcounts == zero_ref\n         assert 0 not in allocator._cached_blocks\n         assert 0 not in allocator.evictor\n         assert 0 in allocator._hashless_allocator._free_block_indices\n \n-        # when allocate immutable with first block_size tokens, we\n+        # When allocate immutable with first block_size tokens, we\n         # shall get free block from hashless allocator, thus no block left\n         # in hashless\n-        block = allocator.allocate_immutable(prev_block=None,\n-                                             token_ids=token_ids[:block_size])\n+        block = allocator.allocate_immutable_block(\n+            prev_block=None, token_ids=token_ids[:block_size])\n \n         assert block.block_id == 0\n         assert len(allocator._hashless_allocator._free_block_indices) == 0\n-        assert 0 in allocator._blocks\n+        assert allocator._block_tracker[0].active\n         assert 0 in allocator._cached_blocks.values()\n         assert allocator._refcounter.get(0) == 1\n         assert 0 not in allocator.evictor\n \n         # allocate mutable block again, it shall be popped from evictor\n-        mutable = allocator.allocate_mutable(prev_block=None)\n+        mutable = allocator.allocate_mutable_block(prev_block=None)\n         assert len(allocator._hashless_allocator._free_block_indices) == 0\n         assert mutable.block_id not in allocator.evictor.free_table\n         assert allocator._refcounter.get(mutable.block_id) == 1\n@@ -619,7 +647,7 @@ class TestPrefixCachingBlockAllocator:\n             block_token_ids = token_ids[block_number *\n                                         block_size:(block_number + 1) *\n                                         block_size]\n-            prev_block = allocator.allocate_immutable(\n+            prev_block = allocator.allocate_immutable_block(\n                 prev_block=prev_block, token_ids=block_token_ids)\n             blocks.append(prev_block)\n \ndiff --git a/tests/spec_decode/test_batch_expansion.py b/tests/spec_decode/test_batch_expansion.py\nindex 42dd90422..c350a2c55 100644\n--- a/tests/spec_decode/test_batch_expansion.py\n+++ b/tests/spec_decode/test_batch_expansion.py\n@@ -90,10 +90,10 @@ def test_create_single_target_seq_group_metadata(k: int):\n \n     assert output.request_id == input_seq_group_metadata.request_id\n     assert len(output.seq_data) == 1\n-    assert output.seq_data[target_seq_id].get_prompt_token_ids(\n-    ) == prompt_tokens\n-    assert output.seq_data[target_seq_id].get_output_token_ids(\n-    ) == prev_output_tokens + token_ids\n+    assert output.seq_data[target_seq_id].get_prompt_token_ids() == tuple(\n+        prompt_tokens)\n+    assert output.seq_data[target_seq_id].get_output_token_ids() == tuple(\n+        prev_output_tokens + token_ids)\n \n     assert len(output.block_tables) == 1\n     assert output.block_tables[\ndiff --git a/vllm/core/block/block_table.py b/vllm/core/block/block_table.py\nindex d705f3d91..49e63c231 100644\n--- a/vllm/core/block/block_table.py\n+++ b/vllm/core/block/block_table.py\n@@ -1,5 +1,6 @@\n from typing import List, Optional\n \n+from vllm.core.block.common import BlockList\n from vllm.core.block.interfaces import Block, DeviceAwareBlockAllocator\n from vllm.utils import Device, cdiv, chunk_list\n \n@@ -47,12 +48,10 @@ class BlockTable:\n         self._allocator = block_allocator\n         if _blocks is None:\n             _blocks = []\n-        self._blocks: List[Block] = _blocks\n+        self._blocks: BlockList = BlockList(_blocks)\n \n         self._max_block_sliding_window = max_block_sliding_window\n-        # Use helper method instead of directly calculating, as blocks\n-        # may not be allocated.\n-        self._num_full_slots = len(self._get_all_token_ids())\n+        self._num_full_slots = self._get_num_token_ids()\n \n     @staticmethod\n     def get_num_required_blocks(token_ids: List[int], block_size: int) -> int:\n@@ -88,11 +87,18 @@ class BlockTable:\n         \"\"\"\n         assert not self._is_allocated\n         assert token_ids\n-        self._blocks = self._allocate_blocks_for_token_ids(prev_block=None,\n-                                                           token_ids=token_ids,\n-                                                           device=device)\n+        blocks = self._allocate_blocks_for_token_ids(prev_block=None,\n+                                                     token_ids=token_ids,\n+                                                     device=device)\n+        self.update(blocks)\n         self._num_full_slots = len(token_ids)\n \n+    def update(self, blocks: List[Block]) -> None:\n+        \"\"\"Resets the table to the newly provided blocks \n+        (with their corresponding block ids)\n+        \"\"\"\n+        self._blocks.update(blocks)\n+\n     def append_token_ids(self,\n                          token_ids: List[int],\n                          num_lookahead_slots: int = 0,\n@@ -140,11 +146,11 @@ class BlockTable:\n                                     num_lookahead_slots)\n \n         # Update the blocks with the new tokens\n-        blocks = self._blocks[self._num_full_slots // self._block_size:]\n+        first_block_idx = self._num_full_slots // self._block_size\n         token_blocks = self._chunk_token_blocks_for_append(token_ids)\n \n-        for block, token_block in zip(blocks, token_blocks):\n-            block.append_token_ids(token_block)\n+        for i, token_block in enumerate(token_blocks):\n+            self._blocks.append_token_ids(first_block_idx + i, token_block)\n \n         self._num_full_slots += len(token_ids)\n \n@@ -174,8 +180,8 @@ class BlockTable:\n         for _ in range(blocks_to_allocate):\n             assert len(self._blocks) > 0\n             self._blocks.append(\n-                self._allocator.allocate_mutable(prev_block=self._blocks[-1],\n-                                                 device=device))\n+                self._allocator.allocate_mutable_block(\n+                    prev_block=self._blocks[-1], device=device))\n \n     def fork(self) -> \"BlockTable\":\n         \"\"\"Creates a new BlockTable instance with a copy of the blocks from the\n@@ -209,12 +215,12 @@ class BlockTable:\n         is set to `None`.\n         \"\"\"\n         assert self._is_allocated\n-        for block in self._blocks:\n+        for block in self.blocks:\n             self._allocator.free(block)\n-        self._blocks = []\n+        self._blocks.reset()\n \n     @property\n-    def physical_block_ids(self) -> List[Optional[int]]:\n+    def physical_block_ids(self) -> List[int]:\n         \"\"\"Returns a list of physical block indices for the blocks in the\n         BlockTable.\n \n@@ -228,7 +234,7 @@ class BlockTable:\n                 BlockTable.\n         \"\"\"\n         assert self._is_allocated\n-        return [block.block_id for block in self._blocks]\n+        return self._blocks.ids()\n \n     def get_unseen_token_ids(self, sequence_token_ids: List[int]) -> List[int]:\n         \"\"\"Get the number of \"unseen\" tokens in the sequence.\n@@ -253,17 +259,31 @@ class BlockTable:\n                                        token_ids: List[int],\n                                        device: Device) -> List[Block]:\n         blocks: List[Block] = []\n-        for block_token_ids in chunk_list(token_ids, self._block_size):\n-            if len(block_token_ids) == self._block_size:\n-                # If the block is full, create an immutable block.\n-                prev_block = self._allocator.allocate_immutable(\n-                    prev_block, token_ids=block_token_ids, device=device)\n+\n+        block_token_ids = []\n+        tail_token_ids = []\n+        for cur_token_ids in chunk_list(token_ids, self._block_size):\n+            if len(cur_token_ids) == self._block_size:\n+                block_token_ids.append(cur_token_ids)\n             else:\n-                # Else, partially fill a mutable block with token ids.\n-                prev_block = self._allocator.allocate_mutable(\n-                    prev_block=prev_block, device=device)\n-                prev_block.append_token_ids(block_token_ids)\n-            blocks.append(prev_block)\n+                tail_token_ids.append(cur_token_ids)\n+\n+        if block_token_ids:\n+            blocks.extend(\n+                self._allocator.allocate_immutable_blocks(\n+                    prev_block, block_token_ids=block_token_ids,\n+                    device=device))\n+            prev_block = blocks[-1]\n+\n+        if tail_token_ids:\n+            assert len(tail_token_ids) == 1\n+            cur_token_ids = tail_token_ids[0]\n+\n+            block = self._allocator.allocate_mutable_block(\n+                prev_block=prev_block, device=device)\n+            block.append_token_ids(cur_token_ids)\n+\n+            blocks.append(block)\n \n         return blocks\n \n@@ -274,18 +294,25 @@ class BlockTable:\n         if not self._is_allocated:\n             return token_ids\n \n-        for block in self._blocks:\n+        for block in self.blocks:\n             token_ids.extend(block.token_ids)\n \n         return token_ids\n \n+    def _get_num_token_ids(self) -> int:\n+        res = 0\n+        for block in self.blocks:\n+            res += len(block.token_ids)\n+\n+        return res\n+\n     @property\n     def _is_allocated(self) -> bool:\n         return len(self._blocks) > 0\n \n     @property\n-    def blocks(self) -> Optional[List[Block]]:\n-        return self._blocks\n+    def blocks(self) -> List[Block]:\n+        return self._blocks.list()\n \n     @property\n     def _num_empty_slots(self) -> int:\ndiff --git a/vllm/core/block/common.py b/vllm/core/block/common.py\nindex d2787d696..1e808e21b 100644\n--- a/vllm/core/block/common.py\n+++ b/vllm/core/block/common.py\n@@ -1,4 +1,5 @@\n-from typing import Dict, Iterable, List, Optional, Protocol, Tuple\n+from collections import deque\n+from typing import Deque, Dict, Iterable, List, Optional, Protocol, Tuple\n \n from vllm.core.block.interfaces import Block, BlockAllocator\n \n@@ -95,64 +96,40 @@ class CopyOnWriteTracker:\n \n     The CopyOnWriteTracker class maintains a mapping of source block indices to\n         their corresponding copy-on-write destination block indices. It works in\n-        conjunction with a RefCounter and a BlockAllocator to handle reference\n-        counting and block allocation.\n+        conjunction with a RefCounter.\n \n     Args:\n         refcounter (RefCounter): The reference counter used to track block\n             reference counts.\n-        allocator (BlockAllocator): The block allocator used to allocate and\n-            free blocks.\n     \"\"\"\n \n-    def __init__(\n-        self,\n-        refcounter: RefCounterProtocol,\n-        allocator: BlockAllocator,\n-    ):\n+    def __init__(self, refcounter: RefCounterProtocol):\n         self._copy_on_writes: List[Tuple[BlockId, BlockId]] = []\n         self._refcounter = refcounter\n-        self._allocator = allocator\n-\n-    def cow_block_if_not_appendable(self, block: Block) -> Optional[BlockId]:\n-        \"\"\"Performs a copy-on-write operation on the given block if it is not\n-        appendable.\n-\n-        This method checks the reference count of the given block. If the\n-        reference count is greater than 1, indicating that the block is shared,\n-        a copy-on-write operation is performed. The original block is freed,\n-        and a new block is allocated with the same content. The new block index\n-        is returned.\n-\n-        Args:\n-            block (Block): The block to check for copy-on-write.\n \n-        Returns:\n-            Optional[BlockId]: The block index of the new block if a copy-on\n-                -write operation was performed, or the original block index if\n-                no copy-on-write was necessary.\n+    def is_appendable(self, block: Block) -> bool:\n+        \"\"\"Checks if the block is shared or not. If shared, then it cannot\n+        be appended and needs to be duplicated via copy-on-write\n         \"\"\"\n         block_id = block.block_id\n         if block_id is None:\n-            return block_id\n+            return True\n \n         refcount = self._refcounter.get(block_id)\n-        assert refcount != 0\n-        if refcount > 1:\n-            src_block_id = block_id\n-            # Decrement refcount of the old block.\n-            self._allocator.free(block)\n-\n-            # Allocate a fresh new block.\n-            block_id = self._allocator.allocate_mutable(\n-                prev_block=block.prev_block).block_id\n+        return refcount <= 1\n \n-            # Track src/dst copy.\n-            assert src_block_id is not None\n-            assert block_id is not None\n-            self._copy_on_writes.append((src_block_id, block_id))\n-\n-        return block_id\n+    def record_cow(self, src_block_id: Optional[BlockId],\n+                   trg_block_id: Optional[BlockId]) -> None:\n+        \"\"\"Records a copy-on-write operation from source to target block id\n+        Args:\n+            src_block_id (BlockId): The source block id from which to copy \n+                the data\n+            trg_block_id (BlockId): The target block id to which the data\n+                is copied\n+        \"\"\"\n+        assert src_block_id is not None\n+        assert trg_block_id is not None\n+        self._copy_on_writes.append((src_block_id, trg_block_id))\n \n     def clear_cows(self) -> List[Tuple[BlockId, BlockId]]:\n         \"\"\"Clears the copy-on-write tracking information and returns the current\n@@ -172,6 +149,139 @@ class CopyOnWriteTracker:\n         return cows\n \n \n+class BlockPool:\n+    \"\"\"Used to pre-allocate block objects, in order to avoid excessive python\n+    object allocations/deallocations.\n+    The pool starts from \"pool_size\" objects and will increase to more objects\n+    if necessary\n+\n+    Note that multiple block objects may point to the same physical block id,\n+    which is why this pool is needed, so that it will be easier to support\n+    prefix caching and more complicated sharing of physical blocks.\n+    \"\"\"\n+\n+    def __init__(self, block_size: int, create_block: Block.Factory,\n+                 allocator: BlockAllocator, pool_size: int):\n+        self._block_size = block_size\n+        self._create_block = create_block\n+        self._allocator = allocator\n+        self._pool_size = pool_size\n+        assert self._pool_size >= 0\n+\n+        self._free_ids: Deque[int] = deque(range(self._pool_size))\n+        self._pool = []\n+        for i in range(self._pool_size):\n+            self._pool.append(\n+                self._create_block(prev_block=None,\n+                                   token_ids=[],\n+                                   block_size=self._block_size,\n+                                   allocator=self._allocator,\n+                                   block_id=None))\n+\n+    def increase_pool(self):\n+        \"\"\"Doubles the internal pool size\n+        \"\"\"\n+        cur_pool_size = self._pool_size\n+        new_pool_size = cur_pool_size * 2\n+        self._pool_size = new_pool_size\n+\n+        self._free_ids += deque(range(cur_pool_size, new_pool_size))\n+\n+        for i in range(cur_pool_size, new_pool_size):\n+            self._pool.append(\n+                self._create_block(prev_block=None,\n+                                   token_ids=[],\n+                                   block_size=self._block_size,\n+                                   allocator=self._allocator,\n+                                   block_id=None))\n+\n+    def init_block(self, prev_block: Optional[Block], token_ids: List[int],\n+                   block_size: int, physical_block_id: Optional[int]) -> Block:\n+        if len(self._free_ids) == 0:\n+            self.increase_pool()\n+            assert len(self._free_ids) > 0\n+\n+        pool_id = self._free_ids.popleft()\n+\n+        block = self._pool[pool_id]\n+        block.__init__(  # type: ignore[misc]\n+            prev_block=prev_block,\n+            token_ids=token_ids,\n+            block_size=block_size,\n+            allocator=block._allocator,  # type: ignore[attr-defined] \n+            block_id=physical_block_id)\n+        block.pool_id = pool_id  # type: ignore[attr-defined]\n+        return block\n+\n+    def free_block(self, block: Block) -> None:\n+        self._free_ids.appendleft(block.pool_id)  # type: ignore[attr-defined]\n+\n+\n+class BlockList:\n+    \"\"\"This class is an optimization to allow fast-access to physical \n+    block ids. It maintains a block id list that is updated with the \n+    block list and this avoids the need to reconstruct the block id \n+    list on every iteration of the block manager\n+    \"\"\"\n+\n+    def __init__(self, blocks: List[Block]):\n+        self._blocks: List[Block] = []\n+        self._block_ids: List[int] = []\n+\n+        self.update(blocks)\n+\n+    def _add_block_id(self, block_id: Optional[BlockId]) -> None:\n+        assert block_id is not None\n+        self._block_ids.append(block_id)\n+\n+    def _update_block_id(self, block_index: int,\n+                         new_block_id: Optional[BlockId]) -> None:\n+        assert new_block_id is not None\n+        self._block_ids[block_index] = new_block_id\n+\n+    def update(self, blocks: List[Block]):\n+        self._blocks = blocks\n+\n+        # Cache block ids for fast query\n+        self._block_ids = []\n+        for block in self._blocks:\n+            self._add_block_id(block.block_id)\n+\n+    def append_token_ids(self, block_index: int, token_ids: List[int]) -> None:\n+        block = self._blocks[block_index]\n+        prev_block_id = block.block_id\n+\n+        block.append_token_ids(token_ids)\n+\n+        # CoW or promotion may update the internal block_id\n+        if prev_block_id != block.block_id:\n+            self._update_block_id(block_index, block.block_id)\n+\n+    def append(self, new_block: Block):\n+        self._blocks.append(new_block)\n+        self._add_block_id(new_block.block_id)\n+\n+    def __len__(self) -> int:\n+        return len(self._blocks)\n+\n+    def __getitem__(self, block_index: int) -> Block:\n+        return self._blocks[block_index]\n+\n+    def __setitem__(self, block_index: int, new_block: Block) -> None:\n+        self._blocks[block_index] = new_block\n+        self._update_block_id(block_index, new_block.block_id)\n+\n+    def reset(self):\n+        self._blocks = []\n+        self._block_ids = []\n+\n+    def list(self) -> List[Block]:\n+        return self._blocks\n+\n+    def ids(self) -> List[int]:\n+        return self._block_ids\n+\n+\n def get_all_blocks_recursively(last_block: Block) -> List[Block]:\n     \"\"\"Retrieves all the blocks in a sequence starting from the last block.\n \ndiff --git a/vllm/core/block/cpu_gpu_block_allocator.py b/vllm/core/block/cpu_gpu_block_allocator.py\nindex 255aae9d1..5287cd9c1 100644\n--- a/vllm/core/block/cpu_gpu_block_allocator.py\n+++ b/vllm/core/block/cpu_gpu_block_allocator.py\n@@ -113,11 +113,11 @@ class CpuGpuBlockAllocator(DeviceAwareBlockAllocator):\n     def allocate_or_get_null_block(self) -> Block:\n         if self._null_block is None:\n             self._null_block = NullBlock(\n-                self.allocate_mutable(None, Device.GPU))\n+                self.allocate_mutable_block(None, Device.GPU))\n         return self._null_block\n \n-    def allocate_mutable(self, prev_block: Optional[Block],\n-                         device: Device) -> Block:\n+    def allocate_mutable_block(self, prev_block: Optional[Block],\n+                               device: Device) -> Block:\n         \"\"\"Allocates a new mutable block on the specified device.\n \n         Args:\n@@ -128,10 +128,31 @@ class CpuGpuBlockAllocator(DeviceAwareBlockAllocator):\n         Returns:\n             Block: The newly allocated mutable block.\n         \"\"\"\n-        return self._allocators[device].allocate_mutable(prev_block)\n+        return self._allocators[device].allocate_mutable_block(prev_block)\n \n-    def allocate_immutable(self, prev_block: Optional[Block],\n-                           token_ids: List[int], device: Device) -> Block:\n+    def allocate_immutable_blocks(self, prev_block: Optional[Block],\n+                                  block_token_ids: List[List[int]],\n+                                  device: Optional[Device]) -> List[Block]:\n+        \"\"\"Allocates a new group of immutable blocks with the provided block \n+        token IDs on the specified device.\n+\n+        Args:\n+            prev_block (Optional[Block]): The previous block in the sequence.\n+                Used for prefix hashing.\n+            block_token_ids (List[int]): The list of block token IDs to be \n+                stored in the new blocks.\n+            device (Device): The device on which to allocate the new block.\n+\n+        Returns:\n+            List[Block]: The newly allocated list of immutable blocks \n+                containing the provided block token IDs.\n+        \"\"\"\n+        return self._allocators[device].allocate_immutable_blocks(\n+            prev_block, block_token_ids)\n+\n+    def allocate_immutable_block(self, prev_block: Optional[Block],\n+                                 token_ids: List[int],\n+                                 device: Device) -> Block:\n         \"\"\"Allocates a new immutable block with the provided token IDs on the\n         specified device.\n \n@@ -146,7 +167,7 @@ class CpuGpuBlockAllocator(DeviceAwareBlockAllocator):\n             Block: The newly allocated immutable block containing the provided\n                 token IDs.\n         \"\"\"\n-        return self._allocators[device].allocate_immutable(\n+        return self._allocators[device].allocate_immutable_block(\n             prev_block, token_ids)\n \n     def free(self, block: Block) -> None:\n@@ -161,7 +182,7 @@ class CpuGpuBlockAllocator(DeviceAwareBlockAllocator):\n         block_id = block.block_id\n         assert block_id is not None\n         allocator = self._block_ids_to_allocator[block_id]\n-        return allocator.free(block)\n+        allocator.free(block)\n \n     def fork(self, last_block: Block) -> List[Block]:\n         \"\"\"Creates a new sequence of blocks that shares the same underlying\n@@ -210,8 +231,8 @@ class CpuGpuBlockAllocator(DeviceAwareBlockAllocator):\n         \"\"\"\n         return self._allocators[device].get_physical_block_id(absolute_id)\n \n-    def swap(self, blocks: List[Block], source_device: Device,\n-             dest_device: Device) -> Dict[int, int]:\n+    def swap(self, blocks: List[Block], src_device: Device,\n+             dst_device: Device) -> Dict[int, int]:\n         \"\"\"Execute the swap for the given blocks from source_device\n         on to dest_device, save the current swap mapping and append \n         them to the accumulated `self._swap_mapping` for each \n@@ -219,23 +240,23 @@ class CpuGpuBlockAllocator(DeviceAwareBlockAllocator):\n \n         Args:\n             blocks: List of blocks to be swapped.\n-            source_device (Device): Device to swap the 'blocks' from.\n-            dest_device (Device): Device to swap the 'blocks' to.\n+            src_device (Device): Device to swap the 'blocks' from.\n+            dst_device (Device): Device to swap the 'blocks' to.\n         \n         Returns:\n             Dict[int, int]: Swap mapping from source_device\n                 on to dest_device.\n         \"\"\"\n-        source_block_ids = [block.block_id for block in blocks]\n-        self._allocators[source_device].swap_out(blocks)\n-        self._allocators[dest_device].swap_in(blocks)\n-        dest_block_ids = [block.block_id for block in blocks]\n+        src_block_ids = [block.block_id for block in blocks]\n+        self._allocators[src_device].swap_out(blocks)\n+        self._allocators[dst_device].swap_in(blocks)\n+        dst_block_ids = [block.block_id for block in blocks]\n \n         current_swap_mapping: Dict[int, int] = {}\n-        for src, dest in zip(source_block_ids, dest_block_ids):\n-            if src is not None and dest is not None:\n-                self._swap_mapping[src] = dest\n-                current_swap_mapping[src] = dest\n+        for src_block_id, dst_block_id in zip(src_block_ids, dst_block_ids):\n+            if src_block_id is not None and dst_block_id is not None:\n+                self._swap_mapping[src_block_id] = dst_block_id\n+                current_swap_mapping[src_block_id] = dst_block_id\n         return current_swap_mapping\n \n     def get_num_blocks_touched(self,\n@@ -283,23 +304,25 @@ class CpuGpuBlockAllocator(DeviceAwareBlockAllocator):\n         device = Device.GPU\n         return self._allocators[device].mark_blocks_as_computed(block_ids)\n \n+    def get_computed_block_ids(self, prev_computed_block_ids: List[int],\n+                               block_ids: List[int],\n+                               skip_last_block_id: bool) -> List[int]:\n+        # Prefix caching only supported on GPU.\n+        device = Device.GPU\n+        return self._allocators[device].get_computed_block_ids(\n+            prev_computed_block_ids, block_ids, skip_last_block_id)\n+\n     def get_common_computed_block_ids(\n-            self, seq_block_ids: List[List[int]]) -> List[int]:\n+            self, computed_seq_block_ids: List[List[int]]) -> List[int]:\n         # Prefix caching only supported on GPU.\n         device = Device.GPU\n         return self._allocators[device].get_common_computed_block_ids(\n-            seq_block_ids)\n+            computed_seq_block_ids)\n \n     @property\n     def all_block_ids(self) -> FrozenSet[int]:\n         return frozenset(self._block_ids_to_allocator.keys())\n \n-    def promote_to_immutable_block(self, block: Block) -> BlockId:\n-        raise NotImplementedError\n-\n-    def cow_block_if_not_appendable(self, block: Block) -> Optional[BlockId]:\n-        raise NotImplementedError\n-\n     def get_and_reset_swaps(self) -> List[Tuple[int, int]]:\n         \"\"\"Returns and clears the mapping of source to destination block IDs.\n         Will be called after every swapping operations for now, and after every\n@@ -341,6 +364,11 @@ class NullBlock(Block):\n     def token_ids(self) -> List[BlockId]:\n         return self._proxy.token_ids\n \n+    @property\n+    def num_tokens_total(self) -> int:\n+        raise NotImplementedError(\n+            \"num_tokens_total is not used for null block\")\n+\n     @property\n     def num_empty_slots(self) -> BlockId:\n         return self._proxy.num_empty_slots\ndiff --git a/vllm/core/block/interfaces.py b/vllm/core/block/interfaces.py\nindex 4b20856a1..ab39832bc 100644\n--- a/vllm/core/block/interfaces.py\n+++ b/vllm/core/block/interfaces.py\n@@ -28,6 +28,13 @@ class Block(ABC):\n     def token_ids(self) -> List[int]:\n         pass\n \n+    @property\n+    @abstractmethod\n+    def num_tokens_total(self) -> int:\n+        \"\"\"The number of tokens till the current block (inclusive)\n+        \"\"\"\n+        pass\n+\n     @property\n     @abstractmethod\n     def num_empty_slots(self) -> int:\n@@ -92,12 +99,18 @@ class Block(ABC):\n class BlockAllocator(ABC):\n \n     @abstractmethod\n-    def allocate_mutable(self, prev_block: Optional[Block]) -> Block:\n+    def allocate_mutable_block(self, prev_block: Optional[Block]) -> Block:\n         pass\n \n     @abstractmethod\n-    def allocate_immutable(self, prev_block: Optional[Block],\n-                           token_ids: List[int]) -> Block:\n+    def allocate_immutable_block(self, prev_block: Optional[Block],\n+                                 token_ids: List[int]) -> Block:\n+        pass\n+\n+    @abstractmethod\n+    def allocate_immutable_blocks(\n+            self, prev_block: Optional[Block],\n+            block_token_ids: List[List[int]]) -> List[Block]:\n         pass\n \n     @abstractmethod\n@@ -146,13 +159,19 @@ class BlockAllocator(ABC):\n     def mark_blocks_as_computed(self, block_ids: List[int]) -> None:\n         pass\n \n+    @abstractmethod\n+    def get_computed_block_ids(self, prev_computed_block_ids: List[int],\n+                               block_ids: List[int],\n+                               skip_last_block_id: bool) -> List[int]:\n+        pass\n+\n     @abstractmethod\n     def get_common_computed_block_ids(\n-            self, seq_block_ids: List[List[int]]) -> List[int]:\n+            self, computed_seq_block_ids: List[List[int]]) -> List[int]:\n         pass\n \n     @abstractmethod\n-    def cow_block_if_not_appendable(self, block: Block) -> Optional[\"BlockId\"]:\n+    def cow_block_if_not_appendable(self, block: Block) -> BlockId:\n         \"\"\"NOTE: This should not be used besides Block\"\"\"\n         pass\n \n@@ -174,13 +193,20 @@ class BlockAllocator(ABC):\n class DeviceAwareBlockAllocator(ABC):\n \n     @abstractmethod\n-    def allocate_mutable(self, prev_block: Optional[Block],\n-                         device: Device) -> Block:\n+    def allocate_mutable_block(self, prev_block: Optional[Block],\n+                               device: Device) -> Block:\n+        pass\n+\n+    @abstractmethod\n+    def allocate_immutable_block(self, prev_block: Optional[Block],\n+                                 token_ids: List[int],\n+                                 device: Device) -> Block:\n         pass\n \n     @abstractmethod\n-    def allocate_immutable(self, prev_block: Optional[Block],\n-                           token_ids: List[int], device: Device) -> Block:\n+    def allocate_immutable_blocks(self, prev_block: Optional[Block],\n+                                  block_token_ids: List[List[int]],\n+                                  device: Device) -> List[Block]:\n         pass\n \n     @abstractmethod\n@@ -217,9 +243,15 @@ class DeviceAwareBlockAllocator(ABC):\n     def mark_blocks_as_computed(self, block_ids: List[int]) -> None:\n         pass\n \n+    @abstractmethod\n+    def get_computed_block_ids(self, prev_computed_block_ids: List[int],\n+                               block_ids: List[int],\n+                               skip_last_block_id: bool) -> List[int]:\n+        pass\n+\n     @abstractmethod\n     def get_common_computed_block_ids(\n-            self, seq_block_ids: List[List[int]]) -> List[int]:\n+            self, computed_seq_block_ids: List[List[int]]) -> List[int]:\n         pass\n \n     @abstractmethod\n@@ -230,8 +262,8 @@ class DeviceAwareBlockAllocator(ABC):\n         pass\n \n     @abstractmethod\n-    def swap(self, blocks: List[Block], source_device: Device,\n-             dest_device: Device) -> Dict[int, int]:\n+    def swap(self, blocks: List[Block], src_device: Device,\n+             dst_device: Device) -> Dict[int, int]:\n         pass\n \n     @abstractmethod\ndiff --git a/vllm/core/block/naive_block.py b/vllm/core/block/naive_block.py\nindex 50f27bab3..0c1e88314 100644\n--- a/vllm/core/block/naive_block.py\n+++ b/vllm/core/block/naive_block.py\n@@ -1,6 +1,7 @@\n-from typing import FrozenSet, Iterable, List, Optional, Set, Tuple\n+from collections import deque\n+from typing import Deque, FrozenSet, Iterable, List, Optional, Tuple\n \n-from vllm.core.block.common import (CopyOnWriteTracker, RefCounter,\n+from vllm.core.block.common import (BlockPool, CopyOnWriteTracker, RefCounter,\n                                     get_all_blocks_recursively)\n from vllm.core.block.interfaces import Block, BlockAllocator, BlockId, Device\n from vllm.utils import cdiv\n@@ -31,28 +32,39 @@ class NaiveBlockAllocator(BlockAllocator):\n         num_blocks: int,\n         block_size: int,\n         block_ids: Optional[Iterable[int]] = None,\n+        block_pool: Optional[BlockPool] = None,\n     ):\n         if block_ids is None:\n             block_ids = range(num_blocks)\n \n-        self._free_block_indices: Set[BlockId] = set(block_ids)\n+        self._free_block_indices: Deque[BlockId] = deque(block_ids)\n         self._all_block_indices = frozenset(block_ids)\n         assert len(self._all_block_indices) == num_blocks\n \n         self._refcounter = RefCounter(\n             all_block_indices=self._free_block_indices)\n-        self._create_block = create_block\n         self._block_size = block_size\n \n         self._cow_tracker = CopyOnWriteTracker(\n-            refcounter=self._refcounter.as_readonly(),\n-            allocator=self,\n-        )\n-\n-    def allocate_immutable(self,\n-                           prev_block: Optional[Block],\n-                           token_ids: List[int],\n-                           device: Optional[Device] = None) -> Block:\n+            refcounter=self._refcounter.as_readonly())\n+\n+        if block_pool is None:\n+            extra_factor = 4\n+            # Pre-allocate \"num_blocks * extra_factor\" block objects.\n+            # The \"* extra_factor\" is a buffer to allow more block objects\n+            # than physical blocks\n+            self._block_pool = BlockPool(self._block_size, create_block, self,\n+                                         num_blocks * extra_factor)\n+        else:\n+            # In this case, the block pool is provided by the caller,\n+            # which means that there is most likely a need to share\n+            # a block pool between allocators\n+            self._block_pool = block_pool\n+\n+    def allocate_immutable_block(self,\n+                                 prev_block: Optional[Block],\n+                                 token_ids: List[int],\n+                                 device: Optional[Device] = None) -> Block:\n         \"\"\"Allocates a new immutable block with the given token IDs, linked to\n         the previous block.\n \n@@ -66,13 +78,36 @@ class NaiveBlockAllocator(BlockAllocator):\n             Block: The newly allocated immutable block.\n         \"\"\"\n         assert device is None\n-        block = self.allocate_mutable(prev_block=prev_block)\n+        block = self.allocate_mutable_block(prev_block=prev_block)\n         block.append_token_ids(token_ids)\n         return block\n \n-    def allocate_mutable(self,\n-                         prev_block: Optional[Block],\n-                         device: Optional[Device] = None) -> Block:\n+    def allocate_immutable_blocks(\n+            self,\n+            prev_block: Optional[Block],\n+            block_token_ids: List[List[int]],\n+            device: Optional[Device] = None) -> List[Block]:\n+        assert device is None\n+        num_blocks = len(block_token_ids)\n+\n+        block_ids = []\n+        for i in range(num_blocks):\n+            block_ids.append(self._allocate_block_id())\n+\n+        blocks = []\n+        for i in range(num_blocks):\n+            prev_block = self._block_pool.init_block(\n+                prev_block=prev_block,\n+                token_ids=block_token_ids[i],\n+                block_size=self._block_size,\n+                physical_block_id=block_ids[i])\n+            blocks.append(prev_block)\n+\n+        return blocks\n+\n+    def allocate_mutable_block(self,\n+                               prev_block: Optional[Block],\n+                               device: Optional[Device] = None) -> Block:\n         \"\"\"Allocates a new mutable block, linked to the previous block.\n \n         Args:\n@@ -84,20 +119,39 @@ class NaiveBlockAllocator(BlockAllocator):\n             Block: The newly allocated mutable block.\n         \"\"\"\n         assert device is None\n-        block_id = self._allocate_new_block_id()\n-        return self._create_block(\n-            prev_block=prev_block,\n-            token_ids=[],\n-            block_id=block_id,\n-            block_size=self._block_size,\n-            allocator=self,\n-        )\n-\n-    def free(self, block: Block) -> None:\n-        assert block.block_id is not None\n-        self._free_block_id(block.block_id)\n+        block_id = self._allocate_block_id()\n+        block = self._block_pool.init_block(prev_block=prev_block,\n+                                            token_ids=[],\n+                                            block_size=self._block_size,\n+                                            physical_block_id=block_id)\n+        return block\n+\n+    def _allocate_block_id(self) -> BlockId:\n+        if not self._free_block_indices:\n+            raise BlockAllocator.NoFreeBlocksError()\n+\n+        block_id = self._free_block_indices.popleft()\n+        self._refcounter.incr(block_id)\n+        return block_id\n+\n+    def _free_block_id(self, block: Block) -> None:\n+        block_id = block.block_id\n+        assert block_id is not None\n+\n+        refcount = self._refcounter.decr(block_id)\n+        if refcount == 0:\n+            self._free_block_indices.appendleft(block_id)\n+\n         block.block_id = None\n \n+    def free(self, block: Block, keep_block_object: bool = False) -> None:\n+        # Release the physical block id\n+        self._free_block_id(block)\n+\n+        # Release the block object\n+        if not keep_block_object:\n+            self._block_pool.free_block(block)\n+\n     def fork(self, last_block: Block) -> List[Block]:\n         \"\"\"Creates a new sequence of blocks that shares the same underlying\n         memory as the original sequence.\n@@ -120,14 +174,13 @@ class NaiveBlockAllocator(BlockAllocator):\n             refcount = self._refcounter.incr(block.block_id)\n             assert refcount != 1, \"can't fork free'd block\"\n \n-            forked_blocks.append(\n-                self._create_block(\n-                    prev_block=prev_block,\n-                    token_ids=block.token_ids,\n-                    block_id=block.block_id,\n-                    block_size=self._block_size,\n-                    allocator=self,\n-                ))\n+            forked_block = self._block_pool.init_block(\n+                prev_block=prev_block,\n+                token_ids=block.token_ids,\n+                block_size=self._block_size,\n+                physical_block_id=block.block_id)\n+\n+            forked_blocks.append(forked_block)\n             prev_block = forked_blocks[-1]\n \n         return forked_blocks\n@@ -138,20 +191,6 @@ class NaiveBlockAllocator(BlockAllocator):\n     def get_num_total_blocks(self) -> int:\n         return len(self._all_block_indices)\n \n-    def _allocate_new_block_id(self) -> BlockId:\n-        if not self._free_block_indices:\n-            raise BlockAllocator.NoFreeBlocksError()\n-\n-        block_id = next(iter(self._free_block_indices))\n-        self._refcounter.incr(block_id)\n-        self._free_block_indices.remove(block_id)\n-        return block_id\n-\n-    def _free_block_id(self, block_id: BlockId) -> None:\n-        refcount = self._refcounter.decr(block_id)\n-        if refcount == 0:\n-            self._free_block_indices.add(block_id)\n-\n     def get_physical_block_id(self, absolute_id: int) -> int:\n         \"\"\"Returns the zero-offset block id on certain block allocator\n         given the absolute block id.\n@@ -173,7 +212,7 @@ class NaiveBlockAllocator(BlockAllocator):\n     def all_block_ids(self) -> FrozenSet[int]:\n         return self._all_block_indices\n \n-    def cow_block_if_not_appendable(self, block: Block) -> Optional[BlockId]:\n+    def cow_block_if_not_appendable(self, block: Block) -> BlockId:\n         \"\"\"Performs a copy-on-write operation on the given block if it is not\n         appendable.\n \n@@ -181,11 +220,22 @@ class NaiveBlockAllocator(BlockAllocator):\n             block (Block): The block to check for copy-on-write.\n \n         Returns:\n-            Optional[BlockId]: The block index of the new block if a copy-on\n-                -write operation was performed, or the original block index if\n+            BlockId: The block index of the new block if a copy-on-write \n+                operation was performed, or the original block index if\n                 no copy-on-write was necessary.\n         \"\"\"\n-        return self._cow_tracker.cow_block_if_not_appendable(block)\n+        src_block_id = block.block_id\n+        assert src_block_id is not None\n+\n+        if self._cow_tracker.is_appendable(block):\n+            return src_block_id\n+\n+        self._free_block_id(block)\n+        trg_block_id = self._allocate_block_id()\n+\n+        self._cow_tracker.record_cow(src_block_id, trg_block_id)\n+\n+        return trg_block_id\n \n     def clear_copy_on_writes(self) -> List[Tuple[BlockId, BlockId]]:\n         \"\"\"Returns the copy-on-write source->destination mapping and clears it.\n@@ -213,8 +263,15 @@ class NaiveBlockAllocator(BlockAllocator):\n         \"\"\"\n         pass\n \n+    def get_computed_block_ids(self, prev_computed_block_ids: List[int],\n+                               block_ids: List[int],\n+                               skip_last_block_id: bool) -> List[int]:\n+        \"\"\"No prefix caching here => return empty list\n+        \"\"\"\n+        return []\n+\n     def get_common_computed_block_ids(\n-            self, seq_block_ids: List[List[int]]) -> List[int]:\n+            self, computed_seq_block_ids: List[List[int]]) -> List[int]:\n         \"\"\"Determine blocks that can be skipped in prefill.\n \n         Since the naive allocator does not support prefix caching, always return\n@@ -223,7 +280,7 @@ class NaiveBlockAllocator(BlockAllocator):\n         return []\n \n     def promote_to_immutable_block(self, block: Block) -> BlockId:\n-        raise NotImplementedError\n+        raise NotImplementedError(\"There is no promotion for naive blocks\")\n \n     def get_num_blocks_touched(self,\n                                blocks: List[Block],\n@@ -263,17 +320,27 @@ class NaiveBlockAllocator(BlockAllocator):\n \n     def swap_out(self, blocks: List[Block]) -> None:\n         for block in blocks:\n-            self.free(block)\n+            self._free_block_id(block)\n \n     def swap_in(self, blocks: List[Block]) -> None:\n         for block in blocks:\n+            # Here we allocate either immutable or mutable block and then\n+            # extract its block_id. Note that the block object is released\n+            # and the block_id is assigned to \"block\" to allow reusing the\n+            # existing \"block\" object\n             if block.is_full:\n-                alloc = self.allocate_immutable(block.prev_block,\n-                                                block.token_ids)\n+                tmp_block = self.allocate_immutable_block(\n+                    prev_block=block.prev_block, token_ids=block.token_ids)\n             else:\n-                alloc = self.allocate_mutable(block.prev_block)\n-                alloc.append_token_ids(block.token_ids)\n-            block.block_id = alloc.block_id\n+                tmp_block = self.allocate_mutable_block(\n+                    prev_block=block.prev_block)\n+                tmp_block.append_token_ids(block.token_ids)\n+\n+            block_id = tmp_block.block_id\n+            tmp_block.block_id = None\n+            self._block_pool.free_block(tmp_block)\n+\n+            block.block_id = block_id  # Assign block_id\n \n \n class NaiveBlock(Block):\n@@ -315,11 +382,12 @@ class NaiveBlock(Block):\n         self._append_token_ids_no_cow(token_ids)\n \n     def append_token_ids(self, token_ids: List[int]) -> None:\n-        \"\"\"Appends the given token IDs to the block, instructing the allocator\n-        to perform a copy-on-write if necessary.\n+        \"\"\"Appends the given token IDs to the block and performs a \n+        copy-on-write if necessary.\n \n         Args:\n-            token_ids (List[int]): The token IDs to be appended to the block.\n+            token_ids (Optional[List[int]]): The token IDs to be appended \n+                to the block.\n         \"\"\"\n         self._append_token_ids_no_cow(token_ids)\n \n@@ -328,7 +396,16 @@ class NaiveBlock(Block):\n                 self._cow_target))\n \n     def _append_token_ids_no_cow(self, token_ids: List[int]) -> None:\n-        assert self.num_empty_slots >= len(token_ids)\n+        \"\"\"Appends the given token IDs to the block\n+\n+        Args:\n+            token_ids (List[int]): The token IDs to be appended to the block.\n+        \"\"\"\n+        if len(token_ids) == 0:\n+            return\n+\n+        assert len(token_ids) <= self.num_empty_slots\n+\n         self._token_ids.extend(token_ids)\n \n     @property\n@@ -361,12 +438,17 @@ class NaiveBlock(Block):\n \n     @property\n     def num_empty_slots(self) -> int:\n-        return self._block_size - len(self._token_ids)\n+        return self._block_size - len(self.token_ids)\n \n     @property\n     def token_ids(self) -> List[int]:\n         return self._token_ids\n \n+    @property\n+    def num_tokens_total(self) -> int:\n+        raise NotImplementedError(\n+            \"num_tokens_total is not used for naive block\")\n+\n     @property\n     def block_size(self) -> int:\n         return self._block_size\ndiff --git a/vllm/core/block/prefix_caching_block.py b/vllm/core/block/prefix_caching_block.py\nindex 2df7d74e4..f272e23ee 100644\n--- a/vllm/core/block/prefix_caching_block.py\n+++ b/vllm/core/block/prefix_caching_block.py\n@@ -1,13 +1,13 @@\n \"\"\"Token blocks.\"\"\"\n \n-from itertools import takewhile\n from os.path import commonprefix\n from typing import Dict, FrozenSet, Iterable, List, Optional, Tuple\n \n from vllm.core.block.common import (CopyOnWriteTracker,\n                                     get_all_blocks_recursively)\n from vllm.core.block.interfaces import Block, BlockAllocator, BlockId, Device\n-from vllm.core.block.naive_block import NaiveBlock, NaiveBlockAllocator\n+from vllm.core.block.naive_block import (BlockPool, NaiveBlock,\n+                                         NaiveBlockAllocator)\n from vllm.core.evictor_v2 import EvictionPolicy, Evictor, make_evictor\n from vllm.utils import cdiv\n \n@@ -19,6 +19,30 @@ PrefixHash = int\n _DEFAULT_LAST_ACCESSED_TIME = -1\n \n \n+class BlockTracker:\n+    \"\"\"Used to track the status of a block inside the prefix caching allocator\n+    \"\"\"\n+    __slots__ = (\"active\", \"last_accessed\", \"computed\")\n+\n+    def reset(self):\n+        self.last_accessed: float = _DEFAULT_LAST_ACCESSED_TIME\n+        self.computed: bool = False\n+\n+    def __init__(self):\n+        self.active: bool = False\n+        self.reset()\n+\n+    def enable(self):\n+        assert not self.active\n+        self.active = True\n+        self.reset()\n+\n+    def disable(self):\n+        assert self.active\n+        self.active = False\n+        self.reset()\n+\n+\n class PrefixCachingBlockAllocator(BlockAllocator):\n     \"\"\"A block allocator that implements prefix caching.\n \n@@ -41,12 +65,26 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         block_ids: Optional[Iterable[int]] = None,\n         eviction_policy: EvictionPolicy = EvictionPolicy.LRU,\n     ):\n+        if block_ids is None:\n+            block_ids = range(num_blocks)\n+\n+        self._block_size = block_size\n+\n         # A mapping of prefix hash to block index. All blocks which have a\n         # prefix hash will be in this dict, even if they have refcount 0.\n         self._cached_blocks: Dict[PrefixHash, BlockId] = {}\n \n-        # A mapping of blockId to Block to track those cached blocks\n-        self._blocks: Dict[BlockId, Block] = {}\n+        # Used to track status of each physical block id\n+        self._block_tracker: Dict[BlockId, BlockTracker] = {}\n+        for block_id in block_ids:\n+            self._block_tracker[block_id] = BlockTracker()\n+\n+        # Pre-allocate \"num_blocks * extra_factor\" block objects.\n+        # The \"* extra_factor\" is a buffer to allow more block objects\n+        # than physical blocks\n+        extra_factor = 4\n+        self._block_pool = BlockPool(self._block_size, self._create_block,\n+                                     self, num_blocks * extra_factor)\n \n         # An allocator for blocks that do not have prefix hashes.\n         self._hashless_allocator = NaiveBlockAllocator(\n@@ -54,10 +92,9 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n             num_blocks=num_blocks,\n             block_size=block_size,\n             block_ids=block_ids,\n+            block_pool=self._block_pool,  # Share block pool here\n         )\n \n-        self._block_size = block_size\n-\n         # Evitor used to maintain how we want to handle those computed blocks\n         # if we find memory pressure is high.\n         self.evictor: Evictor = make_evictor(eviction_policy)\n@@ -68,9 +105,7 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         self._refcounter = self._hashless_allocator.refcounter\n \n         self._cow_tracker = CopyOnWriteTracker(\n-            refcounter=self._refcounter.as_readonly(),\n-            allocator=self,\n-        )\n+            refcounter=self._refcounter.as_readonly())\n \n     # Implements Block.Factory.\n     def _create_block(\n@@ -90,14 +125,14 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n             token_ids=token_ids,\n             block_size=block_size,\n             block_id=block_id,\n-            prefix_caching_allocator=allocator,\n+            allocator=allocator,\n             computed=computed,\n         )\n \n-    def allocate_immutable(self,\n-                           prev_block: Optional[Block],\n-                           token_ids: List[int],\n-                           device: Optional[Device] = None) -> Block:\n+    def allocate_immutable_block(self,\n+                                 prev_block: Optional[Block],\n+                                 token_ids: List[int],\n+                                 device: Optional[Device] = None) -> Block:\n         \"\"\"Allocates an immutable block with the given token IDs, reusing cached\n         blocks if possible.\n \n@@ -111,29 +146,41 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         assert device is None\n         assert_prefix_caching_block_or_none(prev_block)\n \n-        block = self._create_block(\n-            prev_block=prev_block,\n-            token_ids=token_ids,\n-            block_size=self._block_size,\n-            allocator=self,\n-        )\n+        # First, try to create a block that points to cached data\n+        block = self._block_pool.init_block(prev_block=prev_block,\n+                                            token_ids=token_ids,\n+                                            block_size=self._block_size,\n+                                            physical_block_id=None)\n         assert block.content_hash is not None\n \n         cached_block_id = self._cached_blocks.get(block.content_hash, None)\n         if cached_block_id is not None:\n             block.block_id = cached_block_id\n-            self._incr_refcount_cached_block(block, block.block_id)\n+            self._incr_refcount_cached_block(block)\n             return block\n+        self._block_pool.free_block(block)\n \n-        block = self.allocate_mutable(prev_block)\n+        # No cached block => Allocate a new block\n+        block = self.allocate_mutable_block(prev_block)\n         block.append_token_ids(token_ids)\n-        assert block.content_hash is not None\n-\n         return block\n \n-    def allocate_mutable(self,\n-                         prev_block: Optional[Block],\n-                         device: Optional[Device] = None) -> Block:\n+    def allocate_immutable_blocks(\n+            self,\n+            prev_block: Optional[Block],\n+            block_token_ids: List[List[int]],\n+            device: Optional[Device] = None) -> List[Block]:\n+        blocks = []\n+        for token_ids in block_token_ids:\n+            prev_block = self.allocate_immutable_block(prev_block=prev_block,\n+                                                       token_ids=token_ids,\n+                                                       device=device)\n+            blocks.append(prev_block)\n+        return blocks\n+\n+    def allocate_mutable_block(self,\n+                               prev_block: Optional[Block],\n+                               device: Optional[Device] = None) -> Block:\n         \"\"\"Allocates a mutable block. If there are no free blocks, this will\n         evict unused cached blocks.\n \n@@ -147,116 +194,154 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         assert device is None\n         assert_prefix_caching_block_or_none(prev_block)\n \n-        try:\n-            block = self._hashless_allocator.allocate_mutable(\n-                prev_block=prev_block)\n-\n-            assert block.block_id not in self._blocks\n-            assert block.block_id is not None\n-            self._blocks[block.block_id] = block\n-            return block\n-        except BlockAllocator.NoFreeBlocksError:\n-            # We must check the unused cached blocks before raising OOM.\n-            pass\n-\n-        # If the evictor has blocks available for eviction, evict a block\n-        # and return it.\n-        if self.evictor.num_blocks > 0:\n-            # here we get an evicted block, which is only added\n-            # into evictor if its ref counter is 0\n-            # and since its content would be changed, we need\n-            # to remove it from _cached_blocks's tracking list\n-            block_id, content_hash_to_evict = self.evictor.evict()\n-\n-            _block_id = self._cached_blocks[content_hash_to_evict]\n-            assert self._refcounter.get(_block_id) == 0\n-            assert _block_id == block_id\n-\n-            self._cached_blocks.pop(content_hash_to_evict)\n-\n-            self._refcounter.incr(block_id)\n-\n-            # Now this block is pop from evictor and ready to write\n-            # with new content which most probably different with\n-            # original content. So need to tell worker to recompute\n-            # its kvcache\n-            block = self._create_block(\n-                prev_block=prev_block,\n-                token_ids=[],\n-                block_size=self._block_size,\n-                allocator=self,\n-                block_id=block_id,\n-                computed=False,\n-            )\n-            assert block.content_hash is None\n-\n-            assert block.block_id not in self._blocks\n-            assert block.block_id is not None\n-            self._blocks[block.block_id] = block\n-            return block\n-\n-        # No block available in hashless allocator, nor in unused cache blocks.\n-        raise BlockAllocator.NoFreeBlocksError()\n+        block_id = self._allocate_block_id()\n+        block = self._block_pool.init_block(prev_block=prev_block,\n+                                            token_ids=[],\n+                                            block_size=self._block_size,\n+                                            physical_block_id=block_id)\n+        assert not block.computed\n+        assert block.content_hash is None\n+        return block\n \n-    def _incr_refcount_cached_block(self, block: Block,\n-                                    block_id: BlockId) -> None:\n-        # now _incr_refcount_cached_block comes from two place\n-        # allocate_immutable/promote_to_immutable_block where hit\n-        # _cached_blocks hash key.\n-        # In both cases, it means that already exists a already\n-        # computed block which shared with block now\n+    def _incr_refcount_cached_block(self, block: Block) -> None:\n+        # Set this block to be \"computed\" since it is pointing to a\n+        # cached block id (which was already computed)\n         block.computed = True\n \n+        block_id = block.block_id\n+        assert block_id is not None\n+\n         refcount = self._refcounter.incr(block_id)\n         if refcount == 1:\n-            # if block get referred, then it shall not be in evictor\n-            # and put it into _blocks for tracking\n+            # In case a cached block was evicted, restore its tracking\n             if block_id in self.evictor:\n                 self.evictor.remove(block_id)\n-            self._blocks[block_id] = block\n \n-    def free(self, block: Block) -> None:\n-        \"\"\"Decrement the refcount of the block. If the decremented refcount is\n-        zero, store the block in the freelist.\n+            self._track_block_id(block_id, computed=True)\n \n-        If the block has a content hash (meaning it is immutable), then we will\n-        keep the block around in case future allocations require it.\n-        \"\"\"\n-        assert (block.block_id\n-                is not None), \"freeing unallocated block is undefined\"\n+    def _decr_refcount_cached_block(self, block: Block) -> None:\n+        # Ensure this is immutable/cached block\n+        assert block.content_hash is not None\n+\n+        block_id = block.block_id\n+        assert block_id is not None\n+\n+        refcount = self._refcounter.decr(block_id)\n+        if refcount > 0:\n+            block.block_id = None\n+            return\n+        else:\n+            assert refcount == 0\n \n-        self._free_block_id_for_block(block.block_id, block)\n+        # No longer used\n+        assert block.content_hash in self._cached_blocks\n+\n+        # Add the cached block to the evictor\n+        # (This keeps the cached block around so it can be reused)\n+        self.evictor.add(block_id, block.content_hash, block.num_tokens_total,\n+                         self._block_tracker[block_id].last_accessed)\n+\n+        # Stop tracking the block\n+        self._untrack_block_id(block_id)\n \n         block.block_id = None\n \n-    def _free_block_id_for_block(self, block_id: BlockId,\n-                                 block: Block) -> None:\n-        assert isinstance(block, PrefixCachingBlock)\n-\n-        # if we comes from promote_to_immutable_block, it means that\n-        # block.content_hash is never None.\n-        # However we need to release the same content block, so that\n-        # physical block could get reused.\n-        if block.block_id != block_id or block.content_hash is None:\n-            refcount = self._refcounter.get(block_id)\n-            # We have fork case where block would get more than one ref,\n-            # so we cannot free it from tracking if ref cnt large than 1\n-            assert block.block_id is not None\n-            refcount = self._refcounter.get(block.block_id)\n-            if refcount == 1:\n-                del self._blocks[block.block_id]\n-\n-            return self._hashless_allocator.free(block)\n+    def _decr_refcount_hashless_block(self, block: Block) -> None:\n+        block_id = block.block_id\n+        assert block_id is not None\n \n-        refcount = self._refcounter.decr(block_id)\n+        # We may have a fork case where block is shared,\n+        # in which case, we cannot remove it from tracking\n+        refcount = self._refcounter.get(block_id)\n+        if refcount == 1:\n+            self._untrack_block_id(block_id)\n \n-        # If no longer used, add the block to the evictor.\n-        if refcount == 0:\n-            assert block.content_hash in self._cached_blocks\n-            assert block.block_id is not None\n-            del self._blocks[block.block_id]\n-            self.evictor.add(block.block_id, block.content_hash,\n-                             block.num_tokens_total, block.last_accessed)\n+        # Decrement refcount of the block_id, but do not free the block object\n+        # itself (will be handled by the caller)\n+        self._hashless_allocator.free(block, keep_block_object=True)\n+\n+    def _allocate_block_id(self) -> BlockId:\n+        \"\"\"First tries to allocate a block id from the hashless allocator,\n+        and if there are no blocks, then tries to evict an unused cached block.\n+        \"\"\"\n+        hashless_block_id = self._maybe_allocate_hashless_block_id()\n+        if hashless_block_id is not None:\n+            return hashless_block_id\n+\n+        evicted_block_id = self._maybe_allocate_evicted_block_id()\n+        if evicted_block_id is not None:\n+            return evicted_block_id\n+\n+        # No block available in hashless allocator, nor in unused cache blocks.\n+        raise BlockAllocator.NoFreeBlocksError()\n+\n+    def _maybe_allocate_hashless_block_id(self) -> Optional[BlockId]:\n+        try:\n+            # Allocate mutable block and extract its block_id\n+            block = self._hashless_allocator.allocate_mutable_block(\n+                prev_block=None)\n+            block_id = block.block_id\n+            self._block_pool.free_block(block)\n+\n+            self._track_block_id(block_id, computed=False)\n+            return block_id\n+        except BlockAllocator.NoFreeBlocksError:\n+            return None\n+\n+    def _maybe_allocate_evicted_block_id(self) -> Optional[BlockId]:\n+        if self.evictor.num_blocks == 0:\n+            return None\n+\n+        # Here we get an evicted block, which is only added\n+        # into evictor if its ref counter is 0\n+        # and since its content would be changed, we need\n+        # to remove it from _cached_blocks's tracking list\n+        block_id, content_hash_to_evict = self.evictor.evict()\n+\n+        # Sanity checks\n+        assert content_hash_to_evict in self._cached_blocks\n+        _block_id = self._cached_blocks[content_hash_to_evict]\n+        assert self._refcounter.get(_block_id) == 0\n+        assert _block_id == block_id\n+\n+        self._cached_blocks.pop(content_hash_to_evict)\n+\n+        self._refcounter.incr(block_id)\n+        self._track_block_id(block_id, computed=False)\n+\n+        return block_id\n+\n+    def _free_block_id(self, block: Block) -> None:\n+        \"\"\"Decrements the refcount of the block. The block may be in two \n+        possible states: (1) immutable/cached or (2) mutable/hashless. \n+        In the first case, the refcount is decremented directly and the block\n+        may be possibly added to the evictor. In other case, hashless \n+        allocator free(..) with keep_block_object=True is called to only free\n+        the block id (since the block object may be reused by the caller)\n+        \"\"\"\n+        block_id = block.block_id\n+        assert block_id is not None, \"Freeing unallocated block is undefined\"\n+\n+        if block.content_hash is not None:\n+            # Immutable: This type of block is always cached, and we want to\n+            # keep it in the evictor for future reuse\n+            self._decr_refcount_cached_block(block)\n+        else:\n+            # Mutable: This type of block is not cached, so we release it\n+            # directly to the hashless allocator\n+            self._decr_refcount_hashless_block(block)\n+\n+        assert block.block_id is None\n+\n+    def free(self, block: Block, keep_block_object: bool = False) -> None:\n+        \"\"\"Release the block (look at free_block_id(..) docs)\n+        \"\"\"\n+        # Release the physical block index\n+        self._free_block_id(block)\n+\n+        # Release the block object to the pool\n+        if not keep_block_object:\n+            self._block_pool.free_block(block)\n \n     def fork(self, last_block: Block) -> List[Block]:\n         \"\"\"Creates a new sequence of blocks that shares the same underlying\n@@ -274,17 +359,20 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         forked_blocks: List[Block] = []\n         prev_block = None\n         for block in source_blocks:\n-            refcount = self._refcounter.incr(block.block_id)\n-            assert refcount != 1, \"can't fork free'd block\"\n-\n-            forked_blocks.append(\n-                self._create_block(\n-                    prev_block=prev_block,\n-                    token_ids=block.token_ids,\n-                    block_id=block.block_id,\n-                    block_size=self._block_size,\n-                    allocator=self,\n-                ))\n+            block_id = block.block_id\n+            assert block_id is not None\n+\n+            refcount = self._refcounter.incr(block_id)\n+            assert refcount != 1, \"can't fork free'd block_id = {}\".format(\n+                block_id)\n+\n+            forked_block = self._block_pool.init_block(\n+                prev_block=prev_block,\n+                token_ids=block.token_ids,\n+                block_size=self._block_size,\n+                physical_block_id=block_id)\n+\n+            forked_blocks.append(forked_block)\n             prev_block = forked_blocks[-1]\n \n         return forked_blocks\n@@ -329,7 +417,7 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n \n         Note that if we already have a cached block with the same content, we\n         will replace the newly-promoted block's mapping with the existing cached\n-        block.\n+        block id.\n \n         Args:\n             block: The mutable block to be promoted.\n@@ -338,23 +426,30 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n             BlockId: Either the original block index, or the block index of\n                 the previously cached block matching the same content.\n         \"\"\"\n+        # Ensure block can be promoted\n         assert block.content_hash is not None\n         assert block.block_id is not None\n         assert self._refcounter.get(block.block_id) > 0\n \n-        # If the content hash does not have a corresponding cached block,\n-        # set this block as the cached block.\n         if block.content_hash not in self._cached_blocks:\n+            # No cached content hash => Set this block as cached\n+            # (Note that this block is not computed yet =>\n+            #  Will be computed after free())\n             self._cached_blocks[block.content_hash] = block.block_id\n-        else:\n-            self._free_block_id_for_block(\n-                self._cached_blocks[block.content_hash], block)\n-            self._incr_refcount_cached_block(\n-                block, self._cached_blocks[block.content_hash])\n+            return block.block_id\n \n-        return self._cached_blocks[block.content_hash]\n+        # Reuse the cached content hash\n+        self._decr_refcount_hashless_block(block)\n+        block.block_id = self._cached_blocks[block.content_hash]\n \n-    def cow_block_if_not_appendable(self, block: Block) -> Optional[BlockId]:\n+        # Increment refcount of the cached block and (possibly) restore\n+        # it from the evictor.\n+        # Note that in this case, the block is marked as computed\n+        self._incr_refcount_cached_block(block)\n+\n+        return block.block_id\n+\n+    def cow_block_if_not_appendable(self, block: Block) -> BlockId:\n         \"\"\"Performs a copy-on-write operation on the given block if it is not\n         appendable.\n \n@@ -362,11 +457,22 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n             block (Block): The block to check for copy-on-write.\n \n         Returns:\n-            Optional[BlockId]: The block index of the new block if a copy-on\n-                -write operation was performed, or the original block index if\n+            BlockId: The block index of the new block if a copy-on-write \n+                operation was performed, or the original block index if\n                 no copy-on-write was necessary.\n         \"\"\"\n-        return self._cow_tracker.cow_block_if_not_appendable(block)\n+        src_block_id = block.block_id\n+        assert src_block_id is not None\n+\n+        if self._cow_tracker.is_appendable(block):\n+            return src_block_id\n+\n+        self._free_block_id(block)\n+        trg_block_id = self._allocate_block_id()\n+\n+        self._cow_tracker.record_cow(src_block_id, trg_block_id)\n+\n+        return trg_block_id\n \n     def clear_copy_on_writes(self) -> List[Tuple[BlockId, BlockId]]:\n         \"\"\"Returns the copy-on-write source->destination mapping and clears it.\n@@ -386,8 +492,8 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         \"\"\"\n \n         for block_id in block_ids:\n-            if block_id in self._blocks:\n-                self._blocks[block_id].last_accessed = now\n+            if self._block_tracker[block_id].active:\n+                self._block_tracker[block_id].last_accessed = now\n             elif block_id in self.evictor:\n                 self.evictor.update(block_id, now)\n             else:\n@@ -395,25 +501,46 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n                     \"Mark block as accessed which is not belonged to GPU\")\n \n     def mark_blocks_as_computed(self, block_ids: List[int]) -> None:\n-        \"\"\"Mark blocks as computed, used in prefix caching.\"\"\"\n+        raise NotImplementedError(\"Marking as computed is incremental\")\n \n-        for block_id in block_ids:\n-            if block_id in self._blocks:\n-                # only those full block is valid for prefix caching\n-                if self._blocks[block_id].is_full:\n-                    self._blocks[block_id].computed = True\n-            elif block_id not in self.evictor:\n-                raise ValueError(f\"Mark {block_id=} as computed which \"\n-                                 \"is not belonged to GPU\")\n+    def _track_block_id(self, block_id: Optional[BlockId],\n+                        computed: bool) -> None:\n+        assert block_id is not None\n+        self._block_tracker[block_id].enable()\n+        self._block_tracker[block_id].computed = computed\n+\n+    def _untrack_block_id(self, block_id: Optional[BlockId]) -> None:\n+        assert block_id is not None\n+        self._block_tracker[block_id].disable()\n \n     def block_is_computed(self, block_id: int) -> bool:\n-        if block_id in self._blocks:\n-            return self._blocks[block_id].computed\n+        if self._block_tracker[block_id].active:\n+            return self._block_tracker[block_id].computed\n         else:\n             return block_id in self.evictor\n \n+    def get_computed_block_ids(self,\n+                               prev_computed_block_ids: List[int],\n+                               block_ids: List[int],\n+                               skip_last_block_id: bool = True) -> List[int]:\n+        prev_prefix_size = len(prev_computed_block_ids)\n+        cur_size = len(block_ids)\n+        if skip_last_block_id:\n+            cur_size -= 1\n+\n+        # Sanity checks\n+        assert cur_size >= 0\n+        assert prev_prefix_size <= cur_size\n+\n+        ret = prev_computed_block_ids\n+        for i in range(prev_prefix_size, cur_size):\n+            block_id = block_ids[i]\n+            if self.block_is_computed(block_id):\n+                ret.append(block_id)\n+        return ret\n+\n     def get_common_computed_block_ids(\n-            self, seq_block_ids: List[List[int]]) -> List[int]:\n+            self, computed_seq_block_ids: List[List[int]]) -> List[int]:\n         \"\"\"Return the block ids that are common for a given sequence group.\n \n         Only those blocks that are immutable and already be marked\n@@ -424,14 +551,9 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n         # prompt is cached. This would cause erroneous behavior in model\n         # runner.\n \n-        ids_list = [\n-            list(\n-                takewhile(lambda block_id: self.block_is_computed(block_id),\n-                          seq[:-1])) for seq in seq_block_ids\n-        ]\n         # It returns a list of int although type annotation says list of string.\n         return commonprefix([\n-            ids for ids in ids_list  # type: ignore\n+            ids for ids in computed_seq_block_ids  # type: ignore\n             if ids != []\n         ])\n \n@@ -473,10 +595,10 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n             blocks: List of blocks to be swapped out.\n         \"\"\"\n         for block in blocks:\n-            self.free(block)\n+            self._free_block_id(block)\n \n     def swap_in(self, blocks: List[Block]) -> None:\n-        \"\"\"Execute the swap int actions. Change the block id from \n+        \"\"\"Execute the swap in actions. Change the block id from \n         old allocator to current allocator for each block to finish \n         the block table update. \n \n@@ -484,13 +606,22 @@ class PrefixCachingBlockAllocator(BlockAllocator):\n             blocks: List of blocks to be swapped in.\n         \"\"\"\n         for block in blocks:\n+            # Here we allocate either immutable or mutable block and then\n+            # extract its block_id. Note that the block object is released\n+            # and the block_id is assigned to \"block\" to allow reusing the\n+            # existing \"block\" object\n             if block.is_full:\n-                alloc = self.allocate_immutable(block.prev_block,\n-                                                block.token_ids)\n+                tmp_block = self.allocate_immutable_block(\n+                    prev_block=block.prev_block, token_ids=block.token_ids)\n             else:\n-                alloc = self.allocate_mutable(block.prev_block)\n-                alloc.append_token_ids(block.token_ids)\n-            block.block_id = alloc.block_id\n+                tmp_block = self.allocate_mutable_block(\n+                    prev_block=block.prev_block)\n+                tmp_block.append_token_ids(block.token_ids)\n+\n+            block_id = tmp_block.block_id\n+            self._block_pool.free_block(tmp_block)\n+\n+            block.block_id = block_id  # Assign block_id\n \n \n class PrefixCachingBlock(Block):\n@@ -507,7 +638,7 @@ class PrefixCachingBlock(Block):\n         token_ids (List[int]): The initial token IDs to be stored in the block.\n         block_size (int): The maximum number of token IDs that can be stored in\n             the block.\n-        prefix_caching_allocator (BlockAllocator): The prefix\n+        allocator (BlockAllocator): The prefix\n             caching block allocator associated with this block.\n         block_id (Optional[int], optional): The physical block index\n             of this block. Defaults to None.\n@@ -518,31 +649,55 @@ class PrefixCachingBlock(Block):\n         prev_block: Optional[Block],\n         token_ids: List[int],\n         block_size: int,\n-        prefix_caching_allocator: BlockAllocator,\n+        allocator: BlockAllocator,\n         block_id: Optional[int] = None,\n         computed: bool = False,\n     ):\n-        assert isinstance(prefix_caching_allocator,\n-                          PrefixCachingBlockAllocator), (\n-                              \"Currently this class is only tested with \"\n-                              \"PrefixCachingBlockAllocator.\")\n+        assert isinstance(allocator, PrefixCachingBlockAllocator), (\n+            \"Currently this class is only tested with \"\n+            \"PrefixCachingBlockAllocator. Got instead allocator = {}\".format(\n+                allocator))\n         assert_prefix_caching_block_or_none(prev_block)\n \n         self._prev_block = prev_block\n         self._cached_content_hash: Optional[int] = None\n-        self._cached_num_tokens_total: Optional[int] = None\n-        self._prefix_caching_allocator = prefix_caching_allocator\n+        self._cached_num_tokens_total: int = 0\n+        self._allocator = allocator\n         self._last_accessed: float = _DEFAULT_LAST_ACCESSED_TIME\n         self._computed = computed\n \n-        self._block = NaiveBlock(\n-            prev_block=prev_block,\n-            token_ids=token_ids,\n-            block_size=block_size,\n-            block_id=block_id,\n-            allocator=prefix_caching_allocator,\n-            _cow_target=self,\n-        )\n+        # On the first time, we create the block object, and next we only\n+        # reinitialize it\n+        if hasattr(self, \"_block\"):\n+            self._block.__init__(  # type: ignore[has-type]\n+                prev_block=prev_block,\n+                token_ids=token_ids,\n+                block_size=block_size,\n+                block_id=block_id,\n+                allocator=self._allocator)\n+        else:\n+            self._block = NaiveBlock(prev_block=prev_block,\n+                                     token_ids=token_ids,\n+                                     block_size=block_size,\n+                                     block_id=block_id,\n+                                     allocator=self._allocator)\n+\n+        self._update_num_tokens_total()\n+\n+    def _update_num_tokens_total(self):\n+        \"\"\"Incrementally computes the number of tokens that there is\n+        till the current block (included)\n+        \"\"\"\n+        res = 0\n+\n+        # Add all previous blocks\n+        if self._prev_block is not None:\n+            res += self._prev_block.num_tokens_total\n+\n+        # Add current block\n+        res += len(self.token_ids)\n+\n+        self._cached_num_tokens_total = res\n \n     @property\n     def computed(self) -> bool:\n@@ -564,22 +719,28 @@ class PrefixCachingBlock(Block):\n         \"\"\"Appends the given token IDs to the block and registers the block as\n         immutable if the block becomes full.\n \n-        Internally, the naive block handles CoW.\n-\n         Args:\n             token_ids (List[int]): The token IDs to be appended to the block.\n         \"\"\"\n-        assert token_ids\n+        # Ensure this is mutable block (not promoted)\n+        assert self.content_hash is None\n+        assert not self.computed\n+\n+        if len(token_ids) == 0:\n+            return\n \n-        # naive block handles CoW.\n+        # Ensure there are input tokens\n+        assert token_ids, \"Got token_ids = {}\".format(token_ids)\n+\n+        # Naive block handles CoW.\n         self._block.append_token_ids(token_ids)\n+        self._update_num_tokens_total()\n \n         # If the content hash is present, then the block can be made immutable.\n         # Register ourselves with the allocator, potentially replacing the\n         # physical block index.\n         if self.content_hash is not None:\n-            self.block_id = (self._prefix_caching_allocator.\n-                             promote_to_immutable_block(self))\n+            self.block_id = self._allocator.promote_to_immutable_block(self)\n \n     @property\n     def block_id(self) -> Optional[int]:\n@@ -599,23 +760,6 @@ class PrefixCachingBlock(Block):\n \n     @property\n     def num_tokens_total(self) -> int:\n-        \"\"\"return the total tokens so far.\n-\n-        Here we iterate the block chain till to the first block, while\n-        cache the result in local to prevent repeated computations.\n-        \"\"\"\n-        if self._cached_num_tokens_total is not None:\n-            return self._cached_num_tokens_total\n-\n-        _block: Optional[Block] = self\n-        self._cached_num_tokens_total = 0\n-\n-        # TODO: current implement here take O(N^2), we expect future\n-        # we have O(1) here\n-        while _block is not None:\n-            self._cached_num_tokens_total += len(_block.token_ids)\n-            _block = _block.prev_block\n-\n         return self._cached_num_tokens_total\n \n     @property\n@@ -638,7 +782,6 @@ class PrefixCachingBlock(Block):\n         For the content-based hash to be defined, the current block must be\n         full.\n         \"\"\"\n-\n         # If the hash is already computed, return it.\n         if self._cached_content_hash is not None:\n             return self._cached_content_hash\n@@ -688,7 +831,129 @@ class PrefixCachingBlock(Block):\n         return hash((is_first_block, prev_block_hash, *cur_block_token_ids))\n \n \n+class ComputedBlocksTracker:\n+    \"\"\"Handles caching of per-sequence computed block ids. \n+        When a sequence appears for the first time, it traverses all of the \n+        blocks and detects the prefix of blocks that is computed. On the\n+        subsequent times, it only traverses the new blocks that were added \n+        and updates the already recorded prefix of blocks with the newly \n+        computed blocks.\n+\n+        To avoid redundant traversals, the algorithm also detects when there\n+        is a \"gap\" in the computed prefix. For example, if we have blocks =\n+        [1,2,3,4,5], and we have detected [1,2,3] as the computed prefix, then\n+        we won't try to add more computed blocks to [1,2,3] in this sequence\n+        iteration, and will add more computed blocks only after the sequence is\n+        freed and reused again.\n+\n+        Note that currently, for a given sequence, we also skip the last \n+        block id for caching purposes, to avoid caching of a full sequence\n+    \"\"\"\n+\n+    def __init__(self, allocator):\n+        self._allocator = allocator\n+        self._cached_computed_seq_blocks: Dict[int, Tuple[List[int],\n+                                                          bool]] = {}\n+\n+    def add_seq(self, seq_id: int) -> None:\n+        \"\"\"Start tracking seq_id\n+        \"\"\"\n+        assert seq_id not in self._cached_computed_seq_blocks\n+        self._cached_computed_seq_blocks[seq_id] = ([], False)\n+\n+    def remove_seq(self, seq_id: int) -> None:\n+        \"\"\"Stop tracking seq_id\n+        \"\"\"\n+        assert seq_id in self._cached_computed_seq_blocks\n+        del self._cached_computed_seq_blocks[seq_id]\n+\n+    def get_cached_computed_blocks_and_update(\n+            self, seq_id: int, block_ids: List[int]) -> List[int]:\n+        \"\"\" Look at the class documentation for details\n+        \"\"\"\n+        # Ensure seq_id is already tracked\n+        assert seq_id in self._cached_computed_seq_blocks\n+\n+        # Get cached data (may be empty on the first time)\n+        prev_computed_block_ids, has_gap = self._cached_computed_seq_blocks[\n+            seq_id]\n+\n+        if has_gap:\n+            # When gap is detected, we do not add more computed blocks at this\n+            # sequence iteration\n+            return prev_computed_block_ids\n+\n+        # We do not consider the last block id for caching purposes.\n+        num_cur_blocks = len(block_ids) - 1\n+        assert num_cur_blocks >= 0\n+\n+        if len(prev_computed_block_ids) >= num_cur_blocks:\n+            # Cache HIT\n+            assert len(prev_computed_block_ids) == num_cur_blocks\n+            return prev_computed_block_ids\n+\n+        # If here, then we may possibly add more computed blocks. As a result,\n+        # traverse the additional blocks after prev_computed_block_ids to\n+        # detect more computed blocks and add them.\n+\n+        # Incremental init for seq_id => Look only at the new blocks\n+        computed_block_ids = self._allocator.get_computed_block_ids(  # noqa: E501\n+            prev_computed_block_ids,\n+            block_ids,\n+            skip_last_block_id=\n+            True,  # We skip last block id to avoid caching of full seq\n+        )\n+\n+        # Detect if there is a \"gap\"\n+        has_gap = len(computed_block_ids) < num_cur_blocks\n+\n+        # Record\n+        self._cached_computed_seq_blocks[seq_id] = (computed_block_ids,\n+                                                    has_gap)\n+\n+        return computed_block_ids\n+\n+\n+class LastAccessBlocksTracker:\n+    \"\"\"Manages the last access time of the tracked sequences, in order to allow\n+    an efficient update of allocator's block last access times\n+    \"\"\"\n+\n+    def __init__(self, allocator):\n+        self._allocator = allocator\n+        self._seq_last_access: Dict[int, Optional[float]] = {}\n+\n+    def add_seq(self, seq_id: int) -> None:\n+        \"\"\"Start tracking seq_id\n+        \"\"\"\n+        assert seq_id not in self._seq_last_access\n+        self._seq_last_access[seq_id] = None\n+\n+    def remove_seq(self, seq_id: int) -> None:\n+        \"\"\"Stop tracking seq_id\n+        \"\"\"\n+        assert seq_id in self._seq_last_access\n+        del self._seq_last_access[seq_id]\n+\n+    def update_last_access(self, seq_id: int, time: float) -> None:\n+        assert seq_id in self._seq_last_access\n+        self._seq_last_access[seq_id] = time\n+\n+    def update_seq_blocks_last_access(self, seq_id: int,\n+                                      block_ids: List[int]) -> None:\n+        assert seq_id in self._seq_last_access\n+\n+        ts = self._seq_last_access[seq_id]\n+\n+        if ts is None:\n+            # No last access was recorded, no need to update.\n+            return\n+\n+        self._allocator.mark_blocks_as_accessed(block_ids, ts)\n+\n+\n def assert_prefix_caching_block_or_none(block: Optional[Block]):\n     if block is None:\n         return\n-    assert isinstance(block, PrefixCachingBlock)\n+    assert isinstance(block,\n+                      PrefixCachingBlock), \"Got block = {}\".format(block)\ndiff --git a/vllm/core/block_manager_v2.py b/vllm/core/block_manager_v2.py\nindex 309775237..6a6eebc39 100644\n--- a/vllm/core/block_manager_v2.py\n+++ b/vllm/core/block_manager_v2.py\n@@ -7,6 +7,8 @@ from typing import Tuple\n from vllm.core.block.block_table import BlockTable\n from vllm.core.block.cpu_gpu_block_allocator import CpuGpuBlockAllocator\n from vllm.core.block.interfaces import Block\n+from vllm.core.block.prefix_caching_block import (ComputedBlocksTracker,\n+                                                  LastAccessBlocksTracker)\n from vllm.core.block.utils import check_no_caching_or_swa_for_blockmgr_encdec\n from vllm.core.interfaces import AllocStatus, BlockSpaceManager\n from vllm.sequence import Sequence, SequenceGroup, SequenceStatus\n@@ -100,6 +102,11 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n         self.block_tables: Dict[SeqId, BlockTable] = {}\n         self.cross_block_tables: Dict[EncoderSeqId, BlockTable] = {}\n \n+        self._computed_blocks_tracker = ComputedBlocksTracker(\n+            self.block_allocator)\n+        self._last_access_blocks_tracker = LastAccessBlocksTracker(\n+            self.block_allocator)\n+\n     def can_allocate(self, seq_group: SequenceGroup) -> AllocStatus:\n         # FIXME(woosuk): Here we assume that all sequences in the group share\n         # the same prompt. This may not be true for preempted sequences.\n@@ -157,10 +164,18 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n         block_table: BlockTable = self._allocate_sequence(seq)\n         self.block_tables[seq.seq_id] = block_table\n \n+        # Track seq\n+        self._computed_blocks_tracker.add_seq(seq.seq_id)\n+        self._last_access_blocks_tracker.add_seq(seq.seq_id)\n+\n         # Assign the block table for each sequence.\n         for seq in waiting_seqs[1:]:\n             self.block_tables[seq.seq_id] = block_table.fork()\n \n+            # Track seq\n+            self._computed_blocks_tracker.add_seq(seq.seq_id)\n+            self._last_access_blocks_tracker.add_seq(seq.seq_id)\n+\n         # Allocate cross-attention block table for encoder sequence\n         #\n         # NOTE: Here we assume that all sequences in the group have the same\n@@ -224,11 +239,23 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n         return new_cows\n \n     def free(self, seq: Sequence) -> None:\n-        if seq.seq_id not in self.block_tables:\n+        seq_id = seq.seq_id\n+\n+        if seq_id not in self.block_tables:\n             # Already freed or haven't been scheduled yet.\n             return\n-        self.block_tables[seq.seq_id].free()\n-        del self.block_tables[seq.seq_id]\n+\n+        # Update seq block ids with the latest access time\n+        self._last_access_blocks_tracker.update_seq_blocks_last_access(\n+            seq_id, self.block_tables[seq.seq_id].physical_block_ids)\n+\n+        # Untrack seq\n+        self._last_access_blocks_tracker.remove_seq(seq_id)\n+        self._computed_blocks_tracker.remove_seq(seq_id)\n+\n+        # Free table/blocks\n+        self.block_tables[seq_id].free()\n+        del self.block_tables[seq_id]\n \n     def free_cross(self, seq_group: SequenceGroup) -> None:\n         request_id = seq_group.request_id\n@@ -239,9 +266,7 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n         del self.cross_block_tables[request_id]\n \n     def get_block_table(self, seq: Sequence) -> List[int]:\n-        assert seq.seq_id in self.block_tables\n         block_ids = self.block_tables[seq.seq_id].physical_block_ids\n-        assert all(b is not None for b in block_ids)\n         return block_ids  # type: ignore\n \n     def get_cross_block_table(self, seq_group: SequenceGroup) -> List[int]:\n@@ -252,20 +277,14 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n         return block_ids  # type: ignore\n \n     def access_all_blocks_in_seq(self, seq: Sequence, now: float):\n-        # Update the last accessed time of all the blocks accessed\n-        # in this step.\n-        # And the accessed time is only useful for prefix caching now,\n-        # as it support internal evictor policy for which cached\n-        # block could be refilled, to keep cached content could be reused\n-        # at max extend.\n         if self.enable_caching:\n-            block_table = self.block_tables[seq.seq_id]\n-            block_ids: List[Optional[int]] = []\n-            for block_id in block_table.physical_block_ids:\n-                block_ids.append(block_id)\n-            self.block_allocator.mark_blocks_as_accessed(\n-                block_ids,  # type: ignore\n-                now)\n+            # Record the latest access time for the sequence. The actual update\n+            # of the block ids is deferred to the sequence free(..) call, since\n+            # only during freeing of block ids, the blocks are actually added to\n+            # the evictor (which is when the most updated time is required)\n+            # (This avoids expensive calls to mark_blocks_as_accessed(..))\n+            self._last_access_blocks_tracker.update_last_access(\n+                seq.seq_id, now)\n \n     def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n         # The only need for mark block as computed is for prefix caching,\n@@ -285,17 +304,26 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n         This method determines which blocks can be safely skipped for all\n         sequences in the sequence group.\n         \"\"\"\n-        seq_block_ids = [\n-            self.block_tables[seq.seq_id].physical_block_ids for seq in seqs\n-        ]\n+        computed_seq_block_ids = []\n+        for seq in seqs:\n+            computed_seq_block_ids.append(\n+                self._computed_blocks_tracker.\n+                get_cached_computed_blocks_and_update(\n+                    seq.seq_id,\n+                    self.block_tables[seq.seq_id].physical_block_ids))\n+\n         # NOTE(sang): This assumes seq_block_ids doesn't contain any None.\n         return self.block_allocator.get_common_computed_block_ids(\n-            seq_block_ids)  # type: ignore\n+            computed_seq_block_ids)  # type: ignore\n \n     def fork(self, parent_seq: Sequence, child_seq: Sequence) -> None:\n         src_block_table = self.block_tables[parent_seq.seq_id]\n         self.block_tables[child_seq.seq_id] = src_block_table.fork()\n \n+        # Track child seq\n+        self._computed_blocks_tracker.add_seq(child_seq.seq_id)\n+        self._last_access_blocks_tracker.add_seq(child_seq.seq_id)\n+\n     def can_swap_in(self, seq_group: SequenceGroup,\n                     num_lookahead_slots: int) -> AllocStatus:\n         \"\"\"Returns the AllocStatus for the given sequence_group \n@@ -323,19 +351,31 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n             List[Tuple[int, int]]: The mapping of swapping block from CPU \n                 to GPU.\n         \"\"\"\n-        blocks = self._get_blocks_for_swap(seq_group, SequenceStatus.SWAPPED)\n-        current_swap_mapping = self.block_allocator.swap(\n-            blocks=blocks, source_device=Device.CPU, dest_device=Device.GPU)\n-\n-        block_number_mapping = {\n-            self.block_allocator.get_physical_block_id(Device.CPU,\n-                                                       cpu_block_id):\n-            self.block_allocator.get_physical_block_id(Device.GPU,\n-                                                       gpu_block_id)\n-            for cpu_block_id, gpu_block_id in current_swap_mapping.items()\n-        }\n-        # convert to list of tuples once here\n-        return list(block_number_mapping.items())\n+        physical_block_id_mapping = []\n+        for seq in seq_group.get_seqs(status=SequenceStatus.SWAPPED):\n+            blocks = self.block_tables[seq.seq_id].blocks\n+            if len(blocks) == 0:\n+                continue\n+\n+            seq_swap_mapping = self.block_allocator.swap(blocks=blocks,\n+                                                         src_device=Device.CPU,\n+                                                         dst_device=Device.GPU)\n+\n+            # Refresh the block ids of the table (post-swap)\n+            self.block_tables[seq.seq_id].update(blocks)\n+\n+            seq_physical_block_id_mapping = {\n+                self.block_allocator.get_physical_block_id(\n+                    Device.CPU, cpu_block_id):\n+                self.block_allocator.get_physical_block_id(\n+                    Device.GPU, gpu_block_id)\n+                for cpu_block_id, gpu_block_id in seq_swap_mapping.items()\n+            }\n+\n+            physical_block_id_mapping.extend(\n+                list(seq_physical_block_id_mapping.items()))\n+\n+        return physical_block_id_mapping\n \n     def can_swap_out(self, seq_group: SequenceGroup) -> bool:\n         \"\"\"Returns whether we can swap out the given sequence_group \n@@ -355,7 +395,7 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n             return True\n         return False\n \n-    def swap_out(self, sequence_group: SequenceGroup) -> List[Tuple[int, int]]:\n+    def swap_out(self, seq_group: SequenceGroup) -> List[Tuple[int, int]]:\n         \"\"\"Returns the block id mapping (from GPU to CPU) generated by\n         swapping out the given sequence_group with num_lookahead_slots.\n \n@@ -366,19 +406,31 @@ class BlockSpaceManagerV2(BlockSpaceManager):\n             List[Tuple[int, int]]: The mapping of swapping block from \n                 GPU to CPU.\n         \"\"\"\n-        blocks = self._get_blocks_for_swap(sequence_group,\n-                                           SequenceStatus.RUNNING)\n-        current_swap_mapping = self.block_allocator.swap(\n-            blocks=blocks, source_device=Device.GPU, dest_device=Device.CPU)\n-        block_number_mapping = {\n-            self.block_allocator.get_physical_block_id(Device.GPU,\n-                                                       gpu_block_id):\n-            self.block_allocator.get_physical_block_id(Device.CPU,\n-                                                       cpu_block_id)\n-            for gpu_block_id, cpu_block_id in current_swap_mapping.items()\n-        }\n-        # convert to list of tuples once here\n-        return list(block_number_mapping.items())\n+        physical_block_id_mapping = []\n+        for seq in seq_group.get_seqs(status=SequenceStatus.RUNNING):\n+            blocks = self.block_tables[seq.seq_id].blocks\n+            if len(blocks) == 0:\n+                continue\n+\n+            seq_swap_mapping = self.block_allocator.swap(blocks=blocks,\n+                                                         src_device=Device.GPU,\n+                                                         dst_device=Device.CPU)\n+\n+            # Refresh the block ids of the table (post-swap)\n+            self.block_tables[seq.seq_id].update(blocks)\n+\n+            seq_physical_block_id_mapping = {\n+                self.block_allocator.get_physical_block_id(\n+                    Device.GPU, gpu_block_id):\n+                self.block_allocator.get_physical_block_id(\n+                    Device.CPU, cpu_block_id)\n+                for gpu_block_id, cpu_block_id in seq_swap_mapping.items()\n+            }\n+\n+            physical_block_id_mapping.extend(\n+                list(seq_physical_block_id_mapping.items()))\n+\n+        return physical_block_id_mapping\n \n     def get_num_free_gpu_blocks(self) -> int:\n         return self.block_allocator.get_num_free_blocks(Device.GPU)\ndiff --git a/vllm/engine/llm_engine.py b/vllm/engine/llm_engine.py\nindex 5886ebc24..c13b17471 100644\n--- a/vllm/engine/llm_engine.py\n+++ b/vllm/engine/llm_engine.py\n@@ -177,7 +177,8 @@ class LLMEngine:\n             \"enforce_eager=%s, kv_cache_dtype=%s, \"\n             \"quantization_param_path=%s, device_config=%s, \"\n             \"decoding_config=%r, observability_config=%r, \"\n-            \"seed=%d, served_model_name=%s)\",\n+            \"seed=%d, served_model_name=%s, use_v2_block_manager=%s, \"\n+            \"enable_prefix_caching=%s)\",\n             VLLM_VERSION,\n             model_config.model,\n             speculative_config,\n@@ -204,6 +205,8 @@ class LLMEngine:\n             observability_config,\n             model_config.seed,\n             model_config.served_model_name,\n+            scheduler_config.use_v2_block_manager,\n+            cache_config.enable_prefix_caching,\n         )\n         # TODO(woosuk): Print more configs in debug mode.\n \ndiff --git a/vllm/entrypoints/openai/serving_completion.py b/vllm/entrypoints/openai/serving_completion.py\nindex 8741893c9..1bd095655 100644\n--- a/vllm/entrypoints/openai/serving_completion.py\n+++ b/vllm/entrypoints/openai/serving_completion.py\n@@ -345,7 +345,7 @@ class OpenAIServingCompletion(OpenAIServing):\n                     out_logprobs = prompt_logprobs\n                     output_text = prompt_text\n                 elif request.echo and request.max_tokens > 0:\n-                    token_ids = prompt_token_ids + output.token_ids\n+                    token_ids = prompt_token_ids + list(output.token_ids)\n                     out_logprobs = (prompt_logprobs + output.logprobs\n                                     if request.logprobs is not None else None)\n                     output_text = prompt_text + output.text\ndiff --git a/vllm/model_executor/sampling_metadata.py b/vllm/model_executor/sampling_metadata.py\nindex f95de56f3..ad5fb1317 100644\n--- a/vllm/model_executor/sampling_metadata.py\n+++ b/vllm/model_executor/sampling_metadata.py\n@@ -427,8 +427,8 @@ class SamplingTensors:\n                 if seq_group.do_sample:\n                     for seq_id in seq_ids:\n                         seq_data = seq_group.seq_data[seq_id]\n-                        prompt_tokens.append(seq_data.prompt_token_ids)\n-                        output_tokens.append(seq_data.output_token_ids)\n+                        prompt_tokens.append(list(seq_data.prompt_token_ids))\n+                        output_tokens.append(list(seq_data.output_token_ids))\n \n         sampling_tensors = SamplingTensors.from_lists(\n             temperatures, top_ps, top_ks, min_ps, presence_penalties,\ndiff --git a/vllm/outputs.py b/vllm/outputs.py\nindex 49f526b5f..4cb7f06bd 100644\n--- a/vllm/outputs.py\n+++ b/vllm/outputs.py\n@@ -1,6 +1,6 @@\n import time\n from dataclasses import dataclass\n-from typing import List, Optional, Union\n+from typing import List, Optional, Tuple, Union\n \n from vllm.lora.request import LoRARequest\n from vllm.sequence import (PromptLogprobs, RequestMetrics, SampleLogprobs,\n@@ -28,7 +28,7 @@ class CompletionOutput:\n \n     index: int\n     text: str\n-    token_ids: List[int]\n+    token_ids: Tuple[int, ...]\n     cumulative_logprob: float\n     logprobs: Optional[SampleLogprobs]\n     finish_reason: Optional[str] = None\ndiff --git a/vllm/sequence.py b/vllm/sequence.py\nindex 22cb26dc0..21c558d44 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -116,41 +116,66 @@ class SequenceData:\n         prompt_token_ids: List[int],\n         output_token_ids: Optional[List[int]] = None,\n     ) -> None:\n-        if output_token_ids is None:\n-            output_token_ids = []\n+        self._prompt_token_ids: List[int] = list(prompt_token_ids)\n+        self._prompt_token_ids_tuple: Tuple[int, ...] = tuple(prompt_token_ids)\n+        self._output_token_ids: List[int] = (\n+            list(output_token_ids) if output_token_ids is not None else [])\n \n-        self.prompt_token_ids = prompt_token_ids\n-        self._prompt_token_ids_tuple = tuple(prompt_token_ids)\n-        self.output_token_ids = output_token_ids\n         self.cumulative_logprob = 0.0\n         # The number of tokens that are computed (that run against the model).\n         self._num_computed_tokens = 0\n         self._stage: SequenceStage = SequenceStage.PREFILL\n \n+        self._update_cached_all_tokens()\n+\n+    def _update_cached_all_tokens(self):\n+        self._cached_all_token_ids: List[int] = (self._prompt_token_ids +\n+                                                 self._output_token_ids)\n+\n+    @property\n+    def prompt_token_ids(self) -> Tuple[int, ...]:\n+        return self._prompt_token_ids_tuple\n+\n+    @prompt_token_ids.setter\n+    def prompt_token_ids(self, new_prompt_token_ids) -> None:\n+        self._prompt_token_ids = list(new_prompt_token_ids)\n+        self._prompt_token_ids_tuple = tuple(new_prompt_token_ids)\n+        self._update_cached_all_tokens()\n+\n+    @property\n+    def output_token_ids(self) -> Tuple[int, ...]:\n+        return tuple(self._output_token_ids)\n+\n+    @output_token_ids.setter\n+    def output_token_ids(self, new_output_token_ids) -> None:\n+        self._output_token_ids = list(new_output_token_ids)\n+        self._update_cached_all_tokens()\n+\n     def append_token_id(self, token_id: int, logprob: float) -> None:\n-        self.output_token_ids.append(token_id)\n+        self._output_token_ids.append(token_id)\n+        self._cached_all_token_ids.append(token_id)\n         self.cumulative_logprob += logprob\n \n     def get_len(self) -> int:\n-        return len(self.output_token_ids) + len(self.prompt_token_ids)\n+        return len(self._output_token_ids) + len(self._prompt_token_ids)\n \n     def get_prompt_len(self) -> int:\n-        return len(self.prompt_token_ids)\n+        return len(self._prompt_token_ids)\n \n     def get_output_len(self) -> int:\n-        return len(self.output_token_ids)\n+        return len(self._output_token_ids)\n \n     def get_token_ids(self) -> List[int]:\n-        return self.prompt_token_ids + self.output_token_ids\n+        return self._cached_all_token_ids\n \n     def get_prefix_token_ids(\n             self, num_tokens: int\n     ) -> Tuple[Tuple[int, ...], Optional[Tuple[int, ...]]]:\n         \"\"\"Get prefix tokens, and make the return value hashable\"\"\"\n-        prompt_length = len(self.prompt_token_ids)\n+        prompt_length = self.get_prompt_len()\n         if num_tokens > prompt_length:\n             return (self._prompt_token_ids_tuple,\n-                    tuple(self.output_token_ids[:num_tokens - prompt_length]))\n+                    tuple(self._output_token_ids[:num_tokens - prompt_length]))\n         else:\n             return (self._prompt_token_ids_tuple[:num_tokens], None)\n \n@@ -183,14 +208,14 @@ class SequenceData:\n         return self.get_len() - self.get_num_computed_tokens()\n \n     def get_last_token_id(self) -> int:\n-        if not self.output_token_ids:\n-            return self.prompt_token_ids[-1]\n-        return self.output_token_ids[-1]\n+        if not self._output_token_ids:\n+            return self._prompt_token_ids[-1]\n+        return self._output_token_ids[-1]\n \n-    def get_prompt_token_ids(self) -> List[int]:\n+    def get_prompt_token_ids(self) -> Tuple[int, ...]:\n         return self.prompt_token_ids\n \n-    def get_output_token_ids(self) -> List[int]:\n+    def get_output_token_ids(self) -> Tuple[int, ...]:\n         return self.output_token_ids\n \n     @property\n@@ -199,8 +224,8 @@ class SequenceData:\n \n     def __repr__(self) -> str:\n         return (f\"SequenceData(\"\n-                f\"prompt_token_ids={self.prompt_token_ids}, \"\n-                f\"output_token_ids={self.output_token_ids}, \"\n+                f\"prompt_token_ids={self._prompt_token_ids}, \"\n+                f\"output_token_ids={self._output_token_ids}, \"\n                 f\"cumulative_logprob={self.cumulative_logprob})\")\n \n \n@@ -306,14 +331,14 @@ class Sequence:\n     def get_token_ids(self) -> List[int]:\n         return self.data.get_token_ids()\n \n-    def get_prompt_token_ids(self) -> List[int]:\n+    def get_prompt_token_ids(self) -> Tuple[int, ...]:\n         return self.data.get_prompt_token_ids()\n \n     def get_last_token_id(self) -> int:\n         return self.data.get_last_token_id()\n \n-    def get_output_token_ids(self) -> List[int]:\n-        return self.data.output_token_ids\n+    def get_output_token_ids(self) -> Tuple[int, ...]:\n+        return self.data.get_output_token_ids()\n \n     def get_cumulative_logprob(self) -> float:\n         return self.data.cumulative_logprob", "apis": ["CpuGpuBlockAllocator.allocate_mutable_block", "CpuGpuBlockAllocator.allocate_immutable_block", "PrefixCachingBlockAllocator.allocate_mutable_block", "PrefixCachingBlockAllocator.allocate_immutable_block", "PrefixCachingBlock.__init__"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_completion.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit changes a benchmark file (\"benchmarks/benchmark_latency.py\") which is a non-test file and affects how the benchmark measures latency by toggling prefix caching. In addition, significant modifications in the block allocator and caching behavior are made in various test files to verify the new behavior. The commit message indicates a performance optimization (\"Optimize block_manager_v2 vs block_manager_v1, to make V2 default\") and the changes affect the core block allocation and caching mechanisms that likely have performance implications. Thus, despite some refactoring and test changes, the modifications are aimed at performance optimization on the CPU.", "llm_api_reason": "The commit makes several changes to improve and streamline the block management API used by the core components. In particular, it replaces the old allocation methods (allocate_mutable and allocate_immutable) with new ones (allocate_mutable_block and allocate_immutable_block) in the block allocator classes. The tests have been updated to use the new method names, and even the constructor of the prefix-caching block is changed to expect an \"allocator\" parameter instead of a \"prefix_caching_allocator\". These modifications ensure that the V2 block manager becomes the default mechanism."}
{"commit_hash": "7c01f706418d593b3cf23d2ec9110dca7151c539", "pr_url": "https://github.com/vllm-project/vllm/pull/5974", "pr_date": "2024-06-29", "timeline_text": "Copy link Collaborator Yard1 commented Jun 28, 2024 This is a small performance tweak - we call SequenceStatus.is_finished very often, and each time we used to create a list. By switching to an IntEnum , we can do a simple is greater comparison, speeding things up. PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Optimize SequenceStatus.is_finished by switching to IntEnum 2df4810 youkaichao approved these changes Jun 28, 2024 View reviewed changes Copy link Member youkaichao left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Yard1 enabled auto-merge (squash) June 28, 2024 23:42 Yard1 merged commit 7c01f70 into main Jun 29, 2024 robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jul 1, 2024 [Core] Optimize SequenceStatus.is_finished by switching to IntEnum ( vâ€¦ â€¦ 270105d â€¦llm-project#5974 ) prashantgupta24 pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request Jul 1, 2024 [Core] Optimize SequenceStatus.is_finished by switching to IntEnum ( vâ€¦ â€¦ 01789ba â€¦llm-project#5974 ) prashantgupta24 pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request Jul 1, 2024 [Core] Optimize SequenceStatus.is_finished by switching to IntEnum ( vâ€¦ â€¦ 4951f09 â€¦llm-project#5974 ) kzawora-intel added a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Jul 2, 2024 habana_main rebase ( #71 ) â€¦ 5e1a565 * [Hardware][Intel] Optimize CPU backend and add more performance tips ( vllm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\n\n* [Docs] Add 4th meetup slides ( vllm-project#5509 )\n\n* [Misc] Add vLLM version getter to utils ( vllm-project#5098 )\n\n* [CI/Build] Simplify OpenAI server setup in tests ( vllm-project#5100 )\n\n* [Doc] Update LLaVA docs ( vllm-project#5437 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Kernel] Factor out epilogues from cutlass kernels ( vllm-project#5391 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\n\n* [MISC] Remove FP8 warning ( vllm-project#5472 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* Seperate dev requirements into lint and test ( vllm-project#5474 )\n\n* Revert \"[Core] Remove unnecessary copies in flash attn backend\" ( vllm-project#5478 )\n\n* [misc] fix format.sh ( vllm-project#5511 )\n\n* [CI/Build] Disable test_fp8.py ( vllm-project#5508 )\n\n* [Kernel] Disable CUTLASS kernels for fp8 ( vllm-project#5505 )\n\n* Add `cuda_device_count_stateless` ( vllm-project#5473 )\n\n* [Hardware][Intel] Support CPU inference with AVX2 ISA ( vllm-project#5452 )\n\n* [Misc] Fix arg names in quantizer script ( vllm-project#5507 )\n\n* bump version to v0.5.0.post1 ( vllm-project#5522 )\n\n* [CI/Build][Misc] Add CI that benchmarks vllm performance on those PRs with `perf-benchmarks` label ( vllm-project#5073 )\n\nCo-authored-by: simon-mo <simon.mo@hey.com>\n\n* [CI/Build] Disable LLaVA-NeXT CPU test ( vllm-project#5529 )\n\n* [Kernel] Fix CUTLASS 3.x custom broadcast load epilogue ( vllm-project#5516 )\n\n* [Misc] Fix arg names ( vllm-project#5524 )\n\n* [ Misc ] Rs/compressed tensors cleanup ( vllm-project#5432 )\n\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\n\n* [Kernel] Suppress mma.sp warning on CUDA 12.5 and later ( vllm-project#5401 )\n\n* [mis] fix flaky test of test_cuda_device_count_stateless ( vllm-project#5546 )\n\n* [Core] Remove duplicate processing in async engine ( vllm-project#5525 )\n\n* [misc][distributed] fix benign error in `is_in_the_same_node` ( vllm-project#5512 )\n\n* [Docs] Add ZhenFund as a Sponsor ( vllm-project#5548 )\n\n* [Doc] Update documentation on Tensorizer ( vllm-project#5471 )\n\n* [Bugfix] Enable loading FP8 checkpoints for gpt_bigcode models  ( vllm-project#5460 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix typo in Pallas backend ( vllm-project#5558 )\n\n* [Core][Distributed] improve p2p cache generation ( vllm-project#5528 )\n\n* Add ccache to amd ( vllm-project#5555 )\n\n* [Core][Bugfix]: fix prefix caching for blockv2 ( vllm-project#5364 )\n\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\n\n* [mypy] Enable type checking for test directory ( vllm-project#5017 )\n\n* [CI/Build] Test both text and token IDs in batched OpenAI Completions API ( vllm-project#5568 )\n\n* [misc] Do not allow to use lora with chunked prefill. ( vllm-project#5538 )\n\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* add gptq_marlin test for bug report vllm-project#5088 ( vllm-project#5145 )\n\n* [BugFix] Don't start a Ray cluster when not using Ray ( vllm-project#5570 )\n\n* [Fix] Correct OpenAI batch response format ( vllm-project#5554 )\n\n* Add basic correctness 2 GPU tests to 4 GPU pipeline ( vllm-project#5518 )\n\n* [CI][BugFix] Flip is_quant_method_supported condition ( vllm-project#5577 )\n\n* [build][misc] limit numpy version ( vllm-project#5582 )\n\n* [Doc] add debugging tips for crash and multi-node debugging ( vllm-project#5581 )\n\n* Fix w8a8 benchmark and add Llama-3-8B ( vllm-project#5562 )\n\n* [Model] Rename Phi3 rope scaling type ( vllm-project#5595 )\n\n* Correct alignment in the seq_len diagram. ( vllm-project#5592 )\n\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\n\n* [Kernel] `compressed-tensors` marlin 24 support ( vllm-project#5435 )\n\n* [Misc] use AutoTokenizer for benchmark serving when vLLM not installed ( vllm-project#5588 )\n\n* [Hardware][Intel GPU] Add Intel GPU(XPU) inference backend ( vllm-project#3814 )\n\nCo-authored-by: Jiang Li <jiang1.li@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\n\n* [CI/BUILD] Support non-AVX512 vLLM building and testing ( vllm-project#5574 )\n\n* [CI] the readability of benchmarking and prepare for dashboard ( vllm-project#5571 )\n\n[CI] Improve the readability of performance benchmarking results and prepare for upcoming performance dashboard ( vllm-project#5571 )\n\n* [bugfix][distributed] fix 16 gpus local rank arrangement ( vllm-project#5604 )\n\n* [Optimization] use a pool to reuse LogicalTokenBlock.token_ids ( vllm-project#5584 )\n\n* [Bugfix] Fix KV head calculation for MPT models when using GQA ( vllm-project#5142 )\n\n* [Fix] Use utf-8 encoding in entrypoints/openai/run_batch.py ( vllm-project#5606 )\n\n* [Speculative Decoding 1/2 ] Add typical acceptance sampling as one of the sampling techniques in the verifier ( vllm-project#5131 )\n\n* [Model] Initialize Phi-3-vision support ( vllm-project#4986 )\n\n* [Kernel] Add punica dimensions for Granite 13b ( vllm-project#5559 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [misc][typo] fix typo ( vllm-project#5620 )\n\n* [Misc] Fix typo ( vllm-project#5618 )\n\n* [CI] Avoid naming different metrics with the same name in performance benchmark ( vllm-project#5615 )\n\n* [bugfix][distributed] improve p2p capability test ( vllm-project#5612 )\n\n[bugfix][distributed] do not error if two processes do not agree on p2p capability ( vllm-project#5612 )\n\n* [Misc] Remove import from transformers logging ( vllm-project#5625 )\n\n* [CI/Build][Misc] Update Pytest Marker for VLMs ( vllm-project#5623 )\n\n* [ci] Deprecate original CI template ( vllm-project#5624 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Add OpenTelemetry support ( vllm-project#4687 )\n\nThis PR adds basic support for OpenTelemetry distributed tracing.\nIt includes changes to enable tracing functionality and improve monitoring capabilities.\n\nI've also added a markdown with print-screens to guide users how to use this feature. You can find it here\n\n* [Misc] Add channel-wise quantization support for w8a8 dynamic per token activation quantization ( vllm-project#5542 )\n\n* [ci] Setup Release pipeline and build release wheels with cache ( vllm-project#5610 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Model] LoRA support added for command-r ( vllm-project#5178 )\n\n* [Bugfix] Fix for inconsistent behaviour related to sampling and repetition penalties  ( vllm-project#5639 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Doc] Added cerebrium as Integration option ( vllm-project#5553 )\n\n* [Bugfix] Fix CUDA version check for mma warning suppression ( vllm-project#5642 )\n\n* [Bugfix] Fix w8a8 benchmarks for int8 case ( vllm-project#5643 )\n\n* [Bugfix] Fix Phi-3 Long RoPE scaling implementation ( vllm-project#5628 )\n\n* [Bugfix] Added test for sampling repetition penalty bug. ( vllm-project#5659 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix][CI/Build][AMD][ROCm]Fixed the cmake build bug which generate garbage on certain devices ( vllm-project#5641 )\n\n* [misc][distributed] use 127.0.0.1 for single-node ( vllm-project#5619 )\n\n* [Model] Add FP8 kv cache for Qwen2 ( vllm-project#5656 )\n\n* [Bugfix] Fix sampling_params passed incorrectly in Phi3v example ( vllm-project#5684 )\n\n* [Misc]Add param max-model-len in benchmark_latency.py ( vllm-project#5629 )\n\n* [CI/Build] Add tqdm to dependencies ( vllm-project#5680 )\n\n* [ci] Add A100 queue into AWS CI template ( vllm-project#5648 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Frontend][Bugfix] Fix preemption_mode -> preemption-mode for CLI arg in arg_utils.py ( vllm-project#5688 )\n\n* [ci][distributed] add tests for custom allreduce ( vllm-project#5689 )\n\n* [Bugfix] AsyncLLMEngine hangs with asyncio.run ( vllm-project#5654 )\n\n* [Doc] Update docker references ( vllm-project#5614 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Misc] Add per channel support for static activation quantization; update w8a8 schemes to share base classes ( vllm-project#5650 )\n\n* [ci] Limit num gpus if specified for A100 ( vllm-project#5694 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Improve conftest ( vllm-project#5681 )\n\n* [Bugfix][Doc] FIx Duplicate Explicit Target Name Errors ( vllm-project#5703 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM90 ( vllm-project#5514 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Model] Port over CLIPVisionModel for VLMs ( vllm-project#5591 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM80 ( vllm-project#5275 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix] Fix the CUDA version check for FP8 support in the CUTLASS kernels ( vllm-project#5715 )\n\n* [Frontend] Add FlexibleArgumentParser to support both underscore and dash in names ( vllm-project#5718 )\n\n* [distributed][misc] use fork by default for mp ( vllm-project#5669 )\n\n* [Model] MLPSpeculator speculative decoding support ( vllm-project#4947 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\n\n* [Kernel] Add punica dimension for Qwen2 LoRA ( vllm-project#5441 )\n\n* [BugFix] Fix test_phi3v.py ( vllm-project#5725 )\n\n* [Bugfix] Add  fully sharded layer for QKVParallelLinearWithLora ( vllm-project#5665 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Core][Distributed] add shm broadcast ( vllm-project#5399 )\n\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Kernel][CPU] Add Quick `gelu` to CPU ( vllm-project#5717 )\n\n* [Doc] Documentation on supported hardware for quantization methods ( vllm-project#5745 )\n\n* [BugFix] exclude version 1.15.0 for modelscope ( vllm-project#5668 )\n\n* [ci][test] fix ca test in main ( vllm-project#5746 )\n\n* [LoRA] Add support for pinning lora adapters in the LRU cache ( vllm-project#5603 )\n\n* [CI][Hardware][Intel GPU] add Intel GPU(XPU) ci pipeline ( vllm-project#5616 )\n\n* [Model] Support Qwen-VL and Qwen-VL-Chat models with text-only inputs ( vllm-project#5710 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Remove vllm-project#4789 workaround left in vllm/entrypoints/openai/run_batch.py ( vllm-project#5756 )\n\n* [Bugfix] Fix pin_lora error in TPU executor ( vllm-project#5760 )\n\n* [Docs][TPU] Add installation tip for TPU ( vllm-project#5761 )\n\n* [core][distributed] improve shared memory broadcast ( vllm-project#5754 )\n\n* [BugFix] [Kernel] Add Cutlass2x fallback kernels ( vllm-project#5744 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Distributed] Add send and recv helpers ( vllm-project#5719 )\n\n* [Bugfix] Add phi3v resize for dynamic shape and fix torchvision requirement ( vllm-project#5772 )\n\n* [doc][faq] add warning to download models for every nodes ( vllm-project#5783 )\n\n* post-rebase api adjustments\n\n* [Doc] Add \"Suggest edit\" button to doc pages ( vllm-project#5789 )\n\n* [Doc] Add Phi-3-medium to list of supported models ( vllm-project#5788 )\n\n* [Bugfix] Fix FlexibleArgumentParser replaces _ with - for actual args ( vllm-project#5795 )\n\n* [ci] Remove aws template ( vllm-project#5757 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Doc] Add notice about breaking changes to VLMs ( vllm-project#5818 )\n\n* [Speculative Decoding] Support draft model on different tensor-parallel size than target model ( vllm-project#5414 )\n\n* add pin_lora to habana components\n\n* add WA for model loader\n\n* fix api mismatches with ray\n\n* tensor parallel fixes\n\n* workers cpu alignment fix\n\n* [Misc] Remove useless code in cpu_worker ( vllm-project#5824 )\n\n* prefill/decode metadata fixes\n\n* [Core] Add fault tolerance for `RayTokenizerGroupPool` ( vllm-project#5748 )\n\n* re-enable attn metadata trimming\n\n* worker_use_ray fix\n\n* [doc][distributed] add both gloo and nccl tests ( vllm-project#5834 )\n\n* [CI/Build] Add unit testing for FlexibleArgumentParser ( vllm-project#5798 )\n\n* [Misc] Update `w4a16` `compressed-tensors` support to include `w8a16` ( vllm-project#5794 )\n\n* [Hardware][TPU] Refactor TPU backend ( vllm-project#5831 )\n\n* [Hardware][AMD][CI/Build][Doc] Upgrade to ROCm 6.1, Dockerfile improvements, test fixes ( vllm-project#5422 )\n\n* [Hardware][TPU] Raise errors for unsupported sampling params ( vllm-project#5850 )\n\n* [CI/Build] Add E2E tests for MLPSpeculator ( vllm-project#5791 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix assertion in NeuronExecutor ( vllm-project#5841 )\n\n* [Core] Refactor Worker and ModelRunner to consolidate control plane communication ( vllm-project#5408 )\n\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Stephanie <swang@anyscale.com>\n\n* [Misc][Doc] Add Example of using OpenAI Server with VLM ( vllm-project#5832 )\n\n* [bugfix][distributed] fix shm broadcast when the queue size is full ( vllm-project#5801 )\n\n* [Bugfix] Fix embedding to support 2D inputs ( vllm-project#5829 )\n\n* [Bugfix][TPU] Fix KV cache size calculation ( vllm-project#5860 )\n\n* [CI/Build] Refactor image test assets ( vllm-project#5821 )\n\n* [Kernel] Adding bias epilogue support for `cutlass_scaled_mm` ( vllm-project#5560 )\n\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Frontend] Add tokenize/detokenize endpoints ( vllm-project#5054 )\n\n* [Hardware][TPU] Support parallel sampling & Swapping ( vllm-project#5855 )\n\n* [Bugfix][TPU] Fix CPU cache allocation ( vllm-project#5869 )\n\n* Support CPU inference with VSX PowerPC ISA ( vllm-project#5652 )\n\n* [doc] update usage of env var to avoid conflict ( vllm-project#5873 )\n\n* [Misc] Add example for LLaVA-NeXT ( vllm-project#5879 )\n\n* [BugFix] Fix cuda graph for MLPSpeculator ( vllm-project#5875 )\n\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\n\n* [Doc] Add note about context length in Phi-3-Vision example ( vllm-project#5887 )\n\n* [VLM][Bugfix] Make sure that `multi_modal_kwargs` is broadcasted properly ( vllm-project#5880 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Model] Add base class for LoRA-supported models ( vllm-project#5018 )\n\n* [Bugfix] Fix img_sizes Parsing in Phi3-Vision ( vllm-project#5888 )\n\n* [CI/Build] [1/3] Reorganize entrypoints tests ( vllm-project#5526 )\n\n* add collective crash WA\n\n* add comment to the weird mark_step\n\n* [Model][Bugfix] Implicit model flags and reenable Phi-3-Vision ( vllm-project#5896 )\n\n* [doc][misc] add note for Kubernetes users ( vllm-project#5916 )\n\n* [BugFix] Fix `MLPSpeculator` handling of `num_speculative_tokens` ( vllm-project#5876 )\n\n* [BugFix] Fix `min_tokens` behaviour for multiple eos tokens ( vllm-project#5849 )\n\n* [CI/Build] Fix Args for `_get_logits_warper` in Sampler Test ( vllm-project#5922 )\n\n* [Model] Add Gemma 2 ( vllm-project#5908 )\n\n* [core][misc] remove logical block ( vllm-project#5882 )\n\n* [Kernel][ROCm][AMD] fused_moe Triton configs v2 for mi300X ( vllm-project#5932 )\n\n* [Hardware][TPU] Optimize KV cache swapping ( vllm-project#5878 )\n\n* [VLM][BugFix] Make sure that `multi_modal_kwargs` can broadcast properly with ring buffer. ( vllm-project#5905 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][Hardware][Intel CPU] Fix unpassed multi_modal_kwargs for CPU runner ( vllm-project#5956 )\n\n* [Core] Registry for processing model inputs ( vllm-project#5214 )\n\nCo-authored-by: ywang96 <ywang@roblox.com>\n\n* Unmark fused_moe config json file as executable ( vllm-project#5960 )\n\n* [Hardware][Intel] OpenVINO vLLM backend ( vllm-project#5379 )\n\n* [Bugfix] Better error message for MLPSpeculator when `num_speculative_tokens` is set too high ( vllm-project#5894 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [CI/Build] [2/3] Reorganize entrypoints tests ( vllm-project#5904 )\n\n* [Distributed] Make it clear that % should not be in tensor dict keys. ( vllm-project#5927 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Spec Decode] Introduce DraftModelRunner ( vllm-project#5799 )\n\n* [Bugfix] Fix compute datatype for cutlass 3.x epilogues ( vllm-project#5931 )\n\n* [ Misc ] Remove `fp8_shard_indexer` from Col/Row Parallel Linear (Simplify Weight Loading) ( vllm-project#5928 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [ Bugfix ] Enabling Loading Models With Fused QKV/MLP on Disk with FP8 ( vllm-project#5921 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* Support Deepseek-V2 ( vllm-project#4650 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* [Bugfix] Only add `Attention.kv_scale` if kv cache quantization is enabled ( vllm-project#5936 )\n\n* Unmark more files as executable ( vllm-project#5962 )\n\n* [Bugfix] Fix Engine Failing After Invalid Request - AsyncEngineDeadError ( vllm-project#5963 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Kernel] Flashinfer for prefill & decode, with Cudagraph support for decode ( vllm-project#4628 )\n\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\n\n* [Bugfix][TPU] Fix TPU sampler output ( vllm-project#5978 )\n\n* [Bugfix][TPU] Fix pad slot id ( vllm-project#5977 )\n\n* [Bugfix] fix missing last itl in openai completions benchmark ( vllm-project#5926 )\n\n* [Misc] Extend vLLM Metrics logging API ( vllm-project#5925 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Kernel] Add punica dimensions for Granite 3b and 8b ( vllm-project#5930 )\n\nSigned-off-by: Joe Runde <joe@joerun.de>\n\n* [Bugfix] Fix precisions in Gemma 1 ( vllm-project#5913 )\n\n* [Misc] Update Phi-3-Vision Example ( vllm-project#5981 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix] Support `eos_token_id` from `config.json` ( vllm-project#5954 )\n\n* [Core] Optimize `SequenceStatus.is_finished` by switching to IntEnum ( vllm-project#5974 )\n\n* [Kernel] Raise an exception in MoE kernel if the batch size is larger then 65k ( vllm-project#5939 )\n\n* [ CI/Build ] Added E2E Test For Compressed Tensors ( vllm-project#5839 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [CI/Build] Add TP test for vision models ( vllm-project#5892 )\n\n* [ CI/Build ] LM Eval Harness Based CI Testing ( vllm-project#5838 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Bugfix][CI/Build][Hardware][AMD] Install matching torchvision to fix AMD tests ( vllm-project#5949 )\n\n* [CI/Build] Temporarily Remove Phi3-Vision from TP Test ( vllm-project#5989 )\n\n* [CI/Build] Reuse code for checking output consistency ( vllm-project#5988 )\n\n* [CI/Build] [3/3] Reorganize entrypoints tests ( vllm-project#5966 )\n\n* [ci][distributed] fix device count call\n\n[ci][distributed] fix some cuda init that makes it necessary to use spawn ( vllm-project#5991 )\n\n* [Frontend]: Support base64 embedding ( vllm-project#5935 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Lora] Use safetensor keys instead of adapter_config.json to find unexpected modules.  ( vllm-project#5909 )\n\nCo-authored-by: sang <sangcho@anyscale.com>\n\n* [ CI ] Temporarily Disable Large LM-Eval Tests ( vllm-project#6005 )\n\nCo-authored-by: rshaw@neuralmagic.com <rshaw@neuralmagic>\n\n* [Misc] Fix `get_min_capability` ( vllm-project#5971 )\n\n* [ Misc ] Refactor w8a8 to use `process_weights_after_load` (Simplify Weight Loading) ( vllm-project#5940 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [misc][cuda] use nvml to avoid accidentally cuda initialization ( vllm-project#6007 )\n\n* [Speculative Decoding 2/2 ] Integrate typical acceptance sampler into Spec Decode Worker ( vllm-project#5348 )\n\n* Revert test changes\n\n* cleanup\n\n* llm engine cleanup\n\n* utils.py cleanup\n\n* custom ops refactor\n\n* move xops to ops\n\n* remove vllm/hpu/attn_bias.py\n\n* whitespace fix\n\n* revert accidental changes in rmsnorm\n\n* Fix hpugraph hashing\n\n* add trim_attn_metadata comment\n\n* fix prompt bucketing:\n\n* [ CI ] Re-enable Large Model LM Eval ( vllm-project#6031 )\n\n* [doc][misc] remove deprecated api server in doc ( vllm-project#6037 )\n\n* [Misc] update benchmark backend for scalellm ( vllm-project#6018 )\n\n* [doc][misc] further lower visibility of simple api server ( vllm-project#6041 )\n\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [Bugfix] Use RayActorError for older versions of Ray in  RayTokenizerGroupPool ( vllm-project#6039 )\n\n* [Bugfix] adding chunking mechanism to fused_moe to handle large inputs ( vllm-project#6029 )\n\n* add FAQ doc under 'serving' ( vllm-project#5946 )\n\n* [Bugfix][Doc] Fix Doc Formatting ( vllm-project#6048 )\n\n* [Bugfix] Add explicit `end_forward` calls to flashinfer ( vllm-project#6044 )\n\n* [BugFix] Ensure worker model loop is always stopped at the right time ( vllm-project#5987 )\n\n* [Frontend] Relax api url assertion for openai benchmarking ( vllm-project#6046 )\n\n* [Model] Changes to MLPSpeculator to support tie_weights and input_scale ( vllm-project#5965 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\n\n* [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 default)  ( vllm-project#5602 )\n\n* [Frontend] Add template related params to request ( vllm-project#5709 )\n\n* [VLM] Remove `image_input_type` from VLM config ( vllm-project#5852 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Reinstate doc dependencies ( vllm-project#6061 )\n\n* guard model loader wa for hpu\n\n---------\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nSigned-off-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Allen.Dou <allen.dou@hotmail.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: leiwen83 <leiwen83@users.noreply.github.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: SangBin Cho <rkooo567@gmail.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Amit Garg <gargamit@microsoft.com>\nCo-authored-by: Charles Riggins <liqianchen123@foxmail.com>\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\nCo-authored-by: zhyncs <me@zhyncs.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\nCo-authored-by: Bruce Fontaine <bruce@2.7182.net>\nCo-authored-by: zifeitong <zifeitong@gmail.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Ronen Schaffer <ronen.schaffer@ibm.com>\nCo-authored-by: sergey-tinkoff <167607910+sergey-tinkoff@users.noreply.github.com>\nCo-authored-by: milo157 <43028253+milo157@users.noreply.github.com>\nCo-authored-by: Shukant Pal <SukantK2002@outlook.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: DearPlanet <junsong.zhang2021.work@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Joshua Rosenkranz <joshua.rosenkranz@gmail.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Jee Li <pandaleefree@163.com>\nCo-authored-by: rohithkrn <rohith.nallamaddi@gmail.com>\nCo-authored-by: Murali Andoorveedu <37849411+andoorve@users.noreply.github.com>\nCo-authored-by: Woo-Yeon Lee <wooyeonlee0@gmail.com>\nCo-authored-by: Matt Wong <156021403+mawong-amd@users.noreply.github.com>\nCo-authored-by: aws-patlange <90803007+aws-patlange@users.noreply.github.com>\nCo-authored-by: Stephanie Wang <swang@cs.berkeley.edu>\nCo-authored-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: sasha0552 <admin@sasha0552.org>\nCo-authored-by: Chip Kerchner <49959681+ChipKerchner@users.noreply.github.com>\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\nCo-authored-by: xwjiang2010 <87673679+xwjiang2010@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\nCo-authored-by: wangding zeng <155410488+zwd003@users.noreply.github.com>\nCo-authored-by: Lily Liu <lilyliupku@gmail.com>\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\nCo-authored-by: mcalman <68564154+mcalman@users.noreply.github.com>\nCo-authored-by: William Lin <SolitaryThinker@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: llmpros <10524065+llmpros@users.noreply.github.com>\nCo-authored-by: sang <sangcho@anyscale.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: James Whedbee <jamesw@telnyx.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\nCo-authored-by: danieljannai21 <100521221+danieljannai21@users.noreply.github.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Core] Optimize SequenceStatus.is_finished by switching to IntEnum ( vâ€¦ â€¦ 0fd7504 â€¦llm-project#5974 ) xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Core] Optimize SequenceStatus.is_finished by switching to IntEnum ( vâ€¦ â€¦ faa80a2 â€¦llm-project#5974 ) Alvant pushed a commit\n        to compressa-ai/vllm\n      that referenced\n      this pull request Oct 26, 2024 [Core] Optimize SequenceStatus.is_finished by switching to IntEnum ( vâ€¦ â€¦ c349e81 â€¦llm-project#5974 )\n\nSigned-off-by: Alvant <alvasian@yandex.ru> simon-mo deleted the sequence_status_tweak branch October 28, 2024 16:51 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:43", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: LM-Eval | PERF: itl, benchmark serving, Optimization | SERVING: serving, serving, API server | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:48:43", "models": ["meta-llama/Llama-3.1-8B-Instruct", "Qwen/Qwen2.5-7B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=Qwen/Qwen2.5-7B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Core] Optimize `SequenceStatus.is_finished` by switching to IntEnum (#5974)", "commit_message": "[Core] Optimize `SequenceStatus.is_finished` by switching to IntEnum (#5974)", "commit_date": "2024-06-29T12:47:53Z", "files_changed": ["vllm/sequence.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 25, "num_non_test_edited_lines": 25, "commit_year": 2024}, "diff_text": "diff --git a/vllm/sequence.py b/vllm/sequence.py\nindex 13746cef2..22cb26dc0 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -39,24 +39,21 @@ PromptLogprobs = List[Optional[Dict[int, Logprob]]]\n SampleLogprobs = List[Dict[int, Logprob]]\n \n \n-class SequenceStatus(enum.Enum):\n+class SequenceStatus(enum.IntEnum):\n     \"\"\"Status of a sequence.\"\"\"\n-    WAITING = enum.auto()\n-    RUNNING = enum.auto()\n-    SWAPPED = enum.auto()\n-    FINISHED_STOPPED = enum.auto()\n-    FINISHED_LENGTH_CAPPED = enum.auto()\n-    FINISHED_ABORTED = enum.auto()\n-    FINISHED_IGNORED = enum.auto()\n+    WAITING = 0\n+    RUNNING = 1\n+    SWAPPED = 2\n+    # Note: anything after SWAPPED (2) will be considered\n+    # as a finished status.\n+    FINISHED_STOPPED = 3\n+    FINISHED_LENGTH_CAPPED = 4\n+    FINISHED_ABORTED = 5\n+    FINISHED_IGNORED = 6\n \n     @staticmethod\n     def is_finished(status: \"SequenceStatus\") -> bool:\n-        return status in [\n-            SequenceStatus.FINISHED_STOPPED,\n-            SequenceStatus.FINISHED_LENGTH_CAPPED,\n-            SequenceStatus.FINISHED_ABORTED,\n-            SequenceStatus.FINISHED_IGNORED,\n-        ]\n+        return status > SequenceStatus.SWAPPED\n \n     @staticmethod\n     def get_finished_reason(status: \"SequenceStatus\") -> Union[str, None]:", "apis": ["vllm.SequenceStatus", "vllm.SequenceStatus.is_finished"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/sequence.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/worker.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The patch modifies a non-test source file (vllm/sequence.py) by switching from enum.Enum to enum.IntEnum and refactoring the is_finished function. Instead of checking membership in a list, it now performs a simple integer comparison, which is more efficient. Although the change might seem minor, it directly affects the performance of a frequently called utility function in the core API. This qualifies as a performance optimization (even though it's a micro-optimization) and is not merely a refactor or a documentation fix.", "llm_api_reason": "The commit changes the SequenceStatus enum in vllm/sequence.py by switching from enum.Enum to enum.IntEnum and replaces the is_finished methodâ€™s membership check with a simple numerical comparison (i.e. status > SWAPPED). This optimization leverages integer ordering, making it more efficient."}
{"commit_hash": "80aa7e91fcd547a7a1396f71b9bdce18e5c92245", "pr_url": "https://github.com/vllm-project/vllm/pull/4971", "pr_date": "2024-06-13", "timeline_text": "Copy link Member bigPYJ1151 commented May 22, 2024 This PR optimized CPU backend performance and added more performance tips. Optimized input shape of torch_sdpa to use fast code path for better TTFT (~40% reduction). Added tip and example to use TCMalloc, it will significantly improve the performance. Initially integrated Paged attention from Intel Extension for PyTorch. Updated related doc. PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 6 zhouyuan, jikunshang, DamonFool, WoosukKwon, AllenDou, and ivanbaldo reacted with thumbs up emoji â¤ï¸ 1 ivanbaldo reacted with heart emoji All reactions ðŸ‘ 6 reactions â¤ï¸ 1 reaction bigPYJ1151 mentioned this pull request May 22, 2024 [RFC] Initial Support for CPUs #3654 Closed 4 tasks bigPYJ1151 force-pushed the ipex branch\n    from 382dd8a to 49924d7 Compare May 24, 2024 00:14 zhouyuan mentioned this pull request May 29, 2024 [CI/BUILD] enable intel queue for longer CPU tests #4113 Merged liangan1 mentioned this pull request May 31, 2024 [RFC] Speedup vLLM inference with Intel@ Extension for PyTorch* #2526 Closed bigPYJ1151 force-pushed the ipex branch\n      2 times, most recently\n    from 7acb607 to e7b7bb7 Compare June 4, 2024 06:07 bigPYJ1151 and others added 19 commits June 7, 2024 05:15 Add IPEX Paged Att. 980de13 Fix 648d4c0 Fix env cc00133 Refactor QKV shape in torch_sdpa to use fast code path. â€¦ 5e8b064 Co-authored-by: Jianan Gu <jianan.gu@intel.com> Refine 686a41b Update doc 706d14e Update docker image. 1647c27 Fix doc afe6262 trigger 76d319a trigger 62708ef fix f822617 Fix 5fffea9 Fix 0cda257 update b00a5a9 Fix â€¦ b88142a Fix\n\nFix\n\ntrigger Revert \"Fix\" â€¦ fea13c9 This reverts commit 58c036ad079bab6d4a7beccae735c096e2818e37. Revert \"Revert \"Fix\"\" â€¦ ce00ff0 This reverts commit 3861c15e282062c8c5165ce01aa93972280ca92a. Update IPEX 5779f70 update 3930932 bigPYJ1151 force-pushed the ipex branch\n    from e7b7bb7 to 3930932 Compare June 7, 2024 05:54 WoosukKwon added\n  the x86-cpu Related to Intel & AMD CPU label Jun 8, 2024 zhouyuan mentioned this pull request Jun 13, 2024 [Hardware][Intel] Support CPU inference with AVX2 ISA #5452 Merged Copy link Contributor zhouyuan commented Jun 13, 2024 @WoosukKwon Hi, gentle ping, could you please help to take a look on this patch when available? This patch has a big optimization for CPU backend thanks, -yuan ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . update torch 6c77c9e WoosukKwon self-assigned this Jun 13, 2024 WoosukKwon approved these changes Jun 13, 2024 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @bigPYJ1151 LGTM! Thanks for the PR and sorry for the delay. Left minor comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 zhouyuan reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/attention/backends/torch_sdpa.py Comment on lines +17 to +18 except ImportError: from vllm.attention.ops.paged_attn import PagedAttention Copy link Collaborator WoosukKwon Jun 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Can't we simply require users to use IPEX? In which case do we have to use the PagedAttention kernel in vLLM? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author bigPYJ1151 Jun 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yes, after the APIs in IPEX become stable we will add IPEX to the requirements so the users can use it directly. We want to leave the native kernel here to evaluate some latest features (e.g., 8bit KV cache) before the IPEX supports them and public release. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 ivanbaldo reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator WoosukKwon Jun 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I see. Thanks! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions README.md Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/attention/ops/ipex_attn.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Update README.md â€¦ bdf030a Co-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon merged commit 80aa7e9 into vllm-project : main Jun 13, 2024 Copy link Contributor zhouyuan commented Jun 14, 2024 @WoosukKwon thank you for the review and merge, much appreciated! thanks, -yuan All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor DamonFool commented Jun 14, 2024 Hi @bigPYJ1151 , I tested the IPEX but seems no performance gain on CPU. Could you please tell us how can we test for the performance boost? Thanks. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jun 16, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( vâ€¦ â€¦ 45e1f25 â€¦llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> joerunde pushed a commit\n        to joerunde/vllm\n      that referenced\n      this pull request Jun 17, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( vâ€¦ â€¦ b51b458 â€¦llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jun 27, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( vâ€¦ â€¦ 5e1e448 â€¦llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> kzawora-intel added a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Jul 2, 2024 habana_main rebase ( #71 ) â€¦ 5e1a565 * [Hardware][Intel] Optimize CPU backend and add more performance tips ( vllm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\n\n* [Docs] Add 4th meetup slides ( vllm-project#5509 )\n\n* [Misc] Add vLLM version getter to utils ( vllm-project#5098 )\n\n* [CI/Build] Simplify OpenAI server setup in tests ( vllm-project#5100 )\n\n* [Doc] Update LLaVA docs ( vllm-project#5437 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Kernel] Factor out epilogues from cutlass kernels ( vllm-project#5391 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\n\n* [MISC] Remove FP8 warning ( vllm-project#5472 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* Seperate dev requirements into lint and test ( vllm-project#5474 )\n\n* Revert \"[Core] Remove unnecessary copies in flash attn backend\" ( vllm-project#5478 )\n\n* [misc] fix format.sh ( vllm-project#5511 )\n\n* [CI/Build] Disable test_fp8.py ( vllm-project#5508 )\n\n* [Kernel] Disable CUTLASS kernels for fp8 ( vllm-project#5505 )\n\n* Add `cuda_device_count_stateless` ( vllm-project#5473 )\n\n* [Hardware][Intel] Support CPU inference with AVX2 ISA ( vllm-project#5452 )\n\n* [Misc] Fix arg names in quantizer script ( vllm-project#5507 )\n\n* bump version to v0.5.0.post1 ( vllm-project#5522 )\n\n* [CI/Build][Misc] Add CI that benchmarks vllm performance on those PRs with `perf-benchmarks` label ( vllm-project#5073 )\n\nCo-authored-by: simon-mo <simon.mo@hey.com>\n\n* [CI/Build] Disable LLaVA-NeXT CPU test ( vllm-project#5529 )\n\n* [Kernel] Fix CUTLASS 3.x custom broadcast load epilogue ( vllm-project#5516 )\n\n* [Misc] Fix arg names ( vllm-project#5524 )\n\n* [ Misc ] Rs/compressed tensors cleanup ( vllm-project#5432 )\n\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\n\n* [Kernel] Suppress mma.sp warning on CUDA 12.5 and later ( vllm-project#5401 )\n\n* [mis] fix flaky test of test_cuda_device_count_stateless ( vllm-project#5546 )\n\n* [Core] Remove duplicate processing in async engine ( vllm-project#5525 )\n\n* [misc][distributed] fix benign error in `is_in_the_same_node` ( vllm-project#5512 )\n\n* [Docs] Add ZhenFund as a Sponsor ( vllm-project#5548 )\n\n* [Doc] Update documentation on Tensorizer ( vllm-project#5471 )\n\n* [Bugfix] Enable loading FP8 checkpoints for gpt_bigcode models  ( vllm-project#5460 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix typo in Pallas backend ( vllm-project#5558 )\n\n* [Core][Distributed] improve p2p cache generation ( vllm-project#5528 )\n\n* Add ccache to amd ( vllm-project#5555 )\n\n* [Core][Bugfix]: fix prefix caching for blockv2 ( vllm-project#5364 )\n\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\n\n* [mypy] Enable type checking for test directory ( vllm-project#5017 )\n\n* [CI/Build] Test both text and token IDs in batched OpenAI Completions API ( vllm-project#5568 )\n\n* [misc] Do not allow to use lora with chunked prefill. ( vllm-project#5538 )\n\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* add gptq_marlin test for bug report vllm-project#5088 ( vllm-project#5145 )\n\n* [BugFix] Don't start a Ray cluster when not using Ray ( vllm-project#5570 )\n\n* [Fix] Correct OpenAI batch response format ( vllm-project#5554 )\n\n* Add basic correctness 2 GPU tests to 4 GPU pipeline ( vllm-project#5518 )\n\n* [CI][BugFix] Flip is_quant_method_supported condition ( vllm-project#5577 )\n\n* [build][misc] limit numpy version ( vllm-project#5582 )\n\n* [Doc] add debugging tips for crash and multi-node debugging ( vllm-project#5581 )\n\n* Fix w8a8 benchmark and add Llama-3-8B ( vllm-project#5562 )\n\n* [Model] Rename Phi3 rope scaling type ( vllm-project#5595 )\n\n* Correct alignment in the seq_len diagram. ( vllm-project#5592 )\n\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\n\n* [Kernel] `compressed-tensors` marlin 24 support ( vllm-project#5435 )\n\n* [Misc] use AutoTokenizer for benchmark serving when vLLM not installed ( vllm-project#5588 )\n\n* [Hardware][Intel GPU] Add Intel GPU(XPU) inference backend ( vllm-project#3814 )\n\nCo-authored-by: Jiang Li <jiang1.li@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\n\n* [CI/BUILD] Support non-AVX512 vLLM building and testing ( vllm-project#5574 )\n\n* [CI] the readability of benchmarking and prepare for dashboard ( vllm-project#5571 )\n\n[CI] Improve the readability of performance benchmarking results and prepare for upcoming performance dashboard ( vllm-project#5571 )\n\n* [bugfix][distributed] fix 16 gpus local rank arrangement ( vllm-project#5604 )\n\n* [Optimization] use a pool to reuse LogicalTokenBlock.token_ids ( vllm-project#5584 )\n\n* [Bugfix] Fix KV head calculation for MPT models when using GQA ( vllm-project#5142 )\n\n* [Fix] Use utf-8 encoding in entrypoints/openai/run_batch.py ( vllm-project#5606 )\n\n* [Speculative Decoding 1/2 ] Add typical acceptance sampling as one of the sampling techniques in the verifier ( vllm-project#5131 )\n\n* [Model] Initialize Phi-3-vision support ( vllm-project#4986 )\n\n* [Kernel] Add punica dimensions for Granite 13b ( vllm-project#5559 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\n\n* [misc][typo] fix typo ( vllm-project#5620 )\n\n* [Misc] Fix typo ( vllm-project#5618 )\n\n* [CI] Avoid naming different metrics with the same name in performance benchmark ( vllm-project#5615 )\n\n* [bugfix][distributed] improve p2p capability test ( vllm-project#5612 )\n\n[bugfix][distributed] do not error if two processes do not agree on p2p capability ( vllm-project#5612 )\n\n* [Misc] Remove import from transformers logging ( vllm-project#5625 )\n\n* [CI/Build][Misc] Update Pytest Marker for VLMs ( vllm-project#5623 )\n\n* [ci] Deprecate original CI template ( vllm-project#5624 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Add OpenTelemetry support ( vllm-project#4687 )\n\nThis PR adds basic support for OpenTelemetry distributed tracing.\nIt includes changes to enable tracing functionality and improve monitoring capabilities.\n\nI've also added a markdown with print-screens to guide users how to use this feature. You can find it here\n\n* [Misc] Add channel-wise quantization support for w8a8 dynamic per token activation quantization ( vllm-project#5542 )\n\n* [ci] Setup Release pipeline and build release wheels with cache ( vllm-project#5610 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Model] LoRA support added for command-r ( vllm-project#5178 )\n\n* [Bugfix] Fix for inconsistent behaviour related to sampling and repetition penalties  ( vllm-project#5639 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Doc] Added cerebrium as Integration option ( vllm-project#5553 )\n\n* [Bugfix] Fix CUDA version check for mma warning suppression ( vllm-project#5642 )\n\n* [Bugfix] Fix w8a8 benchmarks for int8 case ( vllm-project#5643 )\n\n* [Bugfix] Fix Phi-3 Long RoPE scaling implementation ( vllm-project#5628 )\n\n* [Bugfix] Added test for sampling repetition penalty bug. ( vllm-project#5659 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix][CI/Build][AMD][ROCm]Fixed the cmake build bug which generate garbage on certain devices ( vllm-project#5641 )\n\n* [misc][distributed] use 127.0.0.1 for single-node ( vllm-project#5619 )\n\n* [Model] Add FP8 kv cache for Qwen2 ( vllm-project#5656 )\n\n* [Bugfix] Fix sampling_params passed incorrectly in Phi3v example ( vllm-project#5684 )\n\n* [Misc]Add param max-model-len in benchmark_latency.py ( vllm-project#5629 )\n\n* [CI/Build] Add tqdm to dependencies ( vllm-project#5680 )\n\n* [ci] Add A100 queue into AWS CI template ( vllm-project#5648 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Frontend][Bugfix] Fix preemption_mode -> preemption-mode for CLI arg in arg_utils.py ( vllm-project#5688 )\n\n* [ci][distributed] add tests for custom allreduce ( vllm-project#5689 )\n\n* [Bugfix] AsyncLLMEngine hangs with asyncio.run ( vllm-project#5654 )\n\n* [Doc] Update docker references ( vllm-project#5614 )\n\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\n\n* [Misc] Add per channel support for static activation quantization; update w8a8 schemes to share base classes ( vllm-project#5650 )\n\n* [ci] Limit num gpus if specified for A100 ( vllm-project#5694 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Misc] Improve conftest ( vllm-project#5681 )\n\n* [Bugfix][Doc] FIx Duplicate Explicit Target Name Errors ( vllm-project#5703 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM90 ( vllm-project#5514 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Model] Port over CLIPVisionModel for VLMs ( vllm-project#5591 )\n\n* [Kernel] Update Cutlass int8 kernel configs for SM80 ( vllm-project#5275 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix] Fix the CUDA version check for FP8 support in the CUTLASS kernels ( vllm-project#5715 )\n\n* [Frontend] Add FlexibleArgumentParser to support both underscore and dash in names ( vllm-project#5718 )\n\n* [distributed][misc] use fork by default for mp ( vllm-project#5669 )\n\n* [Model] MLPSpeculator speculative decoding support ( vllm-project#4947 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\n\n* [Kernel] Add punica dimension for Qwen2 LoRA ( vllm-project#5441 )\n\n* [BugFix] Fix test_phi3v.py ( vllm-project#5725 )\n\n* [Bugfix] Add  fully sharded layer for QKVParallelLinearWithLora ( vllm-project#5665 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Core][Distributed] add shm broadcast ( vllm-project#5399 )\n\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Kernel][CPU] Add Quick `gelu` to CPU ( vllm-project#5717 )\n\n* [Doc] Documentation on supported hardware for quantization methods ( vllm-project#5745 )\n\n* [BugFix] exclude version 1.15.0 for modelscope ( vllm-project#5668 )\n\n* [ci][test] fix ca test in main ( vllm-project#5746 )\n\n* [LoRA] Add support for pinning lora adapters in the LRU cache ( vllm-project#5603 )\n\n* [CI][Hardware][Intel GPU] add Intel GPU(XPU) ci pipeline ( vllm-project#5616 )\n\n* [Model] Support Qwen-VL and Qwen-VL-Chat models with text-only inputs ( vllm-project#5710 )\n\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Remove vllm-project#4789 workaround left in vllm/entrypoints/openai/run_batch.py ( vllm-project#5756 )\n\n* [Bugfix] Fix pin_lora error in TPU executor ( vllm-project#5760 )\n\n* [Docs][TPU] Add installation tip for TPU ( vllm-project#5761 )\n\n* [core][distributed] improve shared memory broadcast ( vllm-project#5754 )\n\n* [BugFix] [Kernel] Add Cutlass2x fallback kernels ( vllm-project#5744 )\n\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Distributed] Add send and recv helpers ( vllm-project#5719 )\n\n* [Bugfix] Add phi3v resize for dynamic shape and fix torchvision requirement ( vllm-project#5772 )\n\n* [doc][faq] add warning to download models for every nodes ( vllm-project#5783 )\n\n* post-rebase api adjustments\n\n* [Doc] Add \"Suggest edit\" button to doc pages ( vllm-project#5789 )\n\n* [Doc] Add Phi-3-medium to list of supported models ( vllm-project#5788 )\n\n* [Bugfix] Fix FlexibleArgumentParser replaces _ with - for actual args ( vllm-project#5795 )\n\n* [ci] Remove aws template ( vllm-project#5757 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [Doc] Add notice about breaking changes to VLMs ( vllm-project#5818 )\n\n* [Speculative Decoding] Support draft model on different tensor-parallel size than target model ( vllm-project#5414 )\n\n* add pin_lora to habana components\n\n* add WA for model loader\n\n* fix api mismatches with ray\n\n* tensor parallel fixes\n\n* workers cpu alignment fix\n\n* [Misc] Remove useless code in cpu_worker ( vllm-project#5824 )\n\n* prefill/decode metadata fixes\n\n* [Core] Add fault tolerance for `RayTokenizerGroupPool` ( vllm-project#5748 )\n\n* re-enable attn metadata trimming\n\n* worker_use_ray fix\n\n* [doc][distributed] add both gloo and nccl tests ( vllm-project#5834 )\n\n* [CI/Build] Add unit testing for FlexibleArgumentParser ( vllm-project#5798 )\n\n* [Misc] Update `w4a16` `compressed-tensors` support to include `w8a16` ( vllm-project#5794 )\n\n* [Hardware][TPU] Refactor TPU backend ( vllm-project#5831 )\n\n* [Hardware][AMD][CI/Build][Doc] Upgrade to ROCm 6.1, Dockerfile improvements, test fixes ( vllm-project#5422 )\n\n* [Hardware][TPU] Raise errors for unsupported sampling params ( vllm-project#5850 )\n\n* [CI/Build] Add E2E tests for MLPSpeculator ( vllm-project#5791 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Bugfix] Fix assertion in NeuronExecutor ( vllm-project#5841 )\n\n* [Core] Refactor Worker and ModelRunner to consolidate control plane communication ( vllm-project#5408 )\n\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Stephanie <swang@anyscale.com>\n\n* [Misc][Doc] Add Example of using OpenAI Server with VLM ( vllm-project#5832 )\n\n* [bugfix][distributed] fix shm broadcast when the queue size is full ( vllm-project#5801 )\n\n* [Bugfix] Fix embedding to support 2D inputs ( vllm-project#5829 )\n\n* [Bugfix][TPU] Fix KV cache size calculation ( vllm-project#5860 )\n\n* [CI/Build] Refactor image test assets ( vllm-project#5821 )\n\n* [Kernel] Adding bias epilogue support for `cutlass_scaled_mm` ( vllm-project#5560 )\n\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Frontend] Add tokenize/detokenize endpoints ( vllm-project#5054 )\n\n* [Hardware][TPU] Support parallel sampling & Swapping ( vllm-project#5855 )\n\n* [Bugfix][TPU] Fix CPU cache allocation ( vllm-project#5869 )\n\n* Support CPU inference with VSX PowerPC ISA ( vllm-project#5652 )\n\n* [doc] update usage of env var to avoid conflict ( vllm-project#5873 )\n\n* [Misc] Add example for LLaVA-NeXT ( vllm-project#5879 )\n\n* [BugFix] Fix cuda graph for MLPSpeculator ( vllm-project#5875 )\n\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\n\n* [Doc] Add note about context length in Phi-3-Vision example ( vllm-project#5887 )\n\n* [VLM][Bugfix] Make sure that `multi_modal_kwargs` is broadcasted properly ( vllm-project#5880 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Model] Add base class for LoRA-supported models ( vllm-project#5018 )\n\n* [Bugfix] Fix img_sizes Parsing in Phi3-Vision ( vllm-project#5888 )\n\n* [CI/Build] [1/3] Reorganize entrypoints tests ( vllm-project#5526 )\n\n* add collective crash WA\n\n* add comment to the weird mark_step\n\n* [Model][Bugfix] Implicit model flags and reenable Phi-3-Vision ( vllm-project#5896 )\n\n* [doc][misc] add note for Kubernetes users ( vllm-project#5916 )\n\n* [BugFix] Fix `MLPSpeculator` handling of `num_speculative_tokens` ( vllm-project#5876 )\n\n* [BugFix] Fix `min_tokens` behaviour for multiple eos tokens ( vllm-project#5849 )\n\n* [CI/Build] Fix Args for `_get_logits_warper` in Sampler Test ( vllm-project#5922 )\n\n* [Model] Add Gemma 2 ( vllm-project#5908 )\n\n* [core][misc] remove logical block ( vllm-project#5882 )\n\n* [Kernel][ROCm][AMD] fused_moe Triton configs v2 for mi300X ( vllm-project#5932 )\n\n* [Hardware][TPU] Optimize KV cache swapping ( vllm-project#5878 )\n\n* [VLM][BugFix] Make sure that `multi_modal_kwargs` can broadcast properly with ring buffer. ( vllm-project#5905 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][Hardware][Intel CPU] Fix unpassed multi_modal_kwargs for CPU runner ( vllm-project#5956 )\n\n* [Core] Registry for processing model inputs ( vllm-project#5214 )\n\nCo-authored-by: ywang96 <ywang@roblox.com>\n\n* Unmark fused_moe config json file as executable ( vllm-project#5960 )\n\n* [Hardware][Intel] OpenVINO vLLM backend ( vllm-project#5379 )\n\n* [Bugfix] Better error message for MLPSpeculator when `num_speculative_tokens` is set too high ( vllm-project#5894 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [CI/Build] [2/3] Reorganize entrypoints tests ( vllm-project#5904 )\n\n* [Distributed] Make it clear that % should not be in tensor dict keys. ( vllm-project#5927 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\n\n* [Spec Decode] Introduce DraftModelRunner ( vllm-project#5799 )\n\n* [Bugfix] Fix compute datatype for cutlass 3.x epilogues ( vllm-project#5931 )\n\n* [ Misc ] Remove `fp8_shard_indexer` from Col/Row Parallel Linear (Simplify Weight Loading) ( vllm-project#5928 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [ Bugfix ] Enabling Loading Models With Fused QKV/MLP on Disk with FP8 ( vllm-project#5921 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* Support Deepseek-V2 ( vllm-project#4650 )\n\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\n\n* [Bugfix] Only add `Attention.kv_scale` if kv cache quantization is enabled ( vllm-project#5936 )\n\n* Unmark more files as executable ( vllm-project#5962 )\n\n* [Bugfix] Fix Engine Failing After Invalid Request - AsyncEngineDeadError ( vllm-project#5963 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Kernel] Flashinfer for prefill & decode, with Cudagraph support for decode ( vllm-project#4628 )\n\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\n\n* [Bugfix][TPU] Fix TPU sampler output ( vllm-project#5978 )\n\n* [Bugfix][TPU] Fix pad slot id ( vllm-project#5977 )\n\n* [Bugfix] fix missing last itl in openai completions benchmark ( vllm-project#5926 )\n\n* [Misc] Extend vLLM Metrics logging API ( vllm-project#5925 )\n\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\n\n* [Kernel] Add punica dimensions for Granite 3b and 8b ( vllm-project#5930 )\n\nSigned-off-by: Joe Runde <joe@joerun.de>\n\n* [Bugfix] Fix precisions in Gemma 1 ( vllm-project#5913 )\n\n* [Misc] Update Phi-3-Vision Example ( vllm-project#5981 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix] Support `eos_token_id` from `config.json` ( vllm-project#5954 )\n\n* [Core] Optimize `SequenceStatus.is_finished` by switching to IntEnum ( vllm-project#5974 )\n\n* [Kernel] Raise an exception in MoE kernel if the batch size is larger then 65k ( vllm-project#5939 )\n\n* [ CI/Build ] Added E2E Test For Compressed Tensors ( vllm-project#5839 )\n\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [CI/Build] Add TP test for vision models ( vllm-project#5892 )\n\n* [ CI/Build ] LM Eval Harness Based CI Testing ( vllm-project#5838 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [Bugfix][CI/Build][Hardware][AMD] Install matching torchvision to fix AMD tests ( vllm-project#5949 )\n\n* [CI/Build] Temporarily Remove Phi3-Vision from TP Test ( vllm-project#5989 )\n\n* [CI/Build] Reuse code for checking output consistency ( vllm-project#5988 )\n\n* [CI/Build] [3/3] Reorganize entrypoints tests ( vllm-project#5966 )\n\n* [ci][distributed] fix device count call\n\n[ci][distributed] fix some cuda init that makes it necessary to use spawn ( vllm-project#5991 )\n\n* [Frontend]: Support base64 embedding ( vllm-project#5935 )\n\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Lora] Use safetensor keys instead of adapter_config.json to find unexpected modules.  ( vllm-project#5909 )\n\nCo-authored-by: sang <sangcho@anyscale.com>\n\n* [ CI ] Temporarily Disable Large LM-Eval Tests ( vllm-project#6005 )\n\nCo-authored-by: rshaw@neuralmagic.com <rshaw@neuralmagic>\n\n* [Misc] Fix `get_min_capability` ( vllm-project#5971 )\n\n* [ Misc ] Refactor w8a8 to use `process_weights_after_load` (Simplify Weight Loading) ( vllm-project#5940 )\n\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\n\n* [misc][cuda] use nvml to avoid accidentally cuda initialization ( vllm-project#6007 )\n\n* [Speculative Decoding 2/2 ] Integrate typical acceptance sampler into Spec Decode Worker ( vllm-project#5348 )\n\n* Revert test changes\n\n* cleanup\n\n* llm engine cleanup\n\n* utils.py cleanup\n\n* custom ops refactor\n\n* move xops to ops\n\n* remove vllm/hpu/attn_bias.py\n\n* whitespace fix\n\n* revert accidental changes in rmsnorm\n\n* Fix hpugraph hashing\n\n* add trim_attn_metadata comment\n\n* fix prompt bucketing:\n\n* [ CI ] Re-enable Large Model LM Eval ( vllm-project#6031 )\n\n* [doc][misc] remove deprecated api server in doc ( vllm-project#6037 )\n\n* [Misc] update benchmark backend for scalellm ( vllm-project#6018 )\n\n* [doc][misc] further lower visibility of simple api server ( vllm-project#6041 )\n\nCo-authored-by: Simon Mo <simon.mo@hey.com>\n\n* [Bugfix] Use RayActorError for older versions of Ray in  RayTokenizerGroupPool ( vllm-project#6039 )\n\n* [Bugfix] adding chunking mechanism to fused_moe to handle large inputs ( vllm-project#6029 )\n\n* add FAQ doc under 'serving' ( vllm-project#5946 )\n\n* [Bugfix][Doc] Fix Doc Formatting ( vllm-project#6048 )\n\n* [Bugfix] Add explicit `end_forward` calls to flashinfer ( vllm-project#6044 )\n\n* [BugFix] Ensure worker model loop is always stopped at the right time ( vllm-project#5987 )\n\n* [Frontend] Relax api url assertion for openai benchmarking ( vllm-project#6046 )\n\n* [Model] Changes to MLPSpeculator to support tie_weights and input_scale ( vllm-project#5965 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\n\n* [Core] Optimize block_manager_v2 vs block_manager_v1 (to make V2 default)  ( vllm-project#5602 )\n\n* [Frontend] Add template related params to request ( vllm-project#5709 )\n\n* [VLM] Remove `image_input_type` from VLM config ( vllm-project#5852 )\n\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Doc] Reinstate doc dependencies ( vllm-project#6061 )\n\n* guard model loader wa for hpu\n\n---------\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: Lei Wen <wenlei03@qiyi.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: Rafael Vasquez <rafvasq21@gmail.com>\nSigned-off-by: Stephanie Wang <swang@cs.berkeley.edu>\nSigned-off-by: Stephanie <swang@anyscale.com>\nSigned-off-by: Xiaowei Jiang <xwjiang2010@gmail.com>\nSigned-off-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: zifeitong <zifei.tong@parasail.io>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-neuralmagic@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Philipp Moritz <pcmoritz@gmail.com>\nCo-authored-by: Antoni Baum <antoni.baum@protonmail.com>\nCo-authored-by: Jie Fu (å‚…æ°) <jiefu@tencent.com>\nCo-authored-by: Allen.Dou <allen.dou@hotmail.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: leiwen83 <leiwen83@users.noreply.github.com>\nCo-authored-by: Lei Wen <wenlei03@qiyi.com>\nCo-authored-by: SangBin Cho <rkooo567@gmail.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Amit Garg <gargamit@microsoft.com>\nCo-authored-by: Charles Riggins <liqianchen123@foxmail.com>\nCo-authored-by: Liqian Chen <liqian.chen@deeplang.ai>\nCo-authored-by: zhyncs <me@zhyncs.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: Abhilash Majumder <abhilash.majumder@intel.com>\nCo-authored-by: Abhilash Majumder <30946547+abhilash1910@users.noreply.github.com>\nCo-authored-by: Bruce Fontaine <bruce@2.7182.net>\nCo-authored-by: zifeitong <zifeitong@gmail.com>\nCo-authored-by: sroy745 <142070531+sroy745@users.noreply.github.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Joe Runde <joe@joerun.de>\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Ronen Schaffer <ronen.schaffer@ibm.com>\nCo-authored-by: sergey-tinkoff <167607910+sergey-tinkoff@users.noreply.github.com>\nCo-authored-by: milo157 <43028253+milo157@users.noreply.github.com>\nCo-authored-by: Shukant Pal <SukantK2002@outlook.com>\nCo-authored-by: Hongxia Yang <62075498+hongxiayang@users.noreply.github.com>\nCo-authored-by: DearPlanet <junsong.zhang2021.work@outlook.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Joshua Rosenkranz <joshua.rosenkranz@gmail.com>\nCo-authored-by: Davis Wertheimer <Davis.Wertheimer@ibm.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Jee Li <pandaleefree@163.com>\nCo-authored-by: rohithkrn <rohith.nallamaddi@gmail.com>\nCo-authored-by: Murali Andoorveedu <37849411+andoorve@users.noreply.github.com>\nCo-authored-by: Woo-Yeon Lee <wooyeonlee0@gmail.com>\nCo-authored-by: Matt Wong <156021403+mawong-amd@users.noreply.github.com>\nCo-authored-by: aws-patlange <90803007+aws-patlange@users.noreply.github.com>\nCo-authored-by: Stephanie Wang <swang@cs.berkeley.edu>\nCo-authored-by: Stephanie <swang@anyscale.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: sasha0552 <admin@sasha0552.org>\nCo-authored-by: Chip Kerchner <49959681+ChipKerchner@users.noreply.github.com>\nCo-authored-by: Abhinav Goyal <abhinav.goyal@flipkart.com>\nCo-authored-by: xwjiang2010 <87673679+xwjiang2010@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Robert Shaw <rshaw@neuralmagic>\nCo-authored-by: wangding zeng <155410488+zwd003@users.noreply.github.com>\nCo-authored-by: Lily Liu <lilyliupku@gmail.com>\nCo-authored-by: LiuXiaoxuanPKU <llilyliupku@gmail.com>, bong-furiosa <bongwon.jang@furiosa.ai>\nCo-authored-by: mcalman <68564154+mcalman@users.noreply.github.com>\nCo-authored-by: William Lin <SolitaryThinker@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: llmpros <10524065+llmpros@users.noreply.github.com>\nCo-authored-by: sang <sangcho@anyscale.com>\nCo-authored-by: Avshalom Manevich <12231371+avshalomman@users.noreply.github.com>\nCo-authored-by: James Whedbee <jamesw@telnyx.com>\nCo-authored-by: Joshua Rosenkranz <jmrosenk@us.ibm.com>\nCo-authored-by: danieljannai21 <100521221+danieljannai21@users.noreply.github.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( vâ€¦ â€¦ 233bf00 â€¦llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Hardware][Intel] Optimize CPU backend and add more performance tips ( vâ€¦ â€¦ 610215e â€¦llm-project#4971 )\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com> awangzy mentioned this pull request Mar 11, 2025 [Doc]: Does vllm CPU backend support Intel AMX? #14603 Open 1 task Copy link ivanbaldo commented Jul 30, 2025 So with this, AVX2-only CPUs are supported? Can it be used with the images at public.ecr.aws/q9t5s3a7/vllm-cpu-release-repo:v0.10.0? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:46", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: LM-Eval | PERF: TTFT, itl, benchmark serving | SERVING: serving, serving, API server | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:48:46", "models": ["meta-llama/Llama-3.1-8B-Instruct", "Qwen/Qwen2.5-7B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=Qwen/Qwen2.5-7B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Hardware][Intel] Optimize CPU backend and add more performance tips (#4971)", "commit_message": "[Hardware][Intel] Optimize CPU backend and add more performance tips (#4971)\n\nCo-authored-by: Jianan Gu <jianan.gu@intel.com>", "commit_date": "2024-06-13T09:33:14-07:00", "files_changed": ["Dockerfile.cpu", "README.md", "docs/source/getting_started/cpu-installation.rst", "requirements-cpu.txt", "vllm/attention/backends/torch_sdpa.py", "vllm/attention/ops/ipex_attn.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 6, "only_test_files": 0, "only_non_test_files": 1, "num_files": 6, "num_hunks": 13, "num_edited_lines": 178, "num_non_test_edited_lines": 178, "commit_year": 2024}, "diff_text": "diff --git a/Dockerfile.cpu b/Dockerfile.cpu\nindex 403a1cd03..777bb0829 100644\n--- a/Dockerfile.cpu\n+++ b/Dockerfile.cpu\n@@ -3,9 +3,13 @@\n FROM ubuntu:22.04 AS cpu-test-1\n \n RUN apt-get update  -y \\\n-    && apt-get install -y git wget vim numactl gcc-12 g++-12 python3 python3-pip \\\n+    && apt-get install -y git wget vim numactl gcc-12 g++-12 python3 python3-pip libtcmalloc-minimal4 \\\n     && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10 --slave /usr/bin/g++ g++ /usr/bin/g++-12\n \n+RUN echo 'export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4:$LD_PRELOAD' >> ~/.bashrc\n+\n+RUN pip install https://intel-extension-for-pytorch.s3.amazonaws.com/ipex_dev/cpu/intel_extension_for_pytorch-2.3.100%2Bgit0eb3473-cp310-cp310-linux_x86_64.whl\n+\n RUN pip install --upgrade pip \\\n     && pip install wheel packaging ninja \"setuptools>=49.4.0\" numpy\n \n@@ -21,6 +25,6 @@ RUN VLLM_TARGET_DEVICE=cpu python3 setup.py install\n \n WORKDIR /workspace/\n \n-RUN ln -s /workspace/vllm/tests  && ln -s /workspace/vllm/examples && ln -s /workspace/vllm/benchmarks\n+RUN ln -s /workspace/vllm/tests && ln -s /workspace/vllm/examples && ln -s /workspace/vllm/benchmarks\n \n CMD [\"/bin/bash\"]\ndiff --git a/README.md b/README.md\nindex 57374d279..8e4480ac2 100644\n--- a/README.md\n+++ b/README.md\n@@ -65,7 +65,7 @@ vLLM is flexible and easy to use with:\n - Tensor parallelism support for distributed inference\n - Streaming outputs\n - OpenAI-compatible API server\n-- Support NVIDIA GPUs and AMD GPUs\n+- Support NVIDIA GPUs, AMD GPUs, and Intel CPUs\n - (Experimental) Prefix caching support\n - (Experimental) Multi-lora support\n \ndiff --git a/docs/source/getting_started/cpu-installation.rst b/docs/source/getting_started/cpu-installation.rst\nindex 5270253ca..a9544e8a5 100644\n--- a/docs/source/getting_started/cpu-installation.rst\n+++ b/docs/source/getting_started/cpu-installation.rst\n@@ -10,6 +10,7 @@ Table of contents:\n #. :ref:`Requirements <cpu_backend_requirements>`\n #. :ref:`Quick start using Dockerfile <cpu_backend_quick_start_dockerfile>`\n #. :ref:`Build from source <build_cpu_backend_from_source>`\n+#. :ref:`Intel Extension for PyTorch <ipex_guidance>`\n #. :ref:`Performance tips <cpu_backend_performance_tips>`\n \n .. _cpu_backend_requirements:\n@@ -18,7 +19,7 @@ Requirements\n ------------\n \n * OS: Linux\n-* Compiler: gcc/g++>=12.3.0 (recommended)\n+* Compiler: gcc/g++>=12.3.0 (optional, recommended)\n * Instruction set architecture (ISA) requirement: AVX512 is required.\n \n .. _cpu_backend_quick_start_dockerfile:\n@@ -41,7 +42,7 @@ Quick start using Dockerfile\n Build from source\n -----------------\n \n-- First, install required compiler. We recommend to use ``gcc/g++ >= 12.3.0`` as the default compiler to avoid potential problems. For example, on Ubuntu 22.4, you can run:\n+- First, install recommended compiler. We recommend to use ``gcc/g++ >= 12.3.0`` as the default compiler to avoid potential problems. For example, on Ubuntu 22.4, you can run:\n \n .. code-block:: console\n \n@@ -70,6 +71,15 @@ Build from source\n     \n     - If you want to force enable AVX512_BF16 for the cross-compilation, please set environment variable VLLM_CPU_AVX512BF16=1 before the building.    \n \n+.. _ipex_guidance:\n+\n+Intel Extension for PyTorch\n+---------------------------\n+\n+- `Intel Extension for PyTorch (IPEX) <https://github.com/intel/intel-extension-for-pytorch>`_ extends PyTorch with up-to-date features optimizations for an extra performance boost on Intel hardware.\n+\n+- IPEX after the ``2.3.0`` can be enabled in the CPU backend by default if it is installed.\n+\n .. _cpu_backend_performance_tips:\n \n Performance tips\n@@ -77,6 +87,15 @@ Performance tips\n \n - vLLM CPU backend uses environment variable ``VLLM_CPU_KVCACHE_SPACE`` to specify the KV Cache size (e.g, ``VLLM_CPU_KVCACHE_SPACE=40`` means 40 GB space for KV cache), larger setting will allow vLLM running more requests in parallel. This parameter should be set based on the hardware configuration and memory management pattern of users.\n \n+- We highly recommend to use TCMalloc for high performance memory allocation and better cache locality. For example, on Ubuntu 22.4, you can run:\n+\n+.. code-block:: console\n+\n+    $ sudo apt-get install libtcmalloc-minimal4 # install TCMalloc library\n+    $ find / -name *libtcmalloc* # find the dynamic link library path\n+    $ export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4:$LD_PRELOAD # prepend the library to LD_PRELOAD\n+    $ python examples/offline_inference.py # run vLLM\n+\n - vLLM CPU backend uses OpenMP for thread-parallel computation. If you want the best performance on CPU, it will be very critical to isolate CPU cores for OpenMP threads with other thread pools (like web-service event-loop), to avoid CPU oversubscription. \n \n - If using vLLM CPU backend on a bare-metal machine, it is recommended to disable the hyper-threading.\ndiff --git a/requirements-cpu.txt b/requirements-cpu.txt\nindex b739642d8..8b7d86e68 100644\n--- a/requirements-cpu.txt\n+++ b/requirements-cpu.txt\n@@ -2,5 +2,5 @@\n -r requirements-common.txt\n \n # Dependencies for x86_64 CPUs\n-torch == 2.3.0+cpu\n+torch == 2.3.1+cpu\n triton >= 2.2.0  # FIXME(woosuk): This is a hack to avoid import error.\n\\ No newline at end of file\ndiff --git a/vllm/attention/backends/torch_sdpa.py b/vllm/attention/backends/torch_sdpa.py\nindex 9b50adec5..4b08cce99 100644\n--- a/vllm/attention/backends/torch_sdpa.py\n+++ b/vllm/attention/backends/torch_sdpa.py\n@@ -8,8 +8,16 @@ from torch.nn.functional import scaled_dot_product_attention\n \n from vllm.attention.backends.abstract import (AttentionBackend, AttentionImpl,\n                                               AttentionMetadata)\n-from vllm.attention.ops.paged_attn import (PagedAttention,\n-                                           PagedAttentionMetadata)\n+from vllm.attention.ops.paged_attn import PagedAttentionMetadata\n+from vllm.utils import is_cpu\n+\n+if is_cpu():\n+    try:\n+        from vllm.attention.ops.ipex_attn import PagedAttention\n+    except ImportError:\n+        from vllm.attention.ops.paged_attn import PagedAttention\n+else:\n+    from vllm.attention.ops.paged_attn import PagedAttention\n \n \n class TorchSDPABackend(AttentionBackend):\n@@ -197,13 +205,14 @@ class TorchSDPABackendImpl(AttentionImpl[TorchSDPAMetadata]):\n                                          attn_metadata.attn_bias):\n                     end = start + seq_len\n                     sub_out = scaled_dot_product_attention(\n-                        query[:, start:end, :],\n-                        key[:, start:end, :],\n-                        value[:, start:end, :],\n+                        query[None, :, start:end, :],\n+                        key[None, :, start:end, :],\n+                        value[None, :, start:end, :],\n                         attn_mask=mask,\n                         dropout_p=0.0,\n                         is_causal=not self.need_mask,\n-                        scale=self.scale).movedim(query.dim() - 2, 0)\n+                        scale=self.scale).squeeze(0).movedim(\n+                            query.dim() - 2, 0)\n                     output[start:end, :, :] = sub_out\n                     start = end\n             else:\n@@ -248,7 +257,7 @@ def _make_alibi_bias(\n \n         num_heads = alibi_slopes.shape[0]\n         bias = bias[None, :].repeat((num_heads, 1, 1))\n-        bias.mul_(alibi_slopes[:, None, None])\n+        bias.mul_(alibi_slopes[:, None, None]).unsqueeze_(0)\n         inf_mask = torch.empty(\n             (1, seq_len, seq_len),\n             dtype=bias.dtype).fill_(-torch.inf).triu_(diagonal=1)\ndiff --git a/vllm/attention/ops/ipex_attn.py b/vllm/attention/ops/ipex_attn.py\nnew file mode 100644\nindex 000000000..5a5317b65\n--- /dev/null\n+++ b/vllm/attention/ops/ipex_attn.py\n@@ -0,0 +1,120 @@\n+from typing import Dict, List, Optional, Tuple\n+\n+import intel_extension_for_pytorch.llm.modules as ipex_modules\n+import torch\n+\n+from vllm import _custom_ops as ops\n+\n+\n+class PagedAttention:\n+\n+    @staticmethod\n+    def get_supported_head_sizes() -> List[int]:\n+        return [64, 80, 96, 112, 128, 256]\n+\n+    @staticmethod\n+    def get_kv_cache_shape(\n+        num_blocks: int,\n+        block_size: int,\n+        num_kv_heads: int,\n+        head_size: int,\n+        *args,\n+    ) -> Tuple[int, ...]:\n+        return (2, num_blocks, block_size * num_kv_heads * head_size)\n+\n+    @staticmethod\n+    def split_kv_cache(\n+        kv_cache: torch.Tensor,\n+        num_kv_heads: int,\n+        head_size: int,\n+        *args,\n+    ) -> Tuple[torch.Tensor, torch.Tensor]:\n+        num_blocks = kv_cache.shape[1]\n+\n+        key_cache = kv_cache[0]\n+        key_cache = key_cache.view(num_blocks, num_kv_heads, -1, head_size)\n+        value_cache = kv_cache[1]\n+        value_cache = value_cache.view(num_blocks, num_kv_heads, -1, head_size)\n+        return key_cache, value_cache\n+\n+    @staticmethod\n+    def write_to_paged_cache(\n+        key: torch.Tensor,\n+        value: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        slot_mapping: torch.Tensor,\n+        kv_cache_dtype: str,\n+        kv_scale: float,\n+        *args,\n+    ) -> None:\n+        ipex_modules.PagedAttention.reshape_and_cache(\n+            key, value, key_cache, value_cache,\n+            slot_mapping.flatten().int())\n+\n+    @staticmethod\n+    def forward_decode(\n+        query: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        block_tables: torch.Tensor,\n+        context_lens: torch.Tensor,\n+        max_context_len: int,\n+        kv_cache_dtype: str,\n+        num_kv_heads: int,\n+        scale: float,\n+        alibi_slopes: Optional[torch.Tensor],\n+        kv_scale: float,\n+        *args,\n+    ) -> torch.Tensor:\n+        output = torch.empty_like(query)\n+        block_size = value_cache.shape[2]\n+        head_mapping = torch.arange(\n+            0,\n+            num_kv_heads,\n+            device=\"cpu\",\n+            dtype=torch.int32,\n+        ).view(num_kv_heads,\n+               1).repeat_interleave(query.size(1) // num_kv_heads).flatten()\n+        ipex_modules.PagedAttention.single_query_cached_kv_attention(\n+            output, query.contiguous(), key_cache, value_cache, head_mapping,\n+            scale, block_tables, context_lens, block_size, max_context_len,\n+            alibi_slopes)\n+\n+        return output\n+\n+    @staticmethod\n+    def forward_prefix(\n+        query: torch.Tensor,\n+        key: torch.Tensor,\n+        value: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        block_tables: torch.Tensor,\n+        subquery_start_loc: torch.Tensor,\n+        prompt_lens_tensor: torch.Tensor,\n+        context_lens: torch.Tensor,\n+        max_subquery_len: int,\n+        alibi_slopes: Optional[torch.Tensor],\n+        *args,\n+    ) -> torch.Tensor:\n+        raise NotImplementedError\n+\n+    @staticmethod\n+    def swap_blocks(\n+        src_kv_cache: torch.Tensor,\n+        dst_kv_cache: torch.Tensor,\n+        src_to_dst: Dict[int, int],\n+        *args,\n+    ) -> None:\n+        raise NotImplementedError\n+\n+    @staticmethod\n+    def copy_blocks(\n+        kv_caches: List[torch.Tensor],\n+        src_to_dists: Dict[int, List[int]],\n+        *args,\n+    ) -> None:\n+        key_caches = [kv_cache[0] for kv_cache in kv_caches]\n+        value_caches = [kv_cache[1] for kv_cache in kv_caches]\n+        ops.copy_blocks(key_caches, value_caches, src_to_dists)", "apis": ["vllm.attention.backends.PagedAttention", "vllm.attention.ops.ipex_attn.PagedAttention"], "affected_paths": [], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit updates several crucial files that are not tests â€“ it enhances the Dockerfile (by adding TCMalloc and Intel Extension for PyTorch support), modifies documentation to highlight performance tips for CPU usage, and changes actual source code in the CPU backend (vllm/attention/backends/torch_sdpa.py) and adds a new module (vllm/attention/ops/ipex_attn.py). These changes focus on improving memory allocation efficiency and leveraging Intel's optimized extensions, which directly enhance CPU performance. The modifications are not trivial documentation fixes or mere refactorings; they alter how the high-level CPU APIs perform and include performance-related configuration. All conditions for a performance optimization commit are met.", "llm_api_reason": "The commit introduces several CPU backend optimizations targeting Intel hardware. It updates the Dockerfile and documentation for installing Intel Extension for PyTorch and TCMalloc. In the code, it modifies the TorchSDPABackend to conditionally import an optimized version of PagedAttention for CPU usage; it first tries to load PagedAttention from the newly added ipex_attn module and only falls back to the original implementation if needed. These changes affect the core attention API that vLLM uses for managing attention operations."}
{"commit_hash": "8d75fe48ca5f46b7af0f5201d8500b9604eed769", "pr_url": "https://github.com/vllm-project/vllm/pull/5183", "pr_date": "2024-06-07", "timeline_text": "Copy link Collaborator tlrmchlsmth commented Jun 1, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Switching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8 see https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and #5144 for comparisons across different GEMM sizes. PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 comaniac reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Switch fp8 layers to use the cutlass kernels b6809fa Copy link Collaborator robertgshaw2-redhat commented Jun 1, 2024 @tlrmchlsmth models: https://huggingface.co/nm-testing/Meta-Llama-3-70B-Instruct-FP8 https://huggingface.co/neuralmagic/Meta-Llama-3-8B-Instruct-FP8 https://huggingface.co/nm-testing/Meta-Llama-3-8B-Instruct-FP8-KV << with Quantized KV Cache ðŸ‘€ 1 tlrmchlsmth reacted with eyes emoji All reactions ðŸ‘€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . comaniac reviewed Jun 1, 2024 View reviewed changes vllm/model_executor/layers/quantization/fp8.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author tlrmchlsmth commented Jun 1, 2024 Just ran a quick sanity check for correctness. Output looks good on all three. I tried tensor_parallel_size=2 as well for the 70B model, and that looks good All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Narrow output 2e93b71 robertgshaw2-redhat reviewed Jun 1, 2024 View reviewed changes vllm/model_executor/layers/quantization/fp8.py Outdated return torch.narrow(output, 0, 0, x.shape[0]) # We use the CUTLASS kernels by default but they don't support bias yet if bias is None: Copy link Collaborator robertgshaw2-redhat Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do we also do a branch if we are on ada lovelace and CUDA 12.1? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author tlrmchlsmth Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment We will need to if on CUDA < 12.4. We also need a branch if on CUDA 11.8. @comaniac do you know if torch._scaled_mm is supported in that case? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator comaniac Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I only know that it only supports SM89+. We can try to call this op with torch+cu118 to test out. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author tlrmchlsmth Jun 1, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The cutlass kernels need at least SM89 as well, for the record. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator comaniac Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yeah that makes sense. Older architectures don't have native FP8 so we can't get speedup from them, which seems not necessary to be covered. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator robertgshaw2-redhat Jun 1, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Note: we already have a mechanism for determining if a LinearMethod can run on a specific cuda arch. The LinearMethod exposes get_min_capability which is called during model loading. https://github.com/vllm-project/vllm/blob/main/vllm/model_executor/layers/quantization/fp8.py#L46 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘€ 1 tlrmchlsmth reacted with eyes emoji All reactions ðŸ‘€ 1 reaction Copy link Collaborator pcmoritz commented Jun 1, 2024 Did you run benchmarks to compare the end-to-end performance? ITL for different qps All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator robertgshaw2-redhat commented Jun 1, 2024 Did you run benchmarks to compare the end-to-end performance? ITL for different qps Not yet. But obviously need this before we merge ðŸ‘ 3 tlrmchlsmth, pcmoritz, and comaniac reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Jun 1, 2024 I'll do a benchmark on Monday anyways. btw it'd be great if this PR is rebased onto the latest main that includes all required changes (it's likely the case already I suppose All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author tlrmchlsmth commented Jun 1, 2024 btw it'd be great if this PR is rebased onto the latest main that includes all required changes (it's likely the case already I suppose It's on a very recent main (from this morning) so it's good to use as is. In particular both #5144 and #5137 were needed for the switchover and they are both in. ðŸ‘ 1 comaniac reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Merge branch 'upstream-main' into tms/use_cutlass_4_fp8 33085d9 robertgshaw2-redhat reviewed Jun 3, 2024 View reviewed changes vllm/_custom_ops.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Jun 6, 2024 @tlrmchlsmth @robertgshaw2-neuralmagic per offline discussion, this PR should be ok to go at least for now? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author tlrmchlsmth commented Jun 6, 2024 Yeah, let's get it landed. It needs to check a few more cases for falling back to scaled_mm. I'll get to that today and then mark it ready for review ðŸ‘ 1 comaniac reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth added 2 commits June 6, 2024 20:46 Merge branch 'upstream-main' into tms/use_cutlass_4_fp8 43e5bd1 guard against calling cutlass when not supported 81f5372 robertgshaw2-redhat reviewed Jun 6, 2024 View reviewed changes vllm/model_executor/layers/quantization/fp8.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth added 2 commits June 6, 2024 21:59 format 1fe0468 check support during __init__ 2d77ca5 tlrmchlsmth marked this pull request as ready for review June 6, 2024 22:05 tlrmchlsmth added 2 commits June 6, 2024 22:14 Make that function standalone a1ffa09 format e894b21 robertgshaw2-redhat approved these changes Jun 6, 2024 View reviewed changes Copy link Collaborator robertgshaw2-redhat left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions pcmoritz approved these changes Jun 7, 2024 View reviewed changes Copy link Collaborator pcmoritz left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Great work and thanks for adding the benchmarks :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions comaniac approved these changes Jun 7, 2024 View reviewed changes Copy link Collaborator comaniac left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM. Thanks! I also did some benchmarks with this PR. Note that all results are in TP=4 on H100 and with chunked prefill enabled (this is just my own requirement). Prompts are 550 tokens, decoding 150 tokens. Model QPS scaled_mm-ITL cutlass-ITL scaled_mm-TTFT cutlass-TTFT Llama-3-70B 1 17.3 16.3 68.7 68.7 Llama-3-70B 4 22.7 21.2 72.3 72.6 Llama-3-70B 8 35.9 33.6 83.1 81.2 Mixtral-8x7B 1 9.1 8.9 43.1 40.7 Mixtral-8x7B 4 11.4 10.7 42.6 38.4 Mixtral-8x7B 8 15.6 14.3 43.4 42.8 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 pcmoritz reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction pcmoritz enabled auto-merge (squash) June 7, 2024 00:32 pcmoritz merged commit 8d75fe4 into vllm-project : main Jun 7, 2024 cli99 mentioned this pull request Jun 7, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS #5352 Merged Copy link Contributor cli99 commented Jun 7, 2024 @tlrmchlsmth Awesome work! Was trying this but ran into a problem when checking the cutlass fp8 support. Made a fix that works in my case in #5352 . All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . pcmoritz pushed a commit\n      that referenced\n      this pull request Jun 8, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( #5352 ) â€¦ e69ded7 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in #5183 . dtrifiro pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request Jun 10, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 â€¦ 80ec81e )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. dtrifiro pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request Jun 10, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) â€¦ 978a73a Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jun 11, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 â€¦ ed99ec9 )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Jun 11, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) â€¦ e349c2d Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . joerunde pushed a commit\n        to IBM/vllm\n      that referenced\n      this pull request Jun 13, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS (#5352) â€¦ e0c6dc7 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project/vllm#5183 . tlrmchlsmth deleted the tms/use_cutlass_4_fp8 branch June 14, 2024 17:20 joerunde pushed a commit\n        to joerunde/vllm\n      that referenced\n      this pull request Jun 17, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 â€¦ df50941 )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jun 27, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 â€¦ 2e9ab5b )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jun 27, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) â€¦ ecdf6ef Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 â€¦ 08faea8 )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 8, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) â€¦ eb6d8a6 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Kernel] Switch fp8 layers to use the CUTLASS kernels ( vllm-project#5183 â€¦ e9a71eb )\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and vllm-project#5144 for comparisons across different GEMM sizes. xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jul 24, 2024 [Bug Fix] Fix the support check for FP8 CUTLASS ( vllm-project#5352 ) â€¦ c975075 Bug description:\nWith torch 2.4.0.dev20240603+cu121,\ncutlass_fp8_supported outputs False, and the (capability, version) before the comparison is (90, 11111111112)\n\nThis PR fixes the support check for FP8 CUTLASS ( cutlass_fp8_supported) which was introduced in vllm-project#5183 . Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:50", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, qps | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, testing", "analysis_extracted_at": "2025-09-07 17:48:50", "models": ["neuralmagic/Meta-Llama-3-8B-Instruct-FP8", "nm-testing/Meta-Llama-3-70B-Instruct-FP8", "nm-testing/Meta-Llama-3-8B-Instruct-FP8-KV"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=neuralmagic/Meta-Llama-3-8B-Instruct-FP8,dtype=float16,tensor_parallel_size=1 --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model neuralmagic/Meta-Llama-3-8B-Instruct-FP8 --dataset-name sharegpt --dataset-path ./ShareGPT_V3_unfiltered_cleaned_split.json", "commit_subject": "[Kernel] Switch fp8 layers to use the CUTLASS kernels (#5183)", "commit_message": "[Kernel] Switch fp8 layers to use the CUTLASS kernels (#5183)\n\nSwitching from torch._scaled_mm to vLLM's cutlass fp8 kernels when supported as we are seeing 5-15% improvement in e2e performance on neuralmagic/Meta-Llama-3-8B-Instruct-FP8\n\nsee https://docs.google.com/spreadsheets/d/1GiAnmzyGHgZ6zL_LDSTm35Bdrt4A8AaFEurDlISYYA4/ for some quick e2e benchmarks and #5144 for comparisons across different GEMM sizes.", "commit_date": "2024-06-07T08:42:35Z", "files_changed": ["vllm/_custom_ops.py", "vllm/model_executor/layers/quantization/fp8.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 5, "num_edited_lines": 70, "num_non_test_edited_lines": 70, "commit_year": 2024}, "diff_text": "diff --git a/vllm/_custom_ops.py b/vllm/_custom_ops.py\nindex 462ba8a75..cae682216 100644\n--- a/vllm/_custom_ops.py\n+++ b/vllm/_custom_ops.py\n@@ -179,7 +179,7 @@ def gptq_marlin_24_gemm(a: torch.Tensor, b_q_weight: torch.Tensor,\n \n # cutlass\n def cutlass_scaled_mm_dq(a: torch.Tensor, b: torch.Tensor,\n-                         a_scales: torch.Tensor, b_scales: torch.Tensor,\n+                         scale_a: torch.Tensor, scale_b: torch.Tensor,\n                          out_dtype: Type[torch.dtype]) -> torch.Tensor:\n     assert (b.shape[0] % 16 == 0 and b.shape[1] % 16 == 0)\n     assert (out_dtype is torch.bfloat16 or out_dtype is torch.float16)\n@@ -188,7 +188,7 @@ def cutlass_scaled_mm_dq(a: torch.Tensor, b: torch.Tensor,\n     n = b.shape[1]\n     out = torch.empty((m, n), dtype=out_dtype, device=a.device)\n \n-    vllm_ops.cutlass_scaled_mm_dq(out, a, b, a_scales, b_scales)\n+    vllm_ops.cutlass_scaled_mm_dq(out, a, b, scale_a, scale_b)\n \n     return out\n \ndiff --git a/vllm/model_executor/layers/quantization/fp8.py b/vllm/model_executor/layers/quantization/fp8.py\nindex bf3a59e3d..136a64623 100644\n--- a/vllm/model_executor/layers/quantization/fp8.py\n+++ b/vllm/model_executor/layers/quantization/fp8.py\n@@ -17,6 +17,24 @@ ACTIVATION_SCHEMES = [\"static\", \"dynamic\"]\n logger = init_logger(__name__)\n \n \n+def cutlass_fp8_supported() -> bool:\n+    capability = torch.cuda.get_device_capability()\n+    capability = capability[0] * 10 + capability[1]\n+    version = torch.version.cuda\n+    version = version[0] * 10 + version[1]\n+\n+    # CUTLASS FP8 kernels need at least\n+    #   CUDA 12.0 on SM90 systems (Hopper)\n+    #   CUDA 12.4 on SM89 systems (Lovelace)\n+    gpu_is_supported = False\n+    if capability >= 900:\n+        gpu_is_supported = version > 120\n+    elif capability >= 890:\n+        gpu_is_supported = version > 124\n+\n+    return gpu_is_supported\n+\n+\n class Fp8Config(QuantizationConfig):\n     \"\"\"Config class for FP8.\"\"\"\n \n@@ -92,6 +110,7 @@ class Fp8LinearMethod(LinearMethodBase):\n \n     def __init__(self, quant_config: Fp8Config):\n         self.quant_config = quant_config\n+        self.cutlass_fp8_supported = cutlass_fp8_supported()\n \n     def _create_scale_param(\n         self,\n@@ -233,25 +252,40 @@ class Fp8LinearMethod(LinearMethodBase):\n               layer: torch.nn.Module,\n               x: torch.Tensor,\n               bias: Optional[torch.Tensor] = None) -> torch.Tensor:\n+\n         # ops.scaled_fp8_quant supports both dynamic and static quant.\n         #   If dynamic, layer.act_scale is None and x_scale computed from x.\n         #   If static,  layer.act_scale is scalar and x_scale set to act_scale.\n-        qinput, x_scale = ops.scaled_fp8_quant(x,\n-                                               layer.act_scale,\n-                                               batch_dim_padding=17)\n-\n-        # Fused GEMM_DQ -- note we padded the input above because\n-        # torch._scaled_mm is more performant for matrices with\n-        # batch dimension > 16. Note that this could change\n-        # in the future.\n-        output, _ = torch._scaled_mm(\n-            qinput,\n-            layer.weight,\n-            out_dtype=x.dtype,\n-            scale_a=x_scale,\n-            scale_b=layer.weight_scale,\n-            bias=bias,\n-        )\n+\n+        if bias is None and self.cutlass_fp8_supported:\n+            qinput, x_scale = ops.scaled_fp8_quant(x, layer.act_scale)\n+\n+            # Fused GEMM_DQ\n+            output = ops.cutlass_scaled_mm_dq(\n+                qinput,\n+                layer.weight,\n+                out_dtype=x.dtype,\n+                scale_a=x_scale,\n+                scale_b=layer.weight_scale,\n+            )\n+\n+        else:\n+            qinput, x_scale = ops.scaled_fp8_quant(x,\n+                                                   layer.act_scale,\n+                                                   batch_dim_padding=17)\n+\n+            # Fused GEMM_DQ -- note we padded the input above because\n+            # torch._scaled_mm is more performant for matrices with\n+            # batch dimension > 16. Note that this could change\n+            # in the future.\n+            output, _ = torch._scaled_mm(\n+                qinput,\n+                layer.weight,\n+                out_dtype=x.dtype,\n+                scale_a=x_scale,\n+                scale_b=layer.weight_scale,\n+                bias=bias,\n+            )\n \n         return torch.narrow(output, 0, 0, x.shape[0])", "apis": ["vllm._custom_ops.cutlass_scaled_mm_dq", "vllm.model_executor.layers.quantization.fp8.cutlass_fp8_supported", "vllm.model_executor.layers.quantization.fp8.Fp8LinearMethod.apply"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/fp8.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/_custom_ops.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/csrc/cutlass_extensions/vllm_cutlass_library_extension.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test source code filesâ€”in particular, it changes functionality in vllm/_custom_ops.py and vllm/model_executor/layers/quantization/fp8.py. The changes conditionally switch the fp8 layer implementation from torch._scaled_mm to use a specialized CUTLASS kernel (cutlass_scaled_mm_dq) for performance gains (with reported 5-15% end-to-end improvement). The modifications are not trivial refactoring; rather, they directly impact the performance of a top-level API by selecting a more efficient kernel when supported. Additionally, the change is CPU/GPU agnostic as it provides a condition for when CUTLASS kernels can be used, and it is not limited to any specific hardware. Therefore, the commit satisfies the conditions for being performance or optimization related.", "llm_api_reason": "The commit renames parameters in the lowâ€level custom op function â€œcutlass_scaled_mm_dqâ€ (changing its argument names from â€œa_scales, b_scalesâ€ to â€œscale_a, scale_bâ€) and adds a new helper function â€œcutlass_fp8_supportedâ€ to check CUDA/kernel compatibility. In addition, the FP8 linear quantization layer (Fp8LinearMethod) is modified so that its apply method conditionally calls the new CUTLASS-based GEMM (via ops.cutlass_scaled_mm_dq) when no bias is provided and the GPU supports CUTLASS FP8. These changes collectively affect the FP8 quantization path and its performance optimizations."}
{"commit_hash": "8bc68e198c4c90ddc2e54fa76eb81c2c714bb1cd", "pr_url": "https://github.com/vllm-project/vllm/pull/4208", "pr_date": "2024-05-13", "timeline_text": "Copy link Collaborator sangstar commented Apr 19, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Automatically detect vLLM-tensorized model, update tensorizer to version 2.9.0 This PR accomplishes several things: Updates docstrings to account for tensorizer refactor in [Core] Refactor model loading code #4097 in the tensorize_vllm_examples.py example script, and slight corrections to the docstrings of the new, refactored functions. Allows models to be automatically inferred as a vLLM-tensorized model . Accomplishes this by placing a meta-tensor \"footprint\" in the serialized model, and removing it at runtime. vllm_tensorized as an arg has been removed. Updates tensorizer to the full release of 2.9.0. PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions sangstar added 15 commits April 18, 2024 16:32 perf: Update tensorizer versions to new release 97131c0 perf: Update tensorizer versions to new release 1ba6bc5 docs: Remove unnecessary comma 5e58d6f refactor: (WIP) Allow detection of vLLM-tensorized model â€¦ 62006f9 WIP because the codes needs to be cleaned up, and the current work\nrefactoring the example script in to importable functions from\n`tensorizer.py` is still in progress, which will allow for better\nforward compatibility and better testing. tests: Add testing for vLLM-tensorized model has same output cbeb2cb tests: Fix redundant variables a80b5ce perf: Update example script, add logging for deserialization 1486dcd tests: Get tests to pass e019350 docs: Update docs to reflect accurate function descriptions 31a5076 Run yapf and ruff d68f128 chore: Remove todo 287bfbb chore: Fix yapf formatting f3393bd chore: Disable yapf from interfering with isort for testing script 04c78bf chore: Disable yapf at testing script import block 9658a1a fix: Instantiate load partials only when tensorizer imported 96af687 Copy link Collaborator Author sangstar commented Apr 22, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @Yard1 @ywang96 Some QoL improvements for tensorizer and some corrected docstrings (as per the great refactor from @Yard1 ), and an update for tensorizer as version 1.9.0 is officially released. No longer need to specify if a model is vLLM-tensorized beforehand, as I've implemented a way for this to be inferred implicitly by registering a meta tensor into the model during serialization with a vllm-tensorized-marker and removing it during deserialization. ðŸš€ 1 Yard1 reacted with rocket emoji All reactions ðŸš€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . sangstar added 5 commits April 22, 2024 14:29 Merge remote-tracking branch 'upstream/main' into sangstar/tensorizerâ€¦ â€¦ 5890ded â€¦-update\n\n# Conflicts:\n#\tdocs/source/models/engine_args.rst perf: Update and streamline docs on tensorizing a vLLM model b702901 docs: Correct docstring, add tensorizer docs link for more info 43a298a docs: Fix S3_ENDPOINT_URL naming 2a61b9a docs: Additionally fix S3_ENDPOINT_URL naming on example script 2b2012a Copy link Collaborator Author sangstar commented Apr 29, 2024 Further made some improvements with documentation. Important fixes explaining how to use tensorizer with the refactored changes (as the example script predates the refactor) so hoping to get eyes on this! Cheers :D @ywang96 @Yard1 ðŸ‘ 1 ywang96 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . sangstar added 5 commits April 29, 2024 10:17 tests: Add tensorize_vllm_model.py to Examples Test for regression a1b5971 Merge remote-tracking branch 'upstream/main' into sangstar/tensorizerâ€¦ â€¦ 6e7bfae â€¦-update Run yapf and ruff, update docs 77817d1 perf: Force serialization and deserialization test in example script 19495cf fix: Not double-initiating model for deserialize case in example 1fe66be sangstar mentioned this pull request May 3, 2024 [Frontend] [Core] feat: Add model loading using tensorizer #3476 Merged Copy link Member ywang96 commented May 4, 2024 Will take a look once I have some bandwidth - thanks for the continuous contribution to vLLM! â¤ï¸ 1 sangstar reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ywang96 self-assigned this May 4, 2024 sangstar added 2 commits May 6, 2024 09:28 Merge remote-tracking branch 'upstream/main' into sangstar/tensorizerâ€¦ â€¦ 449753c â€¦-update\n\n# Conflicts:\n#\trequirements-dev.txt\n#\tsetup.py\n#\ttests/tensorizer_loader/tensorize_vllm_model_for_testing.py chore: Update initializing env 9c2f7f8 bbrowning reviewed May 9, 2024 View reviewed changes examples/tensorize_vllm_model.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . ywang96 reviewed May 12, 2024 View reviewed changes Copy link Member ywang96 left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thank you @sangstar for the continuous contribution! I left some questions. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 sangstar reacted with heart emoji All reactions â¤ï¸ 1 reaction examples/tensorize_vllm_model.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/model_loader/tensorizer.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/model_loader/loader.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . chore: Reallow vllm_tensorized parameter, envs fix 246f636 sangstar requested a review\n  from ywang96 May 12, 2024 13:02 sangstar added 3 commits May 12, 2024 09:09 Merge remote-tracking branch 'refs/remotes/upstream/main' into sangstâ€¦ â€¦ a86ab10 â€¦ar/tensorizer-update chore: Install tensorizer for Examples Test 829e24b style: Remove trailing whitespace 7271ea2 Copy link Collaborator Author sangstar commented May 12, 2024 @ywang96 Resolved comments! Let me know if anything else is needed. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . sangstar added 2 commits May 13, 2024 13:56 Merge remote-tracking branch 'upstream/main' into sangstar/tensorizerâ€¦ â€¦ ac7341e â€¦-update\n\n# Conflicts:\n#\tvllm/model_executor/model_loader/loader.py Run yapf and ruff 0abbe10 ywang96 reviewed May 13, 2024 View reviewed changes vllm/model_executor/model_loader/tensorizer.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . sangstar requested a review\n  from ywang96 May 13, 2024 19:48 Copy link Collaborator Author sangstar commented May 13, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @ywang96 Resolved comments! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ywang96 approved these changes May 13, 2024 View reviewed changes Copy link Member ywang96 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment ðŸš€ LGTM! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 1 sangstar reacted with rocket emoji All reactions ðŸš€ 1 reaction Copy link Collaborator Author sangstar commented May 13, 2024 @ywang96 Checks passed and ready to merge! ðŸ˜„ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ywang96 merged commit 8bc68e1 into vllm-project : main May 13, 2024 sangstar deleted the sangstar/tensorizer-update branch May 14, 2024 14:04 robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request May 19, 2024 [Frontend] [Core] perf: Automatically detect vLLM-tensorized model, uâ€¦ â€¦ 7dd2e73 â€¦pdate `tensorizer` to version 2.9.0 ( vllm-project#4208 ) dtrifiro pushed a commit\n        to dtrifiro/vllm\n      that referenced\n      this pull request May 21, 2024 [Frontend] [Core] perf: Automatically detect vLLM-tensorized model, uâ€¦ â€¦ 64d2fdc â€¦pdate `tensorizer` to version 2.9.0 ( vllm-project#4208 ) sangstar mentioned this pull request Jun 13, 2024 [Doc] Update documentation on Tensorizer #5471 Merged sangstar mentioned this pull request Jun 20, 2025 [Frontend] [Core] Integrate Tensorizer in to S3 loading machinery, allow passing arbitrary arguments during save/load #19619 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:54", "has_lm_eval": false, "has_performance": false, "has_serving": true, "has_general_test": true, "test_details": "SERVING: API server, OpenAI API server, Frontend | TEST: test, Test, test", "analysis_extracted_at": "2025-09-07 17:48:54", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Frontend] [Core] perf: Automatically detect vLLM-tensorized model, update `tensorizer` to version 2.9.0 (#4208)", "commit_message": "[Frontend] [Core] perf: Automatically detect vLLM-tensorized model, update `tensorizer` to version 2.9.0 (#4208)", "commit_date": "2024-05-13T14:57:07-07:00", "files_changed": [".buildkite/test-pipeline.yaml", "examples/tensorize_vllm_model.py", "requirements-dev.txt", "setup.py", "tests/tensorizer_loader/tensorize_vllm_model_for_testing.py", "tests/tensorizer_loader/test_tensorizer.py", "vllm/engine/arg_utils.py", "vllm/envs.py", "vllm/model_executor/model_loader/loader.py", "vllm/model_executor/model_loader/tensorizer.py"], "functions_changed": [], "stats": {"num_test_files": 2, "num_non_test_files": 8, "only_test_files": 0, "only_non_test_files": 0, "num_files": 10, "num_hunks": 40, "num_edited_lines": 782, "num_non_test_edited_lines": 348, "commit_year": 2024}, "diff_text": "diff --git a/.buildkite/test-pipeline.yaml b/.buildkite/test-pipeline.yaml\nindex 4feea786f..3c3da41c3 100644\n--- a/.buildkite/test-pipeline.yaml\n+++ b/.buildkite/test-pipeline.yaml\n@@ -60,11 +60,13 @@ steps:\n   mirror_hardwares: [amd]\n   commands:\n     # install aws cli for llava_example.py\n-    - pip install awscli\n+    # install tensorizer for tensorize_vllm_model.py\n+    - pip install awscli tensorizer\n     - python3 offline_inference.py\n     - python3 offline_inference_with_prefix.py\n     - python3 llm_engine_example.py\n     - python3 llava_example.py\n+    - python3 tensorize_vllm_model.py --model facebook/opt-125m serialize --serialized-directory /tmp/ --suffix v1 && python3 tensorize_vllm_model.py --model facebook/opt-125m deserialize --path-to-tensors /tmp/vllm/facebook/opt-125m/v1/model.tensors\n \n - label: Kernels Test %N\n   command: pytest -v -s kernels --shard-id=$$BUILDKITE_PARALLEL_JOB --num-shards=$$BUILDKITE_PARALLEL_JOB_COUNT\ndiff --git a/examples/tensorize_vllm_model.py b/examples/tensorize_vllm_model.py\nindex e2456168d..8b74ae1d7 100644\n--- a/examples/tensorize_vllm_model.py\n+++ b/examples/tensorize_vllm_model.py\n@@ -1,23 +1,20 @@\n import argparse\n import dataclasses\n+import json\n import os\n-import time\n import uuid\n from functools import partial\n-from typing import Type\n \n-import torch\n-import torch.nn as nn\n-from tensorizer import (DecryptionParams, EncryptionParams, TensorDeserializer,\n-                        TensorSerializer, stream_io)\n-from tensorizer.utils import convert_bytes, get_mem_usage, no_init_or_tensor\n-from transformers import AutoConfig, PretrainedConfig\n+from tensorizer import stream_io\n \n-from vllm.distributed import initialize_model_parallel\n+from vllm import LLM\n+from vllm.distributed import (init_distributed_environment,\n+                              initialize_model_parallel)\n from vllm.engine.arg_utils import EngineArgs\n from vllm.engine.llm_engine import LLMEngine\n-from vllm.model_executor.model_loader.tensorizer import TensorizerArgs\n-from vllm.model_executor.models import ModelRegistry\n+from vllm.model_executor.model_loader.tensorizer import (TensorizerArgs,\n+                                                         TensorizerConfig,\n+                                                         serialize_vllm_model)\n \n # yapf conflicts with isort for this docstring\n # yapf: disable\n@@ -27,25 +24,25 @@ deserialize vLLM models. These models can be loaded using tensorizer\n to the GPU extremely quickly over an HTTP/HTTPS endpoint, an S3 endpoint,\n or locally. Tensor encryption and decryption is also supported, although \n libsodium must be installed to use it. Install vllm with tensorizer support \n-using `pip install vllm[tensorizer]`.\n+using `pip install vllm[tensorizer]`. To learn more about tensorizer, visit\n+https://github.com/coreweave/tensorizer\n \n To serialize a model, install vLLM from source, then run something \n like this from the root level of this repository:\n \n python -m examples.tensorize_vllm_model \\\n-   --model EleutherAI/gpt-j-6B \\\n-   --dtype float16 \\\n+   --model facebook/opt-125m \\\n    serialize \\\n-   --serialized-directory s3://my-bucket/ \\\n-   --suffix vllm\n+   --serialized-directory s3://my-bucket \\\n+   --suffix v1\n    \n Which downloads the model from HuggingFace, loads it into vLLM, serializes it,\n and saves it to your S3 bucket. A local directory can also be used. This\n assumes your S3 credentials are specified as environment variables\n-in the form of `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`, and `S3_ENDPOINT`.\n-To provide S3 credentials directly, you can provide `--s3-access-key-id` and \n-`--s3-secret-access-key`, as well as `--s3-endpoint` as CLI args to this \n-script.\n+in the form of `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`, and \n+`S3_ENDPOINT_URL`. To provide S3 credentials directly, you can provide \n+`--s3-access-key-id` and `--s3-secret-access-key`, as well as `--s3-endpoint` \n+as CLI args to this script.\n \n You can also encrypt the model weights with a randomly-generated key by \n providing a `--keyfile` argument.\n@@ -57,7 +54,7 @@ python -m examples.tensorize_vllm_model \\\n    --model EleutherAI/gpt-j-6B \\\n    --dtype float16 \\\n    deserialize \\\n-   --path-to-tensors s3://my-bucket/vllm/EleutherAI/gpt-j-6B/vllm/model.tensors\n+   --path-to-tensors s3://my-bucket/vllm/EleutherAI/gpt-j-6B/v1/model.tensors\n \n Which downloads the model tensors from your S3 bucket and deserializes them.\n \n@@ -71,26 +68,30 @@ Or for deserializing:\n \n `python -m examples.tensorize_vllm_model deserialize --help`.\n \n-Once a model is serialized, it can be used to load the model when running the\n-OpenAI inference client at `vllm/entrypoints/openai/api_server.py` by providing\n-the `--tensorizer-uri` CLI argument that is functionally the same as the\n-`--path-to-tensors` argument in this script, along with `--vllm-tensorized`, to\n-signify that the model to be deserialized is a vLLM model, rather than a \n-HuggingFace `PreTrainedModel`, which can also be deserialized using tensorizer\n-in the same inference server, albeit without the speed optimizations. To\n-deserialize an encrypted file, the `--encryption-keyfile` argument can be used\n-to provide the path to the keyfile used to encrypt the model weights. For\n-information on all the arguments that can be used to configure tensorizer's\n-deserialization, check out the tensorizer options argument group in the\n-`vllm/entrypoints/openai/api_server.py` script with `--help`.\n-\n-Tensorizer can also be invoked with the `LLM` class directly to load models:\n+Once a model is serialized, tensorizer can be invoked with the `LLM` class \n+directly to load models:\n \n     llm = LLM(model=\"facebook/opt-125m\",\n               load_format=\"tensorizer\",\n-              tensorizer_uri=path_to_opt_tensors,\n-              num_readers=3,\n-              vllm_tensorized=True)\n+              model_loader_extra_config=TensorizerConfig(\n+                    tensorizer_uri = path_to_tensors,\n+                    num_readers=3,\n+                    )\n+              )\n+            \n+A serialized model can be used during model loading for the vLLM OpenAI\n+inference server. `model_loader_extra_config` is exposed as the CLI arg\n+`--model-loader-extra-config`, and accepts a JSON string literal of the\n+TensorizerConfig arguments desired.\n+\n+In order to see all of the available arguments usable to configure \n+loading with tensorizer that are given to `TensorizerConfig`, run:\n+\n+`python -m examples.tensorize_vllm_model deserialize --help`\n+\n+under the `tensorizer options` section. These can also be used for\n+deserialization in this example script, although `--tensorizer-uri` and\n+`--path-to-tensors` are functionally the same in this case.\n \"\"\"\n \n \n@@ -158,95 +159,35 @@ def parse_args():\n         help=(\"Path to a binary key to use to decrypt the model weights,\"\n               \" if the model was serialized with encryption\"))\n \n-    return parser.parse_args()\n-\n-\n-def make_model_contiguous(model):\n-    # Ensure tensors are saved in memory contiguously\n-    for param in model.parameters():\n-        param.data = param.data.contiguous()\n-\n-\n-def _get_vllm_model_architecture(config: PretrainedConfig) -> Type[nn.Module]:\n-    architectures = getattr(config, \"architectures\", [])\n-    for arch in architectures:\n-        model_cls = ModelRegistry.load_model_cls(arch)\n-        if model_cls is not None:\n-            return model_cls\n-    raise ValueError(\n-        f\"Model architectures {architectures} are not supported for now. \"\n-        f\"Supported architectures: {ModelRegistry.get_supported_archs()}\")\n-\n-\n-def serialize():\n-\n-    eng_args_dict = {f.name: getattr(args, f.name) for f in\n-                     dataclasses.fields(EngineArgs)}\n-    engine_args = EngineArgs.from_cli_args(argparse.Namespace(**eng_args_dict))\n-    engine = LLMEngine.from_engine_args(engine_args)\n+    TensorizerArgs.add_cli_args(deserialize_parser)\n \n-    model = (engine.model_executor.driver_worker.\n-             model_runner.model)\n-\n-    encryption_params = EncryptionParams.random() if keyfile else None\n-    if keyfile:\n-        with _write_stream(keyfile) as stream:\n-            stream.write(encryption_params.key)\n-\n-    with _write_stream(model_path) as stream:\n-        serializer = TensorSerializer(stream, encryption=encryption_params)\n-        serializer.write_module(model)\n-        serializer.close()\n+    return parser.parse_args()\n \n-    print(\"Serialization complete. Model tensors saved to\", model_path)\n-    if keyfile:\n-        print(\"Key saved to\", keyfile)\n \n \n def deserialize():\n-    config = AutoConfig.from_pretrained(model_ref)\n-\n-    with no_init_or_tensor():\n-        model_class = _get_vllm_model_architecture(config)\n-        model = model_class(config)\n-\n-    before_mem = get_mem_usage()\n-    start = time.time()\n-\n-    if keyfile:\n-        with _read_stream(keyfile) as stream:\n-            key = stream.read()\n-            decryption_params = DecryptionParams.from_key(key)\n-            tensorizer_args.deserializer_params['encryption'] = \\\n-                decryption_params\n-\n-    with (_read_stream(model_path)) as stream, TensorDeserializer(\n-            stream, **tensorizer_args.deserializer_params) as deserializer:\n-        deserializer.load_into_module(model)\n-        end = time.time()\n-\n-    # Brag about how fast we are.\n-    total_bytes_str = convert_bytes(deserializer.total_tensor_bytes)\n-    duration = end - start\n-    per_second = convert_bytes(deserializer.total_tensor_bytes / duration)\n-    after_mem = get_mem_usage()\n-    print(\n-        f\"Deserialized {total_bytes_str} in {end - start:0.2f}s, {per_second}/s\"\n+    llm = LLM(model=args.model,\n+              load_format=\"tensorizer\",\n+              model_loader_extra_config=tensorizer_config\n     )\n-    print(f\"Memory usage before: {before_mem}\")\n-    print(f\"Memory usage after: {after_mem}\")\n+    return llm\n \n-    return model\n \n \n args = parse_args()\n \n-s3_access_key_id = (args.s3_access_key_id or os.environ.get(\"S3_ACCESS_KEY_ID\")\n-                    or None)\n-s3_secret_access_key = (args.s3_secret_access_key\n-                        or os.environ.get(\"S3_SECRET_ACCESS_KEY\") or None)\n+s3_access_key_id = (getattr(args, 's3_access_key_id', None)\n+                    or os.environ.get(\"S3_ACCESS_KEY_ID\", None))\n+s3_secret_access_key = (getattr(args, 's3_secret_access_key', None)\n+                        or os.environ.get(\"S3_SECRET_ACCESS_KEY\", None))\n+s3_endpoint = (getattr(args, 's3_endpoint', None)\n+               or os.environ.get(\"S3_ENDPOINT_URL\", None))\n \n-s3_endpoint = (args.s3_endpoint or os.environ.get(\"S3_ENDPOINT_URL\") or None)\n+credentials = {\n+    \"s3_access_key_id\": s3_access_key_id,\n+    \"s3_secret_access_key\": s3_secret_access_key,\n+    \"s3_endpoint\": s3_endpoint\n+}\n \n _read_stream, _write_stream = (partial(\n     stream_io.open_stream,\n@@ -263,20 +204,41 @@ model_name = model_ref.split(\"/\")[1]\n os.environ[\"MASTER_ADDR\"] = \"127.0.0.1\"\n os.environ[\"MASTER_PORT\"] = \"8080\"\n \n-torch.distributed.init_process_group(world_size=1, rank=0)\n+init_distributed_environment(world_size=1, rank=0, local_rank=0)\n initialize_model_parallel()\n \n keyfile = args.keyfile if args.keyfile else None\n \n+\n+if args.model_loader_extra_config:\n+    config = json.loads(args.model_loader_extra_config)\n+    tensorizer_args = TensorizerConfig(**config)._construct_tensorizer_args()\n+    tensorizer_args.tensorizer_uri = args.path_to_tensors\n+else:\n+    tensorizer_args = None\n+\n if args.command == \"serialize\":\n+    eng_args_dict = {f.name: getattr(args, f.name) for f in\n+                     dataclasses.fields(EngineArgs)}\n+\n+    engine_args = EngineArgs.from_cli_args(argparse.Namespace(**eng_args_dict))\n+    engine = LLMEngine.from_engine_args(engine_args)\n+\n     input_dir = args.serialized_directory.rstrip('/')\n     suffix = args.suffix if args.suffix else uuid.uuid4().hex\n     base_path = f\"{input_dir}/vllm/{model_ref}/{suffix}\"\n     model_path = f\"{base_path}/model.tensors\"\n-    serialize()\n+    tensorizer_config = TensorizerConfig(\n+        tensorizer_uri=model_path,\n+        **credentials)\n+    serialize_vllm_model(engine, tensorizer_config, keyfile)\n elif args.command == \"deserialize\":\n-    tensorizer_args = TensorizerArgs.from_cli_args(args)\n-    model_path = args.path_to_tensors\n+    if not tensorizer_args:\n+        tensorizer_config = TensorizerConfig(\n+            tensorizer_uri=args.path_to_tensors,\n+            encryption_keyfile = keyfile,\n+            **credentials\n+        )\n     deserialize()\n else:\n     raise ValueError(\"Either serialize or deserialize must be specified.\")\ndiff --git a/requirements-dev.txt b/requirements-dev.txt\nindex 796c9e37d..4f6c27d95 100644\n--- a/requirements-dev.txt\n+++ b/requirements-dev.txt\n@@ -14,7 +14,7 @@ types-setuptools\n \n # testing\n pytest\n-tensorizer==2.9.0\n+tensorizer>=2.9.0\n pytest-forked\n pytest-asyncio\n pytest-rerunfailures\ndiff --git a/setup.py b/setup.py\nindex 0dc8818b4..a66af2c5d 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -426,7 +426,7 @@ setup(\n     install_requires=get_requirements(),\n     ext_modules=ext_modules,\n     extras_require={\n-        \"tensorizer\": [\"tensorizer==2.9.0\"],\n+        \"tensorizer\": [\"tensorizer>=2.9.0\"],\n     },\n     cmdclass={\"build_ext\": cmake_build_ext} if not _is_neuron() else {},\n     package_data=package_data,\ndiff --git a/tests/tensorizer_loader/tensorize_vllm_model_for_testing.py b/tests/tensorizer_loader/tensorize_vllm_model_for_testing.py\ndeleted file mode 100644\nindex 0e113ab64..000000000\n--- a/tests/tensorizer_loader/tensorize_vllm_model_for_testing.py\n+++ /dev/null\n@@ -1,245 +0,0 @@\n-import argparse\n-import dataclasses\n-import os\n-import time\n-import uuid\n-from functools import partial\n-from typing import Type\n-\n-import torch.nn as nn\n-from tensorizer import (DecryptionParams, EncryptionParams, TensorDeserializer,\n-                        TensorSerializer, stream_io)\n-from tensorizer.utils import convert_bytes, get_mem_usage, no_init_or_tensor\n-from transformers import AutoConfig, PretrainedConfig\n-\n-from vllm.distributed import (init_distributed_environment,\n-                              initialize_model_parallel)\n-from vllm.engine.arg_utils import EngineArgs\n-from vllm.engine.llm_engine import LLMEngine\n-from vllm.model_executor.model_loader.tensorizer import TensorizerArgs\n-from vllm.model_executor.models import ModelRegistry\n-\n-# yapf conflicts with isort for this docstring\n-# yapf: disable\n-\"\"\"\n-tensorize_vllm_model.py is a script that can be used to serialize and \n-deserialize vLLM models. These models can be loaded using tensorizer directly \n-to the GPU extremely quickly. Tensor encryption and decryption is also \n-supported, although libsodium must be installed to use it. Install\n-vllm with tensorizer support using `pip install vllm[tensorizer]`.\n-\n-To serialize a model, you can run something like this:\n-\n-python tensorize_vllm_model.py \\\n-   --model EleutherAI/gpt-j-6B \\\n-   --dtype float16 \\\n-   serialize \\\n-   --serialized-directory s3://my-bucket/ \\\n-   --suffix vllm\n-\n-Which downloads the model from HuggingFace, loads it into vLLM, serializes it,\n-and saves it to your S3 bucket. A local directory can also be used.\n-\n-You can also encrypt the model weights with a randomly-generated key by \n-providing a `--keyfile` argument.\n-\n-To deserialize a model, you can run something like this:\n-\n-python tensorize_vllm_model.py \\\n-   --model EleutherAI/gpt-j-6B \\\n-   --dtype float16 \\\n-   deserialize \\\n-   --path-to-tensors s3://my-bucket/vllm/EleutherAI/gpt-j-6B/vllm/model.tensors\n-\n-Which downloads the model tensors from your S3 bucket and deserializes them.\n-To provide S3 credentials, you can provide `--s3-access-key-id` and \n-`--s3-secret-access-key`, as well as `--s3-endpoint` as CLI args to this script,\n-the OpenAI entrypoint, as arguments for LLM(), or as environment variables\n-in the form of `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`, and `S3_ENDPOINT`.\n-\n-\n-You can also provide a `--keyfile` argument to decrypt the model weights if \n-they were serialized with encryption.\n-\n-For more information on the available arguments, run \n-`python tensorize_vllm_model.py --help`.\n-\"\"\"\n-\n-\n-def parse_args():\n-    parser = argparse.ArgumentParser(\n-        description=\"An example script that can be used to serialize and \"\n-                    \"deserialize vLLM models. These models \"\n-                    \"can be loaded using tensorizer directly to the GPU \"\n-                    \"extremely quickly. Tensor encryption and decryption is \"\n-                    \"also supported, although libsodium must be installed to \"\n-                    \"use it.\")\n-    parser = TensorizerArgs.add_cli_args(EngineArgs.add_cli_args(parser))\n-    subparsers = parser.add_subparsers(dest='command')\n-\n-    serialize_parser = subparsers.add_parser(\n-        'serialize', help=\"Serialize a model to `--serialized-directory`\")\n-\n-    serialize_parser.add_argument(\n-        \"--suffix\",\n-        type=str,\n-        required=False,\n-        help=(\n-            \"The suffix to append to the serialized model directory, which is \"\n-            \"used to construct the location of the serialized model tensors, \"\n-            \"e.g. if `--serialized-directory` is `s3://my-bucket/` and \"\n-            \"`--suffix` is `v1`, the serialized model tensors will be \"\n-            \"saved to \"\n-            \"`s3://my-bucket/vllm/EleutherAI/gpt-j-6B/v1/model.tensors`. \"\n-            \"If none is provided, a random UUID will be used.\"))\n-    serialize_parser.add_argument(\n-        \"--serialized-directory\",\n-        type=str,\n-        required=True)\n-\n-    serialize_parser.add_argument(\n-        \"--keyfile\",\n-        type=str,\n-        required=False,\n-        help=(\"Encrypt the model weights with a randomly-generated binary key,\"\n-              \" and save the key at this path\"))\n-\n-    deserialize_parser = subparsers.add_parser(\n-        'deserialize',\n-        help=(\"Deserialize a model from `--path-to-tensors`\"\n-              \" to verify it can be loaded and used.\"))\n-\n-    deserialize_parser.add_argument(\n-        \"--path-to-tensors\",\n-        type=str,\n-        required=True,\n-        help=\"The local path or S3 URI to the model tensors to deserialize. \")\n-\n-    deserialize_parser.add_argument(\n-        \"--keyfile\",\n-        type=str,\n-        required=False,\n-        help=(\"Path to a binary key to use to decrypt the model weights,\"\n-              \" if the model was serialized with encryption\"))\n-\n-    return parser.parse_args()\n-\n-\n-def make_model_contiguous(model):\n-    # Ensure tensors are saved in memory contiguously\n-    for param in model.parameters():\n-        param.data = param.data.contiguous()\n-\n-\n-def _get_vllm_model_architecture(config: PretrainedConfig) -> Type[nn.Module]:\n-    architectures = getattr(config, \"architectures\", [])\n-    for arch in architectures:\n-        model_cls = ModelRegistry.load_model_cls(arch)\n-        if model_cls is not None:\n-            return model_cls\n-    raise ValueError(\n-        f\"Model architectures {architectures} are not supported for now. \"\n-        f\"Supported architectures: {ModelRegistry.get_supported_archs()}\")\n-\n-\n-def serialize():\n-    eng_args_dict = {f.name: getattr(args, f.name) for f in\n-                     dataclasses.fields(EngineArgs)}\n-    engine_args = EngineArgs.from_cli_args(argparse.Namespace(**eng_args_dict))\n-    engine = LLMEngine.from_engine_args(engine_args)\n-\n-    model = (engine.model_executor.driver_worker.\n-             model_runner.model)\n-\n-    encryption_params = EncryptionParams.random() if keyfile else None\n-    if keyfile:\n-        with _write_stream(keyfile) as stream:\n-            stream.write(encryption_params.key)\n-\n-    with _write_stream(model_path) as stream:\n-        serializer = TensorSerializer(stream, encryption=encryption_params)\n-        serializer.write_module(model)\n-        serializer.close()\n-\n-    print(\"Serialization complete. Model tensors saved to\", model_path)\n-    if keyfile:\n-        print(\"Key saved to\", keyfile)\n-\n-\n-def deserialize():\n-    config = AutoConfig.from_pretrained(model_ref)\n-\n-    with no_init_or_tensor():\n-        model_class = _get_vllm_model_architecture(config)\n-        model = model_class(config)\n-\n-    before_mem = get_mem_usage()\n-    start = time.time()\n-\n-    if keyfile:\n-        with _read_stream(keyfile) as stream:\n-            key = stream.read()\n-            decryption_params = DecryptionParams.from_key(key)\n-            tensorizer_args.deserializer_params['encryption'] = \\\n-                decryption_params\n-\n-    with (_read_stream(model_path)) as stream, TensorDeserializer(\n-            stream, **tensorizer_args.deserializer_params) as deserializer:\n-        deserializer.load_into_module(model)\n-        end = time.time()\n-\n-    # Brag about how fast we are.\n-    total_bytes_str = convert_bytes(deserializer.total_tensor_bytes)\n-    duration = end - start\n-    per_second = convert_bytes(deserializer.total_tensor_bytes / duration)\n-    after_mem = get_mem_usage()\n-    print(\n-        f\"Deserialized {total_bytes_str} in {end - start:0.2f}s, {per_second}/s\"\n-    )\n-    print(f\"Memory usage before: {before_mem}\")\n-    print(f\"Memory usage after: {after_mem}\")\n-\n-    return model\n-\n-\n-args = parse_args()\n-\n-s3_access_key_id = (args.s3_access_key_id or os.environ.get(\"S3_ACCESS_KEY_ID\")\n-                    or None)\n-s3_secret_access_key = (args.s3_secret_access_key\n-                        or os.environ.get(\"S3_SECRET_ACCESS_KEY\") or None)\n-\n-s3_endpoint = (args.s3_endpoint or os.environ.get(\"S3_ENDPOINT_URL\") or None)\n-\n-_read_stream, _write_stream = (partial(\n-    stream_io.open_stream,\n-    mode=mode,\n-    s3_access_key_id=s3_access_key_id,\n-    s3_secret_access_key=s3_secret_access_key,\n-    s3_endpoint=s3_endpoint,\n-) for mode in (\"rb\", \"wb+\"))\n-\n-model_ref = args.model\n-\n-model_name = model_ref.split(\"/\")[1]\n-\n-os.environ[\"MASTER_ADDR\"] = \"127.0.0.1\"\n-os.environ[\"MASTER_PORT\"] = \"8080\"\n-\n-init_distributed_environment(world_size=1, rank=0, local_rank=0)\n-initialize_model_parallel()\n-\n-keyfile = args.keyfile if args.keyfile else None\n-\n-if args.command == \"serialize\":\n-    input_dir = args.serialized_directory.rstrip('/')\n-    suffix = args.suffix if args.suffix else uuid.uuid4().hex\n-    base_path = f\"{input_dir}/vllm/{model_ref}/{suffix}\"\n-    model_path = f\"{base_path}/model.tensors\"\n-    serialize()\n-elif args.command == \"deserialize\":\n-    tensorizer_args = TensorizerArgs.from_cli_args(args)\n-    model_path = args.path_to_tensors\n-    deserialize()\n-else:\n-    raise ValueError(\"Either serialize or deserialize must be specified.\")\ndiff --git a/tests/tensorizer_loader/test_tensorizer.py b/tests/tensorizer_loader/test_tensorizer.py\nindex ad4748c5e..1579d53a7 100644\n--- a/tests/tensorizer_loader/test_tensorizer.py\n+++ b/tests/tensorizer_loader/test_tensorizer.py\n@@ -10,12 +10,19 @@ import ray\n import torch\n \n from vllm import SamplingParams\n-from vllm.model_executor.model_loader.tensorizer import (\n-    EncryptionParams, TensorizerConfig, TensorSerializer,\n-    is_vllm_serialized_tensorizer, load_with_tensorizer, open_stream)\n+# yapf: disable\n+from vllm.model_executor.model_loader.tensorizer import (TensorizerConfig,\n+                                                         TensorSerializer,\n+                                                         is_vllm_tensorized,\n+                                                         load_with_tensorizer,\n+                                                         open_stream,\n+                                                         serialize_vllm_model)\n \n from ..utils import ServerRunner\n \n+# yapf conflicts with isort for this docstring\n+\n+\n prompts = [\n     \"Hello, my name is\",\n     \"The president of the United States is\",\n@@ -40,7 +47,7 @@ def is_curl_installed():\n \n @pytest.fixture(autouse=True)\n def tensorizer_config():\n-    config = TensorizerConfig(tensorizer_uri=\"vllm\", vllm_tensorized=True)\n+    config = TensorizerConfig(tensorizer_uri=\"vllm\")\n     return config\n \n \n@@ -59,47 +66,6 @@ def test_load_with_tensorizer(mock_agent, tensorizer_config):\n     assert result == mock_agent_instance.deserialize.return_value\n \n \n-def test_is_vllm_model_with_vllm_in_uri(tensorizer_config):\n-    tensorizer_config.vllm_tensorized = True\n-\n-    result = is_vllm_serialized_tensorizer(tensorizer_config)\n-\n-    assert result is True\n-\n-\n-def test_is_vllm_model_without_vllm_in_uri(tensorizer_config):\n-    tensorizer_config.vllm_tensorized = False\n-\n-    result = is_vllm_serialized_tensorizer(tensorizer_config)\n-\n-    assert result is False\n-\n-\n-def test_deserialized_vllm_model_has_same_outputs(vllm_runner, tmp_path):\n-    vllm_model = vllm_runner(model_ref)\n-    model_path = tmp_path / (model_ref + \".tensors\")\n-    outputs = vllm_model.generate(prompts, sampling_params)\n-    model = (vllm_model.model.llm_engine.model_executor.driver_worker.\n-             model_runner.model)\n-    with open_stream(model_path, \"wb+\") as stream:\n-        serializer = TensorSerializer(stream)\n-        serializer.write_module(model)\n-    del vllm_model, model\n-    gc.collect()\n-    torch.cuda.empty_cache()\n-    loaded_vllm_model = vllm_runner(\n-        model_ref,\n-        load_format=\"tensorizer\",\n-        model_loader_extra_config=TensorizerConfig(tensorizer_uri=model_path,\n-                                                   num_readers=1,\n-                                                   vllm_tensorized=True),\n-    )\n-    deserialized_outputs = loaded_vllm_model.generate(prompts, sampling_params)\n-\n-    # Assumes SamplingParams being seeded ensures the outputs are deterministic\n-    assert outputs == deserialized_outputs\n-\n-\n @pytest.mark.skipif(not is_curl_installed(), reason=\"cURL is not installed\")\n def test_can_deserialize_s3(vllm_runner):\n     model_ref = \"EleutherAI/pythia-1.4b\"\n@@ -110,7 +76,6 @@ def test_can_deserialize_s3(vllm_runner):\n                                   model_loader_extra_config=TensorizerConfig(\n                                       tensorizer_uri=tensorized_path,\n                                       num_readers=1,\n-                                      vllm_tensorized=False,\n                                       s3_endpoint=\"object.ord1.coreweave.com\",\n                                   ))\n \n@@ -126,29 +91,26 @@ def test_deserialized_encrypted_vllm_model_has_same_outputs(\n     model_path = tmp_path / (model_ref + \".tensors\")\n     key_path = tmp_path / (model_ref + \".key\")\n     outputs = vllm_model.generate(prompts, sampling_params)\n-    model = (vllm_model.model.llm_engine.model_executor.driver_worker.\n-             model_runner.model)\n \n-    encryption_params = EncryptionParams.random()\n-    with open_stream(model_path, \"wb+\") as stream:\n-        serializer = TensorSerializer(stream, encryption=encryption_params)\n-        serializer.write_module(model)\n-    with open_stream(key_path, \"wb+\") as stream:\n-        stream.write(encryption_params.key)\n-    del vllm_model, model\n+    config_for_serializing = TensorizerConfig(tensorizer_uri=model_path)\n+    serialize_vllm_model(vllm_model.model.llm_engine,\n+                         config_for_serializing,\n+                         encryption_key_path=key_path)\n+\n+    del vllm_model\n     gc.collect()\n     torch.cuda.empty_cache()\n-    loaded_vllm_model = vllm_runner(model_ref,\n-                                    load_format=\"tensorizer\",\n-                                    model_loader_extra_config=TensorizerConfig(\n-                                        tensorizer_uri=model_path,\n-                                        encryption_keyfile=key_path,\n-                                        num_readers=1,\n-                                        vllm_tensorized=True))\n+\n+    config_for_deserializing = TensorizerConfig(tensorizer_uri=model_path,\n+                                                encryption_keyfile=key_path)\n+\n+    loaded_vllm_model = vllm_runner(\n+        model_ref,\n+        load_format=\"tensorizer\",\n+        model_loader_extra_config=config_for_deserializing)\n \n     deserialized_outputs = loaded_vllm_model.generate(prompts, sampling_params)\n \n-    # Assumes SamplingParams being seeded ensures the outputs are deterministic\n     assert outputs == deserialized_outputs\n \n \n@@ -169,7 +131,7 @@ def test_deserialized_hf_model_has_same_outputs(hf_runner, vllm_runner,\n                                   model_loader_extra_config=TensorizerConfig(\n                                       tensorizer_uri=model_path,\n                                       num_readers=1,\n-                                      vllm_tensorized=False))\n+                                  ))\n \n     deserialized_outputs = loaded_hf_model.generate_greedy(\n         prompts, max_tokens=max_tokens)\n@@ -190,12 +152,11 @@ def test_vllm_model_can_load_with_lora(vllm_runner, tmp_path):\n     # Serialize model before deserializing and binding LoRA adapters\n     vllm_model = vllm_runner(model_ref, )\n     model_path = tmp_path / (model_ref + \".tensors\")\n-    model = (vllm_model.model.llm_engine.model_executor.driver_worker.\n-             model_runner.model)\n-    with open_stream(model_path, \"wb+\") as stream:\n-        serializer = TensorSerializer(stream)\n-        serializer.write_module(model)\n-    del vllm_model, model\n+\n+    serialize_vllm_model(vllm_model.model.llm_engine,\n+                         TensorizerConfig(tensorizer_uri=model_path))\n+\n+    del vllm_model\n     gc.collect()\n     torch.cuda.empty_cache()\n     loaded_vllm_model = vllm_runner(\n@@ -204,7 +165,6 @@ def test_vllm_model_can_load_with_lora(vllm_runner, tmp_path):\n         model_loader_extra_config=TensorizerConfig(\n             tensorizer_uri=model_path,\n             num_readers=1,\n-            vllm_tensorized=True,\n         ),\n         enable_lora=True,\n         max_loras=1,\n@@ -220,58 +180,28 @@ def test_vllm_model_can_load_with_lora(vllm_runner, tmp_path):\n \n def test_load_without_tensorizer_load_format(vllm_runner):\n     with pytest.raises(ValueError):\n-        vllm_runner(model_ref,\n-                    model_loader_extra_config=TensorizerConfig(\n-                        tensorizer_uri=\"test\", vllm_tensorized=False))\n-\n-\n-@pytest.mark.skipif(not is_curl_installed(), reason=\"cURL is not installed\")\n-def test_tensorize_vllm_model(tmp_path):\n-    # Test serialize command\n-    serialize_args = [\n-        \"python3\", tensorize_model_for_testing_script, \"--model\", model_ref,\n-        \"--dtype\", \"float16\", \"serialize\", \"--serialized-directory\", tmp_path,\n-        \"--suffix\", \"tests\"\n-    ]\n-    result = subprocess.run(serialize_args, capture_output=True, text=True)\n-    print(result.stdout)  # Print the output of the serialize command\n-\n-    assert result.returncode == 0, (f\"Serialize command failed with output:\"\n-                                    f\"\\n{result.stdout}\\n{result.stderr}\")\n-\n-    path_to_tensors = f\"{tmp_path}/vllm/{model_ref}/tests/model.tensors\"\n-\n-    # Test deserialize command\n-    deserialize_args = [\n-        \"python3\", tensorize_model_for_testing_script, \"--model\", model_ref,\n-        \"--dtype\", \"float16\", \"deserialize\", \"--path-to-tensors\",\n-        path_to_tensors\n-    ]\n-    result = subprocess.run(deserialize_args, capture_output=True, text=True)\n-    assert result.returncode == 0, (f\"Deserialize command failed with output:\"\n-                                    f\"\\n{result.stdout}\\n{result.stderr}\")\n+        vllm_runner(\n+            model_ref,\n+            model_loader_extra_config=TensorizerConfig(tensorizer_uri=\"test\"))\n \n \n @pytest.mark.skipif(not is_curl_installed(), reason=\"cURL is not installed\")\n-def test_openai_apiserver_with_tensorizer(tmp_path):\n+def test_openai_apiserver_with_tensorizer(vllm_runner, tmp_path):\n     ## Serialize model\n-    serialize_args = [\n-        \"python3\", tensorize_model_for_testing_script, \"--model\", model_ref,\n-        \"--dtype\", \"float16\", \"serialize\", \"--serialized-directory\", tmp_path,\n-        \"--suffix\", \"tests\"\n-    ]\n-    result = subprocess.run(serialize_args, capture_output=True, text=True)\n-    print(result.stdout)  # Print the output of the serialize command\n+    vllm_model = vllm_runner(model_ref, )\n+    model_path = tmp_path / (model_ref + \".tensors\")\n \n-    assert result.returncode == 0, (f\"Serialize command failed with output:\"\n-                                    f\"\\n{result.stdout}\\n{result.stderr}\")\n+    serialize_vllm_model(vllm_model.model.llm_engine,\n+                         TensorizerConfig(tensorizer_uri=model_path))\n \n-    path_to_tensors = f\"{tmp_path}/vllm/{model_ref}/tests/model.tensors\"\n     model_loader_extra_config = {\n-        \"tensorizer_uri\": path_to_tensors,\n-        \"vllm_tensorized\": True\n+        \"tensorizer_uri\": str(model_path),\n     }\n \n+    del vllm_model\n+    gc.collect()\n+    torch.cuda.empty_cache()\n+\n     ## Start OpenAI API server\n     openai_args = [\n         \"--model\", model_ref, \"--dtype\", \"float16\", \"--load-format\",\n@@ -304,10 +234,10 @@ def test_openai_apiserver_with_tensorizer(tmp_path):\n \n def test_raise_value_error_on_invalid_load_format(vllm_runner):\n     with pytest.raises(ValueError):\n-        vllm_runner(model_ref,\n-                    load_format=\"safetensors\",\n-                    model_loader_extra_config=TensorizerConfig(\n-                        tensorizer_uri=\"test\", vllm_tensorized=False))\n+        vllm_runner(\n+            model_ref,\n+            load_format=\"safetensors\",\n+            model_loader_extra_config=TensorizerConfig(tensorizer_uri=\"test\"))\n \n \n def test_tensorizer_with_tp(vllm_runner):\n@@ -321,8 +251,29 @@ def test_tensorizer_with_tp(vllm_runner):\n             model_loader_extra_config=TensorizerConfig(\n                 tensorizer_uri=tensorized_path,\n                 num_readers=1,\n-                vllm_tensorized=False,\n                 s3_endpoint=\"object.ord1.coreweave.com\",\n             ),\n             tensor_parallel_size=2,\n         )\n+\n+\n+def test_vllm_tensorized_model_has_same_outputs(vllm_runner, tmp_path):\n+    model_ref = \"facebook/opt-125m\"\n+    model_path = tmp_path / (model_ref + \".tensors\")\n+    config = TensorizerConfig(tensorizer_uri=str(model_path))\n+\n+    vllm_model = vllm_runner(model_ref)\n+    outputs = vllm_model.generate(prompts, sampling_params)\n+    serialize_vllm_model(vllm_model.model.llm_engine, config)\n+\n+    assert is_vllm_tensorized(config)\n+    del vllm_model\n+    gc.collect()\n+    torch.cuda.empty_cache()\n+\n+    loaded_vllm_model = vllm_runner(model_ref,\n+                                    load_format=\"tensorizer\",\n+                                    model_loader_extra_config=config)\n+    deserialized_outputs = loaded_vllm_model.generate(prompts, sampling_params)\n+\n+    assert outputs == deserialized_outputs\ndiff --git a/vllm/engine/arg_utils.py b/vllm/engine/arg_utils.py\nindex 163723b4b..fd5338c46 100644\n--- a/vllm/engine/arg_utils.py\n+++ b/vllm/engine/arg_utils.py\n@@ -167,8 +167,8 @@ class EngineArgs:\n             '* \"dummy\" will initialize the weights with random values, '\n             'which is mainly for profiling.\\n'\n             '* \"tensorizer\" will load the weights using tensorizer from '\n-            'CoreWeave which assumes tensorizer_uri is set to the location of '\n-            'the serialized weights.')\n+            'CoreWeave. See the Tensorize vLLM Model script in the Examples'\n+            'section for more information.\\n')\n         parser.add_argument(\n             '--dtype',\n             type=str,\ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex 91cc8f3be..68d8a074d 100644\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -145,7 +145,7 @@ environment_variables: Dict[str, Callable[[], Any]] = {\n \n     # S3 access information, used for tensorizer to load model from S3\n     \"S3_ACCESS_KEY_ID\":\n-    lambda: os.environ.get(\"S3_ACCESS_KEY\", None),\n+    lambda: os.environ.get(\"S3_ACCESS_KEY_ID\", None),\n     \"S3_SECRET_ACCESS_KEY\":\n     lambda: os.environ.get(\"S3_SECRET_ACCESS_KEY\", None),\n     \"S3_ENDPOINT_URL\":\ndiff --git a/vllm/model_executor/model_loader/loader.py b/vllm/model_executor/model_loader/loader.py\nindex fc9c8aa0a..b14824a35 100644\n--- a/vllm/model_executor/model_loader/loader.py\n+++ b/vllm/model_executor/model_loader/loader.py\n@@ -17,7 +17,7 @@ from vllm.logger import init_logger\n from vllm.model_executor.layers.quantization.base_config import (\n     QuantizationConfig)\n from vllm.model_executor.model_loader.tensorizer import (\n-    TensorizerConfig, is_vllm_serialized_tensorizer, load_with_tensorizer,\n+    TensorizerConfig, is_vllm_tensorized, load_with_tensorizer,\n     tensorizer_weights_iterator)\n from vllm.model_executor.model_loader.utils import (get_model_architecture,\n                                                     set_default_torch_dtype)\n@@ -291,7 +291,7 @@ class TensorizerLoader(BaseModelLoader):\n         tensorizer_args = self.tensorizer_config._construct_tensorizer_args()\n         return tensorizer_weights_iterator(tensorizer_args)\n \n-    def _load_model_unserialized(\n+    def _load_model_serialized_cpu(\n         self,\n         model_config: ModelConfig,\n         device_config: DeviceConfig,\n@@ -299,11 +299,12 @@ class TensorizerLoader(BaseModelLoader):\n         vision_language_config: Optional[VisionLanguageConfig],\n         cache_config: CacheConfig,\n     ) -> nn.Module:\n-        \"\"\"Load an unserialized model with tensorizer.\n+        \"\"\"Load a serialized model with tensorizer to the CPU.\n \n-        Unserialized here means \"not serialized with tensorizer\". This\n-        should still be faster than default HuggingFace loading, but will\n-        be slower than loading a tensorizer-serialized model.\n+        This is only necessary when the model isn't vLLM-tensorized (see\n+        examples/tensorize_vllm_model.py) This should still be faster than\n+        default HuggingFace loading, but will be slower than loading a\n+        vLLM-tensorized model.\n         \"\"\"\n         with set_default_torch_dtype(model_config.dtype):\n             with torch.device(device_config.device):\n@@ -324,8 +325,9 @@ class TensorizerLoader(BaseModelLoader):\n     ) -> nn.Module:\n         \"\"\"Load a serialized model with tensorizer.\n \n-        See the examples/tensorize_vllm_model.py example \"\n-        script for serializing vLLM models.\"\"\"\n+        Expects a vLLM-tensorized model. See the\n+        examples/tensorize_vllm_model.py example script\n+        for serializing vLLM models.\"\"\"\n         with set_default_torch_dtype(model_config.dtype):\n             with torch.device(device_config.device):\n                 model_class = get_model_architecture(model_config)[0]\n@@ -353,15 +355,15 @@ class TensorizerLoader(BaseModelLoader):\n                    cache_config: CacheConfig) -> nn.Module:\n         self._verify_config(model_config, parallel_config)\n \n-        if is_vllm_serialized_tensorizer(self.tensorizer_config):\n+        if is_vllm_tensorized(self.tensorizer_config):\n             return self._load_model_serialized(model_config, device_config,\n                                                lora_config,\n                                                vision_language_config,\n                                                cache_config)\n-        return self._load_model_unserialized(model_config, device_config,\n-                                             lora_config,\n-                                             vision_language_config,\n-                                             cache_config)\n+        return self._load_model_serialized_cpu(model_config, device_config,\n+                                               lora_config,\n+                                               vision_language_config,\n+                                               cache_config)\n \n \n def get_model_loader(load_config: LoadConfig) -> BaseModelLoader:\ndiff --git a/vllm/model_executor/model_loader/tensorizer.py b/vllm/model_executor/model_loader/tensorizer.py\nindex 219a2a392..2cf4ce5f8 100644\n--- a/vllm/model_executor/model_loader/tensorizer.py\n+++ b/vllm/model_executor/model_loader/tensorizer.py\n@@ -5,6 +5,7 @@ import os\n import time\n import typing\n from dataclasses import dataclass\n+from functools import partial\n from typing import Generator, Optional, Tuple, Type, Union\n \n import torch\n@@ -13,6 +14,7 @@ from transformers import PretrainedConfig\n \n import vllm.envs as envs\n from vllm.config import ModelConfig, ParallelConfig\n+from vllm.engine.llm_engine import LLMEngine\n from vllm.logger import init_logger\n from vllm.model_executor.layers.quantization.base_config import (\n     QuantizationConfig)\n@@ -27,6 +29,11 @@ try:\n     from tensorizer.stream_io import open_stream\n     from tensorizer.utils import (convert_bytes, get_mem_usage,\n                                   no_init_or_tensor)\n+\n+    _read_stream, _write_stream = (partial(\n+        open_stream,\n+        mode=mode,\n+    ) for mode in (\"rb\", \"wb+\"))\n except ImportError as e:\n     tensorizer_error_msg = str(e)\n \n@@ -43,7 +50,7 @@ logger = init_logger(__name__)\n class TensorizerConfig:\n     tensorizer_uri: Union[io.BufferedIOBase, io.RawIOBase, typing.BinaryIO,\n                           str, bytes, os.PathLike, int]\n-    vllm_tensorized: bool\n+    vllm_tensorized: Optional[bool] = False\n     verify_hash: Optional[bool] = False\n     num_readers: Optional[int] = None\n     encryption_keyfile: Optional[str] = None\n@@ -93,17 +100,11 @@ def load_with_tensorizer(tensorizer_config: TensorizerConfig,\n     return tensorizer.deserialize()\n \n \n-def is_vllm_serialized_tensorizer(tensorizer_config: TensorizerConfig) -> bool:\n-    if tensorizer_config is None:\n-        return False\n-    return tensorizer_config.vllm_tensorized\n-\n-\n @dataclass\n class TensorizerArgs:\n     tensorizer_uri: Union[io.BufferedIOBase, io.RawIOBase, typing.BinaryIO,\n                           str, bytes, os.PathLike, int]\n-    vllm_tensorized: bool\n+    vllm_tensorized: Optional[bool] = False\n     verify_hash: Optional[bool] = False\n     num_readers: Optional[int] = None\n     encryption_keyfile: Optional[str] = None\n@@ -121,7 +122,9 @@ class TensorizerArgs:\n           vLLM model. This is used to determine the behavior of the \n           TensorDeserializer when loading tensors from a serialized model.\n           It is far faster to deserialize a vLLM model as it utilizes\n-          tensorizer's optimized GPU loading.\n+          tensorizer's optimized GPU loading. Note that this is now\n+          deprecated, as serialized vLLM models are now automatically\n+          inferred as vLLM models.\n       verify_hash: If True, the hashes of each tensor will be verified against \n           the hashes stored in the metadata. A `HashMismatchError` will be \n           raised if any of the hashes do not match.\n@@ -158,6 +161,7 @@ class TensorizerArgs:\n             \"encryption\": self.encryption_keyfile,\n             \"num_readers\": self.num_readers\n         }\n+\n         if self.encryption_keyfile:\n             with open_stream(\n                     self.encryption_keyfile,\n@@ -177,7 +181,14 @@ class TensorizerArgs:\n             'tensorizer options',\n             description=('Options for configuring the behavior of the'\n                          ' tensorizer deserializer when '\n-                         '--load-format=tensorizer'))\n+                         'load_format=tensorizer is specified when '\n+                         'initializing an LLMEngine, either via the CLI '\n+                         'when running the vLLM OpenAI inference server '\n+                         'with a JSON string passed to '\n+                         '--model-loader-extra-config or as arguments given '\n+                         'to TensorizerConfig when passed to '\n+                         'model_loader_extra_config in the constructor '\n+                         'for LLMEngine.'))\n \n         group.add_argument(\n             \"--tensorizer-uri\",\n@@ -222,13 +233,6 @@ class TensorizerArgs:\n             help=\"The endpoint for the S3 bucket. Can also be set via the \"\n             \"S3_ENDPOINT_URL environment variable.\",\n         )\n-        group.add_argument(\n-            \"--vllm-tensorized\",\n-            action=\"store_true\",\n-            help=\"If enabled, indicates that the serialized model is a vLLM \"\n-            \"model. This is used to determine the behavior of the \"\n-            \"TensorDeserializer when loading tensors from a \"\n-            \"serialized model.\")\n \n         return parser\n \n@@ -322,10 +326,9 @@ class TensorizerAgent:\n         \"\"\"\n         before_mem = get_mem_usage()\n         start = time.perf_counter()\n-        with open_stream(\n-                self.tensorizer_args.tensorizer_uri,\n-                mode=\"rb\",\n-                **self.tensorizer_args.stream_params,\n+        with _read_stream(\n+                self.tensorizer_config.tensorizer_uri,\n+                **self.tensorizer_args.stream_params\n         ) as stream, TensorDeserializer(\n                 stream,\n                 dtype=self.tensorizer_config.dtype,\n@@ -345,6 +348,7 @@ class TensorizerAgent:\n \n         self._check_tensors_on_meta_device()\n         self._resize_lora_embeddings()\n+        del self.model.vllm_tensorized_marker\n         return self.model.eval()\n \n \n@@ -366,3 +370,63 @@ def tensorizer_weights_iterator(\n         for name, param in state.items():\n             yield name, param\n     del state\n+\n+\n+def is_vllm_tensorized(tensorizer_config: \"TensorizerConfig\") -> bool:\n+    \"\"\"\n+    Infer if the model is a vLLM model by checking the weights for\n+    a vLLM tensorized marker.\n+\n+    Args:\n+        tensorizer_config: The TensorizerConfig object containing the\n+            tensorizer_uri to the serialized model.\n+\n+    Returns:\n+        bool: True if the model is a vLLM model, False otherwise.\n+    \"\"\"\n+    tensorizer_args = tensorizer_config._construct_tensorizer_args()\n+    deserializer = TensorDeserializer(open_stream(\n+        tensorizer_args.tensorizer_uri, **tensorizer_args.stream_params),\n+                                      **tensorizer_args.deserializer_params,\n+                                      lazy_load=True)\n+    if tensorizer_config.vllm_tensorized:\n+        logger.warning(\n+            \"Please note that newly serialized vLLM models are automatically \"\n+            \"inferred as vLLM models, so setting vllm_tensorized=True is \"\n+            \"only necessary for models serialized prior to this change.\")\n+        return True\n+    if (\".vllm_tensorized_marker\" in deserializer):\n+        return True\n+    return False\n+\n+\n+def get_pretensorized_vllm_model(engine: \"LLMEngine\") -> nn.Module:\n+    model = (engine.model_executor.driver_worker.model_runner.model)\n+    model.register_parameter(\n+        \"vllm_tensorized_marker\",\n+        nn.Parameter(torch.tensor((1, ), device=\"meta\"), requires_grad=False))\n+    return model\n+\n+\n+def serialize_vllm_model(engine: \"LLMEngine\",\n+                         tensorizer_config : TensorizerConfig,\n+                         encryption_key_path: Optional[str] = None) \\\n+        -> nn.Module:\n+\n+    model = get_pretensorized_vllm_model(engine)\n+    tensorizer_args = tensorizer_config._construct_tensorizer_args()\n+    encryption_params = None\n+    if encryption_key_path is not None:\n+        encryption_params = EncryptionParams.random()\n+        with _write_stream(encryption_key_path,\n+                           **tensorizer_args.stream_params) as stream:\n+            stream.write(encryption_params.key)\n+\n+    with _write_stream(tensorizer_args.tensorizer_uri,\n+                       **tensorizer_args.stream_params) as stream:\n+        serializer = TensorSerializer(stream, encryption=encryption_params)\n+        serializer.write_module(model)\n+        serializer.close()\n+    logger.info(\"Successfully serialized model to %s\",\n+                str(tensorizer_args.tensorizer_uri))\n+    return model", "apis": ["vllm.LLM", "vllm.model_executor.model_loader.tensorizer.TensorizerConfig", "vllm.model_executor.model_loader.tensorizer.serialize_vllm_model", "vllm.model_executor.model_loader.tensorizer.is_vllm_tensorized"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/others/tensorize_vllm_model.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/model_loader/tensorizer.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit significantly revises the model serialization/deserialization workflow by introducing automatic detection of vLLM-tensorized models and consolidates the behavior into the tensorizer API. The changes are made in non-test files (e.g., examples, core model loaders, environment configuration) and modify performanceâ€critical code paths related to model loading on the CPU. Although the commit message includes â€œperf:â€ and the word â€œoptimizeâ€ isnâ€™t directly in the code, the alterations (like updating function names to reflect serialized CPU loading vs. unserialized loading and removing legacy flags) indicate an intent to improve the performance of model loading. The changes go beyond simple refactoring or bug fixes; they alter the internal API to streamline operations that are performance sensitive, while the modifications remain testable on CPU.", "llm_api_reason": "This commit mostly updates the tensorizer integration and its usage in serialization/deserialization of vLLM models. The changes update the example script and tests to automatically detect vLLMâ€tensorized models (removing manual flags), adjust CLI instructions, and update help messages. In addition, the commit replaces the old â€œis_vllm_serialized_tensorizerâ€ check with a new â€œis_vllm_tensorizedâ€ function and refactors the serialization helper to automatically add the tensorized marker. These updates affect core model loading via LLM and tensorizer configuration and serialization APIs."}
{"commit_hash": "379da6dcb5f5d062d0452b2fc23291e5113dcf04", "pr_url": "https://github.com/vllm-project/vllm/pull/4691", "pr_date": "2024-05-08", "timeline_text": "Copy link Collaborator pcmoritz commented May 8, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This PR improves the FP8 performance of linear layers, which had been lacking before ( #4118 (comment) and #4118 (comment) ). We noticed that CUBLASLt can find a better algorithm if the first dimension of the matrix is at least 16. So this PR enlarges matrices appropriately during quantization. This improves FP8 performance and removes the performance regression vs. FP16, in many cases exceeding FP16 performance. Here are benchmarks on llama3 70b (ITL numbers for 1000 input and 50 output tokens at fixed qps and at TP 4), all FP8 measurements are for dynamic quantization: qps = 1: 24 ms (FP8, this PR), 32 ms (FP8, previous main), 26 ms (FP16)\nqps = 2: 26 ms (FP8, this PR), 34ms (FP8, previous main), 28 ms (FP16) \nqps = 4: 33 ms (FP8, this PR), 44 ms (FP8, previous main), 36 ms (FP16)\nqps = 6: 46 ms (FP8, this PR), 56 ms (FP8, previous main), 54 ms (FP16)\nqps = 8: 85 ms (FP8, this PR), 85 ms (FP8, previous main), 138 ms (FP16) PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 3 comaniac, AnyISalIn, and mgoin reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions pcmoritz added 9 commits May 8, 2024 13:04 Initial commit d6b8e14 fix 3b77b56 adapt fp8 matmul code to use batch_dim_padding 5a0f28b Merge branch 'fp8-gemm-performance' of github.com:pcmoritz/vllm-publiâ€¦ â€¦ 91f544f â€¦c into fp8-gemm-performance add docstring b435641 format 6178aa3 yapf 99ef55f comments 8373dad format be94800 pcmoritz requested review from comaniac and robertgshaw2-redhat May 8, 2024 21:45 tlrmchlsmth approved these changes May 8, 2024 View reviewed changes vllm/model_executor/layers/quantization/fp8.py Outdated Comment on lines 236 to 240 batch_dim_padding=32) # Fused GEMM_DQ # Fused GEMM_DQ -- note we padded the input above because # torch._scaled_mm is more performant for matrices with # batch dimension at least 32. Copy link Collaborator tlrmchlsmth May 8, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment What is the perf effect when padding to 32 vs 16? (I ask because here it's 32 and in the PR description it's 16) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author pcmoritz May 8, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment So when I write my own wrappers for CUBLASLt, I'm getting the following error when calling the cublasLtMatmulAlgoGetHeuristic with FP8: [2024-05-08 19:00:00][cublasLt][1533][Info][cublasLtMatmulAlgoGetHeuristic] Unsupported M dimension for FP8 matrix multiplication. M must be divisible by 16. Got 2. (this is with highest logging CUBLASLT_LOG_LEVEL=5 ) -- that's why I wrote 16 in the description. For the setting we are using however, 32 is actually the best setting -- I tried them both and with 16 it is much closer to what it was previously. It is however possible that this will change in the future (e.g. once we use FP8 outputs I think things will change). Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 tlrmchlsmth reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator Author pcmoritz May 8, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I clarified this in the description now -- I wrote 16 since I didn't want to bias people for the future :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 3 tlrmchlsmth, mgoin, and comaniac reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions Copy link Contributor courage17340 May 9, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Hello, I have two questions: I never saw the M must be divisible by 16 error when testing cublasLt. In fact, I can perform 1 x 1024 x 16 matmul with torch._scaled_mm . But it seems that there are some constraints on N, cublasLt requires N % 8 == 0 , while torch requires N % 16 == 0 . I guess your error is also on N, because cublasLt api is col major and we pass N as M to it when using row major tensors. In my experiment, matmul is slower when M is in range [1, 16], and is faster in range [17, 32], so maybe 17 is a better choice instead of 32? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author pcmoritz May 9, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the suggestion, let me try if 17 is better than 32 :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author pcmoritz May 9, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I found the performance of 17 to be exactly the same as the performance of 32 , so I'll switch to 17 since it uses less memory. Thanks for the suggestion @courage17340 :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions robertgshaw2-redhat approved these changes May 8, 2024 View reviewed changes Copy link Collaborator robertgshaw2-redhat commented May 8, 2024 kinda wild - I suspect we will be able to improve performance significantly with our kernels All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat enabled auto-merge (squash) May 8, 2024 22:18 mgoin approved these changes May 8, 2024 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This makes sense! :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions comaniac approved these changes May 9, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Great! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions pcmoritz added 5 commits May 8, 2024 18:27 rerun ci 6b87e6f rerun ci 6a4e533 rerun ci af7b9f7 rerun ci 4cc1991 Merge branch 'main' into fp8-gemm-performance 3462ba7 pcmoritz disabled auto-merge May 9, 2024 20:26 pcmoritz added 2 commits May 9, 2024 13:47 use 17 instead of 32 9bafda5 rerun ci 3439917 pcmoritz merged commit 379da6d into vllm-project : main May 9, 2024 robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request May 19, 2024 [Kernel] [FP8] Improve FP8 linear layer performance ( vllm-project#4691 ) â€¦ 56c100c This PR improves the FP8 performance of linear layers, which had been lacking before ( vllm-project#4118 (comment) and vllm-project#4118 (comment)).\n\nWe noticed that CUBLASLt can find a better algorithm if the first dimension of the matrix is greater than 16. So this PR enlarges matrices appropriately during quantization. This improves FP8 performance and removes the performance regression vs. FP16, in many cases exceeding FP16 performance.\n\nHere are benchmarks on llama3 70b (ITL numbers for 1000 input and 50 output tokens at fixed qps and at TP 4), all FP8 measurements are for dynamic quantization:\n\nqps = 1: 24 ms (FP8, this PR), 32 ms (FP8, previous main), 26 ms (FP16)\nqps = 2: 26 ms (FP8, this PR), 34ms (FP8, previous main), 28 ms (FP16) \nqps = 4: 33 ms (FP8, this PR), 44 ms (FP8, previous main), 36 ms (FP16)\nqps = 6: 46 ms (FP8, this PR), 56 ms (FP8, previous main), 54 ms (FP16)\nqps = 8: 85 ms (FP8, this PR), 85 ms (FP8, previous main), 138 ms (FP16) dtrifiro pushed a commit\n        to dtrifiro/vllm\n      that referenced\n      this pull request May 21, 2024 [Kernel] [FP8] Improve FP8 linear layer performance ( vllm-project#4691 ) â€¦ d7e6b3f This PR improves the FP8 performance of linear layers, which had been lacking before ( vllm-project#4118 (comment) and vllm-project#4118 (comment)).\n\nWe noticed that CUBLASLt can find a better algorithm if the first dimension of the matrix is greater than 16. So this PR enlarges matrices appropriately during quantization. This improves FP8 performance and removes the performance regression vs. FP16, in many cases exceeding FP16 performance.\n\nHere are benchmarks on llama3 70b (ITL numbers for 1000 input and 50 output tokens at fixed qps and at TP 4), all FP8 measurements are for dynamic quantization:\n\nqps = 1: 24 ms (FP8, this PR), 32 ms (FP8, previous main), 26 ms (FP16)\nqps = 2: 26 ms (FP8, this PR), 34ms (FP8, previous main), 28 ms (FP16) \nqps = 4: 33 ms (FP8, this PR), 44 ms (FP8, previous main), 36 ms (FP16)\nqps = 6: 46 ms (FP8, this PR), 56 ms (FP8, previous main), 54 ms (FP16)\nqps = 8: 85 ms (FP8, this PR), 85 ms (FP8, previous main), 138 ms (FP16) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:48:57", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: qps, qps, qps | SERVING: API server, OpenAI API server, Frontend | TEST: test, testing, CI", "analysis_extracted_at": "2025-09-07 17:48:57", "models": ["meta-llama/Meta-Llama-3-70B"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Meta-Llama-3-70B,tensor_parallel_size=4,quantization=fp8 --tasks lambada_openai --batch_size auto"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Meta-Llama-3-70B --input-len 1000 --output-len 50 --tensor-parallel-size 4 --quantization fp8", "commit_subject": "[Kernel] [FP8] Improve FP8 linear layer performance (#4691)", "commit_message": "[Kernel] [FP8] Improve FP8 linear layer performance (#4691)\n\nThis PR improves the FP8 performance of linear layers, which had been lacking before (#4118 (comment) and #4118 (comment)).\n\nWe noticed that CUBLASLt can find a better algorithm if the first dimension of the matrix is greater than 16. So this PR enlarges matrices appropriately during quantization. This improves FP8 performance and removes the performance regression vs. FP16, in many cases exceeding FP16 performance.\n\nHere are benchmarks on llama3 70b (ITL numbers for 1000 input and 50 output tokens at fixed qps and at TP 4), all FP8 measurements are for dynamic quantization:\n\nqps = 1: 24 ms (FP8, this PR), 32 ms (FP8, previous main), 26 ms (FP16)\nqps = 2: 26 ms (FP8, this PR), 34ms (FP8, previous main), 28 ms (FP16) \nqps = 4: 33 ms (FP8, this PR), 44 ms (FP8, previous main), 36 ms (FP16)\nqps = 6: 46 ms (FP8, this PR), 56 ms (FP8, previous main), 54 ms (FP16)\nqps = 8: 85 ms (FP8, this PR), 85 ms (FP8, previous main), 138 ms (FP16)", "commit_date": "2024-05-09T16:38:07-07:00", "files_changed": ["vllm/_custom_ops.py", "vllm/model_executor/layers/quantization/fp8.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 3, "num_edited_lines": 41, "num_non_test_edited_lines": 41, "commit_year": 2024}, "diff_text": "diff --git a/vllm/_custom_ops.py b/vllm/_custom_ops.py\nindex 5b5643748..829c47003 100644\n--- a/vllm/_custom_ops.py\n+++ b/vllm/_custom_ops.py\n@@ -189,8 +189,34 @@ def gptq_marlin_gemm(a: torch.Tensor, b_q_weight: torch.Tensor,\n def scaled_fp8_quant(\n     input: torch.Tensor,\n     scale: Optional[torch.Tensor] = None,\n+    batch_dim_padding: Optional[int] = None,\n ) -> Tuple[torch.Tensor, torch.Tensor]:\n-    output = torch.empty_like(input, dtype=torch.float8_e4m3fn)\n+    \"\"\"\n+    Quantize input tensor to FP8 and return quantized tensor and scale.\n+\n+    This function supports both static and dynamic quantization: If you\n+    provide the scale, it will use static scaling and if you omit it,\n+    the scale will be determined dynamically. The function also allows\n+    optional padding of the output tensor for downstream kernels that\n+    will benefit from padding.\n+\n+    Args:\n+        input: The input tensor to be quantized to FP8\n+        scale: Optional scaling factor for the FP8 quantization\n+        batch_dim_padding: If specified, pad the first dimension\n+            of the output to at least this value.\n+\n+    Returns:\n+        Tuple[torch.Tensor, torch.Tensor]: The output tensor in FP8 and\n+            scaling factor.\n+    \"\"\"\n+    if batch_dim_padding:\n+        shape = (max(batch_dim_padding, input.shape[0]), *input.shape[1:])\n+        output = torch.empty(shape,\n+                             device=input.device,\n+                             dtype=torch.float8_e4m3fn)\n+    else:\n+        output = torch.empty_like(input, dtype=torch.float8_e4m3fn)\n     if scale is None:\n         scale = torch.zeros(1, device=input.device, dtype=torch.float32)\n         vllm_ops.dynamic_scaled_fp8_quant(output, input, scale)\ndiff --git a/vllm/model_executor/layers/quantization/fp8.py b/vllm/model_executor/layers/quantization/fp8.py\nindex b57e1dde8..ff996741c 100644\n--- a/vllm/model_executor/layers/quantization/fp8.py\n+++ b/vllm/model_executor/layers/quantization/fp8.py\n@@ -231,9 +231,14 @@ class Fp8LinearMethod(LinearMethodBase):\n         # ops.scaled_fp8_quant supports both dynamic and static quant.\n         #   If dynamic, layer.act_scale is None and x_scale computed from x.\n         #   If static,  layer.act_scale is scalar and x_scale set to act_scale.\n-        qinput, x_scale = ops.scaled_fp8_quant(x, layer.act_scale)\n-\n-        # Fused GEMM_DQ\n+        qinput, x_scale = ops.scaled_fp8_quant(x,\n+                                               layer.act_scale,\n+                                               batch_dim_padding=17)\n+\n+        # Fused GEMM_DQ -- note we padded the input above because\n+        # torch._scaled_mm is more performant for matrices with\n+        # batch dimension > 16. Note that this could change\n+        # in the future.\n         output, _ = torch._scaled_mm(\n             qinput,\n             layer.weight,\n@@ -243,7 +248,7 @@ class Fp8LinearMethod(LinearMethodBase):\n             bias=bias,\n         )\n \n-        return output\n+        return torch.narrow(output, 0, 0, x.shape[0])\n \n \n def all_close_1d(x: torch.Tensor) -> bool:", "apis": ["vllm._custom_ops.scaled_fp8_quant", "vllm.model_executor.layers.quantization.fp8.Fp8LinearMethod.apply"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/fp8.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/_custom_ops.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/linear.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies two source files (vllm/_custom_ops.py and vllm/model_executor/layers/quantization/fp8.py), both of which are non-test files. The modifications introduce a new parameter (batch_dim_padding) to pad the input matrix's first dimension during FP8 quantization, thereby enabling a more efficient GEMM_DQ operation via torch._scaled_mm when the first dimension exceeds 16. The commit message clearly explains that this change is targeted at performance improvement, specifically enhancing FP8 linear layer performance by optimizing matrix dimension padding. There is no indication that the change is merely a bug fix, refactoring, or addition of a new feature; it is directly focused on performance optimization that is testable on CPU.", "llm_api_reason": "The commit adds a new optional parameter, \"batch_dim_padding\", to the FP8 quantization function in the custom ops module. When provided, this parameter causes the output tensor to be padded along the batch (first) dimension so that its size is at least the given value. In the FP8 linear method (Fp8LinearMethod.apply), the call to the scaled FP8 quantization function is updated to include a fixed padding value (17) to improve performance by aligning the matrixâ€™s batch dimension to a size where CUBLASLt can select a better algorithm. Finally, the output of the matrix multiply is narrowed to remove the padded rows so that it matches the original input size. These changes affect the FP8 quantization API and the FP8 linear layerâ€™s apply method."}
{"commit_hash": "d7740ea4dcee4ab75d7d6eef723f33cae957b288", "pr_url": "https://github.com/vllm-project/vllm/pull/4594", "pr_date": null, "timeline_text": "Copy link Collaborator rkooo567 commented May 4, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . get_logprobs happen after sampling, which is the point where GPU <> CPU sync happens. It means overhead from get_logprobs are going to be applied to e2e overhead. I found get_logprobs is pretty inefficient at large batch size, which could be pretty common. On batch size 256, get_logprobs take about 5~6ms. This optimizes the get_logprobs. After this, I found the overhead becomes 2.1ms for get_logprobs. There are 2 optimizations Use non blocking device transfer and call it at the right timing where it can overlap with gpu ops Preselect indices and call tolist() instead of repetitively calling .item (which is much slower) Throughput benchmark (--input-len 256 --output-len 256)\nBefore: Throughput: 23.84 requests/s, 12208.54 tokens/s\nAfter: Throughput: 25.77 requests/s, 13196.11 tokens/s PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions rkooo567 added 4 commits May 3, 2024 20:49 working 30d6fe4 Merge branch 'main' into logprob-opt 65f9dde . 9205244 done 8ad363e rkooo567 changed the title [WIP] Optimize sampler get_logprobs [Core] Optimize sampler get_logprobs May 7, 2024 rkooo567 commented May 7, 2024 View reviewed changes vllm/model_executor/layers/sampler.py Outdated @@ -769,27 +769,24 @@ def _get_logprobs( selected_logprobs = logprobs[[ query_indices_gpu, next_token_ids_gpu, ]] ]] .to('cpu', non_blocking=True) Copy link Collaborator Author rkooo567 May 4, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment this can overlap device transfer with torch.topk Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions done 2177a7a Yard1 approved these changes May 7, 2024 View reviewed changes Copy link Collaborator Yard1 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 rkooo567 reacted with heart emoji All reactions â¤ï¸ 1 reaction Copy link Collaborator Author rkooo567 commented May 7, 2024 thanks for the quick review @Yard1 ! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . rkooo567 added 2 commits May 6, 2024 22:44 done d384dae . 2b2035a Qubitium reviewed May 7, 2024 View reviewed changes vllm/model_executor/layers/sampler.py Outdated # Find prompt/sample logprobs. prompt_logprobs_per_seq_group: List[Optional[PromptLogprobs]] = [] sample_logprobs_per_seq_group: List[SampleLogprobs] = [] top_logprob_idx = 0 selected_logprobs_idx = 0 # Make sure non-blocking .to(\"cpu\", non_blocking=True) is finished assert selected_logprobs.shape[0] == ranks.shape[0] Copy link Contributor Qubitium May 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @rkooo567 Do we still need this assert since non-blocking transfer code is removed? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author rkooo567 May 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for catching! we don't need comments, but assert is kind of still needed. Removed the comment Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 Qubitium reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction rkooo567 commented May 7, 2024 View reviewed changes Copy link Collaborator Author rkooo567 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Update; non_blocking=True for GPU -> CPU doesn't guarantee to synchronize when tolist() is called, so it is not safe. I used the blocking op instead. This decreases the perf improvement a bit (0.5~ish) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/sampler.py Outdated # Find prompt/sample logprobs. prompt_logprobs_per_seq_group: List[Optional[PromptLogprobs]] = [] sample_logprobs_per_seq_group: List[SampleLogprobs] = [] top_logprob_idx = 0 selected_logprobs_idx = 0 # Make sure non-blocking .to(\"cpu\", non_blocking=True) is finished assert selected_logprobs.shape[0] == ranks.shape[0] Copy link Collaborator Author rkooo567 May 7, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for catching! we don't need comments, but assert is kind of still needed. Removed the comment Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 Qubitium reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction done a964163 Yard1 reviewed May 7, 2024 View reviewed changes vllm/model_executor/layers/sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . . 88c0567 simon-mo merged commit d7740ea into vllm-project : main May 8, 2024 z103cb pushed a commit\n        to z103cb/opendatahub_vllm\n      that referenced\n      this pull request May 9, 2024 [Core] Optimize sampler get_logprobs ( vllm-project#4594 ) 4ae5247 Copy link davidthomas426 commented May 9, 2024 Update; non_blocking=True for GPU -> CPU doesn't guarantee to synchronize when tolist() is called, so it is not safe. I used the blocking op instead. This decreases the perf improvement a bit (0.5~ish) As an alternative, you could use a cuda stream for this and do a stream synchronize before the tolist, or just forget the separate cuda stream and just use a full torch cuda synchronize if that wouldn't create a performance issue. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request May 19, 2024 [Core] Optimize sampler get_logprobs ( vllm-project#4594 ) 43bc7e9 dtrifiro pushed a commit\n        to dtrifiro/vllm\n      that referenced\n      this pull request May 21, 2024 [Core] Optimize sampler get_logprobs ( vllm-project#4594 ) 9e4b2e2 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:00", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: Throughput, Throughput, Throughput | SERVING: API server, OpenAI API server, Frontend | TEST: test, CI, continuous integration", "analysis_extracted_at": "2025-09-07 17:49:00", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Core] Optimize sampler get_logprobs (#4594)", "commit_message": "[Core] Optimize sampler get_logprobs (#4594)", "commit_date": "2024-05-08T08:42:28-07:00", "files_changed": ["vllm/model_executor/layers/sampler.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 117, "num_non_test_edited_lines": 117, "commit_year": 2024}, "diff_text": "diff --git a/vllm/model_executor/layers/sampler.py b/vllm/model_executor/layers/sampler.py\nindex 1f19d2053..e52e350d2 100644\n--- a/vllm/model_executor/layers/sampler.py\n+++ b/vllm/model_executor/layers/sampler.py\n@@ -782,13 +782,14 @@ def _get_logprobs(\n         top_logprobs, top_token_ids = torch.topk(logprobs,\n                                                  largest_num_logprobs,\n                                                  dim=-1)\n-        top_logprobs = top_logprobs.cpu()\n-        top_token_ids = top_token_ids.cpu()\n     else:\n         top_logprobs, top_token_ids = None, None\n \n-    selected_logprobs = selected_logprobs.cpu()\n-    ranks = ranks.cpu()\n+    selected_logprobs = selected_logprobs.to('cpu')\n+    ranks = ranks.to('cpu')\n+    if top_logprobs is not None and top_token_ids is not None:\n+        top_logprobs = top_logprobs.to('cpu')\n+        top_token_ids = top_token_ids.to('cpu')\n \n     # Find prompt/sample logprobs.\n     prompt_logprobs_per_seq_group: List[Optional[PromptLogprobs]] = []\n@@ -828,37 +829,48 @@ def _get_prompt_logprob_if_needed(\n \n     # Find prompt logprobs\n     prompt_logprobs: Optional[PromptLogprobs] = None\n-    if (is_prompt and sampling_params.prompt_logprobs is not None):\n+    if is_prompt and sampling_params.prompt_logprobs is not None:\n         prompt_logprobs = []\n         num_logprobs = sampling_params.prompt_logprobs\n         next_prompt_tokens = _get_next_prompt_tokens(seq_group)\n-        for token_id in next_prompt_tokens:\n+        # Pre-select indexes and create a list. It is faster than calling .item\n+        # repetitively.\n+        selected_logprob_items = selected_logprobs[\n+            selected_logprobs_idx:selected_logprobs_idx +\n+            len(next_prompt_tokens)].tolist()\n+        rank_items = ranks[selected_logprobs_idx:selected_logprobs_idx +\n+                           len(next_prompt_tokens)].tolist()\n+\n+        for idx, token_id in enumerate(next_prompt_tokens):\n             # Calculate the prompt logprob of the real prompt tokens.\n-            # Use tuple here for performance (to use to_list()).\n             # {token_id: (logprob, rank_from_vocab)}\n             prompt_logprobs_dict: Dict[int, Tuple[float, int]] = {\n-                token_id: (selected_logprobs[selected_logprobs_idx].item(),\n-                           ranks[selected_logprobs_idx].item())\n+                token_id: (selected_logprob_items[idx], rank_items[idx])\n             }\n \n             # Add top K prompt logprobs along with its rank.\n             if num_logprobs > 0:\n-                prompt_logprobs_dict.update(\n-                    zip(\n-                        top_token_ids[top_logprob_idx, :num_logprobs].tolist(),\n-                        zip(\n-                            top_logprobs[\n-                                top_logprob_idx, :num_logprobs].tolist(),\n-                            # This is ranks. Since top_logprob is sorted,\n-                            # we can just use a range here.\n-                            range(1, num_logprobs + 1))))\n+                top_ids = top_token_ids[\n+                    top_logprob_idx, :num_logprobs].tolist()\n+                top_probs = top_logprobs[\n+                    top_logprob_idx, :num_logprobs].tolist()\n+                # Top K is already sorted by rank, so we can use 1 ~\n+                # num_logprobs + 1 for rank.\n+                top_ranks = range(1, num_logprobs + 1)\n+                prompt_logprobs_dict.update({\n+                    top_id: (top_prob, rank)\n+                    for top_id, top_prob, rank in zip(top_ids, top_probs,\n+                                                      top_ranks)\n+                })\n             prompt_logprobs.append({\n                 token_id: Logprob(*logprob_and_rank)\n                 for token_id, logprob_and_rank in prompt_logprobs_dict.items()\n             })\n             # + 1 to go to the next prompt token.\n             top_logprob_idx += 1\n-            selected_logprobs_idx += 1\n+\n+        # + len(next_prompt_tokens) to go to the next prompt.\n+        selected_logprobs_idx += len(next_prompt_tokens)\n     return prompt_logprobs, top_logprob_idx, selected_logprobs_idx\n \n \n@@ -874,47 +886,54 @@ def _get_sampled_logprob_if_needed(\n ):\n     \"\"\"Compute the sample logprob if needed.\"\"\"\n     seq_ids = seq_group.seq_ids\n-    num_logprobs = seq_group.sampling_params.logprobs\n-    if num_logprobs is None:\n-        num_logprobs = 0\n+    num_logprobs = seq_group.sampling_params.logprobs or 0\n     sampled_logprobs: SampleLogprobs = []\n     next_token_ids, parent_seq_ids = sample_result\n \n     if seq_group.do_sample:\n         assert len(next_token_ids) > 0\n-        for (next_token_id, parent_id) in zip(next_token_ids, parent_seq_ids):\n-            # Calculate the sample logprob of the real sampled tokens.\n-            # Use tuple here for performance (to use to_list()).\n-            # token_id: (logprob, rank_from_vocab)\n-            sampled_logprobs_dict: Dict[int, Tuple[float, int]] = {\n-                next_token_id:\n-                (selected_logprobs[selected_logprobs_idx].item(),\n-                 ranks[selected_logprobs_idx].item())\n+        # Pre-select items from tensor. tolist() is faster than repetitive\n+        # `.item()` calls.\n+        selected_logprob_items = selected_logprobs[\n+            selected_logprobs_idx:selected_logprobs_idx +\n+            len(next_token_ids)].tolist()\n+        rank_items = ranks[selected_logprobs_idx:selected_logprobs_idx +\n+                           len(next_token_ids)].tolist()\n+        for idx, (next_token_id,\n+                  parent_id) in enumerate(zip(next_token_ids, parent_seq_ids)):\n+            # Get the logprob of a sampled token.\n+            sampled_logprobs_dict = {\n+                next_token_id: (selected_logprob_items[idx], rank_items[idx])\n             }\n-            # +1 to go to the next sampled token. Note that\n-            # selected_logprobs can contain duplicates unlike top_logprobs\n-            # when beam search is enabled.\n-            selected_logprobs_idx += 1\n-\n-            # Second, add top K logprobs along with its rank.\n-            if num_logprobs >= 0:\n-                sampled_logprobs_dict.update(\n-                    zip(\n-                        top_token_ids[top_logprob_idx +\n-                                      parent_id, :num_logprobs].tolist(),\n-                        zip(\n-                            top_logprobs[top_logprob_idx +\n-                                         parent_id, :num_logprobs].tolist(),\n-                            # This is rank. Since top_logprob is sorted, we\n-                            # can just use a range here.\n-                            range(1, num_logprobs + 1))))\n+            # Get top K logprobs.\n+            if num_logprobs > 0:\n+                top_ids = top_token_ids[top_logprob_idx +\n+                                        parent_id, :num_logprobs].tolist()\n+                top_probs = top_logprobs[top_logprob_idx +\n+                                         parent_id, :num_logprobs].tolist()\n+                # Top K is already sorted by rank, so we can use 1 ~\n+                # num_logprobs + 1 for rank.\n+                top_ranks = range(1, num_logprobs + 1)\n+                sampled_logprobs_dict.update({\n+                    top_id: (top_prob, rank)\n+                    for top_id, top_prob, rank in zip(top_ids, top_probs,\n+                                                      top_ranks)\n+                })\n+\n             sampled_logprobs.append({\n                 token_id: Logprob(*logprob_and_rank)\n                 for token_id, logprob_and_rank in\n                 sampled_logprobs_dict.items()\n             })\n-        # There are len(seq_ids) number of sampled tokens for the current\n-        # sequence group in top_logprobs. Jump to the next seq_group.\n+\n+        # NOTE: This part of code is not intuitive. `selected_logprobs` include\n+        # logprobs for the current step, which has len(next_token_ids) tokens\n+        # per sequence group. `logprobs` includes logprobs from the previous\n+        # steps, which has len(seq_ids) tokens per sequence group.\n+\n+        # Iterate to the next sequence group in a batch.\n+        selected_logprobs_idx += len(next_token_ids)\n+        # Iterate to the next sequence group in a batch.\n         top_logprob_idx += len(seq_ids)\n     return sampled_logprobs, top_logprob_idx, selected_logprobs_idx", "apis": ["None"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a core module (sampler.py) and changes the way tensors are transferred to CPU by replacing repeated .cpu() calls with .to('cpu') operations, and it pre-selects items from tensors to avoid repeated .item() calls. These changes aim to reduce overhead in log probability calculations, thereby boosting performance. The modifications are not simple refactoring or bug fixes but performance-related optimizations on a high-level API that runs on CPU and can be tested without specialized hardware.", "llm_api_reason": "This commit optimizes how logâ€probabilities are gathered during sampling in the model executorâ€™s sampler layer. In particular, it replaces direct .cpu() calls with .to(\"cpu\"), adds conditional handling for topâ€‘k values, and batches tensor-to-list conversions (thus reducing repetitive .item() calls) in the internal helper functions (_get_logprobs, _get_prompt_logprob_if_needed, and _get_sampled_logprob_if_needed). These changes improve performance without modifying the external API or interface of the sampler."}
{"commit_hash": "2a052011ca473a9dc8160f3daa1f5f63a2ad1fe3", "pr_url": "https://github.com/vllm-project/vllm/pull/4527", "pr_date": "2024-05-04", "timeline_text": "Copy link Member mgoin commented May 1, 2024 â€¢ edited by pcmoritz Loading Uh oh! There was an error while loading. Please reload this page . Follow on to #4332 to enable FP8 checkpoint loading for Mixtral and supersedes #4436 . This PR enables the following checkpoint loading features for Mixtral: Supports loading fp8 checkpoints for Mixtral, such as this \"nm-testing/Mixtral-8x7B-Instruct-v0.1-FP8\" test model Supports static or dynamic activation quantization with static weight quantization (all per tensor) Supports different scales for each expert weight Supports Fp8 in QKV layer Notes: The Expert Gate/Router always runs at half / full precision for now. If there are different weight scales between QKV layer (for separate QKV weights), they are re-quantized using layer.weight_scale.max() so we can have a single gemm for performance. Future work: cutlass kernels for separate QKV weight scales support memory compression from loading fp16 checkpoints and dynamically quantizing to fp8 (blocked on weight loader refactor) generalize MoE implementation to apply to other MoE models Smoke test output: python test-mixtral-fp8.py \nWARNING 05-03 01:42:29 config.py:187] fp8 quantization is not fully optimized yet. The speed can be slower than non-quantized models.\nINFO 05-03 01:42:29 llm_engine.py:100] Initializing an LLM engine (v0.4.1) with config: model='nm-testing/Mixtral-8x7B-Instruct-v0.1-FP8', speculative_config=None, tokenizer='nm-testing/Mixtral-8x7B-Instruct-v0.1-FP8', skip_tokenizer_init=False, tokenizer_mode=auto, revision=None, tokenizer_revision=None, trust_remote_code=False, dtype=torch.bfloat16, max_seq_len=32768, download_dir=None, load_format=LoadFormat.AUTO, tensor_parallel_size=1, disable_custom_all_reduce=False, quantization=fp8, enforce_eager=False, kv_cache_dtype=auto, quantization_param_path=None, device_config=cuda, decoding_config=DecodingConfig(guided_decoding_backend='outlines'), seed=0)\nINFO 05-03 01:42:29 utils.py:623] Found nccl from library /home/paperspace/.config/vllm/nccl/cu12/libnccl.so.2.18.1\nINFO 05-03 01:42:30 selector.py:75] Cannot use FlashAttention-2 backend because the flash_attn package is not found. Please install it for better performance.\nINFO 05-03 01:42:30 selector.py:31] Using XFormers backend.\nWARNING 05-03 01:42:31 fp8.py:29] Detected fp8 checkpoint. Please note that the format is experimental and subject to change.\nINFO 05-03 01:42:31 weight_utils.py:199] Using model weights format ['*.safetensors']\nWARNING 05-03 01:42:41 utils.py:428] Found act_scales that are not equal for fp8 MoE layer. Using the maximum across experts for each layer. \nINFO 05-03 01:42:42 model_runner.py:172] Loading model weights took 43.7487 GB\nINFO 05-03 01:42:51 gpu_executor.py:114] # GPU blocks: 9689, # CPU blocks: 2048\nINFO 05-03 01:42:53 model_runner.py:872] Capturing the model for CUDA graphs. This may lead to unexpected consequences if the model is not static. To run the model in eager mode, set 'enforce_eager=True' or use '--enforce-eager' in the CLI.\nINFO 05-03 01:42:53 model_runner.py:876] CUDA graphs can take additional 1~3 GiB memory per GPU. If you are running out of memory, consider decreasing `gpu_memory_utilization` or enforcing eager mode. You can also reduce the `max_num_seqs` as needed to decrease memory usage.\nINFO 05-03 01:43:00 model_runner.py:953] Graph capturing finished in 7 secs.\nProcessed prompts: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [00:00<00:00,  4.30it/s]\nPrompt: 'Hello, my name is', Generated text: ' Alyssa and I am a 17-year-old girl'\nPrompt: 'The president of the United States is', Generated text: ' the head of the executive branch of the United States government and is the highest political'\nPrompt: 'The capital of France is', Generated text: \" a beautiful and historic city that is home to some of the world's most\"\nPrompt: 'The future of AI is', Generated text: ' a rapidly evolving field, with new developments and innovations happening all the time' PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added 3 commits May 1, 2024 14:16 [Kernel] Support Fp8 Checkpoints for Mixtral (Dynamic + Static â€¦ b5002df Activations) Cleanup 4378f4f Fix circular import with all_close_1d ce2051a robertgshaw2-redhat mentioned this pull request May 1, 2024 [Kernel] Support Fp8 Checkpoints for Mixtral (Dynamic + Static) #4436 Closed comaniac approved these changes May 1, 2024 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/models/mixtral.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat mentioned this pull request May 1, 2024 v0.4.2 Release Tracker #4505 Closed pcmoritz reviewed May 1, 2024 View reviewed changes vllm/model_executor/models/mixtral.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . pcmoritz reviewed May 1, 2024 View reviewed changes vllm/model_executor/models/mixtral.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . mgoin added 3 commits May 2, 2024 14:53 Merge branch 'main' into fp8-mixtral-serialization 1dc1d2d Address review 56ff89c Fix test 66febef pcmoritz reviewed May 4, 2024 View reviewed changes vllm/model_executor/models/mixtral.py # ACT_SCALE (for fp8) if quant_config.activation_scheme == \"static\": if not quant_config.is_checkpoint_fp8_serialized: Copy link Collaborator pcmoritz May 4, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This needs to be removed -- we do support activation scales for FP16 checkpoints too (same as kv store scales going forward) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator pcmoritz May 4, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Ah never mind, I misunderstood -- FP16 checkpoints with \"quantization\": \"fp8\" are also considered fp8 serialized (this is pretty confusing) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions pcmoritz approved these changes May 4, 2024 View reviewed changes pcmoritz merged commit 2a05201 into vllm-project : main May 4, 2024 robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request May 6, 2024 [Kernel] Support MoE Fp8 Checkpoints for Mixtral (Static Weights withâ€¦ â€¦ 55dd119 â€¦ Dynamic/Static Activations) ( vllm-project#4527 )\n\nFollow on to vllm-project#4332 to enable FP8 checkpoint loading for Mixtral and supersedes vllm-project#4436 .\n\nThis PR enables the following checkpoint loading features for Mixtral:\n\nSupports loading fp8 checkpoints for Mixtral, such as this \"nm-testing/Mixtral-8x7B-Instruct-v0.1-FP8\" test model\nSupports static or dynamic activation quantization with static weight quantization (all per tensor)\nSupports different scales for each expert weight\nSupports Fp8 in QKV layer\nNotes:\n\nThe Expert Gate/Router always runs at half / full precision for now.\nIf there are different weight scales between QKV layer (for separate QKV weights), they are re-quantized using layer.weight_scale.max() so we can have a single gemm for performance. z103cb pushed a commit\n        to z103cb/opendatahub_vllm\n      that referenced\n      this pull request May 7, 2024 [Kernel] Support MoE Fp8 Checkpoints for Mixtral (Static Weights withâ€¦ â€¦ ba2be94 â€¦ Dynamic/Static Activations) ( vllm-project#4527 )\n\nFollow on to vllm-project#4332 to enable FP8 checkpoint loading for Mixtral and supersedes vllm-project#4436 .\n\nThis PR enables the following checkpoint loading features for Mixtral:\n\nSupports loading fp8 checkpoints for Mixtral, such as this \"nm-testing/Mixtral-8x7B-Instruct-v0.1-FP8\" test model\nSupports static or dynamic activation quantization with static weight quantization (all per tensor)\nSupports different scales for each expert weight\nSupports Fp8 in QKV layer\nNotes:\n\nThe Expert Gate/Router always runs at half / full precision for now.\nIf there are different weight scales between QKV layer (for separate QKV weights), they are re-quantized using layer.weight_scale.max() so we can have a single gemm for performance. dtrifiro pushed a commit\n        to opendatahub-io/vllm\n      that referenced\n      this pull request May 7, 2024 [Kernel] Support MoE Fp8 Checkpoints for Mixtral (Static Weights withâ€¦ â€¦ 111b1a5 â€¦ Dynamic/Static Activations) ( vllm-project#4527 )\n\nFollow on to vllm-project#4332 to enable FP8 checkpoint loading for Mixtral and supersedes vllm-project#4436 .\n\nThis PR enables the following checkpoint loading features for Mixtral:\n\nSupports loading fp8 checkpoints for Mixtral, such as this \"nm-testing/Mixtral-8x7B-Instruct-v0.1-FP8\" test model\nSupports static or dynamic activation quantization with static weight quantization (all per tensor)\nSupports different scales for each expert weight\nSupports Fp8 in QKV layer\nNotes:\n\nThe Expert Gate/Router always runs at half / full precision for now.\nIf there are different weight scales between QKV layer (for separate QKV weights), they are re-quantized using layer.weight_scale.max() so we can have a single gemm for performance. dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:03", "has_lm_eval": false, "has_performance": false, "has_serving": true, "has_general_test": true, "test_details": "SERVING: API server, OpenAI API server, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:49:03", "models": ["mistralai/Mixtral-8x7B-Instruct-v0.1"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=mistralai/Mixtral-8x7B-Instruct-v0.1,quantization=fp8,tensor_parallel_size=1 --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model mistralai/Mixtral-8x7B-Instruct-v0.1 --quantization fp8", "commit_subject": "[Kernel] Support MoE Fp8 Checkpoints for Mixtral (Static Weights with Dynamic/Static Activations) (#4527)", "commit_message": "[Kernel] Support MoE Fp8 Checkpoints for Mixtral (Static Weights with Dynamic/Static Activations) (#4527)\n\nFollow on to #4332 to enable FP8 checkpoint loading for Mixtral and supersedes #4436.\n\nThis PR enables the following checkpoint loading features for Mixtral:\n\nSupports loading fp8 checkpoints for Mixtral, such as this \"nm-testing/Mixtral-8x7B-Instruct-v0.1-FP8\" test model\nSupports static or dynamic activation quantization with static weight quantization (all per tensor)\nSupports different scales for each expert weight\nSupports Fp8 in QKV layer\nNotes:\n\nThe Expert Gate/Router always runs at half / full precision for now.\nIf there are different weight scales between QKV layer (for separate QKV weights), they are re-quantized using layer.weight_scale.max() so we can have a single gemm for performance.", "commit_date": "2024-05-04T11:45:16-07:00", "files_changed": ["tests/kernels/test_moe.py", "vllm/model_executor/models/mixtral.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 0, "num_files": 2, "num_hunks": 8, "num_edited_lines": 175, "num_non_test_edited_lines": 171, "commit_year": 2024}, "diff_text": "diff --git a/tests/kernels/test_moe.py b/tests/kernels/test_moe.py\nindex 046f11d95..2356b9ec1 100644\n--- a/tests/kernels/test_moe.py\n+++ b/tests/kernels/test_moe.py\n@@ -77,8 +77,8 @@ def test_mixtral_moe(dtype: torch.dtype):\n     for i in range(config.num_local_experts):\n         weights = (hf_moe.experts[i].w1.weight.data,\n                    hf_moe.experts[i].w3.weight.data)\n-        vllm_moe.ws[i][:] = torch.cat(weights, dim=0)\n-        vllm_moe.w2s[i][:] = hf_moe.experts[i].w2.weight.data\n+        vllm_moe.w13_weight[i][:] = torch.cat(weights, dim=0)\n+        vllm_moe.w2_weight[i][:] = hf_moe.experts[i].w2.weight.data\n \n     # Generate input batch of dimensions [batch_size, seq_len, hidden_dim]\n     hf_inputs = torch.randn((1, 64, config.hidden_size)).to(dtype).to(\"cuda\")\ndiff --git a/vllm/model_executor/models/mixtral.py b/vllm/model_executor/models/mixtral.py\nindex 9ff9ba298..efa4de751 100644\n--- a/vllm/model_executor/models/mixtral.py\n+++ b/vllm/model_executor/models/mixtral.py\n@@ -78,6 +78,8 @@ class MixtralMoE(nn.Module):\n         self.top_k = top_k\n         self.hidden_size = hidden_size\n         self.intermediate_size = intermediate_size // self.tp_size\n+        self.quant_config = quant_config\n+\n         # FIXME(pcmoritz): Make this more general to support different\n         # quantization schemes\n         self.use_fp8 = isinstance(quant_config, Fp8Config)\n@@ -86,55 +88,79 @@ class MixtralMoE(nn.Module):\n             params_dtype = torch.get_default_dtype()\n         self.params_dtype = params_dtype\n \n+        # Gate always runs at half / full precision for now.\n         self.gate = ReplicatedLinear(self.hidden_size,\n                                      self.num_total_experts,\n                                      bias=False,\n                                      params_dtype=self.params_dtype,\n                                      quant_config=None)\n \n-        self.ws = nn.Parameter(\n+        if self.use_fp8:\n+            params_dtype = torch.float8_e4m3fn\n+\n+        self.w13_weight = nn.Parameter(\n             torch.empty(self.num_total_experts,\n                         2 * self.intermediate_size,\n                         self.hidden_size,\n-                        dtype=self.params_dtype))\n-        self.w2s = nn.Parameter(\n+                        dtype=params_dtype))\n+        self.w2_weight = nn.Parameter(\n             torch.empty(self.num_total_experts,\n                         self.hidden_size,\n                         self.intermediate_size,\n-                        dtype=self.params_dtype))\n+                        dtype=params_dtype))\n \n-        set_weight_attrs(self.ws, {\n+        set_weight_attrs(self.w13_weight, {\n             \"weight_loader\": self.weight_loader,\n         })\n-        set_weight_attrs(self.w2s, {\n+        set_weight_attrs(self.w2_weight, {\n             \"weight_loader\": self.weight_loader,\n         })\n \n-        # Scaling factors for FP8 weights\n-        self.ws_scale = nn.Parameter(\n-            torch.ones(self.num_total_experts, dtype=torch.float32),\n-            requires_grad=False) if self.use_fp8 else None\n-        self.w2s_scale = nn.Parameter(\n-            torch.ones(self.num_total_experts, dtype=torch.float32),\n-            requires_grad=False) if self.use_fp8 else None\n-\n-        # Scaling factors for FP8 activations\n-        need_act_scales = (self.use_fp8\n-                           and quant_config.activation_scheme == \"static\")\n-        self.as_scale = nn.Parameter(\n-            torch.zeros(1, dtype=torch.float32),\n-            requires_grad=False) if need_act_scales else None\n-        self.a2s_scale = nn.Parameter(\n-            torch.zeros(1, dtype=torch.float32),\n-            requires_grad=False) if need_act_scales else None\n-\n-        if need_act_scales:\n-            set_weight_attrs(self.as_scale, {\n-                \"weight_loader\": self.weight_loader,\n-            })\n-            set_weight_attrs(self.a2s_scale, {\n-                \"weight_loader\": self.weight_loader,\n-            })\n+        # Used for fp8.\n+        self.w13_scale = None\n+        self.w2_scale = None\n+        self.a13_scale = None\n+        self.a2_scale = None\n+\n+        if self.use_fp8:\n+            # WEIGHT_SCALE (for fp8)\n+            self.w13_scale = nn.Parameter(torch.ones(self.num_total_experts,\n+                                                     dtype=torch.float32),\n+                                          requires_grad=False)\n+            self.w2_scale = nn.Parameter(torch.ones(self.num_total_experts,\n+                                                    dtype=torch.float32),\n+                                         requires_grad=False)\n+\n+            # If loading fp8 checkpoint, pass the weight loaders.\n+            # If loading an fp16 checkpoint, do not (we will quantize in\n+            #   process_weights_after_loading()\n+            if quant_config.is_checkpoint_fp8_serialized:\n+                set_weight_attrs(self.w13_scale, {\n+                    \"weight_loader\": self.weight_loader,\n+                })\n+                set_weight_attrs(self.w2_scale, {\n+                    \"weight_loader\": self.weight_loader,\n+                })\n+\n+            # ACT_SCALE (for fp8)\n+            if quant_config.activation_scheme == \"static\":\n+                if not quant_config.is_checkpoint_fp8_serialized:\n+                    raise ValueError(\n+                        \"Found static activation scheme for checkpoint that \"\n+                        \"was not serialized fp8.\")\n+                self.a13_scale = nn.Parameter(torch.zeros(\n+                    self.num_total_experts, dtype=torch.float32),\n+                                              requires_grad=False)\n+                self.a2_scale = nn.Parameter(torch.zeros(\n+                    self.num_total_experts, dtype=torch.float32),\n+                                             requires_grad=False)\n+\n+                set_weight_attrs(self.a13_scale, {\n+                    \"weight_loader\": self.weight_loader,\n+                })\n+                set_weight_attrs(self.a2_scale, {\n+                    \"weight_loader\": self.weight_loader,\n+                })\n \n     def weight_loader(self, param: nn.Parameter, loaded_weight: torch.Tensor,\n                       weight_name: str, expert_id: int):\n@@ -149,20 +175,49 @@ class MixtralMoE(nn.Module):\n                        shard_size:2 * shard_size, :] = loaded_weight[shard, :]\n         if weight_name.endswith(\"w2.weight\"):\n             param_data[expert_id, :, :] = loaded_weight[:, shard]\n-        if \"act_scale\" in weight_name:\n-            param_data[:] = param_data[:].max(loaded_weight)\n+        if \"act_scale\" in weight_name or \"weight_scale\" in weight_name:\n+            param_data[expert_id] = loaded_weight\n \n     def process_weights_after_loading(self):\n-        if self.use_fp8:\n-            ws = torch.empty_like(self.ws.data, dtype=torch.float8_e4m3fn)\n-            w2s = torch.empty_like(self.w2s.data, dtype=torch.float8_e4m3fn)\n+        # Fp8 is the only case where we need to process after loading.\n+        if not self.use_fp8:\n+            return\n+\n+        # If checkpoint is fp16, quantize here.\n+        if not self.quant_config.is_checkpoint_fp8_serialized:\n+            w13_weight = torch.empty_like(self.w13_weight.data,\n+                                          dtype=torch.float8_e4m3fn)\n+            w2_weight = torch.empty_like(self.w2_weight.data,\n+                                         dtype=torch.float8_e4m3fn)\n             for expert in range(self.num_total_experts):\n-                ws[expert, :, :], self.ws_scale[expert] = ops.scaled_fp8_quant(\n-                    self.ws.data[expert, :, :])\n-                w2s[expert, :, :], self.w2s_scale[\n-                    expert] = ops.scaled_fp8_quant(self.w2s.data[expert, :, :])\n-            self.ws = nn.Parameter(ws, requires_grad=False)\n-            self.w2s = nn.Parameter(w2s, requires_grad=False)\n+                w13_weight[expert, :, :], self.w13_scale[\n+                    expert] = ops.scaled_fp8_quant(\n+                        self.w13_weight.data[expert, :, :])\n+                w2_weight[expert, :, :], self.w2_scale[\n+                    expert] = ops.scaled_fp8_quant(\n+                        self.w2_weight.data[expert, :, :])\n+            self.w13_weight = nn.Parameter(w13_weight, requires_grad=False)\n+            self.w2_weight = nn.Parameter(w2_weight, requires_grad=False)\n+\n+        # If checkpoint is fp8 + static, cleanup act_scales.\n+        #   Since state_dict has an act_scale per expert but our kernels\n+        #   are passed one act_scale shared across all experts.\n+        elif self.quant_config.activation_scheme == \"static\":\n+            if self.a13_scale is None or self.a2_scale is None:\n+                raise ValueError(\n+                    \"QuantConfig has static quantization, but found \"\n+                    \"activation scales are None.\")\n+\n+            if (not all_close_1d(self.a13_scale)\n+                    or not all_close_1d(self.a2_scale)):\n+                print_warning_once(\n+                    \"Found act_scales that are not equal for fp8 MoE layer. \"\n+                    \"Using the maximum across experts for each layer. \")\n+\n+            self.a13_scale = nn.Parameter(self.a13_scale.max(),\n+                                          requires_grad=False)\n+            self.a2_scale = nn.Parameter(self.a2_scale.max(),\n+                                         requires_grad=False)\n \n     def forward(self, hidden_states: torch.Tensor) -> torch.Tensor:\n         num_tokens, hidden_size = hidden_states.shape\n@@ -170,17 +225,17 @@ class MixtralMoE(nn.Module):\n         # router_logits: (num_tokens, n_experts)\n         router_logits, _ = self.gate(hidden_states)\n         final_hidden_states = fused_moe(hidden_states,\n-                                        self.ws,\n-                                        self.w2s,\n+                                        self.w13_weight,\n+                                        self.w2_weight,\n                                         router_logits,\n                                         self.top_k,\n                                         renormalize=True,\n                                         inplace=True,\n                                         use_fp8=self.use_fp8,\n-                                        w1_scale=self.ws_scale,\n-                                        w2_scale=self.w2s_scale,\n-                                        a1_scale=self.as_scale,\n-                                        a2_scale=self.a2s_scale)\n+                                        w1_scale=self.w13_scale,\n+                                        w2_scale=self.w2_scale,\n+                                        a1_scale=self.a13_scale,\n+                                        a2_scale=self.a2_scale)\n \n         if self.tp_size > 1:\n             final_hidden_states = tensor_model_parallel_all_reduce(\n@@ -222,7 +277,9 @@ class MixtralAttention(nn.Module):\n         self.rope_theta = rope_theta\n         self.sliding_window = sliding_window\n \n-        if isinstance(quant_config, Fp8Config):\n+        if isinstance(\n+                quant_config,\n+                Fp8Config) and not quant_config.is_checkpoint_fp8_serialized:\n             print_warning_once(\n                 \"For Mixtral FP8 quantization, we currently do not quantize \"\n                 \"the attention layers until their FP8 performance is improved.\"\n@@ -461,16 +518,23 @@ class MixtralForCausalLM(nn.Module):\n         ]\n \n         expert_params_mapping = [\n+            # These are the weight scales for the experts\n+            # (param_name, weight_name, expert_id)\n+            (\"w13_scale\" if weight_name in [\"w1\", \"w3\"] else \"w2_scale\",\n+             f\"experts.{expert_id}.{weight_name}.weight_scale\", expert_id)\n+            for expert_id in range(self.config.num_local_experts)\n+            for weight_name in [\"w1\", \"w2\", \"w3\"]\n+        ] + [\n             # These are the weights for the experts\n             # (param_name, weight_name, expert_id)\n-            (\"ws\" if weight_name in [\"w1\", \"w3\"] else \"w2s\",\n+            (\"w13_weight\" if weight_name in [\"w1\", \"w3\"] else \"w2_weight\",\n              f\"experts.{expert_id}.{weight_name}.weight\", expert_id)\n             for expert_id in range(self.config.num_local_experts)\n             for weight_name in [\"w1\", \"w2\", \"w3\"]\n         ] + [\n             # These are the activation scales for the experts\n             # (param_name, weight_name, expert_id)\n-            (\"as_scale\" if weight_name in [\"w1\", \"w3\"] else \"a2s_scale\",\n+            (\"a13_scale\" if weight_name in [\"w1\", \"w3\"] else \"a2_scale\",\n              f\"experts.{expert_id}.{weight_name}.act_scale\", expert_id)\n             for expert_id in range(self.config.num_local_experts)\n             for weight_name in [\"w1\", \"w2\", \"w3\"]\n@@ -512,3 +576,8 @@ class MixtralForCausalLM(nn.Module):\n                     weight_loader = getattr(param, \"weight_loader\",\n                                             default_weight_loader)\n                     weight_loader(param, loaded_weight)\n+\n+\n+def all_close_1d(x: torch.Tensor) -> bool:\n+    assert len(x.shape) == 1\n+    return all(torch.allclose(x[0], x[i]) for i in range(x.shape[0]))", "apis": ["MixtralMoE", "MixtralModel", "MixtralForCausalLM"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mixtral.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mixtral_quant.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit introduces changes in the core Mixtral model (in mixtral.py) to support FP8 checkpoint loading, including new parameter names, handling of FP8-specific quantization, and weight/activation scaling adjustments. These modifications are not mere refactoring or documentation fixesâ€”they alter the internal behavior of the model to perform lower-precision computations (FP8) which can be expected to improve performance by reducing memory bandwidth and potentially accelerating inference operations. Additionally, changes like re-quantization via max across scales for a unified GEMM further indicate performance considerations. Although the changes also touch a test file, the primary modifications are in non-test source code and aim to improve runtime efficiency on standard CPU hardware. Therefore, this commit is performance/optimization related.", "llm_api_reason": "This commit extends the Mixtral MoE functionality to support FP8 checkpoints by changing internal weight parameter names, adding new scaling parameters, and adjusting the weightâ€processing logic. The modifications are made in the MixtralMoE layer (in both mixtral.py and mixtral_quant.py) as well as the weight mapping in MixtralForCausalLM, which affect how expert weights and activations are quantized and loaded for FP8 support. These updates impact the highâ€level APIs that instantiate these models for causal language modeling."}
{"commit_hash": "ad8d696a99ca1eee19f1404e16e8e82df592ff85", "pr_url": "https://github.com/vllm-project/vllm/pull/4270", "pr_date": "2024-04-22", "timeline_text": "Copy link Collaborator rkooo567 commented Apr 22, 2024 After the scheduler refactoring PR, the scheduler iteration overhead became 2ms -> 11ms. The major overhead was coming from logger.debug added to schedule_running. The main issue I think was that fstring is always evaluated although logger.debug is used, which causes additional overhead. Adding a very small overhead (less than 5us) changes e2e throughput a lot for the scheduler. scheduler after fix\nThroughput: 10.77 requests/s, 5514.02 tokens/s\niter takes 0.8~2.5ms\n\nscheduler before regrssion\nThroughput: 11.37 requests/s, 5821.86 tokens/s\niter takes 0.5~2ms\n\n(5514.02 - 5821.86) / 5821.86 * 100 = -5.28 PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions rkooo567 added 5 commits April 22, 2024 02:20 ip 31c9e5b fix one issue ac78b77 , cc1b303 done d741157 done 915fdde rkooo567 changed the title Scheduler perf fix [Core] Scheduler perf fix Apr 22, 2024 rkooo567 mentioned this pull request Apr 22, 2024 [Core] Fix scheduler perf regression #4261 Closed simon-mo approved these changes Apr 22, 2024 View reviewed changes simon-mo enabled auto-merge (squash) April 22, 2024 16:33 Copy link Collaborator comaniac commented Apr 22, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This is a very good example of logging-fstring-interpolation (W1203) . Could you also try this to see if this performance is preserved? If so, we can enable logging-fstring-interpolation and logging-not-lazy to CI linting. logger.debug(\"add_seq_group %s\", seq_group.request_id) ðŸ‘ 4 simon-mo, richardliaw, AaronFriel, and rkooo567 reacted with thumbs up emoji All reactions ðŸ‘ 4 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . fix test 0fce8f0 simon-mo merged commit ad8d696 into vllm-project : main Apr 22, 2024 Copy link Collaborator Author rkooo567 commented Apr 22, 2024 @comaniac let me try today! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cadedaniel mentioned this pull request Apr 23, 2024 [Core] Enable prefix caching with block manager v2 enabled #4142 Merged rkooo567 mentioned this pull request Apr 24, 2024 [CI] Disable non-lazy string operation on logging #4326 Merged Copy link Collaborator Author rkooo567 commented Apr 24, 2024 @comaniac #4326 Besides, I tried what you suggested on the scheduler, but somehow it is still slower (faster than fstring). So I guess using logger at all is not desirable in the scheduler All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator comaniac commented Apr 25, 2024 Thanks for trying that. I guess it means logger overhead cannot be ignored in some very intense places. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Apr 25, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) e8a65e2 robertgshaw2-redhat pushed a commit\n        to neuralmagic/nm-vllm\n      that referenced\n      this pull request Apr 26, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) 542dc70 alexeykondrat pushed a commit\n        to alexeykondrat/ci-vllm\n      that referenced\n      this pull request May 1, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) 81e9afe z103cb pushed a commit\n        to z103cb/opendatahub_vllm\n      that referenced\n      this pull request May 7, 2024 [Core] Scheduler perf fix ( vllm-project#4270 ) c10e074 dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:06", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, Throughput, Throughput | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:49:06", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Core] Scheduler perf fix (#4270)", "commit_message": "[Core] Scheduler perf fix (#4270)", "commit_date": "2024-04-22T21:11:06Z", "files_changed": ["tests/core/test_scheduler.py", "vllm/core/scheduler.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 0, "num_files": 2, "num_hunks": 13, "num_edited_lines": 25, "num_non_test_edited_lines": 7, "commit_year": 2024}, "diff_text": "diff --git a/tests/core/test_scheduler.py b/tests/core/test_scheduler.py\nindex 9588a1bea..a25112385 100644\n--- a/tests/core/test_scheduler.py\n+++ b/tests/core/test_scheduler.py\n@@ -540,7 +540,7 @@ def test_decode_schedule_preempted():\n     curr_loras = None\n     for i in range(3):\n         _, seq_group = create_dummy_prompt(str(i), prompt_length=60)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         running.append(seq_group)\n     scheduler.block_manager.can_append_slots = MagicMock()\n@@ -581,7 +581,7 @@ def test_decode_swap_beam_search():\n     budget = create_token_budget()\n     for i in range(3):\n         _, seq_group = create_dummy_prompt(str(i), prompt_length=60, best_of=2)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         running.append(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         budget.add_num_seqs(seq_group.request_id,\n@@ -629,7 +629,7 @@ def test_schedule_decode_blocks_to_copy_update():\n     running = deque()\n     policy = PolicyFactory.get_policy(policy_name=\"fcfs\")\n     curr_loras = None\n-    scheduler._allocate_and_set_running(seq_group, 60)\n+    scheduler._allocate_and_set_running(seq_group)\n     append_new_token_seq_group(60, seq_group, 1)\n     running.append(seq_group)\n \n@@ -659,7 +659,7 @@ def test_schedule_swapped_simple():\n     curr_loras = None\n     blocks_to_swap_out = {}\n     _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-    scheduler._allocate_and_set_running(seq_group, 60)\n+    scheduler._allocate_and_set_running(seq_group)\n     append_new_token_seq_group(60, seq_group, 1)\n     scheduler._swap_out(seq_group, blocks_to_swap_out)\n     swapped.append(seq_group)\n@@ -687,7 +687,7 @@ def test_schedule_swapped_max_token_budget():\n     blocks_to_swap_out = {}\n     for _ in range(2):\n         _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -721,7 +721,7 @@ def test_schedule_swapped_max_seqs():\n     blocks_to_swap_out = {}\n     for i in range(4):\n         _, seq_group = create_dummy_prompt(str(i), prompt_length=60)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -759,7 +759,7 @@ def test_schedule_swapped_max_loras():\n                                                lora_name=str(i),\n                                                lora_int_id=i + 1,\n                                                lora_local_path=\"abc\"))\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -783,7 +783,7 @@ def test_schedule_swapped_cannot_swap_in():\n     blocks_to_swap_out = {}\n     for _ in range(2):\n         _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-        scheduler._allocate_and_set_running(seq_group, 60)\n+        scheduler._allocate_and_set_running(seq_group)\n         append_new_token_seq_group(60, seq_group, 1)\n         scheduler._swap_out(seq_group, blocks_to_swap_out)\n         swapped.append(seq_group)\n@@ -808,7 +808,7 @@ def test_schedule_swapped_blocks_to_copy():\n     policy = PolicyFactory.get_policy(policy_name=\"fcfs\")\n     curr_loras = None\n     _, seq_group = create_dummy_prompt(\"1\", prompt_length=60, best_of=2)\n-    scheduler._allocate_and_set_running(seq_group, 60)\n+    scheduler._allocate_and_set_running(seq_group)\n     append_new_token_seq_group(60, seq_group, 1)\n     blocks_to_swap_out = {}\n     scheduler._swap_out(seq_group, blocks_to_swap_out)\ndiff --git a/vllm/core/scheduler.py b/vllm/core/scheduler.py\nindex 419855062..8d7db09bb 100644\n--- a/vllm/core/scheduler.py\n+++ b/vllm/core/scheduler.py\n@@ -297,7 +297,6 @@ class Scheduler:\n \n     def add_seq_group(self, seq_group: SequenceGroup) -> None:\n         # Add sequence groups to the waiting queue.\n-        logger.debug(f\"add_seq_group {seq_group.request_id}\")\n         self.waiting.append(seq_group)\n \n     def abort_seq_group(self, request_id: Union[str, Iterable[str]]) -> None:\n@@ -427,7 +426,6 @@ class Scheduler:\n                         swapped_out.append(seq_group)\n                     break\n             else:\n-                logger.debug(f\"append slot for {seq_group}\")\n                 self._append_slots(seq_group, blocks_to_copy)\n                 is_prefill = seq_group.is_prefill()\n                 if is_prefill:\n@@ -659,7 +657,7 @@ class Scheduler:\n             if curr_loras is not None and lora_int_id > 0:\n                 curr_loras.add(lora_int_id)\n             waiting_queue.popleft()\n-            self._allocate_and_set_running(seq_group, num_new_tokens)\n+            self._allocate_and_set_running(seq_group)\n             seq_groups.append(\n                 ScheduledSequenceGroup(seq_group=seq_group,\n                                        token_chunk_size=num_new_tokens))\n@@ -952,8 +950,7 @@ class Scheduler:\n         self.running = deque(seq_group for seq_group in self.running\n                              if not seq_group.is_finished())\n \n-    def _allocate_and_set_running(self, seq_group: SequenceGroup,\n-                                  num_new_tokens: int) -> None:\n+    def _allocate_and_set_running(self, seq_group: SequenceGroup) -> None:\n         self.block_manager.allocate(seq_group)\n         for seq in seq_group.get_seqs(status=SequenceStatus.WAITING):\n             seq.status = SequenceStatus.RUNNING", "apis": ["vllm.core.scheduler.Scheduler._allocate_and_set_running"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/scheduler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/scheduler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies both test files and a core scheduler source file, meaning it changes non-test code. The change involves removing an unnecessary parameter from the _allocate_and_set_running function and adjusting related calls. Although it might superficially appear as a refactor (removing unused parameters and debug logs), the commit message \"[Core] Scheduler perf fix\" indicates a performance-related fix. The modifications potentially remove overhead (e.g. eliminating redundant token count handling) and simplify scheduling which could improve runtime efficiency of a high-level API (the scheduler) running on CPU. Thus, the changes satisfy the conditions as a performance/optimization-related commit.", "llm_api_reason": "This commit removes the extra parameter (num_new_tokens) from the internal Scheduler method _allocate_and_set_running â€“ updating its signature and all the call sites (including in tests) to no longer pass a token-count argument. This change simplifies the methodâ€™s API so that token allocation is handled internally rather than requiring a caller-supplied value, thereby improving performance and consistency."}
{"commit_hash": "2f1928354903ae0c6edfe76cc90081eb513ead2c", "pr_url": "https://github.com/vllm-project/vllm/pull/3890", "pr_date": "2024-04-07", "timeline_text": "Copy link Member youkaichao commented Apr 7, 2024 Some code is inefficient. Find some equivalent but more efficient code. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 3 ywang96, zhuohan123, and anttttti reacted with rocket emoji All reactions ðŸš€ 3 reactions avoid get_token_ids by len b8cadb3 youkaichao marked this pull request as draft April 7, 2024 01:25 cadedaniel approved these changes Apr 7, 2024 View reviewed changes youkaichao marked this pull request as ready for review April 7, 2024 02:13 youkaichao merged commit 2f19283 into vllm-project : main Apr 7, 2024 youkaichao deleted the latency_optimize branch April 7, 2024 02:14 z103cb pushed a commit\n        to z103cb/opendatahub_vllm\n      that referenced\n      this pull request Apr 22, 2024 [Core] latency optimization ( vllm-project#3890 ) 9d9b6c4 dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:09", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": false, "test_details": "PERF: latency, optimization", "analysis_extracted_at": "2025-09-07 17:49:09", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Core] latency optimization (#3890)", "commit_message": "[Core] latency optimization (#3890)", "commit_date": "2024-04-06T19:14:06-07:00", "files_changed": ["vllm/core/block_manager_v1.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 2, "num_non_test_edited_lines": 2, "commit_year": 2024}, "diff_text": "diff --git a/vllm/core/block_manager_v1.py b/vllm/core/block_manager_v1.py\nindex b2aaeb33c..e7e3b4dc1 100644\n--- a/vllm/core/block_manager_v1.py\n+++ b/vllm/core/block_manager_v1.py\n@@ -328,7 +328,7 @@ class BlockSpaceManagerV1(BlockSpaceManager):\n         self,\n         seq: Sequence,\n     ) -> bool:\n-        token_ids_len = len(seq.data.get_token_ids())\n+        token_ids_len = seq.data.get_len()\n         return token_ids_len > 0 and token_ids_len % seq.block_size == 0\n \n     def _maybe_promote_last_block(", "apis": ["vllm.core.block_manager"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_completion.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file in a non-trivial way. Instead of calling len() on the full token_ids list, it now directly calls get_len(), likely avoiding the cost of list construction and thereby improving latency. The commit message specifically mentions \"latency optimization\", and the change affects the core functionality, likely improving performance for high-level APIs. Overall, it meets the criteria as a performance-related optimization change that is testable on CPU.", "llm_api_reason": "The commit replaces a call to get the length of token IDs via seq.data.get_token_ids() with a new, likely more efficient, method seq.data.get_len() within the BlockSpaceManagerV1 class. This change directly affects the code responsible for managing the physical block allocation (KV cache management) in the vLLM core. Since the block manager is exposed as part of the memory management APIs (vllm.core.block_manager), this change affects that API's functionality and latency characteristics."}
{"commit_hash": "b6d103542c654fb63013a1e45a586d654ae36a2a", "pr_url": "https://github.com/vllm-project/vllm/pull/3662", "pr_date": "2024-03-30", "timeline_text": "Copy link Contributor mawong-amd commented Mar 27, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This PR primarily creates optimized specializations of fused_add_rms_norm_kernel, used in many layernorms. It also includes a slightly optimized version of blockReduceSum/warpReduceSum which slightly reduce the number of shuffles done when the max block size is <=512 and known at compile time. It is observed that fused_add_rms_norm is memory latency bound under many scenarios. The optimized implementation primarily derives its benefits by Coalescing global memory transactions into larger operations, which reduces the number of stalls that need to be hidden. This is achieved by (implicitly) unrolling both of the for loops through the use of a vector struct. Using a smaller block size when the number of blocks dispatched is large, which allows more blocks to simultaneously fit onto execution units and hence improves latency hiding. The same ideas contained here can be applied to other relatively simple kernels which should be memory bound (e.g. some activation kernels). More performance numbers can be provided as they become available or if requested. The existing test suite appears sufficient, but additional tests can be created on request. Some examples of the speed up, as obtained by profiling via benchmark_latency on Llama2-70B (hidden size 8192), FP16, TP = 1, on MI300X: (input_len = output_len = batch_size = 128): Prefill improves to 305 ms from 440 ms. (input_len = 2048, output_len = 128, batch_size = 1): Prefill improves to 41 ms from 88 ms. For both cases above, decode improves to 7 ms from 11 ms. Another optimization attempted was the use of shared memory, which effectively converts a global memory load into a shared memory load/store pair per item. While this improves performance when applied to baseline, it was not observed to improve performance on top of the current optimizations. BEFORE SUBMITTING, PLEASE READ THE CHECKLIST BELOW AND FILL IN THE DESCRIPTION ABOVE PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 cadedaniel and WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions WoosukKwon self-assigned this Mar 28, 2024 WoosukKwon reviewed Mar 28, 2024 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @mawong-amd Thanks for submitting the PR! This optimization seems to be necessary for MI300x GPUs. Unfortunately, I didn't see noticeable e2e performance boost for A100 GPUs. Is this expected? Also, I'm a bit worried about whether the new kernels keep the semantics of the current kernels. Could you double check? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions csrc/reduction_utils.cuh Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . csrc/layernorm_kernels.cu Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . csrc/layernorm_kernels.cu Comment on lines +252 to +253 scalar_t z = input[blockIdx.x * hidden_size + idx]; z += residual[blockIdx.x * hidden_size + idx]; float x = (float) z; Copy link Collaborator WoosukKwon Mar 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Doesn't this change the semantics of the kernel since we do the addition in FP16/BF16 instead of FP32? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author mawong-amd Mar 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It does in theory, however I've not noticed any observable effects from doing the addition in lower precision so far (even the logprobs of generated sequences are identical). In terms of a possible increase in rounding error, this is likely still negligible compared to typical errors incurred during the reduction phase and in the approximate rsqrt. The benefit of doing the addition in FP16/BF16 is that it can be implemented as a packed operation. But this step shouldn't be a bottleneck in any case. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator WoosukKwon Mar 30, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I see, makes sense. Thanks for the explanation! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions cmake/utils.cmake Comment on lines +103 to +107 list(REMOVE_ITEM GPU_FLAGS \"-D__CUDA_NO_HALF_OPERATORS__\" \"-D__CUDA_NO_HALF_CONVERSIONS__\" \"-D__CUDA_NO_BFLOAT16_CONVERSIONS__\" \"-D__CUDA_NO_HALF2_OPERATORS__\") Copy link Collaborator WoosukKwon Mar 28, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Can this affect other CUDA kernels? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author mawong-amd Mar 28, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It could, but I haven't noticed any side effects and neither have the tests. The existing defines seem to originate from Torch's default defines as a legacy item and it's not clear to me if there's a good reason to retain them nowadays (e.g. seems like the recently added Punica extension similarly disables these defines). If this is a concern, we could either limit the scope of removing these defines to this file or use free functions instead of operators (e.g. __hadd/__hadd2 for __half/__half2 operator+). But this increases code bloat and non-portability even further: the current implementation is already compromised to an extent by the (deficient) headers provided by CUDA/HIP (neither __hadd/__hadd2 as free functions or \"heterogeneous\" operators like float2::operator*(float) are consistently implemented in CUDA, while conversion operators/constructors are not consistently implemented by both). Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator WoosukKwon Mar 30, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Got it. Thanks for the explanation! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon added\n  the action-required label Mar 28, 2024 WoosukKwon removed their assignment Mar 28, 2024 mawong-amd changed the title [Kernel] Layernorm performance optimization [WIP][Kernel] Layernorm performance optimization Mar 28, 2024 mawong-amd changed the title [WIP][Kernel] Layernorm performance optimization [Kernel] Layernorm performance optimization Mar 28, 2024 Copy link Contributor Author mawong-amd commented Mar 28, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @mawong-amd Thanks for submitting the PR! This optimization seems to be necessary for MI300x GPUs. Unfortunately, I didn't see noticeable e2e performance boost for A100 GPUs. Is this expected? Also, I'm a bit worried about whether the new kernels keep the semantics of the current kernels. Could you double check? Hi, I managed to run a few performance tests on H100 last night and also observed that there was no speed up. I looked at the PTX and SASS assembly and NVCC was not fusing the loads/stores as expected. It appears NVCC needs to know these global memory ops are aligned on a 16 byte boundary to unlock the full 128-bit coalesced op; I've added this alignment requirement to the vector struct and now I'm observing similar speedups on H100. Preliminary numbers I'm seeing on H100 are: (input_len = output_len = batch_size = 128): Prefill improves to 92 ms from 178 ms. (input_len = 2048, output_len = 128, batch_size = 1): Prefill improves to 45 ms from 84 ms. For both cases above, decode improves to 3 ms from 8 ms. One \"drawback\" of this change is we can now only enable optimizations when the hidden_size is a multiple of 8 and the tensor pointers are aligned on a 16 byte boundary. But these conditions should be met essentially all the time. As for the changed semantics, I'll discuss it in the relevant review comment thread. Thanks! ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mawong-amd added 6 commits March 30, 2024 03:30 Layernorm optimizations: â€¦ aac1754 Bulk conversions (packed halfs into half2, using vectors of half2);\nblock and warp reduce with AMD wavesize 64 (vs 32);\nusing smaller block sizes for improved block occupancy on CUs\n\nUse larger block sizes for decode; optimize warp and block reduce fully\n\nRefactor vector to use half to maintain same alignment as c10::Half; move packed logic into member functions\n\nAdd a few missing unroll directives\n\nFix blockReduce stall caused by warp divergence on CUDA (vLLM uses universal masks)\n\nRefactor vector type to enable optimizations for bf16\n\nRe-apply the blockReduceSum fix for warp divergence\n\nHotfix: Disable BF16 opts due to ROCm 5.7 incompatibility\n\nRemove redundant inline specifiers; preparing for upstream Disable no half conv flags for CUDA d2f681a Add more hidden sizes (including non-multiples of 8) to test 5128836 Enforce 16 byte alignment for CUDA vectorized mem ops c0e37f6 Add back explicit cast to T in reduction_utils 677e045 Style tweak a1bbdc4 mawong-amd force-pushed the layernorm2upstream branch\n    from 4f94b87 to a1bbdc4 Compare March 30, 2024 04:03 Copy link Contributor Author mawong-amd commented Mar 30, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Quick update on end-to-end runtime numbers. With the latest changes, I'm seeing small but observable improvements on H100. Specifically, on the latency benchmark (50 iters on each test): (input_len = output_len = batch_size = 128): Improves to 11.463s from 11.658s. [1.7% improvement] (input_len = 2048, output_len = 128, batch_size = 1): Improves to 4.261s from 4.362s. [2.3% improvement] ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mawong-amd requested a review\n  from WoosukKwon March 30, 2024 16:08 WoosukKwon added rocm Related to AMD ROCm and removed action-required labels Mar 30, 2024 WoosukKwon self-assigned this Mar 30, 2024 WoosukKwon approved these changes Mar 30, 2024 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @mawong-amd LGTM! Thanks for the optimization! Didn't know that RMSNorm can affect the performance this much. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon merged commit b6d1035 into vllm-project : main Mar 30, 2024 Copy link Member youkaichao commented Apr 1, 2024 I realized that this pr breaks cuda 11.8 support because of the usage of __half2 etc. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author mawong-amd commented Apr 1, 2024 I realized that this pr breaks cuda 11.8 support because of the usage of __half2 etc. I think we can hotfix in a define guard to enable these optimizations only when the cuda version is > 11.8. Let me prepare a diff that does that. ðŸ‘ 1 youkaichao reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author mawong-amd commented Apr 1, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . EDIT: Hotfix created as the following PR #3782 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member youkaichao commented Apr 1, 2024 @mawong-amd Can you send a PR to land that patch? ðŸš€ 1 mawong-amd reacted with rocket emoji All reactions ðŸš€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mawong-amd mentioned this pull request Apr 1, 2024 [Hotfix][CI/Build][Kernel] CUDA 11.8 does not support layernorm optimizations #3782 Merged dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:12", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: latency, latency, latency | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:49:12", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Kernel] Layernorm performance optimization (#3662)", "commit_message": "[Kernel] Layernorm performance optimization (#3662)", "commit_date": "2024-03-30T14:26:38-07:00", "files_changed": ["cmake/utils.cmake", "csrc/layernorm_kernels.cu", "csrc/reduction_utils.cuh", "tests/kernels/test_layernorm.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 0, "num_files": 4, "num_hunks": 8, "num_edited_lines": 332, "num_non_test_edited_lines": 329, "commit_year": 2024}, "diff_text": "diff --git a/cmake/utils.cmake b/cmake/utils.cmake\nindex 6bf5d5130..c7d3d8538 100644\n--- a/cmake/utils.cmake\n+++ b/cmake/utils.cmake\n@@ -100,6 +100,11 @@ function (get_torch_gpu_compiler_flags OUT_GPU_FLAGS GPU_LANG)\n \n     if (CUDA_VERSION VERSION_GREATER_EQUAL 11.8)\n       list(APPEND GPU_FLAGS \"-DENABLE_FP8_E5M2\")\n+      list(REMOVE_ITEM GPU_FLAGS\n+        \"-D__CUDA_NO_HALF_OPERATORS__\"\n+        \"-D__CUDA_NO_HALF_CONVERSIONS__\"\n+        \"-D__CUDA_NO_BFLOAT16_CONVERSIONS__\"\n+        \"-D__CUDA_NO_HALF2_OPERATORS__\")\n     endif()\n \n   elseif(${GPU_LANG} STREQUAL \"HIP\")\ndiff --git a/csrc/layernorm_kernels.cu b/csrc/layernorm_kernels.cu\nindex 6d34d014c..ea30fa274 100644\n--- a/csrc/layernorm_kernels.cu\n+++ b/csrc/layernorm_kernels.cu\n@@ -4,6 +4,16 @@\n \n #include \"dispatch_utils.h\"\n #include \"reduction_utils.cuh\"\n+#ifndef USE_ROCM\n+  #include <cuda_bf16.h>\n+  #include <cuda_fp16.h>\n+#else\n+  #include <hip/hip_bf16.h>\n+  #include <hip/hip_fp16.h>\n+\n+  using __nv_bfloat16 = __hip_bfloat16;\n+  using __nv_bfloat162 = __hip_bfloat162;\n+#endif\n \n namespace vllm {\n \n@@ -35,9 +45,199 @@ __global__ void rms_norm_kernel(\n   }\n }\n \n-// TODO: Further optimize this kernel.\n-template<typename scalar_t>\n-__global__ void fused_add_rms_norm_kernel(\n+\n+/* Converter structs for the conversion from torch types to HIP/CUDA types,\n+   and the associated type conversions within HIP/CUDA. These helpers need\n+   to be implemented for now because the relevant type conversion\n+   operators/constructors are not consistently implemented by HIP/CUDA, so\n+   a generic conversion via type casts cannot be implemented.\n+\n+   Each struct should have the member static constexpr bool `exists`:\n+   If false, the optimized kernel is not used for the corresponding torch type.\n+   If true, the struct should be fully defined as shown in the examples below. \n+ */\n+template<typename torch_type>\n+struct _typeConvert { static constexpr bool exists = false; };\n+\n+template<>\n+struct _typeConvert<c10::Half> {\n+  static constexpr bool exists = true;\n+  using hip_type = __half;\n+  using packed_hip_type = __half2;\n+\n+  __device__ static inline float convert(hip_type x) { return __half2float(x); }\n+  __device__ static inline float2 convert(packed_hip_type x) { return __half22float2(x); }\n+  __device__ static inline hip_type convert(float x) { return __float2half_rn(x); }\n+  __device__ static inline packed_hip_type convert(float2 x) { return __float22half2_rn(x); }\n+};\n+\n+#if defined(__CUDA_ARCH__) && __CUDA_ARCH__ >= 800\n+// CUDA_ARCH < 800 does not have BF16 support\n+// TODO: Add in ROCm support once public headers handle bf16 maturely\n+template<>\n+struct _typeConvert<c10::BFloat16> {\n+  static constexpr bool exists = true;\n+  using hip_type = __nv_bfloat16;\n+  using packed_hip_type = __nv_bfloat162;\n+\n+  __device__ static inline float convert(hip_type x) { return __bfloat162float(x); }\n+  __device__ static inline float2 convert(packed_hip_type x) { return __bfloat1622float2(x); }\n+  __device__ static inline hip_type convert(float x) { return __float2bfloat16(x); }\n+  __device__ static inline packed_hip_type convert(float2 x) { return __float22bfloat162_rn(x); }\n+};\n+#endif\n+\n+\n+/* Vector POD struct to generate vectorized and packed FP16/BF16 ops\n+   for appropriate specializations of fused_add_rms_norm_kernel.\n+   Only functions that are necessary in that kernel are implemented.\n+   Alignment to 16 bytes is required to use 128-bit global memory ops.\n+ */\n+template<typename scalar_t, int width>\n+struct alignas(16) _f16Vec {\n+  /* Not theoretically necessary that width is a power of 2 but should \n+     almost always be the case for optimization purposes */ \n+  static_assert(width > 0 && (width & (width - 1)) == 0,\n+                \"Width is not a positive power of 2!\");\n+  using Converter = _typeConvert<scalar_t>;\n+  using T1 = typename Converter::hip_type;\n+  using T2 = typename Converter::packed_hip_type;\n+  T1 data[width];\n+\n+  __device__ _f16Vec& operator+=(const _f16Vec<scalar_t, width>& other) {\n+    if constexpr (width % 2 == 0) {\n+      #pragma unroll\n+      for (int i = 0; i < width; i += 2) {\n+        T2 temp{data[i], data[i+1]};\n+        temp += T2{other.data[i], other.data[i+1]};\n+        data[i] = temp.x;\n+        data[i+1] = temp.y;\n+      }\n+    } else {\n+      #pragma unroll\n+      for (int i = 0; i < width; ++i)\n+        data[i] += other.data[i];\n+    }\n+    return *this;\n+  }\n+\n+  __device__ _f16Vec& operator*=(const _f16Vec<scalar_t, width>& other) {\n+    if constexpr (width % 2 == 0) {\n+      #pragma unroll\n+      for (int i = 0; i < width; i += 2) {\n+        T2 temp{data[i], data[i+1]};\n+        temp *= T2{other.data[i], other.data[i+1]};\n+        data[i] = temp.x;\n+        data[i+1] = temp.y;\n+      }\n+    } else {\n+      #pragma unroll\n+      for (int i = 0; i < width; ++i)\n+        data[i] *= other.data[i];\n+    }\n+    return *this;\n+  }\n+\n+  __device__ _f16Vec& operator*=(const float scale) {\n+    if constexpr (width % 2 == 0) {\n+      #pragma unroll\n+      for (int i = 0; i < width; i += 2) {\n+        float2 temp_f = Converter::convert(T2{data[i], data[i+1]});\n+        temp_f.x *= scale;\n+        temp_f.y *= scale;\n+        T2 temp = Converter::convert(temp_f);\n+        data[i] = temp.x;\n+        data[i+1] = temp.y;\n+      }\n+    } else {\n+      #pragma unroll\n+      for (int i = 0; i < width; ++i) {\n+        float temp = Converter::convert(data[i]) * scale;\n+        data[i] = Converter::convert(temp);\n+      }\n+    }\n+    return *this;\n+  }\n+\n+  __device__ float sum_squares() const {\n+    float result = 0.0f;\n+    if constexpr (width % 2 == 0) {\n+      #pragma unroll\n+      for (int i = 0; i < width; i += 2) {\n+        float2 z = Converter::convert(T2{data[i], data[i+1]});\n+        result += z.x * z.x + z.y * z.y;\n+      }\n+    } else {\n+      #pragma unroll\n+      for (int i = 0; i < width; ++i) {\n+        float x = Converter::convert(data[i]);\n+        result += x * x;\n+      }\n+    }\n+    return result;\n+  }\n+};\n+\n+/* Function specialization in the case of FP16/BF16 tensors.\n+   Additional optimizations we can make in this case are\n+   packed and vectorized operations, which help with the\n+   memory latency bottleneck. */\n+template<typename scalar_t, int width>\n+__global__ std::enable_if_t<\n+  (width > 0) && _typeConvert<scalar_t>::exists> fused_add_rms_norm_kernel(\n+  scalar_t* __restrict__ input,           // [..., hidden_size]\n+  scalar_t* __restrict__ residual,        // [..., hidden_size]\n+  const scalar_t* __restrict__ weight,    // [hidden_size]\n+  const float epsilon,\n+  const int num_tokens,\n+  const int hidden_size) {\n+  // Sanity checks on our vector struct and type-punned pointer arithmetic\n+  static_assert(std::is_pod_v<_f16Vec<scalar_t, width>>);\n+  static_assert(sizeof(_f16Vec<scalar_t, width>) == sizeof(scalar_t) * width);\n+\n+  const int vec_hidden_size = hidden_size / width;\n+  __shared__ float s_variance;\n+  float variance = 0.0f;\n+  /* These and the argument pointers are all declared `restrict` as they are\n+     not aliased in practice. Argument pointers should not be dereferenced\n+     in this kernel as that would be undefined behavior */\n+  auto* __restrict__ input_v = reinterpret_cast<_f16Vec<scalar_t, width>*>(input);\n+  auto* __restrict__ residual_v = reinterpret_cast<_f16Vec<scalar_t, width>*>(residual);\n+  auto* __restrict__ weight_v = reinterpret_cast<const _f16Vec<scalar_t, width>*>(weight);\n+\n+  for (int idx = threadIdx.x; idx < vec_hidden_size; idx += blockDim.x) {\n+    int id = blockIdx.x * vec_hidden_size + idx;\n+    _f16Vec<scalar_t, width> temp = input_v[id];\n+    temp += residual_v[id];\n+    variance += temp.sum_squares();\n+    residual_v[id] = temp;\n+  }\n+  /* Keep the following if-else block in sync with the\n+     calculation of max_block_size in fused_add_rms_norm */ \n+  if (num_tokens < 256) {\n+    variance = blockReduceSum<float, 1024>(variance);\n+  } else variance = blockReduceSum<float, 256>(variance);\n+  if (threadIdx.x == 0) {\n+    s_variance = rsqrtf(variance / hidden_size + epsilon);\n+  }\n+  __syncthreads();\n+\n+  for (int idx = threadIdx.x; idx < vec_hidden_size; idx += blockDim.x) {\n+    int id = blockIdx.x * vec_hidden_size + idx;\n+    _f16Vec<scalar_t, width> temp = residual_v[id];\n+    temp *= s_variance;\n+    temp *= weight_v[idx];\n+    input_v[id] = temp;\n+  }\n+}\n+\n+\n+/* Generic fused_add_rms_norm_kernel\n+   The width field is not used here but necessary for other specializations.\n+ */\n+template<typename scalar_t, int width>\n+__global__ std::enable_if_t<\n+  (width == 0) || !_typeConvert<scalar_t>::exists> fused_add_rms_norm_kernel(\n   scalar_t* __restrict__ input,           // [..., hidden_size]\n   scalar_t* __restrict__ residual,        // [..., hidden_size]\n   const scalar_t* __restrict__ weight,    // [hidden_size]\n@@ -48,12 +248,17 @@ __global__ void fused_add_rms_norm_kernel(\n   float variance = 0.0f;\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n-    float x = (float) input[blockIdx.x * hidden_size + idx];\n-    x += (float) residual[blockIdx.x * hidden_size + idx];\n+    scalar_t z = input[blockIdx.x * hidden_size + idx];\n+    z += residual[blockIdx.x * hidden_size + idx];\n+    float x = (float) z;\n     variance += x * x;\n-    residual[blockIdx.x * hidden_size + idx] = (scalar_t) x;\n+    residual[blockIdx.x * hidden_size + idx] = z;\n   }\n-  variance = blockReduceSum<float>(variance);\n+  /* Keep the following if-else block in sync with the\n+     calculation of max_block_size in fused_add_rms_norm */ \n+  if (num_tokens < 256) {\n+    variance = blockReduceSum<float, 1024>(variance);\n+  } else variance = blockReduceSum<float, 256>(variance);\n   if (threadIdx.x == 0) {\n     s_variance = rsqrtf(variance / hidden_size + epsilon);\n   }\n@@ -93,6 +298,21 @@ void rms_norm(\n     });\n }\n \n+#define LAUNCH_FUSED_ADD_RMS_NORM(width)              \\\n+  VLLM_DISPATCH_FLOATING_TYPES(                       \\\n+    input.scalar_type(),                              \\\n+    \"fused_add_rms_norm_kernel\",                      \\\n+    [&] {                                             \\\n+      vllm::fused_add_rms_norm_kernel                 \\\n+      <scalar_t, width><<<grid, block, 0, stream>>>(  \\\n+        input.data_ptr<scalar_t>(),                   \\\n+        residual.data_ptr<scalar_t>(),                \\\n+        weight.data_ptr<scalar_t>(),                  \\\n+        epsilon,                                      \\\n+        num_tokens,                                   \\\n+        hidden_size);                                 \\\n+    });\n+\n void fused_add_rms_norm(\n   torch::Tensor& input,    // [..., hidden_size]\n   torch::Tensor& residual, // [..., hidden_size]\n@@ -102,19 +322,29 @@ void fused_add_rms_norm(\n   int num_tokens = input.numel() / hidden_size;\n \n   dim3 grid(num_tokens);\n-  dim3 block(std::min(hidden_size, 1024));\n+  /* This kernel is memory-latency bound in many scenarios.\n+     When num_tokens is large, a smaller block size allows\n+     for increased block occupancy on CUs and better latency\n+     hiding on global mem ops. */\n+  const int max_block_size = (num_tokens < 256) ? 1024 : 256;\n+  dim3 block(std::min(hidden_size, max_block_size));\n   const at::cuda::OptionalCUDAGuard device_guard(device_of(input));\n   const cudaStream_t stream = at::cuda::getCurrentCUDAStream();\n-  VLLM_DISPATCH_FLOATING_TYPES(\n-    input.scalar_type(),\n-    \"fused_add_rms_norm_kernel\",\n-    [&] {\n-      vllm::fused_add_rms_norm_kernel<scalar_t><<<grid, block, 0, stream>>>(\n-        input.data_ptr<scalar_t>(),\n-        residual.data_ptr<scalar_t>(),\n-        weight.data_ptr<scalar_t>(),\n-        epsilon,\n-        num_tokens,\n-        hidden_size);\n-    });\n+  /*If the tensor types are FP16/BF16, try to use the optimized kernel\n+    with packed + vectorized ops.\n+    Max optimization is achieved with a width-8 vector of FP16/BF16s\n+    since we can load at most 128 bits at once in a global memory op.\n+    However, this requires each tensor's data to be aligned to 16\n+    bytes.\n+   */\n+  auto inp_ptr = reinterpret_cast<std::uintptr_t>(input.data_ptr());\n+  auto res_ptr = reinterpret_cast<std::uintptr_t>(residual.data_ptr());\n+  auto wt_ptr = reinterpret_cast<std::uintptr_t>(weight.data_ptr());\n+  bool ptrs_are_aligned = inp_ptr % 16 == 0 && res_ptr % 16 == 0 \\\n+                          && wt_ptr % 16 == 0;\n+  if (ptrs_are_aligned && hidden_size % 8 == 0) {\n+    LAUNCH_FUSED_ADD_RMS_NORM(8);\n+  } else {\n+    LAUNCH_FUSED_ADD_RMS_NORM(0);\n+  }\n }\ndiff --git a/csrc/reduction_utils.cuh b/csrc/reduction_utils.cuh\nindex c25464e86..bb5171f85 100644\n--- a/csrc/reduction_utils.cuh\n+++ b/csrc/reduction_utils.cuh\n@@ -20,43 +20,45 @@\n #include \"cuda_compat.h\"\n \n namespace vllm {\n-\n-template<typename T>\n+template<typename T, int numLanes = WARP_SIZE>\n __inline__ __device__ T warpReduceSum(T val) {\n-#pragma unroll\n-  for (int mask = WARP_SIZE/2; mask > 0; mask >>= 1)\n+  static_assert(numLanes > 0 && (numLanes & (numLanes - 1)) == 0,\n+                \"numLanes is not a positive power of 2!\");\n+  static_assert(numLanes <= WARP_SIZE);\n+  #pragma unroll\n+  for (int mask = numLanes >> 1; mask > 0; mask >>= 1)\n     val += VLLM_SHFL_XOR_SYNC(val, mask);\n   return val;\n }\n \n-__inline__ __device__ constexpr int _calculateLaneMask(int warp_size) {\n-  return warp_size - 1;\n-}\n-\n-__inline__ __device__ constexpr int _calculateWidShift(int warp_size) {\n-  return 5 + (warp_size >> 6);\n+// Helper function to return the next largest power of 2\n+static constexpr int _nextPow2(unsigned int num) {\n+  if (num <= 1) return num;\n+  return 1 << (CHAR_BIT * sizeof(num) - __builtin_clz(num - 1));\n }\n \n /* Calculate the sum of all elements in a block */\n-template<typename T>\n+template<typename T, int maxBlockSize = 1024>\n __inline__ __device__ T blockReduceSum(T val) {\n-  static __shared__ T shared[WARP_SIZE];\n-  constexpr auto LANE_MASK = _calculateLaneMask(WARP_SIZE);\n-  constexpr auto WID_SHIFT = _calculateWidShift(WARP_SIZE);\n-  int lane = threadIdx.x & LANE_MASK;\n-  int wid = threadIdx.x >> WID_SHIFT;\n-\n-  val = warpReduceSum<T>(val);\n-\n-  if (lane == 0)\n-    shared[wid] = val;\n+  static_assert(maxBlockSize <= 1024);\n+  if constexpr (maxBlockSize > WARP_SIZE) {\n+    val = warpReduceSum<T>(val);\n+    // Calculates max number of lanes that need to participate in the last warpReduce\n+    constexpr int maxActiveLanes = (maxBlockSize + WARP_SIZE - 1) / WARP_SIZE;\n+    static __shared__ T shared[maxActiveLanes];\n+    int lane = threadIdx.x % WARP_SIZE;\n+    int wid = threadIdx.x / WARP_SIZE;\n+    if (lane == 0)\n+      shared[wid] = val;\n \n-  __syncthreads();\n+    __syncthreads();\n \n-  // Modify from blockDim.x << 5 to blockDim.x / 32. to prevent\n-  // blockDim.x is not divided by 32\n-  val = (threadIdx.x < (blockDim.x / (WARP_SIZE * 1.0f))) ? shared[lane] : (T)(0.0f);\n-  val = warpReduceSum<T>(val);\n+    val = (threadIdx.x < blockDim.x / float(WARP_SIZE)) ? shared[lane] : (T)(0.0f);\n+    val = warpReduceSum<T, _nextPow2(maxActiveLanes)>(val);\n+  } else {\n+    // A single warpReduce is equal to blockReduce\n+    val = warpReduceSum<T, _nextPow2(maxBlockSize)>(val);\n+  }\n   return val;\n }\n \ndiff --git a/tests/kernels/test_layernorm.py b/tests/kernels/test_layernorm.py\nindex b1e3c1a7f..210d59e4f 100644\n--- a/tests/kernels/test_layernorm.py\n+++ b/tests/kernels/test_layernorm.py\n@@ -5,7 +5,8 @@ from vllm.model_executor.layers.layernorm import RMSNorm\n \n DTYPES = [torch.half, torch.bfloat16, torch.float]\n NUM_TOKENS = [7, 83, 4096]  # Arbitrary values for testing\n-HIDDEN_SIZES = [768, 5120, 8192]  # Arbitrary values for testing\n+HIDDEN_SIZES = [768, 769, 770, 771, 5120, 5124, 5125, 5126, 8192,\n+                8199]  # Arbitrary values for testing\n ADD_RESIDUAL = [False, True]\n SEEDS = [0]\n CUDA_DEVICES = [", "apis": ["RMSNorm.forward_cuda"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/layernorm.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/_custom_ops.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes non-trivial modifications to several source files (cmake and C++ CUDA source files) that implement a new vectorized and packed version of a layer normalization kernel. The changes include optimized memory-latency handling in the kernel launch configuration, new conversion structs and specialized kernels for FP16/BF16 data types, and adjustments in reduction utilities. These modifications are aimed at improving kernel performance on CPU-accessible GPUs (the kernels themselves run on CUDA hardware but affect performance optimizations testable without GPU-specific heavy dependencies). Therefore, the commit clearly addresses performance optimization rather than merely refactoring, fixing bugs, or adding non-performance features.", "llm_api_reason": "This commit makes performance optimizations in the layer normalization CUDA kernels by improving the fused_add_rms_norm_kernel implementation (including adding optimizations for FP16/BF16 types using vectorized and packed operations) as well as tuning the reduction functions. These lowâ€level kernel changes directly benefit the CUDA path invoked by the Python API for RMSNorm (e.g. in its forward_cuda method). Hence, the affected Python API is that of the RMSNorm op when using the CUDA implementation."}
{"commit_hash": "3a243095e5e7b655b63ab08fbd5936cb40850415", "pr_url": "https://github.com/vllm-project/vllm/pull/3623", "pr_date": "2024-03-25", "timeline_text": "Copy link Collaborator Yard1 commented Mar 25, 2024 Small tweak to CPU<->GPU comms in Sampler's _get_ranks (not a major improvement, just cleanup). PR Checklist (Click to Expand) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Optimize _get_ranks in Sampler c8f8eb7 Yard1 requested review from esmeetu , zhuohan123 and simon-mo March 25, 2024 21:28 njhill approved these changes Mar 25, 2024 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice! I didn't realize that you could do this particular kind of indexing with tensors. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon merged commit 3a24309 into vllm-project : main Mar 25, 2024 Yard1 deleted the optimize_get_ranks branch March 25, 2024 23:49 xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Mar 31, 2024 Optimize _get_ranks in Sampler ( vllm-project#3623 ) 19d7628 dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:15", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: improvement | SERVING: API server, OpenAI API server, Frontend | TEST: test, CI, continuous integration", "analysis_extracted_at": "2025-09-07 17:49:15", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "Optimize `_get_ranks` in Sampler (#3623)", "commit_message": "Optimize `_get_ranks` in Sampler (#3623)", "commit_date": "2024-03-25T16:03:02-07:00", "files_changed": ["vllm/model_executor/layers/sampler.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 27, "num_non_test_edited_lines": 27, "commit_year": 2024}, "diff_text": "diff --git a/vllm/model_executor/layers/sampler.py b/vllm/model_executor/layers/sampler.py\nindex d07527304..06135192c 100644\n--- a/vllm/model_executor/layers/sampler.py\n+++ b/vllm/model_executor/layers/sampler.py\n@@ -506,22 +506,23 @@ def _sample(\n     #                                   sampling_tensors)\n \n \n-def _get_ranks(x: torch.Tensor, indices: List[int]) -> torch.Tensor:\n+def _get_ranks(x: torch.Tensor, indices: torch.Tensor) -> torch.Tensor:\n     \"\"\"\n     This function calculates the ranks of the chosen tokens in a logprob tensor.\n \n     Args:\n         x (torch.Tensor): 2D logprob tensor of shape (N, M)\n                         where N is the no. of tokens and M is the vocab dim.\n-        indices (List[int]): List of chosen token indices.\n+        indices (torch.Tensor): List of chosen token indices.\n \n     Returns:\n         torch.Tensor: 1D tensor of shape (N,) where N is the no. of tokens.\n                     Each element in the returned tensor represents the rank \n                     of the chosen token in the input logprob tensor.\n     \"\"\"\n-    vals = x[range(len(x)), indices]\n-    return (x > vals[:, None]).long().sum(1) + 1\n+    vals = x[torch.arange(0, len(x), device=x.device, dtype=indices.dtype),\n+             indices]\n+    return (x > vals[:, None]).long().sum(1).add_(1)\n \n \n def _get_logprobs(\n@@ -561,12 +562,21 @@ def _get_logprobs(\n         sample_idx += num_parent_seqs\n     assert sample_idx == logprobs.size(0)\n \n+    batched_logprobs_query_seq_indices_gpu = torch.tensor(\n+        batched_logprobs_query_seq_indices, device=logprobs.device)\n+    batched_logprobs_query_token_indices_gpu = torch.tensor(\n+        batched_logprobs_query_token_indices, device=logprobs.device)\n+\n     # Batched query for logprobs of selected token\n     batched_logprobs_query_result = logprobs[[\n-        batched_logprobs_query_seq_indices,\n-        batched_logprobs_query_token_indices\n+        batched_logprobs_query_seq_indices_gpu,\n+        batched_logprobs_query_token_indices_gpu\n     ]]\n \n+    batched_ranks_query_result = _get_ranks(\n+        logprobs[batched_logprobs_query_seq_indices_gpu],\n+        batched_logprobs_query_token_indices_gpu)\n+\n     # Batched query for logprobs of topk tokens\n     if largest_num_logprobs > 0:\n         top_logprobs, top_token_ids = torch.topk(logprobs,\n@@ -578,10 +588,7 @@ def _get_logprobs(\n         top_logprobs, top_token_ids = None, None\n \n     batched_logprobs_query_result = batched_logprobs_query_result.cpu()\n-\n-    batched_ranks_query_result = _get_ranks(\n-        logprobs[batched_logprobs_query_seq_indices],\n-        batched_logprobs_query_token_indices)\n+    batched_ranks_query_result = batched_ranks_query_result.cpu()\n \n     # Gather results\n     result_prompt_logprobs: List[Optional[PromptLogprobs]] = []", "apis": ["vllm.model_executor.layers.sampler._get_ranks", "vllm.model_executor.layers.sampler._get_logprobs"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a source code file and changes implementations in the _get_ranks and _get_logprobs functions to improve efficiency. It converts a Python list into a tensor, uses in-place operations (add_), and creates tensors on the appropriate device to likely reduce overhead. These changes are not just cosmetic or simple refactoring; they aim to enhance performance on CPU by optimizing the computational workflow. Despite the commit message mentioning \"Optimize\", the modifications are clearly performance-related rather than being a bug fix or adding a new feature.", "llm_api_reason": "This commit optimizes the token ranking computation within the sampler layer. The helper function _get_ranks was refactored to use torch.arange with proper device and dtype parameters instead of Pythonâ€™s range, ensuring better compatibility with the input tensorâ€™s device. In addition, the batched querying in _get_logprobs has been updated to build GPU tensors for the sequence and token indices before passing them to _get_ranks, reducing unnecessary data transfers and improving performance."}
{"commit_hash": "bfdb1ba5c3fb14387c69acb1f5067102d8028e56", "pr_url": "https://github.com/vllm-project/vllm/pull/3469", "pr_date": null, "timeline_text": "Copy link Collaborator Yard1 commented Mar 18, 2024 PR Checklist (Click to expand. Please read before submitting.) Thank you for your contribution to vLLM! Before submitting the pull request, please ensure the PR meets the following criteria. This helps vLLM maintain the code quality and improve the efficiency of the review process. PR Title and Classification Only specific types of PRs will be reviewed. The PR title is prefixed appropriately to indicate the type of change. Please use one of the following: [Bugfix] for bug fixes. [CI/Build] for build or continuous integration improvements. [Doc] for documentation fixes and improvements. [Model] for adding a new model or improving an existing model. Model name should appear in the title. [Frontend] For changes on the vLLM frontend (e.g., OpenAI API server, LLM class, etc.) [Kernel] for changes affecting CUDA kernels or other compute kernels. [Core] for changes in the core vLLM logic (e.g., LLMEngine , AsyncLLMEngine , Scheduler , etc.) [Hardware][Vendor] for hardware-specific changes. Vendor name should appear in the prefix (e.g., [Hardware][AMD] ). [Misc] for PRs that do not fit the above categories. Please use this sparingly. Note: If the PR spans more than one category, please include all relevant prefixes. Code Quality The PR need to meet the following code quality standards: We adhere to Google Python style guide and Google C++ style guide . Pass all linter checks. Please use format.sh to format your code. The code need to be well-documented to ensure future contributors can easily understand the code. Include sufficient tests to ensure the project to stay correct and robust. This includes both unit tests and integration tests. Please add documentation to docs/source/ if the PR modifies the user-facing behaviors of vLLM. It helps vLLM user understand and utilize the new features or changes. Notes for Large Changes Please keep the changes as concise as possible. For major architectural changes (>500 LOC excluding kernel/data/config/test), we would expect a GitHub issue (RFC) discussing the technical design and justification. Otherwise, we will tag it with rfc-required and might not go through the PR. What to Expect for the Reviews The goal of the vLLM team is to be a transparent reviewing machine . We would like to make the review process transparent and efficient and make sure no contributor feel confused or frustrated. However, the vLLM team is small, so we need to prioritize some PRs over others. Here is what you can expect from the review process: After the PR is submitted, the PR will be assigned to a reviewer. Every reviewer will pick up the PRs based on their expertise and availability. After the PR is assigned, the reviewer will provide status update every 2-3 days. If the PR is not reviewed within 7 days, please feel free to ping the reviewer or the vLLM team. After the review, the reviewer will put an action-required label on the PR if there are changes required. The contributor should address the comments and ping the reviewer to re-review the PR. Please respond to all comments within a reasonable time frame. If a comment isn't clear or you disagree with a suggestion, feel free to ask for clarification or discuss the suggestion. Thank You Finally, thank you for taking the time to read these guidelines and for your interest in contributing to vLLM. Your contributions make vLLM a great tool for everyone! This PR improved detokenization performance for the prefill step by doing the following: Avoiding the detokenization of the entire prompt when unnecessary Improving logprob token detokenization to avoid repeated computation Making prompt logprob detokenization incremental In order to facilitate testing, the detokenization logic is moved to its own abstraction. Benchmark results (BS=1, the gain will be linear depending on the number of input tokens in a batch) on a single A10 GPU, with 5 logprobs to decode: python /home/ray/default/vllm_public/benchmarks/benchmark_latency.py --model meta-llama/Llama-2-7b-chat-hf  --batch-size 1 --output-len 2 --input-len 1000 --num-iters 1 Before PR: Avg latency: 0.292 seconds After PR: Avg latency: 0.287 seconds Benchmark results on a single A10 GPU, with 5 prompt logprobs to decode: python /home/ray/default/vllm_public/benchmarks/benchmark_latency.py --model meta-llama/Llama-2-7b-chat-hf  --batch-size 1 --output-len 2 --input-len 1000 --num-iters 1 Before PR: Avg latency: 2.133 seconds After PR: Avg latency: 0.362 seconds Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 5 MeloYang05, robertgshaw2-redhat, esmeetu, WoosukKwon, and ywang96 reacted with thumbs up emoji ðŸ‘€ 4 njhill, robertgshaw2-redhat, WoosukKwon, and ywang96 reacted with eyes emoji All reactions ðŸ‘ 5 reactions ðŸ‘€ 4 reactions Yard1 and others added 3 commits March 16, 2024 22:15 WIP 5b9153d WIP 8e37cfa Add co-author â€¦ ff9c9a5 Co-authored-by: MeloYang <meloyang05@gmail.com> Yard1 requested review from esmeetu , zhuohan123 and simon-mo March 18, 2024 17:21 Fix CI e4c2ebb Yard1 changed the title Improve detokenization performance for prefill [Core] Improve detokenization performance for prefill Mar 18, 2024 richardliaw assigned simon-mo Mar 18, 2024 Fix test 3171bbf Copy link Collaborator WoosukKwon commented Mar 22, 2024 @simon-mo Kindly reminder for this PR. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . simon-mo approved these changes Mar 22, 2024 View reviewed changes Copy link Collaborator simon-mo left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I'm stamping this but could useful for another eye on this. But since it's mostly moving things around + utilizing existing functions to achieve something, I think it's mergable. I tried my best to understand the code, left some comments for readability that please feel free to address. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/transformers_utils/detokenizer.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/transformers_utils/tokenizer.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/transformers_utils/detokenizer.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/transformers_utils/detokenizer.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/transformers_utils/detokenizer.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . njhill reviewed Mar 22, 2024 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @Yard1 this looks great, thanks. I agree with all @simon-mo 's comments. I like the Detokenizer class separation but wonder whether this could be taken a bit further: have Detokenizer be stateful and self-contained, it could contain the prefix_offset , read_offset and output_text fields that are currently in Sequence , and itself be a field of Sequence (for output tokens). A separate instance of it could be used for the prompt tokens. WDYT? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author Yard1 commented Mar 22, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @njhill I like that idea, though we'd need to figure out a good design to share the tokenizer object across the instances. I think the default assumption may be that each Detokenizer has it's own HF tokenizer, but we'd like it to be shared. Maybe we could have something like DetokenizationState in the Sequence All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Review feedback c7e933f Copy link Member njhill commented Mar 22, 2024 I think the default assumption may be that each Detokenizer has it's own HF tokenizer, @Yard1 I'm not sure I follow why that would be the case or why it would matter? I don't see the problem with multiple Detokenizer instances referencing the same tokenizer? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author Yard1 commented Mar 22, 2024 @njhill Oh yeah from technical standpoint it's all clear, but from design standpoint multiple instances sharing the same object makes it hard to realize at a glance whether that object is shared or separate, which may lead to issues later (\"As a new developer, I want to modify the tokenizer in this sequence for some reason, so I will just do that without realizing it's shared across all sequences\") All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member njhill commented Mar 22, 2024 Ah, makes sense! though I think it's not uncommon for such things to be shared. I.e. the field is just seen as a pointer to the tokenizer used by this detokenizer. In any case maybe a comment on the field making clear that it's shared would help with that? And I don't mean to imply that this PR should necessarily be held up for this change, could always be done as a follow-on. ðŸ‘ 1 Yard1 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author Yard1 commented Mar 22, 2024 @njhill definitely! I think it would be a good followup (even just breaking up some of the big sequence.py classes would be good) ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Fix test daa87e9 Yard1 merged commit bfdb1ba into vllm-project : main Mar 22, 2024 Yard1 deleted the improve_detokenization_for_prefill branch March 22, 2024 20:44 dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged gc-fu pushed a commit\n        to analytics-zoo/vllm\n      that referenced\n      this pull request Jul 2, 2024 [Core] Improve detokenization performance for prefill ( vllm-project#3469 â€¦ d60ae0f )\n\nCo-authored-by: MeloYang <meloyang05@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:18", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: latency, latency, latency | SERVING: API server, OpenAI API server, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:49:18", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python /home/ray/default/vllm_public/benchmarks/benchmark_latency.py --model meta-llama/Llama-2-7b-chat-hf  --batch-size 1 --output-len 2 --input-len 1000 --num-iters 1", "commit_subject": "[Core] Improve detokenization performance for prefill (#3469)", "commit_message": "[Core] Improve detokenization performance for prefill (#3469)\n\nCo-authored-by: MeloYang <meloyang05@gmail.com>", "commit_date": "2024-03-22T13:44:12-07:00", "files_changed": ["tests/tokenization/test_detokenize.py", "vllm/engine/llm_engine.py", "vllm/transformers_utils/detokenizer.py", "vllm/transformers_utils/tokenizer.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 0, "num_files": 4, "num_hunks": 13, "num_edited_lines": 474, "num_non_test_edited_lines": 311, "commit_year": 2024}, "diff_text": "diff --git a/tests/tokenization/test_detokenize.py b/tests/tokenization/test_detokenize.py\nindex 442173939..082034083 100644\n--- a/tests/tokenization/test_detokenize.py\n+++ b/tests/tokenization/test_detokenize.py\n@@ -1,13 +1,17 @@\n import pytest\n \n from transformers import AutoTokenizer\n+from typing import List, Dict\n \n+from vllm.sequence import Sequence, Logprob, SamplingParams, SequenceGroup\n+from vllm.transformers_utils.tokenizer_group import get_tokenizer_group\n from vllm.transformers_utils.tokenizer import detokenize_incrementally\n+from vllm.transformers_utils.detokenizer import Detokenizer\n \n TRUTH = [\n-    \"Hello here, this is a simple test\",  # noqa: E501\n-    \"vLLM is a high-throughput and memory-efficient inference and serving engine for LLMs. It is designed to be used in production environments, where inference and serving\",  # noqa: E501\n-    \"æˆ‘å¾ˆæ„Ÿè°¢ä½ çš„çƒ­æƒ…\"  # noqa: E501\n+    \"Hello here, this is a simple test\",\n+    \"vLLM is a high-throughput and memory-efficient inference and serving engine for LLMs. It is designed to be used in production environments, where inference and serving\",  # noqa\n+    \"æˆ‘å¾ˆæ„Ÿè°¢ä½ çš„çƒ­æƒ…\"\n ]\n TOKENIZERS = [\n     \"facebook/opt-125m\",\n@@ -24,12 +28,12 @@ TOKENIZERS = [\n \n \n def _run_incremental_decode(tokenizer, all_input_ids,\n-                            skip_special_tokens: bool):\n+                            skip_special_tokens: bool, starting_index: int):\n     decoded_text = \"\"\n     offset = 0\n     token_offset = 0\n     prev_tokens = None\n-    for i in range(len(all_input_ids)):\n+    for i in range(starting_index, len(all_input_ids)):\n         new_tokens, text, offset, token_offset = detokenize_incrementally(\n             tokenizer,\n             all_input_ids[:i + 1],\n@@ -46,17 +50,152 @@ def _run_incremental_decode(tokenizer, all_input_ids,\n \n \n @pytest.mark.parametrize(\"truth\", TRUTH)\n+@pytest.mark.parametrize(\"with_prompt\", [True, False])\n @pytest.mark.parametrize(\"tokenizer_id\", TOKENIZERS)\n @pytest.mark.parametrize(\"skip_special_tokens\", (True, False))\n-def test_decode_streaming(tokenizer_id, truth, skip_special_tokens):\n+def test_decode_streaming(tokenizer_id, truth, with_prompt,\n+                          skip_special_tokens):\n     tokenizer = AutoTokenizer.from_pretrained(tokenizer_id)\n-    all_input_ids = tokenizer(truth, add_special_tokens=False)[\"input_ids\"]\n+    if with_prompt:\n+        truth_tokens = tokenizer(truth, add_special_tokens=False)[\"input_ids\"]\n+        prompt_input_ids = truth_tokens[:len(truth) // 2]\n+        generated_input_ids = truth_tokens[len(truth) // 2:]\n+        all_input_ids = prompt_input_ids + generated_input_ids\n+        starting_index = len(prompt_input_ids)\n+        prompt = tokenizer.decode(prompt_input_ids,\n+                                  skip_special_tokens=skip_special_tokens)\n+        generated = truth[len(prompt):]\n+    else:\n+        generated = truth\n+        starting_index = 0\n+        all_input_ids = tokenizer(truth, add_special_tokens=False)[\"input_ids\"]\n     if skip_special_tokens:\n-        all_input_ids = ([tokenizer.bos_token_id]\n-                         if tokenizer.bos_token_id is not None else\n-                         []) + all_input_ids + [tokenizer.eos_token_id]\n+        if tokenizer.bos_token_id is not None:\n+            all_input_ids = [tokenizer.bos_token_id] + all_input_ids\n+            starting_index += 1\n+        all_input_ids = all_input_ids + [tokenizer.eos_token_id]\n \n     decoded_text = _run_incremental_decode(\n-        tokenizer, all_input_ids, skip_special_tokens=skip_special_tokens)\n+        tokenizer,\n+        all_input_ids,\n+        skip_special_tokens=skip_special_tokens,\n+        starting_index=starting_index)\n \n-    assert decoded_text == truth\n+    assert decoded_text == generated\n+\n+\n+@pytest.fixture\n+def detokenizer(tokenizer_name: str) -> Detokenizer:\n+    init_kwargs = dict(\n+        tokenizer_id=tokenizer_name,\n+        enable_lora=False,\n+        max_num_seqs=100,\n+        max_input_length=None,\n+        tokenizer_mode=\"auto\",\n+        trust_remote_code=False,\n+        revision=None,\n+    )\n+\n+    tokenizer_group = get_tokenizer_group(\n+        None,\n+        **init_kwargs,\n+    )\n+\n+    return Detokenizer(tokenizer_group)\n+\n+\n+@pytest.fixture(name=\"complete_sequence_token_ids\")\n+def create_complete_sequence_token_ids(complete_sequence: str,\n+                                       tokenizer_name: str) -> List[int]:\n+    tokenizer = AutoTokenizer.from_pretrained(tokenizer_name)\n+    complete_sequence_token_ids = tokenizer(complete_sequence)[\"input_ids\"]\n+    return complete_sequence_token_ids\n+\n+\n+def create_sequence(prompt_token_ids=None):\n+    prompt_token_ids = prompt_token_ids or [1]\n+    return Sequence(\n+        seq_id=0,\n+        prompt=\"<s>\",\n+        prompt_token_ids=prompt_token_ids,\n+        block_size=16,\n+    )\n+\n+\n+def create_dummy_logprobs(\n+        complete_sequence_token_ids: List[int]) -> List[Dict[int, Logprob]]:\n+    return [{\n+        token_id: Logprob(logprob=0.0),\n+        token_id + 1: Logprob(logprob=0.1)\n+    } for token_id in complete_sequence_token_ids]\n+\n+\n+@pytest.mark.parametrize(\"complete_sequence\", TRUTH)\n+@pytest.mark.parametrize(\"tokenizer_name\", TOKENIZERS)\n+@pytest.mark.parametrize(\"skip_special_tokens\", [True, False])\n+def test_decode_sequence_logprobs(complete_sequence: str,\n+                                  complete_sequence_token_ids: List[int],\n+                                  detokenizer: Detokenizer,\n+                                  skip_special_tokens: bool):\n+    \"\"\"Verify Detokenizer decodes logprobs correctly.\"\"\"\n+    sampling_params = SamplingParams(skip_special_tokens=skip_special_tokens,\n+                                     logprobs=2)\n+\n+    # Run sequentially.\n+    seq = create_sequence()\n+    dummy_logprobs = create_dummy_logprobs(complete_sequence_token_ids)\n+    sequential_logprobs_text_chosen_token = []\n+    sequential_logprobs_text_other_token = []\n+    for new_token, logprobs in zip(complete_sequence_token_ids,\n+                                   dummy_logprobs):\n+        seq.append_token_id(new_token, logprobs)\n+        detokenizer.decode_sequence_inplace(seq, sampling_params)\n+        sequential_logprobs_text_chosen_token.append(\n+            seq.output_logprobs[-1][new_token].decoded_token)\n+        sequential_logprobs_text_other_token.append(\n+            seq.output_logprobs[-1][new_token + 1].decoded_token)\n+    sequential_result = seq.output_text\n+\n+    assert sequential_result == \"\".join(sequential_logprobs_text_chosen_token)\n+    assert sequential_result != \"\".join(sequential_logprobs_text_other_token)\n+\n+    if skip_special_tokens:\n+        # Text for logprobs for the chosen token should be the same as the\n+        # generated text. Note that this will only be true if we skip\n+        # special tokens.\n+        assert sequential_result == complete_sequence\n+\n+\n+@pytest.mark.parametrize(\"complete_sequence\", TRUTH)\n+@pytest.mark.parametrize(\"tokenizer_name\", TOKENIZERS)\n+@pytest.mark.parametrize(\"skip_special_tokens\", [True])\n+def test_decode_prompt_logprobs(complete_sequence: str,\n+                                complete_sequence_token_ids: List[int],\n+                                detokenizer: Detokenizer,\n+                                skip_special_tokens: bool):\n+    \"\"\"Verify Detokenizer decodes prompt logprobs correctly.\"\"\"\n+    sampling_params = SamplingParams(skip_special_tokens=skip_special_tokens,\n+                                     prompt_logprobs=1)\n+\n+    # Run sequentially.\n+    seq = create_sequence(complete_sequence_token_ids)\n+    seq_group = SequenceGroup(request_id=\"1\",\n+                              seqs=[seq],\n+                              sampling_params=sampling_params,\n+                              arrival_time=0.0)\n+    dummy_logprobs = create_dummy_logprobs(complete_sequence_token_ids)\n+    detokenizer.decode_prompt_logprobs_inplace(seq_group, dummy_logprobs)\n+    decoded_prompt_logprobs = dummy_logprobs\n+\n+    if skip_special_tokens:\n+        # Text for logprobs for the chosen token should be the same as the\n+        # prompt text. Note that this will only be true if we skip\n+        # special tokens.\n+        assert complete_sequence == \"\".join([\n+            logprobs[token_id].decoded_token for token_id, logprobs in zip(\n+                complete_sequence_token_ids, decoded_prompt_logprobs)\n+        ])\n+        assert complete_sequence != \"\".join([\n+            logprobs[token_id + 1].decoded_token for token_id, logprobs in zip(\n+                complete_sequence_token_ids, decoded_prompt_logprobs)\n+        ])\ndiff --git a/vllm/engine/llm_engine.py b/vllm/engine/llm_engine.py\nindex 724782841..283b5d9ac 100644\n--- a/vllm/engine/llm_engine.py\n+++ b/vllm/engine/llm_engine.py\n@@ -1,5 +1,5 @@\n import time\n-from typing import Dict, Iterable, List, Optional, Tuple, Type, Union\n+from typing import Iterable, List, Optional, Tuple, Type, Union\n \n from transformers import PreTrainedTokenizer\n \n@@ -15,11 +15,11 @@ from vllm.engine.ray_utils import initialize_ray_cluster\n from vllm.logger import init_logger\n from vllm.outputs import RequestOutput\n from vllm.sampling_params import SamplingParams\n-from vllm.sequence import (Logprob, SamplerOutput, Sequence, SequenceGroup,\n+from vllm.sequence import (SamplerOutput, Sequence, SequenceGroup,\n                            SequenceGroupOutput, SequenceOutput, SequenceStatus)\n-from vllm.transformers_utils.tokenizer import detokenize_incrementally\n from vllm.transformers_utils.tokenizer_group import (BaseTokenizerGroup,\n                                                      get_tokenizer_group)\n+from vllm.transformers_utils.detokenizer import Detokenizer\n from vllm.utils import Counter\n \n logger = init_logger(__name__)\n@@ -97,6 +97,7 @@ class LLMEngine:\n         self._verify_args()\n \n         self._init_tokenizer()\n+        self.detokenizer = Detokenizer(self.tokenizer)\n         self.seq_counter = Counter()\n \n         self.model_executor = executor_class(model_config, cache_config,\n@@ -153,7 +154,7 @@ class LLMEngine:\n         raise RuntimeError(\"LLMEngine should not be pickled!\")\n \n     def get_tokenizer(self) -> \"PreTrainedTokenizer\":\n-        return self.tokenizer.get_lora_tokenizer()\n+        return self.tokenizer.get_lora_tokenizer(None)\n \n     def get_tokenizer_for_seq(self,\n                               sequence: Sequence) -> \"PreTrainedTokenizer\":\n@@ -370,13 +371,8 @@ class LLMEngine:\n         # Process prompt logprobs\n         prompt_logprobs = outputs.prompt_logprobs\n         if prompt_logprobs is not None:\n-            # We can pick any sequence for the prompt.\n-            seq = next(iter(seq_group.seqs_dict.values()))\n-            all_token_ids = seq.get_token_ids()\n-            for i, prompt_logprobs_for_token in enumerate(prompt_logprobs):\n-                self._decode_logprobs(seq, seq_group.sampling_params,\n-                                      prompt_logprobs_for_token,\n-                                      all_token_ids[:i])\n+            self.detokenizer.decode_prompt_logprobs_inplace(\n+                seq_group, prompt_logprobs)\n             seq_group.prompt_logprobs = prompt_logprobs\n \n         # Process samples\n@@ -420,7 +416,8 @@ class LLMEngine:\n             child_seqs.append((parent, parent))\n \n         for seq, _ in child_seqs:\n-            self._decode_sequence(seq, seq_group.sampling_params)\n+            self.detokenizer.decode_sequence_inplace(seq,\n+                                                     seq_group.sampling_params)\n             self._check_stop(seq, seq_group.sampling_params)\n \n         # Non-beam search case\n@@ -713,51 +710,6 @@ class LLMEngine:\n             time_e2e_requests=time_e2e_requests,\n         )\n \n-    def _decode_logprobs(self, seq: Sequence, prms: SamplingParams,\n-                         logprobs: Dict[int, Logprob],\n-                         all_input_ids: List[int]) -> None:\n-        if not logprobs:\n-            return\n-        for token_id, sample_logprob in logprobs.items():\n-            if (sample_logprob.decoded_token is None and token_id != -1):\n-                all_input_ids_with_logprob = all_input_ids[:-1] + [token_id]\n-                (_, new_text, prefix_offset,\n-                 read_offset) = detokenize_incrementally(\n-                     self.get_tokenizer_for_seq(seq),\n-                     all_input_ids=all_input_ids_with_logprob,\n-                     prev_tokens=seq.tokens,\n-                     prefix_offset=seq.prefix_offset,\n-                     read_offset=seq.read_offset,\n-                     skip_special_tokens=prms.skip_special_tokens,\n-                     spaces_between_special_tokens=prms.\n-                     spaces_between_special_tokens,\n-                 )\n-                sample_logprob.decoded_token = new_text\n-\n-    def _decode_sequence(self, seq: Sequence, prms: SamplingParams) -> None:\n-        \"\"\"Decodes the new token for a sequence.\"\"\"\n-        all_input_ids = seq.get_token_ids()\n-        self._decode_logprobs(seq, prms, seq.output_logprobs[-1],\n-                              all_input_ids)\n-\n-        (new_tokens, new_output_text, prefix_offset,\n-         read_offset) = detokenize_incrementally(\n-             self.get_tokenizer_for_seq(seq),\n-             all_input_ids=all_input_ids,\n-             prev_tokens=seq.tokens,\n-             prefix_offset=seq.prefix_offset,\n-             read_offset=seq.read_offset,\n-             skip_special_tokens=prms.skip_special_tokens,\n-             spaces_between_special_tokens=prms.spaces_between_special_tokens,\n-         )\n-        if seq.tokens is None:\n-            seq.tokens = new_tokens\n-        else:\n-            seq.tokens.extend(new_tokens)\n-        seq.prefix_offset = prefix_offset\n-        seq.read_offset = read_offset\n-        seq.output_text += new_output_text\n-\n     def _check_stop(self, seq: Sequence,\n                     sampling_params: SamplingParams) -> None:\n         \"\"\"Stop the finished sequences.\"\"\"\ndiff --git a/vllm/transformers_utils/detokenizer.py b/vllm/transformers_utils/detokenizer.py\nnew file mode 100644\nindex 000000000..1f322b367\n--- /dev/null\n+++ b/vllm/transformers_utils/detokenizer.py\n@@ -0,0 +1,155 @@\n+from typing import List, Dict, Optional\n+from transformers import PreTrainedTokenizer\n+from vllm.sequence import Sequence, Logprob, SequenceGroup, SamplingParams\n+from vllm.transformers_utils.tokenizer import (detokenize_incrementally,\n+                                               convert_prompt_ids_to_tokens)\n+from vllm.transformers_utils.tokenizer_group.base_tokenizer_group import (\n+    BaseTokenizerGroup)\n+\n+# Used eg. for marking rejected tokens in spec decoding.\n+INVALID_TOKEN_ID = -1\n+\n+\n+class Detokenizer:\n+    \"\"\"Provides methods to decode the output of a model into text.\"\"\"\n+\n+    def __init__(self, tokenizer_group: BaseTokenizerGroup):\n+        self.tokenizer_group = tokenizer_group\n+\n+    def get_tokenizer_for_seq(self,\n+                              sequence: Sequence) -> \"PreTrainedTokenizer\":\n+        \"\"\"Returns the HF tokenizer to use for a given sequence.\"\"\"\n+        return self.tokenizer_group.get_lora_tokenizer(sequence.lora_request)\n+\n+    def decode_prompt_logprobs_inplace(\n+            self, seq_group: SequenceGroup,\n+            prompt_logprobs: List[Optional[Dict[int, Logprob]]]) -> None:\n+        \"\"\"Decodes the logprobs for the prompt of a sequence group.\n+\n+        Args:\n+            seq_group: The sequence group to decode.\n+            prompt_logprobs: The logprobs to decode.\n+        \n+        Returns:\n+            The prompt logprobs with the decoded tokens.\n+        \"\"\"\n+        prms = seq_group.sampling_params\n+        # We can pick any sequence for the prompt.\n+        seq = next(iter(seq_group.seqs_dict.values()))\n+        # Only prompt, without the generated token.\n+        all_token_ids = seq.get_token_ids()\n+        prompt_token_ids = all_token_ids[:-1]\n+        tokenizer = self.get_tokenizer_for_seq(seq)\n+        prefix_offset = 0\n+        read_offset = 0\n+        next_iter_prefix_offset = 0\n+        next_iter_read_offset = 0\n+        next_iter_tokens = []\n+        prev_tokens = None\n+\n+        for token_position, prompt_logprobs_for_token in enumerate(\n+                prompt_logprobs):\n+            if not prompt_logprobs_for_token:\n+                continue\n+            for token_id, sample_logprob in prompt_logprobs_for_token.items():\n+                if (sample_logprob.decoded_token is None\n+                        and token_id != INVALID_TOKEN_ID):\n+                    prompt_token_ids_with_token = (\n+                        prompt_token_ids[:token_position] + [token_id])\n+                    (new_tokens, new_text, new_prefix_offset,\n+                     new_read_offset) = detokenize_incrementally(\n+                         tokenizer=tokenizer,\n+                         all_input_ids=prompt_token_ids_with_token,\n+                         prev_tokens=prev_tokens,\n+                         prefix_offset=prefix_offset,\n+                         read_offset=read_offset,\n+                         skip_special_tokens=prms.skip_special_tokens,\n+                         spaces_between_special_tokens=prms.\n+                         spaces_between_special_tokens,\n+                     )\n+\n+                    sample_logprob.decoded_token = new_text\n+\n+                    # Use the offsets & prev tokens corresponding to\n+                    # real tokens to ensure detokenization is consistent\n+                    # actual with prompt.\n+                    if token_id == all_token_ids[token_position]:\n+                        next_iter_prefix_offset = new_prefix_offset\n+                        next_iter_read_offset = new_read_offset\n+                        next_iter_tokens = new_tokens\n+\n+            # Advance to the next token position.\n+            prefix_offset = next_iter_prefix_offset\n+            read_offset = next_iter_read_offset\n+            if prev_tokens is None:\n+                prev_tokens = next_iter_tokens\n+            else:\n+                prev_tokens.extend(next_iter_tokens)\n+\n+    def decode_sequence_inplace(self, seq: Sequence,\n+                                prms: SamplingParams) -> None:\n+        \"\"\"Decodes the new token for a sequence. In-place operation.\n+\n+        Args:\n+            seq: The sequence to decode.\n+            prms: The sampling parameters used to generate the sequence.\n+        \"\"\"\n+        all_input_ids = seq.get_token_ids()\n+        token_id_generated_this_iteration = all_input_ids[-1]\n+        tokenizer = self.get_tokenizer_for_seq(seq)\n+\n+        # Convert prompt token IDs to tokens if necessary.\n+        # Do it here so that we don't have to repeat this\n+        # computation for each logprob.\n+        if seq.tokens is None:\n+            (seq.tokens, seq.prefix_offset,\n+             seq.read_offset) = convert_prompt_ids_to_tokens(\n+                 tokenizer=tokenizer,\n+                 prompt_ids=all_input_ids[:-1],\n+                 skip_special_tokens=prms.skip_special_tokens,\n+             )\n+\n+        (new_tokens, new_decoded_token_text, prefix_offset,\n+         read_offset) = detokenize_incrementally(\n+             tokenizer=tokenizer,\n+             all_input_ids=all_input_ids,\n+             prev_tokens=seq.tokens,\n+             prefix_offset=seq.prefix_offset,\n+             read_offset=seq.read_offset,\n+             skip_special_tokens=prms.skip_special_tokens,\n+             spaces_between_special_tokens=prms.spaces_between_special_tokens,\n+         )\n+\n+        # Decode logprobs\n+        logprobs = seq.output_logprobs[-1]\n+        if logprobs:\n+            previous_tokens = all_input_ids[:-1]\n+            for token_id, sample_logprob in logprobs.items():\n+                # If the token was generated this iteration,\n+                # use the provided text.\n+                if token_id == token_id_generated_this_iteration:\n+                    sample_logprob.decoded_token = new_decoded_token_text\n+                    continue\n+\n+                if (sample_logprob.decoded_token is None\n+                        and token_id != INVALID_TOKEN_ID):\n+                    all_input_ids_with_logprob = previous_tokens + [token_id]\n+                    (_, new_text, _, _) = detokenize_incrementally(\n+                        tokenizer=tokenizer,\n+                        all_input_ids=all_input_ids_with_logprob,\n+                        prev_tokens=seq.tokens,\n+                        prefix_offset=seq.prefix_offset,\n+                        read_offset=seq.read_offset,\n+                        skip_special_tokens=prms.skip_special_tokens,\n+                        spaces_between_special_tokens=prms.\n+                        spaces_between_special_tokens,\n+                    )\n+                    sample_logprob.decoded_token = new_text\n+\n+        if seq.tokens is None:\n+            seq.tokens = new_tokens\n+        else:\n+            seq.tokens.extend(new_tokens)\n+        seq.prefix_offset = prefix_offset\n+        seq.read_offset = read_offset\n+        seq.output_text += new_decoded_token_text\ndiff --git a/vllm/transformers_utils/tokenizer.py b/vllm/transformers_utils/tokenizer.py\nindex f7a1a19a8..eebdacc49 100644\n--- a/vllm/transformers_utils/tokenizer.py\n+++ b/vllm/transformers_utils/tokenizer.py\n@@ -158,6 +158,34 @@ def _convert_tokens_to_string_with_added_encoders(\n         return \"\".join(sub_texts)\n \n \n+# 5 is an arbitrary value that should work for all\n+# tokenizers (bigger = more conservative).\n+INITIAL_INCREMENTAL_DETOKENIZATION_OFFSET = 5\n+\n+\n+def convert_prompt_ids_to_tokens(\n+    tokenizer: Union[PreTrainedTokenizer, PreTrainedTokenizerFast],\n+    prompt_ids: List[int],\n+    skip_special_tokens: bool = False,\n+) -> Tuple[List[str], int, int]:\n+    \"\"\"Converts the prompt ids to tokens and returns the tokens and offsets\n+    for incremental detokenization.\n+\n+    Note that not all tokens are converted to strings. Only the tokens that\n+    are necessary for incremental detokenization are converted to strings.\n+    \"\"\"\n+    # Offset a little more in case we have special tokens.\n+    prefix_offset = max(\n+        len(prompt_ids) - INITIAL_INCREMENTAL_DETOKENIZATION_OFFSET - 2, 0)\n+    # We do not need to convert the whole prompt to tokens.\n+    new_tokens = tokenizer.convert_ids_to_tokens(\n+        prompt_ids[prefix_offset:], skip_special_tokens=skip_special_tokens)\n+    prefix_offset = max(\n+        len(new_tokens) - INITIAL_INCREMENTAL_DETOKENIZATION_OFFSET, 0)\n+    read_offset = len(new_tokens)\n+    return new_tokens, prefix_offset, read_offset\n+\n+\n # Based on\n # https://github.com/huggingface/text-generation-inference/blob/v0.9.4/server/text_generation_server/models/model.py#L62C9-L62C15\n # under Apache 2.0 license\n@@ -165,31 +193,53 @@ def detokenize_incrementally(\n     tokenizer: Union[PreTrainedTokenizer, PreTrainedTokenizerFast],\n     all_input_ids: List[int],\n     prev_tokens: Optional[List[str]],\n-    prefix_offset: int = 0,\n-    read_offset: int = 0,\n+    prefix_offset: int,\n+    read_offset: int,\n     skip_special_tokens: bool = False,\n     spaces_between_special_tokens: bool = True,\n ) -> Tuple[List[str], str, int, int]:\n+    \"\"\"Detokenizes the input ids incrementally and returns the new tokens\n+    and the new text.\n+\n+    If `prev_tokens` is None, this function will convert the input ids to\n+    tokens and return the tokens and the new text. Otherwise, it will return the\n+    new tokens and the new text.\n+\n+    This function will also return the new prefix offset and the new read\n+    offset to be used in the next iteration.\n+\n+    The offsets are necessary to defeat cleanup algorithms in the decode which\n+    decide to add a space or not depending on the surrounding ids.\n+\n+    Args:\n+        tokenizer: The tokenizer to use.\n+        all_input_ids: The input ids. The last id is the new token id.\n+        prev_tokens: The previous tokens. If None, this function will convert\n+            the input ids to tokens and return the tokens and the new text.\n+        prefix_offset: The prefix offset.\n+        read_offset: The read offset.\n+        skip_special_tokens: Whether to skip special tokens.\n+        spaces_between_special_tokens: Whether to add spaces between special\n+            tokens.\n+    \"\"\"\n     new_token_id = all_input_ids[-1]\n     # This is the first iteration for this sequence\n-    if prev_tokens is None:\n-        new_tokens = tokenizer.convert_ids_to_tokens(\n-            all_input_ids, skip_special_tokens=skip_special_tokens)\n-        output_tokens = new_tokens\n-        # 5 is an arbitrary value that should work for all\n-        # tokenizers (bigger = more conservative).\n-        # Subtract 1 extra to account for the generated token.\n-        prefix_offset = max(len(output_tokens) - 6, 0)\n-        # If the first new token is a special token, we can't skip 1 extra token\n-        if skip_special_tokens and new_token_id in tokenizer.all_special_ids:\n-            read_offset = max(len(output_tokens), 0)\n-        else:\n-            read_offset = max(len(output_tokens) - 1, 0)\n-    else:\n-        # Put new_token_id in a list so skip_special_tokens is respected\n-        new_tokens = tokenizer.convert_ids_to_tokens(\n-            [new_token_id], skip_special_tokens=skip_special_tokens)\n-        output_tokens = prev_tokens + new_tokens\n+    is_first_iter = prev_tokens is None\n+    if is_first_iter:\n+        (prev_tokens, prefix_offset,\n+         read_offset) = convert_prompt_ids_to_tokens(\n+             tokenizer,\n+             all_input_ids[:-1],\n+             skip_special_tokens=skip_special_tokens)\n+\n+    # Put new_token_id in a list so skip_special_tokens is respected\n+    new_tokens = tokenizer.convert_ids_to_tokens(\n+        [new_token_id], skip_special_tokens=skip_special_tokens)\n+    output_tokens = prev_tokens + new_tokens\n+\n+    # If this is the first iteration, return all tokens.\n+    if is_first_iter:\n+        new_tokens = output_tokens\n \n     # The prefix text is necessary only to defeat cleanup algorithms in\n     # the decode which decide to add a space or not depending on the", "apis": ["vllm.LLMEngine", "vllm.transformers_utils.detokenizer.Detokenizer"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/detokenizer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/detokenizer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/tokenizer.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit introduces a new Detokenizer module and refactors existing engine and tokenizer code to use it, thereby improving the incremental detokenization and logprob decoding processes. The changes affect non-test source code (e.g., vllm/engine/llm_engine.py, vllm/transformers_utils/detokenizer.py, and vllm/transformers_utils/tokenizer.py) and are aimed at optimizing the existing detokenization performance for inference, especially for prefill scenarios. This is not a simple refactoring or bug fixâ€”it specifically targets performance improvements in the core API running on CPU.", "llm_api_reason": "This commit refactors and enhances the detokenization workflow. A new Detokenizer class is introduced in the transformers_utils/detokenizer module to centralize and improve incremental decoding of token outputs. The LLMEngine has been updated to use this Detokenizer (for example, replacing direct calls to detokenize_incrementally when decoding prompt logprobs and generated tokens) and its integration is verified through newly added tests for decoding both prompt and sequence logprobs. These changes optimize detokenization performance and improve test coverage for the decoding logic."}
{"commit_hash": "cf2f084d56a1293cb08da2393984cdc7685ac019", "pr_url": "https://github.com/vllm-project/vllm/pull/3279", "pr_date": "2024-03-22", "timeline_text": "Copy link Member tdoublep commented Mar 8, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . We have been benchmarking vLLM internally using a synthetic workload generator that has been fitted to mimic our production workloads. It stresses the inference server using a varying number of concurrent users, all users send requests that are drawn uniformly from a heterogeneous set of requests with different prompt lengths and number of generated tokens. We have found that for these workloads, vLLM has extremely low TTFT (time to first token) but has relatively high ITL (inter-token latency). An in-depth analysis seems to show that vLLM tends to schedule prompts as soon as possible, resulting in very small prompt batches, which are processed very quickly, but end up starving the decoding phase. This PR adds a new optional feature --scheduler-use-delay which, if enabled, creates an artificial delay before scheduling prompts. The delay is determined dynamically based on the time to perform the last prompt step. This delay allows the waiting queue to fill up with more requests. This gives the opportunity to make larger prompt batches, but due to the heterogeneous nature of the workload, we then hit issues related to padding overhead. It is thus beneficial to combine this scheduler delay with the --scheduler-policy=reorder feature from #2357 which sorts the waiting queue by sequence length. This allows us to create much larger prompt batches whilst staying with the padding limits, and leads to significant improvements in terms of ITL performance. This ITL improvement comes at the expense of TTFT performance, since (a) we are applying an artificial delay before scheduling prompts and (b) we are now processing larger batches which take longer to process. Different use-cases may have a preference towards either metric, which is why we feel this makes sense as an optional feature for now. Benchmarking results (labels on each point indicates the number of concurrent users): Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 3 njhill, ywang96, and zhuohan123 reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions jvlunteren and others added 2 commits March 7, 2024 18:35 Implement dynamic scheduler delay â€¦ 0d0d540 Co-authored-by: Thomas Parnell <tpa@zurich.ibm.com> SchedulerConfig: add default value for use_delay 75b7f57 Copy link Collaborator robertgshaw2-redhat commented Mar 8, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Take a look also at the chunked prefill efforts to address this #3106 ðŸ‘ 1 tdoublep reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author tdoublep commented Mar 8, 2024 @robertgshaw2-neuralmagic Thanks, and agreed: chunked prefill may eventually solve this problem in a different way. We hope that this relatively simple, optional, change can be used to improve performance in the meantime. ðŸ‘ 4 robertgshaw2-redhat, mgoin, njhill, and ywang96 reacted with thumbs up emoji All reactions ðŸ‘ 4 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member ywang96 commented Mar 8, 2024 This delay allows the waiting queue to fill up with more requests. This might affect #3168 and IMO it's worth thinking about how to integrate these control changes with each other All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Yard1 commented Mar 8, 2024 @tdoublep We were planning to upstream something similar, but instead of time we used number of decode iterations (\"schedule prefill iteration only after N decode iterations have been completed or there are no running sequences\"). We believe that this scheme is more generic and easier to implement. I'd be happy to make a PR early next week, if you are interested in trying that out. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member njhill commented Mar 8, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @Yard1 could you elaborate on \"more generic and easier to implement\"? Isn't it completely generic and fairly trivial to implement in either case? We found the adaptive time-based approach to work very well, and it makes more sense to me intuitively at least. The goal is to prevent prefills from starving decode progress - the enforced delay is some fraction of the duration of the last prefill and so equivalent to saying that not more than say 50% of time can be spent in prefill. We chose this min delay to be half the last prefill time which ensures at most 66% of time is spent in prefill. Of course like in your case, the min delay only applies while there are still running sequences. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Yard1 commented Mar 8, 2024 Hmm I now see the delay is dynamic. I think thinking in terms of model iterations is simpler, but I suppose that this approach should be just as good. @tdoublep would it be possible for you to open source your benchmarking tool? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author tdoublep commented Mar 11, 2024 @Yard1 Yes - we do plan to open-source the benchmarking tool. We are working through that process internally at the moment. ðŸ‘ 3 Yard1, ywang96, and richardliaw reacted with thumbs up emoji All reactions ðŸ‘ 3 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor sh1ng commented Mar 11, 2024 @tdoublep Which value of --scheduler-use-delay combined with --scheduler_reorder_window do you use? I believe the sum of them must be a constant. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author tdoublep commented Mar 12, 2024 @sh1ng --scheduler-use-delay is a boolean option. If set to true, we apply a delay equal to half of the previous time for a prompt step (e.g., the delay is adaptive based on the workload). For the --scheduler_reorder_window we used a very large value (1000) to ensure that all of the requests in the waiting queue are sorted. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author tdoublep commented Mar 15, 2024 Based on the discussion here it sounds like sorting the requests in the waiting queue will no longer be necessary once we merge #3236 which effectively removing padding constraints via 1D query. We have run additional experiments to compare the performance when using 1D query from #3236 , as well as to evaluate the performance if we enable the dynamic delay (from this PR) in combination with 1D query: Conclusion : combining dynamic scheduler delay ( #3279 ) with 1D query ( #3236 ) is even more effective than combining it with sorting requests by length ( #2357 ). ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tdoublep added 4 commits March 20, 2024 15:37 Add test for scheduler_use_delay a7b6735 move use_delay test to end 8f15973 Merge branch 'main' into scheduler-delay 8ef047a code formatting fd1e5da Copy link Member Author tdoublep commented Mar 20, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Update: Added a test case in test_scheduler.py to cover use_delay option. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tdoublep mentioned this pull request Mar 20, 2024 [1/n][Chunked Prefill] Refactor input query shapes #3236 Merged Resolve some conflicts with changes on main 69cda2a Copy link Member Author tdoublep commented Mar 21, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Now that 1D query has been merged, the changes from this PR can be effective when applied on top of main branch. Here is latest round of benchmarking results. I've also included performance data collected using TGIS (our fork of TGI) as an additional reference point: Some conclusions here: We can see that introducing the scheduler delay dramatically improves the ITL when the inference server is under stress  (>2x in some cases), and helps to close the performance gap to TGIS, which is better than vLLM in terms of ITL. The delay has the effect of processing larger batches of prompts, which worsens the TTFT a bit. However, we can see that the TTFT from vLLM after this change is still significantly better than TGIS (>10x in some cases). ðŸ‘ 1 rkooo567 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 reviewed Mar 21, 2024 View reviewed changes vllm/core/scheduler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tdoublep added 3 commits March 21, 2024 18:59 Factor delay logic into separate function ae28c43 Merge branch 'main' into scheduler-delay 2d2b8e0 Remove print in test 99b0d7d Copy link Collaborator Yard1 commented Mar 21, 2024 Looks good. I think it would be even better if we didn't hardcode it to 0.5. I think we could make the argument a float, and if it is <=0, we don't apply the delay. ðŸ‘ 2 tdoublep and njhill reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 reviewed Mar 21, 2024 View reviewed changes vllm/core/scheduler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tdoublep added 2 commits March 21, 2024 19:25 Add some comments e1e3408 Changed use_delay (bool) to delay_factor (float) a114e74 Copy link Member Author tdoublep commented Mar 21, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Looks good. I think it would be even better if we didn't hardcode it to 0.5. I think we could make the argument a float, and if it is <=0, we don't apply the delay. @Yard1 Good idea - there is no reason to assume that 0.5 an optimum for all scenarios. I've updated the code accordingly. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator richardliaw commented Mar 22, 2024 @Yard1 are you approving this PR? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 approved these changes Mar 22, 2024 View reviewed changes Yard1 merged commit cf2f084 into vllm-project : main Mar 22, 2024 tdoublep deleted the scheduler-delay branch March 22, 2024 20:10 Copy link Member Author tdoublep commented Mar 22, 2024 @Yard1 thanks for the review and helpful discussion and suggestions. ðŸš€ 1 Yard1 reacted with rocket emoji All reactions ðŸš€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator rkooo567 commented Mar 22, 2024 @tdoublep Does vllm have a doc about configuration? Feel like it is worth adding it there if there is. I.e., there are config setttings to optimize throughput over latency, TTFT over ITL or the other way around. But it seems like things are not that well documented ðŸ‘€ 1 tdene reacted with eyes emoji All reactions ðŸ‘€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author tdoublep commented Mar 25, 2024 @rkooo567 I agree it would be good to have documentation like that. The closest thing I can find the the developer documentation, e.g.: https://docs.vllm.ai/en/latest/dev/engine/llm_engine.html Perhaps we should consider adding some more pages there to documentation the ModelConfig , SchedulerConfig etc. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator rkooo567 commented Mar 25, 2024 I see. Yeah +1 we need better doc with configs, but it seems like there's no holistic page that explains this. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . dtrifiro mentioned this pull request May 15, 2024 bump ubi base image tag opendatahub-io/vllm#24 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:22", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, TTFT | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:49:22", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "Dynamic scheduler delay to improve ITL performance  (#3279)", "commit_message": "Dynamic scheduler delay to improve ITL performance  (#3279)\n\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>", "commit_date": "2024-03-22T12:28:14-07:00", "files_changed": ["tests/core/test_scheduler.py", "vllm/config.py", "vllm/core/scheduler.py", "vllm/engine/arg_utils.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 0, "num_files": 4, "num_hunks": 12, "num_edited_lines": 74, "num_non_test_edited_lines": 40, "commit_year": 2024}, "diff_text": "diff --git a/tests/core/test_scheduler.py b/tests/core/test_scheduler.py\nindex 397101fa8..4a690e24e 100644\n--- a/tests/core/test_scheduler.py\n+++ b/tests/core/test_scheduler.py\n@@ -1,5 +1,6 @@\n from typing import List\n import pytest  # noqa\n+import time\n \n from vllm.config import CacheConfig, SchedulerConfig\n from vllm.core.scheduler import Scheduler\n@@ -168,3 +169,36 @@ def test_scheduler_max_seqs():\n     # and one is prompting.\n     _, out = scheduler.schedule()\n     assert set(out.scheduled_seq_groups) == set([all_seq_groups[1]])\n+\n+\n+def test_scheduler_delay_factor():\n+\n+    block_size = 4\n+    scheduler_config = SchedulerConfig(100, 64, 16, delay_factor=0.5)\n+    cache_config = CacheConfig(block_size, 1.0, 1, \"auto\")\n+    cache_config.num_cpu_blocks = 8\n+    cache_config.num_gpu_blocks = 8\n+    scheduler = Scheduler(scheduler_config, cache_config, None)\n+\n+    # schedule first prompt\n+    _, seq_group = create_dummy_prompt(\"0\", prompt_length=block_size)\n+    scheduler.add_seq_group(seq_group)\n+    seq_group_meta, out = scheduler.schedule()\n+    assert out.prompt_run\n+    assert seq_group_meta[0].request_id == '0'\n+\n+    # wait for a second before scheduling next prompt\n+    time.sleep(1)\n+    _, seq_group = create_dummy_prompt(\"1\", prompt_length=block_size)\n+    scheduler.add_seq_group(seq_group)\n+\n+    # second prompt should *not* be scheduled\n+    seq_group_meta, out = scheduler.schedule()\n+    assert not out.prompt_run\n+    assert seq_group_meta[0].request_id == '0'\n+\n+    # wait for more than 0.5 second and try again\n+    time.sleep(0.6)\n+    seq_group_meta, out = scheduler.schedule()\n+    assert out.prompt_run\n+    assert seq_group_meta[0].request_id == '1'\ndiff --git a/vllm/config.py b/vllm/config.py\nindex 6dfb51586..2003563e4 100644\n--- a/vllm/config.py\n+++ b/vllm/config.py\n@@ -517,6 +517,8 @@ class SchedulerConfig:\n             iteration.\n         max_model_len: Maximum length of a sequence (including prompt\n             and generated text).\n+        delay_factor: Apply a delay (of delay factor multiplied by previous\n+            prompt latency) before scheduling next prompt.\n     \"\"\"\n \n     def __init__(\n@@ -524,6 +526,7 @@ class SchedulerConfig:\n         max_num_batched_tokens: Optional[int],\n         max_num_seqs: int,\n         max_model_len: int,\n+        delay_factor: float = 0.0,\n     ) -> None:\n         if max_num_batched_tokens is not None:\n             self.max_num_batched_tokens = max_num_batched_tokens\n@@ -533,6 +536,7 @@ class SchedulerConfig:\n             self.max_num_batched_tokens = max(max_model_len, 2048)\n         self.max_num_seqs = max_num_seqs\n         self.max_model_len = max_model_len\n+        self.delay_factor = delay_factor\n         self._verify_args()\n \n     def _verify_args(self) -> None:\ndiff --git a/vllm/core/scheduler.py b/vllm/core/scheduler.py\nindex be55e8520..4bd0ef360 100644\n--- a/vllm/core/scheduler.py\n+++ b/vllm/core/scheduler.py\n@@ -103,6 +103,13 @@ class Scheduler:\n         # Sequence groups in the SWAPPED state.\n         self.swapped: Deque[SequenceGroup] = deque()\n \n+        # Time at previous scheduling step\n+        self.prev_time = 0.0\n+        # Did we schedule a prompt at previous step?\n+        self.prev_prompt = False\n+        # Latency of the last prompt step\n+        self.last_prompt_latency = 0.0\n+\n     @property\n     def lora_enabled(self) -> bool:\n         return bool(self.lora_config)\n@@ -179,7 +186,7 @@ class Scheduler:\n             # are added to the back.\n             leftover_waiting_sequences = deque()\n             num_batched_tokens = 0\n-            while self.waiting:\n+            while self._passed_delay(now) and self.waiting:\n                 seq_group = self.waiting[0]\n                 waiting_seqs = seq_group.get_seqs(\n                     status=SequenceStatus.WAITING)\n@@ -246,6 +253,7 @@ class Scheduler:\n             self.waiting.extendleft(leftover_waiting_sequences)\n \n             if scheduled or ignored_seq_groups:\n+                self.prev_prompt = True\n                 scheduler_outputs = SchedulerOutputs(\n                     scheduled_seq_groups=scheduled,\n                     prompt_run=True,\n@@ -491,3 +499,19 @@ class Scheduler:\n \n     def mark_blocks_as_computed(self, seq_group: SequenceGroup):\n         self.block_manager.mark_blocks_as_computed(seq_group)\n+\n+    def _passed_delay(self, now: float) -> bool:\n+        if self.prev_prompt:\n+            self.last_prompt_latency = now - self.prev_time\n+        self.prev_time, self.prev_prompt = now, False\n+        # Delay scheduling prompts to let waiting queue fill up\n+        if self.scheduler_config.delay_factor > 0 and self.waiting:\n+            earliest_arrival_time = min(\n+                [e.metrics.arrival_time for e in self.waiting])\n+            passed_delay = (\n+                (now - earliest_arrival_time) >\n+                (self.scheduler_config.delay_factor * self.last_prompt_latency)\n+                or not self.running)\n+        else:\n+            passed_delay = True\n+        return passed_delay\ndiff --git a/vllm/engine/arg_utils.py b/vllm/engine/arg_utils.py\nindex 94c80f428..2070686ea 100644\n--- a/vllm/engine/arg_utils.py\n+++ b/vllm/engine/arg_utils.py\n@@ -51,6 +51,7 @@ class EngineArgs:\n     max_cpu_loras: Optional[int] = None\n     device: str = 'auto'\n     ray_workers_use_nsight: bool = False\n+    scheduler_delay_factor: float = 0.0\n \n     def __post_init__(self):\n         if self.tokenizer is None:\n@@ -305,6 +306,12 @@ class EngineArgs:\n                             default=EngineArgs.device,\n                             choices=[\"auto\", \"cuda\", \"neuron\"],\n                             help='Device type for vLLM execution.')\n+        parser.add_argument(\n+            '--scheduler-delay-factor',\n+            type=float,\n+            default=EngineArgs.scheduler_delay_factor,\n+            help='Apply a delay (of delay factor multiplied by previous'\n+            'prompt latency) before scheduling next prompt.')\n         return parser\n \n     @classmethod\n@@ -342,7 +349,8 @@ class EngineArgs:\n             ), self.ray_workers_use_nsight)\n         scheduler_config = SchedulerConfig(self.max_num_batched_tokens,\n                                            self.max_num_seqs,\n-                                           model_config.max_model_len)\n+                                           model_config.max_model_len,\n+                                           self.scheduler_delay_factor)\n         lora_config = LoRAConfig(\n             max_lora_rank=self.max_lora_rank,\n             max_loras=self.max_loras,", "apis": ["vllm.config.SchedulerConfig", "vllm.core.scheduler.Scheduler.schedule", "vllm.engine.arg_utils.EngineArgs"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/scheduler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/scheduler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/config.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/config.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/config.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/arg_utils.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit introduces a mechanism to delay scheduling prompts based on previous prompt latency by adding a delay_factor. It modifies non-test files (vllm/config.py, vllm/core/scheduler.py, vllm/engine/arg_utils.py) in a non-trivial way that adjusts the scheduler's behavior to allow the waiting queue to fill up, which should improve overall latency performance. Although a test file is also modified, the core source changes and the commit's message make clear that its goal is to improve ITL performance, and it is not merely a bug fix, simple refactor, or adding a new feature unrelated to performance. The changes affect a high-level scheduling API, impacting CPU performance and are testable on general hardware without reliance on GPUs.", "llm_api_reason": "This commit introduces a new dynamic delay factor to the scheduler to improve inter-token latency performance. The changes add a new â€œdelay_factorâ€ parameter to the SchedulerConfig allowing users to specify that the scheduler should wait a configurable fraction (multiplied by the latency of the previous prompt) before scheduling the next prompt. In the scheduler implementation, new member variables (prev_time, prev_prompt, last_prompt_latency) and a helper method (_passed_delay) have been added to control when a new prompt is allowed. Furthermore, the EngineArgs CLI parser is updated to accept a new commandâ€line argument (--scheduler-delay-factor) that passes the delay factor to the SchedulerConfig. The tests have been extended with a new test to check that the delay behaves as expected."}
{"commit_hash": "9474e89ba4ecae253b585eb6b3e1d85f4e108f01", "pr_url": "https://github.com/vllm-project/vllm/pull/3357", "pr_date": null, "timeline_text": "Copy link Contributor ElizaWszola commented Mar 12, 2024 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . The performance of block allocator went down after implementing automatic prefix caching, even when running with prefix caching disabled. This pr brings back parts of the old code and regains some of the lost performance in the scenario with disabled prefix caching. Benchmarked with: python benchmark_throughput_cache.py --backend vllm --model huggyllama/llama-7b --dataset ../data/ShareGPT_V3_unfiltered_cleaned_split.json --num-prompts 2000 Performance before introducing automatic prefix caching (commit baee28c ): Throughput: 10.37 requests/s, 5062.42 tokens/s Throughput: 10.46 requests/s, 5102.27 tokens/s Throughput: 10.47 requests/s, 5107.30 tokens/s Throughput: 10.48 requests/s, 5113.97 tokens/s Throughput: 10.53 requests/s, 5137.21 tokens/s Throughput: 10.54 requests/s, 5145.38 tokens/s Throughput: 10.56 requests/s, 5153.24 tokens/s Throughput: 10.57 requests/s, 5157.54 tokens/s Throughput: 10.63 requests/s, 5187.32 tokens/s Throughput: 10.65 requests/s, 5198.19 tokens/s Performance after introducing changes in this PR to commit ce4f5a2 : Throughput: 10.40 requests/s, 5076.05 tokens/s Throughput: 10.53 requests/s, 5137.97 tokens/s Throughput: 10.57 requests/s, 5156.04 tokens/s Throughput: 10.60 requests/s, 5173.07 tokens/s Throughput: 10.61 requests/s, 5177.02 tokens/s Throughput: 10.62 requests/s, 5179.91 tokens/s Throughput: 10.63 requests/s, 5186.06 tokens/s Throughput: 10.63 requests/s, 5186.63 tokens/s Throughput: 10.64 requests/s, 5193.72 tokens/s Throughput: 10.67 requests/s, 5207.76 tokens/s (OLD) Benchmark results (10 runs each): Performance before introducing automatic prefix caching (commit baee28c ): Throughput: 10.15 requests/s, 4909.50 tokens/s Throughput: 10.17 requests/s, 4918.22 tokens/s Throughput: 10.20 requests/s, 4936.93 tokens/s Throughput: 10.23 requests/s, 4949.76 tokens/s Throughput: 10.22 requests/s, 4945.64 tokens/s Throughput: 10.27 requests/s, 4967.08 tokens/s Throughput: 10.28 requests/s, 4971.52 tokens/s Throughput: 10.29 requests/s, 4980.92 tokens/s Throughput: 10.29 requests/s, 4976.94 tokens/s Throughput: 10.30 requests/s, 4982.69 tokens/s Performance after introducing automatic prefix caching (commit ce4f5a2 ): Throughput: 9.91 requests/s, 4795.14 tokens/s Throughput: 9.98 requests/s, 4830.01 tokens/s Throughput: 9.99 requests/s, 4832.00 tokens/s Throughput: 10.00 requests/s, 4839.62 tokens/s Throughput: 10.03 requests/s, 4851.13 tokens/s Throughput: 10.06 requests/s, 4868.87 tokens/s Throughput: 10.07 requests/s, 4873.87 tokens/s Throughput: 10.07 requests/s, 4872.51 tokens/s Throughput: 10.08 requests/s, 4876.18 tokens/s Throughput: 10.08 requests/s, 4877.26 tokens/s Performance after introducing changes in this PR to commit ce4f5a2 : Throughput: 10.07 requests/s, 4873.42 tokens/s Throughput: 10.17 requests/s, 4919.84 tokens/s Throughput: 10.18 requests/s, 4923.71 tokens/s Throughput: 10.18 requests/s, 4925.56 tokens/s Throughput: 10.19 requests/s, 4928.09 tokens/s Throughput: 10.20 requests/s, 4937.20 tokens/s Throughput: 10.21 requests/s, 4942.21 tokens/s Throughput: 10.21 requests/s, 4938.38 tokens/s Throughput: 10.21 requests/s, 4940.22 tokens/s Throughput: 10.22 requests/s, 4946.95 tokens/s Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 cadedaniel and rkooo567 reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions ElizaWszola added 8 commits March 6, 2024 13:10 Auto prefix performace fixes 2d2f5bb Small change to no-prefix-caching hashing 9468ce8 Pre-allocate token block list in no-cache scenario 83cd6ed Refactor block manager 4dd06e5 Clean up evictor, fix 20b7db8 Sage's feedback 690cc5e Merge branch 'upstream-main' into auto-prefix-perf 6e50143 format evictor 723e56b Copy link Member zhuohan123 commented Mar 12, 2024 cc @cadedaniel ðŸ‘ 1 cadedaniel reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Fix tests fc9aebb cadedaniel reviewed Mar 13, 2024 View reviewed changes Copy link Collaborator cadedaniel left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the PR! I am concerned that our test coverage of the block manager is not sufficient to allow for refactors w/o good tests. There's a few branches in this PR that are only for prefix caching, which adds a lot of complexity. Could you comment on what causes the performance degradation / improvement? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions cadedaniel self-assigned this Mar 13, 2024 zhuohan123 self-assigned this Mar 14, 2024 zhuohan123 reviewed Mar 14, 2024 View reviewed changes Copy link Member zhuohan123 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Some random small comments. Will review in more detail! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager.py Outdated def free(self, block: PhysicalTokenBlock) -> None: pass @abstractproperty Copy link Member zhuohan123 Mar 13, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Should be abstract_method Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block_manager.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block_manager.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . ElizaWszola and others added 3 commits March 14, 2024 14:23 Update vllm/core/block_manager.py â€¦ c2f74ef Co-authored-by: Zhuohan Li <zhuohan123@gmail.com> Update vllm/core/block_manager.py â€¦ 17ffc2d Co-authored-by: Zhuohan Li <zhuohan123@gmail.com> Update vllm/core/block_manager.py â€¦ c383bac Co-authored-by: Zhuohan Li <zhuohan123@gmail.com> Copy link Contributor Author ElizaWszola commented Mar 14, 2024 @cadedaniel I can think up some tests to add. Is there anything that you would like to be tested specifically? As for the performance gap that still exists, I'm not sure about it because the non-cached codepath is currently very similar to what had been there before the original auto prefix commit. I'm still poking around. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Feedback, one more small modification eaa1fb3 Copy link Contributor Author ElizaWszola commented Mar 14, 2024 Good news, I've found a small bug and redid some of the benchmarks: the performance looks similar to the old one, but I'd be happy if more people can verify. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Merge branch 'upstream-main' into auto-prefix-perf 29f9414 ElizaWszola mentioned this pull request Mar 15, 2024 [PREFIX CACHING FOLLOW UP] OrderedDict-based evictor #3431 Merged ElizaWszola changed the title A bunch of fixes to block allocator performance when automatic prefix caching is disabled [PREFIX CACHING FOLLOW UP] A bunch of fixes to block allocator performance when automatic prefix caching is disabled Mar 15, 2024 AllenDou reviewed Mar 18, 2024 View reviewed changes vllm/core/evictor.py if block.num_hashed_tokens == highest_num_hashed_tokens: if (block.last_accessed < evicted_block.last_accessed or block.last_accessed == evicted_block.last_accessed and block.num_hashed_tokens > evicted_block.num_hashed_tokens): Copy link Contributor AllenDou Mar 18, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I have also optimized the evictor LRU, but after learning more about evictors, I feel that LRU is unnecessary as it is not as efficient as the random policy. So, in my opinion, LRU policy should be removed. cc @cadedaniel Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author ElizaWszola Mar 18, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The changes in this PR improve LRU evictor efficiency marginally. I'm ok with removing them from this PR, especially when a better way to improve LRU evictor efficiency (bringing it to the level roughly on par with random evictor for the tested cases) is implemented here: #3431 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions zhuohan123 approved these changes Mar 19, 2024 View reviewed changes Copy link Member zhuohan123 left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Thanks for the fix and left some small comments. Regarding @cadedaniel 's comment on tests, let's discuss more offline together and figure out what tests we need to write. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block_manager.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block_manager.py else: # Set the reference counts of the token blocks. block.ref_count = seq_group.num_seqs() elif self.enable_caching: Copy link Member zhuohan123 Mar 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Does prefix caching work with sliding window now? Should we explicitly check somewhere that if we enable caching, sliding window should not be enabled. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author ElizaWszola Mar 19, 2024 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The prefix caching functionality is simply not used when we have sliding windows. We have specific checks for that in different places in the code. Putting it in a more central place sounds like a better idea though, and less confusing. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/core/block_manager.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/core/block_manager.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . zhuohan123 added\n  the action-required label Mar 19, 2024 ElizaWszola and others added 4 commits March 19, 2024 13:06 Update vllm/core/block_manager.py â€¦ 65b8213 Co-authored-by: Zhuohan Li <zhuohan123@gmail.com> Update vllm/core/block_manager.py â€¦ 1fc91bb Co-authored-by: Zhuohan Li <zhuohan123@gmail.com> Update vllm/core/block_manager.py â€¦ e39ae06 Co-authored-by: Zhuohan Li <zhuohan123@gmail.com> Update vllm/core/block_manager.py â€¦ af1285f Co-authored-by: Zhuohan Li <zhuohan123@gmail.com> ElizaWszola added 2 commits March 19, 2024 08:38 format, disallow sliding window with prefix caching 6c96014 Merge branch 'upstream-main' into auto-prefix-perf c4b69ab Copy link Member zhuohan123 commented Mar 19, 2024 @ElizaWszola Please let me know when this PR is ready to be merged! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . zhuohan123 approved these changes Mar 20, 2024 View reviewed changes Copy link Member zhuohan123 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Thanks for the fix! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions zhuohan123 enabled auto-merge (squash) March 20, 2024 07:11 zhuohan123 disabled auto-merge March 20, 2024 07:11 zhuohan123 merged commit 9474e89 into vllm-project : main Mar 20, 2024 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:25", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: Throughput, Throughput, Throughput | TEST: test", "analysis_extracted_at": "2025-09-07 17:49:25", "models": ["huggyllama/llama-7b"], "lm_eval_commands": null, "perf_command": "python benchmark_throughput_cache.py --backend vllm --model huggyllama/llama-7b --dataset ../data/ShareGPT_V3_unfiltered_cleaned_split.json --num-prompts 2000", "commit_subject": "[PREFIX CACHING FOLLOW UP] A bunch of fixes to block allocator performance when automatic prefix caching is disabled (#3357)", "commit_message": "[PREFIX CACHING FOLLOW UP] A bunch of fixes to block allocator performance when automatic prefix caching is disabled (#3357)\n\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>", "commit_date": "2024-03-20T00:11:11-07:00", "files_changed": ["tests/core/test_block_manager.py", "tests/prefix_caching/test_prefix_caching.py", "vllm/core/block_manager.py", "vllm/core/evictor.py"], "functions_changed": [], "stats": {"num_test_files": 2, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 0, "num_files": 4, "num_hunks": 25, "num_edited_lines": 286, "num_non_test_edited_lines": 260, "commit_year": 2024}, "diff_text": "diff --git a/tests/core/test_block_manager.py b/tests/core/test_block_manager.py\nindex 44ac05a14..9473a33f0 100644\n--- a/tests/core/test_block_manager.py\n+++ b/tests/core/test_block_manager.py\n@@ -4,7 +4,7 @@ from typing import List\n \n from vllm import SamplingParams\n from vllm.block import PhysicalTokenBlock\n-from vllm.core.block_manager import (BlockAllocator, BlockSpaceManager,\n+from vllm.core.block_manager import (UncachedBlockAllocator, BlockSpaceManager,\n                                      AllocStatus)\n from vllm.utils import Device\n from vllm.sequence import Sequence, SequenceGroup, SequenceStatus, Logprob\n@@ -15,7 +15,8 @@ from .utils import create_dummy_prompt\n def test_block_allocator_allocate():\n     block_size = 4\n     num_cpu_blocks = 4\n-    cpu_allocator = BlockAllocator(Device.CPU, block_size, num_cpu_blocks)\n+    cpu_allocator = UncachedBlockAllocator(Device.CPU, block_size,\n+                                           num_cpu_blocks)\n \n     # Allocate all available cpu blocks.\n     num_free = num_cpu_blocks\n@@ -24,7 +25,7 @@ def test_block_allocator_allocate():\n         block = cpu_allocator.allocate()\n         num_free -= 1\n \n-        assert block.block_hash not in cpu_allocator.evictor\n+        assert block not in cpu_allocator.free_blocks\n         assert cpu_allocator.get_num_free_blocks() == num_free\n \n     with pytest.raises(ValueError):\n@@ -34,14 +35,15 @@ def test_block_allocator_allocate():\n def test_block_allocator_free():\n     block_size = 4\n     num_cpu_blocks = 4\n-    cpu_allocator = BlockAllocator(Device.CPU, block_size, num_cpu_blocks)\n+    cpu_allocator = UncachedBlockAllocator(Device.CPU, block_size,\n+                                           num_cpu_blocks)\n \n     # Allocate all available cpu blocks.\n     blocks: List[PhysicalTokenBlock] = []\n     for _ in range(num_cpu_blocks):\n         block = cpu_allocator.allocate()\n         blocks.append(block)\n-        assert block.block_hash not in cpu_allocator.evictor\n+        assert block not in cpu_allocator.free_blocks\n \n     # Free all allocated cpu blocks.\n     num_free = 0\n@@ -49,7 +51,7 @@ def test_block_allocator_free():\n     for block in blocks:\n         cpu_allocator.free(block)\n         num_free += 1\n-        assert block.block_hash in cpu_allocator.evictor\n+        assert block in cpu_allocator.free_blocks\n         assert cpu_allocator.get_num_free_blocks() == num_free\n \n         with pytest.raises(ValueError):\ndiff --git a/tests/prefix_caching/test_prefix_caching.py b/tests/prefix_caching/test_prefix_caching.py\nindex c83551c36..cb61aac39 100644\n--- a/tests/prefix_caching/test_prefix_caching.py\n+++ b/tests/prefix_caching/test_prefix_caching.py\n@@ -4,7 +4,7 @@ Run `pytest tests/prefix_caching/test_prefix_caching.py`.\n \"\"\"\n import pytest\n \n-from vllm.core.block_manager import BlockAllocator\n+from vllm.core.block_manager import CachedBlockAllocator\n from vllm.utils import Device\n \n \n@@ -15,10 +15,7 @@ def test_block_allocator(\n     num_blocks: int,\n ):\n     block_hash = 1\n-    block_allocator = BlockAllocator(Device.CPU,\n-                                     block_size,\n-                                     num_blocks,\n-                                     enable_caching=True)\n+    block_allocator = CachedBlockAllocator(Device.CPU, block_size, num_blocks)\n \n     # Allocate two PysicalTokenBlocks with the same hash and check\n     # that they are the same PhysicalTokenBlock\n@@ -45,10 +42,7 @@ def test_block_allocator(\n @pytest.mark.parametrize(\"num_blocks\", [16])\n def test_eviction(num_blocks: int, ):\n     block_size = 16\n-    block_allocator = BlockAllocator(Device.CPU,\n-                                     block_size,\n-                                     num_blocks,\n-                                     enable_caching=True)\n+    block_allocator = CachedBlockAllocator(Device.CPU, block_size, num_blocks)\n     blocks = []\n \n     for i in range(num_blocks):\ndiff --git a/vllm/core/block_manager.py b/vllm/core/block_manager.py\nindex 8b089a565..ad9b557fd 100644\n--- a/vllm/core/block_manager.py\n+++ b/vllm/core/block_manager.py\n@@ -3,6 +3,7 @@ import enum\n from itertools import count, takewhile\n from os.path import commonprefix\n from typing import Dict, List, Optional, Set, Tuple\n+from abc import ABC, abstractmethod\n \n from vllm.block import BlockTable, PhysicalTokenBlock\n from vllm.sequence import Sequence, SequenceGroup, SequenceStatus\n@@ -10,7 +11,7 @@ from vllm.utils import Device\n from vllm.core.evictor import Evictor, EvictionPolicy, make_evictor\n \n \n-class BlockAllocator:\n+class BlockAllocatorBase(ABC):\n     \"\"\"Manages free physical token blocks for a device.\n \n     The allocator maintains a list of free blocks and allocates a block when\n@@ -18,23 +19,57 @@ class BlockAllocator:\n     the reference count becomes zero, the block is added back to the free list.\n     \"\"\"\n \n+    @abstractmethod\n     def __init__(self,\n                  device: Device,\n                  block_size: int,\n                  num_blocks: int,\n-                 eviction_policy: EvictionPolicy = EvictionPolicy.LRU,\n-                 enable_caching: bool = False) -> None:\n+                 eviction_policy: EvictionPolicy = EvictionPolicy.LRU):\n+        pass\n+\n+    @abstractmethod\n+    def allocate(self,\n+                 block_hash: Optional[int] = None,\n+                 num_hashed_tokens: int = 0) -> PhysicalTokenBlock:\n+        pass\n+\n+    @abstractmethod\n+    def free(self, block: PhysicalTokenBlock) -> None:\n+        pass\n+\n+    @abstractmethod\n+    def get_num_free_blocks(self) -> int:\n+        pass\n+\n+    @abstractmethod\n+    def contains_block(self, block_hash: int) -> bool:\n+        pass\n+\n+    @abstractmethod\n+    def update_hash(self, block_hash: int, block: PhysicalTokenBlock):\n+        pass\n+\n+\n+class CachedBlockAllocator(BlockAllocatorBase):\n+    \"\"\"Manages free physical token blocks for a device.\n+\n+    The allocator maintains a list of free blocks and allocates a block when\n+    requested. When a block is freed, its reference count is decremented. If\n+    the reference count becomes zero, the block is added back to the free list.\n+    \"\"\"\n+\n+    def __init__(self,\n+                 device: Device,\n+                 block_size: int,\n+                 num_blocks: int,\n+                 eviction_policy: EvictionPolicy = EvictionPolicy.LRU) -> None:\n         self.device = device\n         self.block_size = block_size\n         self.num_blocks = num_blocks\n-        self.enable_caching = enable_caching\n \n         self.current_num_blocks = 0\n         self.cached_blocks: Dict[int, PhysicalTokenBlock] = {}\n \n-        # Switch over to FIFO eviction when caching is disabled\n-        if not self.enable_caching:\n-            eviction_policy = EvictionPolicy.FIFO\n         self.evictor: Evictor = make_evictor(eviction_policy)\n \n         self.default_hash_ctr = count()\n@@ -57,13 +92,6 @@ class BlockAllocator:\n     def allocate(self,\n                  block_hash: Optional[int] = None,\n                  num_hashed_tokens: int = 0) -> PhysicalTokenBlock:\n-        # If caching is disabled, just allocate a new block and return it\n-        if not self.enable_caching:\n-            block = self.allocate_block(next(self.default_hash_ctr),\n-                                        num_hashed_tokens)\n-            block.ref_count += 1\n-            return block\n-\n         if block_hash is None:\n             block_hash = next(self.default_hash_ctr)\n         if block_hash in self.evictor:\n@@ -90,9 +118,8 @@ class BlockAllocator:\n             assert block.block_hash not in self.evictor\n             self.evictor.add(block)\n \n-            # If caching is enabled, remove the block from the cached_blocks\n-            if self.enable_caching:\n-                del self.cached_blocks[block.block_hash]\n+            # Remove the block from the cached_blocks\n+            del self.cached_blocks[block.block_hash]\n \n     def get_num_free_blocks(self) -> int:\n         return (self.num_blocks - self.current_num_blocks +\n@@ -102,14 +129,68 @@ class BlockAllocator:\n         return block_hash in self.cached_blocks or block_hash in self.evictor\n \n     def update_hash(self, block_hash: int, block: PhysicalTokenBlock):\n-        # If caching is enabled, update the hash of block and the\n-        # cached_blocks dictionary.\n-        if self.enable_caching:\n-            assert not self.contains_block(block_hash)\n-            old_hash = block.block_hash\n-            block.block_hash = block_hash\n-            del self.cached_blocks[old_hash]\n-            self.cached_blocks[block_hash] = block\n+        # Update the hash of block and the cached_blocks dictionary.\n+        assert not self.contains_block(block_hash)\n+        old_hash = block.block_hash\n+        block.block_hash = block_hash\n+        del self.cached_blocks[old_hash]\n+        self.cached_blocks[block_hash] = block\n+\n+\n+class UncachedBlockAllocator(BlockAllocatorBase):\n+    \"\"\"Manages free physical token blocks for a device.\n+\n+    The allocator maintains a list of free blocks and allocates a block when\n+    requested. When a block is freed, its reference count is decremented. If\n+    the reference count becomes zero, the block is added back to the free list.\n+    \"\"\"\n+\n+    def __init__(\n+        self,\n+        device: Device,\n+        block_size: int,\n+        num_blocks: int,\n+    ) -> None:\n+        self.device = device\n+        self.block_size = block_size\n+        self.num_blocks = num_blocks\n+\n+        # Initialize the free blocks.\n+        self.free_blocks: BlockTable = []\n+        for i in range(num_blocks):\n+            block = PhysicalTokenBlock(device=device,\n+                                       block_number=i,\n+                                       block_size=block_size,\n+                                       block_hash=-1,\n+                                       num_hashed_tokens=0)\n+            self.free_blocks.append(block)\n+\n+    def allocate(self,\n+                 block_hash: Optional[int] = None,\n+                 num_hashed_tokens: int = 0) -> PhysicalTokenBlock:\n+        if not self.free_blocks:\n+            raise ValueError(\"Out of memory! No free blocks are available.\")\n+        block = self.free_blocks.pop()\n+        block.ref_count = 1\n+        return block\n+\n+    def free(self, block: PhysicalTokenBlock) -> None:\n+        if block.ref_count == 0:\n+            raise ValueError(f\"Double free! {block} is already freed.\")\n+        block.ref_count -= 1\n+        if block.ref_count == 0:\n+            self.free_blocks.append(block)\n+\n+    def get_num_free_blocks(self) -> int:\n+        return len(self.free_blocks)\n+\n+    def contains_block(self, block_hash: int) -> bool:\n+        raise NotImplementedError(\n+            \"Invalid codepath for uncached block allocator.\")\n+\n+    def update_hash(self, block_hash: int, block: PhysicalTokenBlock):\n+        raise NotImplementedError(\n+            \"Invalid codepath for uncached block allocator.\")\n \n \n class AllocStatus(enum.Enum):\n@@ -142,6 +223,10 @@ class BlockSpaceManager:\n         self.num_total_gpu_blocks = num_gpu_blocks\n         self.num_total_cpu_blocks = num_cpu_blocks\n \n+        if enable_caching and sliding_window is not None:\n+            raise NotImplementedError(\n+                \"Sliding window is not allowed with prefix caching enabled!\")\n+\n         self.block_sliding_window = None\n         if sliding_window is not None:\n             assert sliding_window % block_size == 0, (sliding_window,\n@@ -154,14 +239,17 @@ class BlockSpaceManager:\n         self.enable_caching = enable_caching\n \n         self.watermark_blocks = int(watermark * num_gpu_blocks)\n-        self.gpu_allocator = BlockAllocator(Device.GPU,\n-                                            block_size,\n-                                            num_gpu_blocks,\n-                                            enable_caching=enable_caching)\n-        self.cpu_allocator = BlockAllocator(Device.CPU,\n-                                            block_size,\n-                                            num_cpu_blocks,\n-                                            enable_caching=enable_caching)\n+\n+        if self.enable_caching:\n+            self.gpu_allocator = CachedBlockAllocator(Device.GPU, block_size,\n+                                                      num_gpu_blocks)\n+            self.cpu_allocator = CachedBlockAllocator(Device.CPU, block_size,\n+                                                      num_cpu_blocks)\n+        else:\n+            self.gpu_allocator = UncachedBlockAllocator(\n+                Device.GPU, block_size, num_gpu_blocks)\n+            self.cpu_allocator = UncachedBlockAllocator(\n+                Device.CPU, block_size, num_cpu_blocks)\n         # Mapping: seq_id -> BlockTable.\n         self.block_tables: Dict[int, BlockTable] = {}\n \n@@ -198,10 +286,16 @@ class BlockSpaceManager:\n             if (self.block_sliding_window is not None\n                     and logical_idx >= self.block_sliding_window):\n                 block = block_table[logical_idx % self.block_sliding_window]\n-            else:\n+                # Set the reference counts of the token blocks.\n+                block.ref_count = seq_group.num_seqs()\n+            elif self.enable_caching:\n                 block = self.gpu_allocator.allocate(\n                     seq.hash_of_block(logical_idx),\n                     seq.num_hashed_tokens_of_block(logical_idx))\n+            else:\n+                block = self.gpu_allocator.allocate()\n+                # Set the reference counts of the token blocks.\n+                block.ref_count = seq_group.num_seqs()\n             block_table.append(block)\n \n         # Assign the block table for each sequence.\n@@ -220,8 +314,10 @@ class BlockSpaceManager:\n         seq: Sequence,\n         last_block: PhysicalTokenBlock,\n     ) -> PhysicalTokenBlock:\n-        # Compute a new hash for the block so that it can be shared by\n-        # other Sequences\n+        assert self.enable_caching\n+\n+        # Compute a new hash for the block so that it can be shared by other\n+        # Sequences\n         new_hash = seq.hash_of_block(len(seq.logical_token_blocks) - 1)\n \n         # if new_hash is already in the cached table, then free last_block\n@@ -254,6 +350,8 @@ class BlockSpaceManager:\n         self,\n         seq: Sequence,\n     ) -> PhysicalTokenBlock:\n+        if not self.enable_caching:\n+            return self.gpu_allocator.allocate()\n         block_hash: Optional[int] = None\n         if (self._is_last_block_full(seq)):\n             block_hash = seq.hash_of_block(len(seq.logical_token_blocks) - 1)\n@@ -293,10 +391,12 @@ class BlockSpaceManager:\n         assert last_block.device == Device.GPU\n         if last_block.ref_count == 1:\n             # Not shared with other sequences. Appendable.\n-            # If the last block is now complete, promote it to a full block so\n-            # that it can be shared\n-            new_block = self._maybe_promote_last_block(seq, last_block)\n-            block_table[-1] = new_block\n+            if self.enable_caching:\n+                # If the last block is now complete, we may reuse an old block\n+                # to save memory.\n+                maybe_new_block = self._maybe_promote_last_block(\n+                    seq, last_block)\n+                block_table[-1] = maybe_new_block\n             return None\n         else:\n             # The last block is shared with other sequences.\n@@ -440,9 +540,12 @@ class BlockSpaceManager:\n         seq: Sequence,\n         access_time: float,\n     ) -> None:\n-        block_table = self.block_tables[seq.seq_id]\n-        for block in block_table:\n-            block.last_accessed = access_time\n+        if self.enable_caching:\n+            # Update the last accessed time of all the blocks accessed\n+            # in this step.\n+            block_table = self.block_tables[seq.seq_id]\n+            for block in block_table:\n+                block.last_accessed = access_time\n \n     def compute_full_blocks_in_seq(self, seq: Sequence):\n         if seq.seq_id not in self.block_tables:\ndiff --git a/vllm/core/evictor.py b/vllm/core/evictor.py\nindex 1d81f5a97..9f401cba3 100644\n--- a/vllm/core/evictor.py\n+++ b/vllm/core/evictor.py\n@@ -1,5 +1,5 @@\n import enum\n-from typing import Dict, List, Optional\n+from typing import Dict\n from abc import ABC, abstractmethod, abstractproperty\n \n from vllm.block import PhysicalTokenBlock\n@@ -10,7 +10,6 @@ class EvictionPolicy(enum.Enum):\n        Evictor subclass.\n     \"\"\"\n     LRU = enum.auto()\n-    FIFO = enum.auto()\n \n \n class Evictor(ABC):\n@@ -66,37 +65,18 @@ class LRUEvictor(Evictor):\n \n     # TODO: The performance of this evict function can be optimized further.\n     def evict(self) -> PhysicalTokenBlock:\n-        free_blocks: List[PhysicalTokenBlock] = list(self.free_table.values())\n-        if len(free_blocks) == 0:\n+        if len(self.free_table) == 0:\n             raise ValueError(\"No usable cache memory left\")\n+        free_blocks = self.free_table.values()\n \n-        # Find lowest timestamp\n-        lowest_timestamp = free_blocks[0].last_accessed\n-        for block in free_blocks:\n-            if block.last_accessed < lowest_timestamp:\n-                lowest_timestamp = block.last_accessed\n+        # Get evicted block\n+        evicted_block: PhysicalTokenBlock = next(iter(free_blocks))\n \n-        # Find all blocks with the lowest timestamp\n-        least_recent: List[PhysicalTokenBlock] = []\n         for block in free_blocks:\n-            if block.last_accessed == lowest_timestamp:\n-                least_recent.append(block)\n-\n-        # Find highest prefix count per block\n-        highest_num_hashed_tokens = 0\n-        for block in least_recent:\n-            if block.num_hashed_tokens > highest_num_hashed_tokens:\n-                highest_num_hashed_tokens = block.num_hashed_tokens\n-\n-        evicted_block: Optional[PhysicalTokenBlock] = None\n-\n-        # Find the first block with the lowest timestamp\n-        for block in least_recent:\n-            if block.num_hashed_tokens == highest_num_hashed_tokens:\n+            if (block.last_accessed < evicted_block.last_accessed\n+                    or block.last_accessed == evicted_block.last_accessed and\n+                    block.num_hashed_tokens > evicted_block.num_hashed_tokens):\n                 evicted_block = block\n-                break\n-\n-        assert evicted_block is not None\n \n         del self.free_table[evicted_block.block_hash]\n \n@@ -119,43 +99,8 @@ class LRUEvictor(Evictor):\n         return len(self.free_table)\n \n \n-class RandomEvictor(Evictor):\n-    \"\"\"Evicts in a first-in-first-out order\"\"\"\n-\n-    def __init__(self):\n-        self.free_table: Dict[int, PhysicalTokenBlock] = {}\n-\n-    def __contains__(self, block_hash: int) -> bool:\n-        return block_hash in self.free_table\n-\n-    def evict(self) -> PhysicalTokenBlock:\n-        if len(self.free_table) == 0:\n-            raise ValueError(\"No usable cache memory left\")\n-        evicted_block = next(iter(self.free_table.values()))\n-        evicted_block.computed = False\n-        del self.free_table[evicted_block.block_hash]\n-        return evicted_block\n-\n-    def add(self, block: PhysicalTokenBlock):\n-        self.free_table[block.block_hash] = block\n-\n-    def remove(self, block_hash: int) -> PhysicalTokenBlock:\n-        if block_hash not in self.free_table:\n-            raise ValueError(\n-                \"Attempting to remove block that's not in the evictor\")\n-        block: PhysicalTokenBlock = self.free_table[block_hash]\n-        del self.free_table[block_hash]\n-        return block\n-\n-    @property\n-    def num_blocks(self) -> int:\n-        return len(self.free_table)\n-\n-\n def make_evictor(eviction_policy: EvictionPolicy) -> Evictor:\n     if eviction_policy == EvictionPolicy.LRU:\n         return LRUEvictor()\n-    elif eviction_policy == EvictionPolicy.FIFO:\n-        return RandomEvictor()\n     else:\n         raise ValueError(f\"Unknown cache eviction policy: {eviction_policy}\")", "apis": ["vllm.core.block_manager.UncachedBlockAllocator", "vllm.core.block_manager.CachedBlockAllocator", "vllm.core.block_manager.BlockSpaceManager"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block_manager.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/prefix_caching_block.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/offline_inference/automatic_prefix_caching.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes modifications in both test and non-test source filesâ€”in particular, in files under vllm/core, including the block_allocator and evictor implementations. The changes include introducing distinct classes for cached and uncached block allocation by adding UncachedBlockAllocator and CachedBlockAllocator, refactoring how blocks are allocated, freed, and managed, and simplifying the eviction logic. Although the commit message mentions \"prefix caching\" and patch title hints at performance-related fixes, the changes clearly improve block allocation efficiency and memory management rather than merely renaming functions or fixing bugs in a trivial fashion. The modifications affect core APIs that handle CPU-based operations, and they appear to target performance optimization of allocation and eviction workflows. Therefore, the commit satisfies the conditions for being performance/optimization related.", "llm_api_reason": "The commit refactors the block allocator system. It replaces the old BlockAllocator with two distinct implementations â€“ one for cached allocation (CachedBlockAllocator) and one for uncached allocation (UncachedBlockAllocator) â€“ and updates the BlockSpaceManager to instantiate the appropriate allocator based on whether prefix caching is enabled. Test files were updated to import and use these new allocator classes and verify correct behavior, such as checking free blocks instead of block hashes. Overall, this change affects the public Python APIs related to block allocation and management used by vLLM."}
{"commit_hash": "21d93c140d0a97af5f0c59e660cf04bd417fd424", "pr_url": "https://github.com/vllm-project/vllm/pull/2090", "pr_date": null, "timeline_text": "Copy link Collaborator Yard1 commented Dec 13, 2023 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . This PR implements a more efficient parallelism scheme for the Mixtral model. Instead of sharding the layers of each expert by rank, we instead shard whole experts across ranks. This gives us several benefits: We reduce the amount of communication between ranks We do not require megablocks (meaning we can now support non-CUDA accelerators) The operations become more efficient and CUDA-graphable. In the new design, each expert will conduct a dense matrix multiplication of the whole batch, and then rows not assigned to the expert will be zeroed out before accumulation. This results in a slight inefficiency for tensor parallel sizes below the number of experts - it means that we will essentially always do the upper performance bound computation. However, we have not found this to be an issue in practice. A potential improvement would be to use a sparse/grouped GEMM kernel (at least for prefill - for decode it shouldn't matter). We have benchmarked this change and found that it lowers the e2e latency for Mixtral by 4x-5x on A100-40GB TP8 compared to the previous implementation. Furthermore, the PR refactors the Mixtral model for compatibility with Hugging Face format and safetensor weights, and adds quantization support. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 19 WoosukKwon, pcmoritz, scv119, theycallmeloki, kevinhu, esmeetu, binarycrayon, liangfu, RobPruzan, JCRPaquin, and 9 more reacted with hooray emoji ðŸ‘€ 10 luiscape, nateraw, pcmoritz, kevinhu, liangfu, 152334H, RobPruzan, pierrestock, L1aoXingyu, and bernaferrari reacted with eyes emoji All reactions ðŸŽ‰ 19 reactions ðŸ‘€ 10 reactions Yard1 added 3 commits December 13, 2023 14:17 Cleanup a6267bd Revert \"Update Dockerfile to build Megablocks ( vllm-project#2042 )\" â€¦ 804bccb This reverts commit 3fefe27 . Revert \"Update Dockerfile to support Mixtral ( vllm-project#2027 )\" â€¦ d96ba1c This reverts commit eb17212 . Yard1 requested review from zhuohan123 , simon-mo and WoosukKwon December 13, 2023 22:23 This was referenced Dec 13, 2023 Mixtral tokens-per-second slower than expected, 10 tps #2069 Closed Support Mixtral's safetensors weights #2041 Closed WoosukKwon linked an issue Dec 13, 2023 that may be closed by this pull request Support Mixtral's safetensors weights #2041 Closed Copy link Collaborator WoosukKwon commented Dec 13, 2023 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Hi @Yard1 , thanks for the amazing work! I've just tested the PR on examples/llm_engine_example.py and got the following results: Current main INFO 12-13 23:31:55 llm_engine.py:222] # GPU blocks: 86172, # CPU blocks: 8192\nINFO 12-13 23:31:58 llm_engine.py:649] Avg prompt throughput: 0.0 tokens/s, Avg generation throughput: 0.0 tokens/s, Running: 1 reqs, Swapped: 0 reqs, Pending: 0 reqs, GPU KV cache usage: 0.0%, CPU KV cache usage: 0.0%\nRequestOutput(request_id=0, prompt='A robot may not injure a human being', prompt_token_ids=[1, 330, 18401, 993, 459, 5891, 482, 264, 2930, 1250], prompt_logprobs=[None, {330: -9.912246704101562, 22478: -0.7872462272644043}, {18401: -8.597543716430664, 633: -3.347543478012085}, {993: -4.565238952636719, 369: -2.1902387142181396}, {459: -0.4373227059841156}, {5891: -0.4258776903152466}, {482: -3.099436753473128e-06}, {264: -0.0011317284079268575}, {2930: -0.0006484074983745813}, {1250: -0.009901456534862518}], outputs=[CompletionOutput(index=0, text=' or, through inaction, allow a human being to come to harm.\\n', token_ids=[442, 28725, 1059, 297, 1774, 28725, 1914, 264, 2930, 1250, 298, 1567, 298, 6241, 28723, 13], cumulative_logprob=-0.6244106972517329, logprobs=[{442: -0.017248855903744698}, {28725: -0.002303091809153557}, {1059: -0.0011830481234937906}, {297: -0.00041952868923544884}, {1774: -7.164221460698172e-05}, {28725: -0.0003152588615193963}, {1914: -0.0006347072194330394}, {264: -0.0005576247931458056}, {2930: -0.00010775939153973013}, {1250: -0.0015303102554753423}, {298: -0.0005830018781125546}, {1567: -0.0004058252670802176}, {298: -0.0002112165529979393}, {6241: -0.0003516055876389146}, {28723: -0.03660520166158676}, {13: -0.5618820190429688}], finish_reason=length)], finished=True)\nRequestOutput(request_id=1, prompt='To be or not to be,', prompt_token_ids=[1, 1791, 347, 442, 459, 298, 347, 28725], prompt_logprobs=None, outputs=[CompletionOutput(index=0, text=' that is the question.\\nWhether â€™tis nobler in the mind', token_ids=[369, 349, 272, 2996, 28723, 13, 23842, 620, 24978, 28707, 278, 7169, 1523, 297, 272, 2273], cumulative_logprob=-5.713744854774632, logprobs=None, finish_reason=length)], finished=True)\nRequestOutput(request_id=2, prompt='What is the meaning of life?', prompt_token_ids=[1, 1824, 349, 272, 5746, 302, 1411, 28804], prompt_logprobs=None, outputs=[CompletionOutput(index=0, text='\\n\\nThe meaning of life is the question of the purpose and significance of life', token_ids=[13, 13, 1014, 5746, 302, 1411, 349, 272, 2996, 302, 272, 6032, 304, 18309, 302, 1411], cumulative_logprob=-8.794605396687984, logprobs=None, finish_reason=length), CompletionOutput(index=3, text=' Itâ€™s a question thatâ€™s been asked by philosophers, theolog', token_ids=[661, 28809, 28713, 264, 2996, 369, 28809, 28713, 750, 2261, 486, 8829, 404, 28725, 272, 1165], cumulative_logprob=-9.33446236141026, logprobs=None, finish_reason=length)], finished=True)\nRequestOutput(request_id=3, prompt='It is only with the heart that one can see rightly', prompt_token_ids=[1, 661, 349, 865, 395, 272, 3031, 369, 624, 541, 1032, 1103, 346], prompt_logprobs=None, outputs=[CompletionOutput(index=0, text='; what is essential is invisible to the eye.\\n\\nAntoine de Saint', token_ids=[28745, 767, 349, 7974, 349, 20187, 298, 272, 5421, 28723, 13, 13, 13389, 21265, 340, 6393], cumulative_logprob=-2.537341303512221, logprobs=None, finish_reason=length), CompletionOutput(index=1, text='; what is essential is invisible to the eye. Antoine de Saint-Ex', token_ids=[28745, 767, 349, 7974, 349, 20187, 298, 272, 5421, 28723, 3821, 21265, 340, 6393, 28733, 966], cumulative_logprob=-2.979412608925486, logprobs=None, finish_reason=length), CompletionOutput(index=2, text='; what is essential is invisible to the eye. â€“ Antoine de Saint-', token_ids=[28745, 767, 349, 7974, 349, 20187, 298, 272, 5421, 28723, 764, 3821, 21265, 340, 6393, 28733], cumulative_logprob=-3.1470024501613807, logprobs=None, finish_reason=length)], finished=True) This PR INFO 12-13 23:20:14 llm_engine.py:222] # GPU blocks: 57756, # CPU blocks: 8192\nINFO 12-13 23:20:17 llm_engine.py:649] Avg prompt throughput: 0.0 tokens/s, Avg generation throughput: 0.0 tokens/s, Running: 1 reqs, Swapped: 0 reqs, Pending: 0 reqs, GPU KV cache usage: 0.0%, CPU KV cache usage: 0.0%\nRequestOutput(request_id=0, prompt='A robot may not injure a human being', prompt_token_ids=[1, 330, 18401, 993, 459, 5891, 482, 264, 2930, 1250], prompt_logprobs=[None, {330: -9.617840766906738, 12: -1.7154966592788696}, {18401: -8.787067413330078, 330: -2.7558176517486572}, {993: -4.204432010650635, 349: -2.0169320106506348}, {459: -0.3415136933326721}, {5891: -1.0073399543762207, 6241: -0.5073400139808655}, {482: -1.3708974620385561e-05}, {264: -0.1135331317782402}, {2930: -0.002309514442458749}, {1250: -0.016736455261707306}], outputs=[CompletionOutput(index=0, text=', or, more importantly, a robot may not kill a human being.\\n', token_ids=[28725, 442, 28725, 680, 21485, 28725, 264, 18401, 993, 459, 4015, 264, 2930, 1250, 28723, 13], cumulative_logprob=-7.275053498335183, logprobs=[{28725: -0.16343587636947632}, {442: -0.21259483695030212}, {28725: -0.1041431725025177}, {680: -1.0776935815811157}, {21485: -0.2229764610528946}, {28725: -0.01339601818472147}, {264: -1.1102567911148071}, {18401: -0.1942392736673355}, {993: -0.3014945983886719}, {459: -0.05710757523775101}, {4015: -1.3823846578598022}, {264: -0.5338531732559204}, {2930: -0.08587013930082321}, {1250: -0.040455106645822525}, {28723: -0.33675137162208557}, {13: -1.4384008646011353}], finish_reason=length)], finished=True)\nRequestOutput(request_id=1, prompt='To be or not to be,', prompt_token_ids=[1, 1791, 347, 442, 459, 298, 347, 28725], prompt_logprobs=None, outputs=[CompletionOutput(index=0, text=' that is the question of every personâ€™s life.\\nTo live, to', token_ids=[369, 349, 272, 2996, 302, 1012, 1338, 28809, 28713, 1411, 28723, 13, 1551, 2943, 28725, 298], cumulative_logprob=-19.226570382204045, logprobs=None, finish_reason=length)], finished=True)\nRequestOutput(request_id=2, prompt='What is the meaning of life?', prompt_token_ids=[1, 1824, 349, 272, 5746, 302, 1411, 28804], prompt_logprobs=None, outputs=[CompletionOutput(index=0, text='\\n\\nThe meaning of life is the meaning of oneâ€™s life. That', token_ids=[13, 13, 1014, 5746, 302, 1411, 349, 272, 5746, 302, 624, 28809, 28713, 1411, 28723, 1725], cumulative_logprob=-16.94498591311276, logprobs=None, finish_reason=length), CompletionOutput(index=4, text='\\n\\nThis question was often asked in the ancient and modern days.\\n\\n', token_ids=[13, 13, 3260, 2996, 403, 2608, 2261, 297, 272, 9467, 304, 4638, 2202, 28723, 13, 13], cumulative_logprob=-28.903032392263412, logprobs=None, finish_reason=length)], finished=True)\nRequestOutput(request_id=3, prompt='It is only with the heart that one can see rightly', prompt_token_ids=[1, 661, 349, 865, 395, 272, 3031, 369, 624, 541, 1032, 1103, 346], prompt_logprobs=None, outputs=[CompletionOutput(index=1, text='; the\\nreasonable world does not know in unces.\\n\\nHow', token_ids=[28745, 272, 13, 14991, 522, 1526, 1235, 459, 873, 297, 521, 1377, 28723, 13, 13, 5660], cumulative_logprob=-11.229475471191108, logprobs=None, finish_reason=length), CompletionOutput(index=0, text='; the\\nreasonable world does not know in unces, what the\\n', token_ids=[28745, 272, 13, 14991, 522, 1526, 1235, 459, 873, 297, 521, 1377, 28725, 767, 272, 13], cumulative_logprob=-11.59051242750138, logprobs=None, finish_reason=length), CompletionOutput(index=2, text='; the\\nreasonable world does not know in unces.\\n\\nFor', token_ids=[28745, 272, 13, 14991, 522, 1526, 1235, 459, 873, 297, 521, 1377, 28723, 13, 13, 2565], cumulative_logprob=-11.729475471191108, logprobs=None, finish_reason=length)], finished=True) In summary, 1) the results do not match; I feel the current main's output looks more correct, and 2) There's a huge decrease in allocated the KV cache size. Does this mean that this implementation has very high memory overhead? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author Yard1 commented Dec 13, 2023 Thanks, let me check! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author Yard1 commented Dec 13, 2023 FYI we have ran MMLU and recieved extremely close results for both implementations. I feel like the divergence may be due to floating point operations, but I will see if it's possible to reduce it. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member esmeetu commented Dec 14, 2023 Hi @Yard1 ,which model do you use? I tried this PR with https://huggingface.co/mistralai/Mixtral-8x7B-Instruct-v0.1 and it doesn't work. It will throw KeyError: 'tok_embeddings.weight'. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member esmeetu commented Dec 14, 2023 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Hi @Yard1 ,which model do you use? I tried this PR with https://huggingface.co/mistralai/Mixtral-8x7B-Instruct-v0.1 and it doesn't work. It will throw KeyError: 'tok_embeddings.weight'. I found that i only download .pt weights without .safetensors. Doesn't this PR support .pt formatï¼Ÿ And Do you know how to convert pt to safetensors without download again? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author Yard1 commented Dec 14, 2023 @esmeetu There is a divergence between pt and safetensors weights uploaded to huggingface hub (they use different layer names). You can use this script to convert pt to safetensors - https://github.com/huggingface/transformers/blob/v4.36.0/src/transformers/models/mixtral/convert_mixtral_weights_to_hf.py All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Alternative approach aee7762 Copy link Collaborator Author Yard1 commented Dec 14, 2023 @WoosukKwon I have updated the PR using an alternative approach that should both reduce memory usage and numerical inaccuracies. PTAL! ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yard1 added 2 commits December 13, 2023 19:25 Tweak 14f0d67 Go back to dense 02d2c04 Copy link Member esmeetu commented Dec 14, 2023 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @Yard1 Thanks. I converted .pt format weights to .bin format weights. And this PR gives me x2 speedup(6t/s -> 12t/s). Thanks for your great work! Besides i compared Humaneval score on that model. And the result(50.6) is better than main branch(49.4). Another thing, i found the GPU utilization ratio is about 80% when model running. It seems that there is more space to improve performance. ðŸ‘ 4 pcmoritz, Yard1, WoosukKwon, and theycallmeloki reacted with thumbs up emoji All reactions ðŸ‘ 4 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Cleanup 00ad1b7 nivibilla mentioned this pull request Dec 14, 2023 Timeline on supporting Mixtral on ROCm? #2089 Closed Copy link Collaborator WoosukKwon commented Dec 14, 2023 @Yard1 The outputs after the fix look good to me! Many thanks for the quick fix! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon self-assigned this Dec 14, 2023 WoosukKwon reviewed Dec 14, 2023 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @Yard1 Thanks for submitting the PR! The code looks really great overall. I'm just wondering why we need DummyModule . Please check out my comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 nittaya111 reacted with heart emoji All reactions â¤ï¸ 1 reaction vllm/config.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Dockerfile Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/models/mixtral.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/models/mixtral.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/models/mixtral.py config.hidden_size, config.intermediate_size, linear_method=linear_method) if idx in self.expert_indicies else DummyModule() Copy link Collaborator WoosukKwon Dec 14, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I actually didn't understand why we need DummyModule here. Could you elaborate more on this? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author Yard1 Dec 14, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The whole purpose of the dummy module is so that we can discard weights for experts we do not want to load on a given rank. If you have a better way of doing that, please let me know! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator WoosukKwon Dec 14, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Sorry, why can't we just use None ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author Yard1 Dec 14, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Isn't that going to cause exceptions during weights loading? If not then we should definitely use None Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor liangfu Dec 14, 2023 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Instead of adding a placeholder as DummpyModule , construct self.experts as for a list of experts in local_rank? For instance, with num_local_experts=8, tp_size=4, expert_indicies=[0,1], construct self.experts with first two experts and make the ModuleList short? Since gating network is replicated, getting access to routing_weights locally in each rank should be easy, right? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author Yard1 Dec 14, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It's moreso about how to make this compatible with vLLM's TP weight loading logic, which uses list indices Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator WoosukKwon Dec 14, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Let's merge the PR for the release and fix this issue in another PR. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon mentioned this pull request Dec 14, 2023 Bump up to v0.2.5 #2095 Merged liangfu reviewed Dec 14, 2023 View reviewed changes vllm/model_executor/models/mixtral.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Yard1 added 3 commits December 13, 2023 21:54 Remove fschat 90a9fb0 Fix top_k 1b744e2 ROCM a5c7da4 WoosukKwon added 2 commits December 14, 2023 07:47 Warning for pt weights ea91f03 Fix ROCm supported model doc 39aaf15 WoosukKwon approved these changes Dec 14, 2023 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Many thanks for the great work! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 nittaya111 reacted with heart emoji ðŸš€ 2 Yard1 and ArthurZucker reacted with rocket emoji All reactions â¤ï¸ 1 reaction ðŸš€ 2 reactions Copy link Collaborator WoosukKwon commented Dec 14, 2023 @liangfu Thanks for the review! â¤ï¸ 2 Yard1 and nittaya111 reacted with heart emoji All reactions â¤ï¸ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon merged commit 21d93c1 into vllm-project : main Dec 14, 2023 Yard1 deleted the mixtral_expert_parallelism branch December 14, 2023 08:01 This was referenced Dec 14, 2023 performance of Mixtral-8x7B inference #2098 Closed Refactor Mixtral to reuse code from MegaBlocks #2032 Closed tgale96 reviewed Dec 14, 2023 View reviewed changes vllm/model_executor/models/mixtral.py else: final_hidden_states.add_(current_hidden_states) return tensor_model_parallel_all_reduce(final_hidden_states).view( Copy link tgale96 Dec 14, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Hi! I'm curious to understand what's going on in this implementation. The PR calls this expert parallelism but it still looks like tensor parallelism to me? At least, if this is expert parallelism, I don't see any logic routing the tokens to the device that owns the expert it was assigned to? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author Yard1 Dec 14, 2023 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment We run every expert on the rank and zero out the rows that were not selected to be used by the expert. We then all reduce the tensors across the ranks. This results in dense computations (and higher memory usage), but it dramatically reduces latency, especially for small batch sizes. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link tgale96 Dec 15, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Ah ok, thank you! I was confused by the \"expert parallelism\" in the PR name, which I think is a misnomer here :) The prior implementation with MegaBlocks was using a training-optimized code path. I'd expect it to be very inefficient because a) it pads each expert batch to the nearest multiple of 128 and b) dispatches to sparse matmul kernels which use tile dimensions tuned for large problems. For inference, its much better to use our grouped implementation, which avoids these pitfalls. Essentially what is in the function here . Our gather/scatter kernels handle replication for top_k>1 as well as the permutation to group tokens by expert assignment. They're also written in Triton so they should work fine on AMD. For the MLP, we dispatch to custom grouped GEMM ops, but you can also use a pure-Torch grouped MLP like what's happening in this PR to make it AMD compatible. This is the direction I'd go to improve the current implementation further, fwiw. You don't necessarily need to add MegaBlocks as a dep - most of this can be replicated without too much complexity. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author Yard1 Dec 15, 2023 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the explanation! I definitely agree there is a lot of room to expand here. Looking forward to more contributions from you or the community! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link tom-doerr commented Dec 14, 2023 Of we run all experts anyway, how about using more of the results? https://www.reddit.com/r/LocalLLaMA/comments/18i2h4c/mixtral_gets_even_better_by_just_adding_an_expert/ ðŸ‘ 1 NickLucche reacted with thumbs up emoji â¤ï¸ 1 nittaya111 reacted with heart emoji All reactions ðŸ‘ 1 reaction â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link vibhuagrawal14 commented Dec 14, 2023 For me, the speed has increased from 11 tok/s to 30+ ðŸš€ ðŸŽ‰ 4 scv119, pcmoritz, tom-doerr, and TissueC reacted with hooray emoji â¤ï¸ 1 nittaya111 reacted with heart emoji All reactions ðŸŽ‰ 4 reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . 0xymoro mentioned this pull request Dec 15, 2023 Mixtral optimization from vllm NVIDIA/TensorRT-LLM#672 Closed xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Dec 18, 2023 Optimize Mixtral with expert parallelism ( vllm-project#2090 ) f49edbe timohear mentioned this pull request Feb 1, 2024 Mixtral nf4 performance 2x slower than expected huggingface/text-generation-inference#1501 Closed 4 tasks hongxiayang pushed a commit\n        to hongxiayang/vllm\n      that referenced\n      this pull request Feb 13, 2024 Optimize Mixtral with expert parallelism ( vllm-project#2090 ) bc7486b Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:30", "has_lm_eval": true, "has_performance": true, "has_serving": false, "has_general_test": false, "test_details": "LM_EVAL: MMLU, Humaneval | PERF: throughput, throughput, throughput", "analysis_extracted_at": "2025-09-07 17:49:30", "models": ["mistralai/Mixtral-8x7B-Instruct-v0.1"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=mistralai/Mixtral-8x7B-Instruct-v0.1,tensor_parallel_size=8 --tasks mmlu --batch_size auto"], "perf_command": "python benchmarks/benchmark_serving.py --model mistralai/Mixtral-8x7B-Instruct-v0.1 --tensor-parallel-size 8", "commit_subject": "Optimize Mixtral with expert parallelism (#2090)", "commit_message": "Optimize Mixtral with expert parallelism (#2090)", "commit_date": "2023-12-13T23:55:07-08:00", "files_changed": ["Dockerfile", "README.md", "docs/source/models/supported_models.rst", "vllm/config.py", "vllm/model_executor/models/__init__.py", "vllm/model_executor/models/mixtral.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 6, "only_test_files": 0, "only_non_test_files": 1, "num_files": 6, "num_hunks": 15, "num_edited_lines": 555, "num_non_test_edited_lines": 555, "commit_year": 2023}, "diff_text": "diff --git a/Dockerfile b/Dockerfile\nindex f41753aeb..6ef03b843 100644\n--- a/Dockerfile\n+++ b/Dockerfile\n@@ -41,14 +41,6 @@ ENV NVCC_THREADS=$nvcc_threads\n \n RUN python3 setup.py build_ext --inplace\n \n-# Build the megablocks library as wheel because it doesn't publish pre-built wheels.\n-# https://github.com/stanford-futuredata/megablocks/commit/5897cd6f254b7b3edf7a708a3a3314ecb54b6f78\n-RUN apt-get install -y git && \\\n-    git clone https://github.com/stanford-futuredata/megablocks.git && \\\n-    cd megablocks && \\\n-    git checkout 5897cd6f254b7b3edf7a708a3a3314ecb54b6f78 && \\\n-    MAX_JOBS=8 NVCC_THREADS=8 python3 setup.py bdist_wheel\n-\n # image to run unit testing suite\n FROM dev AS test\n \n@@ -85,12 +77,8 @@ FROM vllm-base AS vllm-openai\n RUN --mount=type=cache,target=/root/.cache/pip \\\n     pip install accelerate\n \n-COPY vllm vllm\n COPY --from=build /workspace/vllm/*.so /workspace/vllm/\n-COPY --from=build /workspace/megablocks/dist/*.whl /tmp/\n-RUN --mount=type=cache,target=/root/.cache/pip \\\n-    pip install /tmp/megablocks-0.5.0-cp310-cp310-linux_x86_64.whl && \\\n-    rm /tmp/megablocks-0.5.0-cp310-cp310-linux_x86_64.whl\n+COPY vllm vllm\n \n ENTRYPOINT [\"python3\", \"-m\", \"vllm.entrypoints.openai.api_server\"]\n \ndiff --git a/README.md b/README.md\nindex 84cadee48..e4b3b5026 100644\n--- a/README.md\n+++ b/README.md\n@@ -72,10 +72,6 @@ Install vLLM with pip or [from source](https://vllm.readthedocs.io/en/latest/get\n ```bash\n pip install vllm\n ```\n-**NOTE:** The Mixtral model additionally requires `megablocks` which can be installed with pip or [from source](https://github.com/stanford-futuredata/megablocks):\n-```bash\n-pip install megablocks\n-```\n \n ## Getting Started\n \ndiff --git a/docs/source/models/supported_models.rst b/docs/source/models/supported_models.rst\nindex e21cdd65d..44e4fe5ea 100644\n--- a/docs/source/models/supported_models.rst\n+++ b/docs/source/models/supported_models.rst\n@@ -74,8 +74,7 @@ Otherwise, please refer to :ref:`Adding a New Model <adding_a_new_model>` for in\n Alternatively, you can raise an issue on our `GitHub <https://github.com/vllm-project/vllm/issues>`_ project.\n \n .. note::\n-    Currently, the ROCm version of vLLM does not support Mixtral.\n-    Additionally, it only supports Mistral for context lengths up to 4096.\n+    Currently, the ROCm version of vLLM supports Mistral and Mixtral only for context lengths up to 4096.\n \n .. tip::\n     The easiest way to check if your model is supported is to run the program below:\ndiff --git a/vllm/config.py b/vllm/config.py\nindex 6bafa73c7..eb1fee0f2 100644\n--- a/vllm/config.py\n+++ b/vllm/config.py\n@@ -120,14 +120,16 @@ class ModelConfig:\n             if load_format == \"auto\":\n                 load_format = \"pt\"\n \n-        # FIXME(woosuk): This is a temporary hack. Support safetensor weights.\n+        # TODO: Remove this check once HF updates the pt weights of Mixtral.\n         architectures = getattr(self.hf_config, \"architectures\", [])\n-        if \"MixtralForCausalLM\" in architectures and load_format != \"pt\":\n-            logger.info(\n-                \"Currently, only 'pt' format is supported for Mixtral. \"\n-                \"Changing the format to 'pt'. This may re-download the \"\n-                \"weights if you have downloaded the safetensor weights.\")\n-            load_format = \"pt\"\n+        if \"MixtralForCausalLM\" in architectures:\n+            if load_format == \"pt\":\n+                raise ValueError(\n+                    \"Currently, the 'pt' format is not supported for Mixtral. \"\n+                    \"Please use the 'safetensors' format instead. \")\n+            elif load_format == \"auto\":\n+                # Do not fall back to pt weights.\n+                load_format = \"safetensors\"\n \n         self.load_format = load_format\n \ndiff --git a/vllm/model_executor/models/__init__.py b/vllm/model_executor/models/__init__.py\nindex 5596884f3..ab9a1636a 100644\n--- a/vllm/model_executor/models/__init__.py\n+++ b/vllm/model_executor/models/__init__.py\n@@ -39,13 +39,15 @@ _MODELS = {\n }\n \n # Models not supported by ROCm.\n-_ROCM_UNSUPPORTED_MODELS = [\"MixtralForCausalLM\"]\n+_ROCM_UNSUPPORTED_MODELS = []\n \n # Models partially supported by ROCm.\n # Architecture -> Reason.\n _ROCM_PARTIALLY_SUPPORTED_MODELS = {\n     \"MistralForCausalLM\":\n     \"Sliding window attention is not yet supported in ROCm's flash attention\",\n+    \"MixtralForCausalLM\":\n+    \"Sliding window attention is not yet supported in ROCm's flash attention\",\n }\n \n \ndiff --git a/vllm/model_executor/models/mixtral.py b/vllm/model_executor/models/mixtral.py\nindex 8e0a094c7..b11e3713f 100644\n--- a/vllm/model_executor/models/mixtral.py\n+++ b/vllm/model_executor/models/mixtral.py\n@@ -31,22 +31,11 @@ import torch.nn.functional as F\n from torch import nn\n from transformers import MixtralConfig\n \n-try:\n-    import megablocks.ops as ops\n-except ImportError as e:\n-    raise ImportError(\"MegaBlocks not found. \"\n-                      \"Please install it by `pip install megablocks`.\") from e\n-try:\n-    import stk\n-except ImportError as e:\n-    raise ImportError(\n-        \"STK not found. \"\n-        \"Please install it by `pip install stanford-stk`.\") from e\n-\n from vllm.model_executor.input_metadata import InputMetadata\n from vllm.model_executor.layers.attention import PagedAttention\n from vllm.model_executor.layers.layernorm import RMSNorm\n from vllm.model_executor.layers.linear import (LinearMethodBase,\n+                                               ReplicatedLinear,\n                                                QKVParallelLinear,\n                                                RowParallelLinear)\n from vllm.model_executor.layers.rotary_embedding import get_rope\n@@ -66,8 +55,134 @@ from vllm.sequence import SamplerOutput\n KVCache = Tuple[torch.Tensor, torch.Tensor]\n \n \n-def promote_scalar(x: torch.Tensor) -> torch.Tensor:\n-    return x.view(1) if len(x.size()) == 0 else x\n+class MixtralMLP(nn.Module):\n+\n+    def __init__(\n+        self,\n+        num_experts: int,\n+        hidden_size: int,\n+        intermediate_size: int,\n+        linear_method: Optional[LinearMethodBase] = None,\n+    ) -> None:\n+        super().__init__()\n+        self.num_experts = num_experts\n+        self.ffn_dim = intermediate_size\n+        self.hidden_dim = hidden_size\n+\n+        self.w1 = ReplicatedLinear(self.hidden_dim,\n+                                   self.ffn_dim,\n+                                   bias=False,\n+                                   linear_method=linear_method)\n+        self.w2 = ReplicatedLinear(self.ffn_dim,\n+                                   self.hidden_dim,\n+                                   bias=False,\n+                                   linear_method=linear_method)\n+        self.w3 = ReplicatedLinear(self.hidden_dim,\n+                                   self.ffn_dim,\n+                                   bias=False,\n+                                   linear_method=linear_method)\n+\n+        # TODO: Use vllm's SiluAndMul\n+        self.act_fn = nn.SiLU()\n+\n+    def forward(self, hidden_states: torch.Tensor) -> torch.Tensor:\n+        w1_out, _ = self.w1(hidden_states)\n+        w1_out = self.act_fn(w1_out)\n+        w3_out, _ = self.w3(hidden_states)\n+        current_hidden_states = w1_out * w3_out\n+        current_hidden_states, _ = self.w2(current_hidden_states)\n+        return current_hidden_states\n+\n+\n+class DummyModule(nn.Module):\n+\n+    def __init__(self) -> None:\n+        super().__init__()\n+\n+        self.w1 = nn.Linear(0, 0, bias=False)\n+        self.w2 = nn.Linear(0, 0, bias=False)\n+        self.w3 = nn.Linear(0, 0, bias=False)\n+\n+        set_weight_attrs(self.w1.weight,\n+                         {\"weight_loader\": self.dummy_weight_loader})\n+        set_weight_attrs(self.w2.weight,\n+                         {\"weight_loader\": self.dummy_weight_loader})\n+        set_weight_attrs(self.w3.weight,\n+                         {\"weight_loader\": self.dummy_weight_loader})\n+\n+    def forward(self, *args, **kwargs) -> None:\n+        raise NotImplementedError()\n+\n+    def dummy_weight_loader(self, *args, **kwargs) -> None:  # pylint: disable=unused-argument\n+        # Noop\n+        return\n+\n+\n+class MixtralMoE(nn.Module):\n+\n+    def __init__(\n+        self,\n+        config: MixtralConfig,\n+        linear_method: Optional[LinearMethodBase] = None,\n+    ):\n+        super().__init__()\n+        self.config = config\n+        self.rank = get_tensor_model_parallel_rank()\n+        self.tp_size = get_tensor_model_parallel_world_size()\n+        self.num_total_experts = config.num_local_experts\n+        self.top_k = config.num_experts_per_tok\n+        if self.tp_size > self.num_total_experts:\n+            raise ValueError(\n+                f\"Tensor parallel size {self.tp_size} is greater than \"\n+                f\"the number of experts {self.num_total_experts}.\")\n+        # Split experts equally between ranks\n+        self.expert_indicies = np.array_split(range(\n+            self.num_total_experts), self.tp_size)[self.rank].tolist()\n+        if not self.expert_indicies:\n+            raise ValueError(\n+                f\"Rank {self.rank} has no experts assigned to it.\")\n+\n+        self.experts = nn.ModuleList([\n+            MixtralMLP(self.num_total_experts,\n+                       config.hidden_size,\n+                       config.intermediate_size,\n+                       linear_method=linear_method)\n+            if idx in self.expert_indicies else DummyModule()\n+            for idx in range(self.num_total_experts)\n+        ])\n+        self.gate = ReplicatedLinear(config.hidden_size,\n+                                     self.num_total_experts,\n+                                     bias=False,\n+                                     linear_method=linear_method)\n+\n+    def forward(self, hidden_states: torch.Tensor) -> torch.Tensor:\n+        batch_size, sequence_length, hidden_dim = hidden_states.shape\n+        hidden_states = hidden_states.view(-1, hidden_dim)\n+        # router_logits: (batch * sequence_length, n_experts)\n+        router_logits, _ = self.gate(hidden_states)\n+\n+        routing_weights = F.softmax(router_logits, dim=1, dtype=torch.float)\n+        routing_weights, selected_experts = torch.topk(routing_weights,\n+                                                       self.top_k,\n+                                                       dim=-1)\n+        routing_weights /= routing_weights.sum(dim=-1, keepdim=True)\n+\n+        final_hidden_states = None\n+        for expert_idx in self.expert_indicies:\n+            expert_layer = self.experts[expert_idx]\n+            expert_mask = (selected_experts == expert_idx)\n+            expert_weights = (routing_weights * expert_mask).sum(dim=-1,\n+                                                                 keepdim=True)\n+\n+            current_hidden_states = expert_layer(hidden_states).mul_(\n+                expert_weights)\n+            if final_hidden_states is None:\n+                final_hidden_states = current_hidden_states\n+            else:\n+                final_hidden_states.add_(current_hidden_states)\n+\n+        return tensor_model_parallel_all_reduce(final_hidden_states).view(\n+            batch_size, sequence_length, hidden_dim)\n \n \n class MixtralAttention(nn.Module):\n@@ -78,6 +193,7 @@ class MixtralAttention(nn.Module):\n                  num_kv_heads: int,\n                  max_position: int = 4096 * 32,\n                  rope_theta: float = 10000,\n+                 linear_method: Optional[LinearMethodBase] = None,\n                  sliding_window: Optional[int] = None) -> None:\n         super().__init__()\n         self.hidden_size = hidden_size\n@@ -102,24 +218,26 @@ class MixtralAttention(nn.Module):\n         self.rope_theta = rope_theta\n         self.sliding_window = sliding_window\n \n-        self.wqkv = QKVParallelLinear(\n+        self.qkv_proj = QKVParallelLinear(\n             hidden_size,\n             self.head_dim,\n             self.total_num_heads,\n             self.total_num_kv_heads,\n             bias=False,\n+            linear_method=linear_method,\n         )\n-        self.wo = RowParallelLinear(\n+        self.o_proj = RowParallelLinear(\n             self.total_num_heads * self.head_dim,\n             hidden_size,\n             bias=False,\n+            linear_method=linear_method,\n         )\n         self.rotary_emb = get_rope(\n             self.head_dim,\n             rotary_dim=self.head_dim,\n             max_position=max_position,\n             base=int(self.rope_theta),\n-            is_neox_style=False,  # weights not in HF format\n+            is_neox_style=True,\n         )\n         self.attn = PagedAttention(\n             self.num_heads,\n@@ -137,310 +255,74 @@ class MixtralAttention(nn.Module):\n         input_metadata: InputMetadata,\n         cache_event: Optional[torch.cuda.Event],\n     ) -> torch.Tensor:\n-        qkv, _ = self.wqkv(hidden_states)\n+        qkv, _ = self.qkv_proj(hidden_states)\n         q, k, v = qkv.split([self.q_size, self.kv_size, self.kv_size], dim=-1)\n         q, k = self.rotary_emb(positions, q, k)\n         k_cache, v_cache = kv_cache\n         attn_output = self.attn(q, k, v, k_cache, v_cache, input_metadata,\n                                 cache_event)\n-        output, _ = self.wo(attn_output)\n+        output, _ = self.o_proj(attn_output)\n         return output\n \n \n-class BlockSparseMoE(nn.Module):\n-    \"\"\"\n-    Built on the paper and library Megablocks as described in\n-    https://arxiv.org/abs/2211.15841. This implementation is\n-    strictly equivalent to standard MoE with full capacity (no\n-    dropped tokens). It's faster since it formulates MoE operations\n-    in terms of block-sparse operations to accomodate imbalanced\n-    assignments of tokens to experts, whereas standard MoE either\n-    (1) drop tokens at the cost of reduced performance or (2) set\n-    capacity factor to number of experts and thus waste computation\n-    and memory on padding.\n-    \"\"\"\n-\n-    def __init__(self, hidden_dim: int, ffn_dim: int, num_experts: int,\n-                 top_k: int):\n-        super().__init__()\n-        self.hidden_dim = hidden_dim\n-        self.ffn_dim = ffn_dim\n-        self.num_experts = num_experts\n-        self.top_k = top_k\n-\n-        # gating\n-        self.gate = nn.Linear(self.hidden_dim,\n-                              self.num_experts,\n-                              bias=False,\n-                              device=torch.cuda.current_device())\n-\n-        tp_size = get_tensor_model_parallel_world_size()\n-        assert self.ffn_dim % tp_size == 0\n-        self.ffn_dim_per_partition = self.ffn_dim // tp_size\n-        # merged expert weights, all of size  (ffn_dim * n_experts, model_dim)\n-        self.w1 = nn.Parameter(\n-            torch.empty(self.ffn_dim_per_partition * self.num_experts,\n-                        self.hidden_dim,\n-                        device=torch.cuda.current_device()))\n-        set_weight_attrs(self.w1, {\"weight_loader\": self.moe_weight_loader})\n-        self.w2 = nn.Parameter(\n-            torch.empty(self.ffn_dim_per_partition * self.num_experts,\n-                        self.hidden_dim,\n-                        device=torch.cuda.current_device()))\n-        set_weight_attrs(self.w2, {\"weight_loader\": self.moe_weight_loader})\n-        self.w3 = nn.Parameter(\n-            torch.empty(self.ffn_dim_per_partition * self.num_experts,\n-                        self.hidden_dim,\n-                        device=torch.cuda.current_device()))\n-        set_weight_attrs(self.w3, {\"weight_loader\": self.moe_weight_loader})\n-\n-        # Calculate the number of bits needed to represent the expert indices\n-        # so that we can pass it to radix sort.\n-        self.sort_end_bit = max(int(np.ceil(np.log2(self.num_experts))), 1)\n-        self.blocking = 128\n-        self.quantize_scatter_num_bits = -1\n-\n-        # Calculate the number of bits needed to represent the column indices\n-        # in the intermediate sparse matrix.\n-        max_column_index = (self.ffn_dim * self.num_experts) // self.blocking\n-        self.transpose_sort_end_bit = max(\n-            int(np.ceil(np.log2(max_column_index))), 1)\n-\n-    def moe_weight_loader(self, param: nn.Parameter,\n-                          loaded_weight: torch.Tensor) -> None:\n-        \"\"\"\n-        Load the weights for the MoE linear layer.\n-        \"\"\"\n-        tp_rank = get_tensor_model_parallel_rank()\n-        shard_size = self.ffn_dim_per_partition\n-        loaded_weight = loaded_weight.view(self.num_experts, self.ffn_dim, -1)\n-        loaded_weight = loaded_weight[:, shard_size * tp_rank:shard_size *\n-                                      (tp_rank + 1)]\n-        loaded_weight = loaded_weight.reshape_as(param)\n-        param.data.copy_(loaded_weight)\n-\n-    def sparse_transpose(\n-            self, size: int, row_indices,\n-            column_indices) -> Tuple[torch.Tensor, torch.Tensor, torch.Tensor]:\n-        block_columns = size[1] // self.blocking\n-\n-        # Sort row indices by column indices to get the transposed matrix's\n-        # column indices.\n-        #\n-        # NOTE: Our sort operation uses the same width indices as the input\n-        # values. To avoid overflow when we have large activation matrices\n-        # we cast to 32-bit before sorting.\n-        _, gather_indices = ops.sort(column_indices.int(),\n-                                     self.transpose_sort_end_bit)\n-\n-        # There are a constant number of blocks in every row of the sparse\n-        # matrix. A blocks offset is:\n-        #\n-        # row_index * blocks_per_row + column_index % blocks_per_row\n-        #\n-        # Once we have the block offsets ordered for transposition we can\n-        # divide by blocks_per_row to get the transposed column indices.\n-        column_indices_t = row_indices.gather(0, gather_indices.long())\n-        block_offsets_t = gather_indices.int()\n-\n-        zero = torch.zeros((1, ), dtype=torch.int32, device=row_indices.device)\n-        nnz_per_column = ops.histogram(column_indices, block_columns)\n-        nnz_per_column = ops.inclusive_cumsum(nnz_per_column, 0)\n-        offsets_t = torch.cat([zero, nnz_per_column])\n-        return column_indices_t, offsets_t, block_offsets_t\n-\n-    def topology(self, x: torch.Tensor,\n-                 padded_bins: torch.Tensor) -> \"stk.Matrix\":\n-        padded_tokens, _ = x.size()\n-        assert padded_tokens % self.blocking == 0\n-        assert self.ffn_dim_per_partition % self.blocking == 0\n-\n-        # Offsets for the sparse matrix. All rows have the\n-        # same number of nonzero blocks dictated by the\n-        # dimensionality of a single expert.\n-        block_rows = padded_tokens // self.blocking\n-        blocks_per_row = self.ffn_dim_per_partition // self.blocking\n-        offsets = torch.arange(\n-            0,\n-            block_rows * blocks_per_row + 1,\n-            blocks_per_row,\n-            dtype=torch.int32,\n-            device=x.device,\n-        )\n-\n-        # Indices for the sparse matrix. The indices for\n-        # the intermediate matrix are dynamic depending\n-        # on the mapping of tokens to experts.\n-        column_indices = ops.topology(padded_bins, self.blocking, block_rows,\n-                                      blocks_per_row)\n-\n-        # TODO(tgale): This is unused. Remove the need for this in stk.\n-        # For now, use meta init to save the device memory.\n-        data = torch.empty(\n-            column_indices.numel(),\n-            self.blocking,\n-            self.blocking,\n-            dtype=x.dtype,\n-            device=\"meta\",\n-        )\n-        shape = (padded_tokens, self.ffn_dim_per_partition * self.num_experts)\n-        row_indices = stk.ops.row_indices(shape, data, offsets, column_indices)\n-        column_indices_t, offsets_t, block_offsets_t = self.sparse_transpose(\n-            shape, row_indices, column_indices)\n-        return stk.Matrix(\n-            shape,\n-            data,\n-            row_indices,\n-            column_indices,\n-            offsets,\n-            column_indices_t,\n-            offsets_t,\n-            block_offsets_t,\n-        )\n-\n-    def indices_and_padded_bins(\n-        self, selected_experts: torch.Tensor\n-    ) -> Tuple[torch.Tensor, torch.Tensor, torch.Tensor, torch.Tensor,\n-               torch.Tensor]:\n-        # Sort the expert ids to produce the scatter/gather\n-        # indices for the permutation.\n-        selected_experts = selected_experts.int()\n-        bin_ids, indices = ops.sort(selected_experts, self.sort_end_bit)\n-\n-        # Histogram the expert ids to identify the number of\n-        # tokens routed to each expert.\n-        tokens_per_expert = ops.histogram(selected_experts, self.num_experts)\n-\n-        # Round the token counts up to the block size used in\n-        # the matrix muliplications. Caculate the starting\n-        # position of each bin.\n-        padded_tokens_per_expert = ops.round_up(tokens_per_expert,\n-                                                self.blocking)\n-        padded_bins = ops.inclusive_cumsum(padded_tokens_per_expert, 0)\n-        padded_bins = promote_scalar(padded_bins)\n-\n-        # Calculate the bin bounds for the sorted tokens.\n-        bins = ops.inclusive_cumsum(tokens_per_expert, 0)\n-        bins = promote_scalar(bins)\n-        return indices, bin_ids, bins, padded_bins, tokens_per_expert\n-\n-    @torch.inference_mode()\n-    def forward(self, x: torch.Tensor) -> torch.Tensor:\n-        \"\"\"\n-        x: (sequence_length, model_dim)\n-        gate_logits: (sequence_length, n_experts)\n-        \"\"\"\n-        # optional reshape\n-        input_shape = x.shape\n-        x = x.view(-1, input_shape[-1])\n-\n-        # gate_logits: (sequence_length, n_experts)\n-        gate_logits = self.gate(x)\n-        # all_probs: (sequence_length, n_experts) and upcast for softmax\n-        all_probs = F.softmax(gate_logits, dim=1, dtype=torch.float)\n-        # weights, selected_experts: (sequence_length, top-k)\n-        weights, selected_experts = torch.topk(all_probs, self.top_k, dim=-1)\n-        weights /= weights.sum(dim=-1, keepdim=True)\n-        weights = weights.flatten().to(x.dtype)\n-        selected_experts = selected_experts.flatten()\n-\n-        (indices, bin_ids, bins, padded_bins,\n-         _) = self.indices_and_padded_bins(selected_experts)\n-\n-        # Permute tokens and pad to prepare expert computation\n-        # (top_k * sequence_length + padding, model_dim)\n-        x = ops.padded_gather(x, indices, bin_ids, bins, padded_bins,\n-                              self.top_k)\n-\n-        # Create the sparse matrix topology\n-        with torch.no_grad():\n-            topo = self.topology(x, padded_bins)\n-\n-        # Perform the expert computation\n-        # First Dense x Dense -> Sparse for w1 and w3,\n-        # (top_k * sequence_length + padding, ffn_dim * n_experts)\n-        x = stk.Matrix(\n-            topo.size(),\n-            F.silu(stk.ops.sdd(x, self.w1.t(), topo).data) *\n-            stk.ops.sdd(x, self.w3.t(), topo).data,\n-            topo.row_indices,\n-            topo.column_indices,\n-            topo.offsets,\n-            topo.column_indices_t,\n-            topo.offsets_t,\n-            topo.block_offsets_t,\n-        )\n-\n-        # Then Sparse x Dense -> Dense for w2\n-        # (top_k * sequence_length + padding, model_dim)\n-        x = stk.ops.dsd(x, self.w2)\n-\n-        x = tensor_model_parallel_all_reduce(x)\n-\n-        # Permute back and remove padding\n-        # (top_k * sequence_length, model_dim)\n-        x = ops.padded_scatter(\n-            x,\n-            indices,\n-            bin_ids,\n-            weights,\n-            bins,\n-            padded_bins,\n-            self.top_k,\n-            self.quantize_scatter_num_bits,\n-        )\n-        return x.view(*input_shape)\n-\n-\n class MixtralDecoderLayer(nn.Module):\n \n     def __init__(\n         self,\n         config: MixtralConfig,\n+        linear_method: Optional[LinearMethodBase] = None,\n     ) -> None:\n         super().__init__()\n         self.hidden_size = config.hidden_size\n         # Requires transformers > 4.32.0\n         rope_theta = getattr(config, \"rope_theta\", 10000)\n-        self.attention = MixtralAttention(\n+        self.self_attn = MixtralAttention(\n             hidden_size=self.hidden_size,\n             num_heads=config.num_attention_heads,\n             max_position=config.max_position_embeddings,\n             num_kv_heads=config.num_key_value_heads,\n             rope_theta=rope_theta,\n-            sliding_window=config.sliding_window)\n-        self.block_sparse_moe = BlockSparseMoE(\n-            hidden_dim=self.hidden_size,\n-            ffn_dim=config.intermediate_size,\n-            num_experts=config.num_local_experts,\n-            top_k=config.num_experts_per_tok,\n-        )\n-        self.attention_norm = RMSNorm(config.hidden_size,\n-                                      eps=config.rms_norm_eps)\n-        self.ffn_norm = RMSNorm(config.hidden_size, eps=config.rms_norm_eps)\n+            sliding_window=config.sliding_window,\n+            linear_method=linear_method)\n+        self.block_sparse_moe = MixtralMoE(config=config,\n+                                           linear_method=linear_method)\n+        self.input_layernorm = RMSNorm(config.hidden_size,\n+                                       eps=config.rms_norm_eps)\n+        self.post_attention_layernorm = RMSNorm(config.hidden_size,\n+                                                eps=config.rms_norm_eps)\n \n     def forward(\n         self,\n         positions: torch.Tensor,\n-        x: torch.Tensor,\n+        hidden_states: torch.Tensor,\n         kv_cache: KVCache,\n         input_metadata: InputMetadata,\n         cache_event: Optional[torch.cuda.Event],\n+        residual: Optional[torch.Tensor],\n     ) -> torch.Tensor:\n-        r = self.attention(\n+        # Self Attention\n+        if residual is None:\n+            residual = hidden_states\n+            hidden_states = self.input_layernorm(hidden_states)\n+        else:\n+            hidden_states, residual = self.input_layernorm(\n+                hidden_states, residual)\n+        hidden_states = self.self_attn(\n             positions=positions,\n-            hidden_states=self.attention_norm(x),\n+            hidden_states=hidden_states,\n             kv_cache=kv_cache,\n             input_metadata=input_metadata,\n             cache_event=cache_event,\n         )\n-        h = x + r\n-        r = self.block_sparse_moe(self.ffn_norm(h))\n-        out = h + r\n-        return out\n \n+        # Fully Connected\n+        hidden_states, residual = self.post_attention_layernorm(\n+            hidden_states, residual)\n+        hidden_states = self.block_sparse_moe(hidden_states)\n+        return hidden_states, residual\n \n-class MixtralForCausalLM(nn.Module):\n+\n+class MixtralModel(nn.Module):\n \n     def __init__(\n         self,\n@@ -448,23 +330,18 @@ class MixtralForCausalLM(nn.Module):\n         linear_method: Optional[LinearMethodBase] = None,\n     ) -> None:\n         super().__init__()\n-        self.config = config\n-        assert linear_method is None\n         self.padding_idx = config.pad_token_id\n         self.vocab_size = config.vocab_size\n-        self.tok_embeddings = VocabParallelEmbedding(\n+\n+        self.embed_tokens = VocabParallelEmbedding(\n             config.vocab_size,\n             config.hidden_size,\n         )\n-\n-        self.norm = RMSNorm(config.hidden_size, eps=config.rms_norm_eps)\n-        self.output = ParallelLMHead(config.vocab_size, config.hidden_size)\n-        self.sampler = Sampler(config.vocab_size)\n-\n         self.layers = nn.ModuleList([\n-            MixtralDecoderLayer(config)\n+            MixtralDecoderLayer(config, linear_method=linear_method)\n             for _ in range(config.num_hidden_layers)\n         ])\n+        self.norm = RMSNorm(config.hidden_size, eps=config.rms_norm_eps)\n \n     def forward(\n         self,\n@@ -474,20 +351,42 @@ class MixtralForCausalLM(nn.Module):\n         input_metadata: InputMetadata,\n         cache_events: Optional[List[torch.cuda.Event]],\n     ) -> SamplerOutput:\n-        hidden_states = self.tok_embeddings(input_ids)\n-\n-        # forward\n+        hidden_states = self.embed_tokens(input_ids)\n+        residual = None\n         for i in range(len(self.layers)):\n             cache_event = None if cache_events is None else cache_events[i]\n             layer = self.layers[i]\n-            hidden_states = layer(\n-                positions,\n-                hidden_states,\n-                kv_caches[i],\n-                input_metadata,\n-                cache_event,\n-            )\n-        hidden_states = self.norm(hidden_states)\n+            hidden_states, residual = layer(positions, hidden_states,\n+                                            kv_caches[i], input_metadata,\n+                                            cache_event, residual)\n+        hidden_states, _ = self.norm(hidden_states, residual)\n+        return hidden_states\n+\n+\n+class MixtralForCausalLM(nn.Module):\n+\n+    def __init__(\n+        self,\n+        config: MixtralConfig,\n+        linear_method: Optional[LinearMethodBase] = None,\n+    ) -> None:\n+        super().__init__()\n+        self.config = config\n+        self.linear_method = linear_method\n+        self.model = MixtralModel(config, linear_method)\n+        self.lm_head = ParallelLMHead(config.vocab_size, config.hidden_size)\n+        self.sampler = Sampler(config.vocab_size)\n+\n+    def forward(\n+        self,\n+        input_ids: torch.Tensor,\n+        positions: torch.Tensor,\n+        kv_caches: List[KVCache],\n+        input_metadata: InputMetadata,\n+        cache_events: Optional[List[torch.cuda.Event]],\n+    ) -> torch.Tensor:\n+        hidden_states = self.model(input_ids, positions, kv_caches,\n+                                   input_metadata, cache_events)\n         return hidden_states\n \n     def sample(\n@@ -495,7 +394,7 @@ class MixtralForCausalLM(nn.Module):\n         hidden_states: Optional[torch.Tensor],\n         sampling_metadata: SamplingMetadata,\n     ) -> SamplerOutput:\n-        next_tokens = self.sampler(self.output.weight, hidden_states,\n+        next_tokens = self.sampler(self.lm_head.weight, hidden_states,\n                                    sampling_metadata)\n         return next_tokens\n \n@@ -506,10 +405,11 @@ class MixtralForCausalLM(nn.Module):\n                      revision: Optional[str] = None):\n         stacked_params_mapping = [\n             # (param_name, shard_name, shard_id)\n-            (\"wqkv\", \"wq\", \"q\"),\n-            (\"wqkv\", \"wk\", \"k\"),\n-            (\"wqkv\", \"wv\", \"v\"),\n+            (\"qkv_proj\", \"q_proj\", \"q\"),\n+            (\"qkv_proj\", \"k_proj\", \"k\"),\n+            (\"qkv_proj\", \"v_proj\", \"v\"),\n         ]\n+\n         params_dict = dict(self.named_parameters())\n         for name, loaded_weight in hf_model_weights_iterator(\n                 model_name_or_path, cache_dir, load_format, revision):", "apis": ["vllm.model_executor.models.mixtral.MixtralAttention", "vllm.model_executor.models.mixtral.MixtralDecoderLayer", "vllm.model_executor.models.mixtral.MixtralModel", "vllm.model_executor.models.mixtral.MixtralForCausalLM", "vllm.model_executor.models.mixtral.MixtralMoE"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mixtral.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/config.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/config.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/config.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies several non-test source files, including Dockerfile changes, documentation updates, and comprehensive modifications in the Mixtral-related modules within the model executor. The changes are not trivial â€“ they completely rework the Mixtral architecture components (such as adding a new MixtralMoE module with expert parallelism, adjusting how projections and gating are handled, and replacing deprecated or less efficient implementations) in order to improve model performance. Despite the commit message using \"Optimize Mixtral with expert parallelism\", the changes are clearly performance oriented rather than simple refactoring, bug fixes, or feature additions. These modifications are designed to affect performance on the main inference APIs and are testable without requiring GPU-specific or hardware-specific contexts. Thus, this commit qualifies as performance/optimization related.", "llm_api_reason": "The commit removes the megablocks dependency from the Dockerfile and documentation and updates the Mixtral model implementation to support expert parallelism. In particular, it refactors key components in the Mixtral model such as the attention, decoder layer, and MoE implementations. New classes and modifications include changes to MixtralAttention (renaming â€œwqkvâ€ to â€œqkv_projâ€ and adding a linear_method parameter), the introduction of MixtralMLP, DummyModule, and a revised MixtralMoE for expert parallelism, as well as breaking out MixtralModel and MixtralForCausalLM to reflect these changes. These modifications affect the high-level Python APIs used for the Mixtral models."}
{"commit_hash": "ec3b5ce9ccb4262194a16a8b1c31ffd6b3b824b9", "pr_url": "https://github.com/vllm-project/vllm/pull/1338", "pr_date": "2023-10-13", "timeline_text": "Copy link Collaborator Yard1 commented Oct 13, 2023 Two main changes: if we are using a fast tokenizer, we do not enter the slow _convert_tokens_to_string_with_added_encoders loop as the fast tokenizers do not use it in base transformers Use cached properties for added_tokens_encoder and all_special_tokens . Those 2 changes improved detokenization speed for 4096 tokens from 13ms to 2ms. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 WoosukKwon reacted with heart emoji All reactions â¤ï¸ 1 reaction Improve detokenization performance 09e8491 Copy link Collaborator Author Yard1 commented Oct 13, 2023 cc @WoosukKwon @zhuohan123 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon self-requested a review October 13, 2023 16:43 WoosukKwon approved these changes Oct 13, 2023 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @Yard1 LGTM! Thanks for the contribution! This resolves the performance degradation after upgrading tokenizers. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/transformers_utils/tokenizer.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . WoosukKwon merged commit ec3b5ce into vllm-project : main Oct 13, 2023 Yard1 deleted the use_fast_tokenizer branch October 13, 2023 17:09 hongxiayang pushed a commit\n        to hongxiayang/vllm\n      that referenced\n      this pull request Feb 13, 2024 Improve detokenization performance ( vllm-project#1338 ) 69ae127 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:32", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": false, "test_details": "NONE", "analysis_extracted_at": "2025-09-07 17:49:32", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "Improve detokenization performance (#1338)", "commit_message": "Improve detokenization performance (#1338)", "commit_date": "2023-10-13T09:59:07-07:00", "files_changed": ["vllm/transformers_utils/tokenizer.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 7, "num_non_test_edited_lines": 7, "commit_year": 2023}, "diff_text": "diff --git a/vllm/transformers_utils/tokenizer.py b/vllm/transformers_utils/tokenizer.py\nindex 6dafdac96..49e7007ae 100644\n--- a/vllm/transformers_utils/tokenizer.py\n+++ b/vllm/transformers_utils/tokenizer.py\n@@ -81,10 +81,11 @@ def _convert_tokens_to_string_with_added_encoders(\n     # even when the loop body is very simple.\n     sub_texts = []\n     current_sub_text = []\n+    all_special_tokens = set(tokenizer.all_special_tokens)\n     for token in output_tokens:\n-        if skip_special_tokens and token in tokenizer.all_special_tokens:\n+        if skip_special_tokens and token in all_special_tokens:\n             continue\n-        if token in tokenizer.added_tokens_encoder:\n+        if token in tokenizer.get_added_vocab():\n             if current_sub_text:\n                 sub_text = tokenizer.convert_tokens_to_string(current_sub_text)\n                 sub_texts.append(sub_text)\n@@ -129,7 +130,7 @@ def detokenize_incrementally(\n     # The prefix text is necessary only to defeat cleanup algorithms in\n     # the decode which decide to add a space or not depending on the\n     # surrounding ids.\n-    if not getattr(tokenizer, \"added_tokens_encoder\", {}):\n+    if tokenizer.is_fast or not tokenizer.get_added_vocab():\n         prefix_text = tokenizer.convert_tokens_to_string(\n             output_tokens[prefix_offset:read_offset])\n         new_text = tokenizer.convert_tokens_to_string(", "apis": ["vllm.transformers_utils.tokenizer.get_tokenizer", "vllm.transformers_utils.detokenizer_utils.detokenize_incrementally"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/tokenizer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/detokenizer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/detokenizer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/tokenizer_base.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file (tokenizer.py) in a non-trivial way by revising how special tokens are checked and how the added vocabulary is used, with an intention to improve the performance of tokenization/detokenization. The changes are not just cosmetic or refactoring; they adjust the logic to potentially optimize the performance of detokenization on the CPU. The commit message \"Improve detokenization performance\" aligns with the performance optimization goal, and the modifications are applied to a high-level API for tokenization which can impact overall efficiency. Therefore, this commit satisfies the conditions for being performance or optimization related.", "llm_api_reason": "This commit makes performance improvements to the detokenization process. It refactors how special tokens are checked during conversion by precomputing the set of all special tokens and by replacing direct attribute access of added token mappings (i.e. tokenizer.added_tokens_encoder) with a method call (i.e. tokenizer.get_added_vocab()). In addition, an extra condition is now used (using tokenizer.is_fast) to decide which branch of the detokenization logic to use. These changes affect the internal incremental detokenization routines that higherâ€level APIs rely upon for converting model output tokens into text."}
{"commit_hash": "c45f3c3ab60f4bf4eaab791a76028b8b07ffe9bd", "pr_url": "https://github.com/vllm-project/vllm/pull/17", "pr_date": "2023-03-31", "timeline_text": "Copy link Member zhuohan123 commented Mar 31, 2023 Speed before this PR: ubuntu@ray-zhuohan-cf-head-d95da8d2-compute:~/nfs/cacheflow/cacheflow$ python benchmark/benchmark_latency.py --model facebook/opt-13b\nNamespace(batch_size=8, block_size=8, dtype='half', input_len=32, max_batch_size=2560, model='facebook/opt-13b', model_path='~/.cacheflow/model_weights', output_len=128, pipeline_parallel_size=1, seed=0, swap_space=20, tens\nor_parallel_size=1)\n2023-03-31 14:17:41,580 INFO worker.py:1535 -- Started a local Ray instance. View the dashboard at http://127.0.0.1:8266\n# GPU blocks: 1975, # CPU blocks: 3276\nWarm up step\nProfile step: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:15<00:00,  5.18s/it]\nAvg latency: 5.184098243713379 seconds Speed after this PR: ubuntu@ray-zhuohan-cf-head-d95da8d2-compute:~/nfs/cacheflow/cacheflow$ python benchmark/benchmark_latency.py --model facebook/opt-13b\nNamespace(batch_size=8, block_size=8, dtype='half', input_len=32, max_batch_size=2560, model='facebook/opt-13b', model_path='~/.cacheflow/model_weights', output_len=128, pipeline_parallel_size=1, seed=0, swap_space=20, tensor_parallel_size=1)\n2023-03-31 15:20:04,885 INFO worker.py:1535 -- Started a local Ray instance. View the dashboard at http://127.0.0.1:8266\n# GPU blocks: 1975, # CPU blocks: 3276\nWarm up step\nProfile step: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:10<00:00,  3.49s/it]\nAvg latency: 3.492198626200358 seconds Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions zhuohan123 added 2 commits March 31, 2023 15:25 Optimize tensor parallel execution speed a32f244 add more files c3e6bce zhuohan123 requested a review\n  from WoosukKwon March 31, 2023 15:32 WoosukKwon approved these changes Mar 31, 2023 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Awesome! Thanks for the effort. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon reviewed Mar 31, 2023 View reviewed changes benchmark/benchmark_latency.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . nit 2bea93e zhuohan123 merged commit c45f3c3 into main Mar 31, 2023 zhuohan123 deleted the optimize-tp-speed branch June 18, 2023 07:22 shanshanpt mentioned this pull request Nov 17, 2023 Run long conetxt error : CUDA error: an illegal memory access was encountered #1700 Closed junior-zsy mentioned this pull request Nov 20, 2023 Error with 32k Long Text in chatglm2-6b-32k Model #1725 Closed hongxiayang pushed a commit\n        to hongxiayang/vllm\n      that referenced\n      this pull request Feb 13, 2024 Optimize tensor parallel execution speed ( vllm-project#17 ) ad3d36f AdrianAbeyta referenced\n      this pull request\n        in ROCm/vllm Mar 8, 2024 Merge pull request #17 from ROCm/IFU-2024-03-01-fp8-kv â€¦ b3d81e0 Rebase fp8_kv branch with upstream (3-07-2024) z103cb referenced\n      this pull request\n        in z103cb/opendatahub_vllm Apr 22, 2024 Compile kernels and fix build ( opendatahub-io#17 ) â€¦ 15076fa These Dockerfile changes:\n- Update the release stage to work with the recently refactored\n`requirements-common.txt` / `requirements-cuda.txt` split\n- Fixup the kernel compilation in the `build` stage to correctly pick up\ncuda\n- Install the kernels from this docker build rather than pulling a\nprecompiled wheel. We can swap that back once a new wheel is available\nwith the correct pytorch version + updated interfaces\n\n---------\n\nSigned-off-by: Nick Hill <nickhill@us.ibm.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com> fxmarty pushed a commit\n        to fxmarty/vllm-public\n      that referenced\n      this pull request May 31, 2024 Merge pull request vllm-project#17 from ROCm/triton-config-fix â€¦ bebcbe6 [ROCm] adding a missing triton autotune config alixiaodi mentioned this pull request Aug 2, 2024 [Bug]: #7072 Closed SpaceHunterInf mentioned this pull request Sep 30, 2024 [Bug]: Bus error (core dumped) #8974 Closed 1 task wuhuikx pushed a commit\n        to wuhuikx/vllm\n      that referenced\n      this pull request Mar 27, 2025 [Platform] add dispatch key ( vllm-project#17 ) â€¦ dd425d6 ### What this PR does / why we need it?\nAdd dispatch key for NPU, so that the log could be print correctly.\n\nNow\n```\nexecutor_base.py:110] # CPU blocks: 220478, # CPU blocks: 21845\n```\n\nAfter this pr\n```\nexecutor_base.py:110] # NPU blocks: 220478, # CPU blocks: 21845\n```\n\n### Does this PR introduce _any_ user-facing change?\nN/A\n\n### How was this patch tested?\nCI passed and log printed as above\n\nSigned-off-by: MengqingCao <cmq0113@163.com> hao-cold mentioned this pull request May 13, 2025 [Bug]: CUDA error: an illegal instruction was encountered #18045 Open 1 task markmc mentioned this pull request May 21, 2025 [Bug][Failing Test]: Distributed Comm Ops - distributed/test_shm_broadcast.py #18492 Closed 1 task zerosurplus mentioned this pull request Jun 16, 2025 [Bug]: torch.distributed.DistNetworkError: The client socket has timed out after 600000ms while trying to connect to (172.17.0.9, 46229). #19670 Open 1 task robertgshaw2-redhat added a commit\n      that referenced\n      this pull request Jul 7, 2025 Merge pull request #17 from praveingk/batching â€¦ 39e6bd1 Load balance across multiple workers xiaomofang mentioned this pull request Jul 31, 2025 [Bug]: There is an issue with speculative inference in Eagle mode, where the context length of vLLM inference is constrained by the draft model. #21986 Open 1 task zyongye pushed a commit\n        to zyongye/vllm\n      that referenced\n      this pull request Aug 5, 2025 Add TRT-LLM Attention Sink and MXFP4 MoE ( vllm-project#17 ) 78e69f6 zyongye pushed a commit\n        to zyongye/vllm\n      that referenced\n      this pull request Aug 6, 2025 Add TRT-LLM Attention Sink and MXFP4 MoE ( vllm-project#17 ) 2cc41a7 JeffreyWong20 mentioned this pull request Aug 19, 2025 [Bug]: [TPU] profiling_tpu/profiling.py example crashed when runs on vllm_tpu docker #23194 Closed 1 task Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:36", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: latency, latency, Profile | TEST: Test, CI", "analysis_extracted_at": "2025-09-07 17:49:36", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python benchmark/benchmark_latency.py --model facebook/opt-13b", "commit_subject": "Optimize tensor parallel execution speed (#17)", "commit_message": "Optimize tensor parallel execution speed (#17)", "commit_date": "2023-04-01T00:51:08+08:00", "files_changed": ["benchmark/benchmark_latency.py", "cacheflow/parallel_utils/tensor_parallel/__init__.py", "cacheflow/parallel_utils/tensor_parallel/layers.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 1, "num_files": 3, "num_hunks": 15, "num_edited_lines": 390, "num_non_test_edited_lines": 390, "commit_year": 2023}, "diff_text": "diff --git a/benchmark/benchmark_latency.py b/benchmark/benchmark_latency.py\nnew file mode 100644\nindex 000000000..a18ef98f4\n--- /dev/null\n+++ b/benchmark/benchmark_latency.py\n@@ -0,0 +1,99 @@\n+import argparse\n+import time\n+from typing import List\n+\n+from tqdm import tqdm\n+import numpy as np\n+import torch\n+\n+from cacheflow.master.simple_frontend import SimpleFrontend\n+from cacheflow.master.server import (Server, add_server_arguments,\n+                                     initialize_ray_cluster)\n+from cacheflow.sampling_params import SamplingParams\n+from cacheflow.utils import get_gpu_memory, get_cpu_memory\n+\n+\n+def main(args: argparse.Namespace):\n+    # TODO(zhuohan): Support pipeline parallelism.\n+    assert args.pipeline_parallel_size == 1, (\n+        'Pipeline parallelism is not supported yet.')\n+\n+    (num_nodes, num_devices_per_node, distributed_init_method,\n+    all_stage_devices) = (\n+        initialize_ray_cluster(\n+            address='local',\n+            pipeline_parallel_size=args.pipeline_parallel_size,\n+            tensor_parallel_size=args.tensor_parallel_size))\n+\n+    # Create a server.\n+    server = Server(\n+        model=args.model,\n+        model_path=args.model_path,\n+        pipeline_parallel_size=args.pipeline_parallel_size,\n+        tensor_parallel_size=args.tensor_parallel_size,\n+        block_size=args.block_size,\n+        dtype=args.dtype,\n+        seed=args.seed,\n+        swap_space=args.swap_space,\n+        max_batch_size=args.max_batch_size,\n+        num_nodes=num_nodes,\n+        num_devices_per_node=num_devices_per_node,\n+        distributed_init_method=distributed_init_method,\n+        all_stage_devices=all_stage_devices,\n+        gpu_memory=get_gpu_memory(),\n+        cpu_memory=get_cpu_memory(),\n+    )\n+\n+    # Create a frontend.\n+    frontend = SimpleFrontend(\n+        model_name=args.model,\n+        block_size=args.block_size,\n+    )\n+    sampling_params_dict = {\n+        'n': 1,\n+        'temperature': 0.0,\n+        'top_p': 1.0,\n+        'use_beam_search': False,\n+        'stop_token_ids': set(),\n+        'max_num_steps': args.output_len,\n+    }\n+    sampling_params = SamplingParams.from_dict(sampling_params_dict)\n+    input_token_ids = [0] * args.input_len\n+\n+    def profile_step(profile=False):\n+        if profile:\n+            torch.cuda.cudart().cudaProfilerStart()\n+        for _ in range(args.batch_size):\n+            frontend._add_query(input_token_ids, sampling_params)\n+        server.add_sequence_groups(frontend.get_inputs())\n+        start_time = time.time()\n+        while True:\n+            server.step()\n+            if not server.has_unfinished_requests():\n+                break\n+        end_time = time.time()\n+        latency = end_time - start_time\n+        if profile:\n+            torch.cuda.cudart().cudaProfilerStop()\n+        return latency\n+\n+    print(\"Warm up step\")\n+    profile_step()\n+\n+    # Benchmark.\n+    latencies = []\n+    for _ in tqdm(range(3), desc=\"Profile step\"):\n+        latencies.append(profile_step())\n+    print(f'Avg latency: {np.mean(latencies)} seconds')\n+\n+\n+if __name__ == '__main__':\n+    parser = argparse.ArgumentParser(description='CacheFlow simple server.')\n+    parser = add_server_arguments(parser)\n+    parser.add_argument('--input-len', type=int, default=32)\n+    parser.add_argument('--output-len', type=int, default=128)\n+    parser.add_argument('--batch-size', type=int, default=8)\n+    args = parser.parse_args()\n+    args.max_batch_size = max(args.max_batch_size, args.batch_size * args.input_len)\n+    print(args)\n+    main(args)\ndiff --git a/cacheflow/parallel_utils/tensor_parallel/__init__.py b/cacheflow/parallel_utils/tensor_parallel/__init__.py\nindex fba4f9abe..246f5f6f2 100644\n--- a/cacheflow/parallel_utils/tensor_parallel/__init__.py\n+++ b/cacheflow/parallel_utils/tensor_parallel/__init__.py\n@@ -6,8 +6,6 @@ from .layers import (\n     set_defaults_if_not_set_tensor_model_parallel_attributes,\n     copy_tensor_model_parallel_attributes,\n     param_is_not_tensor_parallel_duplicate,\n-    linear_with_grad_accumulation_and_async_allreduce\n-\n )\n \n from .mappings import (\n@@ -39,7 +37,6 @@ __all__ = [\n     \"set_defaults_if_not_set_tensor_model_parallel_attributes\",\n     \"copy_tensor_model_parallel_attributes\",\n     \"param_is_not_tensor_parallel_duplicate\",\n-    \"linear_with_grad_accumulation_and_async_allreduce\",\n     # mappings.py\n     \"copy_to_tensor_model_parallel_region\",\n     \"gather_from_tensor_model_parallel_region\",\ndiff --git a/cacheflow/parallel_utils/tensor_parallel/layers.py b/cacheflow/parallel_utils/tensor_parallel/layers.py\nindex 978ca04e6..f9ba8385c 100644\n--- a/cacheflow/parallel_utils/tensor_parallel/layers.py\n+++ b/cacheflow/parallel_utils/tensor_parallel/layers.py\n@@ -3,10 +3,6 @@\n # Parts of the code here are adapted from PyTorch\n # repo: https://github.com/pytorch/pytorch\n \n-import math\n-import os\n-from typing import Optional\n-import warnings\n \n import torch\n import torch.nn.functional as F\n@@ -16,31 +12,20 @@ from torch.nn.parameter import Parameter\n from cacheflow.parallel_utils.parallel_state import (\n     get_tensor_model_parallel_rank,\n     get_tensor_model_parallel_world_size,\n-    get_tensor_model_parallel_group,\n-    get_global_memory_buffer,\n )\n from .mappings import (\n     copy_to_tensor_model_parallel_region,\n     gather_from_tensor_model_parallel_region,\n-    gather_from_sequence_parallel_region,\n     reduce_from_tensor_model_parallel_region,\n     scatter_to_tensor_model_parallel_region,\n-    reduce_scatter_to_sequence_parallel_region,\n )\n \n from .random import get_cuda_rng_tracker\n from .utils import (\n     divide,\n-    split_tensor_along_last_dim,\n     VocabUtility,\n )\n \n-_grad_accum_fusion_available = True\n-try:\n-    import fused_weight_gradient_mlp_cuda\n-except ImportError:\n-    _grad_accum_fusion_available = False\n-\n _MODEL_PARALLEL_ATTRIBUTE_DEFAULTS = {'tensor_model_parallel': False,\n                                       'partition_dim': -1,\n                                       'partition_stride': 1}\n@@ -216,202 +201,6 @@ class VocabParallelEmbedding(torch.nn.Module):\n         return output\n \n \n-class LinearWithGradAccumulationAndAsyncCommunication(torch.autograd.Function):\n-    \"\"\"See linear_with_grad_accumulation_and_async_allreduce\"\"\"\n-\n-    @staticmethod\n-    def forward(ctx, input, weight, bias, gradient_accumulation_fusion,\n-                async_grad_allreduce, sequence_parallel):\n-        ctx.save_for_backward(input, weight)\n-        ctx.use_bias = bias is not None\n-        ctx.gradient_accumulation_fusion = gradient_accumulation_fusion\n-        ctx.async_grad_allreduce = async_grad_allreduce\n-        ctx.sequence_parallel = sequence_parallel\n-\n-        if sequence_parallel:\n-            world_size = get_tensor_model_parallel_world_size()\n-            dim_size = list(input.size())\n-            dim_size[0] = dim_size[0] * world_size\n-\n-            all_gather_buffer = \\\n-                get_global_memory_buffer().get_tensor(dim_size, input.dtype, \"mpu\")\n-            torch.distributed._all_gather_base(\n-                all_gather_buffer,\n-                input,\n-                group=get_tensor_model_parallel_group())\n-            total_input = all_gather_buffer\n-        else:\n-            total_input = input\n-\n-        output = torch.matmul(total_input, weight.t())\n-        if bias is not None:\n-            output = output + bias\n-        return output\n-\n-    @staticmethod\n-    def backward(ctx, grad_output):\n-        input, weight = ctx.saved_tensors\n-        use_bias = ctx.use_bias\n-\n-        if ctx.sequence_parallel:\n-            world_size = get_tensor_model_parallel_world_size()\n-            dim_size = list(input.size())\n-            dim_size[0] = dim_size[0] * world_size\n-\n-            all_gather_buffer = \\\n-                get_global_memory_buffer().get_tensor(dim_size, input.dtype, \"mpu\")\n-            handle = torch.distributed._all_gather_base(\n-                all_gather_buffer,\n-                input,\n-                group=get_tensor_model_parallel_group(), async_op=True)\n-\n-            # Here we rely on CUDA_DEVICE_MAX_CONNECTIONS=1 to ensure that the\n-            # gather is scheduled before the input gradient computation\n-            total_input = all_gather_buffer\n-        else:\n-            total_input = input\n-        grad_input = grad_output.matmul(weight)\n-\n-        if ctx.sequence_parallel:\n-            handle.wait()\n-\n-        # Convert the tensor shapes to 2D for execution compatibility\n-        grad_output = grad_output.view(grad_output.shape[0] * grad_output.shape[1],\n-                                       grad_output.shape[2])\n-        total_input = total_input.view(total_input.shape[0] * total_input.shape[1],\n-\t\t\t\t       total_input.shape[2])\n-\n-        if ctx.async_grad_allreduce:\n-            # Asynchronous all-reduce\n-            handle = torch.distributed.all_reduce(\n-                    grad_input, group=get_tensor_model_parallel_group(), async_op=True)\n-            # Here we rely on CUDA_DEVICE_MAX_CONNECTIONS=1 to ensure that the\n-            # all-reduce is scheduled before the weight gradient computation\n-\n-        if ctx.sequence_parallel:\n-            assert not ctx.async_grad_allreduce\n-            dim_size = list(input.size())\n-            sub_grad_input = torch.empty(dim_size, dtype=input.dtype,\n-                                         device=torch.cuda.current_device(),\n-                                         requires_grad=False)\n-            # reduce_scatter\n-            handle = torch.distributed._reduce_scatter_base(sub_grad_input, grad_input,\n-                                                            group=get_tensor_model_parallel_group(),\n-                                                            async_op=True)\n-            # Here we rely on CUDA_DEVICE_MAX_CONNECTIONS=1 to ensure that the\n-            # reduce scatter is scheduled before the weight gradient computation\n-\n-\n-        if ctx.gradient_accumulation_fusion:\n-            if weight.main_grad.dtype == torch.float32:\n-                fused_weight_gradient_mlp_cuda.wgrad_gemm_accum_fp32(total_input, grad_output, weight.main_grad)\n-            elif weight.main_grad.dtype == torch.float16:\n-                fused_weight_gradient_mlp_cuda.wgrad_gemm_accum_fp16(total_input, grad_output, weight.main_grad)\n-            else:\n-                raise RuntimeError(\"Unsupported gradient type for gradient accumulation fusion\")\n-            grad_weight = None\n-        else:\n-            grad_weight = grad_output.t().matmul(total_input)\n-        grad_bias = grad_output.sum(dim=0) if use_bias else None\n-\n-        if ctx.sequence_parallel:\n-            handle.wait()\n-            return sub_grad_input, grad_weight, grad_bias, None, None, None\n-\n-        if ctx.async_grad_allreduce:\n-            handle.wait()\n-\n-        return grad_input, grad_weight, grad_bias, None, None, None\n-\n-def linear_with_grad_accumulation_and_async_allreduce(\n-    input: torch.Tensor,\n-    weight: torch.Tensor,\n-    bias: Optional[torch.Tensor],\n-    gradient_accumulation_fusion: bool,\n-    async_grad_allreduce: bool,\n-    sequence_parallel_enabled: bool,\n-) -> torch.Tensor:\n-    \"\"\"Linear layer execution with asynchronous communication and\n-    gradient accumulation fusion in backprop.\n-\n-    This has the option to accumulate the result of backprop\n-    calculation into an existing gradient buffer, preventing the need\n-    to do an additional addition kernel after the gradient\n-    calculation.\n-\n-    Additionally, the tensor parallel all reduce of the input\n-    gradients can be done asynchronously with the calculation of\n-    the weight gradients.\n-\n-    In the case of sequence parallelism, the reduce scatter of the\n-    input gradients is done asynchronously with the calcluation of the\n-    weight gradients.\n-\n-    Use of this module requires that the environment variable\n-    CUDA_DEVICE_MAX_CONNECTIONS=1. There are a few collective\n-    operations, noted in the code, that should be scheduled before\n-    compute kernels to overlap the communication with the computation,\n-    which is necessary for a speedup but not for correctness so that\n-    ordering isn't imposed by the scheduler. Setting\n-    CUDA_DEVICE_MAX_CONNECTIONS=1 forces the kernels to be scheduled\n-    in the order they are called.\n-\n-    Arguments:\n-\n-    input (torch.Tensor required): input like torch.nn.functional.linear\n-\n-    weight (torch.Tensor required): weight like torch.nn.functional.linear\n-\n-    bias (torch.Tensor optional): bias like torch.nn.functional.linear\n-\n-    gradient_accumulation_fusion (bool required): Perform the gradient\n-        accumulation fusion, requires the custom CUDA extension\n-        fused_weight_gradient_mlp_cuda module. To use\n-        gradient_accumulation_fusion you must install APEX with\n-        --cpp_ext and --cuda_ext. For example: \"pip install\n-        --global-option=\\\"--cpp_ext\\\" --global-option=\\\"--cuda_ext .\\\"\n-        \" Note that the extension requires CUDA>=11. Otherwise, you\n-        must turn off gradient accumulation fusion.\"\n-\n-    async_grad_allreduce (bool required): Do the allreduce of input\n-        gradients asyncronously with the computation of weight\n-        gradients. If sequence_parallel_enabled is True, this must be\n-        False, as no all reduce is performed.\n-\n-    sequence_parallel_enabled (bool required): Indicates that sequence\n-        parallelism is used and thus in the forward pass the input is\n-        all gathered, and the backward pass the input gradients are\n-        reduce scattered.\n-    \"\"\"\n-    args = [\n-        input,\n-        weight,\n-        bias,\n-        gradient_accumulation_fusion,\n-        async_grad_allreduce,\n-        sequence_parallel_enabled,\n-    ]\n-\n-    if not linear_with_grad_accumulation_and_async_allreduce.warned:\n-        if os.environ.get('CUDA_DEVICE_MAX_CONNECTIONS') != \"1\":\n-            if sequence_parallel_enabled:\n-                warnings.warn(\n-                    \"When using sequence parallelism it is recommended to set the \"\n-                    \"environment variable CUDA_DEVICE_MAX_CONNECTIONS to 1 for \"\n-                    \"maximum speedup\")\n-                linear_with_grad_accumulation_and_async_allreduce.warned = True\n-\n-            if async_grad_allreduce:\n-                warnings.warn(\n-                    \"When using async grad allreduce it is recommended to set the \"\n-                    \"environment variable CUDA_DEVICE_MAX_CONNECTIONS to 1 for \"\n-                    \"maximum speedup\")\n-                linear_with_grad_accumulation_and_async_allreduce.warned = True\n-\n-    with torch.cuda.amp.autocast(enabled=False):\n-        return LinearWithGradAccumulationAndAsyncCommunication.apply(*args)\n-linear_with_grad_accumulation_and_async_allreduce.warned = False\n-\n class ColumnParallelLinear(torch.nn.Module):\n     \"\"\"Linear layer with column parallelism.\n \n@@ -436,11 +225,8 @@ class ColumnParallelLinear(torch.nn.Module):\n         skip_bias_add: This was added to enable performance optimations where bias\n                        can be fused with other elementwise operations. we skip\n                        adding bias but instead return it.\n-        async_tensor_model_parallel_allreduce:\n         params_dtype:\n         use_cpu_initialization:\n-        gradient_accumulation_fusion:\n-        sequence_parallel_enabled:\n     \"\"\"\n \n     def __init__(self, input_size, output_size, *,\n@@ -448,12 +234,9 @@ class ColumnParallelLinear(torch.nn.Module):\n                  init_method=init.xavier_normal_, stride=1,\n                  keep_master_weight_for_test=False,\n                  skip_bias_add=False,\n-                 async_tensor_model_parallel_allreduce=True,\n                  params_dtype=None,\n                  use_cpu_initialization=False,\n                  perform_initialization=True,\n-                 gradient_accumulation_fusion=False,\n-                 sequence_parallel_enabled: bool = False,\n                  ):\n         super(ColumnParallelLinear, self).__init__()\n \n@@ -506,37 +289,6 @@ class ColumnParallelLinear(torch.nn.Module):\n         else:\n             self.register_parameter('bias', None)\n \n-        self.async_tensor_model_parallel_allreduce = (\n-                async_tensor_model_parallel_allreduce and\n-                world_size > 1)\n-        if sequence_parallel_enabled:\n-            if world_size <= 1:\n-                warnings.warn(\n-                    f\"`sequence_parallel_enabled` is set to `True`, but tensor model parallel size is {world_size}. \"\n-                    f\"Disabling sequence parallel.\"\n-                )\n-                sequence_parallel_enabled = False\n-        self.sequence_parallel_enabled = sequence_parallel_enabled\n-\n-        if gradient_accumulation_fusion:\n-            if not _grad_accum_fusion_available:\n-                raise RuntimeError(\n-                    \"ColumnParallelLinear was called with gradient_accumulation_fusion set \"\n-                    \"to True but the custom CUDA extension fused_weight_gradient_mlp_cuda \"\n-                    \"module is not found. To use gradient_accumulation_fusion you must \"\n-                    \"install APEX with --cpp_ext and --cuda_ext. For example: \"\n-                    \"pip install --global-option=\\\"--cpp_ext\\\" --global-option=\\\"--cuda_ext .\\\" \"\n-                    \"Note that the extension requires CUDA>=11. Otherwise, you must turn off \"\n-                    \"gradient accumulation fusion.\"\n-                )\n-        self.gradient_accumulation_fusion = gradient_accumulation_fusion\n-\n-        if self.async_tensor_model_parallel_allreduce and self.sequence_parallel_enabled:\n-            raise RuntimeError(\n-                \"`async_tensor_model_parallel_allreduce` and `sequence_parallel_enabled` \"\n-                \"cannot be enabled at the same time.\"\n-            )\n-\n \n     def forward(self, input_):\n         \"\"\"Forward of ColumnParallelLinear\n@@ -550,23 +302,11 @@ class ColumnParallelLinear(torch.nn.Module):\n         \"\"\"\n         bias = self.bias if not self.skip_bias_add else None\n \n-        if self.async_tensor_model_parallel_allreduce or \\\n-                self.sequence_parallel_enabled:\n-            input_parallel = input_\n-        else:\n-            input_parallel = copy_to_tensor_model_parallel_region(input_)\n+        input_parallel = copy_to_tensor_model_parallel_region(input_)\n         # Matrix multiply.\n-        output_parallel = linear_with_grad_accumulation_and_async_allreduce(\n-            input=input_parallel,\n-            weight=self.weight,\n-            bias=bias,\n-            gradient_accumulation_fusion=self.gradient_accumulation_fusion,\n-            async_grad_allreduce=self.async_tensor_model_parallel_allreduce,\n-            sequence_parallel_enabled=self.sequence_parallel_enabled,\n-        )\n+        output_parallel = F.linear(input_parallel, self.weight, bias)\n         if self.gather_output:\n             # All-gather across the partitions.\n-            assert not self.sequence_parallel_enabled\n             output = gather_from_tensor_model_parallel_region(output_parallel)\n         else:\n             output = output_parallel\n@@ -607,8 +347,6 @@ class RowParallelLinear(torch.nn.Module):\n         params_dtype:\n         use_cpu_initialization:\n         perform_initialization:\n-        gradient_accumulation_fusion:\n-        sequence_parallel_enabled:\n     \"\"\"\n \n     def __init__(self, input_size, output_size, *,\n@@ -619,8 +357,6 @@ class RowParallelLinear(torch.nn.Module):\n                  params_dtype=None,\n                  use_cpu_initialization=False,\n                  perform_initialization=True,\n-                 gradient_accumulation_fusion=False,\n-                 sequence_parallel_enabled: bool = False,\n                  ):\n         super(RowParallelLinear, self).__init__()\n \n@@ -635,10 +371,6 @@ class RowParallelLinear(torch.nn.Module):\n         world_size = get_tensor_model_parallel_world_size()\n         self.input_size_per_partition = divide(input_size, world_size)\n         self.skip_bias_add = skip_bias_add\n-        self.gradient_accumulation_fusion = gradient_accumulation_fusion\n-        self.sequence_parallel_enabled = sequence_parallel_enabled\n-        if self.sequence_parallel_enabled and not self.input_is_parallel:\n-            raise RuntimeError(\"To enable `sequence_parallel_enabled`, `input_is_parallel` must be `True`\")\n \n         # Parameters.\n         # Note: torch.nn.functional.linear performs XA^T + b and as a result\n@@ -669,7 +401,6 @@ class RowParallelLinear(torch.nn.Module):\n                 self.bias = Parameter(torch.empty(\n                     self.output_size, device=torch.cuda.current_device(),\n                     dtype=params_dtype))\n-            setattr(self.bias, 'sequence_parallel', sequence_parallel_enabled)\n \n             # Always initialize bias to zero.\n             with torch.no_grad():\n@@ -693,23 +424,12 @@ class RowParallelLinear(torch.nn.Module):\n         if self.input_is_parallel:\n             input_parallel = input_\n         else:\n-            assert not self.sequence_parallel_enabled\n             input_parallel = scatter_to_tensor_model_parallel_region(input_)\n         # Matrix multiply.\n-        output_parallel = linear_with_grad_accumulation_and_async_allreduce(\n-            input=input_parallel,\n-            weight=self.weight,\n-            bias=None,\n-            gradient_accumulation_fusion=self.gradient_accumulation_fusion,\n-            async_grad_allreduce=False,\n-            sequence_parallel_enabled=False,\n-        )\n+        output_parallel = F.linear(input_parallel, self.weight)\n \n         # All-reduce across all the partitions.\n-        if self.sequence_parallel_enabled:\n-            output_ = reduce_scatter_to_sequence_parallel_region(output_parallel)\n-        else:\n-            output_ = reduce_from_tensor_model_parallel_region(output_parallel)\n+        output_ = reduce_from_tensor_model_parallel_region(output_parallel)\n         if not self.skip_bias_add:\n             output = output_ + self.bias if self.bias is not None else output_\n             output_bias = None", "apis": ["Server", "SimpleFrontend", "ColumnParallelLinear.forward", "RowParallelLinear.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/adapter_commons/layers.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/layers.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/benchmark_latency.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit makes non-trivial modifications to production code (e.g., changes in tensor parallel implementations) and adds a new benchmark tool, showing that its purpose is to optimize the performance of tensor parallel execution. The commit removes custom asynchronous gradient accumulation fusion and related all-reduce operations in favor of a simpler, probably faster F.linear implementation. These changes target CPU-tested tensor parallel execution speed improvements and are not just refactoring or bug fixes. Therefore, it satisfies the conditions for a performance or optimization related commit.", "llm_api_reason": "This commit introduces a new benchmark script that directly calls cacheflowâ€™s Server and SimpleFrontend classes, and it refactors tensor-parallel linear layers by removing the custom asynchronous gradient accumulation function. In particular, the ColumnParallelLinear and RowParallelLinear forward methods have been updated to use a more straightforward implementation (calling F.linear directly), which affects their public Python APIs. Overall, the changes impact high-level APIs exposed by the server/front-end and the tensor-parallel layers."}
{"commit_hash": "d4bc1a4d248a5d23e1f731ecb53511a9a54f5dfc", "pr_url": "No PR found", "pr_date": null, "timeline_text": "", "timeline_extracted_at": null, "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": false, "test_details": "NO_PR", "analysis_extracted_at": "", "models": ["facebook/opt-125m", "facebook/opt-350m", "facebook/opt-1.3b", "facebook/opt-2.7b", "facebook/opt-6.7b"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=facebook/opt-125m --tasks lambada_openai --batch_size 32"], "perf_command": "python benchmarks/benchmark_serving.py --model facebook/opt-125m --num-prompts 100", "commit_subject": "Add unoptimized OPT Attention", "commit_message": "Add unoptimized OPT Attention", "commit_date": "2023-02-23T09:31:55Z", "files_changed": ["cacheflow/models/attention.py", "cacheflow/models/opt.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 9, "num_edited_lines": 191, "num_non_test_edited_lines": 191, "commit_year": 2023}, "diff_text": "diff --git a/cacheflow/models/attention.py b/cacheflow/models/attention.py\nnew file mode 100644\nindex 000000000..c36f06c79\n--- /dev/null\n+++ b/cacheflow/models/attention.py\n@@ -0,0 +1,118 @@\n+from typing import Optional, Tuple\n+\n+import torch\n+import torch.nn as nn\n+import xformers.ops as xops\n+\n+from cacheflow import ops\n+from cacheflow.models import InputMetadata\n+\n+\n+class OPTCacheFlowAttention(nn.Module):\n+\n+    def __init__(self, scale: float) -> None:\n+        super().__init__()\n+        self.scale = scale\n+\n+        # Shape-agnostic attention mask.\n+        self.attention_mask = xops.LowerTriangularMask()\n+\n+    def multi_query_kv_attention(\n+        self,\n+        output: torch.Tensor,\n+        query: torch.Tensor,\n+        key: torch.Tensor,\n+        value: torch.Tensor,\n+    ) -> None:\n+        out = xops.memory_efficient_attention(\n+            query, key, value, attn_bias=self.attention_mask, scale=self.scale)\n+        # FIXME(woosuk): Directly write the attention output.\n+        output.copy_(out, non_blocking=True)\n+\n+    def single_query_cached_kv_attention(\n+        self,\n+        output: torch.Tensor,\n+        query: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        input_metadata: InputMetadata,\n+    ) -> None:\n+        num_heads = value_cache.shape[1]\n+        head_size = value_cache.shape[3]\n+        block_size = value_cache.shape[2]\n+        block_tables = input_metadata.block_tables\n+\n+        # FIXME(woosuk): Replace the following with a custom op.\n+        for i in range(input_metadata.num_generation_tokens):\n+            q = query[i]\n+            block_table = block_tables[i]\n+            context_len = int(input_metadata.context_lens[i])\n+            keys = []\n+            for j in range(context_len):\n+                block_number = block_table[j // block_size]\n+                block_offset = j % block_size\n+                k = key_cache[block_number, :, :, block_offset, :]\n+                k = k.view(num_heads, head_size)\n+                keys.append(k)\n+            keys = torch.stack(keys, dim=-1)\n+            logits = q @ keys\n+            attention_weights = torch.softmax(logits, dim=-1)\n+\n+            values = []\n+            for j in range(context_len):\n+                block_number = block_table[j // block_size]\n+                block_offset = j % block_size\n+                v = value_cache[block_number, :, block_offset, :]\n+                values.append(v)\n+            values = torch.stack(values, dim=-1)\n+            out = attention_weights @ values\n+            output[i].copy_(out, non_blocking=True)\n+\n+    def forward(\n+        self,\n+        query: torch.Tensor,\n+        key: torch.Tensor,\n+        value: torch.Tensor,\n+        key_cache: torch.Tensor,\n+        value_cache: torch.Tensor,\n+        input_metadata: InputMetadata,\n+        cache_event: Optional[torch.cuda.Event],\n+    ) -> torch.Tensor:\n+        # Reshape the input tensors.\n+        num_heads = value_cache.shape[1]\n+        head_size = value_cache.shape[3]\n+        query = query.view(-1, num_heads, head_size)\n+        key = key.view(-1, num_heads, head_size)\n+        value = value.view(-1, num_heads, head_size)\n+\n+        # Compute the attention op for prompts.\n+        output = torch.empty_like(query)\n+        start_idx = 0\n+        for i in range(input_metadata.num_prompts):\n+            prompt_len = input_metadata.prompt_lens[i]\n+            out = output[start_idx:start_idx + prompt_len]\n+            q = query[start_idx:start_idx + prompt_len]\n+            k = key[start_idx:start_idx + prompt_len]\n+            v = value[start_idx:start_idx + prompt_len]\n+            self.multi_query_kv_attention(out, q, k, v)\n+            start_idx += prompt_len\n+\n+        # Wait until the cache op is done.\n+        if cache_event is not None:\n+            cache_event.wait()\n+\n+        # Reshape the keys and values and store them in the cache.\n+        ops.reshape_and_cache(\n+            key, value, key_cache, value_cache, input_metadata.slot_mapping)\n+\n+        if input_metadata.num_generation_tokens > 0:\n+            # Compute the attention op for generation tokens.\n+            self.single_query_cached_kv_attention(\n+                output[start_idx:],\n+                query[start_idx:],\n+                key_cache,\n+                value_cache,\n+                input_metadata)\n+\n+        # Reshape the output tensor.\n+        return output.view(-1, num_heads * head_size)\ndiff --git a/cacheflow/models/opt.py b/cacheflow/models/opt.py\nindex 3a340317a..234ab2635 100644\n--- a/cacheflow/models/opt.py\n+++ b/cacheflow/models/opt.py\n@@ -1,9 +1,17 @@\n \"\"\"1D OPT model compatible with HuggingFace weights.\"\"\"\n+from typing import Dict, List, Optional, Tuple\n+\n import torch\n from torch import nn\n from transformers import OPTConfig\n from transformers import PreTrainedModel\n \n+from cacheflow.models import InputMetadata\n+from cacheflow.models.attention import OPTCacheFlowAttention\n+from cacheflow.models.sample import Sampler\n+\n+KVCache = Tuple[torch.Tensor, torch.Tensor]\n+\n \n class OPTLearnedPositionalEmbedding(nn.Embedding):\n \n@@ -31,17 +39,27 @@ class OPTAttention(nn.Module):\n         self.head_dim = embed_dim // num_heads\n         self.scaling = self.head_dim**-0.5\n \n+        # TODO(woosuk): Fuse the three linear layers into one QKV linear layer.\n         self.k_proj = nn.Linear(embed_dim, embed_dim, bias=bias)\n         self.v_proj = nn.Linear(embed_dim, embed_dim, bias=bias)\n         self.q_proj = nn.Linear(embed_dim, embed_dim, bias=bias)\n         self.out_proj = nn.Linear(embed_dim, embed_dim, bias=bias)\n \n-    def forward(self, hidden_states: torch.Tensor) -> torch.Tensor:\n-        q = self.q_proj(hidden_states) * self.scaling\n+        self.attn = OPTCacheFlowAttention(scale=self.scaling)\n+\n+    def forward(\n+        self,\n+        hidden_states: torch.Tensor,\n+        kv_cache: KVCache,\n+        input_metadata: InputMetadata,\n+        cache_event: Optional[torch.cuda.Event],\n+    ) -> torch.Tensor:\n+        q = self.q_proj(hidden_states)\n         k = self.k_proj(hidden_states)\n         v = self.v_proj(hidden_states)\n-        # TODO\n-        attn_output = None\n+        key_cache, value_cache = kv_cache\n+        attn_output = self.attn(\n+            q, k, v, key_cache, value_cache, input_metadata, cache_event)\n         output = self.out_proj(attn_output)\n         return output\n \n@@ -66,13 +84,23 @@ class OPTDecoderLayer(nn.Module):\n         self.fc2 = nn.Linear(config.ffn_dim, self.embed_dim, bias=config.enable_bias)\n         self.final_layer_norm = nn.LayerNorm(self.embed_dim, elementwise_affine=config.layer_norm_elementwise_affine)\n \n-    def forward(self, hidden_states: torch.Tensor) -> torch.Tensor:\n+    def forward(\n+        self,\n+        hidden_states: torch.Tensor,\n+        kv_cache: KVCache,\n+        input_metadata: InputMetadata,\n+        cache_event: Optional[torch.cuda.Event],\n+    ) -> torch.Tensor:\n         # Self Attention\n         residual = hidden_states\n         # 125m, 1.7B, ..., 175B applies layer norm BEFORE attention\n         if self.do_layer_norm_before:\n             hidden_states = self.self_attn_layer_norm(hidden_states)\n-        hidden_states = self.self_attn(hidden_states=hidden_states)\n+        hidden_states = self.self_attn(\n+            hidden_states=hidden_states,\n+            kv_cache=kv_cache,\n+            input_metadata=input_metadata,\n+            cache_event=cache_event)\n         hidden_states = residual + hidden_states\n         # 350m applies layer norm AFTER attention\n         if not self.do_layer_norm_before:\n@@ -145,6 +173,9 @@ class OPTDecoder(OPTPreTrainedModel):\n         self,\n         input_ids: torch.LongTensor,\n         positions: torch.LongTensor,\n+        kv_caches: List[KVCache],\n+        input_metadata: InputMetadata,\n+        cache_events: Optional[List[torch.cuda.Event]],\n     ) -> torch.Tensor:\n         inputs_embeds = self.embed_tokens(input_ids)\n         pos_embeds = self.embed_positions(positions)\n@@ -153,8 +184,14 @@ class OPTDecoder(OPTPreTrainedModel):\n             inputs_embeds = self.project_in(inputs_embeds)\n         hidden_states = inputs_embeds + pos_embeds\n \n-        for layer in self.layers:\n-            hidden_states = layer(hidden_states)\n+        for i in range(len(self.layers)):\n+            if cache_events is None:\n+                cache_event = None\n+            else:\n+                cache_event = cache_events[i]\n+            layer = self.layers[i]\n+            hidden_states = layer(\n+                hidden_states, kv_caches[i], input_metadata, cache_event)\n \n         if self.final_layer_norm is not None:\n             hidden_states = self.final_layer_norm(hidden_states)\n@@ -175,8 +212,12 @@ class OPTModel(OPTPreTrainedModel):\n         self,\n         input_ids: torch.LongTensor,\n         positions: torch.LongTensor,\n+        kv_caches: List[KVCache],\n+        input_metadata: InputMetadata,\n+        cache_events: Optional[List[torch.cuda.Event]],\n     ) -> torch.Tensor:\n-        return self.decoder(input_ids, positions)\n+        return self.decoder(\n+            input_ids, positions, kv_caches, input_metadata, cache_events)\n \n \n class OPTForCausalLM(OPTPreTrainedModel):\n@@ -185,9 +226,9 @@ class OPTForCausalLM(OPTPreTrainedModel):\n     def __init__(self, config):\n         super().__init__(config)\n         self.model = OPTModel(config)\n-\n         # the lm_head weight is automatically tied to the embed tokens weight\n         self.lm_head = nn.Linear(config.word_embed_proj_dim, config.vocab_size, bias=False)\n+        self.sampler = Sampler(embedding=self.lm_head.weight)\n \n         # Initialize weights and apply final processing\n         self.post_init()\n@@ -196,7 +237,11 @@ class OPTForCausalLM(OPTPreTrainedModel):\n         self,\n         input_ids: torch.LongTensor,\n         positions: torch.LongTensor,\n-    ) -> torch.Tensor:\n-        hidden_states = self.model.decoder(input_ids, positions)\n-        logits = self.lm_head(hidden_states).contiguous()\n-        return logits\n+        kv_caches: List[KVCache],\n+        input_metadata: InputMetadata,\n+        cache_events: Optional[List[torch.cuda.Event]],\n+    ) -> Dict[int, Tuple[int, int]]:\n+        hidden_states = self.model(\n+            input_ids, positions, kv_caches, input_metadata, cache_events)\n+        next_tokens = self.sampler(hidden_states, input_metadata)\n+        return next_tokens", "apis": ["OPTCacheFlowAttention.forward", "OPTAttention.forward", "OPTDecoderLayer.forward", "OPTDecoder.forward", "OPTForCausalLM.forward"], "affected_paths": [], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit adds a new OPTCacheFlowAttention module that leverages xformers' memory_efficient_attention and implements a cached key/value mechanism for generation. It integrates caching into the top-level OPT attention process by modifying high-level APIs in the model (e.g., updating the forward methods in OPTAttention, OPTDecoderLayer, OPTDecoder, and OPTForCausalLM) so that the attention calculations can benefit from more efficient memory usage. Despite the commit message reading â€œAdd unoptimized OPT Attentionâ€, the changes aim to affect execution time and memory performance by utilizing specialized operations and restructured data flows. The modifications are non-trivial, affect non-test source files, and target performance improvements on CPU (via more efficient attention operations and caching), rather than just bug fixes or refactoring.</REASON>\n[ANSWER]YES[/ANSWER]", "llm_api_reason": "This commit introduces a new attention module class (OPTCacheFlowAttention) and integrates it into several higher-level OPT model components. Specifically, it adds the new OPTCacheFlowAttention class with its forward (and helper) methods, then updates the forward methods of OPTAttention, OPTDecoderLayer, OPTDecoder, and OPTForCausalLM to incorporate caching and new attention behavior. These methods are the primary Python APIs affected by the changes."}
{"commit_hash": "b690e34824fd5a5c4054a0c0468ebfb6aa1dd215", "pr_url": "https://github.com/vllm-project/vllm/pull/21075", "pr_date": "2025-08-02", "timeline_text": "Copy link Contributor cyang49 commented Jul 16, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results (Optional) The necessary documentation update, such as updating supported_models.md and examples for a new model. Purpose This PR uses preallocated output tensor for SSM output both from decode and prefill paths, instead of allocating individual tensors and then concatenating with torch.vstack . We observed that the original approach causes unnecessary D2D copy. Test Plan Testing with benchmark_serving.py and observe the throughput change. Ideally a slight improvement should be observed Testing with lm_eval to make sure output is still correct Test Result Experiments were done on single H100-80GB. benchmark_serving.py # server\nvllm serve ibm-ai-platform/Bamba-9B-v2 --port 9998 # client\npython benchmarks/benchmark_serving.py --model ibm-ai-platform/Bamba-9B-v2 --backend vllm  --dataset-name sharegpt     --dataset-path /net/storage149/mnt/md0/ccyang/github.com/ShareGPT_V3/ShareGPT_V3_unfiltered_cleaned_split.json --ignore-eos --port 9998 Before (#1c3198b) ============ Serving Benchmark Result ============\nSuccessful requests:                     983       \nBenchmark duration (s):                  44.69     \nTotal input tokens:                      209731    \nTotal generated tokens:                  195084    \nRequest throughput (req/s):              22.00     \nOutput token throughput (tok/s):         4365.18   \nTotal Token throughput (tok/s):          9058.10 After ============ Serving Benchmark Result ============\nSuccessful requests:                     983       \nBenchmark duration (s):                  44.01     \nTotal input tokens:                      209731    \nTotal generated tokens:                  195084    \nRequest throughput (req/s):              22.34     \nOutput token throughput (tok/s):         4432.88   \nTotal Token throughput (tok/s):          9198.58 No performance degradation. lm_eval # Command\nlm_eval --model vllm  --model_args pretrained=ibm-ai-platform/Bamba-9B-v2,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.95 --batch_size auto --trust_remote_code  --cache_requests true --tasks gsm8k Before (#1c3198b) vllm (pretrained=ibm-ai-platform/Bamba-9B-v2,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.95,trust_remote_code=True), gen_kwargs: (None), limit: None, num_fewshot: None, batch_size: auto\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.4162|Â±  |0.0136|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.4132|Â±  |0.0136| After vllm (pretrained=ibm-ai-platform/Bamba-9B-v2,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.95,trust_remote_code=True), gen_kwargs: (None), limit: None, num_fewshot: None, batch_size: auto\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.4162|Â±  |0.0136|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.4132|Â±  |0.0136| (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link github-actions bot commented Jul 16, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gemini-code-assist bot reviewed Jul 16, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces a performance optimization by pre-allocating the SSM output tensor, which avoids an unnecessary device-to-device copy. The approach is sound and the changes are well-contained. I've identified one critical issue related to tensor sharding that would cause an assertion failure when using tensor parallelism. Addressing this should make the implementation robust. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/mamba/mamba_mixer2.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . cyang49 marked this pull request as ready for review July 16, 2025 20:19 cyang49 changed the title [Model] preallocate SSM output tensor to avoid d2d copy overhead [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overhead Jul 16, 2025 Copy link Member DarkLight1337 commented Jul 17, 2025 cc @tlrmchlsmth @tdoublep All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented Jul 21, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @cyang49 . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jul 21, 2025 cyang49 force-pushed the pr_mamba2_vstack branch\n    from f9ab16e to 5f73b79 Compare July 21, 2025 14:51 mergify bot removed\n  the needs-rebase label Jul 21, 2025 cyang49 force-pushed the pr_mamba2_vstack branch\n      4 times, most recently\n    from 875c81f to 3873218 Compare July 23, 2025 15:09 tlrmchlsmth reviewed Jul 30, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This looks like a reasonable optimization. My main comment is that this leaves the interface to the mamba_ssm functions more complicated than they were before. Now they support both in-place updating and out-of-place allocation of the outputs. And we need to handle those two cases in a few different places. Could we change it to always be in-place instead? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author cyang49 commented Jul 30, 2025 This looks like a reasonable optimization. My main comment is that this leaves the interface to the mamba_ssm functions more complicated than they were before. Now they support both in-place updating and out-of-place allocation of the outputs. And we need to handle those two cases in a few different places. Could we change it to always be in-place instead? I think I kept the original logic as a fall back, but you're right, we can remove them. I will push a simplified version if it is safe to remove. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Jul 30, 2025 @tlrmchlsmth There are two other uses in plamo2.py and phi4flash.py If I make the kernel only support in-place update, they will need to be changed too. plamo2 has similar logic as mamba_mixer2, so it should work after applying similar changes phi4flash looks quite different, though. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Jul 31, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . I tried to run both plamo2 and phi4flash on main (not the PR branch) and they both failed to run. I think for now we should keep the out-of-place allocation for compatibility, because I can't check the correctness if we keep only the in-place update path. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cyang49 force-pushed the pr_mamba2_vstack branch\n    from 3873218 to b165a18 Compare July 31, 2025 16:50 cyang49 requested a review\n  from WoosukKwon as a code owner July 31, 2025 16:50 Copy link Contributor Author cyang49 commented Jul 31, 2025 Fixed models that calls the affected kernels plamo2 lm_eval --model vllm  --model_args pretrained=pfnet/plamo\n-2.1-2b-cpt,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.95,max_model_len=8192 --batch_size auto --trust_remote_code  --cache_re\nquests true --tasks gsm8k vllm (pretrained=pfnet/plamo-2.1-2b-cpt,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.95,max_model_len=8192,trust_remote_code=True), gen_kwargs: (None), limit: None, num_fewshot: None, batch_size: auto\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.5982|Â±  |0.0135|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.5951|Â±  |0.0135| phi4flash VLLM_ATTENTION_BACKEND=DIFFERENTIAL_FLASH_ATTN lm_eval --model vllm  --model_args pretrained=microsoft/Phi-4-mini-flash-reasoning,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.95,enable_prefix_caching=False,enable_chunked_prefill=False,max_model_len=8192 --batch_size auto --trust_remote_code  --cache_requests true --tasks gsm8k vllm (pretrained=microsoft/Phi-4-mini-flash-reasoning,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.95,enable_prefix_caching=False,enable_chunked_prefill=False,max_model_len=8192,trust_remote_code=True), gen_kwargs: (None), limit: None, num_fewshot: None, batch_size: auto\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.5239|Â±  |0.0138|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.4837|Â±  |0.0138| ðŸŽ‰ 1 nopperl reacted with hooray emoji All reactions ðŸŽ‰ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth approved these changes Jul 31, 2025 View reviewed changes tlrmchlsmth added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 31, 2025 tlrmchlsmth enabled auto-merge (squash) July 31, 2025 19:34 auto-merge was automatically disabled August 1, 2025 18:13 Head branch was pushed to by a user without write access cyang49 force-pushed the pr_mamba2_vstack branch\n    from b165a18 to 19651f2 Compare August 1, 2025 18:13 cyang49 added 5 commits August 1, 2025 21:13 preallocate SSM output tensor to avoid d2d copy overhead â€¦ 3cee43c Signed-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com> clean up â€¦ 6d962a5 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> keep only in-place update of output â€¦ 6035133 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> mamba2 interface changes for plamo2 â€¦ 9632f0f Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> interface change phi4flash â€¦ af5f089 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> fix CI test and mamba_mixer â€¦ 97c9a70 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> cyang49 force-pushed the pr_mamba2_vstack branch\n    from d59b61d to 97c9a70 Compare August 2, 2025 01:13 Hide details View details vllm-bot merged commit b690e34 into vllm-project : main Aug 2, 2025 39 of 45 checks passed Uh oh! There was an error while loading. Please reload this page . cyang49 deleted the pr_mamba2_vstack branch August 4, 2025 11:53 wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 8223083 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: shuw <shuw@nvidia.com> juuice-lee pushed a commit\n        to juuice-lee/vllm-moe.code\n      that referenced\n      this pull request Aug 5, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 4b81d26 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 871bde5 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ c1ce688 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: x22x22 <wadeking@qq.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 07e421d â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: x22x22 <wadeking@qq.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 4b27371 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> nopperl reviewed Aug 8, 2025 View reviewed changes vllm/model_executor/layers/mamba/ops/mamba_ssm.py @@ -206,7 +206,7 @@ def selective_state_update(state, dt_softplus=False, state_batch_indices=None, pad_slot_id=PAD_SLOT_ID, preallocated_ssm_out =None): out =None): Copy link Contributor nopperl Aug 8, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think out needs to be a required argument now, because it is not allocated within the function anymore. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author cyang49 Aug 8, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good point. Will address this in an upcoming PR Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 nopperl reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction jingyu-ml pushed a commit\n        to jingyu-ml/vllm\n      that referenced\n      this pull request Aug 8, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 71eb0f9 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: jingyu <jingyu@omniml.ai> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ ee9e5c1 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> noamgat pushed a commit\n        to noamgat/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ c7e2edf â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Noam Gat <noamgat@gmail.com> yyihuang pushed a commit\n        to yyihuang/vllm\n      that referenced\n      this pull request Aug 11, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 2e68882 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Avery Yingyi Huang <yingyihuang2000@outlook.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 02e862a â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 49a0a42 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> BoyuanFeng pushed a commit\n        to BoyuanFeng/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 5f66814 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Boyuan Feng <boyuan@meta.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ f79d7fa â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ d9e22d3 â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> zhewenl pushed a commit\n        to zhewenl/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ 1b7d42b â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overheâ€¦ â€¦ e3f090e â€¦ad ( vllm-project#21075 )\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> nopperl mentioned this pull request Aug 31, 2025 [V1] v1 engine + full CUDA graph support for PLaMo2 #23998 Merged 5 tasks Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:40", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, lm_eval | PERF: throughput, throughput, throughput | SERVING: vllm serve, Serving, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:49:40", "models": ["ibm-ai-platform/Bamba-9B-v2", "microsoft/Phi-4-mini-flash-reasoning"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=ibm-ai-platform/Bamba-9B-v2,dtype=float16 --tasks gsm8k --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=microsoft/Phi-4-mini-flash-reasoning,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model ibm-ai-platform/Bamba-9B-v2 --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overhead (#21075)", "commit_message": "[Model] Mamba2 preallocate SSM output tensor to avoid d2d copy overhead (#21075)\n\nSigned-off-by: Chih-Chieh Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>", "commit_date": "2025-08-02T01:59:34-07:00", "files_changed": ["tests/kernels/mamba/test_mamba_ssm.py", "tests/kernels/mamba/test_mamba_ssm_ssd.py", "vllm/model_executor/layers/mamba/mamba_mixer.py", "vllm/model_executor/layers/mamba/mamba_mixer2.py", "vllm/model_executor/layers/mamba/ops/mamba_ssm.py", "vllm/model_executor/layers/mamba/ops/ssd_chunk_scan.py", "vllm/model_executor/layers/mamba/ops/ssd_combined.py", "vllm/model_executor/models/phi4flash.py", "vllm/model_executor/models/plamo2.py"], "functions_changed": [], "stats": {"num_test_files": 2, "num_non_test_files": 7, "only_test_files": 0, "only_non_test_files": 0, "num_files": 9, "num_hunks": 39, "num_edited_lines": 262, "num_non_test_edited_lines": 165, "commit_year": 2025}, "diff_text": "diff --git a/tests/kernels/mamba/test_mamba_ssm.py b/tests/kernels/mamba/test_mamba_ssm.py\nindex 8dece26dd..4c32ae81b 100644\n--- a/tests/kernels/mamba/test_mamba_ssm.py\n+++ b/tests/kernels/mamba/test_mamba_ssm.py\n@@ -365,6 +365,7 @@ def test_selective_state_update(dim, dstate, has_z, itype):\n     batch_size = 1\n     state = torch.randn(batch_size, dim, dstate, dtype=itype, device=device)\n     x = torch.randn(batch_size, dim, device=device, dtype=itype)\n+    out = torch.empty_like(x)\n     dt = torch.randn(batch_size, dim, device=device, dtype=itype)\n     dt_bias = torch.rand(dim, device=device) - 4.0\n     A = -torch.rand(dim, dstate, device=device) - 1.0\n@@ -373,16 +374,17 @@ def test_selective_state_update(dim, dstate, has_z, itype):\n     D = torch.randn(dim, device=device)\n     z = torch.randn_like(x) if has_z else None\n     state_ref = state.detach().clone()\n-    out = selective_state_update(state,\n-                                 x,\n-                                 dt,\n-                                 A,\n-                                 B,\n-                                 C,\n-                                 D=D,\n-                                 z=z,\n-                                 dt_bias=dt_bias,\n-                                 dt_softplus=True)\n+    selective_state_update(state,\n+                           x,\n+                           dt,\n+                           A,\n+                           B,\n+                           C,\n+                           D=D,\n+                           z=z,\n+                           dt_bias=dt_bias,\n+                           dt_softplus=True,\n+                           out=out)\n     out_ref = selective_state_update_ref(state_ref,\n                                          x,\n                                          dt,\n@@ -581,6 +583,7 @@ def test_selective_state_update_with_batch_indices(with_padding, dim, dstate,\n     ],\n                                         dim=0)\n     x = torch.randn(padded_batch_size, dim, device=device, dtype=itype)\n+    out = torch.empty_like(x)\n     dt = torch.randn(padded_batch_size, dim, device=device, dtype=itype)\n     dt_bias = torch.rand(dim, device=device) - 4.0\n     A = -torch.rand(dim, dstate, device=device) - 1.0\n@@ -590,18 +593,19 @@ def test_selective_state_update_with_batch_indices(with_padding, dim, dstate,\n     z = torch.randn_like(x) if has_z else None\n     state_ref = state[state_indices, :].clone()\n     state_before = state.clone()\n-    out = selective_state_update(state,\n-                                 x,\n-                                 dt,\n-                                 A,\n-                                 B,\n-                                 C,\n-                                 D=D,\n-                                 z=z,\n-                                 dt_bias=dt_bias,\n-                                 dt_softplus=True,\n-                                 state_batch_indices=padded_state_indices,\n-                                 pad_slot_id=PAD_SLOT_ID)\n+    selective_state_update(state,\n+                           x,\n+                           dt,\n+                           A,\n+                           B,\n+                           C,\n+                           D=D,\n+                           z=z,\n+                           dt_bias=dt_bias,\n+                           dt_softplus=True,\n+                           state_batch_indices=padded_state_indices,\n+                           pad_slot_id=PAD_SLOT_ID,\n+                           out=out)\n     out_ref = selective_state_update_ref(state_ref,\n                                          x[:batch_size],\n                                          dt[:batch_size],\n@@ -665,6 +669,7 @@ def test_selective_state_update_with_heads_with_batch_indices(\n         dtype=torch.int32, device=device)\n \n     x = torch.randn(batch_size, nheads, headdim, device=device, dtype=itype)\n+    out = torch.empty_like(x)\n     if not tie_hdim:\n         dt = torch.randn(batch_size,\n                          nheads,\n@@ -691,18 +696,19 @@ def test_selective_state_update_with_heads_with_batch_indices(\n     C = torch.randn(batch_size, ngroups, dstate, device=device)\n     z = torch.randn_like(x) if has_z else None\n     state_ref = state[state_indices, :].detach().clone()\n-    out = selective_state_update(state,\n-                                 x,\n-                                 dt,\n-                                 A,\n-                                 B,\n-                                 C,\n-                                 D=D,\n-                                 z=z,\n-                                 dt_bias=dt_bias,\n-                                 dt_softplus=True,\n-                                 state_batch_indices=state_indices,\n-                                 pad_slot_id=PAD_SLOT_ID)\n+    selective_state_update(state,\n+                           x,\n+                           dt,\n+                           A,\n+                           B,\n+                           C,\n+                           D=D,\n+                           z=z,\n+                           dt_bias=dt_bias,\n+                           dt_softplus=True,\n+                           state_batch_indices=state_indices,\n+                           pad_slot_id=PAD_SLOT_ID,\n+                           out=out)\n     out_ref = selective_state_update_ref(state_ref,\n                                          x,\n                                          dt,\ndiff --git a/tests/kernels/mamba/test_mamba_ssm_ssd.py b/tests/kernels/mamba/test_mamba_ssm_ssd.py\nindex 00c1a2911..67b14a7fa 100644\n--- a/tests/kernels/mamba/test_mamba_ssm_ssd.py\n+++ b/tests/kernels/mamba/test_mamba_ssm_ssd.py\n@@ -212,15 +212,16 @@ def test_mamba_chunk_scan_single_example(d_head, n_heads, seq_len_chunk_size,\n \n     Y_min, final_state_min = ssd_minimal_discrete(X * dt.unsqueeze(-1), A * dt,\n                                                   B, C, chunk_size)\n-\n-    Y, final_state = mamba_chunk_scan_combined(X,\n-                                               dt,\n-                                               A,\n-                                               B,\n-                                               C,\n-                                               chunk_size,\n-                                               D=None,\n-                                               return_final_states=True)\n+    Y = torch.empty_like(X)\n+    final_state = mamba_chunk_scan_combined(X,\n+                                            dt,\n+                                            A,\n+                                            B,\n+                                            C,\n+                                            chunk_size,\n+                                            D=None,\n+                                            return_final_states=True,\n+                                            out=Y)\n \n     # just test the last in sequence\n     torch.testing.assert_close(Y[:, -1], Y_min[:, -1], atol=atol, rtol=rtol)\n@@ -292,7 +293,8 @@ def test_mamba_chunk_scan_cont_batch(d_head, n_heads, seq_len_chunk_size_cases,\n             _query_start_loc_to_chunk_indices_offsets(\n                 cu_seqlens, chunk_size, cu_seqlens[-1])\n \n-        Y, new_states = mamba_chunk_scan_combined(\n+        Y = torch.empty_like(X)\n+        new_states = mamba_chunk_scan_combined(\n             X,\n             dt,\n             A,\n@@ -306,6 +308,7 @@ def test_mamba_chunk_scan_cont_batch(d_head, n_heads, seq_len_chunk_size_cases,\n             chunk_offsets=chunk_offsets,\n             return_varlen_states=True,\n             initial_states=states,\n+            out=Y,\n         )\n \n         # just test the last in sequence\ndiff --git a/vllm/model_executor/layers/mamba/mamba_mixer.py b/vllm/model_executor/layers/mamba/mamba_mixer.py\nindex 796c8d937..60cf3e118 100644\n--- a/vllm/model_executor/layers/mamba/mamba_mixer.py\n+++ b/vllm/model_executor/layers/mamba/mamba_mixer.py\n@@ -220,7 +220,8 @@ class MambaMixer(CustomOp):\n                 has_initial_state=attn_metadata.context_lens_tensor > 0,\n                 query_start_loc=attn_metadata.query_start_loc)\n         else:\n-            scan_outputs = selective_state_update(\n+            scan_outputs = torch.empty_like(hidden_states.transpose(0, 1))\n+            selective_state_update(\n                 mamba_cache_params.ssm_state,\n                 hidden_states.transpose(0, 1),\n                 discrete_time_step.transpose(0, 1),\n@@ -231,7 +232,8 @@ class MambaMixer(CustomOp):\n                 gate.transpose(0, 1),\n                 time_proj_bias,\n                 dt_softplus=True,\n-                state_batch_indices=mamba_cache_params.state_indices_tensor)\n+                state_batch_indices=mamba_cache_params.state_indices_tensor,\n+                out=scan_outputs)\n             scan_outputs = scan_outputs.transpose(0, 1)\n \n         # 4. Final linear projection\ndiff --git a/vllm/model_executor/layers/mamba/mamba_mixer2.py b/vllm/model_executor/layers/mamba/mamba_mixer2.py\nindex 36edac237..5ac9a7f9a 100644\n--- a/vllm/model_executor/layers/mamba/mamba_mixer2.py\n+++ b/vllm/model_executor/layers/mamba/mamba_mixer2.py\n@@ -541,7 +541,6 @@ class MambaMixer2(MambaBase, CustomOp):\n         # NOTE: V0 put prefill before decode, v1 puts decode before prefill\n         # Separate prefill and decode by splitting varlen input\n         # Split along token dimension\n-        # NOTE: V0 put prefill before decode, v1 puts decode before prefill\n         if envs.VLLM_USE_V1:\n             hidden_states_B_C_d, hidden_states_B_C_p = torch.split(\n                 hidden_states_B_C[:num_actual_tokens],\n@@ -583,7 +582,28 @@ class MambaMixer2(MambaBase, CustomOp):\n                                                                1]\n                                  if has_prefill else None)\n \n-        ssd_output_list = []\n+        # Preallocate output tensor to avoid memcpy cost for merging prefill\n+        # and decode outputs\n+        preallocated_ssm_out = torch.empty(\n+            [\n+                num_prefill_tokens + num_decodes,\n+                (self.num_heads // self.tp_size) * self.head_dim\n+            ],\n+            dtype=hidden_states.dtype,\n+            device=hidden_states.device,\n+        )\n+        if envs.VLLM_USE_V1:\n+            preallocated_ssm_out_d, preallocated_ssm_out_p = torch.split(\n+                preallocated_ssm_out,\n+                [num_decodes, num_prefill_tokens],\n+                dim=0,\n+            )\n+        else:\n+            preallocated_ssm_out_p, preallocated_ssm_out_d = torch.split(\n+                preallocated_ssm_out,\n+                [num_prefill_tokens, num_decodes],\n+                dim=0,\n+            )\n \n         # Process prefill requests\n         if has_prefill:\n@@ -623,7 +643,8 @@ class MambaMixer2(MambaBase, CustomOp):\n                         has_initial_states_p[:num_prefills, None, None, None],\n                         ssm_state[state_indices_tensor_p], 0)\n \n-            scan_output, varlen_state = mamba_chunk_scan_combined(\n+            # NOTE: final output is an in-place update of out tensor\n+            varlen_state = mamba_chunk_scan_combined(\n                 hidden_states_p.view(1, num_prefill_tokens,\n                                      self.num_heads // self.tp_size,\n                                      self.head_dim),\n@@ -646,15 +667,14 @@ class MambaMixer2(MambaBase, CustomOp):\n                 return_final_states=False,\n                 dt_softplus=True,\n                 dt_limit=(0.0, float(\"inf\")),\n+                out=preallocated_ssm_out_p.view(1, num_prefill_tokens, -1,\n+                                                self.head_dim),\n             )\n \n             # update ssm states\n             # - varlen state is a (num_prefills, nheads, headdim, dstate) tensor\n             ssm_state[state_indices_tensor_p] = varlen_state\n \n-            # - reshape\n-            ssd_output_list.append(scan_output.view(num_prefill_tokens, -1))\n-\n         # Process decode requests\n         if has_decode:\n             # 2. Convolution sequence transformation\n@@ -684,8 +704,8 @@ class MambaMixer2(MambaBase, CustomOp):\n             # - the hidden is reshaped into (bs, num_heads, head_dim)\n             # - mamba_cache_params.ssm_state's slots will be selected\n             #   using state_indices_tensor_d\n-\n-            hidden_states_d = selective_state_update(\n+            # NOTE: final output is an in-place update of out tensor\n+            selective_state_update(\n                 ssm_state,\n                 hidden_states_d,\n                 dt_d,\n@@ -697,26 +717,16 @@ class MambaMixer2(MambaBase, CustomOp):\n                 dt_bias=dt_bias,\n                 dt_softplus=True,\n                 state_batch_indices=state_indices_tensor_d,\n+                out=preallocated_ssm_out_d.view(num_decodes, -1,\n+                                                self.head_dim),\n             )\n \n-            if envs.VLLM_USE_V1:\n-                ssd_output_list.insert(\n-                    0,\n-                    hidden_states_d.view(-1, (self.num_heads // self.tp_size) *\n-                                         self.head_dim))\n-            else:\n-                ssd_output_list.append(\n-                    hidden_states_d.view(-1, (self.num_heads // self.tp_size) *\n-                                         self.head_dim))\n-\n-        # Merge prefill and decode outputs before passing to gated MLP\n-        hidden_states = torch.vstack(ssd_output_list)\n-\n         # 4. gated MLP\n         # GatedRMSNorm internally applying SiLU to the gate\n         # SiLU is applied internally before normalization, unlike standard\n         # norm usage\n-        hidden_states = self.norm(hidden_states, gate[:num_actual_tokens])\n+        hidden_states = self.norm(preallocated_ssm_out,\n+                                  gate[:num_actual_tokens])\n \n         # 5. Final linear projection\n         output[:num_actual_tokens], _ = self.out_proj(hidden_states)\ndiff --git a/vllm/model_executor/layers/mamba/ops/mamba_ssm.py b/vllm/model_executor/layers/mamba/ops/mamba_ssm.py\nindex 3f67fc35a..838290a9f 100644\n--- a/vllm/model_executor/layers/mamba/ops/mamba_ssm.py\n+++ b/vllm/model_executor/layers/mamba/ops/mamba_ssm.py\n@@ -205,7 +205,8 @@ def selective_state_update(state,\n                            dt_bias=None,\n                            dt_softplus=False,\n                            state_batch_indices=None,\n-                           pad_slot_id=PAD_SLOT_ID):\n+                           pad_slot_id=PAD_SLOT_ID,\n+                           out=None):\n     \"\"\"\n     Argument:\n         state: (batch, dim, dstate) or (batch, nheads, dim, dstate)\n@@ -223,10 +224,9 @@ def selective_state_update(state,\n             for example: cache_indices = [pad_slot_id, 1, 20, pad_slot_id] \n             in this case, the kernel will not process entries at \n             indices 0 and 3\n-    Return:\n-        out: (batch, dim) or (batch, nheads, dim)\n+        out: Preallocated ssm output tensor. Assume same shape as x. \n+             In-place updated.\n     \"\"\"\n-    has_heads = state.dim() > 3\n     if state.dim() == 3:\n         state = state.unsqueeze(1)\n     if x.dim() == 2:\n@@ -245,6 +245,8 @@ def selective_state_update(state,\n         z = z.unsqueeze(1)\n     if dt_bias is not None and dt_bias.dim() == 1:\n         dt_bias = dt_bias.unsqueeze(0)\n+    if out.dim() == 2:\n+        out = out.unsqueeze(1)\n \n     _, nheads, dim, dstate = state.shape\n     batch = x.shape[0]\n@@ -264,7 +266,8 @@ def selective_state_update(state,\n         assert dt_bias.shape == (nheads, dim)\n     if state_batch_indices is not None:\n         assert state_batch_indices.shape == (batch, )\n-    out = torch.empty_like(x)\n+    assert out.shape == x.shape\n+\n     grid = lambda META: (triton.cdiv(dim, META['BLOCK_SIZE_M']), batch, nheads)\n     z_strides = ((z.stride(0), z.stride(1), z.stride(2)) if z is not None else\n                  (0, 0, 0))\n@@ -328,9 +331,6 @@ def selective_state_update(state,\n             BLOCK_SIZE_M,\n             num_warps=num_warps,\n         )\n-    if not has_heads:\n-        out = out.squeeze(1)\n-    return out\n \n \n def selective_scan_fn(u,\ndiff --git a/vllm/model_executor/layers/mamba/ops/ssd_chunk_scan.py b/vllm/model_executor/layers/mamba/ops/ssd_chunk_scan.py\nindex 61eff0c00..fc2b3b25f 100644\n--- a/vllm/model_executor/layers/mamba/ops/ssd_chunk_scan.py\n+++ b/vllm/model_executor/layers/mamba/ops/ssd_chunk_scan.py\n@@ -454,6 +454,7 @@ def _chunk_scan_fwd(\n     chunk_indices=None,\n     chunk_offsets=None,\n     initial_states=None,\n+    out=None,\n ):\n     batch, seqlen, nheads, headdim = x.shape\n     _, _, nchunks, chunk_size = dt.shape\n@@ -483,20 +484,10 @@ def _chunk_scan_fwd(\n     else:\n         chunk_indices, chunk_offsets = None, None\n \n-    # Allocates output.\n-    out = torch.empty(batch,\n-                      seqlen,\n-                      nheads,\n-                      headdim,\n-                      device=x.device,\n-                      dtype=x.dtype)\n+    assert out.shape == x.shape\n+\n     if z is not None:\n-        out_x = torch.empty(batch,\n-                            seqlen,\n-                            nheads,\n-                            headdim,\n-                            device=x.device,\n-                            dtype=x.dtype)\n+        out_x = torch.empty_like(x)\n         assert out_x.stride() == out.stride()\n     else:\n         out_x = None\n@@ -579,4 +570,4 @@ def _chunk_scan_fwd(\n         IS_TRITON_22=TRITON_22,\n         HAS_INITSTATES=initial_states is not None,\n     )\n-    return out, out_x\n+    return out_x\ndiff --git a/vllm/model_executor/layers/mamba/ops/ssd_combined.py b/vllm/model_executor/layers/mamba/ops/ssd_combined.py\nindex b121275e9..ad2853a3d 100644\n--- a/vllm/model_executor/layers/mamba/ops/ssd_combined.py\n+++ b/vllm/model_executor/layers/mamba/ops/ssd_combined.py\n@@ -36,7 +36,8 @@ def _mamba_chunk_scan_combined_fwd(x,\n                                    chunk_offsets=None,\n                                    cu_seqlens=None,\n                                    dt_softplus=False,\n-                                   dt_limit=(0.0, float(\"inf\"))):\n+                                   dt_limit=(0.0, float(\"inf\")),\n+                                   out=None):\n     batch, seqlen, nheads, headdim = x.shape\n     _, _, ngroups, dstate = B.shape\n     assert nheads % ngroups == 0\n@@ -134,7 +135,7 @@ def _mamba_chunk_scan_combined_fwd(x,\n     # - in each (pseudo) chunk, we detect if the previous (pseudo) chunk had\n     #   a seq_idx change, in which case we take states information from\n     #   init_states.\n-    out, out_x = _chunk_scan_fwd(\n+    out_x = _chunk_scan_fwd(\n         CB,\n         x,\n         dt,\n@@ -147,9 +148,10 @@ def _mamba_chunk_scan_combined_fwd(x,\n         chunk_indices=chunk_indices,\n         chunk_offsets=chunk_offsets,\n         initial_states=initial_states,\n+        out=out,\n     )\n     if cu_seqlens is None:\n-        return out, out_x, dt, dA_cumsum, states, final_states\n+        return out_x, dt, dA_cumsum, states, final_states\n     else:\n         assert batch == 1, \"passing cu_seqlens to get the varlen states is only supported if batch dimension is 1\"\n         varlen_states = chunk_state_varlen(\n@@ -161,7 +163,7 @@ def _mamba_chunk_scan_combined_fwd(x,\n             states.squeeze(0),\n             initial_states=initial_states,\n         )\n-        return out, out_x, dt, dA_cumsum, states, final_states, varlen_states\n+        return out_x, dt, dA_cumsum, states, final_states, varlen_states\n \n \n def mamba_chunk_scan_combined(x,\n@@ -180,6 +182,7 @@ def mamba_chunk_scan_combined(x,\n                               cu_seqlens=None,\n                               dt_softplus=False,\n                               dt_limit=(0.0, float(\"inf\")),\n+                              out=None,\n                               return_final_states=False,\n                               return_varlen_states=False):\n     \"\"\"\n@@ -197,15 +200,14 @@ def mamba_chunk_scan_combined(x,\n         seq_idx: (batch, seqlen)\n         cu_seqlens: (num_sequences + 1) or None, only used if return_varlen_states is True\n         dt_softplus: Whether to apply softplus to dt\n-    Return:\n-        out: (batch, seqlen, nheads, headdim)\n+        out: Preallocated output tensor\n     \"\"\"\n \n     if not return_varlen_states:\n         cu_seqlens = None\n     else:\n         assert cu_seqlens is not None, \"cu_seqlens must be provided if return_varlen_states is True\"\n-    out, out_x, dt_out, dA_cumsum, states, final_states, *rest = _mamba_chunk_scan_combined_fwd(\n+    out_x, dt_out, dA_cumsum, states, final_states, *rest = _mamba_chunk_scan_combined_fwd(\n         x,\n         dt,\n         A,\n@@ -221,12 +223,14 @@ def mamba_chunk_scan_combined(x,\n         chunk_offsets=chunk_offsets,\n         cu_seqlens=cu_seqlens,\n         dt_softplus=dt_softplus,\n-        dt_limit=dt_limit)\n+        dt_limit=dt_limit,\n+        out=out)\n     if not return_varlen_states:\n-        return out if not return_final_states else (out, final_states)\n+        if not return_final_states:\n+            return\n+        else:\n+            return final_states\n     else:\n         varlen_states = rest[0]\n-        return (out,\n-                varlen_states) if not return_final_states else (out,\n-                                                                final_states,\n+        return (varlen_states) if not return_final_states else (final_states,\n                                                                 varlen_states)\ndiff --git a/vllm/model_executor/models/phi4flash.py b/vllm/model_executor/models/phi4flash.py\nindex a4ded2b7a..1a761d01f 100644\n--- a/vllm/model_executor/models/phi4flash.py\n+++ b/vllm/model_executor/models/phi4flash.py\n@@ -387,7 +387,8 @@ class Phi4Mamba(nn.Module):\n                 has_initial_state=attn_metadata.context_lens_tensor > 0,\n                 query_start_loc=attn_metadata.query_start_loc)\n         else:\n-            scan_outputs = selective_state_update(\n+            scan_outputs = torch.empty_like(hidden_states.transpose(0, 1))\n+            selective_state_update(\n                 mamba_cache_params.ssm_state,\n                 hidden_states.transpose(0, 1),\n                 discrete_time_step.transpose(0, 1),\n@@ -400,7 +401,8 @@ class Phi4Mamba(nn.Module):\n                 None if self.yoco_kv else gate.transpose(0, 1),\n                 time_proj_bias,\n                 dt_softplus=True,\n-                state_batch_indices=mamba_cache_params.state_indices_tensor)\n+                state_batch_indices=mamba_cache_params.state_indices_tensor,\n+                out=scan_outputs)\n             scan_outputs = scan_outputs.transpose(0, 1)\n \n         # 4. Final linear projection\ndiff --git a/vllm/model_executor/models/plamo2.py b/vllm/model_executor/models/plamo2.py\nindex 9bc577cfe..8b1df66f0 100644\n--- a/vllm/model_executor/models/plamo2.py\n+++ b/vllm/model_executor/models/plamo2.py\n@@ -257,7 +257,21 @@ class Plamo2MambaMixer(nn.Module):\n         query_start_loc_p = (attn_metadata.query_start_loc[:num_prefills + 1]\n                              if has_prefill else None)\n \n-        ssd_output_list = []\n+        # Preallocate output tensor to avoid memcpy cost for merging prefill\n+        # and decode outputs\n+        preallocated_ssm_out = torch.empty(\n+            [\n+                num_prefill_tokens + num_decodes,\n+                (self.num_heads // self.tp_size) * self.head_dim\n+            ],\n+            dtype=hidden_states.dtype,\n+            device=hidden_states.device,\n+        )\n+        preallocated_ssm_out_p, preallocated_ssm_out_d = torch.split(\n+            preallocated_ssm_out,\n+            [num_prefill_tokens, num_decodes],\n+            dim=0,\n+        )\n \n         # Process prefill requests\n         if has_prefill:\n@@ -290,7 +304,7 @@ class Plamo2MambaMixer(nn.Module):\n                 initial_states = torch.where(\n                     mamba2_metadata.has_initial_states[:, None, None, None],\n                     mamba_cache_params.ssm_state[state_indices_tensor_p], 0)\n-            scan_output, varlen_state = mamba_chunk_scan_combined(\n+            varlen_state = mamba_chunk_scan_combined(\n                 hidden_states_p.view(1, num_prefill_tokens,\n                                      self.num_heads // self.tp_size,\n                                      self.head_dim),\n@@ -312,15 +326,14 @@ class Plamo2MambaMixer(nn.Module):\n                 return_final_states=False,\n                 dt_softplus=True,\n                 dt_limit=(0.0, float(\"inf\")),\n+                out=preallocated_ssm_out_p.view(1, num_prefill_tokens, -1,\n+                                                self.head_dim),\n             )\n \n             # update ssm states\n             # - varlen state is a (batch, nheads, headdim, dstate) tensor\n             mamba_cache_params.ssm_state[state_indices_tensor_p] = varlen_state\n \n-            # - reshape\n-            ssd_output_list.append(scan_output.view(num_prefill_tokens, -1))\n-\n         # Process decode requests\n         if has_decode:\n             # 2. Convolution sequence transformation\n@@ -349,8 +362,7 @@ class Plamo2MambaMixer(nn.Module):\n             # - the hidden is reshaped into (bs, num_heads, head_dim)\n             # - mamba_cache_params.ssm_state's slots will be selected\n             #   using state_indices_tensor_d\n-\n-            hidden_states_d = selective_state_update(\n+            selective_state_update(\n                 mamba_cache_params.ssm_state,\n                 hidden_states_d,\n                 dt,\n@@ -362,17 +374,13 @@ class Plamo2MambaMixer(nn.Module):\n                 dt_bias=dt_bias,\n                 dt_softplus=True,\n                 state_batch_indices=state_indices_tensor_d,\n+                out=preallocated_ssm_out_d.view(num_decodes, -1,\n+                                                self.head_dim),\n             )\n             assert self.num_heads % self.tp_size == 0\n-            ssd_output_list.append(\n-                hidden_states_d.view(-1, (self.num_heads // self.tp_size) *\n-                                     self.head_dim))\n-\n-        # Merge prefill and decode outputs before passing to MLP\n-        hidden_states = torch.vstack(ssd_output_list)\n \n         # 4. Final linear projection\n-        out = self.out_proj(hidden_states)\n+        out = self.out_proj(preallocated_ssm_out)\n         return out", "apis": ["vllm.model_executor.layers.mamba.ops.mamba_ssm.selective_state_update", "vllm.model_executor.layers.mamba.ops.ssd_combined.mamba_chunk_scan_combined"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/mamba/mamba_mixer2.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/phi4flash.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/plamo2.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes multiple changes in production files (e.g., in mamba_mixer, mamba_mixer2, phi4flash, plamo2, and lower-level ops files) by introducing preallocation of output tensors to avoid redundant device-to-device memory copies. This modification targets reducing unnecessary memcpy overhead and thus improves runtime performance. It alters the way outputs are handled in performance-critical code paths, rather than merely refactoring or bug fixing. Although test files are also modified, the main performance optimizations are implemented in non-test, production modules affecting high-level APIs that run on the CPU. Therefore, the commit meets the conditions for being performance/optimization related.", "llm_api_reason": "This commit modifies several lowâ€level SSM functions to accept a preallocated output tensor (â€œoutâ€) in order to avoid extra device-to-device copy overhead. In particular, the updates add an â€œoutâ€ argument to the selective_state_update() function (in vllm/model_executor/layers/mamba/ops/mamba_ssm.py) and to the mamba_chunk_scan_combined() function (in vllm/model_executor/layers/mamba/ops/ssd_combined.py). These changes propagate to various model modules (e.g. MambaMixer2, Phi4Mamba, and Plamo2MambaMixer) that call these routines in their forward passes, as reflected in the updated tests."}
{"commit_hash": "58eee5f2e05b74eb2cb1a3bbda9c04df4805e4cc", "pr_url": "https://github.com/vllm-project/vllm/pull/20000", "pr_date": "2025-08-02", "timeline_text": "Copy link Contributor vadiklyutiy commented Jun 24, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. Purpose to_py_obj is called inside transformers tokenizer.decode . In our case to_py_obj convert list to list what is useless. Avoid to_py_obj to speedup decoding. Test Plan Change is really short and trivial. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions avoid useless list-to-list conversion â€¦ b74bbba Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> Copy link github-actions bot commented Jun 24, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gemini-code-assist bot reviewed Jun 24, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @vadiklyutiy , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request introduces a performance optimization to the token decoding process within the tokenizer utility. By intelligently selecting the most efficient decoding method available, it aims to eliminate redundant data conversions and improve the speed of token decoding. Highlights Performance Optimization : Modified the decode_tokens function in vllm/transformers_utils/tokenizer.py to prioritize using the _decode method of the tokenizer if it exists, falling back to the standard decode method otherwise. This change aims to bypass an unnecessary list-to-list conversion ( to_py_obj ) that can occur during token decoding, thereby improving performance. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with ðŸ‘ and ðŸ‘Ž on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . â†© Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jun 24, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review The pull request modifies the decode_tokens function in vllm/transformers_utils/tokenizer.py to use the _decode method of the tokenizer if it exists, falling back to the decode method if it doesn't. This is done to potentially speed up decoding by avoiding unnecessary list-to-list conversions. The change is concise and seems reasonable. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/transformers_utils/tokenizer.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . 22quinn reviewed Jun 24, 2025 View reviewed changes Copy link Collaborator 22quinn left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Interesting. This is the code pointer for anyone interested. I feel this kind of optimization is better done in huggingface. I dig a bit and found there was already some discussion and optimization in huggingface/transformers#36885 Have you measured the speedup for this PR? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions 22quinn added\n  the performance Performance-related issues label Jun 24, 2025 Copy link Contributor Author vadiklyutiy commented Jun 24, 2025 Interesting. This is the code pointer for anyone interested. I feel this kind of optimization is better done in huggingface. I dig a bit and found there was already some discussion and optimization in huggingface/transformers#36885 Have you measured the speedup for this PR? @22quinn you are right. This change from my backlog and I did it some time ago. I measured performance without patch to HF you mentioned and that saw a lot of to_py_obj calls for every list element. I will check performance improvement on the latest version. Maybe after HF patch performance improvement too minor to worry about it. Thank you for pointing this out. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator ProExpertProg commented Jun 26, 2025 Congrats on #20000 ! ðŸ˜„ 1 22quinn reacted with laugh emoji All reactions ðŸ˜„ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details vllm-bot merged commit 58eee5f into vllm-project : main Aug 2, 2025 15 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Member DarkLight1337 commented Aug 2, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Oops accidentally merged this PR, feel free to revert if there's a problem with it All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author vadiklyutiy commented Aug 3, 2025 @DarkLight1337 Should I create PR to revert it? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member DarkLight1337 commented Aug 3, 2025 Is this change still relevant? If not then yeah let's revert All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author vadiklyutiy commented Aug 3, 2025 Ok, let's me collect up to date numbers. Mentioned above merge to transformers improved performance but not fully - there is still some overhead. With specific numbers we can decide. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 35f1408 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: shuw <shuw@nvidia.com> juuice-lee pushed a commit\n        to juuice-lee/vllm-moe.code\n      that referenced\n      this pull request Aug 5, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 9b76219 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ fc6cbb1 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 8cb05d1 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: x22x22 <wadeking@qq.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ fa14d61 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: x22x22 <wadeking@qq.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 91186e5 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> jingyu-ml pushed a commit\n        to jingyu-ml/vllm\n      that referenced\n      this pull request Aug 8, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 6e204de â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: jingyu <jingyu@omniml.ai> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 2d6070c â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> noamgat pushed a commit\n        to noamgat/vllm\n      that referenced\n      this pull request Aug 9, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 2349d3d â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Noam Gat <noamgat@gmail.com> yyihuang pushed a commit\n        to yyihuang/vllm\n      that referenced\n      this pull request Aug 11, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 5372242 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Avery Yingyi Huang <yingyihuang2000@outlook.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 66782d4 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 4b814e9 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> BoyuanFeng pushed a commit\n        to BoyuanFeng/vllm\n      that referenced\n      this pull request Aug 14, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 8ffd112 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Boyuan Feng <boyuan@meta.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 8fb256d â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> Copy link Contributor Author vadiklyutiy commented Aug 22, 2025 @DarkLight1337 Sorry for late reply. Ran Qwen-2.5-VL-3B with high load on latest main with and without this PR. decode_token itself speed up is sufficient - 28%. But after transformers optimizations we don't spend a lot of time in it. E2E improving is tiny - around 0.2%. Please let me know what do you think. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member DarkLight1337 commented Aug 22, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . OK, let's revert this PR then. Thanks for investgating this! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . DarkLight1337 added a commit\n        to DarkLight1337/vllm\n      that referenced\n      this pull request Aug 22, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ ec8ebfe â€¦ist-to-list conversion ( vllm-project#20000 )\"\n\nThis reverts commit 58eee5f .\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> DarkLight1337 mentioned this pull request Aug 22, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless list-to-list conversion (#20000)\" #23396 Merged 4 tasks Isotr0py pushed a commit\n      that referenced\n      this pull request Aug 23, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ b4e9fd8 â€¦ist-to-list conversion ( #20000 )\" ( #23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> FFFfff1FFFfff pushed a commit\n        to FFFfff1FFFfff/my_vllm\n      that referenced\n      this pull request Aug 25, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ cb92141 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: FFFfff1FFFfff <yifanli0919@gmail.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ f902dce â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 622bd37 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> juuice-lee pushed a commit\n        to juuice-lee/vllm-moe.code\n      that referenced\n      this pull request Aug 28, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 84c70d4 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> xiao-llm pushed a commit\n        to xiao-llm/vllm\n      that referenced\n      this pull request Aug 28, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ dd95e26 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Xiao Yu <xiao.yu@amd.com> xiao-llm pushed a commit\n        to xiao-llm/vllm\n      that referenced\n      this pull request Aug 28, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 2b472fc â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Xiao Yu <xiao.yu@amd.com> zhewenl pushed a commit\n        to zhewenl/vllm\n      that referenced\n      this pull request Aug 28, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ cd0e40b â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> zhewenl pushed a commit\n        to zhewenl/vllm\n      that referenced\n      this pull request Aug 28, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ fbaa487 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> dumb0002 pushed a commit\n        to dumb0002/vllm\n      that referenced\n      this pull request Aug 28, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ f30ac74 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [PERF] Use faster way of decode in tokenizer: avoid useless list-to-lâ€¦ â€¦ 04627e3 â€¦ist conversion ( vllm-project#20000 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> 2015aroras pushed a commit\n        to 2015aroras/vllm\n      that referenced\n      this pull request Aug 29, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 38f7e84 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> mengxingkongzhouhan pushed a commit\n        to mengxingkongzhouhan/vllm\n      that referenced\n      this pull request Aug 30, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 4eec518 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> mengxingkongzhouhan pushed a commit\n        to mengxingkongzhouhan/vllm\n      that referenced\n      this pull request Aug 30, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 1f5ccee â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> mengxingkongzhouhan pushed a commit\n        to mengxingkongzhouhan/vllm\n      that referenced\n      this pull request Aug 30, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ b20b3e1 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> mengxingkongzhouhan pushed a commit\n        to mengxingkongzhouhan/vllm\n      that referenced\n      this pull request Aug 30, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ fe798f2 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> mengxingkongzhouhan pushed a commit\n        to mengxingkongzhouhan/vllm\n      that referenced\n      this pull request Aug 30, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 4f2a849 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> nopperl pushed a commit\n        to pfnet/vllm\n      that referenced\n      this pull request Sep 3, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 5a917a8 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> 842974287 pushed a commit\n        to 842974287/vllm\n      that referenced\n      this pull request Sep 3, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 81e37d6 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Shiyan Deng <dsy842974287@meta.com> zhewenl pushed a commit\n        to zhewenl/vllm\n      that referenced\n      this pull request Sep 3, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 1046c1c â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk> ekagra-ranjan pushed a commit\n        to ekagra-ranjan/vllm\n      that referenced\n      this pull request Sep 4, 2025 Revert \"[PERF] Use faster way of decode in tokenizer: avoid useless lâ€¦ â€¦ 4f93bc2 â€¦ist-to-list conversion ( vllm-project#20000 )\" ( vllm-project#23396 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Ekagra Ranjan <3116519+ekagra-ranjan@users.noreply.github.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:44", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: optimization, Optimization, optimization | TEST: test, test, Test", "analysis_extracted_at": "2025-09-07 17:49:44", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[PERF] Use faster way of decode in tokenizer: avoid useless list-to-list conversion (#20000)", "commit_message": "[PERF] Use faster way of decode in tokenizer: avoid useless list-to-list conversion (#20000)\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>", "commit_date": "2025-08-02T01:43:52-07:00", "files_changed": ["vllm/transformers_utils/tokenizer.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 7, "num_non_test_edited_lines": 7, "commit_year": 2025}, "diff_text": "diff --git a/vllm/transformers_utils/tokenizer.py b/vllm/transformers_utils/tokenizer.py\nindex 24ddd35ab..6a31a4198 100644\n--- a/vllm/transformers_utils/tokenizer.py\n+++ b/vllm/transformers_utils/tokenizer.py\n@@ -50,11 +50,12 @@ def decode_tokens(\n     `skip_special_tokens=None` means to use the backend's default\n     settings.\n     \"\"\"\n+    decode_method = getattr(tokenizer, \"_decode\", tokenizer.decode)\n     if skip_special_tokens is not None:\n-        return tokenizer.decode(token_ids,\n-                                skip_special_tokens=skip_special_tokens)\n+        return decode_method(token_ids,\n+                             skip_special_tokens=skip_special_tokens)\n \n-    return tokenizer.decode(token_ids)\n+    return decode_method(token_ids)\n \n \n def encode_tokens(", "apis": ["vllm.transformers_utils.tokenizer.decode_tokens"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/tokenizer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/tokenizer_base.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/tokenizer_group.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file (vllm/transformers_utils/tokenizer.py) and changes the decode_tokens function to use a potentially faster internal method (_decode) over the default decode. This modification directly impacts the performance of the tokenizer's decode functionality, avoiding unnecessary list-to-list conversion as indicated by the commit message. The change is non-trivial, focuses on optimizing performance of a high-level API, and is applicable in general CPU execution contexts.", "llm_api_reason": "The commit optimizes the decode_tokens function in the tokenizer module by using getattr to check for a faster \"_decode\" method. This update directly affects the public API decode_tokens, ensuring that downstream users benefit from improved performance in token decoding."}
{"commit_hash": "eefbf4a68b7b0a5b8364a59647906be1b7f043e2", "pr_url": "https://github.com/vllm-project/vllm/pull/22036", "pr_date": "2025-08-01", "timeline_text": "Copy link Collaborator yewentao256 commented Jul 31, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Purpose Using vectorization utils to reshape_and_cache_flash and get performance improvement Test Acc lm_eval   --model vllm   --model_args \" pretrained=Qwen/Qwen3-30B-A3B-FP8,max_model_len=32768,enforce_eager=True \" --trust_remote_code   --tasks gsm8k   --num_fewshot 5   --batch_size auto | Tasks | Version | Filter | n-shot | Metric | | Value | | Stderr | | ----- | ------: | ---------------- | -----: | ----------- | --- | -----: | --- | -----: | | gsm8k | 3 | flexible-extract | 5 | exact_match | â†‘ | 0.8173 | Â± | 0.0106 | | | | strict-match | 5 | exact_match | â†‘ | 0.8870 | Â± | 0.0087 | # main | Tasks | Version | Filter | n-shot | Metric | | Value | | Stderr | | ----- | ------: | ---------------- | -----: | ----------- | --- | -----: | --- | -----: | | gsm8k | 3 | flexible-extract | 5 | exact_match | â†‘ | 0.8173 | Â± | 0.0106 | | | | strict-match | 5 | exact_match | â†‘ | 0.8870 | Â± | 0.0087 | pytest test_cache.py -x\n==================== test session starts ====================\nplatform linux -- Python 3.12.3, pytest-8.4.0, pluggy-1.6.0\nrootdir: /home/wentao/vllm-source\nconfigfile: pyproject.toml\nplugins: asyncio-1.0.0, anyio-4.9.0\nasyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function\ncollected 1102 items                                        \n\ntest_cache.py ....................................... [  3%]\n...................................s...s...s...s...s. [  8%]\n..s...s...s...s...s...s...s...s...s...s...s...s...s.. [ 13%]\n..................................................... [ 17%]\n....................s...s...s...s...s...s...s...s...s [ 22%]\n...s...s...s...s...s...s...s...s...s................. [ 27%]\n..................................................... [ 32%]\n..................................................... [ 37%]\n..................................................... [ 42%]\n..................................................... [ 46%]\n..................................................... [ 51%]\n..................................................... [ 56%]\n..................................................... [ 61%]\n..................................................... [ 66%]\n..................................................... [ 70%]\n...........s.ss.sssss.ss.ss.sssss.ss.ss.sssss.ss.ss.s [ 75%]\nssss.ss.ss.sssss.ss.ss.sssss.ss.ss.sssss.ss.ss.sssss. [ 80%]\nss.ss.sssss.ss.ss.sssss.ss.ss.sssss.ss.ss.sssss.ss.ss [ 85%]\n.sssss.ss.ss.sssss.ss.ss.sssss.ss.ss.sssss.ss.ss.ssss [ 90%]\ns.ss.ss.sssss.s...................................... [ 94%]\n..................................................... [ 99%]\nsss                                                   [100%]\n\n======= 901 passed, 201 skipped in 349.21s (0:05:49) ======== Performance python benchmark_reshape_and_cache_flash.py num_tokens layout Old Run (Âµs) New Run (Âµs) Change (%) 2 HND 10.326 8.323 -19.4% ðŸš€ 4 HND 10.440 8.355 -20.0% ðŸš€ 8 HND 10.356 8.344 -19.4% ðŸš€ 16 HND 10.330 8.372 -19.0% ðŸš€ 32 HND 10.345 8.348 -19.3% ðŸš€ 64 HND 10.454 8.354 -20.1% ðŸš€ 128 HND 10.397 8.370 -19.5% ðŸš€ 256 HND 14.431 10.375 -28.1% ðŸš€ 512 HND 24.809 20.137 -18.8% ðŸš€ 1024 HND 51.389 45.196 -12.1% ðŸš€ 2048 HND 96.466 77.908 -19.2% ðŸš€ 4096 HND 175.695 147.068 -16.3% ðŸš€ 8192 HND 336.814 279.106 -17.1% ðŸš€ 16384 HND 668.001 547.169 -18.1% ðŸš€ 32768 HND 1320.570 1082.070 -18.1% ðŸš€ 65536 HND 2605.930 2149.950 -17.5% ðŸš€ 2 NHD 10.371 6.649 -35.9% ðŸš€ 4 NHD 10.337 6.407 -38.0% ðŸš€ 8 NHD 10.346 6.338 -38.7% ðŸš€ 16 NHD 10.352 6.394 -38.2% ðŸš€ 32 NHD 10.350 7.416 -28.3% ðŸš€ 64 NHD 10.341 7.305 -29.4% ðŸš€ 128 NHD 10.349 7.614 -26.4% ðŸš€ 256 NHD 14.401 10.363 -28.0% ðŸš€ 512 NHD 25.955 15.084 -41.9% ðŸš€ 1024 NHD 49.264 30.690 -37.7% ðŸš€ 2048 NHD 93.674 53.726 -42.6% ðŸš€ 4096 NHD 172.364 101.030 -41.4% ðŸš€ 8192 NHD 333.329 195.911 -41.2% ðŸš€ 16384 NHD 665.351 385.012 -42.1% ðŸš€ 32768 NHD 1308.720 762.607 -41.7% ðŸš€ 65536 NHD 2587.800 1519.310 -41.3% ðŸš€ Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 3 mgoin, ProExpertProg, and minosfuture reacted with hooray emoji All reactions ðŸŽ‰ 3 reactions yewentao256 added 2 commits July 31, 2025 17:15 optimize reshape and cache flash kernel â€¦ ec2e746 Signed-off-by: yewentao256 <zhyanwentao@126.com> add benchmark script â€¦ 1d25423 Signed-off-by: yewentao256 <zhyanwentao@126.com> mergify bot added\n  the performance Performance-related issues label Jul 31, 2025 gemini-code-assist bot reviewed Jul 31, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request optimizes the reshape_and_cache_flash CUDA kernel by using vectorization, which results in significant performance improvements. The changes look good, but there is a critical correctness issue. The new implementation assumes a contiguous memory layout for the (num_heads, head_size) dimensions in the KV cache, which is only true for the NHD layout. This breaks support for the HND layout, which is also a supported configuration. I've provided a detailed comment with a suggested fix to address this. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions csrc/cache_kernels.cu Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link github-actions bot commented Jul 31, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . yewentao256 added 4 commits July 31, 2025 17:45 Fallback HND â€¦ 8c4484e Signed-off-by: yewentao256 <zhyanwentao@126.com> HND optimize â€¦ 27546f6 Signed-off-by: yewentao256 <zhyanwentao@126.com> optimize HND and update benchmark script â€¦ 8896ba3 Signed-off-by: yewentao256 <zhyanwentao@126.com> update comments â€¦ f850fb5 Signed-off-by: yewentao256 <zhyanwentao@126.com> Copy link Collaborator robertgshaw2-redhat commented Aug 1, 2025 wow, nice work ðŸš€ 1 yewentao256 reacted with rocket emoji All reactions ðŸš€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Aug 1, 2025 mgoin approved these changes Aug 1, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM, vectorize_with_alignment should deal with uneven shapes and existing CI should cover this. I'll make sure to unblock a full run just in case Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 yewentao256 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Hide details View details mgoin merged commit eefbf4a into vllm-project : main Aug 1, 2025 106 of 108 checks passed Uh oh! There was an error while loading. Please reload this page . wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 2d1176c â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: shuw <shuw@nvidia.com> mgoin mentioned this pull request Aug 5, 2025 Update rms_norm_kernel by removing redundant global memory loads #22134 Closed juuice-lee pushed a commit\n        to juuice-lee/vllm-moe.code\n      that referenced\n      this pull request Aug 5, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 77fb21a â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ af2e1b0 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 243072a â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: x22x22 <wadeking@qq.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 70a4ebc â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: x22x22 <wadeking@qq.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 0776d55 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com> jingyu-ml pushed a commit\n        to jingyu-ml/vllm\n      that referenced\n      this pull request Aug 8, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 4a21190 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: jingyu <jingyu@omniml.ai> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 8854ac4 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> noamgat pushed a commit\n        to noamgat/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 417c8f8 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: Noam Gat <noamgat@gmail.com> yyihuang pushed a commit\n        to yyihuang/vllm\n      that referenced\n      this pull request Aug 11, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 677f751 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: Avery Yingyi Huang <yingyihuang2000@outlook.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 8883b90 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 4d7adb0 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com> BoyuanFeng pushed a commit\n        to BoyuanFeng/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 9f6eea7 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: Boyuan Feng <boyuan@meta.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 59b5f69 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> yewentao256 mentioned this pull request Aug 24, 2025 Vectorize RMSNorm CUDA kernel #22602 Open epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 018781e â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com> zhewenl pushed a commit\n        to zhewenl/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 64db329 â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Perf] Optimize reshape_and_cache_flash CUDA Kernel ( vllm-project#2â€¦ â€¦ 27c54dd â€¦2036 )\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:48", "has_lm_eval": true, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, gsm8k, gsm8k | PERF: improvement | TEST: Test, test, test", "analysis_extracted_at": "2025-09-07 17:49:48", "models": ["Qwen/Qwen3-30B-A3B-FP8"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=Qwen/Qwen3-30B-A3B-FP8,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model Qwen/Qwen3-30B-A3B-FP8 --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Perf] Optimize `reshape_and_cache_flash` CUDA Kernel (#22036)", "commit_message": "[Perf] Optimize `reshape_and_cache_flash` CUDA Kernel (#22036)\n\nSigned-off-by: yewentao256 <zhyanwentao@126.com>", "commit_date": "2025-08-01T19:18:51-04:00", "files_changed": ["benchmarks/kernels/benchmark_reshape_and_cache_flash.py", "csrc/cache_kernels.cu"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 4, "num_edited_lines": 248, "num_non_test_edited_lines": 248, "commit_year": 2025}, "diff_text": "diff --git a/benchmarks/kernels/benchmark_reshape_and_cache_flash.py b/benchmarks/kernels/benchmark_reshape_and_cache_flash.py\nnew file mode 100644\nindex 000000000..d4648c18f\n--- /dev/null\n+++ b/benchmarks/kernels/benchmark_reshape_and_cache_flash.py\n@@ -0,0 +1,156 @@\n+# SPDX-License-Identifier: Apache-2.0\n+# SPDX-FileCopyrightText: Copyright contributors to the vLLM project\n+from __future__ import annotations\n+\n+import random\n+import time\n+\n+import torch\n+from tabulate import tabulate\n+\n+from vllm import _custom_ops as ops\n+from vllm.logger import init_logger\n+from vllm.platforms import current_platform\n+from vllm.utils import (\n+    STR_DTYPE_TO_TORCH_DTYPE,\n+    FlexibleArgumentParser,\n+    create_kv_caches_with_random_flash,\n+)\n+\n+logger = init_logger(__name__)\n+\n+\n+@torch.inference_mode()\n+def run_benchmark(\n+    num_tokens: int,\n+    num_heads: int,\n+    head_size: int,\n+    block_size: int,\n+    num_blocks: int,\n+    dtype: torch.dtype,\n+    kv_cache_dtype: str,\n+    kv_cache_layout: str,\n+    num_iters: int,\n+    device: str = \"cuda\",\n+) -> float:\n+    \"\"\"Return latency (seconds) for given num_tokens.\"\"\"\n+\n+    if kv_cache_dtype == \"fp8\" and head_size % 16:\n+        raise ValueError(\"fp8 kv-cache requires head_size to be a multiple of 16.\")\n+\n+    current_platform.seed_everything(42)\n+    torch.set_default_device(device)\n+\n+    # create random key / value tensors [T, H, D].\n+    key = torch.randn(num_tokens, num_heads, head_size, dtype=dtype, device=device)\n+    value = torch.randn_like(key)\n+\n+    # prepare the slot mapping.\n+    # each token is assigned a unique slot in the KV-cache.\n+    num_slots = block_size * num_blocks\n+    if num_tokens > num_slots:\n+        raise ValueError(\"num_tokens cannot exceed the total number of cache slots\")\n+    slot_mapping_lst = random.sample(range(num_slots), num_tokens)\n+    slot_mapping = torch.tensor(slot_mapping_lst, dtype=torch.long, device=device)\n+\n+    key_caches, value_caches = create_kv_caches_with_random_flash(\n+        num_blocks,\n+        block_size,\n+        1,  # num_layers\n+        num_heads,\n+        head_size,\n+        kv_cache_dtype,\n+        dtype,\n+        device=device,\n+        cache_layout=kv_cache_layout,\n+    )\n+    key_cache, value_cache = key_caches[0], value_caches[0]\n+\n+    # compute per-kernel scaling factors for fp8 conversion (if used).\n+    k_scale = (key.amax() / 64.0).to(torch.float32)\n+    v_scale = (value.amax() / 64.0).to(torch.float32)\n+\n+    def run_cuda_benchmark(n_iters: int) -> float:\n+        nonlocal key, value, key_cache, value_cache, slot_mapping\n+        torch.cuda.synchronize()\n+        start = time.perf_counter()\n+        for _ in range(n_iters):\n+            ops.reshape_and_cache_flash(\n+                key,\n+                value,\n+                key_cache,\n+                value_cache,\n+                slot_mapping,\n+                kv_cache_dtype,\n+                k_scale,\n+                v_scale,\n+            )\n+        torch.cuda.synchronize()\n+        end = time.perf_counter()\n+        return (end - start) / n_iters\n+\n+    # warm-up\n+    run_cuda_benchmark(3)\n+\n+    lat = run_cuda_benchmark(num_iters)\n+\n+    # free tensors to mitigate OOM when sweeping\n+    del key, value, key_cache, value_cache, slot_mapping\n+    torch.cuda.empty_cache()\n+\n+    return lat\n+\n+\n+def main(args):\n+    rows = []\n+    for layout in [\"NHD\", \"HND\"]:\n+        for exp in range(1, 17):\n+            n_tok = 2**exp\n+            lat = run_benchmark(\n+                num_tokens=n_tok,\n+                num_heads=args.num_heads,\n+                head_size=args.head_size,\n+                block_size=args.block_size,\n+                num_blocks=args.num_blocks,\n+                dtype=STR_DTYPE_TO_TORCH_DTYPE[args.dtype],\n+                kv_cache_dtype=args.kv_cache_dtype,\n+                kv_cache_layout=layout,\n+                num_iters=args.iters,\n+                device=\"cuda\",\n+            )\n+            rows.append([n_tok, layout, f\"{lat * 1e6:.3f}\"])\n+\n+    print(tabulate(rows, headers=[\"num_tokens\", \"layout\", \"latency (Âµs)\"]))\n+\n+\n+if __name__ == \"__main__\":\n+    parser = FlexibleArgumentParser()\n+\n+    parser.add_argument(\"--num-heads\", type=int, default=128)\n+    parser.add_argument(\n+        \"--head-size\",\n+        type=int,\n+        choices=[64, 80, 96, 112, 120, 128, 192, 256],\n+        default=128,\n+    )\n+    parser.add_argument(\"--block-size\", type=int, choices=[16, 32], default=16)\n+    parser.add_argument(\"--num-blocks\", type=int, default=128 * 512)\n+\n+    parser.add_argument(\n+        \"--dtype\",\n+        type=str,\n+        choices=[\"half\", \"bfloat16\", \"float\"],\n+        default=\"bfloat16\",\n+    )\n+\n+    parser.add_argument(\n+        \"--kv-cache-dtype\",\n+        type=str,\n+        choices=[\"auto\", \"fp8\"],\n+        default=\"auto\",\n+    )\n+\n+    parser.add_argument(\"--iters\", type=int, default=100)\n+    args = parser.parse_args()\n+\n+    main(args)\ndiff --git a/csrc/cache_kernels.cu b/csrc/cache_kernels.cu\nindex 88559c8fe..131dcb15c 100644\n--- a/csrc/cache_kernels.cu\n+++ b/csrc/cache_kernels.cu\n@@ -5,6 +5,7 @@\n #include \"cuda_utils.h\"\n #include \"cuda_compat.h\"\n #include \"dispatch_utils.h\"\n+#include \"quantization/vectorization_utils.cuh\"\n \n #ifdef USE_ROCM\n   #include \"quantization/fp8/amd/quant_utils.cuh\"\n@@ -261,14 +262,26 @@ __global__ void reshape_and_cache_kernel(\n   }\n }\n \n+// Used by vectorization_utils to copy/convert one element\n+template <typename OutT, typename InT, Fp8KVCacheDataType kv_dt>\n+struct CopyWithScaleOp {\n+  float scale;\n+\n+  __device__ __forceinline__ void operator()(OutT& dst, const InT src) const {\n+    if constexpr (kv_dt == Fp8KVCacheDataType::kAuto) {\n+      dst = static_cast<OutT>(src);\n+    } else {\n+      dst = fp8::scaled_convert<OutT, InT, kv_dt>(src, scale);\n+    }\n+  }\n+};\n+\n template <typename scalar_t, typename cache_t, Fp8KVCacheDataType kv_dt>\n __global__ void reshape_and_cache_flash_kernel(\n     const scalar_t* __restrict__ key,    // [num_tokens, num_heads, head_size]\n     const scalar_t* __restrict__ value,  // [num_tokens, num_heads, head_size]\n-    cache_t* __restrict__ key_cache,     // [num_blocks, block_size, num_heads,\n-                                         // head_size]\n-    cache_t* __restrict__ value_cache,   // [num_blocks, block_size, num_heads,\n-                                         // head_size]\n+    cache_t* __restrict__ key_cache,     // NHD or HND, shape see comments below\n+    cache_t* __restrict__ value_cache,   // same above\n     const int64_t* __restrict__ slot_mapping,  // [num_tokens]\n     const int64_t block_stride, const int64_t page_stride,\n     const int64_t head_stride, const int64_t key_stride,\n@@ -282,25 +295,58 @@ __global__ void reshape_and_cache_flash_kernel(\n   }\n   const int64_t block_idx = slot_idx / block_size;\n   const int64_t block_offset = slot_idx % block_size;\n-  const int n = num_heads * head_size;\n-  for (int i = threadIdx.x; i < n; i += blockDim.x) {\n-    const int64_t src_key_idx = token_idx * key_stride + i;\n-    const int64_t src_value_idx = token_idx * value_stride + i;\n-    const int head_idx = i / head_size;\n-    const int head_offset = i % head_size;\n-    const int64_t tgt_key_value_idx = block_idx * block_stride +\n-                                      block_offset * page_stride +\n-                                      head_idx * head_stride + head_offset;\n-    scalar_t tgt_key = key[src_key_idx];\n-    scalar_t tgt_value = value[src_value_idx];\n-    if constexpr (kv_dt == Fp8KVCacheDataType::kAuto) {\n-      key_cache[tgt_key_value_idx] = tgt_key;\n-      value_cache[tgt_key_value_idx] = tgt_value;\n-    } else {\n-      key_cache[tgt_key_value_idx] =\n-          fp8::scaled_convert<cache_t, scalar_t, kv_dt>(tgt_key, *k_scale);\n-      value_cache[tgt_key_value_idx] =\n-          fp8::scaled_convert<cache_t, scalar_t, kv_dt>(tgt_value, *v_scale);\n+  const int n_elems = num_heads * head_size;\n+\n+  // pointers to the beginning of the source row for this token.\n+  const scalar_t* __restrict__ key_src = key + token_idx * key_stride;\n+  const scalar_t* __restrict__ value_src = value + token_idx * value_stride;\n+\n+  // find the start position inside the kv-cache for this token.\n+  cache_t* __restrict__ key_dst =\n+      key_cache + block_idx * block_stride + block_offset * page_stride;\n+  cache_t* __restrict__ value_dst =\n+      value_cache + block_idx * block_stride + block_offset * page_stride;\n+\n+  // this is true for the NHD layout where `head_stride == head_size`\n+  const bool is_contiguous_heads = (head_stride == head_size);\n+\n+  float k_scale_val = (kv_dt == Fp8KVCacheDataType::kAuto) ? 0.f : *k_scale;\n+  float v_scale_val = (kv_dt == Fp8KVCacheDataType::kAuto) ? 0.f : *v_scale;\n+  constexpr int VEC_SIZE = (sizeof(scalar_t) == 2) ? 8 : 4;\n+  CopyWithScaleOp<cache_t, scalar_t, kv_dt> k_op{k_scale_val};\n+  CopyWithScaleOp<cache_t, scalar_t, kv_dt> v_op{v_scale_val};\n+  if (is_contiguous_heads) {\n+    // NHD layout\n+    // kv cache: [num_blocks, block_size, num_heads, head_size]\n+    vectorize_with_alignment<VEC_SIZE>(key_src, key_dst, n_elems, threadIdx.x,\n+                                       blockDim.x, k_op);\n+\n+    vectorize_with_alignment<VEC_SIZE>(value_src, value_dst, n_elems,\n+                                       threadIdx.x, blockDim.x, v_op);\n+\n+  } else {\n+    // HND layout: heads are strided, but each head_size segment is contiguous\n+    // kv cache: [num_blocks, num_heads, block_size, head_size]\n+    const int lane = threadIdx.x & 31;     // 0..31 within warp\n+    const int warp_id = threadIdx.x >> 5;  // warp index within block\n+    const int warps_per_block = blockDim.x >> 5;\n+\n+    for (int head = warp_id; head < num_heads; head += warps_per_block) {\n+      const scalar_t* __restrict__ k_src_h = key_src + head * head_size;\n+      const scalar_t* __restrict__ v_src_h = value_src + head * head_size;\n+\n+      cache_t* __restrict__ k_dst_h =\n+          key_dst + static_cast<int64_t>(head) * head_stride;\n+      cache_t* __restrict__ v_dst_h =\n+          value_dst + static_cast<int64_t>(head) * head_stride;\n+\n+      // within each head, let the 32 threads of the warp perform the vector\n+      // copy\n+      vectorize_with_alignment<VEC_SIZE>(k_src_h, k_dst_h, head_size, lane, 32,\n+                                         k_op);\n+\n+      vectorize_with_alignment<VEC_SIZE>(v_src_h, v_dst_h, head_size, lane, 32,\n+                                         v_op);\n     }\n   }\n }", "apis": ["vllm._custom_ops.reshape_and_cache_flash"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/_custom_ops.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/kernels/benchmark_reshape_and_cache_flash.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes modifications to a core CUDA kernel in a production source file (csrc/cache_kernels.cu) where it introduces vectorization and scaling operations, indicating a performance optimization. Additionally, it adds a benchmark file in the benchmarks/kernels directory to measure the latency of the modified kernel. The changes are non-trivial, modify key computation paths (memory copy and scaling in the CUDA kernel), and target performance improvement on the CPU/GPU interface. Therefore, the commit meets the criteria for a performance/optimization related change.", "llm_api_reason": "This commit introduces performance optimizations to the CUDA kernel used by the \"reshape_and_cache_flash\" operation by incorporating vectorized copying with scaling. Additionally, the benchmark file \"benchmark_reshape_and_cache_flash.py\" is added to measure the latency of this operation. The affected high-level Python API is the one that wraps this CUDA kernel, namely vllm._custom_ops.reshape_and_cache_flash."}
{"commit_hash": "ac45c44d98e77f30e47b8fb69134f4635183070d", "pr_url": "https://github.com/vllm-project/vllm/pull/21837", "pr_date": null, "timeline_text": "Copy link Contributor varun-sundar-rabindranath commented Jul 29, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Purpose DeepEPHighThroughput All2All kernel when used with DeepSeek models dispatches the tokens in 16bit datatype and quantizes after dispatch. This is inefficient for 2 reasons, More data in communication More data to quantize after dispatch This PR introduces a fix to quantize to fp8 first and then dispatch the fp8 tensor. Test Plan canhazgpu  run -g2 -- pytest -s tests/kernels/moe/test_modular_kernel_combinations.py canhazgpu run -g2 -- pytest tests/kernels/moe/test_deepep_deepgemm_moe.py VLLM_ALL2ALL_BACKEND=\"deepep_high_throughput\" VLLM_USE_DEEP_GEMM=1  canhazgpu run -g 2 --  vllm serve Qwen/Qwen3-30B-A3B-FP8  --trust-remote-code --enable-expert-parallel --data-parallel-size 2 --port 9010 --no-enable-prefix-caching Test Result All tests pass for canhazgpu  run -g2 -- pytest -s tests/kernels/moe/test_modular_kernel_combinations.py All tests pass for canhazgpu run -g2 -- pytest tests/kernels/moe/test_deepep_deepgemm_moe.py |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.86|Â±  |0.0349|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.94|Â±  |0.0239| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link github-actions bot commented Jul 29, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the deepseek Related to DeepSeek models label Jul 29, 2025 gemini-code-assist bot reviewed Jul 29, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces a performance optimization for MoE layers using DeepEPHighThroughput with block quantization (e.g., for DeepSeek models). The change correctly modifies the logic to quantize the activations before dispatching them, which reduces communication overhead and is more efficient. The implementation is clean and effective. The condition for pre-quantization is correctly expanded to include block-quantized cases, and the call to the quantization kernel is updated to pass the correct parameters, which also fixes a potential bug that the logical change would have otherwise introduced. Overall, the changes look solid and align well with the stated purpose. I couldn't find any issues of high or critical severity. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author varun-sundar-rabindranath commented Jul 29, 2025 @tlrmchlsmth @bnellnm PTAL ! Thanks ðŸ™Œ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor bnellnm commented Jul 29, 2025 So we still go down the \"quantize after\" codepath if the quantization is per-tensor?  Is there some reason that quantization can't happen beforehand in that case also?  Or does DeepEP not support that? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author varun-sundar-rabindranath commented Jul 29, 2025 So we still go down the \"quantize after\" codepath if the quantization is per-tensor? Is there some reason that quantization can't happen beforehand in that case also? Or does DeepEP not support that? It is a DeepEP limitation. DeepEP doesn't support that. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor bnellnm commented Jul 29, 2025 So we still go down the \"quantize after\" codepath if the quantization is per-tensor? Is there some reason that quantization can't happen beforehand in that case also? Or does DeepEP not support that? It is a DeepEP limitation. DeepEP doesn't support that. Would it make sense to fake it out by replicating the scale and then resizing/truncating them after the dispatch? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author varun-sundar-rabindranath commented Jul 30, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . So we still go down the \"quantize after\" codepath if the quantization is per-tensor? Is there some reason that quantization can't happen beforehand in that case also? Or does DeepEP not support that? It is a DeepEP limitation. DeepEP doesn't support that. Would it make sense to fake it out by replicating the scale and then resizing/truncating them after the dispatch? I went back and looked at the DeepEP documentation here The documentation suggests that only block-quantization is supported. But the function seemingly also supports per-token quantization (We have unit test that have been passing - look here ). However, it looks like we are an assert away in the DeepEP repo from crashing. To be safe, I have updated the code to support only block-quantization for the \"Quant-then-Dispatch\" block. For any other quantization we will \"Dispatch-then-Quant\" cc @tlrmchlsmth ðŸ‘ 1 bnellnm reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth approved these changes Jul 31, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tlrmchlsmth added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 31, 2025 tlrmchlsmth enabled auto-merge (squash) July 31, 2025 14:33 Varun Sundar Rabindranath added 2 commits August 1, 2025 06:32 quant then dispatch â€¦ ed5a03f Signed-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com> Remove per-act-token-quant â€¦ fcf2fe9 Signed-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com> auto-merge was automatically disabled August 1, 2025 06:33 Head branch was pushed to by a user without write access varun-sundar-rabindranath force-pushed the varun/ht-quant-dispatch-ordering branch\n    from 80cb125 to fcf2fe9 Compare August 1, 2025 06:33 varun-sundar-rabindranath changed the title [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant and then Dispatch [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant before Dispatch Aug 1, 2025 Hide details View details vllm-bot merged commit ac45c44 into vllm-project : main Aug 1, 2025 41 of 44 checks passed Uh oh! There was an error while loading. Please reload this page . wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ b787b9a â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: shuw <shuw@nvidia.com> juuice-lee pushed a commit\n        to juuice-lee/vllm-moe.code\n      that referenced\n      this pull request Aug 5, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ a171dbf â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ e53887f â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ fc8f4fa â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: x22x22 <wadeking@qq.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 6058cc5 â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: x22x22 <wadeking@qq.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 7f0c9e2 â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> jingyu-ml pushed a commit\n        to jingyu-ml/vllm\n      that referenced\n      this pull request Aug 8, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 506a08a â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: jingyu <jingyu@omniml.ai> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 024bae4 â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> noamgat pushed a commit\n        to noamgat/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ e62f88f â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Noam Gat <noamgat@gmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 02137be â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ d35b39e â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> BoyuanFeng pushed a commit\n        to BoyuanFeng/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 0c4f6b9 â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Boyuan Feng <boyuan@meta.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 998c08f â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 4a6adca â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> zhewenl pushed a commit\n        to zhewenl/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 4c75149 â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant beforeâ€¦ â€¦ 445bac5 â€¦ Dispatch ( vllm-project#21837 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:52", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: gsm8k | PERF: optimization | SERVING: vllm serve, serve | TEST: Test, Test, test", "analysis_extracted_at": "2025-09-07 17:49:52", "models": ["deepseek-ai/DeepSeek-V2", "deepseek-ai/DeepSeek-V3"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-V2 --tasks gsm8k"], "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-V2", "commit_subject": "[Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant before Dispatch (#21837)", "commit_message": "[Bugfix] [Performance] DeepEPHighThroughput + DeepSeek : Quant before Dispatch (#21837)\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>", "commit_date": "2025-08-01T10:14:38-07:00", "files_changed": ["vllm/model_executor/layers/fused_moe/deepep_ht_prepare_finalize.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 13, "num_non_test_edited_lines": 13, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/fused_moe/deepep_ht_prepare_finalize.py b/vllm/model_executor/layers/fused_moe/deepep_ht_prepare_finalize.py\nindex 7016ff34c..f6b62254e 100644\n--- a/vllm/model_executor/layers/fused_moe/deepep_ht_prepare_finalize.py\n+++ b/vllm/model_executor/layers/fused_moe/deepep_ht_prepare_finalize.py\n@@ -144,12 +144,13 @@ class DeepEPHTPrepareAndFinalize(mk.FusedMoEPrepareAndFinalize):\n                 \"apply_router_weight_on_input is only implemented for topk=1\")\n             a1 = a1 * topk_weights.to(a1.dtype)\n \n-        if quant_config.per_act_token_quant:\n+        if quant_config.is_block_quantized:\n+            # Quant and Dispatch\n             a1q, a1q_scale = moe_kernel_quantize_input(\n                 a1,\n                 a1_scale,\n                 quant_dtype=quant_config.quant_dtype,\n-                per_act_token_quant=True,\n+                per_act_token_quant=quant_config.per_act_token_quant,\n                 block_shape=quant_config.block_shape,\n             )\n             if a1q_scale is not None and a1q_scale.numel() == 1:\n@@ -162,8 +163,10 @@ class DeepEPHTPrepareAndFinalize(mk.FusedMoEPrepareAndFinalize):\n                  rank_topk_weights=topk_weights,\n                  num_experts=num_experts)\n         else:\n-            # DeepEP kernels only support dispatching per-token-quant\n-            # quantization. dispatch in bfloat16.\n+            # Dispatch and Quant\n+            # DeepEP kernels only support dispatching block-quantized\n+            # activation scales.\n+            # Dispatch in bfloat16\n             (expert_x, _, expert_tokens_meta, expert_topk_ids,\n              expert_topk_weights) = self._do_dispatch(\n                  tokens=a1,\n@@ -171,7 +174,7 @@ class DeepEPHTPrepareAndFinalize(mk.FusedMoEPrepareAndFinalize):\n                  rank_topk_ids=topk_ids,\n                  rank_topk_weights=topk_weights,\n                  num_experts=num_experts)\n-            # quantize now\n+            # Quantize after dispatch.\n             expert_x_scale = None\n             if expert_x.numel() != 0:\n                 expert_x, expert_x_scale = moe_kernel_quantize_input(", "apis": ["DeepEPHTPrepareAndFinalize.prepare"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/deepep_ht_prepare_finalize.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/deepseek.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/deepseek_v2.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The diff updates the logic in a critical numeric computation file (a non-test source file) by changing the conditions and order in which quantization is applied relative to dispatch. The commit changes key internal quantization calls (e.g., switching from per-activation to block quantization under certain conditions and thus altering the computational path), which can have a direct performance impact on the high-throughput MoE process. Despite the commit message containing a bugfix label, the changes are performance sensitive since correcting the quantization order can boost throughput on CPU and improve runtime performance. The commit satisfies conditions for modifying non-test source code and affecting performance of top-level APIs without being tied to specific hardware.", "llm_api_reason": "This commit changes the conditional logic in the prepare method of the DeepEPHTPrepareAndFinalize class so that quantization is performed before dispatch when block quantization is enabled. This adjustment alters the behavior of the public prepare API in the fused MoE layer that is used during inference."}
{"commit_hash": "8aa1485fcff7be3e42300c0615ee0f3f3cbce9a8", "pr_url": "https://github.com/vllm-project/vllm/pull/21761", "pr_date": "2025-07-28", "timeline_text": "Copy link Collaborator LucasWilkinson commented Jul 28, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results (Optional) The necessary documentation update, such as updating supported_models.md and examples for a new model. Purpose Currently using the hybrid kv-cache with llama4s chunked local attention causes a latency ~2ms since when the hybrid kv-cache manager is used we end up with 3 ChunkedLocalAttention kv-cache spec groups. We end up with the following groups: (FullAttention x 12) (ChunkedLocalAttention x 12) (ChunkedLocalAttention x 12) (ChunkedLocalAttention x 12) This results in attn metadata and local virtual batches for the local layers being constructed 3 times adding latency: Enabled: \n\nvllm serve meta-llama/Llama-4-Scout-17B-16E-Instruct -tp 4 --trust-remote-code --max-model-len 16384 --port 8081  --disable-log-requests\n\n============ Serving Benchmark Result ============\nSuccessful requests:                     100       \nBenchmark duration (s):                  9.11      \nTotal input tokens:                      6299      \nTotal generated tokens:                  12509     \nRequest throughput (req/s):              10.97     \nOutput token throughput (tok/s):         1372.85   \nTotal Token throughput (tok/s):          2064.16   \n---------------Time to First Token----------------\nMean TTFT (ms):                          61.84     \nMedian TTFT (ms):                        61.53     \nP99 TTFT (ms):                           106.66    \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          28.46     \nMedian TPOT (ms):                        29.17     \nP99 TPOT (ms):                           30.99     \n---------------Inter-token Latency----------------\nMean ITL (ms):                           28.44     \nMedian ITL (ms):                         28.65     \nP99 ITL (ms):                            38.05     \n==================================================\n\n\nDisabled:\n\nvllm serve meta-llama/Llama-4-Scout-17B-16E-Instruct -tp 4 --trust-remote-code --max-model-len 16384 --port 8081  --disable-log-requests --disable-hybrid-kv-cache-manager\n\n============ Serving Benchmark Result ============\nSuccessful requests:                     100       \nBenchmark duration (s):                  8.84      \nTotal input tokens:                      6299      \nTotal generated tokens:                  12297     \nRequest throughput (req/s):              11.32     \nOutput token throughput (tok/s):         1391.49   \nTotal Token throughput (tok/s):          2104.26   \n---------------Time to First Token----------------\nMean TTFT (ms):                          58.69     \nMedian TTFT (ms):                        59.23     \nP99 TTFT (ms):                           90.65     \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          26.48     \nMedian TPOT (ms):                        27.32     \nP99 TPOT (ms):                           28.90     \n---------------Inter-token Latency----------------\nMean ITL (ms):                           26.55     \nMedian ITL (ms):                         26.54     \nP99 ITL (ms):                            39.40     \n================================================== Test Plan see: #21707 Test Result see: #21707 (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions disable chunked local attention by default â€¦ dd3ccf5 Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> LucasWilkinson requested review from simon-mo , WoosukKwon , youkaichao , robertgshaw2-redhat , mgoin , tlrmchlsmth , houseroad and hmellor as code owners July 28, 2025 14:27 Copy link github-actions bot commented Jul 28, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the llama Related to Llama models label Jul 28, 2025 gemini-code-assist bot reviewed Jul 28, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request correctly addresses a performance regression by disabling chunked local attention with the hybrid KV cache manager by default, while providing an environment variable to re-enable it. The implementation is sound. My only suggestion is to update a comment to more accurately reflect that the change is a performance optimization, which will improve code clarity and maintainability. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/config.py Comment on lines +4780 to +4781 # Hybrid KV cache manager is not yet supported with chunked # local attention. Copy link Contributor gemini-code-assist bot Jul 28, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This comment is slightly misleading as it suggests the feature is unsupported, whereas the PR description and warning log indicate it's a performance regression. To improve clarity for future maintenance, it would be better to state the performance-related reason for disabling it. Suggested change # Hybrid KV cache manager is not yet supported with chunked # local attention . # Disable hybrid KV cache manager with chunked local attention # due to a performance regression . Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member mgoin Jul 28, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I kind of agree with Gemini here, although you say this in your log Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin approved these changes Jul 28, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM for the moment Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/config.py Comment on lines +4780 to +4781 # Hybrid KV cache manager is not yet supported with chunked # local attention. Copy link Member mgoin Jul 28, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I kind of agree with Gemini here, although you say this in your log Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/config.py self.scheduler_config.disable_hybrid_kv_cache_manager = True elif \\ not envs.VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE: logger.warning( Copy link Member mgoin Jul 28, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: warning_once Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added performance Performance-related issues ready ONLY add when PR is ready to merge/full CI is needed labels Jul 28, 2025 Copy link Member mgoin commented Jul 28, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Merging to solve the regression since we have better solutions on the way All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details mgoin merged commit 8aa1485 into vllm-project : main Jul 28, 2025 78 checks passed Uh oh! There was an error while loading. Please reload this page . liuyumoye pushed a commit\n        to liuyumoye/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 47a6c89 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> sarckk mentioned this pull request Aug 2, 2025 [Bug]: [v1/core/block_pool.py] Assertion Failure: prev_block.block_hash is not None #21992 Open Copy link Collaborator luccafong commented Aug 2, 2025 @LucasWilkinson will we reduce metadata creation with refactoring? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author LucasWilkinson commented Aug 2, 2025 thats the plan; we are working towards: https://vllm-dev.slack.com/archives/C07R5Q1Q2BB/p1753727605258469?thread_ts=1753202489.248869&cid=C07R5Q1Q2BB but that will be a followup PR All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ e636a83 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: shuw <shuw@nvidia.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ b15f7a3 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: x22x22 <wadeking@qq.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 024f5de â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ be60f7a â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 94a185c â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ bda1d57 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> noamgat pushed a commit\n        to noamgat/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ b0119fd â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Noam Gat <noamgat@gmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 3712e58 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 63e3c03 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> BoyuanFeng pushed a commit\n        to BoyuanFeng/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 46cb6ce â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Boyuan Feng <boyuan@meta.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ afd3f01 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 1e8cef7 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> zhewenl pushed a commit\n        to zhewenl/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ 47bfbc4 â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Perf] Disable chunked local attention by default with llama4 ( vllm-pâ€¦ â€¦ c1a10df â€¦roject#21761 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:49:55", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, TTFT | SERVING: vllm serve, vllm serve, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:49:55", "models": ["meta-llama/Llama-4-Scout-17B-16E-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-4-Scout-17B-16E-Instruct,trust_remote_code=True,max_model_len=16384 --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-4-Scout-17B-16E-Instruct --trust-remote-code --max-model-len 16384", "commit_subject": "[Perf] Disable chunked local attention by default with llama4 (#21761)", "commit_message": "[Perf] Disable chunked local attention by default with llama4 (#21761)\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>", "commit_date": "2025-07-28T18:49:04-04:00", "files_changed": ["vllm/config.py", "vllm/envs.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 3, "num_edited_lines": 35, "num_non_test_edited_lines": 35, "commit_year": 2025}, "diff_text": "diff --git a/vllm/config.py b/vllm/config.py\nindex 6bfe94b76..3bcbbe606 100644\n--- a/vllm/config.py\n+++ b/vllm/config.py\n@@ -4769,12 +4769,23 @@ class VllmConfig:\n                 # Hybrid KV cache manager is not compatible with KV events.\n                 self.scheduler_config.disable_hybrid_kv_cache_manager = True\n             if self.model_config is not None and \\\n-                self.model_config.attention_chunk_size is not None and \\\n-                self.speculative_config is not None and \\\n-                self.speculative_config.use_eagle():\n-                # Hybrid KV cache manager is not yet supported with chunked\n-                # local attention + eagle.\n-                self.scheduler_config.disable_hybrid_kv_cache_manager = True\n+                self.model_config.attention_chunk_size is not None:\n+                if self.speculative_config is not None and \\\n+                    self.speculative_config.use_eagle():\n+                    # Hybrid KV cache manager is not yet supported with chunked\n+                    # local attention + eagle.\n+                    self.scheduler_config.disable_hybrid_kv_cache_manager = True\n+                elif \\\n+                    not envs.VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE:\n+                    logger.warning(\n+                        \"There is a latency regression when using chunked local\"\n+                        \" attention with the hybrid KV cache manager. Disabling\"\n+                        \" it, by default. To enable it, set the environment \"\n+                        \"VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE=1.\"\n+                    )\n+                    # Hybrid KV cache manager is not yet supported with chunked\n+                    # local attention.\n+                    self.scheduler_config.disable_hybrid_kv_cache_manager = True\n \n     def update_sizes_for_sequence_parallelism(self,\n                                               possible_sizes: list) -> list:\ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex 0eff74151..fcfad4eec 100755\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -143,6 +143,7 @@ if TYPE_CHECKING:\n     VLLM_USE_CUDNN_PREFILL: bool = False\n     VLLM_ENABLE_CUDAGRAPH_GC: bool = False\n     VLLM_LOOPBACK_IP: str = \"\"\n+    VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE: bool = False\n \n \n def get_default_cache_root():\n@@ -991,6 +992,17 @@ environment_variables: dict[str, Callable[[], Any]] = {\n     # The default value is \"VLLM\".\n     \"VLLM_PROCESS_NAME_PREFIX\":\n     lambda: os.getenv(\"VLLM_PROCESS_NAME_PREFIX\", \"VLLM\"),\n+\n+    # Allow chunked local attention with hybrid kv cache manager.\n+    # Currently using the Hybrid KV cache manager with chunked local attention\n+    # in the Llama4 models (the only models currently using chunked local attn)\n+    # causes a latency regression. For this reason, we disable it by default.\n+    # This flag is used to allow users to enable it if they want to (to save on\n+    # kv-cache memory usage and enable longer contexts)\n+    # TODO(lucas): Remove this flag once latency regression is resolved.\n+    \"VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE\":\n+    lambda: bool(int(os.getenv(\\\n+            \"VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE\", \"0\"))),\n }\n \n # --8<-- [end:env-vars-definition]", "apis": ["vllm.core.scheduler.Scheduler"], "affected_paths": [], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test, production code (vllm/config.py and vllm/envs.py) and contains non-trivial changes to disable the hybrid KV cache manager when using chunked local attention, in order to mitigate a latency regression. This flag change is directly connected to performance issues (latency regression) in specific model setups (e.g., llama4) while still being testable on CPU and not tied to specific hardware. The focus is on performance optimization and not on a bug fix or a refactoring of comments or documentation.", "llm_api_reason": "This commit modifies how the configuration is set in VllmConfig regarding the hybrid KV cache manager when using chunked local attention. The changes ensure that the scheduler configurationâ€™s flag disable_hybrid_kv_cache_manager is always set to True when chunked local attention is enabled, unless an environment override is provided. Since this flag is read by the scheduler during batching and scheduling, the behavior of vllm.core.scheduler.Scheduler is affected by these changes."}
{"commit_hash": "61b8cea3b42feab021d506e9143551de18f9165c", "pr_url": "https://github.com/vllm-project/vllm/pull/21137", "pr_date": "2025-07-24", "timeline_text": "Copy link Collaborator LucasWilkinson commented Jul 17, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results (Optional) The necessary documentation update, such as updating supported_models.md and examples for a new model. Purpose Flash infer prefers host side CPU buffers in many cases, example: https://github.com/flashinfer-ai/flashinfer/blob/3c40456effae8b9c5b1a11c0d1e0594295b1a312/flashinfer/prefill.py#L1430-L1436 So we pass host side buffers (since #20466 we now have access to these) to reduce D2H transfers. Trace from main showing D2H transfers in plan Test Plan Test Result Accuracy Results VLLM_ATTENTION_BACKEND=FLASHINFER lm_eval --model vllm --model_args pretrained=met\na-llama/Meta-Llama-3-8B-Instruct --tasks gsm8k --batch_size auto\n...\nINFO 07-17 20:33:43 [cuda.py:253] Using FlashInfer backend on V1 engine.\n...\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.7536|Â±  |0.0119|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.7551|Â±  |0.0118| Benchmark Results Benchmark Command: python benchmarks/benchmark_throughput.py --model meta-llama/Llama-3.2-3B-Instruct --dataset-name random --input-len 256 --output-len 128 --num-prompts < N > --seed 42 Results (3 runs per condition, mean Â± standard error): num-prompts Main Branch (req/s) This PR (req/s) 1 1.58 Â± 0.06 1.90 Â± 0.03 8 13.06 Â± 0.11 14.32 Â± 0.21 16 26.00 Â± 0.07 28.74 Â± 0.13 32 47.84 Â± 0.57 46.53 Â± 1.57 64 76.14 Â± 0.45 81.43 Â± 3.43 128 116.99 Â± 6.10 127.78 Â± 7.50 256 164.45 Â± 6.12 177.70 Â± 3.88 Tested on NVIDIA B200 GPU with meta-llama/Llama-3.2-3B-Instruct (256â†’128 tokens) (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link github-actions bot commented Jul 17, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added rocm Related to AMD ROCm speculative-decoding labels Jul 17, 2025 Copy link mergify bot commented Jul 17, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @LucasWilkinson . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added v1 needs-rebase labels Jul 17, 2025 gemini-code-assist bot reviewed Jul 17, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request is a significant and well-executed refactoring of the attention backend infrastructure. The primary goal of decoupling the metadata builders from the model runner has been achieved, which improves modularity and maintainability. The optimization for FlashInfer by preparing metadata on the CPU is a key improvement and has been implemented correctly. The introduction of CommonAttentionMetadata as a unified data structure is a solid design choice that simplifies the data flow to the attention backends. The refactoring of the speculative decoding logic, particularly in vllm/v1/spec_decode/eagle.py , to remove the Triton kernel in favor of a more readable PyTorch/NumPy implementation is a notable improvement. The addition of a comprehensive test suite in tests/v1/attention/test_attention_backends.py is excellent. It provides strong validation for the correctness of this large-scale refactoring by comparing various backends against a reference implementation under realistic conditions. Overall, the changes are of high quality and represent a positive step forward for the codebase. I have not identified any issues of high or critical severity. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions LucasWilkinson force-pushed the lwilkinson/flash-infer-host-buffers branch\n    from 87ccacf to 8af5f3b Compare July 18, 2025 00:36 mergify bot removed\n  the needs-rebase label Jul 18, 2025 LucasWilkinson marked this pull request as ready for review July 18, 2025 03:54 LucasWilkinson requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners July 18, 2025 03:54 WoosukKwon reviewed Jul 18, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment BTW why don't we use Numpy instead of PyTorch CPU tensors? Except for some edge cases, Numpy is usually faster in my experience. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor fhl2000 commented Jul 18, 2025 Could we still pass the device tensors to Flashinfer's plan() rather than host tensors? Because we might want to support full cudagraph of Flashinfer in the future (currently implemented in #20059 in rough), which requires managing device-side persistent buffers that can be reused across different decode wrappers. Here, one decode wrapper corresponds to a runtime shape that needs to be captured. Also, if we pass the host tensors to the wrapper,  it seems that H2D transfers still exist.  If I remember correctly, Sglang's implementation overrides the plan functions that still pass host-side persistent buffers, and also explicitly avoids certain D2H transfers. Hope it's helpful! @LucasWilkinson All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author LucasWilkinson commented Jul 18, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . BTW why don't we use Numpy instead of PyTorch CPU tensors? Except for some edge cases, Numpy is usually faster in my experience. Ive found going to and from numpy (i.e. .numpy() , torch::from_numpy can be a bit slow and only worth it if you are gonna do alot of ops; since FlashInfer ultimately wants torch tensors and for most of these theres only one or two ops per tensor im not sure its worth going to numpy; but I can scrub for tensors that are manipulated alot ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author LucasWilkinson commented Jul 18, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Could we still pass the device tensors to Flashinfer's plan() rather than host tensors? Because we might want to support full cudagraph of Flashinfer in the future (currently implemented in #20059 in rough), which requires managing device-side persistent buffers that can be reused across different decode wrappers. Here, one decode wrapper corresponds to a runtime shape that needs to be captured. If you look in FlashInfer's BatchDecodeWithPagedKVCacheWrapper you'll see the buffers get copied in the cudagraph path regardless: https://github.com/flashinfer-ai/flashinfer/blob/1e9a41ad7f0efc5989bb0a2bf7e954902c8c73af/flashinfer/decode.py#L892-L910 and will get copied to the host: https://github.com/flashinfer-ai/flashinfer/blob/1e9a41ad7f0efc5989bb0a2bf7e954902c8c73af/flashinfer/decode.py#L925-L926 Also, if we pass the host tensors to the wrapper, it seems that H2D transfers still exist. Yes; however H2D transfers are preferred over D2H as they can be done in a non-blocking fashion and do force synchronization with GPU. For the build call we are trying to optimize the CPU overhead so the fire-and-forget nature of the H2D transfers is better then depending on D2H transfer. If I remember correctly, Sglang's implementation overrides the plan functions that still pass host-side persistent buffers, and also explicitly avoids certain D2H transfers. Thats effectively what this PR does; the CPU buffers in CommonAttentionMetadata are views into the gpu_model_runner s persistent input_batch host side tensors. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor fhl2000 commented Jul 18, 2025 If I remember correctly, Sglang's implementation overrides the plan functions that still pass host-side persistent buffers, Oh my bad! Sorry, I was saying they are passing the device-side buffers. If you look in FlashInfer's BatchDecodeWithPagedKVCacheWrapper you'll see the buffers get copied in the cudagraph path regardless: https://github.com/flashinfer-ai/flashinfer/blob/1e9a41ad7f0efc5989bb0a2bf7e954902c8c73af/flashinfer/decode.py#L892-L910 and will get copied to the host: https://github.com/flashinfer-ai/flashinfer/blob/1e9a41ad7f0efc5989bb0a2bf7e954902c8c73af/flashinfer/decode.py#L925-L926 I am wondering if we can override this plan function that lets the wrapper directly own the device-side persistent buffer from VLLM, and avoid any unnecessary copy (device-to-device or host-to-device)?  At least for qo_indptr, which is equivalent to query_start_loc, we already have both cpu and gpu versions of it from common_attn_metadata, so we can just reuse them without any further copy. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author LucasWilkinson commented Jul 18, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . If I remember correctly, Sglang's implementation overrides the plan functions that still pass host-side persistent buffers, Oh my bad! Sorry, I was saying they are passing the device-side buffers. If you look in FlashInfer's BatchDecodeWithPagedKVCacheWrapper you'll see the buffers get copied in the cudagraph path regardless: https://github.com/flashinfer-ai/flashinfer/blob/1e9a41ad7f0efc5989bb0a2bf7e954902c8c73af/flashinfer/decode.py#L892-L910 and will get copied to the host: https://github.com/flashinfer-ai/flashinfer/blob/1e9a41ad7f0efc5989bb0a2bf7e954902c8c73af/flashinfer/decode.py#L925-L926 I am wondering if we can override this plan function that lets the wrapper directly own the device-side persistent buffer from VLLM, and avoid any unnecessary copy (device-to-device or host-to-device)? At least for qo_indptr, which is equivalent to query_start_loc, we already have both cpu and gpu versions of it from common_attn_metadata, so we can just reuse them without any further copy. Is this what you are referring to? https://github.com/sgl-project/sglang/blob/719b29f218a09642193c4bda2a7ffa32829d5604/python/sglang/srt/layers/attention/flashinfer_backend.py#L1229 ?; not that familiar with sglang. This is an interesting idea; thanks for sharing! Regardless, even in this overridden version they pass host side buffers ( https://github.com/sgl-project/sglang/blob/719b29f218a09642193c4bda2a7ffa32829d5604/python/sglang/srt/layers/attention/flashinfer_backend.py#L1334-L1336 ); so if we want to override plan in the future I think we would still want this PR as a stepping stone (and override plan in follow up PR). ðŸ‘ 1 fhl2000 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member mgoin commented Jul 18, 2025 Could you make sure to test the trtllm case in the flashinfer backend as well? Just want to make sure this choice is preferable for that backend as well if affected All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . fhl2000 mentioned this pull request Jul 22, 2025 [V1][CUDA] Full cudagraph support for FlashInfer #21367 Merged 4 tasks Copy link Collaborator Author LucasWilkinson commented Jul 23, 2025 @mgoin looks good ðŸ‘ I think we should land this since its a win and I can follow up if using numpy helps VLLM_LOGGING_LEVEL=INFO cVLLM_USE_TRTLLM_DECODE_ATTENTION=1 VLLM_ATTENTION_BACKEND=FLASHINFER_VLLM_V1 lm_eval   --model vllm   --model_args '{\"pretrained\": \"meta-llama/Meta-Llama\n-3-8B-Instruct\"}'   --tasks gsm8k --batch_size auto\n...\nWARNING 07-23 11:40:01 [flashinfer.py:140] Using TRTLLM decode attention (auto-detected). \n...                                                 \nvllm ({'pretrained': 'meta-llama/Meta-Llama-3-8B-Instruct'}), gen_kwargs: (None), limit: None, num_fewshot: None, batch_size: auto\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.7559|Â±  |0.0118|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.7574|Â±  |0.0118| ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . LucasWilkinson added 4 commits July 23, 2025 11:44 host buffers â€¦ 6b18ffb Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\nOptimize V1 FlashInfer backend to use CPU host buffers\n\n- Replace GPU-to-CPU transfers with direct CPU tensor construction\n- Build planning tensors from existing CommonAttentionMetadata CPU buffers\n- Reduce from 6x to 1x .cpu() calls during FlashInfer planning\n- Fix test mocks to handle correct argument count\n- Maintain compatibility with GPUModelRunner and FlashInfer V1 backend\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\ndont transfer block table\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\noptimize\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> reorder imports â€¦ 599ee48 Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> cleanup â€¦ 4e07e01 Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> cleanup â€¦ 585548e Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 23, 2025 mgoin approved these changes Jul 23, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good to me, thanks! After review the amount of work we have to do on the CPU is more than I expected, so looking forward to seeing full cg Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 fhl2000 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction LucasWilkinson added 2 commits July 23, 2025 13:32 fix attention test â€¦ 701fdc0 Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> format â€¦ b087694 Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> LucasWilkinson force-pushed the lwilkinson/flash-infer-host-buffers branch\n    from 155e954 to b087694 Compare July 23, 2025 17:33 format â€¦ 9723f3d Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> mgoin enabled auto-merge (squash) July 24, 2025 00:54 Hide details View details vllm-bot merged commit 61b8cea into vllm-project : main Jul 24, 2025 67 of 69 checks passed Uh oh! There was an error while loading. Please reload this page . elvischenv mentioned this pull request Jul 24, 2025 [Bugfix] Fix workspace buffer None issue for Flashinfer TRTLLM Backend #21525 Merged 4 tasks avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 3e6afaf â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 8b86ba2 â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: shuw <shuw@nvidia.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 841628b â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ d368f33 â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 39d315c â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 9a7c08f â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 965d4ef â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 484d958 â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> BoyuanFeng pushed a commit\n        to BoyuanFeng/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 6b0bc15 â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Boyuan Feng <boyuan@meta.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ c3786d8 â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ f22e665 â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Attention] Optimize FlashInfer MetadataBuilder Build call ( vllm-projâ€¦ â€¦ 593f1b1 â€¦ect#21137 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:01", "has_lm_eval": true, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, gsm8k | PERF: req/s, req/s, optimization | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:50:01", "models": ["meta-llama/Meta-Llama-3-8B-Instruct", "meta-llama/Llama-3.2-3B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Meta-Llama-3-8B-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.2-3B-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Meta-Llama-3-8B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Attention] Optimize FlashInfer MetadataBuilder Build call (#21137)", "commit_message": "[Attention] Optimize FlashInfer MetadataBuilder Build call (#21137)\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>", "commit_date": "2025-07-24T03:21:46-07:00", "files_changed": ["tests/v1/attention/test_attention_backends.py", "tests/v1/attention/utils.py", "vllm/v1/attention/backends/flashinfer.py"], "functions_changed": [], "stats": {"num_test_files": 2, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 0, "num_files": 3, "num_hunks": 16, "num_edited_lines": 172, "num_non_test_edited_lines": 157, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/attention/test_attention_backends.py b/tests/v1/attention/test_attention_backends.py\nindex b4e0101a0..9bd0b9979 100644\n--- a/tests/v1/attention/test_attention_backends.py\n+++ b/tests/v1/attention/test_attention_backends.py\n@@ -11,7 +11,8 @@ from tests.v1.attention.utils import (BatchSpec, _Backend,\n                                       create_vllm_config,\n                                       get_attention_backend)\n from vllm.utils import STR_DTYPE_TO_TORCH_DTYPE, cdiv\n-from vllm.v1.attention.backends.utils import CommonAttentionMetadata\n+from vllm.v1.attention.backends.utils import (CommonAttentionMetadata,\n+                                              set_kv_cache_layout)\n from vllm.v1.kv_cache_interface import FullAttentionSpec\n \n BACKENDS_TO_TEST = [\n@@ -212,7 +213,7 @@ def run_attention_backend(backend: _Backend, kv_cache_spec: FullAttentionSpec,\n \n         from vllm.v1.attention.backends.flashinfer import PerLayerParameters\n \n-        def mock_get_per_layer_parameters(vllm_config):\n+        def mock_get_per_layer_parameters(vllm_config, impl_cls):\n             # Return mock parameters for a single layer\n             head_size = vllm_config.model_config.get_head_size()\n             return {\n@@ -297,7 +298,8 @@ def test_backend_correctness(batch_spec_name: str, model: str):\n     5. Comparing the vLLM backend's output to the ground-truth SDPA output.\n     \"\"\"\n     batch_spec = BATCH_SPECS[batch_spec_name]\n-    vllm_config = create_vllm_config(model_name=model)\n+    vllm_config = create_vllm_config(model_name=model,\n+                                     max_model_len=max(batch_spec.seq_lens))\n     device = torch.device(\"cuda:0\")\n \n     kv_cache_spec = create_standard_kv_cache_spec(vllm_config)\n@@ -419,6 +421,11 @@ def test_backend_correctness(batch_spec_name: str, model: str):\n         if backend_name == _Backend.FLASHINFER_VLLM_V1:\n             kv_cache_for_backend = kv_cache.transpose(0, 1)\n \n+            # For FlashInfer default to HND layout and\n+            kv_cache_for_backend = kv_cache_for_backend.transpose(\n+                2, 3).contiguous().transpose(2, 3)\n+            set_kv_cache_layout(\"HND\")\n+\n         backend_output = run_attention_backend(backend_name, kv_cache_spec,\n                                                vllm_config, device,\n                                                common_attn_metadata,\ndiff --git a/tests/v1/attention/utils.py b/tests/v1/attention/utils.py\nindex 30cfbdda5..69bd4a206 100644\n--- a/tests/v1/attention/utils.py\n+++ b/tests/v1/attention/utils.py\n@@ -66,7 +66,7 @@ def create_common_attn_metadata(\n     num_computed_tokens_cpu = torch.tensor(context_lens, dtype=torch.int32)\n \n     # Create block table (random for testing)\n-    max_blocks = max(batch_spec.seq_lens) // block_size + 1\n+    max_blocks = (max(batch_spec.seq_lens) + block_size - 1) // block_size\n     block_table_tensor = torch.randint(0,\n                                        max_block_idx,\n                                        (batch_spec.batch_size, max_blocks),\ndiff --git a/vllm/v1/attention/backends/flashinfer.py b/vllm/v1/attention/backends/flashinfer.py\nindex 953ef26c8..94d80d441 100755\n--- a/vllm/v1/attention/backends/flashinfer.py\n+++ b/vllm/v1/attention/backends/flashinfer.py\n@@ -18,6 +18,7 @@ from vllm.attention.backends.abstract import (AttentionBackend, AttentionImpl,\n from vllm.config import VllmConfig\n from vllm.logger import init_logger\n from vllm.platforms import current_platform\n+from vllm.utils import cdiv\n from vllm.v1.attention.backends.flash_attn import use_cascade_attention\n from vllm.v1.attention.backends.utils import (\n     AttentionMetadataBuilder, CommonAttentionMetadata, PerLayerParameters,\n@@ -158,7 +159,7 @@ class FlashInferMetadata:\n     # (batch_size + 1,). The cumulative subquery lengths of the sequences in\n     # the batch, used to index into subquery. E.g., if the subquery length\n     # is [4, 6], it is [0, 4, 10].\n-    qo_indptr: torch.Tensor\n+    qo_indptr_cpu: torch.Tensor\n     # An example for paged_kv_indices, paged_kv_indptr:\n     # request 1, page indices [0, 5, 8]\n     # request 2, page indices [1, 6, 7]\n@@ -167,13 +168,13 @@ class FlashInferMetadata:\n     # [0, 5, 8, 1, 6, 7, 3, 4]\n     # paged_kv_indptr is used to index into paged_kv_indices:\n     # [0, 3, 6, 8]\n-    # The indptr of the paged kv cache, shape: [batch_size + 1]\n-    paged_kv_indptr: torch.Tensor\n-    # The page indices of the paged kv cache\n+    # The indptr of the paged kv cache, shape: [batch_size + 1] (CPU for plan)\n+    paged_kv_indptr_cpu: torch.Tensor\n+    # The page indices of the paged kv cache (on device for plan)\n     paged_kv_indices: torch.Tensor\n     # The number of entries in the last page of each request in\n-    # the paged kv cache, shape: [batch_size]\n-    paged_kv_last_page_len: torch.Tensor\n+    # the paged kv cache, shape: [batch_size] (CPU for plan)\n+    paged_kv_last_page_len_cpu: torch.Tensor\n     # The number of query/output heads\n     num_qo_heads: int\n     # The number of key/value heads\n@@ -201,22 +202,17 @@ class FlashInferMetadata:\n     num_prefills: int\n     num_prefill_tokens: int\n \n-    # For cascade attention.\n+    # For cascade attention (CPU for planning).\n     use_cascade: bool\n-    shared_qo_indptr: Optional[torch.Tensor] = None\n-    shared_kv_page_indptr: Optional[torch.Tensor] = None\n-    shared_kv_page_indices: Optional[torch.Tensor] = None\n-    shared_kv_last_page_len: Optional[torch.Tensor] = None\n+    shared_qo_indptr_cpu: Optional[torch.Tensor] = None\n+    shared_kv_page_indptr_cpu: Optional[torch.Tensor] = None\n+    shared_kv_page_indices_cpu: Optional[torch.Tensor] = None\n+    shared_kv_last_page_len_cpu: Optional[torch.Tensor] = None\n \n     prefill_wrapper: Optional[BatchPrefillWithPagedKVCacheWrapper] = None\n     decode_wrapper: Optional[BatchDecodeWithPagedKVCacheWrapper] = None\n     cascade_wrapper: Optional[MultiLevelCascadeAttentionWrapper] = None\n \n-    @property\n-    def query_start_loc(self):\n-        # The GPUModelRunner expects to be able to access this property.\n-        return self.qo_indptr\n-\n     def __post_init__(self):\n         if self.head_dim is not None:\n             FlashInferBackend.validate_head_size(self.head_dim)\n@@ -238,6 +234,12 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n         self.vllm_config = vllm_config\n         self.cache_config = vllm_config.cache_config\n         self.kv_cache_spec = kv_cache_spec\n+        max_num_blocks_per_request = cdiv(\n+            vllm_config.model_config.max_model_len,\n+            self.kv_cache_spec.block_size)\n+        self.block_table_arange = torch.arange(max_num_blocks_per_request,\n+                                               dtype=torch.int32,\n+                                               device=self.device)\n \n     def reorder_batch(self, input_batch: InputBatch,\n                       scheduler_output: SchedulerOutput) -> bool:\n@@ -285,21 +287,25 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n         if self.global_hyperparameters is None:\n             self.global_hyperparameters = infer_global_hyperparameters(\n                 get_per_layer_parameters(self.vllm_config, FlashInferImpl))\n+\n         if attn_metadata.use_cascade:\n             attn_metadata.cascade_wrapper = self._get_cascade_wrapper()\n             attn_metadata.cascade_wrapper.plan(\n-                [attn_metadata.shared_qo_indptr, attn_metadata.qo_indptr],\n                 [\n-                    attn_metadata.shared_kv_page_indptr,\n-                    attn_metadata.paged_kv_indptr\n+                    attn_metadata.shared_qo_indptr_cpu,\n+                    attn_metadata.qo_indptr_cpu\n+                ],\n+                [\n+                    attn_metadata.shared_kv_page_indptr_cpu,\n+                    attn_metadata.paged_kv_indptr_cpu\n                 ],\n                 [\n-                    attn_metadata.shared_kv_page_indices,\n+                    attn_metadata.shared_kv_page_indices_cpu,\n                     attn_metadata.paged_kv_indices\n                 ],\n                 [\n-                    attn_metadata.shared_kv_last_page_len,\n-                    attn_metadata.paged_kv_last_page_len\n+                    attn_metadata.shared_kv_last_page_len_cpu,\n+                    attn_metadata.paged_kv_last_page_len_cpu\n                 ],\n                 attn_metadata.num_qo_heads,\n                 attn_metadata.num_kv_heads,\n@@ -320,22 +326,22 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n                 # Decodes are first so prefills start after the last decode\n                 prefill_start = num_decodes\n                 attn_metadata.prefill_wrapper = self._get_prefill_wrapper()\n-                assert attn_metadata.qo_indptr[prefill_start:].shape[\n+                assert attn_metadata.qo_indptr_cpu[prefill_start:].shape[\n                     0] == num_prefills + 1\n-                assert attn_metadata.paged_kv_indptr[prefill_start:].shape[\n+                assert attn_metadata.paged_kv_indptr_cpu[prefill_start:].shape[\n                     0] == num_prefills + 1\n-                assert attn_metadata.paged_kv_last_page_len[\n+                assert attn_metadata.paged_kv_last_page_len_cpu[\n                     prefill_start:].shape[0] == num_prefills\n                 # Since prefill_wrapper.run() will be called with\n                 # query[num_decode_tokens:] we need to adjust the qo_indptr\n                 # to be relative to the start of the prefill queries.\n-                qo_indptr = attn_metadata.qo_indptr[\n-                    prefill_start:] - attn_metadata.qo_indptr[prefill_start]\n+                qo_indptr_cpu = attn_metadata.qo_indptr_cpu[\n+                    prefill_start:] - attn_metadata.qo_indptr_cpu[prefill_start]\n                 attn_metadata.prefill_wrapper.plan(\n-                    qo_indptr,\n-                    attn_metadata.paged_kv_indptr[prefill_start:],\n+                    qo_indptr_cpu,\n+                    attn_metadata.paged_kv_indptr_cpu[prefill_start:],\n                     attn_metadata.paged_kv_indices,\n-                    attn_metadata.paged_kv_last_page_len[prefill_start:],\n+                    attn_metadata.paged_kv_last_page_len_cpu[prefill_start:],\n                     attn_metadata.num_qo_heads,\n                     attn_metadata.num_kv_heads,\n                     attn_metadata.head_dim,\n@@ -357,9 +363,9 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n                         attn_metadata.num_qo_heads, attn_metadata.num_kv_heads,\n                         attn_metadata.head_dim):\n                     attn_metadata.decode_wrapper.plan(\n-                        attn_metadata.paged_kv_indptr[:num_decodes + 1],\n+                        attn_metadata.paged_kv_indptr_cpu[:num_decodes + 1],\n                         attn_metadata.paged_kv_indices,\n-                        attn_metadata.paged_kv_last_page_len[:num_decodes],\n+                        attn_metadata.paged_kv_last_page_len_cpu[:num_decodes],\n                         attn_metadata.num_qo_heads,\n                         attn_metadata.num_kv_heads,\n                         attn_metadata.head_dim,\n@@ -383,55 +389,58 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n             split_decodes_and_prefills(common_attn_metadata)\n \n         page_size = self.kv_cache_spec.block_size\n-        device = self.device\n-        qo_indptr = common_attn_metadata.query_start_loc\n         max_seq_len = common_attn_metadata.seq_lens_cpu.max()\n         seq_lens = common_attn_metadata.seq_lens\n+        seq_lens_cpu = common_attn_metadata.seq_lens_cpu\n         block_table_tensor = common_attn_metadata.block_table_tensor\n \n-        block_table_bounds = (seq_lens + page_size - 1) // page_size\n+        block_table_bounds_cpu = (seq_lens_cpu + page_size - 1) // page_size\n \n         use_cascade = common_prefix_len > 0\n         if use_cascade:\n             # Grab the blocks of the shared prefix from the first request.\n             assert common_prefix_len % page_size == 0\n             num_common_kv_blocks = common_prefix_len // page_size\n-            shared_qo_indptr = torch.tensor([0, num_actual_tokens],\n-                                            dtype=torch.int32,\n-                                            device=device)\n-            shared_kv_page_indptr = torch.tensor([0, num_common_kv_blocks],\n-                                                 dtype=torch.int32,\n-                                                 device=device)\n-            shared_kv_page_indices = block_table_tensor[\n+\n+            # Create CPU versions directly for cascade (no GPU versions needed)\n+            shared_qo_indptr_cpu = torch.tensor([0, num_actual_tokens],\n+                                                dtype=torch.int32,\n+                                                device='cpu')\n+            shared_kv_page_indptr_cpu = torch.tensor([0, num_common_kv_blocks],\n+                                                     dtype=torch.int32,\n+                                                     device='cpu')\n+            shared_kv_page_indices_cpu = block_table_tensor[\n                 0, :num_common_kv_blocks]\n-            shared_kv_last_page_len = torch.tensor([page_size],\n-                                                   dtype=torch.int32,\n-                                                   device=device)\n+            shared_kv_last_page_len_cpu = torch.tensor([page_size],\n+                                                       dtype=torch.int32,\n+                                                       device='cpu')\n+\n             # Remove the blocks of the shared prefix from all requests.\n             block_table_tensor = block_table_tensor[:, num_common_kv_blocks:]\n-            block_table_bounds -= num_common_kv_blocks\n+            block_table_bounds_cpu -= num_common_kv_blocks\n         else:\n-            shared_qo_indptr = None\n-            shared_kv_page_indptr = None\n-            shared_kv_page_indices = None\n-            shared_kv_last_page_len = None\n-\n-        mask = (torch.arange(block_table_tensor.size(1),\n-                             dtype=block_table_tensor.dtype,\n-                             device=block_table_tensor.device).unsqueeze(0)\n+            shared_qo_indptr_cpu = None\n+            shared_kv_page_indptr_cpu = None\n+            shared_kv_page_indices_cpu = None\n+            shared_kv_last_page_len_cpu = None\n+\n+        max_num_blocks = block_table_bounds_cpu.max()\n+        block_table_bounds = block_table_bounds_cpu.to(self.device,\n+                                                       non_blocking=True)\n+        mask = (self.block_table_arange[:max_num_blocks].unsqueeze(0)\n                 < block_table_bounds.unsqueeze(1))\n-        paged_kv_indices = block_table_tensor[mask]\n-\n-        paged_kv_indptr = torch.cat([\n-            torch.zeros(1,\n-                        dtype=block_table_bounds.dtype,\n-                        device=block_table_bounds.device),\n-            block_table_bounds.cumsum(dim=0, dtype=torch.int32)\n-        ])\n-\n-        paged_kv_last_page_len = seq_lens % page_size\n-        paged_kv_last_page_len = torch.where(paged_kv_last_page_len == 0,\n-                                             page_size, paged_kv_last_page_len)\n+        paged_kv_indices = block_table_tensor[:, :max_num_blocks][mask]\n+\n+        paged_kv_indptr_cpu = torch.zeros(len(block_table_bounds_cpu) + 1,\n+                                          dtype=torch.int32,\n+                                          device='cpu')\n+        paged_kv_indptr_cpu[1:] = block_table_bounds_cpu.cumsum(\n+            dim=0, dtype=torch.int32)\n+\n+        paged_kv_last_page_len_cpu = seq_lens_cpu % page_size\n+        paged_kv_last_page_len_cpu = torch.where(\n+            paged_kv_last_page_len_cpu == 0, page_size,\n+            paged_kv_last_page_len_cpu)\n         cache_dtype = self.cache_config.cache_dtype\n         if cache_dtype.startswith(\"fp8\"):\n             kv_cache_dtype = FlashInferBackend.get_fp8_dtype_for_flashinfer(\n@@ -440,10 +449,10 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n             kv_cache_dtype = self.kv_cache_spec.dtype\n         attn_metadata = FlashInferMetadata(\n             num_actual_tokens=num_actual_tokens,\n-            qo_indptr=qo_indptr,\n-            paged_kv_indptr=paged_kv_indptr,\n+            qo_indptr_cpu=common_attn_metadata.query_start_loc_cpu,\n+            paged_kv_indptr_cpu=paged_kv_indptr_cpu,\n             paged_kv_indices=paged_kv_indices,\n-            paged_kv_last_page_len=paged_kv_last_page_len,\n+            paged_kv_last_page_len_cpu=paged_kv_last_page_len_cpu,\n             num_qo_heads=self.vllm_config.model_config.get_num_attention_heads(\n                 self.vllm_config.parallel_config),\n             num_kv_heads=self.kv_cache_spec.num_kv_heads,\n@@ -457,14 +466,14 @@ class FlashInferMetadataBuilder(AttentionMetadataBuilder[FlashInferMetadata]):\n             num_prefills=num_prefills,\n             num_prefill_tokens=num_prefill_tokens,\n             use_cascade=use_cascade,\n-            shared_qo_indptr=shared_qo_indptr,\n-            shared_kv_page_indptr=shared_kv_page_indptr,\n-            shared_kv_page_indices=shared_kv_page_indices,\n-            shared_kv_last_page_len=shared_kv_last_page_len,\n+            shared_qo_indptr_cpu=shared_qo_indptr_cpu,\n+            shared_kv_page_indptr_cpu=shared_kv_page_indptr_cpu,\n+            shared_kv_page_indices_cpu=shared_kv_page_indices_cpu,\n+            shared_kv_last_page_len_cpu=shared_kv_last_page_len_cpu,\n             max_seq_len=max_seq_len,\n             seq_lens=seq_lens,\n             block_table_tensor=block_table_tensor,\n-            workspace_buffer=self._workspace_buffer,\n+            workspace_buffer=self._get_workspace_buffer(),\n         )\n \n         self._plan(num_prefills, num_decodes, attn_metadata)", "apis": ["vllm.v1.attention.backends.flashinfer.FlashInferMetadata", "vllm.v1.attention.backends.flashinfer.FlashInferMetadataBuilder", "vllm.v1.attention.backends.utils.set_kv_cache_layout"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/utils/flashinfer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/flashinfer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/flashinfer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/adapter_commons/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/multimodal/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/profiler/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/online_serving/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/kernels/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/cutlass_benchmarks/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/structured_output/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/model_loader/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/benchmarks/lib/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/punica_wrapper/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/kv_transfer/kv_connector/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/tool_parsers/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/ops/triton_ops/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/quark/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/compressed_tensors/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/kv_cache_interface.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The patch modifies non-test source files (e.g., vllm/v1/attention/backends/flashinfer.py) and introduces changes to how metadata is computed and managed for the FlashInfer backend. The changes include reworking tensor layout handling (e.g., CPU vs GPU tensors), refining block calculations, and updating function signatures. These alterations aim to improve performance by optimizing memory layout and processing paths. The changes are non-trivial modifications to internal APIs that impact performance on CPU and are testable without GPU-specific workload instructions. Thus, they satisfy the criteria for a performance/optimization-related commit.", "llm_api_reason": "The commit adjusts and optimizes how FlashInferâ€™s attention metadata is built. In the tests, it updates the configuration call (passing max_model_len) and makes use of a newlyâ€exposed utility function to force the â€œHNDâ€ KV cache layout. In the FlashInfer backend itself, several field names are renamed (for example, â€œqo_indptrâ€, â€œpaged_kv_indptrâ€, and â€œpaged_kv_last_page_lenâ€ are replaced by their CPU counterparts) and the MetadataBuilderâ€™s plan() call is updated to use the CPU versions. These changes affect the public FlashInfer metadata and associated configuration functions."}
{"commit_hash": "4fb56914c5f27ef062e10d44a0f79c6ceab382f9", "pr_url": "https://github.com/vllm-project/vllm/pull/21116", "pr_date": "2025-07-17", "timeline_text": "Copy link Contributor mickaelseznec commented Jul 17, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results (Optional) The necessary documentation update, such as updating supported_models.md and examples for a new model. Purpose For MLA models that have a q_lora_rank: fuse q_lora and kv_lora into the same matrix (avoids some traffic + one less kernel call). Also adds a implementation for layernorm to operate on strided input, this avoids memory copy. Test Plan Units tests added for strided layernorm. E2E testing & benchamrks results in this PR Test Result Accuracy main ( 20149d8 ) vllm (pretrained=deepseek-ai/DeepSeek-V3-0324,tensor_parallel_size=8,trust_remote_code=True), gen_kwargs: (None), limit: None, num_fewshot: 5, batch_size: auto |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr| |-----|------:|----------------|-----:|-----------|---|-----:|---|-----:| |gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.9469|Â±  |0.0062| |     |       |strict-match    |     5|exact_match|â†‘  |0.9454|Â±  |0.0063| This PR: vllm (pretrained=deepseek-ai/DeepSeek-V3-0324,add_bos_token=true,tensor_parallel_size=8), gen_kwargs: (None), limit: 250.0, num_fewshot: None, batch_size: auto |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr| |-----|------:|----------------|-----:|-----------|---|----:|---|-----:| |gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.952|Â±  |0.0135| |     |       |strict-match    |     5|exact_match|â†‘  |0.952|Â±  |0.0135| Performance main ( 20149d8 ) venv â¯ python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-V3-0324 --dataset-name sharegpt --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json INFO 07-15 17:16:08 [__init__.py:253] Automatically detected platform cuda. Namespace(backend='vllm', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/completions', dataset_name='sharegpt', dataset_path='ShareGPT_V3_unfiltered_cleaned_split.json', no_stream=False, max_concurrency=None, model='deepseek-ai/DeepSeek-V3-0324', tokenizer=None, use_beam_search=False, num_prompts=1000, logprobs=None, request_rate=inf, burstiness=1.0, seed=0, trust_remote_code=False, disable_tqdm=False, profile=False, save_result=False, save_detailed=False, append_result=False, metadata=None, result_dir=None, result_filename=None, ignore_eos=False, percentile_metrics='ttft,tpot,itl', metric_percentiles='99', goodput=None, custom_output_len=256, custom_skip_chat_template=False, sonnet_input_len=550, sonnet_output_len=150, sonnet_prefix_len=200, sharegpt_output_len=None, random_input_len=1024, random_output_len=128, random_range_ratio=0.0, random_prefix_len=0, hf_subset=None, hf_split=None, hf_output_len=None, top_p=None, top_k=None, min_p=None, temperature=None, tokenizer_mode='auto', served_model_name=None, lora_modules=None, ramp_up_strategy=None, ramp_up_start_rps=None, ramp_up_end_rps=None) Starting initial single prompt test run... Initial test run completed. Starting main benchmark run... Traffic request rate: inf RPS. Burstiness factor: 1.0 (Poisson process) Maximum request concurrency: None 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1000/1000 [00:58<00:00, 17.10it/s] ============ Serving Benchmark Result ============ Successful requests:                     1000 Benchmark duration (s):                  58.46 Total input tokens:                      219171 Total generated tokens:                  164272 Request throughput (req/s):              17.10 Output token throughput (tok/s):         2809.81 Total Token throughput (tok/s):          6558.65 ---------------Time to First Token---------------- Mean TTFT (ms):                          8290.64 Median TTFT (ms):                        7975.92 P99 TTFT (ms):                           14349.76 -----Time per Output Token (excl. 1st token)------ Mean TPOT (ms):                          177.57 Median TPOT (ms):                        115.76 P99 TPOT (ms):                           434.24 ---------------Inter-token Latency---------------- Mean ITL (ms):                           98.84 Median ITL (ms):                         66.80 P99 ITL (ms):                            435.74 ================================================== This PR: venv â¯ python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-V3-0324 --dataset-name sharegpt --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json INFO 07-17 10:27:38 [__init__.py:253] Automatically detected platform cuda. Namespace(backend='vllm', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/completions', dataset_name='sharegpt', dataset_path='ShareGPT_V3_unfiltered_cleaned_split.json', no_stream=False, max_concurrency=None, model='deepseek-ai/DeepSeek-V3-0324', tokenizer=None, use_beam_search=False, num_prompts=1000, logprobs=None, request_rate=inf, burstiness=1.0, seed=0, trust_remote_code=False, disable_tqdm=False, profile=False, save_result=False, save_detailed=False, append_result=False, metadata=None, result_dir=None, result_filename=None, ignore_eos=False, percentile_metrics='ttft,tpot,itl', metric_percentiles='99', goodput=None, custom_output_len=256, custom_skip_chat_template=False, sonnet_input_len=550, sonnet_output_len=150, sonnet_prefix_len=200, sharegpt_output_len=None, random_input_len=1024, random_output_len=128, random_range_ratio=0.0, random_prefix_len=0, hf_subset=None, hf_split=None, hf_output_len=None, top_p=None, top_k=None, min_p=None, temperature=None, tokenizer_mode='auto', served_model_name=None, lora_modules=None, ramp_up_strategy=None, ramp_up_start_rps=None, ramp_up_end_rps=None) Starting initial single prompt test run... Initial test run completed. Starting main benchmark run... Traffic request rate: inf RPS. Burstiness factor: 1.0 (Poisson process) Maximum request concurrency: None 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1000/1000 [00:56<00:00, 17.63it/s] ============ Serving Benchmark Result ============ Successful requests:                     1000 Benchmark duration (s):                  56.72 Total input tokens:                      219171 Total generated tokens:                  165898 Request throughput (req/s):              17.63 Output token throughput (tok/s):         2925.10 Total Token throughput (tok/s):          6789.51 ---------------Time to First Token---------------- Mean TTFT (ms):                          6917.92 Median TTFT (ms):                        6629.26 P99 TTFT (ms):                           12941.51 -----Time per Output Token (excl. 1st token)------ Mean TPOT (ms):                          171.18 Median TPOT (ms):                        108.68 P99 TPOT (ms):                           461.18 ---------------Inter-token Latency---------------- Mean ITL (ms):                           95.07 Median ITL (ms):                         67.52 P99 ITL (ms):                            431.03 ================================================== (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 4 mgoin, hj-mistral, LucasWilkinson, and simon-mo reacted with rocket emoji All reactions ðŸš€ 4 reactions mickaelseznec requested review from tlrmchlsmth , WoosukKwon , mgoin and robertgshaw2-redhat as code owners July 17, 2025 10:36 Copy link github-actions bot commented Jul 17, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the deepseek Related to DeepSeek models label Jul 17, 2025 gemini-code-assist bot reviewed Jul 17, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces two significant optimizations: fusing the QKV projection for MLA models and implementing a strided LayerNorm kernel. The changes are well-implemented and should provide the performance benefits described. The fusion of Q-LoRA and KV-LoRA projections into a single matrix operation for DeepSeek-V2 models is a smart optimization that reduces kernel launch overhead and memory traffic. The introduction of MergedReplicatedLinear to handle this fusion is a clean way to extend the existing linear layer infrastructure. The addition of a strided layernorm implementation is crucial for the fusion to be effective, as it avoids expensive .contiguous() calls on tensor slices. The CUDA kernels have been updated correctly to handle the input_stride , and the PyTorch bindings are adjusted accordingly. The test suite has been properly extended to cover the new strided input case for the layernorm kernels, ensuring the correctness of the new implementation. Overall, this is a high-quality contribution that improves performance while maintaining code clarity and correctness. I have no major concerns. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions feat: add fused MLA QKV + strided layernorm â€¦ e3962ab Signed-off-by: Mickael Seznec <mickael@mistral.ai> mickaelseznec force-pushed the mseznec/merged-qkv-and-strided-layernorm branch\n    from 75b3d50 to e3962ab Compare July 17, 2025 10:38 mgoin requested a review\n  from LucasWilkinson July 17, 2025 12:06 tlrmchlsmth reviewed Jul 17, 2025 View reviewed changes csrc/layernorm_kernels.cu Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat reviewed Jul 17, 2025 View reviewed changes vllm/model_executor/models/deepseek_v2.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . LucasWilkinson reviewed Jul 17, 2025 View reviewed changes vllm/model_executor/layers/linear.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . mickaelseznec added 2 commits July 17, 2025 14:06 review: stride->int64_t â€¦ 3f6b148 Signed-off-by: Mickael Seznec <mickael@mistral.ai> pre-commit â€¦ 4f77a0d Signed-off-by: Mickael Seznec <mickael@mistral.ai> Copy link Collaborator LucasWilkinson commented Jul 17, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Nice thanks for the contribution! Clean, simple and gives perf; the trifecta haha. Overall looks pretty good to me but I think one of the weight loading experts, i.e. @dsikka or @mgoin should take a look to make sure we dont break 4bit quantized models â¤ï¸ 1 mickaelseznec reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . fix: better fallback in weight loader â€¦ 49a9b00 Signed-off-by: Mickael Seznec <mickael@mistral.ai> yewentao256 reviewed Jul 17, 2025 View reviewed changes Copy link Collaborator yewentao256 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the work! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions csrc/layernorm_kernels.cu Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/layers/linear.py Comment on lines +423 to +424 from vllm.model_executor.layers.quantization.fp8 import ( Fp8LinearMethod, Fp8MoEMethod) Copy link Collaborator yewentao256 Jul 17, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Could we refactor the code, so that we can put import on top of the file without worrying about the circular import instead here? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author mickaelseznec Jul 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Well it's tricky, because FP8Linear already depends on Linear (which makes sense). I don't know how you'd like to proceed. I lazily copy/pasted from https://github.com/vllm-project/vllm/blob/main/vllm/model_executor/layers/linear.py#L787-L791 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator yewentao256 Jul 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yeah I am thinking, if A imports B, B imports A. We can have a base file C, move base things into C, so A imports C, B imports C as well. We don't need to do it right now in this pr if you don't wish, could be done by refactor in the future. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author mickaelseznec Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Sure! Here, the best way would probably be to rely on inheritance by defining (and overriding) methods like: QuantizeMethodBase.supports_block_quantization() However, I don't have a complete overview on all the supported cases and potential edge-cases and it might make this PR heavier than needed now. Happy to help with a following PR though :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator yewentao256 Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Sounds great, certainly you can do that in another pr Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mickaelseznec changed the title feat: add fused MLA QKV + strided layernorm [perf] Add fused MLA QKV + strided layernorm Jul 18, 2025 mickaelseznec added 2 commits July 18, 2025 13:12 review: fewer magic numbers â€¦ b6f3455 Signed-off-by: Mickael Seznec <mickael@mistral.ai> fix: pre-commit â€¦ d1be02d Signed-off-by: Mickael Seznec <mickael@mistral.ai> mgoin approved these changes Jul 21, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice work! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Merge branch 'main' into mseznec/merged-qkv-and-strided-layernorm 070dfa4 mgoin enabled auto-merge (squash) July 21, 2025 18:38 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 21, 2025 Hide details View details vllm-bot merged commit 4fb5691 into vllm-project : main Jul 22, 2025 106 of 108 checks passed Uh oh! There was an error while loading. Please reload this page . xuechendi mentioned this pull request Jul 22, 2025 [BUGFIX] deepseek-v2-lite failed due to fused_qkv_a_proj name update #21414 Merged 4 tasks yeqcharlotte pushed a commit\n        to yeqcharlotte/vllm\n      that referenced\n      this pull request Jul 23, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 37ec8cb Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com> zixi-qi pushed a commit\n        to zixi-qi/vllm\n      that referenced\n      this pull request Jul 23, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 46b75f4 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: qizixi <qizixi@meta.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 7c6c84c Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com> benchislett mentioned this pull request Jul 30, 2025 [Bugfix] Fix MTP weight loading #21941 Merged avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ da8f8fe Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 994dd51 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: shuw <shuw@nvidia.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 95d77b5 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 4402c98 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com> fxmarty-amd mentioned this pull request Aug 6, 2025 [Bugfix] Add missing packed_modules_mapping to DeepseekV2ForCausalLM #22352 Merged npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 2e941f0 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ bb2b8ee Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 3c47ab0 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ b771731 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com> benchislett mentioned this pull request Aug 14, 2025 [Model] Support deepseek with eagle #21086 Merged 4 tasks diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 52f0b84 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> cjackal mentioned this pull request Aug 25, 2025 [Bug]: DeepSeek-R1 AWQ model loading is not possible in v0.10.0 or later. #23530 Open 1 task epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ 7b35796 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [perf] Add fused MLA QKV + strided layernorm ( vllm-project#21116 ) â€¦ c7e4502 Signed-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com> cjackal mentioned this pull request Aug 30, 2025 DeepSeek fix: awq x mergedreplicatedlinear #23764 Open 5 tasks Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:06", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: gsm8k, gsm8k | PERF: ttft, TTFT, TTFT | SERVING: Serving, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:50:06", "models": ["deepseek-ai/DeepSeek-V3-0324"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-V3-0324 --dataset-name sharegpt --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json", "commit_subject": "[perf] Add fused MLA QKV + strided layernorm (#21116)", "commit_message": "[perf] Add fused MLA QKV + strided layernorm (#21116)\n\nSigned-off-by: Mickael Seznec <mickael@mistral.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>", "commit_date": "2025-07-22T07:07:44-07:00", "files_changed": ["csrc/layernorm_kernels.cu", "csrc/layernorm_quant_kernels.cu", "csrc/quantization/fp8/common.cu", "tests/kernels/core/test_layernorm.py", "vllm/model_executor/layers/linear.py", "vllm/model_executor/layers/quantization/fp8.py", "vllm/model_executor/models/deepseek_v2.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 6, "only_test_files": 0, "only_non_test_files": 0, "num_files": 7, "num_hunks": 46, "num_edited_lines": 280, "num_non_test_edited_lines": 254, "commit_year": 2025}, "diff_text": "diff --git a/csrc/layernorm_kernels.cu b/csrc/layernorm_kernels.cu\nindex d073dd6d2..f051eb070 100644\n--- a/csrc/layernorm_kernels.cu\n+++ b/csrc/layernorm_kernels.cu\n@@ -15,15 +15,16 @@ namespace vllm {\n // TODO(woosuk): Further optimize this kernel.\n template <typename scalar_t>\n __global__ void rms_norm_kernel(\n-    scalar_t* __restrict__ out,           // [..., hidden_size]\n-    const scalar_t* __restrict__ input,   // [..., hidden_size]\n+    scalar_t* __restrict__ out,          // [..., hidden_size]\n+    const scalar_t* __restrict__ input,  // [..., hidden_size]\n+    const int64_t input_stride,\n     const scalar_t* __restrict__ weight,  // [hidden_size]\n     const float epsilon, const int num_tokens, const int hidden_size) {\n   __shared__ float s_variance;\n   float variance = 0.0f;\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n-    const float x = (float)input[blockIdx.x * hidden_size + idx];\n+    const float x = (float)input[blockIdx.x * input_stride + idx];\n     variance += x * x;\n   }\n \n@@ -37,7 +38,7 @@ __global__ void rms_norm_kernel(\n   __syncthreads();\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n-    float x = (float)input[blockIdx.x * hidden_size + idx];\n+    float x = (float)input[blockIdx.x * input_stride + idx];\n     out[blockIdx.x * hidden_size + idx] =\n         ((scalar_t)(x * s_variance)) * weight[idx];\n   }\n@@ -50,7 +51,8 @@ __global__ void rms_norm_kernel(\n template <typename scalar_t, int width>\n __global__ std::enable_if_t<(width > 0) && _typeConvert<scalar_t>::exists>\n fused_add_rms_norm_kernel(\n-    scalar_t* __restrict__ input,         // [..., hidden_size]\n+    scalar_t* __restrict__ input,  // [..., hidden_size]\n+    const int64_t input_stride,\n     scalar_t* __restrict__ residual,      // [..., hidden_size]\n     const scalar_t* __restrict__ weight,  // [hidden_size]\n     const float epsilon, const int num_tokens, const int hidden_size) {\n@@ -59,6 +61,7 @@ fused_add_rms_norm_kernel(\n   static_assert(sizeof(_f16Vec<scalar_t, width>) == sizeof(scalar_t) * width);\n \n   const int vec_hidden_size = hidden_size / width;\n+  const int64_t vec_input_stride = input_stride / width;\n   __shared__ float s_variance;\n   float variance = 0.0f;\n   /* These and the argument pointers are all declared `restrict` as they are\n@@ -73,7 +76,8 @@ fused_add_rms_norm_kernel(\n \n   for (int idx = threadIdx.x; idx < vec_hidden_size; idx += blockDim.x) {\n     int id = blockIdx.x * vec_hidden_size + idx;\n-    _f16Vec<scalar_t, width> temp = input_v[id];\n+    int64_t strided_id = blockIdx.x * vec_input_stride + idx;\n+    _f16Vec<scalar_t, width> temp = input_v[strided_id];\n     temp += residual_v[id];\n     variance += temp.sum_squares();\n     residual_v[id] = temp;\n@@ -90,10 +94,11 @@ fused_add_rms_norm_kernel(\n \n   for (int idx = threadIdx.x; idx < vec_hidden_size; idx += blockDim.x) {\n     int id = blockIdx.x * vec_hidden_size + idx;\n+    int64_t strided_id = blockIdx.x * vec_input_stride + idx;\n     _f16Vec<scalar_t, width> temp = residual_v[id];\n     temp *= s_variance;\n     temp *= weight_v[idx];\n-    input_v[id] = temp;\n+    input_v[strided_id] = temp;\n   }\n }\n \n@@ -103,7 +108,8 @@ fused_add_rms_norm_kernel(\n template <typename scalar_t, int width>\n __global__ std::enable_if_t<(width == 0) || !_typeConvert<scalar_t>::exists>\n fused_add_rms_norm_kernel(\n-    scalar_t* __restrict__ input,         // [..., hidden_size]\n+    scalar_t* __restrict__ input,  // [..., hidden_size]\n+    const int64_t input_stride,\n     scalar_t* __restrict__ residual,      // [..., hidden_size]\n     const scalar_t* __restrict__ weight,  // [hidden_size]\n     const float epsilon, const int num_tokens, const int hidden_size) {\n@@ -111,7 +117,7 @@ fused_add_rms_norm_kernel(\n   float variance = 0.0f;\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n-    scalar_t z = input[blockIdx.x * hidden_size + idx];\n+    scalar_t z = input[blockIdx.x * input_stride + idx];\n     z += residual[blockIdx.x * hidden_size + idx];\n     float x = (float)z;\n     variance += x * x;\n@@ -129,7 +135,7 @@ fused_add_rms_norm_kernel(\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n     float x = (float)residual[blockIdx.x * hidden_size + idx];\n-    input[blockIdx.x * hidden_size + idx] =\n+    input[blockIdx.x * input_stride + idx] =\n         ((scalar_t)(x * s_variance)) * weight[idx];\n   }\n }\n@@ -141,11 +147,12 @@ void rms_norm(torch::Tensor& out,     // [..., hidden_size]\n               torch::Tensor& weight,  // [hidden_size]\n               double epsilon) {\n   TORCH_CHECK(out.is_contiguous());\n-  TORCH_CHECK(input.is_contiguous());\n+  TORCH_CHECK(input.stride(-1) == 1);\n   TORCH_CHECK(weight.is_contiguous());\n \n   int hidden_size = input.size(-1);\n   int num_tokens = input.numel() / hidden_size;\n+  int64_t input_stride = input.stride(-2);\n \n   dim3 grid(num_tokens);\n   dim3 block(std::min(hidden_size, 1024));\n@@ -153,26 +160,29 @@ void rms_norm(torch::Tensor& out,     // [..., hidden_size]\n   const cudaStream_t stream = at::cuda::getCurrentCUDAStream();\n   VLLM_DISPATCH_FLOATING_TYPES(input.scalar_type(), \"rms_norm_kernel\", [&] {\n     vllm::rms_norm_kernel<scalar_t><<<grid, block, 0, stream>>>(\n-        out.data_ptr<scalar_t>(), input.data_ptr<scalar_t>(),\n+        out.data_ptr<scalar_t>(), input.data_ptr<scalar_t>(), input_stride,\n         weight.data_ptr<scalar_t>(), epsilon, num_tokens, hidden_size);\n   });\n }\n \n-#define LAUNCH_FUSED_ADD_RMS_NORM(width)                                       \\\n-  VLLM_DISPATCH_FLOATING_TYPES(                                                \\\n-      input.scalar_type(), \"fused_add_rms_norm_kernel\", [&] {                  \\\n-        vllm::fused_add_rms_norm_kernel<scalar_t, width>                       \\\n-            <<<grid, block, 0, stream>>>(input.data_ptr<scalar_t>(),           \\\n-                                         residual.data_ptr<scalar_t>(),        \\\n-                                         weight.data_ptr<scalar_t>(), epsilon, \\\n-                                         num_tokens, hidden_size);             \\\n+#define LAUNCH_FUSED_ADD_RMS_NORM(width)                                    \\\n+  VLLM_DISPATCH_FLOATING_TYPES(                                             \\\n+      input.scalar_type(), \"fused_add_rms_norm_kernel\", [&] {               \\\n+        vllm::fused_add_rms_norm_kernel<scalar_t, width>                    \\\n+            <<<grid, block, 0, stream>>>(                                   \\\n+                input.data_ptr<scalar_t>(), input_stride,                   \\\n+                residual.data_ptr<scalar_t>(), weight.data_ptr<scalar_t>(), \\\n+                epsilon, num_tokens, hidden_size);                          \\\n       });\n \n void fused_add_rms_norm(torch::Tensor& input,     // [..., hidden_size]\n                         torch::Tensor& residual,  // [..., hidden_size]\n                         torch::Tensor& weight,    // [hidden_size]\n                         double epsilon) {\n+  TORCH_CHECK(residual.is_contiguous());\n+  TORCH_CHECK(weight.is_contiguous());\n   int hidden_size = input.size(-1);\n+  int64_t input_stride = input.stride(-2);\n   int num_tokens = input.numel() / hidden_size;\n \n   dim3 grid(num_tokens);\n@@ -194,9 +204,16 @@ void fused_add_rms_norm(torch::Tensor& input,     // [..., hidden_size]\n   auto inp_ptr = reinterpret_cast<std::uintptr_t>(input.data_ptr());\n   auto res_ptr = reinterpret_cast<std::uintptr_t>(residual.data_ptr());\n   auto wt_ptr = reinterpret_cast<std::uintptr_t>(weight.data_ptr());\n-  bool ptrs_are_aligned =\n-      inp_ptr % 16 == 0 && res_ptr % 16 == 0 && wt_ptr % 16 == 0;\n-  if (ptrs_are_aligned && hidden_size % 8 == 0) {\n+  constexpr int vector_width = 8;\n+  constexpr int req_alignment_bytes =\n+      vector_width * 2;  // vector_width * sizeof(bfloat16 or float16) (float32\n+                         // falls back to non-vectorized version anyway)\n+  bool ptrs_are_aligned = inp_ptr % req_alignment_bytes == 0 &&\n+                          res_ptr % req_alignment_bytes == 0 &&\n+                          wt_ptr % req_alignment_bytes == 0;\n+  bool offsets_are_multiple_of_vector_width =\n+      hidden_size % vector_width == 0 && input_stride % vector_width == 0;\n+  if (ptrs_are_aligned && offsets_are_multiple_of_vector_width) {\n     LAUNCH_FUSED_ADD_RMS_NORM(8);\n   } else {\n     LAUNCH_FUSED_ADD_RMS_NORM(0);\ndiff --git a/csrc/layernorm_quant_kernels.cu b/csrc/layernorm_quant_kernels.cu\nindex d595b9e88..0fd5849d9 100644\n--- a/csrc/layernorm_quant_kernels.cu\n+++ b/csrc/layernorm_quant_kernels.cu\n@@ -23,8 +23,9 @@ namespace vllm {\n // TODO(woosuk): Further optimize this kernel.\n template <typename scalar_t, typename fp8_type>\n __global__ void rms_norm_static_fp8_quant_kernel(\n-    fp8_type* __restrict__ out,           // [..., hidden_size]\n-    const scalar_t* __restrict__ input,   // [..., hidden_size]\n+    fp8_type* __restrict__ out,          // [..., hidden_size]\n+    const scalar_t* __restrict__ input,  // [..., hidden_size]\n+    const int input_stride,\n     const scalar_t* __restrict__ weight,  // [hidden_size]\n     const float* __restrict__ scale,      // [1]\n     const float epsilon, const int num_tokens, const int hidden_size) {\n@@ -32,7 +33,7 @@ __global__ void rms_norm_static_fp8_quant_kernel(\n   float variance = 0.0f;\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n-    const float x = (float)input[blockIdx.x * hidden_size + idx];\n+    const float x = (float)input[blockIdx.x * input_stride + idx];\n     variance += x * x;\n   }\n \n@@ -49,7 +50,7 @@ __global__ void rms_norm_static_fp8_quant_kernel(\n   float const scale_inv = 1.0f / *scale;\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n-    float x = (float)input[blockIdx.x * hidden_size + idx];\n+    float x = (float)input[blockIdx.x * input_stride + idx];\n     float const out_norm = ((scalar_t)(x * s_variance)) * weight[idx];\n     out[blockIdx.x * hidden_size + idx] =\n         scaled_fp8_conversion<true, fp8_type>(out_norm, scale_inv);\n@@ -63,8 +64,9 @@ __global__ void rms_norm_static_fp8_quant_kernel(\n template <typename scalar_t, int width, typename fp8_type>\n __global__ std::enable_if_t<(width > 0) && _typeConvert<scalar_t>::exists>\n fused_add_rms_norm_static_fp8_quant_kernel(\n-    fp8_type* __restrict__ out,           // [..., hidden_size]\n-    scalar_t* __restrict__ input,         // [..., hidden_size]\n+    fp8_type* __restrict__ out,    // [..., hidden_size]\n+    scalar_t* __restrict__ input,  // [..., hidden_size]\n+    const int input_stride,\n     scalar_t* __restrict__ residual,      // [..., hidden_size]\n     const scalar_t* __restrict__ weight,  // [hidden_size]\n     const float* __restrict__ scale,      // [1]\n@@ -74,6 +76,7 @@ fused_add_rms_norm_static_fp8_quant_kernel(\n   static_assert(sizeof(_f16Vec<scalar_t, width>) == sizeof(scalar_t) * width);\n \n   const int vec_hidden_size = hidden_size / width;\n+  const int vec_input_stride = input_stride / width;\n   __shared__ float s_variance;\n   float variance = 0.0f;\n   /* These and the argument pointers are all declared `restrict` as they are\n@@ -87,8 +90,9 @@ fused_add_rms_norm_static_fp8_quant_kernel(\n       reinterpret_cast<const _f16Vec<scalar_t, width>*>(weight);\n \n   for (int idx = threadIdx.x; idx < vec_hidden_size; idx += blockDim.x) {\n+    int stride_id = blockIdx.x * vec_input_stride + idx;\n     int id = blockIdx.x * vec_hidden_size + idx;\n-    _f16Vec<scalar_t, width> temp = input_v[id];\n+    _f16Vec<scalar_t, width> temp = input_v[stride_id];\n     temp += residual_v[id];\n     variance += temp.sum_squares();\n     residual_v[id] = temp;\n@@ -125,8 +129,9 @@ fused_add_rms_norm_static_fp8_quant_kernel(\n template <typename scalar_t, int width, typename fp8_type>\n __global__ std::enable_if_t<(width == 0) || !_typeConvert<scalar_t>::exists>\n fused_add_rms_norm_static_fp8_quant_kernel(\n-    fp8_type* __restrict__ out,           // [..., hidden_size]\n-    scalar_t* __restrict__ input,         // [..., hidden_size]\n+    fp8_type* __restrict__ out,    // [..., hidden_size]\n+    scalar_t* __restrict__ input,  // [..., hidden_size]\n+    const int input_stride,\n     scalar_t* __restrict__ residual,      // [..., hidden_size]\n     const scalar_t* __restrict__ weight,  // [hidden_size]\n     const float* __restrict__ scale,      // [1]\n@@ -135,7 +140,7 @@ fused_add_rms_norm_static_fp8_quant_kernel(\n   float variance = 0.0f;\n \n   for (int idx = threadIdx.x; idx < hidden_size; idx += blockDim.x) {\n-    scalar_t z = input[blockIdx.x * hidden_size + idx];\n+    scalar_t z = input[blockIdx.x * input_stride + idx];\n     z += residual[blockIdx.x * hidden_size + idx];\n     float x = (float)z;\n     variance += x * x;\n@@ -169,7 +174,9 @@ void rms_norm_static_fp8_quant(torch::Tensor& out,     // [..., hidden_size]\n                                torch::Tensor& weight,  // [hidden_size]\n                                torch::Tensor& scale,   // [1]\n                                double epsilon) {\n+  TORCH_CHECK(out.is_contiguous());\n   int hidden_size = input.size(-1);\n+  int input_stride = input.stride(-2);\n   int num_tokens = input.numel() / hidden_size;\n \n   dim3 grid(num_tokens);\n@@ -183,8 +190,9 @@ void rms_norm_static_fp8_quant(torch::Tensor& out,     // [..., hidden_size]\n               vllm::rms_norm_static_fp8_quant_kernel<scalar_t, fp8_t>\n                   <<<grid, block, 0, stream>>>(\n                       out.data_ptr<fp8_t>(), input.data_ptr<scalar_t>(),\n-                      weight.data_ptr<scalar_t>(), scale.data_ptr<float>(),\n-                      epsilon, num_tokens, hidden_size);\n+                      input_stride, weight.data_ptr<scalar_t>(),\n+                      scale.data_ptr<float>(), epsilon, num_tokens,\n+                      hidden_size);\n             });\n       });\n }\n@@ -198,7 +206,7 @@ void rms_norm_static_fp8_quant(torch::Tensor& out,     // [..., hidden_size]\n                                                                width, fp8_t> \\\n                   <<<grid, block, 0, stream>>>(                              \\\n                       out.data_ptr<fp8_t>(), input.data_ptr<scalar_t>(),     \\\n-                      residual.data_ptr<scalar_t>(),                         \\\n+                      input_stride, residual.data_ptr<scalar_t>(),           \\\n                       weight.data_ptr<scalar_t>(), scale.data_ptr<float>(),  \\\n                       epsilon, num_tokens, hidden_size);                     \\\n             });                                                              \\\n@@ -210,7 +218,10 @@ void fused_add_rms_norm_static_fp8_quant(\n     torch::Tensor& weight,    // [hidden_size]\n     torch::Tensor& scale,     // [1]\n     double epsilon) {\n+  TORCH_CHECK(out.is_contiguous());\n+  TORCH_CHECK(residual.is_contiguous());\n   int hidden_size = input.size(-1);\n+  int input_stride = input.stride(-2);\n   int num_tokens = input.numel() / hidden_size;\n \n   dim3 grid(num_tokens);\n@@ -234,7 +245,7 @@ void fused_add_rms_norm_static_fp8_quant(\n   auto wt_ptr = reinterpret_cast<std::uintptr_t>(weight.data_ptr());\n   bool ptrs_are_aligned =\n       inp_ptr % 16 == 0 && res_ptr % 16 == 0 && wt_ptr % 16 == 0;\n-  if (ptrs_are_aligned && hidden_size % 8 == 0) {\n+  if (ptrs_are_aligned && hidden_size % 8 == 0 && input_stride % 8 == 0) {\n     LAUNCH_FUSED_ADD_RMS_NORM(8);\n   } else {\n     LAUNCH_FUSED_ADD_RMS_NORM(0);\ndiff --git a/csrc/quantization/fp8/common.cu b/csrc/quantization/fp8/common.cu\nindex f3f9f669e..0e1eab66f 100644\n--- a/csrc/quantization/fp8/common.cu\n+++ b/csrc/quantization/fp8/common.cu\n@@ -88,6 +88,8 @@ void static_scaled_fp8_quant(torch::Tensor& out,          // [..., d]\n                              torch::Tensor const& input,  // [..., d]\n                              torch::Tensor const& scale)  // [1]\n {\n+  TORCH_CHECK(input.is_contiguous());\n+  TORCH_CHECK(out.is_contiguous());\n   int const block_size = 256;\n   int const num_tokens = input.numel() / input.size(-1);\n   int const num_elems = input.numel();\n@@ -111,6 +113,8 @@ void dynamic_scaled_fp8_quant(torch::Tensor& out,          // [..., d]\n                               torch::Tensor const& input,  // [..., d]\n                               torch::Tensor& scale)        // [1]\n {\n+  TORCH_CHECK(input.is_contiguous());\n+  TORCH_CHECK(out.is_contiguous());\n   int const block_size = 256;\n   int const num_tokens = input.numel() / input.size(-1);\n   int const num_elems = input.numel();\ndiff --git a/tests/kernels/core/test_layernorm.py b/tests/kernels/core/test_layernorm.py\nindex 3eac06273..02316ceaa 100644\n--- a/tests/kernels/core/test_layernorm.py\n+++ b/tests/kernels/core/test_layernorm.py\n@@ -26,6 +26,7 @@ CUDA_DEVICES = [\n @pytest.mark.parametrize(\"dtype\", DTYPES)\n @pytest.mark.parametrize(\"seed\", SEEDS)\n @pytest.mark.parametrize(\"device\", CUDA_DEVICES)\n+@pytest.mark.parametrize(\"strided_input\", [False, True])\n @torch.inference_mode()\n def test_rms_norm(\n     num_tokens: int,\n@@ -34,13 +35,17 @@ def test_rms_norm(\n     dtype: torch.dtype,\n     seed: int,\n     device: str,\n+    strided_input: bool,\n ) -> None:\n     current_platform.seed_everything(seed)\n     torch.set_default_device(device)\n     layer = RMSNorm(hidden_size).to(dtype=dtype)\n     layer.weight.data.normal_(mean=1.0, std=0.1)\n     scale = 1 / (2 * hidden_size)\n-    x = torch.randn(num_tokens, hidden_size, dtype=dtype)\n+    last_dim = 2 * hidden_size if strided_input else hidden_size\n+    x = torch.randn(num_tokens, last_dim, dtype=dtype)\n+    x = x[..., :hidden_size]\n+    assert x.is_contiguous() != strided_input\n     x *= scale\n     residual = torch.randn_like(x) * scale if add_residual else None\n \n@@ -72,6 +77,7 @@ def test_rms_norm(\n @pytest.mark.parametrize(\"quant_scale\", [1.0, 0.01, 10.0])\n @pytest.mark.parametrize(\"seed\", SEEDS)\n @pytest.mark.parametrize(\"device\", CUDA_DEVICES)\n+@pytest.mark.parametrize(\"strided_input\", [False, True])\n def test_fused_rms_norm_quant(\n     num_tokens: int,\n     hidden_size: int,\n@@ -80,13 +86,18 @@ def test_fused_rms_norm_quant(\n     quant_scale: float,\n     seed: int,\n     device: str,\n+    strided_input: bool,\n ) -> None:\n     current_platform.seed_everything(seed)\n     torch.set_default_device(device)\n \n     weight = torch.empty(hidden_size, dtype=dtype).normal_(mean=1.0, std=0.1)\n     scale = 1 / (2 * hidden_size)\n-    x = torch.randn(num_tokens, hidden_size, dtype=dtype)\n+    last_dim = 2 * hidden_size if strided_input else hidden_size\n+    x_base = torch.randn(num_tokens, last_dim, dtype=dtype)\n+    x = x_base[..., :hidden_size]\n+    assert x.is_contiguous() != strided_input\n+\n     x *= scale\n     if add_residual:\n         residual = torch.randn_like(x) * scale\n@@ -106,9 +117,11 @@ def test_fused_rms_norm_quant(\n \n         # Unfused kernel is in-place so it goes second\n         # Also use a separate clone of x to avoid modifying the input\n-        x_unfused = x.clone()\n+        x_unfused_base = x_base.clone()\n+        x_unfused = x_unfused_base[..., :hidden_size]\n+        assert x_unfused.is_contiguous() != strided_input\n         torch.ops._C.fused_add_rms_norm(x_unfused, residual, weight, 1e-6)\n-        torch.ops._C.static_scaled_fp8_quant(out_quant, x_unfused,\n+        torch.ops._C.static_scaled_fp8_quant(out_quant, x_unfused.contiguous(),\n                                              quant_scale_t)\n \n         torch.cuda.synchronize()\n@@ -116,7 +129,6 @@ def test_fused_rms_norm_quant(\n                                    residual,\n                                    atol=1e-2,\n                                    rtol=1e-2)\n-\n         opcheck(\n             torch.ops._C.fused_add_rms_norm_static_fp8_quant,\n             (out_quant_fused, x, residual_fused, weight, quant_scale_t, 1e-6))\n@@ -131,7 +143,7 @@ def test_fused_rms_norm_quant(\n         opcheck(torch.ops._C.rms_norm_static_fp8_quant,\n                 (out_quant_fused, x, weight, quant_scale_t, 1e-6))\n \n-    torch.testing.assert_close(out_quant_fused.to(dtype=torch.float32),\n-                               out_quant.to(dtype=torch.float32),\n+    torch.testing.assert_close(out_quant.to(dtype=torch.float32),\n+                               out_quant_fused.to(dtype=torch.float32),\n                                atol=1e-3,\n                                rtol=1e-3)\ndiff --git a/vllm/model_executor/layers/linear.py b/vllm/model_executor/layers/linear.py\nindex 366dfd97d..bb81a663d 100644\n--- a/vllm/model_executor/layers/linear.py\n+++ b/vllm/model_executor/layers/linear.py\n@@ -259,6 +259,8 @@ class LinearBase(torch.nn.Module):\n         if params_dtype is None:\n             params_dtype = torch.get_default_dtype()\n         self.params_dtype = params_dtype\n+        self.quant_config = quant_config\n+        self.prefix = prefix\n         if quant_config is None:\n             self.quant_method: Optional[\n                 QuantizeMethodBase] = UnquantizedLinearMethod()\n@@ -300,6 +302,12 @@ class ReplicatedLinear(LinearBase):\n         *,\n         return_bias: bool = True,\n     ):\n+        # If MergedReplicatedLinear, use output size of each partition.\n+        if hasattr(self, \"output_sizes\"):\n+            self.output_partition_sizes = self.output_sizes\n+        else:\n+            self.output_partition_sizes = [output_size]\n+\n         super().__init__(input_size,\n                          output_size,\n                          skip_bias_add,\n@@ -311,7 +319,8 @@ class ReplicatedLinear(LinearBase):\n         # All the linear layer supports quant method.\n         assert self.quant_method is not None\n         self.quant_method.create_weights(self,\n-                                         self.input_size, [self.output_size],\n+                                         self.input_size,\n+                                         self.output_partition_sizes,\n                                          self.input_size,\n                                          self.output_size,\n                                          self.params_dtype,\n@@ -367,6 +376,73 @@ class ReplicatedLinear(LinearBase):\n         return s\n \n \n+class MergedReplicatedLinear(ReplicatedLinear):\n+    \"\"\"Replicated linear layer.\n+\n+    Args:\n+        input_size: input dimension of the linear layer.\n+        output_size: output dimension of the linear layer.\n+        bias: If true, add bias.\n+        skip_bias_add: If true, skip adding bias but instead return it.\n+        params_dtype: Data type for the parameters.\n+        quant_config: Quantization configure.\n+        prefix: The name of the layer in the state dict, including all parents\n+                        (e.g. model.layers.0.qkv_proj)\n+    \"\"\"\n+\n+    def __init__(\n+        self,\n+        input_size: int,\n+        output_sizes: list[int],\n+        bias: bool = True,\n+        skip_bias_add: bool = False,\n+        params_dtype: Optional[torch.dtype] = None,\n+        quant_config: Optional[QuantizationConfig] = None,\n+        prefix: str = \"\",\n+        *,\n+        return_bias: bool = True,\n+    ):\n+        self.output_sizes = output_sizes\n+        super().__init__(input_size,\n+                         sum(output_sizes),\n+                         bias,\n+                         skip_bias_add,\n+                         params_dtype,\n+                         quant_config,\n+                         prefix=prefix,\n+                         return_bias=return_bias)\n+\n+    def weight_loader(self,\n+                      param: Union[Parameter, BasevLLMParameter],\n+                      loaded_weight: torch.Tensor,\n+                      loaded_shard_id: Optional[int] = None):\n+        assert loaded_shard_id is not None\n+        assert loaded_shard_id < len(self.output_sizes)\n+\n+        if isinstance(param, BlockQuantScaleParameter):\n+            from vllm.model_executor.layers.quantization.fp8 import (\n+                Fp8LinearMethod, Fp8MoEMethod)\n+            assert self.quant_method is not None\n+            assert isinstance(self.quant_method,\n+                              (Fp8LinearMethod, Fp8MoEMethod))\n+            weight_block_size = self.quant_method.quant_config.weight_block_size\n+            assert weight_block_size is not None\n+            block_n, _ = weight_block_size[0], weight_block_size[1]\n+            shard_offset = (\n+                (sum(self.output_sizes[:loaded_shard_id]) + block_n - 1) //\n+                block_n)\n+            shard_size = ((self.output_sizes[loaded_shard_id] + block_n - 1) //\n+                          block_n)\n+        elif isinstance(param, PerTensorScaleParameter):\n+            shard_offset = loaded_shard_id\n+            shard_size = 1\n+        else:\n+            shard_offset = sum(self.output_sizes[:loaded_shard_id])\n+            shard_size = self.output_sizes[loaded_shard_id]\n+\n+        param[shard_offset:shard_offset + shard_size] = loaded_weight\n+\n+\n class ColumnParallelLinear(LinearBase):\n     \"\"\"Linear layer with column parallelism.\n \ndiff --git a/vllm/model_executor/layers/quantization/fp8.py b/vllm/model_executor/layers/quantization/fp8.py\nindex 35d7545d8..75f8adf34 100644\n--- a/vllm/model_executor/layers/quantization/fp8.py\n+++ b/vllm/model_executor/layers/quantization/fp8.py\n@@ -257,9 +257,16 @@ class Fp8LinearMethod(LinearMethodBase):\n                     f\"{input_size_per_partition} is not divisible by \"\n                     f\"weight quantization block_k = {block_k}.\")\n             # Required by column parallel or enabling merged weights\n-            if (tp_size > 1 and output_size // output_size_per_partition\n-                    == tp_size) or len(output_partition_sizes) > 1:\n-                for output_partition_size in output_partition_sizes:\n+            is_tp_split = (tp_size > 1 and\n+                           output_size // output_size_per_partition == tp_size)\n+            is_merged_gemm = len(output_partition_sizes) > 1\n+            if is_tp_split or is_merged_gemm:\n+                sizes_to_check = output_partition_sizes\n+                if not is_tp_split and is_merged_gemm:\n+                    # In case of merged matrices, we allow the last\n+                    # matrix to not be a multiple of block size\n+                    sizes_to_check = output_partition_sizes[:-1]\n+                for output_partition_size in sizes_to_check:\n                     if output_partition_size % block_n != 0:\n                         raise ValueError(\n                             f\"Weight output_partition_size = \"\ndiff --git a/vllm/model_executor/models/deepseek_v2.py b/vllm/model_executor/models/deepseek_v2.py\nindex 5106b9914..649109777 100644\n--- a/vllm/model_executor/models/deepseek_v2.py\n+++ b/vllm/model_executor/models/deepseek_v2.py\n@@ -42,6 +42,7 @@ from vllm.model_executor.layers.fused_moe import FusedMoE\n from vllm.model_executor.layers.layernorm import RMSNorm\n from vllm.model_executor.layers.linear import (ColumnParallelLinear,\n                                                MergedColumnParallelLinear,\n+                                               MergedReplicatedLinear,\n                                                ReplicatedLinear,\n                                                RowParallelLinear)\n from vllm.model_executor.layers.logits_processor import LogitsProcessor\n@@ -336,7 +337,7 @@ class DeepseekV2Attention(nn.Module):\n         kv_a, _ = latent_cache.split(\n             [self.kv_lora_rank, self.qk_rope_head_dim], dim=-1)\n         latent_cache = latent_cache.unsqueeze(1)\n-        kv_a = self.kv_a_layernorm(kv_a.contiguous())\n+        kv_a = self.kv_a_layernorm(kv_a)\n         kv = self.kv_b_proj(kv_a)[0]\n         kv = kv.view(-1, self.num_local_heads,\n                      self.qk_nope_head_dim + self.v_head_dim)\n@@ -407,14 +408,24 @@ class DeepseekV2MLAAttention(nn.Module):\n         self.max_position_embeddings = max_position_embeddings\n \n         if self.q_lora_rank is not None:\n-            self.q_a_proj = ReplicatedLinear(self.hidden_size,\n-                                             self.q_lora_rank,\n-                                             bias=False,\n-                                             quant_config=quant_config,\n-                                             prefix=f\"{prefix}.q_a_proj\")\n+            self.fused_qkv_a_proj = MergedReplicatedLinear(\n+                self.hidden_size,\n+                [self.q_lora_rank, self.kv_lora_rank + self.qk_rope_head_dim],\n+                bias=False,\n+                quant_config=quant_config,\n+                prefix=f\"{prefix}.fused_qkv_a_proj\")\n+        else:\n+            self.kv_a_proj_with_mqa = ReplicatedLinear(\n+                self.hidden_size,\n+                self.kv_lora_rank + self.qk_rope_head_dim,\n+                bias=False,\n+                quant_config=quant_config,\n+                prefix=f\"{prefix}.kv_a_proj_with_mqa\")\n+\n+        if self.q_lora_rank is not None:\n             self.q_a_layernorm = RMSNorm(self.q_lora_rank,\n                                          eps=config.rms_norm_eps)\n-            self.q_b_proj = ColumnParallelLinear(q_lora_rank,\n+            self.q_b_proj = ColumnParallelLinear(self.q_lora_rank,\n                                                  self.num_heads *\n                                                  self.qk_head_dim,\n                                                  bias=False,\n@@ -427,13 +438,6 @@ class DeepseekV2MLAAttention(nn.Module):\n                                                bias=False,\n                                                quant_config=quant_config,\n                                                prefix=f\"{prefix}.q_proj\")\n-\n-        self.kv_a_proj_with_mqa = ReplicatedLinear(\n-            self.hidden_size,\n-            self.kv_lora_rank + self.qk_rope_head_dim,\n-            bias=False,\n-            quant_config=quant_config,\n-            prefix=f\"{prefix}.kv_a_proj_with_mqa\")\n         self.kv_a_layernorm = RMSNorm(self.kv_lora_rank,\n                                       eps=config.rms_norm_eps)\n         self.kv_b_proj = ColumnParallelLinear(\n@@ -495,15 +499,24 @@ class DeepseekV2MLAAttention(nn.Module):\n         positions: torch.Tensor,\n         hidden_states: torch.Tensor,\n     ) -> torch.Tensor:\n+        q_c = None\n+        kv_lora = None\n+\n         if self.q_lora_rank is not None:\n-            q_c = self.q_a_proj(hidden_states)[0]\n+            qkv_lora = self.fused_qkv_a_proj(hidden_states)[0]\n+            q_c, kv_lora = qkv_lora.split(\n+                [self.q_lora_rank, self.kv_lora_rank + self.qk_rope_head_dim],\n+                dim=-1,\n+            )\n             q_c = self.q_a_layernorm(q_c)\n             q = self.q_b_proj(q_c)[0]\n         else:\n+            kv_lora = self.kv_a_proj_with_mqa(hidden_states)[0]\n             q = self.q_proj(hidden_states)[0]\n-        kv_c, k_pe = self.kv_a_proj_with_mqa(hidden_states)[0].split(\n-            [self.kv_lora_rank, self.qk_rope_head_dim], dim=-1)\n-        kv_c_normed = self.kv_a_layernorm(kv_c.contiguous())\n+\n+        kv_c, k_pe = kv_lora.split([self.kv_lora_rank, self.qk_rope_head_dim],\n+                                   dim=-1)\n+        kv_c_normed = self.kv_a_layernorm(kv_c)\n \n         q = q.view(-1, self.num_local_heads, self.qk_head_dim)\n         # Add head dim of 1 to k_pe\n@@ -837,6 +850,8 @@ class DeepseekV2ForCausalLM(nn.Module, SupportsPP, MixtureOfExperts):\n             # (param_name, shard_name, shard_id)\n             (\"gate_up_proj\", \"gate_proj\", 0),\n             (\"gate_up_proj\", \"up_proj\", 1),\n+            (\"fused_qkv_a_proj\", \"q_a_proj\", 0),\n+            (\"fused_qkv_a_proj\", \"kv_a_proj_with_mqa\", 1),\n         ]\n \n         # Params for weights, fp8 weight scales, fp8 activation scales\n@@ -871,6 +886,12 @@ class DeepseekV2ForCausalLM(nn.Module, SupportsPP, MixtureOfExperts):\n                 if ((\"mlp.experts.\" in name) and name not in params_dict):\n                     continue\n                 name = name.replace(weight_name, param_name)\n+\n+                # QKV fusion is optional, fall back to normal\n+                # weight loading if it's not enabled\n+                if ((param_name == \"fused_qkv_a_proj\")\n+                        and name not in params_dict):\n+                    continue\n                 # Skip loading extra bias for GPTQ models.\n                 if name.endswith(\".bias\") and name not in params_dict:\n                     continue", "apis": ["vllm.model_executor.layers.layernorm.RMSNorm", "vllm.model_executor.layers.linear.MergedReplicatedLinear", "vllm.model_executor.models.deepseek_v2.DeepseekV2ForCausalLM"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/layernorm.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/deepseek_v2.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes non-trivial changes to CUDA kernel code in several source files. It alters how memory strides (input_stride) are used in layer normalization and quantization kernels, modifying indexing and alignment checks to support strided inputs and vectorized memory accesses. These modifications are performance related as they optimize low-level kernel behavior, improve memory access patterns, and are directly involved in the high-level API performance (layernorm/fused norm operations) without being mere refactors, bug fixes, or documentation edits. Although the commit message mentions \"[perf]\" and \"strided layernorm\", these changes go beyond simple renaming (they modify computations and launching parameters) and directly affect CPU-shot execution and testable GPU kernels in a performance optimization context.", "llm_api_reason": "The commit changes several CUDA kernels for RMS normalization and its fused add variant by adding a new input_stride parameter to support nonstandard memory layouts. These backend kernel modifications feed into the Pythonâ€side custom op wrapped in the RMSNorm class. In addition, the fused QKV support has been added in the merged replicated linear layer, with updates to how DeepseekV2â€™s attention modules invoke the fused QKV projection. Tests were also enhanced to exercise both contiguous and strided inputs. Overall, this commit affects the Python API for RMSNorm, the merged replicated linear layer, and the deepseek_v2 model that uses these ops."}
{"commit_hash": "ed25054577f7abca2aee32a5290200c4a1aed561", "pr_url": "https://github.com/vllm-project/vllm/pull/21222", "pr_date": "2025-07-19", "timeline_text": "Copy link Contributor Jialin commented Jul 19, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results (Optional) The necessary documentation update, such as updating supported_models.md and examples for a new model. Purpose Most of the block_pool operators are on critical path forward path is hard blocked by kv block allocation decode cycle end is hard blocked by kv block free In this PR, we're focusing on further optimization these 2 operators. Bulk popleft instead of popleft n times Originally, in block_pool.get_new_blocks, we popped blocks one at a time, which would triggered the second block to fake head connections (which are unnecessary operations as the second block might be popped right after this). As we knew total number of blocks to pop ahead, we could simply introduce popleft_n for buck popleft. Overall, the number link list operations to linked list of popleft_n would only be half of n popleft. Bulk append instead of append n times Similar, in block_pool.free_blocks, we invoke append one at a time. Introducing bulk append would also cut link list operations by half. Test Plan Evaluate with benchmark scripts Evaluate with benchmark_blockpoll New Unit Test for append_n and popleft_n are added Test Result benchmark scripts Get new blocks improved from 0.15ms to 0.008ms Free new blocks improved from 33us to 9us After Before benchmark_blockpool As expected, get_blocks and free_blocks times are cut in half. After Before (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Jialin requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners July 19, 2025 09:39 Copy link github-actions bot commented Jul 19, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author Jialin commented Jul 19, 2025 resolve #21141 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Jul 19, 2025 gemini-code-assist bot reviewed Jul 19, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces popleft_n and append_n methods to FreeKVCacheBlockQueue for bulk operations, optimizing get_new_blocks and free_blocks in BlockPool . Benchmark results show significant improvements. To enhance robustness, I've suggested materializing the ordered_blocks iterable to a list in free_blocks to prevent potential OOM errors. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/core/block_pool.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Jialin mentioned this pull request Jul 18, 2025 [Performance]: Opportunities to speed up BlockPool processing #21141 Open 5 tasks DarkLight1337 requested a review\n  from heheda12345 July 19, 2025 12:19 Jialin force-pushed the blockpool branch\n    from a3253a5 to a3042bd Compare July 20, 2025 10:12 njhill reviewed Jul 20, 2025 View reviewed changes vllm/v1/core/kv_cache_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/core/kv_cache_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/core/block_pool.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/core/block_pool.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Jialin mentioned this pull request Jul 21, 2025 [Core] Minimize number of dict lookup in _maybe_evict_cached_block #21281 Merged 4 tasks njhill reviewed Jul 21, 2025 View reviewed changes vllm/v1/core/kv_cache_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/core/block_pool.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/core/block_pool.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Jialin force-pushed the blockpool branch\n    from 073075f to ca9fca3 Compare July 21, 2025 22:14 houseroad added performance Performance-related issues ready ONLY add when PR is ready to merge/full CI is needed labels Jul 21, 2025 houseroad reviewed Jul 22, 2025 View reviewed changes vllm/v1/core/kv_cache_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . houseroad reviewed Jul 22, 2025 View reviewed changes vllm/v1/core/kv_cache_utils.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . houseroad approved these changes Jul 22, 2025 View reviewed changes Copy link Collaborator houseroad left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good to me. Impressive results, and two nits to consider to address. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 Jialin reacted with heart emoji All reactions â¤ï¸ 1 reaction Jialin added 7 commits July 21, 2025 22:20 Introduce popleft_n and append_n in FreeKVCacheBlockQueue â€¦ 9353288 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Fix free_blocks to correctly iterate ordered_blocks twice â€¦ 7dd32ff Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Materialize iterable instead of using itertools.tee â€¦ d62f3e8 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Address comments â€¦ a7b16ba Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Address comments (further simplify implementation and avoid list iterâ€¦ â€¦ 429e723 â€¦ations)\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Added a TODO to clean up incr_ref and decr_ref â€¦ 3655119 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Address comments â€¦ ad59a94 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Jialin force-pushed the blockpool branch\n    from ca9fca3 to ad59a94 Compare July 22, 2025 05:23 houseroad enabled auto-merge (squash) July 22, 2025 05:23 njhill approved these changes Jul 22, 2025 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks @Jialin ! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details vllm-bot merged commit ed25054 into vllm-project : main Jul 22, 2025 64 of 66 checks passed Uh oh! There was an error while loading. Please reload this page . yeqcharlotte pushed a commit\n        to yeqcharlotte/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 4420ad5 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> zixi-qi pushed a commit\n        to zixi-qi/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 40ab4c4 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: qizixi <qizixi@meta.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ cf5038f â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 40dcc2e â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ e28b77c â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: shuw <shuw@nvidia.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ a1cdc67 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ a7521ad â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 22a3904 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ aedd951 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 231c183 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 5081f27 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 7ad8303 â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ 01377bf â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to fâ€¦ â€¦ b8e251c â€¦urther optimize block_pool ( vllm-project#21222 )\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:11", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: optimization | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:50:11", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to further optimize block_pool (#21222)", "commit_message": "[Core] Introduce popleft_n and append_n in FreeKVCacheBlockQueue to further optimize block_pool (#21222)\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>", "commit_date": "2025-07-22T06:17:47-07:00", "files_changed": ["tests/v1/core/test_kv_cache_utils.py", "vllm/v1/core/block_pool.py", "vllm/v1/core/kv_cache_utils.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 0, "num_files": 3, "num_hunks": 6, "num_edited_lines": 203, "num_non_test_edited_lines": 98, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/core/test_kv_cache_utils.py b/tests/v1/core/test_kv_cache_utils.py\nindex 68b060156..ccdbe79df 100644\n--- a/tests/v1/core/test_kv_cache_utils.py\n+++ b/tests/v1/core/test_kv_cache_utils.py\n@@ -184,6 +184,111 @@ def test_free_kv_cache_block_queue_operations():\n     assert str(e.value) == \"No free blocks available\"\n \n \n+def test_free_kv_cache_block_queue_append_n():\n+    # Create an empty FreeKVCacheBlockQueue with these blocks\n+    queue = FreeKVCacheBlockQueue([])\n+    blocks = [KVCacheBlock(block_id=i) for i in range(6)]\n+    # Append 0 block\n+    # fake_head->fake_tail\n+    queue.append_n([])\n+    assert queue.num_free_blocks == 0\n+    assert (queue.fake_free_list_head.next_free_block\n+            is queue.fake_free_list_tail)\n+    assert (queue.fake_free_list_tail.prev_free_block\n+            is queue.fake_free_list_head)\n+    # Append 1 block\n+    # fake_head->b0->fake_tail\n+    queue.append_n(blocks[0:1])\n+    assert queue.num_free_blocks == 1\n+    assert queue.fake_free_list_head.next_free_block is blocks[0]\n+    assert blocks[0].prev_free_block is queue.fake_free_list_head\n+    assert blocks[0].next_free_block is queue.fake_free_list_tail\n+    assert queue.fake_free_list_tail.prev_free_block is blocks[0]\n+    # Append 2 blocks\n+    # fake_head->b0->b4->b5->fake_tail\n+    queue.append_n(blocks[4:6])\n+    assert queue.num_free_blocks == 3\n+    assert queue.fake_free_list_head.next_free_block is blocks[0]\n+    assert blocks[0].prev_free_block is queue.fake_free_list_head\n+    assert blocks[0].next_free_block is blocks[4]\n+    assert blocks[4].prev_free_block is blocks[0]\n+    assert blocks[4].next_free_block is blocks[5]\n+    assert blocks[5].prev_free_block is blocks[4]\n+    assert blocks[5].next_free_block is queue.fake_free_list_tail\n+    assert queue.fake_free_list_tail.prev_free_block is blocks[5]\n+    # Append 3 blocks\n+    # fake_head->b0->b4->b5->b1->b2->b3->fake_tail\n+    queue.append_n(blocks[1:4])\n+    assert queue.num_free_blocks == 6\n+    assert queue.fake_free_list_head.next_free_block is blocks[0]\n+    assert blocks[0].prev_free_block is queue.fake_free_list_head\n+    assert blocks[0].next_free_block is blocks[4]\n+    assert blocks[4].prev_free_block is blocks[0]\n+    assert blocks[4].next_free_block is blocks[5]\n+    assert blocks[5].prev_free_block is blocks[4]\n+    assert blocks[5].next_free_block is blocks[1]\n+    assert blocks[1].prev_free_block is blocks[5]\n+    assert blocks[1].next_free_block is blocks[2]\n+    assert blocks[2].prev_free_block is blocks[1]\n+    assert blocks[2].next_free_block is blocks[3]\n+    assert blocks[3].prev_free_block is blocks[2]\n+    assert blocks[3].next_free_block is queue.fake_free_list_tail\n+    assert queue.fake_free_list_tail.prev_free_block is blocks[3]\n+\n+\n+def test_free_kv_cache_block_queue_popleft_n():\n+    blocks = [KVCacheBlock(block_id=i) for i in range(6)]\n+    # Create a empty FreeKVCacheBlockQueue with these blocks\n+    queue = FreeKVCacheBlockQueue(\n+        [blocks[1], blocks[3], blocks[5], blocks[4], blocks[0], blocks[2]])\n+    assert queue.num_free_blocks == 6\n+    assert queue.fake_free_list_head.next_free_block is blocks[1]\n+    assert blocks[1].prev_free_block is queue.fake_free_list_head\n+    assert blocks[1].next_free_block is blocks[3]\n+    assert blocks[3].prev_free_block is blocks[1]\n+    assert blocks[3].next_free_block is blocks[5]\n+    assert blocks[5].prev_free_block is blocks[3]\n+    assert blocks[5].next_free_block is blocks[4]\n+    assert blocks[4].prev_free_block is blocks[5]\n+    assert blocks[4].next_free_block is blocks[0]\n+    assert blocks[0].prev_free_block is blocks[4]\n+    assert blocks[0].next_free_block is blocks[2]\n+    assert blocks[2].prev_free_block is blocks[0]\n+    assert blocks[2].next_free_block is queue.fake_free_list_tail\n+    assert queue.fake_free_list_tail.prev_free_block is blocks[2]\n+\n+    # Pop 0 block\n+    # fake_head->b1->b3->b5->b4->b0->b2->fake_tail\n+    assert len(queue.popleft_n(0)) == 0\n+    # Pop 1 block\n+    # fake_head->b3->b5->b4->b0->b2->fake_tail\n+    result_blocks = queue.popleft_n(1)\n+    assert len(result_blocks) == 1\n+    assert result_blocks[0] is blocks[1]\n+    for block in result_blocks:\n+        assert block.prev_free_block is None\n+        assert block.next_free_block is None\n+    # Pop 2 blocks\n+    # fake_head->b4->b0->b2->fake_tail\n+    result_blocks = queue.popleft_n(2)\n+    assert len(result_blocks) == 2\n+    assert result_blocks[0] is blocks[3]\n+    assert result_blocks[1] is blocks[5]\n+    for block in result_blocks:\n+        assert block.prev_free_block is None\n+        assert block.next_free_block is None\n+    # Pop 3 blocks\n+    # fake_head->fake_tail\n+    result_blocks = queue.popleft_n(3)\n+    assert len(result_blocks) == 3\n+    assert result_blocks[0] is blocks[4]\n+    assert result_blocks[1] is blocks[0]\n+    assert result_blocks[2] is blocks[2]\n+    for block in result_blocks:\n+        assert block.prev_free_block is None\n+        assert block.next_free_block is None\n+\n+\n def test_free_kv_cache_block_queue_get_all_free_blocks():\n     # Create a list of KVCacheBlock objects\n     blocks = [KVCacheBlock(block_id=i) for i in range(5)]\ndiff --git a/vllm/v1/core/block_pool.py b/vllm/v1/core/block_pool.py\nindex cbb6bb268..5bf4d3a2a 100644\n--- a/vllm/v1/core/block_pool.py\n+++ b/vllm/v1/core/block_pool.py\n@@ -214,21 +214,18 @@ class BlockPool:\n             raise ValueError(\n                 f\"Cannot get {num_blocks} free blocks from the pool\")\n \n-        ret: list[KVCacheBlock] = []\n-        idx = 0\n-        while idx < num_blocks:\n-            # First allocate blocks.\n-            curr_block = self.free_block_queue.popleft()\n-            assert curr_block.ref_cnt == 0\n-\n-            # If the block is cached, evict it.\n-            if self.enable_caching:\n-                self._maybe_evict_cached_block(curr_block)\n-\n-            curr_block.incr_ref()\n-            ret.append(curr_block)\n-            idx += 1\n-\n+        ret: list[KVCacheBlock] = self.free_block_queue.popleft_n(num_blocks)\n+\n+        # In order to only iterate the list once, we duplicated code a bit\n+        if self.enable_caching:\n+            for block in ret:\n+                self._maybe_evict_cached_block(block)\n+                assert block.ref_cnt == 0\n+                block.ref_cnt += 1\n+        else:\n+            for block in ret:\n+                assert block.ref_cnt == 0\n+                block.ref_cnt += 1\n         return ret\n \n     def _maybe_evict_cached_block(self, block: KVCacheBlock) -> bool:\n@@ -289,11 +286,14 @@ class BlockPool:\n             ordered_blocks: A list of blocks to free ordered by their eviction\n                 priority.\n         \"\"\"\n-        for block in ordered_blocks:\n-            block.decr_ref()\n-            # null_block should not be added to the free list.\n-            if block.ref_cnt == 0 and not block.is_null:\n-                self.free_block_queue.append(block)\n+        # Materialize the iterable to allow multiple passes.\n+        blocks_list = list(ordered_blocks)\n+        for block in blocks_list:\n+            block.ref_cnt -= 1\n+        self.free_block_queue.append_n([\n+            block for block in blocks_list\n+            if block.ref_cnt == 0 and not block.is_null\n+        ])\n \n     def reset_prefix_cache(self) -> bool:\n         \"\"\"Reset prefix cache. This function may be used in RLHF\ndiff --git a/vllm/v1/core/kv_cache_utils.py b/vllm/v1/core/kv_cache_utils.py\nindex 457d95cc7..198d79cfb 100644\n--- a/vllm/v1/core/kv_cache_utils.py\n+++ b/vllm/v1/core/kv_cache_utils.py\n@@ -154,6 +154,8 @@ class KVCacheBlock:\n     # Whether the block is a null block that should never be cached.\n     is_null: bool = False\n \n+    # TODO(Jialin): For performance, let callers handle ref_cnt bumps to\n+    # avoid function calls.\n     def incr_ref(self):\n         self.ref_cnt += 1\n \n@@ -273,6 +275,39 @@ class FreeKVCacheBlockQueue:\n         self.num_free_blocks -= 1\n         return first_block\n \n+    def popleft_n(self, n: int) -> list[KVCacheBlock]:\n+        \"\"\"Pop the first n free blocks and reduce num_free_blocks by n.\n+\n+        Args:\n+            n: The number of blocks to pop.\n+\n+        Returns:\n+            A list of n free blocks.\n+        \"\"\"\n+        if n == 0:\n+            return []\n+        assert self.num_free_blocks >= n\n+        self.num_free_blocks -= n\n+\n+        curr_block = self.fake_free_list_head.next_free_block\n+        # Pop n blocks from the head of the list\n+        ret = []\n+        for _ in range(n):\n+            assert curr_block is not None\n+            ret.append(curr_block)\n+            last_block = curr_block\n+            curr_block = curr_block.next_free_block\n+            # Reset prev_free_block and next_free_block of all popped blocks\n+            last_block.prev_free_block = None\n+            last_block.next_free_block = None\n+\n+        if curr_block is not None:\n+            # The queue is not empty, connect the fake head to\n+            # the new first block.\n+            self.fake_free_list_head.next_free_block = curr_block\n+            curr_block.prev_free_block = self.fake_free_list_head\n+        return ret\n+\n     def remove(self, block: KVCacheBlock) -> None:\n         \"\"\"Remove a block in the free list and reduce num_free_blocks by 1.\n \n@@ -315,6 +350,29 @@ class FreeKVCacheBlockQueue:\n \n         self.num_free_blocks += 1\n \n+    def append_n(self, blocks: list[KVCacheBlock]) -> None:\n+        \"\"\"Put a list of blocks back into the free list\n+\n+        Args:\n+            blocks: The blocks to append.\n+        \"\"\"\n+        if len(blocks) == 0:\n+            return\n+        self.num_free_blocks += len(blocks)\n+\n+        last_block = self.fake_free_list_tail.prev_free_block\n+        assert last_block is not None, (\n+            \"prev_free_block of fake_free_list_tail should always exist\")\n+        # Add inter-connections between consecutive blocks\n+        for block in blocks:\n+            block.prev_free_block = last_block\n+            last_block.next_free_block = block\n+            last_block = block\n+\n+        # Connect the last block of <blocks> to the fake tail\n+        last_block.next_free_block = self.fake_free_list_tail\n+        self.fake_free_list_tail.prev_free_block = last_block\n+\n     def get_all_free_blocks(self) -> list[KVCacheBlock]:\n         \"\"\"Get all free blocks in the free list. Mainly used for testing.", "apis": ["FreeKVCacheBlockQueue.popleft_n", "FreeKVCacheBlockQueue.append_n", "BlockPool.get_new_blocks", "BlockPool.free_blocks"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/kv_cache_utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/block_pool.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The changes modify core files (block_pool.py and kv_cache_utils.py), not just test files, and introduce new methods (popleft_n and append_n) that batch process blocks. These are non-trivial modifications aimed at reducing iteration overhead and improving the efficiency of block management in the cache, indicating a performance optimization. The commit message and the nature of changes confirm this is a performance-related change.", "llm_api_reason": "The commit adds tests for the newly introduced popleft_n and append_n methods in the FreeKVCacheBlockQueue class and updates the BlockPool methods to use these new APIs for bulk block allocation and free operations. Additionally, the implementation of get_new_blocks and free_blocks in BlockPool now leverages these optimized methods. Overall, the changes aim at better performance by reducing per-block Python function call overhead."}
{"commit_hash": "a32237665df876fcb51196dc209e8aff9fd89d29", "pr_url": "https://github.com/vllm-project/vllm/pull/21245", "pr_date": "2025-07-20", "timeline_text": "Copy link Contributor Jialin commented Jul 20, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results (Optional) The necessary documentation update, such as updating supported_models.md and examples for a new model. Purpose Fix update checks in MinTokensLogitsProcessor and LogitBiasLogitsProcessor. For a benchmark run without override min length or logit bias, we still see noticeable cost coming from MinTokensLogitsProcessor and LogitBiasLogitsProcessor. We found that it's due to inefficient needs_update tagging which would be tagged to True whenever there're new requests added to the batch. In this diff, we would tag needs_update to True, if new added request had customized min_token config a request with min_token config got popped Test Plan Rerun the benchmark. # vLLM Serving\nexport VLLM_USE_MODELSCOPE=False;\nexport VLLM_TORCH_PROFILER_DIR=~/vllm_profile; # for profiling\nvllm serve facebook/opt-125m \\\n    --swap-space 16 \\\n    --disable-log-requests \\\n    --host :: \\\n    --dtype float16\n\n# Capture traces\nvllm bench serve \\\n    --dataset-name random \\\n    --model facebook/opt-125m \\\n    --served-model-name facebook/opt-125m \\\n    --random-input-len 700 \\\n    --random-output-len 1 \\\n    --endpoint /v1/completions \\\n    --ignore-eos \\\n    --host localhost \\\n    --port 8000 \\\n    --request-rate 200 \\\n    --num-prompts 100 Test Result Confirmed the cost from MinTokensLogitsProcessor and LogitBiasLogitsProcessor is mostly gone. After Before (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 yeqcharlotte reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Jialin requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners July 20, 2025 09:15 Copy link github-actions bot commented Jul 20, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Jul 20, 2025 gemini-code-assist bot reviewed Jul 20, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request optimizes update checks in MinTokensLogitsProcessor . I've added a suggestion to improve the maintainability of the new logic by making it more explicit and avoiding a side effect in a conditional statement. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/sample/logits_processor.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Jialin changed the title [Core] Optimize update checks in MinTokensLogitsProcessor [Core] Optimize update checks in LogitsProcessor Jul 20, 2025 Jialin force-pushed the min_token branch\n    from 9f1d4fd to b300005 Compare July 20, 2025 10:18 Copy link Member njhill commented Jul 20, 2025 Thanks @Jialin . I think I had similar logic in the my original impl of these LPs here https://github.com/vllm-project/vllm/pull/13360/files#diff-d01f143e1af472f24af24842cb879907ce624e6e5c977935e944545240723529R51 and hadn't realized that had been changed. cc @afeldman-nm â¤ï¸ 1 Jialin reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . houseroad approved these changes Jul 21, 2025 View reviewed changes Copy link Collaborator houseroad left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good to me. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/sample/logits_processor.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . houseroad added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 21, 2025 Jialin force-pushed the min_token branch\n    from b300005 to 5142da8 Compare July 21, 2025 22:03 houseroad added\n  the performance Performance-related issues label Jul 21, 2025 houseroad enabled auto-merge (squash) July 21, 2025 22:08 Jialin added 2 commits July 21, 2025 22:24 Optimize update checks in MinTokensLogitsProcessor â€¦ d0baa38 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Apply updates to LogitBiasLogitsProcessor as well â€¦ b3026ed Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> auto-merge was automatically disabled July 22, 2025 05:25 Head branch was pushed to by a user without write access Jialin force-pushed the min_token branch\n    from 5142da8 to b3026ed Compare July 22, 2025 05:25 Hide details View details vllm-bot merged commit a322376 into vllm-project : main Jul 22, 2025 63 of 65 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Contributor afeldman-nm commented Jul 22, 2025 Thanks @Jialin ! I think this was probably my bad so thanks for the fix â¤ï¸ 1 Jialin reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author Jialin commented Jul 22, 2025 Thanks @Jialin ! I think this was probably my bad so thanks for the fix No worry :) All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . yeqcharlotte pushed a commit\n        to yeqcharlotte/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ f96ca50 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> zixi-qi pushed a commit\n        to zixi-qi/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 25d0c72 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: qizixi <qizixi@meta.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ f9839e4 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ b5ee4f7 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 1e52328 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: shuw <shuw@nvidia.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ daab1aa Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ b6c32b5 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 87908a8 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ fad4dd9 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 97ee62f Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 0ca234a Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 2ffbc24 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 34bfe4b Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Core] Optimize update checks in LogitsProcessor ( vllm-project#21245 ) â€¦ 9405819 Signed-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:16", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: benchmark run without override min length or logit bias, we still see noticeable cost coming from MinTokensLogitsProcessor and LogitBiasLogitsProcessor. We found that it's due to inefficient needs_update tagging which would be tagged to True whenever there're new requests added to the batch. In this diff, we would tag needs_update to True, if new added request had customized min_token config a request with min_token config got popped Test Plan Rerun the benchmark. # vLLM Serving, profiling | SERVING: vllm serve, Serving, serve | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:50:16", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "vllm bench serve --dataset-name random --model facebook/opt-125m --served-model-name facebook/opt-125m --random-input-len 700 --random-output-len 1 --endpoint /v1/completions --ignore-eos --host localhost --port 8000 --request-rate 200 --num-prompts 100", "commit_subject": "[Core] Optimize update checks in LogitsProcessor (#21245)", "commit_message": "[Core] Optimize update checks in LogitsProcessor (#21245)\n\nSigned-off-by: Jialin Ouyang <Jialin.Ouyang@gmail.com>", "commit_date": "2025-07-22T05:27:18-07:00", "files_changed": ["vllm/v1/sample/logits_processor.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 18, "num_non_test_edited_lines": 18, "commit_year": 2025}, "diff_text": "diff --git a/vllm/v1/sample/logits_processor.py b/vllm/v1/sample/logits_processor.py\nindex 3a4c25964..3a06e7105 100644\n--- a/vllm/v1/sample/logits_processor.py\n+++ b/vllm/v1/sample/logits_processor.py\n@@ -335,14 +335,19 @@ class LogitBiasLogitsProcessor(LogitsProcessor):\n         if not batch_update:\n             return\n \n+        needs_update: bool = False\n         # Process added requests.\n-        needs_update = bool(batch_update.added)\n         for index, params, _ in batch_update.added:\n             if isinstance(params, SamplingParams) and (lb :=\n                                                        params.logit_bias):\n                 self.biases[index] = lb\n+                needs_update = True\n             else:\n-                self.biases.pop(index, None)\n+                # Drop biases metadata at batch index\n+                if self.biases.pop(index, None) is not None:\n+                    # If a new request replaces an old request which\n+                    # specified biases, we should update processor tensors\n+                    needs_update = True\n \n         if self.biases:\n             # Process removed requests.\n@@ -419,7 +424,6 @@ class MinTokensLogitsProcessor(LogitsProcessor):\n \n         if batch_update:\n             # Process added requests.\n-            needs_update |= bool(batch_update.added)\n             for index, params, output_tok_ids in batch_update.added:\n                 if (isinstance(params, SamplingParams)\n                         and (min_tokens := params.min_tokens)\n@@ -427,9 +431,13 @@ class MinTokensLogitsProcessor(LogitsProcessor):\n                     # Replace request metadata at batch index\n                     self.min_toks[index] = (min_tokens, output_tok_ids,\n                                             params.all_stop_token_ids)\n+                    needs_update = True\n                 else:\n-                    # Drop request metadata at batch index\n-                    self.min_toks.pop(index, None)\n+                    # Drop min_toks metadata at batch index\n+                    if self.min_toks.pop(index, None) is not None:\n+                        # If a new request replaces an old request which\n+                        # specified min_toks, we should update processor tensors\n+                        needs_update = True\n \n             if self.min_toks:\n                 # Process removed requests.", "apis": ["LogitBiasLogitsProcessor.update_state", "MinTokensLogitsProcessor.update_state"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/logits_processor.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/logits_processor.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/logits_processors.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file in core components (LogitsProcessor and MinTokensLogitsProcessor) and changes the update-check logic. Instead of simply checking the truthiness of batch updates, it introduces a more precise tracking variable (\"needs_update\") to only update processor tensors when necessary. This is intended to optimize performance by avoiding unnecessary updates. The changes are non-trivial, affect internal API performance, and are focused on CPU execution. Thus, it meets the conditions for being performance/optimization related. [ANSWER] YES [/ANSWER]", "llm_api_reason": "The commit optimizes the update checks within the update_state method implementations of two logits processor classes. In LogitBiasLogitsProcessor, the update_state method is modified to set a flag (needs_update) when biases are added or when an existing bias is dropped and replaced. Similarly, in MinTokensLogitsProcessor, the update_state method is changed to update the processor's state only when necessary by conditionally setting the update flag when min-token metadata is added or dropped. Both changes affect the behavior of the update_state APIs for these two classes, which are used to manage logits processing during model inference."}
{"commit_hash": "e7b204268132cb775c139574c1ff4ad7e15c8f66", "pr_url": "https://github.com/vllm-project/vllm/pull/21334", "pr_date": "2025-07-22", "timeline_text": "Copy link Contributor minosfuture commented Jul 21, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Purpose This reverts commit 9fb2d22 to fix #21322 Test Plan pytest -v -s tests/models/multimodal/generation/test_maverick.py lm_eval maverick Test Result UT passed lm_eval result: local-chat-completions (model=meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8,base_url= http://127.0.0.1:8000/v1/chat/completions,num_concurrent=32 ), gen_kwargs: (None), limit: 200.0, num_fewshot: 5, batch_size: 1 Tasks Version Filter n-shot Metric Value Stderr gsm8k 3 flexible-extract 5 exact_match â†‘ 0.93 Â± 0.0181 strict-match 5 exact_match â†‘ 0.92 Â± 0.0192 (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 roywei reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 51db38e â€¦UTLASS MoE ( vllm-project#20762 )\"\n\nThis reverts commit 9fb2d22 .\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> minosfuture requested review from tlrmchlsmth , WoosukKwon , mgoin and robertgshaw2-redhat as code owners July 21, 2025 21:30 Copy link github-actions bot commented Jul 21, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the performance Performance-related issues label Jul 21, 2025 gemini-code-assist bot reviewed Jul 21, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request reverts a previous performance improvement to fix a correctness issue. The changes are mostly removing code related to the optimization. However, I've identified a critical issue where the revert breaks CUDA graph compatibility by creating new tensors inside a function that can be captured by a CUDA graph. This will cause benchmarks and potentially other features relying on CUDA graphs to fail. I've provided detailed comments and code suggestions across multiple files to address this by re-introducing the practice of passing stride tensors as arguments, which was the behavior before the original performance-enhancing change. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tests/kernels/moe/test_cutlass_moe.py @@ -207,10 +207,6 @@ def run_8_bit(moe_tensors: MOETensors8Bit, 'topk_ids': topk_ids, 'w1_scale': moe_tensors.w1_scale, 'w2_scale': moe_tensors.w2_scale, Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment To align with the proposed fix for CUDA graph compatibility, the stride tensors need to be passed to cutlass_moe_fp8 for testing. 'w2_scale' : moe_tensors . w2_scale , 'ab_strides1' : moe_tensors . ab_strides1 , 'ab_strides2' : moe_tensors . ab_strides2 , 'c_strides1' : moe_tensors . c_strides1 , 'c_strides2' : moe_tensors . c_strides2 , Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tests/kernels/moe/test_cutlass_moe.py @@ -444,11 +440,6 @@ def test_run_cutlass_moe_fp8( expert_map[start:end] = list(range(num_local_experts)) expert_map = torch.tensor(expert_map, dtype=torch.int32, device=\"cuda\") Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors need to be created for the test to be consistent with the proposed fix for CUDA graph compatibility. expert_map = torch . tensor ( expert_map , dtype = torch . int32 , device = \"cuda\" ) ab_strides1 = torch . full (( e , ), k , device = \"cuda\" , dtype = torch . int64 ) ab_strides2 = torch . full (( e , ), n , device = \"cuda\" , dtype = torch . int64 ) c_strides1 = torch . full (( e , ), 2 * n , device = \"cuda\" , dtype = torch . int64 ) c_strides2 = torch . full (( e , ), k , device = \"cuda\" , dtype = torch . int64 ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tests/kernels/moe/test_cutlass_moe.py Comment on lines +451 to +452 a1q_scale, None, workspace13, workspace2, None, mt.a.dtype, per_act_token, per_out_channel, False) Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors should be passed to run_cutlass_moe_fp8 to align with the proposed fix for CUDA graph compatibility. a1q_scale , None , ab_strides1 , ab_strides2 , c_strides1 , c_strides2 , workspace13 , workspace2 , None , mt . a . dtype , per_act_token , per_out_channel , False ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tests/kernels/moe/test_pplx_cutlass_moe.py Comment on lines 126 to 131 experts = CutlassExpertsFp8(num_local_experts, out_dtype, per_act_token, per_out_ch, ab_strides1, ab_strides2, c_strides1, c_strides2, num_dispatchers=num_dispatchers, use_batched_format=True) Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors need to be created and passed to CutlassExpertsFp8 for the test to be consistent with the proposed fix for CUDA graph compatibility. You'll also need to re-introduce intermediate_dim which was removed in this PR. intermediate_dim = w2 . shape [ 2 ] ab_strides1 = torch . full (( num_local_experts , ), hidden_dim , device = \"cuda\" , dtype = torch . int64 ) ab_strides2 = torch . full (( num_local_experts , ), intermediate_dim , device = \"cuda\" , dtype = torch . int64 ) c_strides1 = torch . full (( num_local_experts , ), 2 * intermediate_dim , device = \"cuda\" , dtype = torch . int64 ) c_strides2 = torch . full (( num_local_experts , ), hidden_dim , device = \"cuda\" , dtype = torch . int64 ) experts = CutlassExpertsFp8 ( num_local_experts , out_dtype , per_act_token , per_out_ch , ab_strides1 , ab_strides2 , c_strides1 , c_strides2 , num_dispatchers = num_dispatchers , use_batched_format = True ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/fused_moe/cutlass_moe.py @@ -34,10 +35,6 @@ def run_cutlass_moe_fp8( w2_scale: Optional[torch.Tensor], a1q_scale: Optional[torch.Tensor], a2_scale: Optional[torch.Tensor], Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment To maintain CUDA graph compatibility, the stride tensors should be passed as arguments instead of being created inside this function. Please add them back to the function signature. Suggested change a2_scale : Optional [ torch . Tensor ], a2_scale : Optional [ torch . Tensor ], ab_strides1 : torch . Tensor , ab_strides2 : torch . Tensor , c_strides1 : torch . Tensor , c_strides2 : torch . Tensor , Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions 4 hidden conversations Load moreâ€¦ vllm/model_executor/layers/fused_moe/cutlass_moe.py @@ -329,10 +332,6 @@ def cutlass_moe_fp8( topk_ids: torch.Tensor, w1_scale: torch.Tensor, w2_scale: torch.Tensor, Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors should be passed as arguments here as well to maintain CUDA graph compatibility. w2_scale : torch . Tensor , ab_strides1 : torch . Tensor , ab_strides2 : torch . Tensor , c_strides1 : torch . Tensor , c_strides2 : torch . Tensor , Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/fused_moe/cutlass_moe.py @@ -403,10 +391,6 @@ def cutlass_moe_fp8( out_dtype=a.dtype, per_act_token_quant=per_act_token, per_out_ch_quant=per_out_ch, Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors should be passed to the CutlassExpertsFp8 constructor. per_out_ch_quant = per_out_ch , ab_strides1 = ab_strides1 , ab_strides2 = ab_strides2 , c_strides1 = c_strides1 , c_strides2 = c_strides2 , Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py @@ -859,21 +859,6 @@ def process_weights_after_loading(self, layer: torch.nn.Module) -> None: layer.w13_weight_scale = torch.nn.Parameter(max_w13_scales, requires_grad=False) Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors should be pre-computed and stored here to be passed to the MoE kernel. This is necessary for CUDA graph compatibility. Suggested change device = layer . w13_weight . device # ab_strides1 and c_strides2 are the same self . ab_strides1_c_strides2 = torch . full (( layer . local_num_experts , ), layer . hidden_size , device = device , dtype = torch . int64 ) self . ab_strides2 = torch . full (( layer . local_num_experts , ), layer . intermediate_size_per_partition , device = device , dtype = torch . int64 ) self . c_strides1 = torch . full (( layer . local_num_experts , ), 2 * layer . intermediate_size_per_partition , device = device , dtype = torch . int64 ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py @@ -896,10 +881,6 @@ def select_gemm_impl( moe.in_dtype, self.input_quant.strategy == QuantizationStrategy.TOKEN, self.weight_quant.strategy == QuantizationStrategy.CHANNEL, Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors should be passed to the CutlassExpertsFp8 constructor. self . weight_quant . strategy == QuantizationStrategy . CHANNEL , ab_strides1 = self . ab_strides1_c_strides2 , ab_strides2 = self . ab_strides2 , c_strides1 = self . c_strides1 , c_strides2 = self . ab_strides1_c_strides2 , Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py @@ -968,10 +948,6 @@ def apply( expert_map=None if self.disable_expert_map else expert_map, w1_scale=layer.w13_weight_scale, w2_scale=layer.w2_weight_scale, Copy link Contributor gemini-code-assist bot Jul 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The stride tensors should be passed to cutlass_moe_fp8 . w2_scale = layer . w2_weight_scale , ab_strides1 = self . ab_strides1_c_strides2 , ab_strides2 = self . ab_strides2 , c_strides1 = self . c_strides1 , c_strides2 = self . ab_strides1_c_strides2 , Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions houseroad approved these changes Jul 21, 2025 View reviewed changes Copy link Collaborator houseroad left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for reverting the original PR to help recover the trunk health. This will unblock our code sync as well. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator houseroad commented Jul 21, 2025 cc: @ElizaWszola , @tlrmchlsmth , @mgoin , @robertgshaw2-redhat this is blocking our internal work, so need to revert for now to unblock. Sorry about the inconvenience, and happy to help on landing the fixed version. Also if forward-fix is easy to land, we are happy to switch to that as well. :-) ðŸ‘ 2 mgoin and minosfuture reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . houseroad enabled auto-merge (squash) July 21, 2025 22:04 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 21, 2025 houseroad added\n  the llama Related to Llama models label Jul 21, 2025 mgoin added this to the v0.10.0 milestone Jul 22, 2025 mgoin approved these changes Jul 22, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Okay let's revert for now. Thanks for identifying this Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 houseroad and ElizaWszola reacted with thumbs up emoji â¤ï¸ 1 minosfuture reacted with heart emoji All reactions ðŸ‘ 2 reactions â¤ï¸ 1 reaction simon-mo disabled auto-merge July 22, 2025 04:48 Hide details View details simon-mo merged commit e7b2042 into vllm-project : main Jul 22, 2025 109 of 111 checks passed Uh oh! There was an error while loading. Please reload this page . minosfuture added a commit\n        to minosfuture/vllm\n      that referenced\n      this pull request Jul 22, 2025 Reapply \"[Performance] Performance improvements in non-blockwise fp8 â€¦ â€¦ 2f39358 â€¦CUTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nThis reverts commit e7b2042 . minosfuture added a commit\n        to minosfuture/vllm\n      that referenced\n      this pull request Jul 23, 2025 Reapply \"[Performance] Performance improvements in non-blockwise fp8 â€¦ â€¦ 291c923 â€¦CUTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nThis reverts commit e7b2042 .\n\nThe original PR vllm-project#20762 is:\n\nAuthored-by: ElizaWszola <ewszola@redhat.com>\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> zixi-qi pushed a commit\n        to zixi-qi/vllm\n      that referenced\n      this pull request Jul 23, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ e780c7d â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>\nSigned-off-by: qizixi <qizixi@meta.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 663b3f1 â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ c24051b â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> wenscarl pushed a commit\n        to wenscarl/vllm\n      that referenced\n      this pull request Aug 4, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 5cf3120 â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>\nSigned-off-by: shuw <shuw@nvidia.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 5418f5a â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 4c1cd4d â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 26384dc â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 45b2eb2 â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 680fa6d â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 19f1d60 â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ a397d4d â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 28, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ c9e26e8 â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 Revert \"[Performance] Performance improvements in non-blockwise fp8 Câ€¦ â€¦ 27299ac â€¦UTLASS MoE ( vllm-project#20762 ) ( vllm-project#21334 )\n\nSigned-off-by: Ming Yang <minos.future@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:20", "has_lm_eval": true, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, gsm8k | PERF: optimization, improvement | TEST: Test, Test, test", "analysis_extracted_at": "2025-09-07 17:50:20", "models": ["01-ai/Yi-1.5-9B-Chat"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=01-ai/Yi-1.5-9B-Chat,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model 01-ai/Yi-1.5-9B-Chat --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "Revert \"[Performance] Performance improvements in non-blockwise fp8 CUTLASS MoE (#20762) (#21334)", "commit_message": "Revert \"[Performance] Performance improvements in non-blockwise fp8 CUTLASS MoE (#20762) (#21334)\n\nSigned-off-by: Ming Yang <minos.future@gmail.com>", "commit_date": "2025-07-21T21:49:01-07:00", "files_changed": ["benchmarks/kernels/benchmark_grouped_gemm_cutlass.py", "csrc/moe/moe_permute_unpermute_op.cu", "tests/kernels/moe/test_cutlass_moe.py", "tests/kernels/moe/test_pplx_cutlass_moe.py", "vllm/model_executor/layers/fused_moe/cutlass_moe.py", "vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py"], "functions_changed": [], "stats": {"num_test_files": 2, "num_non_test_files": 4, "only_test_files": 0, "only_non_test_files": 0, "num_files": 6, "num_hunks": 30, "num_edited_lines": 212, "num_non_test_edited_lines": 176, "commit_year": 2025}, "diff_text": "diff --git a/benchmarks/kernels/benchmark_grouped_gemm_cutlass.py b/benchmarks/kernels/benchmark_grouped_gemm_cutlass.py\nindex a6b42406b..1d4e730f9 100644\n--- a/benchmarks/kernels/benchmark_grouped_gemm_cutlass.py\n+++ b/benchmarks/kernels/benchmark_grouped_gemm_cutlass.py\n@@ -80,11 +80,6 @@ def bench_run(\n         a, score, topk, renormalize=False\n     )\n \n-    ab_strides1 = torch.full((num_experts,), k, device=\"cuda\", dtype=torch.int64)\n-    ab_strides2 = torch.full((num_experts,), n, device=\"cuda\", dtype=torch.int64)\n-    c_strides1 = torch.full((num_experts,), 2 * n, device=\"cuda\", dtype=torch.int64)\n-    c_strides2 = torch.full((num_experts,), k, device=\"cuda\", dtype=torch.int64)\n-\n     def run_triton_moe(\n         a: torch.Tensor,\n         w1: torch.Tensor,\n@@ -116,10 +111,6 @@ def bench_run(\n         w2: torch.Tensor,\n         w1_scale: torch.Tensor,\n         w2_scale: torch.Tensor,\n-        ab_strides1: torch.Tensor,\n-        ab_strides2: torch.Tensor,\n-        c_strides1: torch.Tensor,\n-        c_strides2: torch.Tensor,\n         topk_weights: torch.Tensor,\n         topk_ids: torch.Tensor,\n         per_act_token: bool,\n@@ -134,10 +125,6 @@ def bench_run(\n                 topk_ids,\n                 w1_scale,\n                 w2_scale,\n-                ab_strides1,\n-                ab_strides2,\n-                c_strides1,\n-                c_strides2,\n                 per_act_token,\n                 a1_scale=None,\n             )\n@@ -149,10 +136,6 @@ def bench_run(\n         w2_q: torch.Tensor,\n         w1_scale: torch.Tensor,\n         w2_scale: torch.Tensor,\n-        ab_strides1: torch.Tensor,\n-        ab_strides2: torch.Tensor,\n-        c_strides1: torch.Tensor,\n-        c_strides2: torch.Tensor,\n         topk_weights: torch.Tensor,\n         topk_ids: torch.Tensor,\n     ):\n@@ -167,10 +150,6 @@ def bench_run(\n                 topk_ids,\n                 w1_scale,\n                 w2_scale,\n-                ab_strides1,\n-                ab_strides2,\n-                c_strides1,\n-                c_strides2,\n                 per_act_token,\n                 a1_scale=None,\n             )\n@@ -215,10 +194,6 @@ def bench_run(\n             w2_q,\n             w1_scale,\n             w2_scale,\n-            ab_strides1,\n-            ab_strides2,\n-            c_strides1,\n-            c_strides2,\n             topk_weights,\n             topk_ids,\n         )\n@@ -256,10 +231,6 @@ def bench_run(\n         \"w1_scale\": w1_scale,\n         \"w2_scale\": w2_scale,\n         \"per_act_token\": per_act_token,\n-        \"ab_strides1\": ab_strides1,\n-        \"ab_strides2\": ab_strides2,\n-        \"c_strides1\": c_strides1,\n-        \"c_strides2\": c_strides2,\n         # cuda graph params\n         \"cutlass_graph\": cutlass_graph,\n         \"triton_graph\": triton_graph,\n@@ -318,10 +289,6 @@ def bench_run(\n         w2_q,\n         w1_scale,\n         w2_scale,\n-        ab_strides1,\n-        ab_strides2,\n-        c_strides1,\n-        c_strides2,\n         topk_weights,\n         topk_ids,\n         per_act_token,\n@@ -330,7 +297,7 @@ def bench_run(\n \n     results.append(\n         benchmark.Timer(\n-            stmt=\"run_cutlass_moe(a, a_scale, w1_q, w2_q, w1_scale, w2_scale, ab_strides1, ab_strides2, c_strides1, c_strides2, topk_weights, topk_ids, per_act_token, num_runs)\",  # noqa: E501\n+            stmt=\"run_cutlass_moe(a, a_scale, w1_q, w2_q, w1_scale, w2_scale, topk_weights, topk_ids, per_act_token, num_runs)\",  # noqa: E501\n             globals=globals,\n             label=label,\n             sub_label=sub_label,\ndiff --git a/csrc/moe/moe_permute_unpermute_op.cu b/csrc/moe/moe_permute_unpermute_op.cu\nindex 13aecd800..a77471a7f 100644\n--- a/csrc/moe/moe_permute_unpermute_op.cu\n+++ b/csrc/moe/moe_permute_unpermute_op.cu\n@@ -160,30 +160,6 @@ __global__ void shuffleInputRowsKernel(const T* input,\n   }\n }\n \n-template <typename T>\n-__global__ void shuffleInputRowsKernelSlow(const T* input,\n-                                           const int32_t* dst2src_map,\n-                                           T* output, int64_t num_src_rows,\n-                                           int64_t num_dst_rows,\n-                                           int64_t num_cols) {\n-  int64_t dest_row_idx = blockIdx.x;\n-  int64_t const source_row_idx = dst2src_map[dest_row_idx];\n-\n-  if (blockIdx.x < num_dst_rows) {\n-    // Duplicate and permute rows\n-    auto const* source_row_ptr = input + source_row_idx * num_cols;\n-    auto* dest_row_ptr = output + dest_row_idx * num_cols;\n-\n-    int64_t const start_offset = threadIdx.x;\n-    int64_t const stride = blockDim.x;\n-\n-    for (int elem_index = start_offset; elem_index < num_cols;\n-         elem_index += stride) {\n-      dest_row_ptr[elem_index] = source_row_ptr[elem_index];\n-    }\n-  }\n-}\n-\n void shuffle_rows(const torch::Tensor& input_tensor,\n                   const torch::Tensor& dst2src_map,\n                   torch::Tensor& output_tensor) {\n@@ -197,24 +173,17 @@ void shuffle_rows(const torch::Tensor& input_tensor,\n   int64_t const num_src_rows = input_tensor.size(0);\n   int64_t const num_cols = input_tensor.size(1);\n \n-  if (num_cols % (128 / sizeof(input_tensor.scalar_type()) / 8)) {\n-    // use slow kernel if num_cols can't be aligned to 128 bits\n-    MOE_DISPATCH(input_tensor.scalar_type(), [&] {\n-      shuffleInputRowsKernelSlow<scalar_t><<<blocks, threads, 0, stream>>>(\n-          reinterpret_cast<scalar_t*>(input_tensor.data_ptr()),\n-          dst2src_map.data_ptr<int32_t>(),\n-          reinterpret_cast<scalar_t*>(output_tensor.data_ptr()), num_src_rows,\n-          num_dest_rows, num_cols);\n-    });\n-  } else {\n-    MOE_DISPATCH(input_tensor.scalar_type(), [&] {\n-      shuffleInputRowsKernel<scalar_t><<<blocks, threads, 0, stream>>>(\n-          reinterpret_cast<scalar_t*>(input_tensor.data_ptr()),\n-          dst2src_map.data_ptr<int32_t>(),\n-          reinterpret_cast<scalar_t*>(output_tensor.data_ptr()), num_src_rows,\n-          num_dest_rows, num_cols);\n-    });\n-  }\n+  TORCH_CHECK(!(num_cols % (128 / sizeof(input_tensor.scalar_type()) / 8)),\n+              \"num_cols must be divisible by 128 / \"\n+              \"sizeof(input_tensor.scalar_type()) / 8\");\n+\n+  MOE_DISPATCH(input_tensor.scalar_type(), [&] {\n+    shuffleInputRowsKernel<scalar_t><<<blocks, threads, 0, stream>>>(\n+        reinterpret_cast<scalar_t*>(input_tensor.data_ptr()),\n+        dst2src_map.data_ptr<int32_t>(),\n+        reinterpret_cast<scalar_t*>(output_tensor.data_ptr()), num_src_rows,\n+        num_dest_rows, num_cols);\n+  });\n }\n \n #else\ndiff --git a/tests/kernels/moe/test_cutlass_moe.py b/tests/kernels/moe/test_cutlass_moe.py\nindex 37727b75b..81fb3ec1d 100644\n--- a/tests/kernels/moe/test_cutlass_moe.py\n+++ b/tests/kernels/moe/test_cutlass_moe.py\n@@ -207,10 +207,6 @@ def run_8_bit(moe_tensors: MOETensors8Bit,\n         'topk_ids': topk_ids,\n         'w1_scale': moe_tensors.w1_scale,\n         'w2_scale': moe_tensors.w2_scale,\n-        'ab_strides1': moe_tensors.ab_strides1,\n-        'ab_strides2': moe_tensors.ab_strides2,\n-        'c_strides1': moe_tensors.c_strides1,\n-        'c_strides2': moe_tensors.c_strides2,\n         'per_act_token': per_act_token,\n         'a1_scale': None  #moe_tensors.a_scale\n     }\n@@ -444,11 +440,6 @@ def test_run_cutlass_moe_fp8(\n         expert_map[start:end] = list(range(num_local_experts))\n         expert_map = torch.tensor(expert_map, dtype=torch.int32, device=\"cuda\")\n \n-        ab_strides1 = torch.full((e, ), k, device=\"cuda\", dtype=torch.int64)\n-        ab_strides2 = torch.full((e, ), n, device=\"cuda\", dtype=torch.int64)\n-        c_strides1 = torch.full((e, ), 2 * n, device=\"cuda\", dtype=torch.int64)\n-        c_strides2 = torch.full((e, ), k, device=\"cuda\", dtype=torch.int64)\n-\n         activation = lambda o, i: torch.ops._C.silu_and_mul(o, i)\n         a1q, a1q_scale = moe_kernel_quantize_input(mt.a, mt.a_scale,\n                                                    torch.float8_e4m3fn,\n@@ -457,9 +448,8 @@ def test_run_cutlass_moe_fp8(\n         func = lambda output: run_cutlass_moe_fp8(\n             output, a1q, mt.w1_q, mt.w2_q, topk_ids, activation,\n             global_num_experts, expert_map, mt.w1_scale, mt.w2_scale,\n-            a1q_scale, None, ab_strides1, ab_strides2, c_strides1, c_strides2,\n-            workspace13, workspace2, None, mt.a.dtype, per_act_token,\n-            per_out_channel, False)\n+            a1q_scale, None, workspace13, workspace2, None, mt.a.dtype,\n+            per_act_token, per_out_channel, False)\n \n         workspace13.random_()\n         output_random_workspace = torch.empty(output_shape,\ndiff --git a/tests/kernels/moe/test_pplx_cutlass_moe.py b/tests/kernels/moe/test_pplx_cutlass_moe.py\nindex 77adc89ea..e4f4a393d 100644\n--- a/tests/kernels/moe/test_pplx_cutlass_moe.py\n+++ b/tests/kernels/moe/test_pplx_cutlass_moe.py\n@@ -75,7 +75,6 @@ def pplx_cutlass_moe(\n     assert torch.cuda.current_device() == pgi.local_rank\n \n     num_tokens, hidden_dim = a.shape\n-    intermediate_dim = w2.shape[2]\n     num_experts = w1.shape[0]\n     block_size = hidden_dim  # TODO support more cases\n     device = pgi.device\n@@ -124,31 +123,10 @@ def pplx_cutlass_moe(\n         num_local_experts=num_local_experts,\n         num_dispatchers=num_dispatchers)\n \n-    ab_strides1 = torch.full((num_local_experts, ),\n-                             hidden_dim,\n-                             device=\"cuda\",\n-                             dtype=torch.int64)\n-    ab_strides2 = torch.full((num_local_experts, ),\n-                             intermediate_dim,\n-                             device=\"cuda\",\n-                             dtype=torch.int64)\n-    c_strides1 = torch.full((num_local_experts, ),\n-                            2 * intermediate_dim,\n-                            device=\"cuda\",\n-                            dtype=torch.int64)\n-    c_strides2 = torch.full((num_local_experts, ),\n-                            hidden_dim,\n-                            device=\"cuda\",\n-                            dtype=torch.int64)\n-\n     experts = CutlassExpertsFp8(num_local_experts,\n                                 out_dtype,\n                                 per_act_token,\n                                 per_out_ch,\n-                                ab_strides1,\n-                                ab_strides2,\n-                                c_strides1,\n-                                c_strides2,\n                                 num_dispatchers=num_dispatchers,\n                                 use_batched_format=True)\n \ndiff --git a/vllm/model_executor/layers/fused_moe/cutlass_moe.py b/vllm/model_executor/layers/fused_moe/cutlass_moe.py\nindex ff49d7bb7..2585a2953 100644\n--- a/vllm/model_executor/layers/fused_moe/cutlass_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/cutlass_moe.py\n@@ -13,7 +13,8 @@ from vllm.model_executor.layers.fused_moe.prepare_finalize import (\n     MoEPrepareAndFinalizeNoEP)\n from vllm.model_executor.layers.fused_moe.topk_weight_and_reduce import (\n     TopKWeightAndReduceDelegate)\n-from vllm.model_executor.layers.fused_moe.utils import (_fp8_quantize,\n+from vllm.model_executor.layers.fused_moe.utils import (_fp8_perm,\n+                                                        _fp8_quantize,\n                                                         _resize_cache,\n                                                         extract_required_args)\n from vllm.scalar_type import scalar_types\n@@ -34,10 +35,6 @@ def run_cutlass_moe_fp8(\n     w2_scale: Optional[torch.Tensor],\n     a1q_scale: Optional[torch.Tensor],\n     a2_scale: Optional[torch.Tensor],\n-    ab_strides1: torch.Tensor,\n-    ab_strides2: torch.Tensor,\n-    c_strides1: torch.Tensor,\n-    c_strides2: torch.Tensor,\n     workspace13: torch.Tensor,\n     workspace2: torch.Tensor,\n     expert_num_tokens: Optional[torch.Tensor],\n@@ -156,11 +153,27 @@ def run_cutlass_moe_fp8(\n                                     problem_sizes1, problem_sizes2, a_map,\n                                     c_map, global_num_experts, N, K)\n \n-        a1q = ops.shuffle_rows(a1q, a_map)\n-        a1q_scale = (ops.shuffle_rows(a1q_scale, a_map)\n-                     if per_act_token else a1q_scale)\n+        a1q = _fp8_perm(a1q, a_map)\n+        a1q_scale = a1q_scale[a_map] if per_act_token else a1q_scale\n         expert_offsets = expert_offsets[:-1]\n \n+    ab_strides1 = torch.full((w1.size(0), ),\n+                             K,\n+                             device=device,\n+                             dtype=torch.int64)\n+    c_strides1 = torch.full((w1.size(0), ),\n+                            2 * N,\n+                            device=device,\n+                            dtype=torch.int64)\n+    ab_strides2 = torch.full((w1.size(0), ),\n+                             N,\n+                             device=device,\n+                             dtype=torch.int64)\n+    c_strides2 = torch.full((w1.size(0), ),\n+                            K,\n+                            device=device,\n+                            dtype=torch.int64)\n+\n     if use_batched_format:\n         c1 = _resize_cache(workspace13, (local_E * padded_M, N * 2))\n         c2 = _resize_cache(workspace2, (local_E * padded_M, N))\n@@ -197,8 +210,7 @@ def run_cutlass_moe_fp8(\n     else:\n         # We can't do this inplace because output may point to the same tensor\n         # as c3.\n-        output.copy_(ops.shuffle_rows(c3, c_map).view(M * topk, K),\n-                     non_blocking=True)\n+        output.copy_(c3[c_map].view(M * topk, K), non_blocking=True)\n \n \n # TODO (bnell): split class batched vs. non-batched?\n@@ -211,10 +223,6 @@ class CutlassExpertsFp8(mk.FusedMoEPermuteExpertsUnpermute):\n         out_dtype: Optional[torch.dtype],\n         per_act_token_quant: bool,\n         per_out_ch_quant: bool,\n-        ab_strides1: torch.Tensor,\n-        ab_strides2: torch.Tensor,\n-        c_strides1: torch.Tensor,\n-        c_strides2: torch.Tensor,\n         block_shape: Optional[list[int]] = None,\n         num_dispatchers: Optional[int] = None,\n         use_batched_format: bool = False,\n@@ -231,10 +239,6 @@ class CutlassExpertsFp8(mk.FusedMoEPermuteExpertsUnpermute):\n         self.max_experts_per_worker = max_experts_per_worker\n         self.num_dispatchers = num_dispatchers\n         self.out_dtype = out_dtype\n-        self.ab_strides1 = ab_strides1\n-        self.ab_strides2 = ab_strides2\n-        self.c_strides1 = c_strides1\n-        self.c_strides2 = c_strides2\n         self.use_batched_format = use_batched_format\n \n     @property\n@@ -314,8 +318,7 @@ class CutlassExpertsFp8(mk.FusedMoEPermuteExpertsUnpermute):\n         run_cutlass_moe_fp8(\n             output, hidden_states, w1, w2, topk_ids, activation_callable,\n             global_num_experts, expert_map, w1_scale, w2_scale, a1q_scale,\n-            a2_scale, self.ab_strides1, self.ab_strides2, self.c_strides1,\n-            self.c_strides2, workspace13, workspace2, expert_num_tokens,\n+            a2_scale, workspace13, workspace2, expert_num_tokens,\n             self.out_dtype if self.out_dtype is not None else in_dtype,\n             self.per_act_token_quant, self.per_out_ch_quant,\n             self.use_batched_format)\n@@ -329,10 +332,6 @@ def cutlass_moe_fp8(\n     topk_ids: torch.Tensor,\n     w1_scale: torch.Tensor,\n     w2_scale: torch.Tensor,\n-    ab_strides1: torch.Tensor,\n-    ab_strides2: torch.Tensor,\n-    c_strides1: torch.Tensor,\n-    c_strides2: torch.Tensor,\n     per_act_token: Optional[bool] = None,\n     activation: str = \"silu\",\n     a1_scale: Optional[torch.Tensor] = None,\n@@ -360,17 +359,6 @@ def cutlass_moe_fp8(\n         Shape: [num_experts] or [num_experts, 2N]\n     - w2_scale (torch.Tensor): The fp32 scale to dequantize w2_q.\n         Shape: [num_experts] or [num_experts, K]\n-    - ab_strides1 (torch.Tensor): The input/weight strides for the first gemm.\n-        Shape: [num_experts]\n-    - ab_strides2 (torch.Tensor): The input/weight strides for the second gemm.\n-        Shape: [num_experts]\n-    - c_strides1 (torch.Tensor): The output strides for the first gemm.\n-        Shape: [num_experts]\n-    - c_strides2 (torch.Tensor): The output strides for the second gemm.\n-        Shape: [num_experts]\n-    - per_act_token (Optional[bool]): Whether the scale is per-token or\n-                                      per-tensor.\n-    - activation (str): The activation function to use.\n     - a1_scale (Optional[torch.Tensor]): The optional fp32 scale to quantize a.\n         Shape: scalar or [M]\n     - a2_scale (Optional[torch.Tensor]): The optional fp32 scale to\n@@ -403,10 +391,6 @@ def cutlass_moe_fp8(\n             out_dtype=a.dtype,\n             per_act_token_quant=per_act_token,\n             per_out_ch_quant=per_out_ch,\n-            ab_strides1=ab_strides1,\n-            ab_strides2=ab_strides2,\n-            c_strides1=c_strides1,\n-            c_strides2=c_strides2,\n             use_batched_format=False,\n         ),\n     )\ndiff --git a/vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py b/vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py\nindex 1a31410c3..2c93977be 100644\n--- a/vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py\n+++ b/vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py\n@@ -859,21 +859,6 @@ class CompressedTensorsW8A8Fp8MoECutlassMethod(CompressedTensorsMoEMethod):\n             layer.w13_weight_scale = torch.nn.Parameter(max_w13_scales,\n                                                         requires_grad=False)\n \n-        device = layer.w13_weight.device\n-        # ab_strides1 and c_strides2 are the same\n-        self.ab_strides1_c_strides2 = torch.full((layer.local_num_experts, ),\n-                                                 layer.hidden_size,\n-                                                 device=device,\n-                                                 dtype=torch.int64)\n-        self.ab_strides2 = torch.full((layer.local_num_experts, ),\n-                                      layer.intermediate_size_per_partition,\n-                                      device=device,\n-                                      dtype=torch.int64)\n-        self.c_strides1 = torch.full((layer.local_num_experts, ),\n-                                     2 * layer.intermediate_size_per_partition,\n-                                     device=device,\n-                                     dtype=torch.int64)\n-\n     def select_gemm_impl(\n         self,\n         prepare_finalize: FusedMoEPrepareAndFinalize,\n@@ -896,10 +881,6 @@ class CompressedTensorsW8A8Fp8MoECutlassMethod(CompressedTensorsMoEMethod):\n             moe.in_dtype,\n             self.input_quant.strategy == QuantizationStrategy.TOKEN,\n             self.weight_quant.strategy == QuantizationStrategy.CHANNEL,\n-            ab_strides1=self.ab_strides1_c_strides2,\n-            ab_strides2=self.ab_strides2,\n-            c_strides1=self.c_strides1,\n-            c_strides2=self.ab_strides1_c_strides2,\n             num_dispatchers=num_dispatchers,\n             use_batched_format=use_batched_format,\n         )\n@@ -946,8 +927,7 @@ class CompressedTensorsW8A8Fp8MoECutlassMethod(CompressedTensorsMoEMethod):\n             num_expert_group=num_expert_group,\n             custom_routing_function=custom_routing_function,\n             scoring_func=scoring_func,\n-            e_score_correction_bias=e_score_correction_bias,\n-            indices_type=self.topk_indices_dtype)\n+            e_score_correction_bias=e_score_correction_bias)\n \n         per_act_token = (\n             self.input_quant.strategy == QuantizationStrategy.TOKEN)\n@@ -968,10 +948,6 @@ class CompressedTensorsW8A8Fp8MoECutlassMethod(CompressedTensorsMoEMethod):\n                 expert_map=None if self.disable_expert_map else expert_map,\n                 w1_scale=layer.w13_weight_scale,\n                 w2_scale=layer.w2_weight_scale,\n-                ab_strides1=self.ab_strides1_c_strides2,\n-                ab_strides2=self.ab_strides2,\n-                c_strides1=self.c_strides1,\n-                c_strides2=self.ab_strides1_c_strides2,\n                 a1_scale=layer.w13_input_scale,\n                 a2_scale=layer.w2_input_scale,\n             )", "apis": ["vllm.cutlass_moe_fp8", "CutlassExpertsFp8.apply", "CompressedTensorsW8A8Fp8MoECutlassMethod.select_gemm_impl"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/cutlass_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/compressed_tensors/compressed_tensors_moe.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit is a revert of a previous performance improvements commit. It touches non-test source code files (including benchmarking scripts, CUDA kernels, and fused operators) by removing parameters and code paths that were introduced for performance optimization of the fp8 CUTLASS MoE implementation. Although the commit rolls back performance improvements, the changes are directly related to performance by targeting the efficient execution of GEMM operations and fused kernels on CUDA devices (CPU performance tests are applicable). Thus, the commit satisfies the criteria for being performance/optimization related.", "llm_api_reason": "This commit reverts several changes made to the fp8 CUTLASS MoE implementations. In the benchmarks and tests the extra strideâ€parameters (ab_strides and c_strides) are removed from all function calls. In the CUTLASS MoE module the function run_cutlass_moe_fp8 and the CutlassExpertsFp8 class have been adjusted to no longer require or pass these stride tensors. Similarly, in the compressed tensors MoE method for FP8 (CompressedTensorsW8A8Fp8MoECutlassMethod) the use of these stride parameters is reverted. Overall, the commit eliminates the performance-related API changes by reverting the changes to the stride-related interfaces."}
{"commit_hash": "0ec82edda59aaf5cf3b07aadf4ecce1aa1131add", "pr_url": "https://github.com/vllm-project/vllm/pull/21079", "pr_date": null, "timeline_text": "Copy link Contributor hj-mistral commented Jul 16, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Purpose Move fill ops inside align sum kernel to reduce bubbles. cumsum buffer does not need to be filled with zero. we can use blockscan to do the prefix sum This PR also moves the triton inits into the kernel to make it a fair comparison and also ensure the kernel is usable in the future as a fallback if required. Benchmarks Main branch FP16:\n# vllm bench throughput --model Qwen/Qwen3-30B-A3B --load-format dummy --input-len 1000 --output-len 100\n\nThroughput: 43.75 requests/s, 48024.34 total tokens/s, 4374.91 output tokens/s\nTotal num prompt tokens:  997723\nTotal num output tokens:  100000\n\nFP8:\n# vllm bench throughput --model Qwen/Qwen3-30B-A3B-FP8 --load-format dummy --input-len 1000 --output-len 100\n\nThroughput: 41.04 requests/s, 45049.17 total tokens/s, 4103.87 output tokens/s\nTotal num prompt tokens:  997723\nTotal num output tokens:  100000\n\nKernel benchmark:\n# python3 benchmarks/kernels/benchmark_moe_align_block_size.py\n\nRunning correctness check...\nâœ… VLLM implementation works with 64 experts!\nâœ… Triton and VLLM implementations match.\nmoe-align-block-size-performance:\n    num_tokens  num_experts  topk       VLLM      Triton\n0          1.0         16.0   1.0  16.448000   23.040000\n1          1.0         16.0   2.0  16.432000   23.104001\n2          1.0         16.0   8.0  16.448000   23.040000\n3          1.0         64.0   1.0  21.600001   25.984000\n4          1.0         64.0   2.0  21.792000   26.048001\n5          1.0         64.0   8.0  21.824000   25.952000\n6          1.0        224.0   1.0  23.680000   40.288001\n7          1.0        224.0   2.0  23.680000   40.320002\n8          1.0        224.0   8.0  23.712000   40.383998\n9          1.0        256.0   1.0  24.607999   43.136001\n10         1.0        256.0   2.0  24.639999   43.104000\n11         1.0        256.0   8.0  24.639999   43.200001\n12         1.0        280.0   1.0  25.248000   45.407999\n13         1.0        280.0   2.0  25.248000   45.343999\n14         1.0        280.0   8.0  25.248000   45.440000\n15         1.0        512.0   1.0  31.136001   69.151998\n16         1.0        512.0   2.0  31.328000   69.119997\n17         1.0        512.0   8.0  31.296000   69.215998\n18        16.0         16.0   1.0  16.511999   23.296000\n19        16.0         16.0   2.0  16.608000   23.520000\n20        16.0         16.0   8.0  17.856000   24.351999\n21        16.0         64.0   1.0  21.792000   26.400000\n22        16.0         64.0   2.0  21.792000   26.656000\n23        16.0         64.0   8.0  22.143999   27.424000\n24        16.0        224.0   1.0  23.871999   41.503999\n25        16.0        224.0   2.0  23.903999   41.600000\n26        16.0        224.0   8.0  24.032000   41.152000\n27        16.0        256.0   1.0  24.768000   43.088000\n28        16.0        256.0   2.0  24.831999   43.136001\n29        16.0        256.0   8.0  24.928000   43.391999\n30        16.0        280.0   1.0  25.152000   45.968000\n31        16.0        280.0   2.0  25.184000   46.080001\n32        16.0        280.0   8.0  25.343999   46.271998\n33        16.0        512.0   1.0  31.264000   69.343999\n34        16.0        512.0   2.0  31.328000   69.504000\n35        16.0        512.0   8.0  31.456001   69.888003\n36       256.0         16.0   1.0  19.200001   25.312001\n37       256.0         16.0   2.0  22.624001   28.576000\n38       256.0         16.0   8.0  18.528000   45.184001\n39       256.0         64.0   1.0  23.104001   28.416000\n40       256.0         64.0   2.0  24.831999   29.023999\n41       256.0         64.0   8.0  20.256000   33.535998\n42       256.0        224.0   1.0  24.256000   42.367999\n43       256.0        224.0   2.0  24.000000   42.943999\n44       256.0        224.0   8.0  24.256000   45.952000\n45       256.0        256.0   1.0  25.119999   44.224001\n46       256.0        256.0   2.0  24.960000   44.192001\n47       256.0        256.0   8.0  25.984000   47.488000\n48       256.0        280.0   1.0  25.312001   46.239998\n49       256.0        280.0   2.0  25.536001   47.327999\n50       256.0        280.0   8.0  26.432000   49.568001\n51       256.0        512.0   1.0  31.488001   69.824003\n52       256.0        512.0   2.0  31.392001   69.856003\n53       256.0        512.0   8.0  32.671999   71.712002\n54      4096.0         16.0   1.0  20.128001   68.896003\n55      4096.0         16.0   2.0  22.720000  114.367999\n56      4096.0         16.0   8.0  36.256000  378.015995\n57      4096.0         64.0   1.0  21.856001   39.391998\n58      4096.0         64.0   2.0  24.639999   51.872000\n59      4096.0         64.0   8.0  41.216001  121.360000\n60      4096.0        224.0   1.0  26.368000   50.976001\n61      4096.0        224.0   2.0  29.023999   56.607999\n62      4096.0        224.0   8.0  45.504000   78.304000\n63      4096.0        256.0   1.0  27.071999   51.968001\n64      4096.0        256.0   2.0  29.824000   58.944002\n65      4096.0        256.0   8.0  45.568001   78.368001\n66      4096.0        280.0   1.0  27.295999   53.056002\n67      4096.0        280.0   2.0  30.272000   59.648000\n68      4096.0        280.0   8.0  43.264002   80.095999\n69      4096.0        512.0   1.0  33.824001   73.600002\n70      4096.0        512.0   2.0  35.551999   77.776000\n71      4096.0        512.0   8.0  49.024001   98.591998 This PR FP16:\n#vllm bench throughput --model Qwen/Qwen3-30B-A3B --load-format dummy --input-len 1000 --output-len 100\n\nThroughput: 43.94 requests/s, 48234.94 total tokens/s, 4394.09 output tokens/s\nTotal num prompt tokens:  997723\nTotal num output tokens:  100000\n\nFP8:\n#vllm bench throughput --model Qwen/Qwen3-30B-A3B-FP8 --load-format dummy --input-len 1000 --output-len 100\n\nThroughput: 41.26 requests/s, 45294.95 total tokens/s, 4126.26 output tokens/s\nTotal num prompt tokens:  997723\nTotal num output tokens:  100000\n\nKernel benchmark:\n# python3 benchmarks/kernels/benchmark_moe_align_block_size.py\n\nRunning correctness check...\nâœ… VLLM implementation works with 64 experts!\nâœ… Triton and VLLM implementations match.\nmoe-align-block-size-performance:\n    num_tokens  num_experts  topk       VLLM      Triton\n0          1.0         16.0   1.0  17.472001   27.488001\n1          1.0         16.0   2.0  17.600000   30.304000\n2          1.0         16.0   8.0  17.696001   30.880000\n3          1.0         64.0   1.0  25.760001   31.296000\n4          1.0         64.0   2.0  25.855999   31.168001\n5          1.0         64.0   8.0  25.823999   31.488001\n6          1.0        224.0   1.0  21.536000   44.544000\n7          1.0        224.0   2.0  21.344000   44.799998\n8          1.0        224.0   8.0  21.407999   44.736002\n9          1.0        256.0   1.0  22.080000   47.616001\n10         1.0        256.0   2.0  21.568000   47.392000\n11         1.0        256.0   8.0  21.760000   47.711998\n12         1.0        280.0   1.0  21.952000   49.632002\n13         1.0        280.0   2.0  22.336001   49.984001\n14         1.0        280.0   8.0  22.048000   49.952000\n15         1.0        512.0   1.0  25.888000   75.071998\n16         1.0        512.0   2.0  25.952000   75.328000\n17         1.0        512.0   8.0  25.952000   75.007997\n18        16.0         16.0   1.0  17.600000   27.295999\n19        16.0         16.0   2.0  17.600000   28.352000\n20        16.0         16.0   8.0  18.912001   29.696001\n21        16.0         64.0   1.0  25.696000   31.184000\n22        16.0         64.0   2.0  25.632000   30.688001\n23        16.0         64.0   8.0  25.952000   30.944001\n24        16.0        224.0   1.0  21.312000   45.855999\n25        16.0        224.0   2.0  21.183999   45.791999\n26        16.0        224.0   8.0  21.536000   45.440000\n27        16.0        256.0   1.0  21.792000   47.359999\n28        16.0        256.0   2.0  21.760000   47.584001\n29        16.0        256.0   8.0  21.760000   47.807999\n30        16.0        280.0   1.0  22.048000   50.271999\n31        16.0        280.0   2.0  21.888001   50.464001\n32        16.0        280.0   8.0  22.336001   50.624002\n33        16.0        512.0   1.0  25.664000   74.975997\n34        16.0        512.0   2.0  25.696000   75.039998\n35        16.0        512.0   8.0  25.952000   75.135998\n36       256.0         16.0   1.0  20.320000   29.088000\n37       256.0         16.0   2.0  23.871999   32.543998\n38       256.0         16.0   8.0  17.600000   49.279999\n39       256.0         64.0   1.0  26.784001   32.448001\n40       256.0         64.0   2.0  28.384000   32.127999\n41       256.0         64.0   8.0  18.912001   37.535999\n42       256.0        224.0   1.0  21.536000   46.720002\n43       256.0        224.0   2.0  21.695999   47.488000\n44       256.0        224.0   8.0  21.856001   50.175998\n45       256.0        256.0   1.0  22.336001   48.703998\n46       256.0        256.0   2.0  21.952000   48.351999\n47       256.0        256.0   8.0  23.072001   51.711999\n48       256.0        280.0   1.0  22.240000   50.783999\n49       256.0        280.0   2.0  22.752000   52.000001\n50       256.0        280.0   8.0  23.808001   54.639999\n51       256.0        512.0   1.0  26.208000   75.744003\n52       256.0        512.0   2.0  26.335999   75.103998\n53       256.0        512.0   8.0  26.656000   77.215999\n54      4096.0         16.0   1.0  19.168001   72.672002\n55      4096.0         16.0   2.0  22.112001  117.183998\n56      4096.0         16.0   8.0  37.087999  382.703990\n57      4096.0         64.0   1.0  20.352000   43.423999\n58      4096.0         64.0   2.0  23.424000   55.712000\n59      4096.0         64.0   8.0  42.016000  125.568002\n60      4096.0        224.0   1.0  23.264000   55.744000\n61      4096.0        224.0   2.0  26.912000   60.864002\n62      4096.0        224.0   8.0  44.704001   81.919998\n63      4096.0        256.0   1.0  24.383999   56.448001\n64      4096.0        256.0   2.0  27.327999   63.104004\n65      4096.0        256.0   8.0  44.319998   82.496002\n66      4096.0        280.0   1.0  23.808001   57.824001\n67      4096.0        280.0   2.0  27.424000   64.576000\n68      4096.0        280.0   8.0  41.792002   83.967999\n69      4096.0        512.0   1.0  27.744001   79.135999\n70      4096.0        512.0   2.0  30.479999   83.328001\n71      4096.0        512.0   8.0  45.536000  103.808001 Test Result pytest tests/kernels/moe/test_moe_align_block_size.py - PASSED (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 2 mgoin and xuanyu-mistral reacted with heart emoji All reactions â¤ï¸ 2 reactions Copy link github-actions bot commented Jul 16, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . hj-mistral force-pushed the hj-align-kernel branch\n    from 2f3cc21 to 67295ab Compare July 16, 2025 22:08 gemini-code-assist bot reviewed Jul 16, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request aims to speed up MoE alignment kernels by replacing a sequential prefix sum with a parallel version using cub::BlockScan and by moving some tensor initializations from Python into the CUDA kernel to reduce kernel launch overhead. While these changes are effective for performance, I've identified a critical correctness issue in the new parallel prefix sum implementation. It does not correctly handle cases where the number of experts exceeds the number of threads in the CUDA block (1024), which would lead to incorrect calculations. The existing tests do not cover this scenario. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions csrc/moe/moe_align_sum_kernels.cu Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Member mgoin commented Jul 16, 2025 cc @yewentao256 ðŸ‘ 1 yewentao256 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . yewentao256 reviewed Jul 17, 2025 View reviewed changes Copy link Collaborator yewentao256 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the work! Could you also please benchmark the performance (E2E throughput + kernel latency) and make sure all unit test passes? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/fused_moe/moe_align_block_size.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author hj-mistral commented Jul 17, 2025 Thanks for the work! Could you also please benchmark the performance (E2E throughput + kernel latency) and make sure all unit test passes? Any documentation to follow on how to run both? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . hj-mistral added 3 commits July 17, 2025 12:43 Speed up align sum kernels â€¦ 3cd55fd Signed-off-by: Himanshu Jaju <hj@mistral.ai> assert num_exp < 1024 â€¦ f6ef4eb Signed-off-by: Himanshu Jaju <hj@mistral.ai> whitespace â€¦ c898aab Signed-off-by: Himanshu Jaju <hj@mistral.ai> hj-mistral force-pushed the hj-align-kernel branch\n    from b5ee67e to c898aab Compare July 17, 2025 12:43 Copy link Collaborator yewentao256 commented Jul 17, 2025 Any documentation to follow on how to run both? Throughput(fp16)\n\nvllm bench throughput --model Qwen/Qwen3-30B-A3B --load-format dummy --input-len 1000 --output-len 100\n\nThroughput(fp8)\n\nvllm bench throughput --model Qwen/Qwen3-30B-A3B-FP8 --load-format dummy --input-len 1000 --output-len 100 vllm-source/benchmarks/kernels/benchmark_moe_align_block_size.py vllm-source/tests/kernels/moe/test_moe_align_block_size.py ðŸ‘ 1 hj-mistral reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the performance Performance-related issues label Jul 18, 2025 Some changes â€¦ be95db1 Signed-off-by: Himanshu Jaju <hj@mistral.ai> hj-mistral force-pushed the hj-align-kernel branch\n    from a8140c6 to be95db1 Compare July 18, 2025 16:11 Copy link Contributor Author hj-mistral commented Jul 18, 2025 Any documentation to follow on how to run both? Throughput(fp16)\n\nvllm bench throughput --model Qwen/Qwen3-30B-A3B --load-format dummy --input-len 1000 --output-len 100\n\nThroughput(fp8)\n\nvllm bench throughput --model Qwen/Qwen3-30B-A3B-FP8 --load-format dummy --input-len 1000 --output-len 100 vllm-source/benchmarks/kernels/benchmark_moe_align_block_size.py vllm-source/tests/kernels/moe/test_moe_align_block_size.py All done and added to description, ptal :) All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . hj-mistral commented Jul 18, 2025 View reviewed changes csrc/moe/moe_align_sum_kernels.cu int expert_offset = (i - 1) % experts_per_warp; expert_count = shared_counts[warp_idx * experts_per_warp + expert_offset]; // Compute prefix sum over token counts per expert using BlockScan = cub::BlockScan<int32_t, 1024>; Copy link Contributor Author hj-mistral Jul 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment For reviewer: this is what helps this kernel become faster even though its doing more ops now. Unsure how to do this for the small_kernel, but if there's a way we can do this as a follow up PR :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions hj-mistral marked this pull request as ready for review July 18, 2025 17:00 hj-mistral requested review from tlrmchlsmth and WoosukKwon as code owners July 18, 2025 17:00 hj-mistral changed the title [wip] Speed up align sum kernels [perf] Speed up align sum kernels Jul 18, 2025 yewentao256 approved these changes Jul 18, 2025 View reviewed changes Copy link Collaborator yewentao256 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good to me, thanks for the work! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 hj-mistral reacted with heart emoji All reactions â¤ï¸ 1 reaction Copy link mergify bot commented Jul 19, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @hj-mistral . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jul 19, 2025 mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 19, 2025 mergify bot removed\n  the needs-rebase label Jul 19, 2025 hj-mistral force-pushed the hj-align-kernel branch\n    from 623f56f to 86466d7 Compare July 19, 2025 13:48 hj-mistral requested review from hmellor , jeejeelee , DarkLight1337 and ywang96 as code owners July 19, 2025 13:48 44 hidden items Load moreâ€¦ mgoin added moe and removed speculative-decoding ci/build v1 multi-modality Related to multi-modality (#4194) tool-calling llama Related to Llama models qwen Related to Qwen models labels Jul 19, 2025 fix â€¦ a5dfc09 Signed-off-by: Himanshu Jaju <hj@mistral.ai> Copy link Contributor Author hj-mistral commented Jul 21, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . That's a great point and answers my question as well. It is good to see the e2e speedup at least (and a note that FP8 performance looks off..) Don't worry about the DCO as we can resolve it manually before merge. It looks like there are a few related failures in the kernel tests I fixed my incorrect merge, but unsure how to fix the v1-test failure. Seems just an infra error? [2025-07-21T12:56:57Z]   Running command git clone --filter=blob:none --quiet https://github.com/robertgshaw2-neuralmagic/lm-evaluation-harness.git /tmp/pip-req-build-o61noco_\n[2025-07-21T12:56:58Z]   WARNING: Did not find branch or tag 'streaming-api', assuming revision or ref.\n[2025-07-21T12:56:58Z]   Running command git checkout -q streaming-api\n[2025-07-21T12:56:58Z]   error: pathspec 'streaming-api' did not match any file(s) known to git ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member mgoin commented Jul 21, 2025 Yeah the CI infra is just off there and we resolved on main, will request a force merge All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details simon-mo merged commit 0ec82ed into vllm-project : main Jul 21, 2025 96 of 98 checks passed Uh oh! There was an error while loading. Please reload this page . github-project-automation bot moved this to Done in Structured Output Jul 21, 2025 github-project-automation bot moved this to Done in Tool Calling Jul 21, 2025 hj-mistral deleted the hj-align-kernel branch July 21, 2025 18:26 Copy link Member tdoublep commented Jul 22, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . The changes from this PR are causing illegal memory accesses for me. If I deploy with commit before this PR was merged 005ae9be6c22dfa2c2c5580b50b41e67faee4a87 : $ VLLM_USE_V1=1 VLLM_ATTENTION_BACKEND=FLASHINFER vllm serve ibm-granite/granite-4.0-tiny-preview --no-enable-prefix-caching\n...\nINFO:     Started server process [604208]\nINFO:     Waiting for application startup.\nINFO:     Application startup complete. Whereas, if I deploy at commit after this PR was merged 0ec82edda59aaf5cf3b07aadf4ecce1aa1131add : $ VLLM_USE_V1=1 VLLM_ATTENTION_BACKEND=FLASHINFER vllm serve ibm-granite/granite-4.0-tiny-preview --no-enable-prefix-caching\n...\n  File \"/home/zrltpa/vllm/vllm/model_executor/layers/fused_moe/fused_moe.py\", line 1230, in torch_vllm_inplace_fused_experts\n    torch.ops.vllm.inplace_fused_experts(**kwargs)\n  File \"/home/zrltpa/miniforge3/envs/dev-env/lib/python3.12/site-packages/torch/_ops.py\", line 1158, in __call__\n    return self._op(*args, **(kwargs or {}))\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/zrltpa/vllm/vllm/model_executor/layers/fused_moe/fused_moe.py\", line 1020, in inplace_fused_experts\n    fused_experts_impl(hidden_states, w1, w2, topk_weights, topk_ids, True,\n  File \"/home/zrltpa/vllm/vllm/model_executor/layers/fused_moe/fused_moe.py\", line 1484, in fused_experts_impl\n    invoke_fused_moe_kernel(qcurr_hidden_states,\n  File \"/home/zrltpa/vllm/vllm/model_executor/layers/fused_moe/fused_moe.py\", line 604, in invoke_fused_moe_kernel\n    fused_moe_kernel[grid](\n  File \"/home/zrltpa/miniforge3/envs/dev-env/lib/python3.12/site-packages/triton/runtime/jit.py\", line 347, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/zrltpa/miniforge3/envs/dev-env/lib/python3.12/site-packages/triton/runtime/jit.py\", line 591, in run\n    kernel.run(grid_0, grid_1, grid_2, stream, kernel.function, kernel.packed_metadata,\n  File \"/home/zrltpa/miniforge3/envs/dev-env/lib/python3.12/site-packages/triton/backends/nvidia/driver.py\", line 529, in __call__\n    self.launch(gridX, gridY, gridZ, stream, function, self.launch_cooperative_grid, global_scratch, *args)\nRuntimeError: Triton Error [CUDA]: an illegal memory access was encountered Could we perhaps revert the changes from this PR until we figure out what is going on here? cc @mgoin @tlrmchlsmth This should have been caught by the CI tests...looking into what happened. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member tdoublep commented Jul 22, 2025 Before PR: python -m pytest tests/models/language/generation/test_hybrid.py::test_models[5-64-ibm-granite/granite-4.0-tiny-preview] \n...\n1 passed, 12 warnings in 69.55s (0:01:09) After PR: $ python -m pytest tests/models/language/generation/test_hybrid.py::test_models[5-64-ibm-granite/granite-4.0-tiny-preview]\n...\nFAILED tests/models/language/generation/test_hybrid.py::test_models[5-64-ibm-granite/granite-4.0-tiny-preview] - RuntimeError: Triton Error [CUDA]: operation not supported on global/shared address space\nERROR tests/models/language/generation/test_hybrid.py::test_models[5-64-ibm-granite/granite-4.0-tiny-preview] - RuntimeError: CUDA error: operation not supported on global/shared address space All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member tdoublep commented Jul 22, 2025 OK the reason it passes in CI is that vLLM bumped torch version which in turn bumped Triton version to 3.3.1. That seems to resolve the error that I am seeing. Still a bit weird though? Illegal memory access in 3.3.0 but works fine in 3.3.1? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . zixi-qi pushed a commit\n        to zixi-qi/vllm\n      that referenced\n      this pull request Jul 23, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 41d76db Signed-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: qizixi <qizixi@meta.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 98e2e2c Signed-off-by: Himanshu Jaju <hj@mistral.ai> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 8954857 Signed-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 8944e23 Signed-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 15e1cba Signed-off-by: Himanshu Jaju <hj@mistral.ai> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 0865b8e Signed-off-by: Himanshu Jaju <hj@mistral.ai> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 885137a Signed-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ a6ae1b9 Signed-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 7672862 Signed-off-by: Himanshu Jaju <hj@mistral.ai> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ 92ef410 Signed-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 27, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ c1bb8c1 Signed-off-by: Himanshu Jaju <hj@mistral.ai> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [perf] Speed up align sum kernels ( vllm-project#21079 ) â€¦ c6cb0c5 Signed-off-by: Himanshu Jaju <hj@mistral.ai> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:25", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, Throughput, throughput | SERVING: vllm serve, vllm serve, serve | TEST: Test, test, test", "analysis_extracted_at": "2025-09-07 17:50:25", "models": ["Qwen/Qwen3-30B-A3B", "Qwen/Qwen3-30B-A3B-FP8", "ibm-granite/granite-4.0-tiny-preview"], "lm_eval_commands": null, "perf_command": "vllm bench throughput --model Qwen/Qwen3-30B-A3B --load-format dummy --input-len 1000 --output-len 100", "commit_subject": "[perf] Speed up align sum kernels (#21079)", "commit_message": "[perf] Speed up align sum kernels (#21079)\n\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>", "commit_date": "2025-07-21T11:19:23-07:00", "files_changed": ["benchmarks/kernels/benchmark_moe_align_block_size.py", "csrc/moe/moe_align_sum_kernels.cu", "vllm/model_executor/layers/fused_moe/moe_align_block_size.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 1, "num_files": 3, "num_hunks": 13, "num_edited_lines": 85, "num_non_test_edited_lines": 85, "commit_year": 2025}, "diff_text": "diff --git a/benchmarks/kernels/benchmark_moe_align_block_size.py b/benchmarks/kernels/benchmark_moe_align_block_size.py\nindex 5170ac09d..1af5a21ca 100644\n--- a/benchmarks/kernels/benchmark_moe_align_block_size.py\n+++ b/benchmarks/kernels/benchmark_moe_align_block_size.py\n@@ -33,15 +33,13 @@ def check_correctness(num_tokens, num_experts=256, block_size=256, topk=8):\n     sorted_ids_triton = torch.empty(\n         (max_num_tokens_padded,), dtype=torch.int32, device=\"cuda\"\n     )\n-    sorted_ids_triton.fill_(topk_ids.numel())  # fill with sentinel value\n-    expert_ids_triton = torch.zeros(\n+    expert_ids_triton = torch.empty(\n         (max_num_tokens_padded // block_size,), dtype=torch.int32, device=\"cuda\"\n     )\n     num_tokens_post_pad_triton = torch.empty((1,), dtype=torch.int32, device=\"cuda\")\n \n     sorted_ids_vllm = torch.empty_like(sorted_ids_triton)\n-    sorted_ids_vllm.fill_(topk_ids.numel())\n-    expert_ids_vllm = torch.zeros_like(expert_ids_triton)\n+    expert_ids_vllm = torch.empty_like(expert_ids_triton)\n     num_tokens_post_pad_vllm = torch.empty_like(num_tokens_post_pad_triton)\n \n     # 2. run implementations\n@@ -102,7 +100,6 @@ def benchmark(num_tokens, num_experts, topk, provider):\n \n     max_num_tokens_padded = topk_ids.numel() + num_experts * (block_size - 1)\n     sorted_ids = torch.empty((max_num_tokens_padded,), dtype=torch.int32, device=\"cuda\")\n-    sorted_ids.fill_(topk_ids.numel())\n     max_num_m_blocks = max_num_tokens_padded // block_size\n     expert_ids = torch.empty((max_num_m_blocks,), dtype=torch.int32, device=\"cuda\")\n     num_tokens_post_pad = torch.empty((1,), dtype=torch.int32, device=\"cuda\")\ndiff --git a/csrc/moe/moe_align_sum_kernels.cu b/csrc/moe/moe_align_sum_kernels.cu\nindex 462dbd1f8..8bbcf5a67 100644\n--- a/csrc/moe/moe_align_sum_kernels.cu\n+++ b/csrc/moe/moe_align_sum_kernels.cu\n@@ -1,6 +1,7 @@\n #include <torch/all.h>\n #include <ATen/cuda/CUDAContext.h>\n #include <c10/cuda/CUDAGuard.h>\n+#include <cub/cub.cuh>\n \n #include <ATen/ATen.h>\n #include <ATen/cuda/Atomic.cuh>\n@@ -19,9 +20,14 @@ __global__ void moe_align_block_size_kernel(\n     int32_t* __restrict__ sorted_token_ids, int32_t* __restrict__ expert_ids,\n     int32_t* __restrict__ total_tokens_post_pad, int32_t num_experts,\n     int32_t padded_num_experts, int32_t experts_per_warp, int32_t block_size,\n-    size_t numel, int32_t* __restrict__ cumsum) {\n+    size_t numel, int32_t* __restrict__ cumsum, int32_t max_num_tokens_padded) {\n   extern __shared__ int32_t shared_counts[];\n \n+  // Initialize sorted_token_ids with numel\n+  for (size_t it = threadIdx.x; it < max_num_tokens_padded; it += blockDim.x) {\n+    sorted_token_ids[it] = numel;\n+  }\n+\n   const int warp_id = threadIdx.x / WARP_SIZE;\n   const int my_expert_start = warp_id * experts_per_warp;\n \n@@ -45,18 +51,27 @@ __global__ void moe_align_block_size_kernel(\n \n   __syncthreads();\n \n-  if (threadIdx.x == 0) {\n-    cumsum[0] = 0;\n-    for (int i = 1; i <= num_experts; ++i) {\n-      int expert_count = 0;\n-      int warp_idx = (i - 1) / experts_per_warp;\n-      int expert_offset = (i - 1) % experts_per_warp;\n-      expert_count = shared_counts[warp_idx * experts_per_warp + expert_offset];\n+  // Compute prefix sum over token counts per expert\n+  using BlockScan = cub::BlockScan<int32_t, 1024>;\n+  __shared__ typename BlockScan::TempStorage temp_storage;\n \n-      cumsum[i] =\n-          cumsum[i - 1] + CEILDIV(expert_count, block_size) * block_size;\n-    }\n-    *total_tokens_post_pad = cumsum[num_experts];\n+  int expert_count = 0;\n+  int expert_id = threadIdx.x;\n+  if (expert_id < num_experts) {\n+    int warp_idx = expert_id / experts_per_warp;\n+    int expert_offset = expert_id % experts_per_warp;\n+    expert_count = shared_counts[warp_idx * experts_per_warp + expert_offset];\n+    expert_count = CEILDIV(expert_count, block_size) * block_size;\n+  }\n+\n+  int cumsum_val;\n+  BlockScan(temp_storage).ExclusiveSum(expert_count, cumsum_val);\n+  if (expert_id <= num_experts) {\n+    cumsum[expert_id] = cumsum_val;\n+  }\n+\n+  if (expert_id == num_experts) {\n+    *total_tokens_post_pad = cumsum_val;\n   }\n \n   __syncthreads();\n@@ -67,6 +82,13 @@ __global__ void moe_align_block_size_kernel(\n       expert_ids[i / block_size] = threadIdx.x;\n     }\n   }\n+\n+  // Fill remaining expert_ids with 0\n+  const size_t fill_start_idx = cumsum[num_experts] / block_size + threadIdx.x;\n+  const size_t expert_ids_size = CEILDIV(max_num_tokens_padded, block_size);\n+  for (size_t i = fill_start_idx; i < expert_ids_size; i += blockDim.x) {\n+    expert_ids[i] = 0;\n+  }\n }\n \n template <typename scalar_t>\n@@ -105,7 +127,12 @@ __global__ void moe_align_block_size_small_batch_expert_kernel(\n     const scalar_t* __restrict__ topk_ids,\n     int32_t* __restrict__ sorted_token_ids, int32_t* __restrict__ expert_ids,\n     int32_t* __restrict__ total_tokens_post_pad, int32_t num_experts,\n-    int32_t block_size, size_t numel) {\n+    int32_t block_size, size_t numel, int32_t max_num_tokens_padded) {\n+  // Initialize sorted_token_ids with numel\n+  for (size_t it = threadIdx.x; it < max_num_tokens_padded; it += blockDim.x) {\n+    sorted_token_ids[it] = numel;\n+  }\n+\n   const size_t tid = threadIdx.x;\n   const size_t stride = blockDim.x;\n \n@@ -153,6 +180,13 @@ __global__ void moe_align_block_size_small_batch_expert_kernel(\n     }\n   }\n \n+  // Fill remaining expert_ids with 0\n+  const size_t fill_start_idx = cumsum[num_experts] / block_size + threadIdx.x;\n+  const size_t expert_ids_size = CEILDIV(max_num_tokens_padded, block_size);\n+  for (size_t i = fill_start_idx; i < expert_ids_size; i += blockDim.x) {\n+    expert_ids[i] = 0;\n+  }\n+\n   for (size_t i = tid; i < numel; i += stride) {\n     int32_t expert_id = topk_ids[i];\n     int32_t rank_post_pad =\n@@ -179,13 +213,17 @@ void moe_align_block_size(torch::Tensor topk_ids, int64_t num_experts,\n   int threads = 1024;\n   threads = ((threads + WARP_SIZE - 1) / WARP_SIZE) * WARP_SIZE;\n \n+  // BlockScan uses 1024 threads and assigns one thread per expert.\n+  TORCH_CHECK(padded_num_experts < 1024,\n+              \"padded_num_experts must be less than 1024\");\n+\n   VLLM_DISPATCH_INTEGRAL_AND_UNSIGNED_TYPES(\n       topk_ids.scalar_type(), \"moe_align_block_size_kernel\", [&] {\n         // calc needed amount of shared mem for `cumsum` tensors\n         auto options_int =\n             torch::TensorOptions().dtype(torch::kInt).device(topk_ids.device());\n         torch::Tensor cumsum_buffer =\n-            torch::zeros({num_experts + 1}, options_int);\n+            torch::empty({num_experts + 1}, options_int);\n         bool small_batch_expert_mode =\n             (topk_ids.numel() < 1024) && (num_experts <= 64);\n \n@@ -203,7 +241,7 @@ void moe_align_block_size(torch::Tensor topk_ids, int64_t num_experts,\n               sorted_token_ids.data_ptr<int32_t>(),\n               experts_ids.data_ptr<int32_t>(),\n               num_tokens_post_pad.data_ptr<int32_t>(), num_experts, block_size,\n-              topk_ids.numel());\n+              topk_ids.numel(), sorted_token_ids.size(0));\n         } else {\n           auto align_kernel = vllm::moe::moe_align_block_size_kernel<scalar_t>;\n \n@@ -217,7 +255,8 @@ void moe_align_block_size(torch::Tensor topk_ids, int64_t num_experts,\n               experts_ids.data_ptr<int32_t>(),\n               num_tokens_post_pad.data_ptr<int32_t>(), num_experts,\n               padded_num_experts, experts_per_warp, block_size,\n-              topk_ids.numel(), cumsum_buffer.data_ptr<int32_t>());\n+              topk_ids.numel(), cumsum_buffer.data_ptr<int32_t>(),\n+              sorted_token_ids.size(0));\n \n           const int block_threads = std::min(256, (int)threads);\n           const int num_blocks =\ndiff --git a/vllm/model_executor/layers/fused_moe/moe_align_block_size.py b/vllm/model_executor/layers/fused_moe/moe_align_block_size.py\nindex 3aae183df..2c9ad509f 100644\n--- a/vllm/model_executor/layers/fused_moe/moe_align_block_size.py\n+++ b/vllm/model_executor/layers/fused_moe/moe_align_block_size.py\n@@ -111,6 +111,8 @@ def moe_align_block_size_triton(\n                          dtype=torch.int32,\n                          device=topk_ids.device)\n     tokens_per_thread = cdiv(numel, num_experts)\n+    sorted_token_ids.fill_(numel)\n+    expert_ids.zero_()\n \n     moe_align_block_size_stage1[grid](\n         topk_ids,\n@@ -205,11 +207,8 @@ def moe_align_block_size(\n     sorted_ids = torch.empty((max_num_tokens_padded, ),\n                              dtype=torch.int32,\n                              device=topk_ids.device)\n-    sorted_ids.fill_(topk_ids.numel())\n     max_num_m_blocks = triton.cdiv(max_num_tokens_padded, block_size)\n-    # Expert ids must be zeroed out to prevent index out of bounds error while\n-    # mapping global expert ids to local expert ids in expert parallelism.\n-    expert_ids = torch.zeros((max_num_m_blocks, ),\n+    expert_ids = torch.empty((max_num_m_blocks, ),\n                              dtype=torch.int32,\n                              device=topk_ids.device)\n     num_tokens_post_pad = torch.empty((1),", "apis": ["vllm.model_executor.layers.fused_moe.moe_align_block_size"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/moe_align_block_size.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/kernels/benchmark_moe_align_block_size.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test source files (C++ CUDA kernels and Python modules) and alters algorithmic behavior in the align sum kernels to speed them up. The changes include replacing filled arrays with more efficient initializations, adding a cub::BlockScan based prefix sum for computing cumsum, and additional logic to fill arrays without unnecessary initialization overhead. These modifications are carefully tuned to improve runtime performance on CPU accessible kernels (even though they run on CUDA, they donâ€™t involve GPU-exclusive workloads for training, and performance is testable without a GPU context running general algorithms). The changes are non-trivial modifications of internal performance-critical kernels rather than simple refactorings, bug fixes, or feature additions. Therefore, based on these performance optimization improvements, the commit satisfies the conditions for being performance related.", "llm_api_reason": "The commit refactors both the benchmark and CUDA kernel code used in the MoE alignment operation and updates the Python wrapper in vllm/model_executor/layers/fused_moe/moe_align_block_size.py. In doing so, it changes the initialization and memory filling routines used by the Python function that performs MoE block size alignment. This means that the Python API function moe_align_block_size is affected, as it now relies on the revised internal behavior for aligning tokens and mapping expert IDs."}
{"commit_hash": "6d0734c562e759fdb7076d762222b3881e62ab1f", "pr_url": "https://github.com/vllm-project/vllm/pull/20645", "pr_date": "2025-07-19", "timeline_text": "Copy link Contributor kaixih commented Jul 8, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . For this PR , Flashinfer introduces a new backend for block-wise scaled FP8. This PR adds support for that backend. cc. @kushanam @wenscarl @pavanimajety Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions kaixih requested review from mgoin , robertgshaw2-redhat and tlrmchlsmth as code owners July 8, 2025 21:54 Copy link github-actions bot commented Jul 8, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gemini-code-assist bot reviewed Jul 8, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @kaixih , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request integrates a new Flashinfer backend to support block-wise scaled FP8 quantization for Mixture-of-Experts (MoE) layers. The primary goal is to leverage Flashinfer's optimized kernels to potentially enhance the performance of FP8 MoE computations within vLLM, introducing a specialized execution path for compatible configurations. Highlights Flashinfer Integration : Introduced flashinfer.fused_moe as a new dependency and added a flashinfer_moe_enabled flag within the Fp8LinearMethod class to conditionally activate the new backend. Weight Preprocessing for Compatibility : Implemented a new helper function _swap_w13_to_w31 and integrated its application during the process_weights_after_loading phase. This is crucial for reordering weights ( w13_weight and w13_weight_scale_inv ) to ensure compatibility with Flashinfer's expected activation layout. Conditional MoE Execution Path : Modified the apply method in Fp8LinearMethod to introduce a new execution branch. When flashinfer_moe_enabled is true, vLLM's default expert selection logic is bypassed, and the call is delegated to Flashinfer's fused_moe.trtllm_fp8_block_scale_moe for the core FP8 MoE computation. Backend-Specific Constraints and Input Handling : Added several assertions within the Flashinfer MoE execution path to enforce specific requirements, such as block_quant , renormalize , use_grouped_topk , sigmoid scoring, silu activation, and specific constraints on top_k , global_num_experts , and num_expert_group . Additionally, input hidden states are now quantized using per_token_group_quant_fp8 before being passed to the Flashinfer kernel. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with ðŸ‘ and ðŸ‘Ž on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . â†© Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jul 8, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces support for a new Flashinfer MoE backend for block-wise scaled FP8 quantization, primarily in vllm/model_executor/layers/quantization/fp8.py . A critical bug exists in weight processing, where swapped weights are not persisted. Additionally, assert statements should be replaced with proper error handling, and the new backend should be made configurable. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/quantization/fp8.py Outdated Comment on lines 656 to 707 w13_weight = _swap_w13_to_w31(layer.w13_weight.data) w13_weight_scale_inv = _swap_w13_to_w31(layer.w13_weight_scale_inv.data) w2_weight = layer.w2_weight.data w2_weight_scale_inv = layer.w2_weight_scale_inv.data Copy link Contributor gemini-code-assist bot Jul 8, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The swapped weights and scales obtained from _swap_w13_to_w31 are assigned to local variables but not persisted back to the layer 's parameters. This will cause the apply method to use the original, un-swapped weights, leading to incorrect results. Ensure the processed weights are copied back to the layer's parameters using param.data.copy_(swapped_tensor) . Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/quantization/fp8.py Outdated Comment on lines 937 to 1011 assert self.block_quant assert (renormalize and use_grouped_topk and scoring_func == 'sigmoid' and custom_routing_function == None) assert top_k <= global_num_experts assert top_k <= 8 assert topk_group <= 4 assert global_num_experts > num_expert_group assert global_num_experts % num_expert_group == 0 assert global_num_experts % 4 == 0 assert top_k < (topk_group * global_num_experts / num_expert_group) assert activation == \"silu\" Copy link Contributor gemini-code-assist bot Jul 8, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Replace assert statements with explicit if conditions and raise ValueError or NotImplementedError exceptions. This ensures that these checks are always active, even when assertions are disabled in production environments. if not self . block_quant : raise ValueError ( \"Flashinfer MoE backend requires block quantization.\" ) if not ( renormalize and use_grouped_topk and scoring_func == 'sigmoid' and custom_routing_function is None ): raise NotImplementedError ( \"Flashinfer MoE backend has specific routing requirements: \" \"renormalize=True, use_grouped_topk=True, scoring_func='sigmoid', \" \"and no custom_routing_function.\" ) if not top_k <= 8 : raise ValueError ( f\"Unsupported top_k= { top_k } , must be <= 8.\" ) if not topk_group <= 4 : raise ValueError ( f\"Unsupported topk_group= { topk_group } , must be <= 4.\" ) if not ( global_num_experts > num_expert_group and global_num_experts % num_expert_group == 0 and global_num_experts % 4 == 0 ): raise ValueError ( f\"Unsupported expert grouping: { global_num_experts = } , { num_expert_group = } \" ) if not top_k < ( topk_group * global_num_experts / num_expert_group ): raise ValueError ( \"top_k must be less than (topk_group * num_experts_per_group).\" ) if activation != \"silu\" : raise NotImplementedError ( f\"Flashinfer MoE backend only supports 'silu' activation, but got { activation } .\" ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/quantization/fp8.py Outdated @@ -449,6 +454,7 @@ def __init__(self, quant_config: Fp8Config): self.quant_config = quant_config self.block_quant = self.quant_config.weight_block_size is not None self.flashinfer_moe_enabled = True Copy link Contributor gemini-code-assist bot Jul 8, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Consider making flashinfer_moe_enabled configurable via an environment variable or model configuration parameter to facilitate debugging and performance comparisons. This would allow users to easily switch between backends. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author kaixih commented Jul 10, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Here is the lm_eval results after enabling the new moe backend: Tasks Version Filter n-shot Metric Value Stderr gsm8k 3 flexible-extract 5 exact_match â†‘ 0.968 Â± 0.0079 strict-match 5 exact_match â†‘ 0.962 Â± 0.0086 To repro: pip install lm_eval[api]==0.4.8 export VLLM_WORKER_MULTIPROC_METHOD= \" spawn \" export VLLM_USE_V1= \" 1 \" export VLLM_USE_STANDALONE_COMPILE= \" 0 \" export VLLM_USE_FLASHINFER_MOE_FP8= \" 1 \" model_dir= < your ckpts of DeepSeek-R1- 0528> model_args= \" model= ${model_dir} ,pretrained= ${model_dir} ,trust_remote_code=True,tensor_parallel_size=8,enable_expert_parallel=True,enforce_eager=False,max_model_len=2048 \" lm_eval --model vllm --model_args $model_args --gen_kwargs temperature=0.0 --limit 500 --trust_remote_code --tasks gsm8k --num_fewshot 5 --batch_size 200 ðŸ‘ 2 mgoin and pavanimajety reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented Jul 11, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @kaixih . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jul 11, 2025 kaixih force-pushed the kaixih/flashinfer-moe-bs-fp8 branch\n      2 times, most recently\n    from 6229f18 to 567d6ae Compare July 11, 2025 23:17 mergify bot removed\n  the needs-rebase label Jul 11, 2025 kaixih force-pushed the kaixih/flashinfer-moe-bs-fp8 branch\n    from 567d6ae to 85ccae5 Compare July 11, 2025 23:32 support flashinfer moe blockscale fp8 â€¦ 644d108 Signed-off-by: kaixih <kaixih@nvidia.com> kaixih force-pushed the kaixih/flashinfer-moe-bs-fp8 branch\n    from 85ccae5 to 644d108 Compare July 11, 2025 23:58 Minor â€¦ 44d86bb Signed-off-by: kaixih <kaixih@nvidia.com> Copy link Contributor Author kaixih commented Jul 12, 2025 These kernels are primarily beneficial in low-latency scenarios, so I also ran some latency benchmarks. The results are shown below. The flashinfer kernels can bring ~32% perf improvement for a DSR1 model on 8xB200 GPUs. # default:\nAvg latency: 22.061138840367253 seconds\n# flashinfer:\nAvg latency: 15.51937770833271 seconds To repro: export VLLM_WORKER_MULTIPROC_METHOD= \" spawn \" export VLLM_USE_V1= \" 1 \" export VLLM_USE_STANDALONE_COMPILE= \" 0 \" export VLLM_USE_FLASHINFER_MOE_FP8= \" 0 \" # or \"1\" for flashinfer model_dir= < your ckpts of DeepSeek-R1- 0528> python benchmarks/benchmark_latency.py --model= $model_dir --output-len=1024 --tensor-parallel-size=8 --enable-expert-parallel --input-len=128 --trust_remote_code --max-model-len=2048 --batch-size=1 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . kaixih changed the title [Draft] Add Flashinfer MoE blockscale fp8 backend [NVIDIA] Add Flashinfer MoE blockscale fp8 backend Jul 12, 2025 pavanimajety reviewed Jul 13, 2025 View reviewed changes vllm/model_executor/layers/fused_moe/fused_moe.py Outdated Comment on lines 1067 to 1068 def flashinfer_fused_moe_fp8(router_logits: torch.Tensor, e_score_correction_bias: torch.Tensor, Copy link Contributor pavanimajety Jul 13, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Use flashinfer_fused_moe_blockscale_fp8 to differentiate between other moe variants in FI Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor pavanimajety Jul 13, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment also add assert fi_fused_moe is not None Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author kaixih Jul 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Done. Thx. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions kaixih added 2 commits July 14, 2025 16:42 Address comments â€¦ a2b14c6 Signed-off-by: kaixih <kaixih@nvidia.com> Formatting â€¦ aa634a6 Signed-off-by: kaixih <kaixih@nvidia.com> mgoin changed the title [NVIDIA] Add Flashinfer MoE blockscale fp8 backend [NVIDIA] Add Flashinfer MoE blockscale fp8 backend for low latency Jul 16, 2025 Update API â€¦ 7ce56eb Signed-off-by: kaixih <kaixih@nvidia.com> Copy link Contributor Author kaixih commented Jul 16, 2025 Iâ€™ve just updated the API call sites to accommodate the latest FlashInfer changes, which are recommended for improved robustness. Iâ€™d suggest testing the code with the ToT version of flashinfer or any release after 0.2.8. ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented Jul 18, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @kaixih . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jul 18, 2025 mgoin added 2 commits July 18, 2025 09:32 Merge branch 'main' into kaixih/flashinfer-moe-bs-fp8 â€¦ 8f6aa2f Signed-off-by: mgoin <mgoin64@gmail.com> Refactor to use flashinfer wrapper for lazy import â€¦ 2e61e91 Signed-off-by: mgoin <mgoin64@gmail.com> mgoin reviewed Jul 18, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Is it right that TP is not supported, only EP? I think we should assert if so I see this error with TP RuntimeError: Worker failed with error 'vllm::flashinfer_fused_moe_blockscale_fp8() Expected a value of type 'int' for argument 'num_expert_group' but instead found type 'NoneType'.\nPosition: 9\nValue: None\nDeclaration: vllm::flashinfer_fused_moe_blockscale_fp8(Tensor router_logits, Tensor e_score_correction_bias, Tensor x, Tensor w13_weight, Tensor w13_weight_scale_inv, Tensor w2_weight, Tensor w2_weight_scale_inv, SymInt global_num_experts, SymInt top_k, SymInt num_expert_group, SymInt topk_group, SymInt intermediate_size_per_partition, SymInt expert_offset, SymInt local_num_experts, SymInt[] block_shape, float routed_scaling=1., SymInt tile_tokens_dim=8, SymInt routing_method_type=2) -> Tensor\nCast error details: Unable to cast Python instance of type <class 'NoneType'> to C++ type '?' (#define PYBIND11_DETAILED_ERROR_MESSAGES or compile in debug mode for details)', please check the stack trace above for the root cause Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/quantization/fp8.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/layers/quantization/fp8.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/layers/fused_moe/fused_moe.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . mergify bot removed\n  the needs-rebase label Jul 18, 2025 kaixih added 2 commits July 18, 2025 19:45 Address comments â€¦ 79ef02e Signed-off-by: kaixih <kaixih@nvidia.com> Format â€¦ 44b0d24 Signed-off-by: kaixih <kaixih@nvidia.com> mgoin added performance Performance-related issues ready ONLY add when PR is ready to merge/full CI is needed labels Jul 18, 2025 mgoin changed the title [NVIDIA] Add Flashinfer MoE blockscale fp8 backend for low latency [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low latency Jul 18, 2025 Copy link Contributor Author kaixih commented Jul 18, 2025 Is it right that TP is not supported, only EP? I think we should assert if so I think it supports it. I did a quick check and it looked good. Can you double check what is in your num_expert_group ? Are you testing a DS model? Here is what I used for quick test and you can turn on/off the enable_expert_parallel . All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author kaixih commented Jul 18, 2025 Also checked accuracy with TP=8: INFO:lm_eval.loggers.evaluation_tracker:Output path not provided, skipping saving results aggregated vllm (model=/model/models--deepseek-ai--DeepSeek-R1-0528/snapshots/4236a6af538feda4548eca9ab308586007567f52/,pretrained=/model/models--deepseek-ai--DeepSeek-R1-0528/snapshots/4236a6af538feda4548eca9ab308586007567f52/,trust_remote_code=True,tensor_parallel_size=8,enable_expert_parallel=False,enforce_eager=False,max_model_len=2048,trust_remote_code=True), gen_kwargs: (temperature=0.0), limit: 500.0, num_fewshot: 5, batch_size: 200 Tasks Version Filter n-shot Metric Value Stderr gsm8k 3 flexible-extract 5 exact_match â†‘ 0.964 Â± 0.0083 strict-match 5 exact_match â†‘ 0.958 Â± 0.0090 To repro: export VLLM_WORKER_MULTIPROC_METHOD=\"spawn\"\nexport VLLM_USE_V1=\"1\"\nexport VLLM_USE_STANDALONE_COMPILE=\"0\"\nexport VLLM_USE_FLASHINFER_MOE_FP8=\"1\"\nmodel_dir=\"/model/models--deepseek-ai--DeepSeek-R1-0528/snapshots/4236a6af538feda4548eca9ab308586007567f52/\"\nmodel_args=\"model=${model_dir},pretrained=${model_dir},trust_remote_code=True,tensor_parallel_size=8,enable_expert_parallel=False,enforce_eager=False,max_model_len=2048\"\nlm_eval --model vllm --model_args $model_args --gen_kwargs temperature=0.0 --limit 500 --trust_remote_code --tasks gsm8k --num_fewshot 5 --batch_size 200 ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin approved these changes Jul 18, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM, thank you! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin enabled auto-merge (squash) July 18, 2025 21:22 Hide details View details vllm-bot merged commit 6d0734c into vllm-project : main Jul 19, 2025 80 of 83 checks passed Uh oh! There was an error while loading. Please reload this page . hj-mistral pushed a commit\n        to hj-mistral/vllm\n      that referenced\n      this pull request Jul 19, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ d195bb6 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ ac5c103 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 2919908 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 71dd173 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 36f7621 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 268cfab â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 392b3e9 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 0b6eb26 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 51d92ce â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ 4970555 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 27, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ d42a70b â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low lateâ€¦ â€¦ fd638e0 â€¦ncy ( vllm-project#20645 )\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:29", "has_lm_eval": true, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, lm_eval | PERF: latency, latency, latency | TEST: test, test, testing", "analysis_extracted_at": "2025-09-07 17:50:29", "models": ["mistralai/Mistral-7B-Instruct-v0.3", "deepseek-ai/DeepSeek-R1"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=mistralai/Mistral-7B-Instruct-v0.3,dtype=float16 --tasks gsm8k --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-R1,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model mistralai/Mistral-7B-Instruct-v0.3 --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low latency (#20645)", "commit_message": "[NVIDIA] Add SM100 Flashinfer MoE blockscale fp8 backend for low latency (#20645)\n\nSigned-off-by: kaixih <kaixih@nvidia.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>", "commit_date": "2025-07-19T02:33:01-07:00", "files_changed": ["vllm/envs.py", "vllm/model_executor/layers/fused_moe/config.py", "vllm/model_executor/layers/fused_moe/fused_moe.py", "vllm/model_executor/layers/quantization/fp8.py", "vllm/model_executor/layers/quantization/modelopt.py", "vllm/utils/flashinfer.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 6, "only_test_files": 0, "only_non_test_files": 1, "num_files": 6, "num_hunks": 16, "num_edited_lines": 218, "num_non_test_edited_lines": 218, "commit_year": 2025}, "diff_text": "diff --git a/vllm/envs.py b/vllm/envs.py\nindex 261cc7855..0896ae3a9 100755\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -119,7 +119,8 @@ if TYPE_CHECKING:\n     VLLM_TPU_BUCKET_PADDING_GAP: int = 0\n     VLLM_TPU_MOST_MODEL_LEN: Optional[int] = None\n     VLLM_USE_DEEP_GEMM: bool = False\n-    VLLM_USE_FLASHINFER_MOE: bool = False\n+    VLLM_USE_FLASHINFER_MOE_FP8: bool = False\n+    VLLM_USE_FLASHINFER_MOE_FP4: bool = False\n     VLLM_XGRAMMAR_CACHE_MB: int = 0\n     VLLM_MSGPACK_ZERO_COPY_THRESHOLD: int = 256\n     VLLM_ALLOW_INSECURE_SERIALIZATION: bool = False\n@@ -854,9 +855,13 @@ environment_variables: dict[str, Callable[[], Any]] = {\n     \"VLLM_USE_DEEP_GEMM\":\n     lambda: bool(int(os.getenv(\"VLLM_USE_DEEP_GEMM\", \"0\"))),\n \n+    # Allow use of FlashInfer MoE kernels for fused moe ops.\n+    \"VLLM_USE_FLASHINFER_MOE_FP8\":\n+    lambda: bool(int(os.getenv(\"VLLM_USE_FLASHINFER_MOE_FP8\", \"0\"))),\n+\n     # Allow use of FlashInfer CUTLASS kernels for fused moe ops.\n-    \"VLLM_USE_FLASHINFER_MOE\":\n-    lambda: bool(int(os.getenv(\"VLLM_USE_FLASHINFER_MOE\", \"0\"))),\n+    \"VLLM_USE_FLASHINFER_MOE_FP4\":\n+    lambda: bool(int(os.getenv(\"VLLM_USE_FLASHINFER_MOE_FP4\", \"0\"))),\n \n     # Control the cache sized used by the xgrammar compiler. The default\n     # of 512 MB should be enough for roughly 1000 JSON schemas.\ndiff --git a/vllm/model_executor/layers/fused_moe/config.py b/vllm/model_executor/layers/fused_moe/config.py\nindex 9bebb6a65..51c421bd2 100644\n--- a/vllm/model_executor/layers/fused_moe/config.py\n+++ b/vllm/model_executor/layers/fused_moe/config.py\n@@ -191,7 +191,7 @@ class FusedMoEParallelConfig:\n \n     @property\n     def use_flashinfer_cutlass_kernels(self):\n-        return (envs.VLLM_USE_FLASHINFER_MOE\n+        return (envs.VLLM_USE_FLASHINFER_MOE_FP4\n                 and has_flashinfer_cutlass_fused_moe())\n \n     @staticmethod\ndiff --git a/vllm/model_executor/layers/fused_moe/fused_moe.py b/vllm/model_executor/layers/fused_moe/fused_moe.py\nindex aec5d7b25..c412f695a 100644\n--- a/vllm/model_executor/layers/fused_moe/fused_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/fused_moe.py\n@@ -28,7 +28,7 @@ from vllm.model_executor.layers.fused_moe.prepare_finalize import (\n from vllm.model_executor.layers.fused_moe.topk_weight_and_reduce import (\n     TopKWeightAndReduceNoOP)\n from vllm.model_executor.layers.fused_moe.utils import (\n-    _resize_cache, moe_kernel_quantize_input)\n+    _resize_cache, moe_kernel_quantize_input, per_token_group_quant_fp8)\n from vllm.model_executor.layers.quantization.utils.mxfp4_utils import (\n     dequant_mxfp4)\n from vllm.platforms import current_platform\n@@ -1061,6 +1061,104 @@ direct_register_custom_op(\n )\n \n \n+def next_positive_power_of_2(x: int) -> int:\n+    if x < 1:\n+        return 1\n+    return 1 << (x - 1).bit_length()\n+\n+\n+def _get_tile_tokens_dim(num_tokens, top_k, num_experts):\n+    # Guess tokens per expert assuming perfect expert distribution first.\n+    num_tokens_per_expert = (num_tokens * top_k) // num_experts\n+    # And pad the number to the next power of 2.\n+    tile_tokens_dim = next_positive_power_of_2(num_tokens_per_expert)\n+    # Cap to 8-64 tokens per CTA tile as it's the range supported by the kernel.\n+    tile_tokens_dim = min(max(tile_tokens_dim, 8), 64)\n+    return tile_tokens_dim\n+\n+\n+def flashinfer_fused_moe_blockscale_fp8(\n+        routing_logits: torch.Tensor,\n+        routing_bias: torch.Tensor,\n+        x: torch.Tensor,\n+        w13_weight: torch.Tensor,\n+        w13_weight_scale_inv: torch.Tensor,\n+        w2_weight: torch.Tensor,\n+        w2_weight_scale_inv: torch.Tensor,\n+        global_num_experts: int,\n+        top_k: int,\n+        num_expert_group: int,\n+        topk_group: int,\n+        intermediate_size: int,\n+        expert_offset: int,\n+        local_num_experts: int,\n+        block_shape: list[int],\n+        routed_scaling: float = 1.0) -> torch.Tensor:\n+    from vllm.utils.flashinfer import flashinfer_trtllm_fp8_block_scale_moe\n+    assert top_k <= global_num_experts\n+    assert top_k <= 8\n+    assert topk_group <= 4\n+    assert global_num_experts > num_expert_group\n+    assert global_num_experts % num_expert_group == 0\n+    assert global_num_experts % 4 == 0\n+    assert top_k < (topk_group * global_num_experts / num_expert_group)\n+    assert block_shape == [128, 128]\n+\n+    a_q, a_sf = per_token_group_quant_fp8(x, block_shape[1])\n+    # NOTE: scales of hidden states have to be transposed!\n+    a_sf_t = a_sf.t().contiguous()\n+    return flashinfer_trtllm_fp8_block_scale_moe(\n+        routing_logits=routing_logits,\n+        routing_bias=routing_bias,\n+        hidden_states=a_q,\n+        hidden_states_scale=a_sf_t,\n+        gemm1_weights=w13_weight,\n+        gemm1_weights_scale=w13_weight_scale_inv,\n+        gemm2_weights=w2_weight,\n+        gemm2_weights_scale=w2_weight_scale_inv,\n+        num_experts=global_num_experts,\n+        top_k=top_k,\n+        n_group=num_expert_group,\n+        topk_group=topk_group,\n+        intermediate_size=intermediate_size,\n+        local_expert_offset=expert_offset,\n+        local_num_experts=local_num_experts,\n+        routed_scaling_factor=routed_scaling,\n+        tile_tokens_dim=_get_tile_tokens_dim(x.shape[0], top_k,\n+                                             global_num_experts),\n+        routing_method_type=2,  # DeepSeek-styled routing method\n+    )\n+\n+\n+def flashinfer_fused_moe_blockscale_fp8_fake(\n+        routing_logits: torch.Tensor,\n+        routing_bias: torch.Tensor,\n+        x: torch.Tensor,\n+        w13_weight: torch.Tensor,\n+        w13_weight_scale_inv: torch.Tensor,\n+        w2_weight: torch.Tensor,\n+        w2_weight_scale_inv: torch.Tensor,\n+        global_num_experts: int,\n+        top_k: int,\n+        num_expert_group: int,\n+        topk_group: int,\n+        intermediate_size: int,\n+        expert_offset: int,\n+        local_num_experts: int,\n+        block_shape: list[int],\n+        routed_scaling: float = 1.0) -> torch.Tensor:\n+    return torch.empty_like(x)\n+\n+\n+direct_register_custom_op(\n+    op_name=\"flashinfer_fused_moe_blockscale_fp8\",\n+    op_func=flashinfer_fused_moe_blockscale_fp8,\n+    mutates_args=[],\n+    fake_impl=flashinfer_fused_moe_blockscale_fp8_fake,\n+    tags=(torch.Tag.needs_fixed_stride_order, ),\n+)\n+\n+\n def outplace_fused_experts(\n         hidden_states: torch.Tensor,\n         w1: torch.Tensor,\ndiff --git a/vllm/model_executor/layers/quantization/fp8.py b/vllm/model_executor/layers/quantization/fp8.py\nindex 824dfe15a..35d7545d8 100644\n--- a/vllm/model_executor/layers/quantization/fp8.py\n+++ b/vllm/model_executor/layers/quantization/fp8.py\n@@ -43,6 +43,7 @@ from vllm.platforms import current_platform\n from vllm.scalar_type import scalar_types\n from vllm.utils import has_deep_gemm\n from vllm.utils.deep_gemm import is_blackwell_deep_gemm_used\n+from vllm.utils.flashinfer import has_flashinfer_moe\n \n if TYPE_CHECKING:\n     from vllm.model_executor.models.utils import WeightsMapper\n@@ -52,6 +53,11 @@ ACTIVATION_SCHEMES = [\"static\", \"dynamic\"]\n logger = init_logger(__name__)\n \n \n+def _swap_w13_to_w31(x: torch.Tensor) -> torch.Tensor:\n+    return x.reshape(-1, 2, x.shape[-2] // 2,\n+                     x.shape[-1]).flip(dims=[1]).reshape(x.shape)\n+\n+\n def _is_col_major(x: torch.Tensor) -> bool:\n     assert x.dim() == 3\n     b, m, n = x.shape\n@@ -473,6 +479,11 @@ class Fp8MoEMethod(FusedMoEMethodBase):\n         self.quant_config = quant_config\n         self.block_quant = self.quant_config.weight_block_size is not None\n \n+        self.flashinfer_moe_enabled = False\n+        if envs.VLLM_USE_FLASHINFER_MOE_FP8 and has_flashinfer_moe():\n+            logger.info_once(\n+                \"Using FlashInfer MoE FP8 kernels for Fp8MoEMethod.\")\n+            self.flashinfer_moe_enabled = True\n         # For GPUs that lack FP8 hardware support, we can leverage the Marlin\n         # kernel for fast weight-only FP8 quantization\n         self.use_marlin = (not current_platform.has_device_capability(89)\n@@ -674,6 +685,14 @@ class Fp8MoEMethod(FusedMoEMethodBase):\n                     normalize_e4m3fn_to_e4m3fnuz(\n                         layer.w2_weight, layer.w2_weight_scale_inv,\n                         layer.w2_input_scale)\n+            elif self.flashinfer_moe_enabled:\n+                # NOTE: weights have to be swapped since the activation is\n+                # applied on different half for flashinfer vs vllm\n+                w13_weight = _swap_w13_to_w31(layer.w13_weight.data)\n+                w13_weight_scale_inv = _swap_w13_to_w31(\n+                    layer.w13_weight_scale_inv.data)\n+                w2_weight = layer.w2_weight.data\n+                w2_weight_scale_inv = layer.w2_weight_scale_inv.data\n             else:\n                 w13_weight = layer.w13_weight.data\n                 w13_weight_scale_inv = layer.w13_weight_scale_inv.data\n@@ -915,25 +934,25 @@ class Fp8MoEMethod(FusedMoEMethodBase):\n             assert logical_to_physical_map is not None\n             assert logical_replica_count is not None\n             assert isinstance(layer, FusedMoE)\n-\n-        topk_weights, topk_ids = FusedMoE.select_experts(\n-            hidden_states=x,\n-            router_logits=router_logits,\n-            use_grouped_topk=use_grouped_topk,\n-            top_k=top_k,\n-            renormalize=renormalize,\n-            topk_group=topk_group,\n-            num_expert_group=num_expert_group,\n-            custom_routing_function=custom_routing_function,\n-            scoring_func=scoring_func,\n-            e_score_correction_bias=e_score_correction_bias,\n-            indices_type=self.topk_indices_dtype,\n-            enable_eplb=enable_eplb,\n-            expert_map=expert_map,\n-            expert_load_view=expert_load_view,\n-            logical_to_physical_map=logical_to_physical_map,\n-            logical_replica_count=logical_replica_count,\n-        )\n+        if not self.flashinfer_moe_enabled:\n+            topk_weights, topk_ids = FusedMoE.select_experts(\n+                hidden_states=x,\n+                router_logits=router_logits,\n+                use_grouped_topk=use_grouped_topk,\n+                top_k=top_k,\n+                renormalize=renormalize,\n+                topk_group=topk_group,\n+                num_expert_group=num_expert_group,\n+                custom_routing_function=custom_routing_function,\n+                scoring_func=scoring_func,\n+                e_score_correction_bias=e_score_correction_bias,\n+                indices_type=self.topk_indices_dtype,\n+                enable_eplb=enable_eplb,\n+                expert_map=expert_map,\n+                expert_load_view=expert_load_view,\n+                logical_to_physical_map=logical_to_physical_map,\n+                logical_replica_count=logical_replica_count,\n+            )\n \n         if self.rocm_aiter_moe_enabled:\n             from vllm.model_executor.layers.fused_moe.rocm_aiter_fused_moe import (  # noqa: E501\n@@ -971,6 +990,31 @@ class Fp8MoEMethod(FusedMoEMethodBase):\n                 apply_router_weight_on_input=apply_router_weight_on_input,\n                 global_num_experts=global_num_experts,\n                 expert_map=expert_map)\n+        elif self.flashinfer_moe_enabled:\n+            # Currently only work with DS models\n+            assert self.block_quant\n+            assert (renormalize and use_grouped_topk\n+                    and scoring_func == 'sigmoid'\n+                    and custom_routing_function is None)\n+            assert activation == \"silu\"\n+            return torch.ops.vllm.flashinfer_fused_moe_blockscale_fp8(\n+                routing_logits=router_logits.to(torch.float32),\n+                routing_bias=e_score_correction_bias,\n+                x=x,\n+                w13_weight=layer.w13_weight,\n+                w13_weight_scale_inv=layer.w13_weight_scale_inv,\n+                w2_weight=layer.w2_weight,\n+                w2_weight_scale_inv=layer.w2_weight_scale_inv,\n+                global_num_experts=global_num_experts,\n+                top_k=top_k,\n+                num_expert_group=num_expert_group,\n+                topk_group=topk_group,\n+                intermediate_size=layer.intermediate_size_per_partition,\n+                expert_offset=layer.ep_rank * layer.local_num_experts,\n+                local_num_experts=layer.local_num_experts,\n+                block_shape=self.quant_config.weight_block_size,\n+                routed_scaling=1.0,\n+            )\n         else:\n             return self.fused_experts(\n                 hidden_states=x,\ndiff --git a/vllm/model_executor/layers/quantization/modelopt.py b/vllm/model_executor/layers/quantization/modelopt.py\nindex 3807899fc..20def70d1 100644\n--- a/vllm/model_executor/layers/quantization/modelopt.py\n+++ b/vllm/model_executor/layers/quantization/modelopt.py\n@@ -721,7 +721,7 @@ class ModelOptNvFp4FusedMoE(FusedMoEMethodBase):\n         self.use_marlin = False\n         self.allow_flashinfer_cutlass = False\n \n-        if envs.VLLM_USE_FLASHINFER_MOE:\n+        if envs.VLLM_USE_FLASHINFER_MOE_FP4:\n             if self.cutlass_nvfp4_supported and current_platform.is_cuda() \\\n                and current_platform.is_device_capability(100):\n                 logger.info_once(\n@@ -800,10 +800,9 @@ class ModelOptNvFp4FusedMoE(FusedMoEMethodBase):\n             assert moe.dp_size > 1\n             logger.debug_once(\"Using CutlassExpertsFp4\")\n             # Currently CutlassExpertsFp4 doesn't support DP\n-            raise ValueError(\n-                \"CutlassExpertsFp4 doesn't support DP. \"\n-                \"Use flashinfer CUTLASS FusedMoE(VLLM_USE_FLASHINFER_MOE)\"\n-                \" backend instead.\")\n+            raise ValueError(\"CutlassExpertsFp4 doesn't support DP. \"\n+                             \"Use flashinfer CUTLASS FusedMoE backend instead \"\n+                             \"(set VLLM_USE_FLASHINFER_MOE_FP4=1)\")\n \n         return experts\n \ndiff --git a/vllm/utils/flashinfer.py b/vllm/utils/flashinfer.py\nindex dbd2dc393..fd8b384a6 100644\n--- a/vllm/utils/flashinfer.py\n+++ b/vllm/utils/flashinfer.py\n@@ -64,6 +64,8 @@ def _lazy_import_wrapper(module_name: str,\n \n \n # Create lazy wrappers for each function\n+flashinfer_trtllm_fp8_block_scale_moe = _lazy_import_wrapper(\n+    \"flashinfer.fused_moe\", \"trtllm_fp8_block_scale_moe\")\n flashinfer_cutlass_fused_moe = _lazy_import_wrapper(\"flashinfer.fused_moe\",\n                                                     \"cutlass_fused_moe\")\n fp4_quantize = _lazy_import_wrapper(\"flashinfer\", \"fp4_quantize\")\n@@ -77,10 +79,16 @@ autotune = _lazy_import_wrapper(\n     fallback_fn=lambda *args, **kwargs: contextlib.nullcontext())\n \n \n+@functools.cache\n+def has_flashinfer_moe() -> bool:\n+    \"\"\"Return ``True`` if FlashInfer MoE module is available.\"\"\"\n+    return importlib.util.find_spec(\"flashinfer.fused_moe\") is not None\n+\n+\n @functools.cache\n def has_flashinfer_cutlass_fused_moe() -> bool:\n     \"\"\"Return ``True`` if FlashInfer CUTLASS fused MoE is available.\"\"\"\n-    if not has_flashinfer():\n+    if not has_flashinfer_moe():\n         return False\n \n     # Check if all required functions are available\n@@ -99,9 +107,11 @@ def has_flashinfer_cutlass_fused_moe() -> bool:\n \n __all__ = [\n     \"has_flashinfer\",\n-    \"has_flashinfer_cutlass_fused_moe\",\n+    \"flashinfer_trtllm_fp8_block_scale_moe\",\n     \"flashinfer_cutlass_fused_moe\",\n     \"fp4_quantize\",\n     \"fp4_swizzle_blockscale\",\n     \"autotune\",\n+    \"has_flashinfer_moe\",\n+    \"has_flashinfer_cutlass_fused_moe\",\n ]", "apis": ["vllm.model_executor.layers.fused_moe.fused_moe.flashinfer_fused_moe_blockscale_fp8", "vllm.model_executor.layers.fused_moe.config.FusedMoEParallelConfig.use_flashinfer_cutlass_kernels", "vllm.model_executor.layers.quantization.fp8.Fp8MoEMethod.apply", "vllm.utils.flashinfer.has_flashinfer_moe"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/envs.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/fused_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/fp8.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies several non-test source files in the vllm codebase, including configuration files and quantization implementations, to add new backend functionality: FlashInfer MoE blockscale fp8 kernels. This change introduces new environment variables and selects new optimized code paths that target low latency operation on CPU (not GPU-specific) for fused MoE operations. The changes are non-trivial and focused on performance improvements (reducing latency), rather than simple refactoring, bug fixes, or standard feature additions. Hence, the modifications are performance/optimization related.", "llm_api_reason": "This commit adds support for new FlashInfer MoE backends by introducing two new environment flags (VLLM_USE_FLASHINFER_MOE_FP8 and VLLM_USE_FLASHINFER_MOE_FP4) in the environment module. It then updates the fused MoE layer by adding a new function (flashinfer_fused_moe_blockscale_fp8) and a helper to compute tile dimensions. In the FP8 quantization code for MoE, the Fp8MoEMethod.apply branch now calls the appropriate FlashInfer kernel when flashinfer MoE is enabled. Finally, a new utility (has_flashinfer_moe) is added in the flashinfer module to detect if the FlashInfer MoE module is present. These changes affect the public/fused MoE API endpoints used in FP8 MoE inference and configuration."}
{"commit_hash": "dcc6cfb991cd76369aad96e04424f29c8fecdbd8", "pr_url": "https://github.com/vllm-project/vllm/pull/21193", "pr_date": "2025-07-19", "timeline_text": "Copy link Contributor varun-sundar-rabindranath commented Jul 18, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Purpose Tweak the num_warps and NUM_STAGES (num pipeline stages for prefetching) values of the kernel. Local micro-benchmark numbers: main: Benchmark: E=256, T=2048, H=7168, group_size=128, repeat=200\ntokens=4: \tquant_silu_mul 0.030ms \t\ntokens=8: \tquant_silu_mul 0.056ms \t\ntokens=16: \tquant_silu_mul 0.106ms \t\ntokens=32: \tquant_silu_mul 0.204ms \t\ntokens=64: \tquant_silu_mul 0.402ms \t\ntokens=128: \tquant_silu_mul 0.799ms \t\ntokens=256: \tquant_silu_mul 1.579ms \t\ntokens=384: \tquant_silu_mul 2.366ms \t\ntokens=512: \tquant_silu_mul 3.148ms \t\ntokens=1024: \tquant_silu_mul 6.272ms \t\ntokens=2048: \tquant_silu_mul 12.522ms This PR: Benchmark: E=256, T=2048, H=7168, group_size=128, repeat=200\ntokens=4: \tquant_silu_mul 0.017ms \t\ntokens=8: \tquant_silu_mul 0.032ms \t\ntokens=16: \tquant_silu_mul 0.057ms \t\ntokens=32: \tquant_silu_mul 0.108ms \t\ntokens=64: \tquant_silu_mul 0.211ms \t\ntokens=128: \tquant_silu_mul 0.417ms \t\ntokens=256: \tquant_silu_mul 0.830ms \t\ntokens=384: \tquant_silu_mul 1.234ms \t\ntokens=512: \tquant_silu_mul 1.639ms \t\ntokens=1024: \tquant_silu_mul 3.254ms \t\ntokens=2048: \tquant_silu_mul 6.514ms Note: micro-benchmarking script from https://github.com/tlrmchlsmth/ptgq_fp8 E2E Perf server command : VLLM_ALL2ALL_BACKEND=\"deepep_low_latency\" VLLM_USE_DEEP_GEMM=1  canhazgpu run -g 2 --  vllm serve Qwen/Qwen3-30B-A3B-FP8  --trust-remote-code --enable-expert-parallel --data-parallel-size 2 --port 9010 --no-enable-prefix-caching benchmark command : python3 ./benchmarks/benchmark_serving.py --model Qwen/Qwen3-30B-A3B-FP8 --dataset-name sharegpt --port 9010 --dataset-path ./ShareGPT_V3_unfiltered_cleaned_split.json Methodology: Start the server and execute the benchmark command 3 times. Report the best Total Token Throughput numbers. main : ============ Serving Benchmark Result ============\nSuccessful requests:                 \t1000 \t \nBenchmark duration (s):              \t32.44\t \nTotal input tokens:                  \t217393    \nTotal generated tokens:              \t201847    \nRequest throughput (req/s):          \t30.83\t \nOutput token throughput (tok/s):     \t6222.53   \nTotal Token throughput (tok/s):      \t12924.31  \n---------------Time to First Token----------------\nMean TTFT (ms):                      \t6470.31   \nMedian TTFT (ms):                    \t6734.54   \nP99 TTFT (ms):                       \t12538.94  \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                      \t192.93    \nMedian TPOT (ms):                    \t76.87\t \nP99 TPOT (ms):                       \t773.24    \n---------------Inter-token Latency----------------\nMean ITL (ms):                       \t61.06\t \nMedian ITL (ms):                     \t35.02\t \nP99 ITL (ms):                        \t778.17    \n================================================== This PR: ============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  30.64     \nTotal input tokens:                      217393    \nTotal generated tokens:                  201847    \nRequest throughput (req/s):              32.64     \nOutput token throughput (tok/s):         6587.82   \nTotal Token throughput (tok/s):          13683.03  \n---------------Time to First Token----------------\nMean TTFT (ms):                          6416.49   \nMedian TTFT (ms):                        6604.24   \nP99 TTFT (ms):                           11718.61  \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          174.51    \nMedian TPOT (ms):                        66.36     \nP99 TPOT (ms):                           776.26    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           54.63     \nMedian ITL (ms):                         27.40     \nP99 ITL (ms):                            779.23    \n================================================== Test Plan local testing : pytest -s tests/kernels/moe/test_silu_mul_fp8_quant_deep_gemm.py e2e testing : server command : VLLM_ALL2ALL_BACKEND=\"deepep_low_latency\" VLLM_USE_DEEP_GEMM=1  canhazgpu run -g 2 --  vllm serve Qwen/Qwen3-30B-A3B-FP8  --trust-remote-code --enable-expert-parallel --data-parallel-size 2 --port 9010 --no-enable-prefix-caching lm_eval command : lm_eval --model local-completions --tasks gsm8k --model_args model=Qwen/Qwen3-30B-A3B-FP8,base_url=http://127.0.0.1:9010/v1/completions,num_concurrent=30,max_retries=3 --limit 100 Test Result tests/kernels/moe/test_silu_mul_fp8_quant_deep_gemm.py test passes locally lm_eval output : |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.84|Â±  |0.0368|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.95|Â±  |0.0219| (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions num_warps & num_stages tweak â€¦ f134464 Signed-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com> Copy link github-actions bot commented Jul 18, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gemini-code-assist bot reviewed Jul 18, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces performance optimizations to the silu_mul_fp8_quant_deep_gemm Triton kernel. The changes involve switching from a manual while loop to tl.range to enable software pipelining, and tuning the num_warps and NUM_STAGES parameters. The code modifications are correct and follow Triton best practices for performance. The provided micro-benchmarks demonstrate a significant performance improvement, which validates the tuning choices. The changes are well-contained and improve the efficiency of the kernel as intended. I have no further comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tlrmchlsmth approved these changes Jul 18, 2025 View reviewed changes tlrmchlsmth added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 18, 2025 tlrmchlsmth enabled auto-merge (squash) July 18, 2025 16:36 simon-mo disabled auto-merge July 19, 2025 06:09 Hide details View details simon-mo merged commit dcc6cfb into vllm-project : main Jul 19, 2025 78 of 79 checks passed Uh oh! There was an error while loading. Please reload this page . hj-mistral pushed a commit\n        to hj-mistral/vllm\n      that referenced\n      this pull request Jul 19, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ 58ad0a6 â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ d07d2ed â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> tlrmchlsmth mentioned this pull request Jul 24, 2025 [RFC]: Data Parallel Attention and Expert Parallel MoEs #16037 Open 37 tasks avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ 5ee1aab â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ 5070713 â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ c87a2d4 â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ 60013fe â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ 7a09a5b â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ 999d5e4 â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ ef2c87e â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ cbc3340 â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 27, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ 463fcc1 â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm â€¦ â€¦ ec28a1c â€¦kernel ( vllm-project#21193 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:33", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, lm_eval | PERF: TTFT, TTFT, TTFT | SERVING: vllm serve, vllm serve, Serving | TEST: Test, Test, test", "analysis_extracted_at": "2025-09-07 17:50:33", "models": ["Qwen/Qwen3-30B-A3B-FP8"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=Qwen/Qwen3-30B-A3B-FP8,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model Qwen/Qwen3-30B-A3B-FP8 --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm kernel (#21193)", "commit_message": "[Kernel][Performance] Tweak MoE Batched silu_mul_fp8_quant_deep_gemm kernel (#21193)\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>", "commit_date": "2025-07-18T23:09:51-07:00", "files_changed": ["vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 4, "num_edited_lines": 9, "num_non_test_edited_lines": 9, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py b/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py\nindex 628aa5c7b..3ccddb529 100644\n--- a/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py\n@@ -55,6 +55,7 @@ def _silu_mul_fp8_quant_deep_gemm(\n \n     # Meta ---------------------------------------------------------------\n     BLOCK: tl.constexpr,\n+    NUM_STAGES: tl.constexpr,\n ):\n     G = H // GROUP_SIZE\n \n@@ -73,8 +74,7 @@ def _silu_mul_fp8_quant_deep_gemm(\n     cols = cols.to(tl.int64)\n     mask_h = cols < BLOCK\n \n-    t = tl.zeros([], tl.int64)\n-    while t < n_tokens:\n+    for t in tl.range(0, n_tokens, num_stages=NUM_STAGES):\n         base_i_offset = (e * stride_i_e + t * stride_i_t +\n                          g * GROUP_SIZE * stride_i_h)\n         base_yq_offset = (e * stride_yq_e + t * stride_yq_t +\n@@ -102,8 +102,6 @@ def _silu_mul_fp8_quant_deep_gemm(\n         tl.store(y_q_ptr + base_yq_offset + cols * stride_yq_h, y_q, mask=mask)\n         tl.store(y_s_ptr + base_ys_offset, y_s)\n \n-        t += 1\n-\n \n def silu_mul_fp8_quant_deep_gemm(\n     y: torch.Tensor,  # (E, T, 2*H) float32\n@@ -180,7 +178,8 @@ def silu_mul_fp8_quant_deep_gemm(\n         fp8_max,\n         is_blackwell_deep_gemm_used(),\n         BLOCK=group_size,\n-        num_warps=4,\n+        NUM_STAGES=8,\n+        num_warps=1,\n     )\n \n     return y_q, y_s", "apis": ["vllm.model_executor.layers.fused_moe.batched_deep_gemm_moe.silu_mul_fp8_quant_deep_gemm", "vllm.model_executor.layers.fused_moe.batched_deep_gemm_moe.BatchedDeepGemmExperts.apply"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/batched_triton_or_deep_gemm_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/deep_gemm_moe.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies the file \"vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py\", which is a non-test source file, changing the looping structure from a while loop to a for-loop call to tl.range with a parameter NUM_STAGES, and adjusting function parameters (NUM_STAGES and num_warps). These changes appear to alter the performance characteristics of the MoE deep gemm kernel. Although the commit title mentions performance, the changes are non-trivial and intended to affect execution efficiency rather than a mere refactoring or bug fix. The modifications are applicable on CPU and affect a core computational kernel, meeting the criteria for performance optimization.", "llm_api_reason": "The commit changes the kernel code in batched_deep_gemm_moe.py. It modifies the lowâ€level silu_mul_fp8_quant_deep_gemm kernel by switching from a whileâ€‘loop to a forâ€‘loop using a new NUM_STAGES parameter and adjusts kernel launch parameters (NUM_STAGES and num_warps). Since the silu_mul_fp8_quant_deep_gemm function is the entry point for this fused quantization kernel and is used by the BatchedDeepGemmExperts class (specifically in its apply method), both become affected APIs by this performance tweak."}
{"commit_hash": "8a4e5c5f3c1d39e924e48a87c9cc6cf382aa3532", "pr_url": "https://github.com/vllm-project/vllm/pull/20906", "pr_date": "2025-07-17", "timeline_text": "Copy link Contributor Abatom commented Jul 14, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Enhance Performance and code readability for P2pNcclConnector, follow-up #18242 . The design document and user manual can be found in docs/design/v1/p2p_nccl_connector.md . The KVCache sender offloads the KVCache extraction and reshape operations to a dedicated sending thread, thereby reducing the load on the main thread and lowering the TTFT. Fix the issue of occasional garbled output when receiving a temporarily created empty tensor and ncclRecv are not in the same stream for \"GET\". Optimize the proxy so that when there are no active requests, instances P or D can be automatically removed. Handling abnormal crashes will be addressed in a follow-up PR; in PR [V1][P/D]Support automatic instance removal after crash for P2pNcclConnector #20006 I attempted to cover this scenario and found that removal is far more complex than scaling up. Resolving the P2pNcclConnector crash caused by PR [KVConnector] Aggregate finished requests on the scheduler #19555 . In PR [V1][P/D]Enhance Performance for P2pNcclConnector #20074 , I attempted to support asynchronous loading of the KV cache and release the KV cache after sending is completed; however, performance actually degraded. Once this PR is merged, I will revisit these two features on top of it. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Abatom added 8 commits July 13, 2025 22:57 reshape â€¦ 4c9bbfd Signed-off-by: Abatom <abzhonghua@gmail.com> Merge branch 'main' into send 6efd67d bool â€¦ 8144527 Signed-off-by: Abatom <abzhonghua@gmail.com> bool â€¦ 2f71a7d Signed-off-by: Abatom <abzhonghua@gmail.com> staticmethod â€¦ 31cff5c Signed-off-by: Abatom <abzhonghua@gmail.com> code readability â€¦ d3c9ee0 Signed-off-by: Abatom <abzhonghua@gmail.com> proxy â€¦ d72dfb9 Signed-off-by: Abatom <abzhonghua@gmail.com> mod doc â€¦ 8ed454d Signed-off-by: Abatom <abzhonghua@gmail.com> Abatom requested a review\n  from hmellor as a code owner July 14, 2025 07:07 mergify bot added\n  the documentation Improvements or additions to documentation label Jul 14, 2025 Copy link github-actions bot commented Jul 14, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gemini-code-assist bot reviewed Jul 14, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @Abatom , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request focuses on enhancing the performance and code readability of the P2pNcclConnector. It introduces optimizations to reduce main thread load, fixes a garbled output issue, and optimizes proxy resource management. Additionally, internal methods have been refactored to improve code quality. Highlights Performance Enhancement : Offloads KVCache extraction and reshape operations to a dedicated sending thread, reducing the load on the main thread and lowering TTFT. Bug Fix : Resolves an issue causing occasional garbled output when receiving a temporarily created empty tensor, ensuring ncclRecv operations are synchronized. Proxy Optimization : Improves proxy functionality by automatically removing P or D instances when there are no active requests, optimizing resource utilization. Code Modernization : Refactors internal methods to improve code readability and maintainability. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with ðŸ‘ and ðŸ‘Ž on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . â†© Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jul 14, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces significant performance and readability enhancements for the P2pNcclConnector . Key changes include offloading KVCache extraction to a dedicated sending thread, fixing a race condition with ncclRecv by ensuring operations are on the same CUDA stream, and implementing automatic cleanup of stale proxy instances. The refactoring of methods from private to public in p2p_nccl_engine.py also improves the API design. Overall, the changes are well-aligned with the PR's objectives. I've identified one critical bug related to a method rename that was missed, which would cause a runtime error. I've also included a few medium-severity suggestions to improve code clarity and maintainability. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Abatom added 10 commits July 14, 2025 15:21 have_sent_tensor_id â€¦ ca02a98 Signed-off-by: Abatom <abzhonghua@gmail.com> mod log â€¦ 4441b2c Signed-off-by: Abatom <abzhonghua@gmail.com> SendQueueItem â€¦ 8adac0c Signed-off-by: Abatom <abzhonghua@gmail.com> console â€¦ 416e6b7 Signed-off-by: Abatom <abzhonghua@gmail.com> console â€¦ 81b2f0b Signed-off-by: Abatom <abzhonghua@gmail.com> format â€¦ 847282b Signed-off-by: Abatom <abzhonghua@gmail.com> PUT_ASYNC â€¦ f97ecf9 Signed-off-by: Abatom <abzhonghua@gmail.com> mod doc â€¦ 5eb5edc Signed-off-by: Abatom <abzhonghua@gmail.com> format â€¦ b85043e Signed-off-by: Abatom <abzhonghua@gmail.com> SPDX â€¦ 8126ed0 Signed-off-by: Abatom <abzhonghua@gmail.com> Abatom changed the title [WIP][V1][P/D]Enhance Performance and code readability for P2pNcclConnector [V1][P/D]Enhance Performance and code readability for P2pNcclConnector Jul 14, 2025 Abatom added 5 commits July 15, 2025 16:45 mod doc â€¦ a5fcacd Signed-off-by: Abatom <abzhonghua@gmail.com> Merge branch 'main' into send 4256b01 no_compile_layers â€¦ 6af393a Signed-off-by: Abatom <abzhonghua@gmail.com> format â€¦ cd11f33 Signed-off-by: Abatom <abzhonghua@gmail.com> mod doc â€¦ 113993c Signed-off-by: Abatom <abzhonghua@gmail.com> KuntaiDu approved these changes Jul 16, 2025 View reviewed changes Copy link Collaborator KuntaiDu left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 Abatom reacted with heart emoji All reactions â¤ï¸ 1 reaction simon-mo added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 17, 2025 Hide details View details simon-mo merged commit 8a4e5c5 into vllm-project : main Jul 17, 2025 80 of 82 checks passed Uh oh! There was an error while loading. Please reload this page . hj-mistral pushed a commit\n        to hj-mistral/vllm\n      that referenced\n      this pull request Jul 19, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ cc76e0b vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ 2f0aa79 vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ aef48d4 vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ e9ea31d vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ be0e12d vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ e2e9f64 vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ a3af660 vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ e42182b vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ 65558a4 vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ f189c1c vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> Abatom mentioned this pull request Aug 22, 2025 [Bugfix][V1][P/D]Fix the issue where repeated requests for the same input produce abnormal outputs for P2pNcclConnector #23403 Merged 4 tasks epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 27, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ 67bdc76 vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [V1][P/D]Enhance Performance and code readability for P2pNcclConnector ( â€¦ bc17546 vllm-project#20906 )\n\nSigned-off-by: Abatom <abzhonghua@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:37", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, Optimization | SERVING: online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . examples/online_serving | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:50:37", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][P/D]Enhance Performance and code readability for P2pNcclConnector (#20906)", "commit_message": "[V1][P/D]Enhance Performance and code readability for P2pNcclConnector (#20906)\n\nSigned-off-by: Abatom <abzhonghua@gmail.com>", "commit_date": "2025-07-16T22:13:00-07:00", "files_changed": ["docs/design/v1/p2p_nccl_connector.md", "examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py", "vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_connector.py", "vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 4, "only_test_files": 0, "only_non_test_files": 1, "num_files": 4, "num_hunks": 48, "num_edited_lines": 522, "num_non_test_edited_lines": 522, "commit_year": 2025}, "diff_text": "diff --git a/docs/design/v1/p2p_nccl_connector.md b/docs/design/v1/p2p_nccl_connector.md\nindex b1df93cfc..8f6a2b3b2 100644\n--- a/docs/design/v1/p2p_nccl_connector.md\n+++ b/docs/design/v1/p2p_nccl_connector.md\n@@ -31,7 +31,7 @@ Each P/D instance periodically sends a heartbeat packet to the Proxy/Router (cur\n \n ## KV Cache Transfer Methods\n \n-There are three methods for KVcache transfer: PUT, GET, and PUT_ASYNC. These methods can be specified using the `--kv-transfer-config` and `kv_connector_extra_config` parameters, specifically through the `send_type` field. Both PUT and PUT_ASYNC involve the P instance actively sending KVcache to the D instance. The difference is that PUT is a synchronous transfer method that blocks the main process, while PUT_ASYNC is an asynchronous transfer method. PUT_ASYNC uses a dedicated thread for sending KVcache, which means it does not block the main process. In contrast, the GET method involves the P instance saving the KVcache to the memory buffer after computing the prefill. The D instance then actively retrieves the computed KVcache from the P instance once it has allocated space for the KVcache.\n+There are three methods for KVCache transfer: PUT, GET, and PUT_ASYNC. These methods can be specified using the `--kv-transfer-config` and `kv_connector_extra_config` parameters, specifically through the `send_type` field. Both PUT and PUT_ASYNC involve the P instance actively sending KVCache to the D instance. The difference is that PUT is a synchronous transfer method that blocks the main process, while PUT_ASYNC is an asynchronous transfer method. PUT_ASYNC uses a dedicated thread for sending KVCache, which means it does not block the main process. In contrast, the GET method involves the P instance saving the KVCache to the memory buffer after computing the prefill. The D instance then actively retrieves the computed KVCache from the P instance once it has allocated space for the KVCache.\n \n Experimental results have shown that the performance of these methods, from highest to lowest, is as follows: PUT_ASYNC â†’ GET â†’ PUT.\n \n@@ -39,13 +39,13 @@ Experimental results have shown that the performance of these methods, from high\n \n As long as the address of the counterpart is known, point-to-point KV cache transfer (using NCCL) can be performed, without being constrained by rank and world size. To support dynamic scaling (expansion and contraction) of instances with PD disaggregation. This means that adding or removing P/D instances does not require a full system restart.\n \n-Each P/D instance only needs to create a single `P2pNcclEngine` instance. This instance maintains a ZMQ Server, which runs a dedicated thread to listen on the `zmq_addr` address and receive control flow requests from other instances. These requests include requests to establish an NCCL connection and requests to send KVcache metadata (such as tensor shapes and data types). However, it does not actually transmit the KVcache data itself.\n+Each P/D instance only needs to create a single `P2pNcclEngine` instance. This instance maintains a ZMQ Server, which runs a dedicated thread to listen on the `zmq_addr` address and receive control flow requests from other instances. These requests include requests to establish an NCCL connection and requests to send KVCache metadata (such as tensor shapes and data types). However, it does not actually transmit the KVCache data itself.\n \n-When a P instance and a D instance transmit KVcache for the first time, they need to establish a ZMQ connection and an NCCL group. For subsequent KVcache transmissions, this ZMQ connection and NCCL group are reused. The NCCL group consists of only two ranks, meaning the world size is equal to 2. This design is intended to support dynamic scaling, which means that adding or removing P/D instances does not require a full system restart. As long as the address of the counterpart is known, point-to-point KVcache transmission can be performed, without being restricted by rank or world size.\n+When a P instance and a D instance transmit KVCache for the first time, they need to establish a ZMQ connection and an NCCL group. For subsequent KVCache transmissions, this ZMQ connection and NCCL group are reused. The NCCL group consists of only two ranks, meaning the world size is equal to 2. This design is intended to support dynamic scaling, which means that adding or removing P/D instances does not require a full system restart. As long as the address of the counterpart is known, point-to-point KVCache transmission can be performed, without being restricted by rank or world size.\n \n ## NCCL Group Topology\n \n-Currently, only symmetric TP (Tensor Parallelism) methods are supported for KVcache transmission. Asymmetric TP and PP (Pipeline Parallelism) methods will be supported in the future. Figure 2 illustrates the 1P2D setup, where each instance has a TP (Tensor Parallelism) degree of 2. There are a total of 7 NCCL groups: three vLLM instances each have one NCCL group with TP=2. Additionally, the 0th GPU card of the P instance establishes an NCCL group with the 0th GPU card of each D instance. Similarly, the 1st GPU card of the P instance establishes an NCCL group with the 1st GPU card of each D instance.\n+Currently, only symmetric TP (Tensor Parallelism) methods are supported for KVCache transmission. Asymmetric TP and PP (Pipeline Parallelism) methods will be supported in the future. Figure 2 illustrates the 1P2D setup, where each instance has a TP (Tensor Parallelism) degree of 2. There are a total of 7 NCCL groups: three vLLM instances each have one NCCL group with TP=2. Additionally, the 0th GPU card of the P instance establishes an NCCL group with the 0th GPU card of each D instance. Similarly, the 1st GPU card of the P instance establishes an NCCL group with the 1st GPU card of each D instance.\n \n ![image2](https://github.com/user-attachments/assets/837e61d6-365e-4cbf-8640-6dd7ab295b36)\n \n@@ -53,32 +53,18 @@ Each NCCL group occupies a certain amount of GPU memory buffer for communication\n \n ## GPU Memory Buffer and Tensor Memory Pool\n \n-The trade-off in the size of the memory buffer is as follows: For P instances, the memory buffer is not required in PUT and PUT_ASYNC modes, but it is necessary in GET mode. For D instances, a memory buffer is needed in all three modes. The memory buffer for D instances should not be too large. Similarly, for P instances in GET mode, the memory buffer should also not be too large. The memory buffer of D instances is used to temporarily store KVcache sent by P instances. If it is too large, it will reduce the KVcache space available for normal inference by D instances, thereby decreasing the inference batch size and ultimately leading to a reduction in output throughput. The size of the memory buffer is configured by the parameter `kv_buffer_size`, measured in bytes, and is typically set to 5%ï½ž10% of the memory size.\n+The trade-off in the size of the memory buffer is as follows: For P instances, the memory buffer is not required in PUT and PUT_ASYNC modes, but it is necessary in GET mode. For D instances, a memory buffer is needed in all three modes. The memory buffer for D instances should not be too large. Similarly, for P instances in GET mode, the memory buffer should also not be too large. The memory buffer of D instances is used to temporarily store KVCache sent by P instances. If it is too large, it will reduce the KVCache space available for normal inference by D instances, thereby decreasing the inference batch size and ultimately leading to a reduction in output throughput. The size of the memory buffer is configured by the parameter `kv_buffer_size`, measured in bytes, and is typically set to 5%ï½ž10% of the memory size.\n \n-If the `--max-num-seqs` parameter for P instances is set to a large value, due to the large batch size, P instances will generate a large amount of KVcache simultaneously. This may exceed the capacity of the memory buffer of D instances, resulting in KVcache loss. Once KVcache is lost, D instances need to recompute Prefill, which is equivalent to performing Prefill twice. Consequently, the time-to-first-token (TTFT) will significantly increase, leading to degraded performance.\n+If the `--max-num-seqs` parameter for P instances is set to a large value, due to the large batch size, P instances will generate a large amount of KVCache simultaneously. This may exceed the capacity of the memory buffer of D instances, resulting in KVCache loss. Once KVCache is lost, D instances need to recompute Prefill, which is equivalent to performing Prefill twice. Consequently, the time-to-first-token (TTFT) will significantly increase, leading to degraded performance.\n \n-To address the above issues, I have designed and developed a local Tensor memory pool for storing KVcache, inspired by the buddy system used in Linux memory modules. Since the memory is sufficiently large, typically in the TB range on servers, there is no need to consider prefix caching or using block-based designs to reuse memory, thereby saving space. When the memory buffer is insufficient, KVcache can be directly stored in the Tensor memory pool, and D instances can subsequently retrieve KVcache from it. The read and write speed is that of PCIe, with PCIe 4.0 having a speed of approximately 21 GB/s, which is usually faster than the Prefill speed. Otherwise, solutions like Mooncake and lmcache would not be necessary. The Tensor memory pool acts as a flood diversion area, typically unused except during sudden traffic surges. In the worst-case scenario, my solution performs no worse than the normal situation with a Cache store.\n+To address the above issues, I have designed and developed a local Tensor memory pool for storing KVCache, inspired by the buddy system used in Linux memory modules. Since the memory is sufficiently large, typically in the TB range on servers, there is no need to consider prefix caching or using block-based designs to reuse memory, thereby saving space. When the memory buffer is insufficient, KVCache can be directly stored in the Tensor memory pool, and D instances can subsequently retrieve KVCache from it. The read and write speed is that of PCIe, with PCIe 4.0 having a speed of approximately 21 GB/s, which is usually faster than the Prefill speed. Otherwise, solutions like Mooncake and lmcache would not be necessary. The Tensor memory pool acts as a flood diversion area, typically unused except during sudden traffic surges. In the worst-case scenario, my solution performs no worse than the normal situation with a Cache store.\n \n # Install vLLM\n \n ??? console \"Commands\"\n \n     ```shell\n-    # Enter the home directory or your working directory.\n-    cd /home\n-\n-    # Download the installation package, and I will update the commit-id in time. You can directly copy the command.\n-    wget https://vllm-wheels.s3.us-west-2.amazonaws.com/9112b443a042d8d815880b8780633882ad32b183/vllm-1.0.0.dev-cp38-abi3-manylinux1_x86_64.whl\n-\n-    # Download the code repository.\n-    git clone -b xpyd-v1 https://github.com/Abatom/vllm.git\n-    cd vllm\n-\n-    # Set the installation package path.\n-    export VLLM_PRECOMPILED_WHEEL_LOCATION=/home/vllm-1.0.0.dev-cp38-abi3-manylinux1_x86_64.whl\n-\n-    # installation\n-    pip install -e . -v\n+    pip install \"vllm>=0.9.2\"\n     ```\n \n # Run xPyD\n@@ -90,7 +76,7 @@ To address the above issues, I have designed and developed a local Tensor memory\n - You may need to modify the `kv_buffer_size` and `port` in the following commands (if there is a conflict).\n - `PUT_ASYNC` offers the best performance and should be prioritized.\n - The `--port` must be consistent with the `http_port` in the `--kv-transfer-config`.\n-- The `disagg_prefill_proxy_xpyd.py` script will use port 10001 (for receiving client requests) and port 30001 (for receiving service discovery from P and D instances).\n+- The `disagg_proxy_p2p_nccl_xpyd.py` script will use port 10001 (for receiving client requests) and port 30001 (for receiving service discovery from P and D instances).\n - The node running the proxy must have `quart` installed.\n - Supports multiple nodes; you just need to modify the `proxy_ip` and `proxy_port` in `--kv-transfer-config`.\n - In the following examples, it is assumed that **the proxy's IP is 10.0.1.1**.\n@@ -100,8 +86,8 @@ To address the above issues, I have designed and developed a local Tensor memory\n ### Proxy (e.g. 10.0.1.1)\n \n ```shell\n-cd {your vllm directory}/examples/online_serving/disagg_xpyd/\n-python3 disagg_prefill_proxy_xpyd.py &\n+cd {your vllm directory}/examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/\n+python3 disagg_proxy_p2p_nccl_xpyd.py &\n ```\n \n ### Prefill1 (e.g. 10.0.1.2 or 10.0.1.1)\n@@ -111,7 +97,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n     ```shell\n     VLLM_USE_V1=1 CUDA_VISIBLE_DEVICES=0 vllm serve {your model directory} \\\n         --host 0.0.0.0 \\\n-        --port 20005 \\\n+        --port 20001 \\\n         --tensor-parallel-size 1 \\\n         --seed 1024 \\\n         --served-model-name base_model \\\n@@ -123,7 +109,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.9 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"21001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20005\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"21001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20001\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n ### Decode1 (e.g. 10.0.1.3 or 10.0.1.1)\n@@ -133,7 +119,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n     ```shell\n     VLLM_USE_V1=1 CUDA_VISIBLE_DEVICES=1 vllm serve {your model directory} \\\n         --host 0.0.0.0 \\\n-        --port 20009 \\\n+        --port 20002 \\\n         --tensor-parallel-size 1 \\\n         --seed 1024 \\\n         --served-model-name base_model \\\n@@ -145,7 +131,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.7 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"22001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20009\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"22001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20002\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n ### Decode2 (e.g. 10.0.1.4 or 10.0.1.1)\n@@ -167,7 +153,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.7 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"23001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20003\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"23001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20003\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n ### Decode3 (e.g. 10.0.1.5 or 10.0.1.1)\n@@ -177,7 +163,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n     ```shell\n     VLLM_USE_V1=1 CUDA_VISIBLE_DEVICES=3 vllm serve {your model directory} \\\n         --host 0.0.0.0 \\\n-        --port 20008 \\\n+        --port 20004 \\\n         --tensor-parallel-size 1 \\\n         --seed 1024 \\\n         --served-model-name base_model \\\n@@ -189,7 +175,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.7 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"24001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20008\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"24001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20004\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n ## Run 3P1D\n@@ -197,8 +183,8 @@ python3 disagg_prefill_proxy_xpyd.py &\n ### Proxy (e.g. 10.0.1.1)\n \n ```shell\n-cd {your vllm directory}/examples/online_serving/disagg_xpyd/\n-python3 disagg_prefill_proxy_xpyd.py &\n+cd {your vllm directory}/examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/\n+python3 disagg_proxy_p2p_nccl_xpyd.py &\n ```\n \n ### Prefill1 (e.g. 10.0.1.2 or 10.0.1.1)\n@@ -208,7 +194,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n     ```shell\n     VLLM_USE_V1=1 CUDA_VISIBLE_DEVICES=0 vllm serve {your model directory} \\\n         --host 0.0.0.0 \\\n-        --port 20005 \\\n+        --port 20001 \\\n         --tensor-parallel-size 1 \\\n         --seed 1024 \\\n         --served-model-name base_model \\\n@@ -220,7 +206,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.9 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"21001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20005\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"21001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20001\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n ### Prefill2 (e.g. 10.0.1.3 or 10.0.1.1)\n@@ -230,7 +216,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n     ```shell\n     VLLM_USE_V1=1 CUDA_VISIBLE_DEVICES=1 vllm serve {your model directory} \\\n         --host 0.0.0.0 \\\n-        --port 20009 \\\n+        --port 20002 \\\n         --tensor-parallel-size 1 \\\n         --seed 1024 \\\n         --served-model-name base_model \\\n@@ -242,7 +228,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.9 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"22001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20009\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"22001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20002\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n ### Prefill3 (e.g. 10.0.1.4 or 10.0.1.1)\n@@ -264,7 +250,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.9 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"23001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20003\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_producer\",\"kv_buffer_size\":\"1e1\",\"kv_port\":\"23001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20003\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n ### Decode1 (e.g. 10.0.1.5 or 10.0.1.1)\n@@ -274,7 +260,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n     ```shell\n     VLLM_USE_V1=1 CUDA_VISIBLE_DEVICES=3 vllm serve {your model directory} \\\n         --host 0.0.0.0 \\\n-        --port 20008 \\\n+        --port 20004 \\\n         --tensor-parallel-size 1 \\\n         --seed 1024 \\\n         --served-model-name base_model \\\n@@ -286,7 +272,7 @@ python3 disagg_prefill_proxy_xpyd.py &\n         --gpu-memory-utilization 0.7 \\\n         --disable-log-request \\\n         --kv-transfer-config \\\n-        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"24001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20008\",\"send_type\":\"PUT_ASYNC\",\"nccl_num_channels\":\"16\"}}' > /var/vllm.log 2>&1 &\n+        '{\"kv_connector\":\"P2pNcclConnector\",\"kv_role\":\"kv_consumer\",\"kv_buffer_size\":\"8e9\",\"kv_port\":\"24001\",\"kv_connector_extra_config\":{\"proxy_ip\":\"10.0.1.1\",\"proxy_port\":\"30001\",\"http_port\":\"20004\"}}' > /var/vllm.log 2>&1 &\n     ```\n \n # Single request\n@@ -334,24 +320,6 @@ pgrep python | xargs kill -9 && pkill -f python\n \n # Test data\n \n-## **Scenario 1**: 1K input & 1K output tokens, E2E P99 latency ~20s\n-- **1P5D (6Ã—A800) vs vLLM (1Ã—A800)**:\n-  - Throughput â†‘7.2% (1085 â†’ 6979/6)\n-  - ITL (P99) â†“81.3% (120ms â†’ 22.9ms)\n-  - TTFT (P99) â†‘26.8% (175ms â†’ 222ms)\n-  - TPOT: No change\n-\n-- **1P6D (7Ã—A800) vs vLLM (1Ã—A800)**:\n-  - Throughput â†‘9.6% (1085 â†’ 8329/7)\n-  - ITL (P99) â†“81.0% (120ms â†’ 22.7ms)\n-  - TTFT (P99) â†‘210% (175ms â†’543ms)\n-  - TPOT: No change\n-\n-## **Scenario 2**: 1K input & 200 output tokens, E2E P99 latency ~4s\n-- **1P1D (2Ã—A800) vs vLLM (1Ã—A800)**:\n-  - Throughput â†‘37.4% (537 â†’ 1476/2)\n-  - ITL (P99) â†“81.8% (127ms â†’ 23.1ms)\n-  - TTFT (P99) â†‘41.8% (160ms â†’ 227ms)\n-  - TPOT: No change\n-\n-![testdata](https://github.com/user-attachments/assets/f791bfc7-9f3d-4e5c-9171-a42f9f4da627)\n+## **Scenario**: 1K input & 200 output tokens, E2E P99 latency ~2s\n+\n+![testdata](https://github.com/user-attachments/assets/cef0953b-4567-4bf9-b940-405b92a28eb1)\ndiff --git a/examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py b/examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py\nindex 4e82424d6..ec58a1830 100644\n--- a/examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py\n+++ b/examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py\n@@ -4,7 +4,9 @@\n import os\n import socket\n import threading\n+import time\n import uuid\n+from typing import Any\n \n import aiohttp\n import msgpack\n@@ -12,12 +14,25 @@ import zmq\n from quart import Quart, make_response, request\n \n count = 0\n-prefill_instances: dict[str, str] = {}  # http_address: zmq_address\n-decode_instances: dict[str, str] = {}  # http_address: zmq_address\n+prefill_instances: dict[str, Any] = {}  # http_address: (zmq_address, stamp)\n+decode_instances: dict[str, Any] = {}  # http_address: (zmq_address, stamp)\n \n prefill_cv = threading.Condition()\n decode_cv = threading.Condition()\n \n+DEFAULT_PING_SECONDS = 5\n+\n+\n+def _remove_oldest_instances(instances: dict[str, Any]) -> None:\n+    oldest_key = next(iter(instances), None)\n+    while oldest_key is not None:\n+        value = instances[oldest_key]\n+        if value[1] > time.time():\n+            break\n+        print(f\"ðŸ”´Remove [HTTP:{oldest_key}, ZMQ:{value[0]}, stamp:{value[1]}]\")\n+        instances.pop(oldest_key, None)\n+        oldest_key = next(iter(instances), None)\n+\n \n def _listen_for_register(poller, router_socket):\n     while True:\n@@ -31,12 +46,23 @@ def _listen_for_register(poller, router_socket):\n                 global prefill_instances\n                 global prefill_cv\n                 with prefill_cv:\n-                    prefill_instances[data[\"http_address\"]] = data[\"zmq_address\"]\n+                    node = prefill_instances.pop(data[\"http_address\"], None)\n+                    prefill_instances[data[\"http_address\"]] = (\n+                        data[\"zmq_address\"],\n+                        time.time() + DEFAULT_PING_SECONDS,\n+                    )\n+                    _remove_oldest_instances(prefill_instances)\n+\n             elif data[\"type\"] == \"D\":\n                 global decode_instances\n                 global decode_cv\n                 with decode_cv:\n-                    decode_instances[data[\"http_address\"]] = data[\"zmq_address\"]\n+                    node = decode_instances.pop(data[\"http_address\"], None)\n+                    decode_instances[data[\"http_address\"]] = (\n+                        data[\"zmq_address\"],\n+                        time.time() + DEFAULT_PING_SECONDS,\n+                    )\n+                    _remove_oldest_instances(decode_instances)\n             else:\n                 print(\n                     \"Unexpected, Received message from %s, data: %s\",\n@@ -44,6 +70,9 @@ def _listen_for_register(poller, router_socket):\n                     data,\n                 )\n \n+            if node is None:\n+                print(f\"ðŸ”µAdd [HTTP:{data['http_address']}, ZMQ:{data['zmq_address']}]\")\n+\n \n def start_service_discovery(hostname, port):\n     if not hostname:\n@@ -105,12 +134,14 @@ async def handle_request():\n         with prefill_cv:\n             prefill_list = list(prefill_instances.items())\n             prefill_addr, prefill_zmq_addr = prefill_list[count % len(prefill_list)]\n+            prefill_zmq_addr = prefill_zmq_addr[0]\n \n         global decode_instances\n         global decode_cv\n         with decode_cv:\n             decode_list = list(decode_instances.items())\n             decode_addr, decode_zmq_addr = decode_list[count % len(decode_list)]\n+            decode_zmq_addr = decode_zmq_addr[0]\n \n         print(\n             f\"handle_request count: {count}, [HTTP:{prefill_addr}, \"\ndiff --git a/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_connector.py b/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_connector.py\nindex 52f589a6d..d47a75461 100644\n--- a/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_connector.py\n+++ b/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_connector.py\n@@ -13,7 +13,6 @@ from vllm.distributed.kv_transfer.kv_connector.v1.base import (\n from vllm.distributed.kv_transfer.kv_connector.v1.p2p.p2p_nccl_engine import (\n     P2pNcclEngine)\n from vllm.distributed.parallel_state import get_world_group\n-from vllm.forward_context import get_forward_context\n from vllm.logger import init_logger\n from vllm.v1.attention.backends.mla.common import MLACommonMetadata\n from vllm.v1.core.sched.output import SchedulerOutput\n@@ -238,32 +237,16 @@ class P2pNcclConnector(KVConnectorBase_V1):\n \n         assert self.p2p_nccl_engine is not None\n \n-        def extract_kv_from_layer(\n-            layer: torch.Tensor,\n-            slot_mapping: torch.Tensor,\n-        ) -> torch.Tensor:\n-            \"\"\"Extract the KV cache from the layer.\n-\n-            Assume the shape of the layer is (2, num_pages, page_size, xxx)\n-            if MLA is not used, and (num_pages, page_size, xxx) otherwise.\n-            \"\"\"\n-            if isinstance(attn_metadata, MLACommonMetadata):\n-                num_pages, page_size = layer.shape[0], layer.shape[1]\n-                return layer.reshape(num_pages * page_size, -1)[slot_mapping,\n-                                                                ...]\n-            num_pages, page_size = layer.shape[1], layer.shape[2]\n-            return layer.reshape(2, num_pages * page_size, -1)[:, slot_mapping,\n-                                                               ...]\n-\n         connector_metadata = self._get_connector_metadata()\n         assert isinstance(connector_metadata, P2pNcclConnectorMetadata)\n         for request in connector_metadata.requests:\n             request_id = request.request_id\n             ip, port = self.parse_request_id(request_id, True)\n             remote_address = ip + \":\" + str(port + self._rank)\n-            kv_cache = extract_kv_from_layer(kv_layer, request.slot_mapping)\n-            self.p2p_nccl_engine.send_tensor(request_id + \"#\" + layer_name,\n-                                             kv_cache, remote_address)\n+            self.p2p_nccl_engine.send_tensor(\n+                request_id + \"#\" + layer_name, kv_layer, remote_address,\n+                request.slot_mapping,\n+                isinstance(attn_metadata, MLACommonMetadata))\n \n     def wait_for_save(self):\n         if self.is_producer:\n@@ -286,9 +269,10 @@ class P2pNcclConnector(KVConnectorBase_V1):\n \n         assert self.p2p_nccl_engine is not None\n \n-        forward_context: ForwardContext = get_forward_context()\n+        no_compile_layers = (\n+            self._vllm_config.compilation_config.static_forward_context)\n         return self.p2p_nccl_engine.get_finished(finished_req_ids,\n-                                                 forward_context)\n+                                                 no_compile_layers)\n \n     # ==============================\n     # Scheduler-side methods\n@@ -418,14 +402,6 @@ class P2pNcclConnector(KVConnectorBase_V1):\n                                  block_ids=block_ids,\n                                  block_size=self._block_size)\n \n-        # Requests loaded asynchronously are not in the scheduler_output.\n-        # for request_id in self._requests_need_load:\n-        #     request, block_ids = self._requests_need_load[request_id]\n-        #     meta.add_request(request_id=request.request_id,\n-        #                      token_ids=request.prompt_token_ids,\n-        #                      block_ids=block_ids,\n-        #                      block_size=self._block_size)\n-\n         self._requests_need_load.clear()\n         return meta\n \ndiff --git a/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py b/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py\nindex 6c9ccb2e3..b94f2296d 100644\n--- a/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py\n+++ b/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py\n@@ -8,7 +8,8 @@ import time\n import typing\n from collections import deque\n from contextlib import contextmanager\n-from typing import TYPE_CHECKING, Any, Optional\n+from dataclasses import dataclass\n+from typing import Any, Optional\n \n import msgpack\n import torch\n@@ -21,9 +22,6 @@ from vllm.distributed.kv_transfer.kv_connector.v1.p2p.tensor_memory_pool import\n     TensorMemoryPool)\n from vllm.utils import current_stream, get_ip\n \n-if TYPE_CHECKING:\n-    from vllm.forward_context import ForwardContext\n-\n logger = logging.getLogger(__name__)\n \n DEFAULT_MEM_POOL_SIZE_GB = 32\n@@ -59,6 +57,15 @@ def set_p2p_nccl_context(num_channels: str):\n                 os.environ.pop(var, None)\n \n \n+@dataclass\n+class SendQueueItem:\n+    tensor_id: str\n+    remote_address: str\n+    tensor: torch.Tensor\n+    slot_mapping: torch.Tensor\n+    is_mla: bool\n+\n+\n class P2pNcclEngine:\n \n     def __init__(self,\n@@ -112,24 +119,26 @@ class P2pNcclEngine:\n         self.send_stream = torch.cuda.Stream()\n         self.recv_stream = torch.cuda.Stream()\n \n-        mem_pool_size_gb = self.config.get_from_extra_config(\n-            \"mem_pool_size_gb\", DEFAULT_MEM_POOL_SIZE_GB)\n-        self.pool = TensorMemoryPool(max_block_size=int(mem_pool_size_gb) *\n-                                     1024**3)  # GB\n+        mem_pool_size_gb = float(\n+            self.config.get_from_extra_config(\"mem_pool_size_gb\",\n+                                              DEFAULT_MEM_POOL_SIZE_GB))\n+        self.pool = TensorMemoryPool(max_block_size=int(mem_pool_size_gb *\n+                                                        1024**3))  # GB\n \n         # The sending type includes tree mutually exclusive options:\n         # PUT, GET, PUT_ASYNC.\n-        self.send_type = self.config.get_from_extra_config(\"send_type\", \"PUT\")\n+        self.send_type = self.config.get_from_extra_config(\n+            \"send_type\", \"PUT_ASYNC\")\n         if self.send_type == \"GET\":\n             # tensor_id: torch.Tensor\n             self.send_store: dict[str, torch.Tensor] = {}\n         else:\n             # PUT or PUT_ASYNC\n             # tensor_id: torch.Tensor\n-            self.send_queue: deque[list[Any]] = deque()\n+            self.send_queue: deque[SendQueueItem] = deque()\n             self.send_request_id_to_tensor_ids: dict[str, set[str]] = {}\n             if self.send_type == \"PUT_ASYNC\":\n-                self._send_thread = threading.Thread(target=self._send_async,\n+                self._send_thread = threading.Thread(target=self.send_async,\n                                                      daemon=True)\n                 self._send_thread.start()\n \n@@ -146,13 +155,12 @@ class P2pNcclEngine:\n             \"nccl_num_channels\", \"8\")\n \n         self._listener_thread = threading.Thread(\n-            target=self._listen_for_requests, daemon=True)\n+            target=self.listen_for_requests, daemon=True)\n         self._listener_thread.start()\n \n         self._ping_thread = None\n         if port_offset == 0 and self.proxy_address != \"\":\n-            self._ping_thread = threading.Thread(target=self._ping,\n-                                                 daemon=True)\n+            self._ping_thread = threading.Thread(target=self.ping, daemon=True)\n             self._ping_thread.start()\n \n         logger.info(\n@@ -162,7 +170,7 @@ class P2pNcclEngine:\n             self.http_address, self.zmq_address, self.proxy_address,\n             self.send_type, self.buffer_size_threshold, self.nccl_num_channels)\n \n-    def _create_connect(self, remote_address: typing.Optional[str] = None):\n+    def create_connect(self, remote_address: typing.Optional[str] = None):\n         assert remote_address is not None\n         if remote_address not in self.socks:\n             sock = self.context.socket(zmq.DEALER)\n@@ -184,7 +192,7 @@ class P2pNcclEngine:\n                     comm: ncclComm_t = self.nccl.ncclCommInitRank(\n                         2, unique_id, rank)\n                 self.comms[remote_address] = (comm, rank)\n-                logger.info(\"ðŸ¤ncclCommInitRank Success, %sðŸ‘‰%s, MyRank: %s\",\n+                logger.info(\"ðŸ¤ncclCommInitRank Success, %sðŸ‘‰%s, MyRank:%s\",\n                             self.zmq_address, remote_address, rank)\n \n         return self.socks[remote_address], self.comms[remote_address]\n@@ -194,44 +202,54 @@ class P2pNcclEngine:\n         tensor_id: str,\n         tensor: torch.Tensor,\n         remote_address: typing.Optional[str] = None,\n+        slot_mapping: torch.Tensor = None,\n+        is_mla: bool = False,\n     ) -> bool:\n         if remote_address is None:\n             with self.recv_store_cv:\n                 self.recv_store[tensor_id] = tensor\n                 self.recv_store_cv.notify()\n             return True\n-        else:\n-            if self.send_type == \"PUT\":\n-                return self._send_sync(tensor_id, tensor, remote_address)\n-            elif self.send_type == \"PUT_ASYNC\":\n-                with self.send_queue_cv:\n-                    self.send_queue.append([tensor_id, remote_address, tensor])\n-                    self.send_queue_cv.notify()\n-            else:  # GET\n-                with self.send_store_cv:\n-                    tensor_size = tensor.element_size() * tensor.numel()\n-                    while (self.buffer_size + tensor_size\n-                           > self.buffer_size_threshold):\n-                        oldest_tenser_id = next(iter(self.send_store))\n-                        oldest_tenser = self.send_store.pop(oldest_tenser_id)\n-                        oldest_tenser_size = oldest_tenser.element_size(\n-                        ) * oldest_tenser.numel()\n-                        self.buffer_size -= oldest_tenser_size\n-                        logger.info(\n-                            \"â›”[GET]Send to %s, tensor_id:%s, tensor_size:%d,\"\n-                            \" buffer_size:%d, oldest_tenser_size:%d, rank:%d\",\n-                            remote_address, tensor_id, tensor_size,\n-                            self.buffer_size, oldest_tenser_size, self.rank)\n-\n-                    self.send_store[tensor_id] = tensor\n-                    self.buffer_size += tensor_size\n-                    logger.debug(\n-                        \"ðŸ”µ[GET]Send to %s, tensor_id:%s, tensor_size:%d, \"\n-                        \"shape:%s, rank:%d, buffer_size:%d(%.2f%%)\",\n-                        remote_address, tensor_id, tensor_size, tensor.shape,\n-                        self.rank, self.buffer_size,\n-                        self.buffer_size / self.buffer_size_threshold * 100)\n \n+        item = SendQueueItem(tensor_id=tensor_id,\n+                             remote_address=remote_address,\n+                             tensor=tensor,\n+                             slot_mapping=slot_mapping,\n+                             is_mla=is_mla)\n+\n+        if self.send_type == \"PUT\":\n+            return self.send_sync(item)\n+\n+        if self.send_type == \"PUT_ASYNC\":\n+            with self.send_queue_cv:\n+                self.send_queue.append(item)\n+                self.send_queue_cv.notify()\n+            return True\n+\n+        # GET\n+        with self.send_store_cv:\n+            tensor_size = tensor.element_size() * tensor.numel()\n+            while (self.buffer_size + tensor_size\n+                   > self.buffer_size_threshold):\n+                oldest_tenser_id = next(iter(self.send_store))\n+                oldest_tenser = self.send_store.pop(oldest_tenser_id)\n+                oldest_tenser_size = oldest_tenser.element_size(\n+                ) * oldest_tenser.numel()\n+                self.buffer_size -= oldest_tenser_size\n+                logger.info(\n+                    \"â›”[GET]Send to %s, tensor_id:%s, tensor_size:%d,\"\n+                    \" buffer_size:%d, oldest_tenser_size:%d, rank:%d\",\n+                    remote_address, tensor_id, tensor_size, self.buffer_size,\n+                    oldest_tenser_size, self.rank)\n+\n+            self.send_store[tensor_id] = tensor\n+            self.buffer_size += tensor_size\n+            logger.debug(\n+                \"ðŸ”µ[GET]Send to %s, tensor_id:%s, tensor_size:%d, \"\n+                \"shape:%s, rank:%d, buffer_size:%d(%.2f%%)\", remote_address,\n+                tensor_id, tensor_size, tensor.shape, self.rank,\n+                self.buffer_size,\n+                self.buffer_size / self.buffer_size_threshold * 100)\n         return True\n \n     def recv_tensor(\n@@ -267,7 +285,7 @@ class P2pNcclEngine:\n             return None\n \n         if remote_address not in self.socks:\n-            self._create_connect(remote_address)\n+            self.create_connect(remote_address)\n \n         sock = self.socks[remote_address]\n         comm, rank = self.comms[remote_address]\n@@ -282,121 +300,121 @@ class P2pNcclEngine:\n                            remote_address, tensor_id, data[\"ret\"])\n             return None\n \n-        tensor = torch.empty(data[\"shape\"],\n-                             dtype=getattr(torch, data[\"dtype\"]),\n-                             device=self.device)\n+        with torch.cuda.stream(self.recv_stream):\n+            tensor = torch.empty(data[\"shape\"],\n+                                 dtype=getattr(torch, data[\"dtype\"]),\n+                                 device=self.device)\n \n-        self._recv(comm, tensor, rank ^ 1, self.recv_stream)\n+        self.recv(comm, tensor, rank ^ 1, self.recv_stream)\n \n         return tensor\n \n-    def _listen_for_requests(self):\n+    def listen_for_requests(self):\n         while True:\n             socks = dict(self.poller.poll())\n-            if self.router_socket in socks:\n-                remote_address, message = self.router_socket.recv_multipart()\n-                data = msgpack.loads(message)\n-                if data[\"cmd\"] == \"NEW\":\n-                    unique_id = self.nccl.unique_id_from_bytes(\n-                        bytes(data[\"unique_id\"]))\n-                    with torch.cuda.device(self.device):\n-                        rank = 1\n-                        with set_p2p_nccl_context(self.nccl_num_channels):\n-                            comm: ncclComm_t = self.nccl.ncclCommInitRank(\n-                                2, unique_id, rank)\n-                        self.comms[remote_address.decode()] = (comm, rank)\n-                        logger.info(\n-                            \"ðŸ¤ncclCommInitRank Success, %sðŸ‘ˆ%s, MyRank:%s\",\n-                            self.zmq_address, remote_address.decode(), rank)\n-                elif data[\"cmd\"] == \"PUT\":\n-                    tensor_id = data[\"tensor_id\"]\n-                    try:\n-                        with torch.cuda.stream(self.recv_stream):\n-                            tensor = torch.empty(data[\"shape\"],\n-                                                 dtype=getattr(\n-                                                     torch, data[\"dtype\"]),\n-                                                 device=self.device)\n-                        self.router_socket.send_multipart(\n-                            [remote_address, b\"0\"])\n-                        comm, rank = self.comms[remote_address.decode()]\n-                        self._recv(comm, tensor, rank ^ 1, self.recv_stream)\n-                        tensor_size = tensor.element_size() * tensor.numel()\n-                        if (self.buffer_size + tensor_size\n-                                > self.buffer_size_threshold):\n-                            # Store Tensor in memory pool\n-                            addr = self.pool.store_tensor(tensor)\n-                            tensor = (addr, tensor.dtype, tensor.shape)\n-                            logger.warning(\n-                                \"ðŸ”´[PUT]Recv Tensor, Out Of Threshold, \"\n-                                \"%sðŸ‘ˆ%s, data:%s, addr:%d\", self.zmq_address,\n-                                remote_address.decode(), data, addr)\n-                        else:\n-                            self.buffer_size += tensor_size\n-\n-                    except torch.cuda.OutOfMemoryError:\n-                        self.router_socket.send_multipart(\n-                            [remote_address, b\"1\"])\n-                        tensor = None\n+            if self.router_socket not in socks:\n+                continue\n+\n+            remote_address, message = self.router_socket.recv_multipart()\n+            data = msgpack.loads(message)\n+            if data[\"cmd\"] == \"NEW\":\n+                unique_id = self.nccl.unique_id_from_bytes(\n+                    bytes(data[\"unique_id\"]))\n+                with torch.cuda.device(self.device):\n+                    rank = 1\n+                    with set_p2p_nccl_context(self.nccl_num_channels):\n+                        comm: ncclComm_t = self.nccl.ncclCommInitRank(\n+                            2, unique_id, rank)\n+                    self.comms[remote_address.decode()] = (comm, rank)\n+                    logger.info(\"ðŸ¤ncclCommInitRank Success, %sðŸ‘ˆ%s, MyRank:%s\",\n+                                self.zmq_address, remote_address.decode(),\n+                                rank)\n+            elif data[\"cmd\"] == \"PUT\":\n+                tensor_id = data[\"tensor_id\"]\n+                try:\n+                    with torch.cuda.stream(self.recv_stream):\n+                        tensor = torch.empty(data[\"shape\"],\n+                                             dtype=getattr(\n+                                                 torch, data[\"dtype\"]),\n+                                             device=self.device)\n+                    self.router_socket.send_multipart([remote_address, b\"0\"])\n+                    comm, rank = self.comms[remote_address.decode()]\n+                    self.recv(comm, tensor, rank ^ 1, self.recv_stream)\n+                    tensor_size = tensor.element_size() * tensor.numel()\n+                    if (self.buffer_size + tensor_size\n+                            > self.buffer_size_threshold):\n+                        # Store Tensor in memory pool\n+                        addr = self.pool.store_tensor(tensor)\n+                        tensor = (addr, tensor.dtype, tensor.shape)\n                         logger.warning(\n-                            \"ðŸ”´[PUT]Recv Tensor, Out Of Memory, %sðŸ‘ˆ%s, \"\n-                            \"data:%s\", self.zmq_address,\n-                            remote_address.decode(), data)\n-\n-                    with self.recv_store_cv:\n-                        self.recv_store[tensor_id] = tensor\n-                        self._have_received_tensor_id(tensor_id)\n-                        self.recv_store_cv.notify()\n-\n-                elif data[\"cmd\"] == \"GET\":\n-                    tensor_id = data[\"tensor_id\"]\n-                    with self.send_store_cv:\n-                        tensor = self.send_store.pop(tensor_id, None)\n-                        if tensor is not None:\n-                            data = {\n-                                \"ret\": 0,\n-                                \"shape\": tensor.shape,\n-                                \"dtype\":\n-                                str(tensor.dtype).replace(\"torch.\", \"\")\n-                            }\n-                            # LRU\n-                            self.send_store[tensor_id] = tensor\n-                            self._have_sent_tensor_id(tensor_id)\n-                        else:\n-                            data = {\"ret\": 1}\n-\n-                    self.router_socket.send_multipart(\n-                        [remote_address, msgpack.dumps(data)])\n-\n-                    if data[\"ret\"] == 0:\n-                        comm, rank = self.comms[remote_address.decode()]\n-                        self._send(comm, tensor.to(self.device), rank ^ 1,\n-                                   self.send_stream)\n-                else:\n+                            \"ðŸ”´[PUT]Recv Tensor, Out Of Threshold, \"\n+                            \"%sðŸ‘ˆ%s, data:%s, addr:%d\", self.zmq_address,\n+                            remote_address.decode(), data, addr)\n+                    else:\n+                        self.buffer_size += tensor_size\n+\n+                except torch.cuda.OutOfMemoryError:\n+                    self.router_socket.send_multipart([remote_address, b\"1\"])\n+                    tensor = None\n                     logger.warning(\n-                        \"ðŸš§Unexpected, Received message from %s, data:%s\",\n-                        remote_address, data)\n+                        \"ðŸ”´[PUT]Recv Tensor, Out Of Memory, %sðŸ‘ˆ%s, \"\n+                        \"data:%s\", self.zmq_address, remote_address.decode(),\n+                        data)\n \n-    def _have_sent_tensor_id(self, tensor_id: str):\n+                with self.recv_store_cv:\n+                    self.recv_store[tensor_id] = tensor\n+                    self.have_received_tensor_id(tensor_id)\n+                    self.recv_store_cv.notify()\n+\n+            elif data[\"cmd\"] == \"GET\":\n+                tensor_id = data[\"tensor_id\"]\n+                with self.send_store_cv:\n+                    tensor = self.send_store.pop(tensor_id, None)\n+                    if tensor is not None:\n+                        data = {\n+                            \"ret\": 0,\n+                            \"shape\": tensor.shape,\n+                            \"dtype\": str(tensor.dtype).replace(\"torch.\", \"\")\n+                        }\n+                        # LRU\n+                        self.send_store[tensor_id] = tensor\n+                        self.have_sent_tensor_id(tensor_id)\n+                    else:\n+                        data = {\"ret\": 1}\n+\n+                self.router_socket.send_multipart(\n+                    [remote_address, msgpack.dumps(data)])\n+\n+                if data[\"ret\"] == 0:\n+                    comm, rank = self.comms[remote_address.decode()]\n+                    self.send(comm, tensor.to(self.device), rank ^ 1,\n+                              self.send_stream)\n+            else:\n+                logger.warning(\n+                    \"ðŸš§Unexpected, Received message from %s, data:%s\",\n+                    remote_address, data)\n+\n+    def have_sent_tensor_id(self, tensor_id: str):\n         request_id = tensor_id.split('#')[0]\n         if request_id not in self.send_request_id_to_tensor_ids:\n             self.send_request_id_to_tensor_ids[request_id] = set()\n         self.send_request_id_to_tensor_ids[request_id].add(tensor_id)\n \n-    def _have_received_tensor_id(self, tensor_id: str):\n+    def have_received_tensor_id(self, tensor_id: str):\n         request_id = tensor_id.split('#')[0]\n         if request_id not in self.recv_request_id_to_tensor_ids:\n             self.recv_request_id_to_tensor_ids[request_id] = set()\n         self.recv_request_id_to_tensor_ids[request_id].add(tensor_id)\n \n-    def _send_async(self):\n+    def send_async(self):\n         while True:\n             with self.send_queue_cv:\n                 while not self.send_queue:\n                     self.send_queue_cv.wait()\n-                tensor_id, remote_address, tensor = self.send_queue.popleft()\n+                item = self.send_queue.popleft()\n                 if not self.send_queue:\n                     self.send_queue_cv.notify()\n-            self._send_sync(tensor_id, tensor, remote_address)\n+            self.send_sync(item)\n \n     def wait_for_sent(self):\n         if self.send_type == \"PUT_ASYNC\":\n@@ -409,22 +427,21 @@ class P2pNcclEngine:\n                 \"ðŸš§[PUT_ASYNC]It took %.3fms to wait for the send_queue\"\n                 \" to be empty, rank:%d\", duration * 1000, self.rank)\n \n-    def _send_sync(\n-        self,\n-        tensor_id: str,\n-        tensor: torch.Tensor,\n-        remote_address: typing.Optional[str] = None,\n-    ) -> bool:\n-        if remote_address is None:\n+    def send_sync(self, item: SendQueueItem) -> bool:\n+        if item.remote_address is None:\n             return False\n-        if remote_address not in self.socks:\n-            self._create_connect(remote_address)\n+        if item.remote_address not in self.socks:\n+            self.create_connect(item.remote_address)\n \n-        sock = self.socks[remote_address]\n-        comm, rank = self.comms[remote_address]\n+        with self.send_stream:\n+            tensor = self.extract_kv_from_layer(item.is_mla, item.tensor,\n+                                                item.slot_mapping)\n+\n+        sock = self.socks[item.remote_address]\n+        comm, rank = self.comms[item.remote_address]\n         data = {\n             \"cmd\": \"PUT\",\n-            \"tensor_id\": tensor_id,\n+            \"tensor_id\": item.tensor_id,\n             \"shape\": tensor.shape,\n             \"dtype\": str(tensor.dtype).replace(\"torch.\", \"\")\n         }\n@@ -435,20 +452,21 @@ class P2pNcclEngine:\n             logger.error(\n                 \"ðŸ”´Send Tensor, Peer Out Of Memory/Threshold, %s ðŸ‘‰ %s, \"\n                 \"MyRank:%s, data:%s, tensor:%s, size:%fGB, response:%s\",\n-                self.zmq_address, remote_address, rank, data, tensor.shape,\n+                self.zmq_address, item.remote_address, rank, data,\n+                tensor.shape,\n                 tensor.element_size() * tensor.numel() / 1024**3,\n                 response.decode())\n             return False\n \n-        self._send(comm, tensor.to(self.device), rank ^ 1, self.send_stream)\n+        self.send(comm, tensor.to(self.device), rank ^ 1, self.send_stream)\n \n         if self.send_type == \"PUT_ASYNC\":\n-            self._have_sent_tensor_id(tensor_id)\n+            self.have_sent_tensor_id(item.tensor_id)\n \n         return True\n \n     def get_finished(\n-        self, finished_req_ids: set[str], forward_context: \"ForwardContext\"\n+            self, finished_req_ids: set[str], no_compile_layers\n     ) -> tuple[Optional[set[str]], Optional[set[str]]]:\n         \"\"\"\n         Notifies worker-side connector ids of requests that have\n@@ -463,7 +481,7 @@ class P2pNcclEngine:\n \n         # Clear the buffer upon request completion.\n         for request_id in finished_req_ids:\n-            for layer_name in forward_context.no_compile_layers:\n+            for layer_name in no_compile_layers:\n                 tensor_id = request_id + \"#\" + layer_name\n                 if tensor_id in self.recv_store:\n                     with self.recv_store_cv:\n@@ -472,7 +490,6 @@ class P2pNcclEngine:\n                             request_id, None)\n                         self.recv_request_id_to_tensor_ids.pop(\n                             request_id, None)\n-                    addr = 0\n                     if isinstance(tensor, tuple):\n                         addr, _, _ = tensor\n                         self.pool.free(addr)\n@@ -485,7 +502,7 @@ class P2pNcclEngine:\n \n         return finished_sending or None, finished_recving or None\n \n-    def _ping(self):\n+    def ping(self):\n         sock = self.context.socket(zmq.DEALER)\n         sock.setsockopt_string(zmq.IDENTITY, self.zmq_address)\n         logger.debug(\"ping start, zmq_address:%s\", self.zmq_address)\n@@ -499,7 +516,7 @@ class P2pNcclEngine:\n             sock.send(msgpack.dumps(data))\n             time.sleep(3)\n \n-    def _send(self, comm, tensor: torch.Tensor, dst: int, stream=None):\n+    def send(self, comm, tensor: torch.Tensor, dst: int, stream=None):\n         assert tensor.device == self.device, (\n             f\"this nccl communicator is created to work on {self.device}, \"\n             f\"but the input tensor is on {tensor.device}\")\n@@ -512,7 +529,7 @@ class P2pNcclEngine:\n                                comm, cudaStream_t(stream.cuda_stream))\n         stream.synchronize()\n \n-    def _recv(self, comm, tensor: torch.Tensor, src: int, stream=None):\n+    def recv(self, comm, tensor: torch.Tensor, src: int, stream=None):\n         assert tensor.device == self.device, (\n             f\"this nccl communicator is created to work on {self.device}, \"\n             f\"but the input tensor is on {tensor.device}\")\n@@ -531,3 +548,21 @@ class P2pNcclEngine:\n             self._send_thread.join()\n         if self._ping_thread is not None:\n             self._ping_thread.join()\n+\n+    @staticmethod\n+    def extract_kv_from_layer(\n+        is_mla: bool,\n+        layer: torch.Tensor,\n+        slot_mapping: torch.Tensor,\n+    ) -> torch.Tensor:\n+        \"\"\"Extract the KV cache from the layer.\n+        Assume the shape of the layer is (2, num_pages, page_size, xxx)\n+        if MLA is not used, and (num_pages, page_size, xxx) otherwise.\n+        \"\"\"\n+        if is_mla:\n+            num_pages, page_size = layer.shape[0], layer.shape[1]\n+            return layer.reshape(num_pages * page_size, -1)[slot_mapping, ...]\n+\n+        num_pages, page_size = layer.shape[1], layer.shape[2]\n+        return layer.reshape(2, num_pages * page_size, -1)[:, slot_mapping,\n+                                                           ...]", "apis": ["vllm.distributed.kv_transfer.kv_connector.v1.p2p.P2pNcclConnector.start_load_kv", "vllm.distributed.kv_transfer.kv_connector.v1.p2p.P2pNcclConnector.get_finished", "vllm.distributed.kv_transfer.kv_connector.v1.p2p.P2pNcclEngine.send_tensor", "vllm.distributed.kv_transfer.kv_connector.v1.p2p.P2pNcclEngine.send_sync", "vllm.distributed.kv_transfer.kv_connector.v1.p2p.P2pNcclEngine.extract_kv_from_layer"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_connector.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/kv_transfer/kv_connector/v1/p2p/p2p_nccl_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/online_serving/disaggregated_serving_p2p_nccl_xpyd/disagg_proxy_p2p_nccl_xpyd.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes modifications to both documentation and the core implementation of the P2pNcclConnector and its engine. It changes default settings (e.g., defaulting the send type to \"PUT_ASYNC\"), refactors internal asynchronous sending logic (introducing a typed SendQueueItem for clarity and safety), and adjusts memory pool handling, all of which are intended to improve the throughput and reduce latency in transfer of KV cache data. These changes affect the performance of the core, high-level API of the system and are not just trivial refactoring or documentation fixes. The improvements focus on enhancing data transfer performance on CPU and are testable without dependency on GPU/TPU specifics. Therefore, the commit satisfies the criteria for being performance or optimization related.", "llm_api_reason": "This commit mostly involves documentation updates (changing \"KVcache\" to \"KVCache\" for consistency), improvements to code readability, and some internal refactoring. In particular, it updates the P2pNcclConnector and P2pNcclEngine classes. The changes include modifying how the connector sends KVCache data (e.g. updating start_load_kv so that it calls engine.send_tensor with extra arguments), refactoring internal methods (renaming _send_sync to send_sync, _create_connect to create_connect, etc.), and moving the KV extraction logic into a new static method extract_kv_from_layer in P2pNcclEngine. These modifications affect the Python APIs for the P2pNcclConnector and P2pNcclEngine classes."}
{"commit_hash": "c0569dbc82b5e945a77878190114d1b68027828b", "pr_url": "https://github.com/vllm-project/vllm/pull/20725", "pr_date": "2025-07-14", "timeline_text": "Copy link Contributor varun-sundar-rabindranath commented Jul 10, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Purpose Perform weight-application and reduction inside the TritonExperts and DeepGemmExperts. This helps save memory. For example please refer to #20228 Changes: Add topk_weights and apply_router_weight_on_input args to FusedMoEPermuteExpertsUnpermute::apply functions - so the implementations can perform topk-weight application if they wish to. Adjust workspace reuse in TritonExperts and DeepGemmExperts to accommodate weight-application and reduction. Test Plan pytest : pytest -s tests/kernels/moe/test_modular_kernel_combinations.py e2e tests: Using TritonOrDeepGemmExperts VLLM_ALL2ALL_BACKEND=\"deepep_high_throughput\" VLLM_USE_DEEP_GEMM=1  canhazgpu run -g 2 --  vllm serve Qwen/Qwen3-30B-A3B-FP8  --trust-remote-code --enable-expert-parallel --data-parallel-size 2 --port 9010 Using only TritonExperts VLLM_ALL2ALL_BACKEND=\"deepep_high_throughput\" VLLM_USE_DEEP_GEMM=0  canhazgpu run -g 2 --  vllm serve Qwen/Qwen3-30B-A3B-FP8  --trust-remote-code --enable-expert-parallel --data-parallel-size 2 --port 9010 lm-eval command : lm_eval --model local-completions --tasks gsm8k --model_args model=Qwen/Qwen3-30B-A3B-FP8,base_url=http://127.0.0.1:9010/v1/completions,num_concurrent=30,max_retries=3 --limit 100 Test Result |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.86|Â±  |0.0349|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.92|Â±  |0.0273| |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.80|Â±  |0.0402|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.91|Â±  |0.0288| (Optional) Documentation Update Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions varun-sundar-rabindranath requested review from tlrmchlsmth and WoosukKwon as code owners July 10, 2025 00:41 Copy link github-actions bot commented Jul 10, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . varun-sundar-rabindranath marked this pull request as draft July 10, 2025 00:42 Copy link mergify bot commented Jul 10, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @varun-sundar-rabindranath . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jul 10, 2025 gemini-code-assist bot reviewed Jul 10, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @varun-sundar-rabindranath , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request enhances the FusedMoEPermuteExpertsUnpermute module by enabling weight application and reduction within the fused operation. This is achieved through the introduction of the TopKWeightAndReduce abstraction, which allows implementations to specify how the finalize() method should behave. The PR also standardizes weight application and reduction implementations, improving code organization and maintainability. Highlights MoE Reduction : Adds the ability to perform MoE reduction within the FusedMoEPermuteExpertsUnpermute operation, allowing for memory footprint reduction. TopKWeightAndReduce Abstraction : Introduces the TopKWeightAndReduce abstraction to standardize weight application and reduction implementations, providing flexibility in the finalize() method. Standardization : Consolidates all weight-application and reduction implementations into a single location for better maintainability. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with ðŸ‘ and ðŸ‘Ž on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . â†© Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jul 10, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request introduces a significant and well-designed refactoring to make MoE kernels more modular. By abstracting the weight application and reduction logic into a WeightAndReduce class, it allows different FusedMoEPermuteExpertsUnpermute implementations to either perform this step themselves or delegate it to the finalize stage. This is a great improvement for code clarity, reusability, and will help in reducing memory footprint as intended. The changes are well-implemented across the affected files. My feedback focuses on a few areas where code can be made more concise and consistent with the established API contracts. These are minor points in an otherwise excellent PR. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/fused_moe/batched_triton_or_deep_gemm_moe.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/layers/fused_moe/deep_gemm_moe.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/layers/fused_moe/triton_deep_gemm_moe.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . varun-sundar-rabindranath force-pushed the varun/experts-reduce branch\n    from e797a42 to 27306fa Compare July 10, 2025 00:51 mergify bot removed\n  the needs-rebase label Jul 10, 2025 varun-sundar-rabindranath force-pushed the varun/experts-reduce branch\n    from 27306fa to 3f1d2da Compare July 10, 2025 19:55 Copy link mergify bot commented Jul 10, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @varun-sundar-rabindranath . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jul 10, 2025 varun-sundar-rabindranath force-pushed the varun/experts-reduce branch\n    from 3d3003a to 4389c7a Compare July 11, 2025 01:36 mergify bot removed\n  the needs-rebase label Jul 11, 2025 varun-sundar-rabindranath changed the title [Misc] Modular Kernel : Add ability to MoE reduce in FusedMoEPermuteExpertsUnpermute [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts & DeepGemmExperts Jul 11, 2025 varun-sundar-rabindranath marked this pull request as ready for review July 11, 2025 02:42 varun-sundar-rabindranath commented Jul 11, 2025 View reviewed changes vllm/model_executor/layers/fused_moe/deep_gemm_moe.py (M_sum, N // 2)) mm2_out = _resize_cache(workspace2, (M_sum, K)) mm2_out = _resize_cache(workspace13, (M_sum, K)) perm_out = _resize_cache(workspace2, (M * num_topk, K)) Copy link Contributor Author varun-sundar-rabindranath Jul 11, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment rearrage how workspaces are used to make space for perm_out - note that perm_out cannot use workspace13 as workspace13 may be used as the output tensor ( vllm/vllm/model_executor/layers/fused_moe/modular_kernel.py Line 486\n      in 5923ab9 fused_out = _resize_cache ( workspace13 , fused_out_shape ) ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions varun-sundar-rabindranath commented Jul 11, 2025 View reviewed changes vllm/model_executor/layers/fused_moe/fused_moe.py (num_tokens * top_k_num, N // 2)) intermediate_cache3 = _resize_cache(workspace2, (num_tokens, top_k_num, K)) Copy link Contributor Author varun-sundar-rabindranath Jul 11, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment rearrage how workspaces are used to make space for intermediate_cache3 - note that intermediate_cache3 cannot use workspace13 as workspace13 may be used as the output tensor Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link mergify bot commented Jul 11, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @varun-sundar-rabindranath . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Jul 11, 2025 varun-sundar-rabindranath force-pushed the varun/experts-reduce branch\n    from 4389c7a to c5fd979 Compare July 11, 2025 16:56 mergify bot removed\n  the needs-rebase label Jul 11, 2025 This was referenced Jul 12, 2025 [Kernels][Misc] DeepGemm High-Throughput Optimizations #20228 Closed [Kernel] DeepGemm MoE : Integrate triton permute / unpermute kernels #20903 Merged tlrmchlsmth approved these changes Jul 14, 2025 View reviewed changes vllm/model_executor/layers/fused_moe/topk_weight_and_reduce.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 14, 2025 Varun Sundar Rabindranath added 3 commits July 14, 2025 16:10 do reduction in experts â€¦ c9f2001 Signed-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com> fix workspace overallocation â€¦ 4d7e07b Signed-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com> TritonExperts opt â€¦ 2961f53 Signed-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com> varun-sundar-rabindranath force-pushed the varun/experts-reduce branch\n    from e369637 to 2961f53 Compare July 14, 2025 16:13 Copy link Collaborator tlrmchlsmth commented Jul 14, 2025 Confirm that without this PR, I cannot run a full sequence length DeepSeekV3 across 16 H200s and with it I see: GPU KV cache size: 236,736 tokens ðŸŽ‰ 1 robertgshaw2-redhat reacted with hooray emoji All reactions ðŸŽ‰ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth enabled auto-merge (squash) July 14, 2025 18:04 Hide details View details tlrmchlsmth merged commit c0569db into vllm-project : main Jul 14, 2025 68 checks passed Uh oh! There was an error while loading. Please reload this page . py-andy-c pushed a commit\n        to py-andy-c/vllm\n      that referenced\n      this pull request Jul 14, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 5dfb1a9 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> py-andy-c pushed a commit\n        to py-andy-c/vllm\n      that referenced\n      this pull request Jul 14, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ d9b727c â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> patrickvonplaten pushed a commit\n        to patrickvonplaten/vllm\n      that referenced\n      this pull request Jul 15, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 8595ba0 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Patrick von Platen <patrick.v.platen@gmail.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 8150275 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 0bee6a6 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> x22x22 pushed a commit\n        to x22x22/vllm\n      that referenced\n      this pull request Aug 5, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 3eba418 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: x22x22 <wadeking@qq.com> Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 813b32a â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 8e72fe1 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 98a3732 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> paulpak58 pushed a commit\n        to paulpak58/vllm\n      that referenced\n      this pull request Aug 13, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 1bb105e â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Paul Pak <paulpak58@gmail.com> taneem-ibrahim pushed a commit\n        to taneem-ibrahim/vllm\n      that referenced\n      this pull request Aug 14, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 7d7f94b â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> diegocastanibm pushed a commit\n        to diegocastanibm/vllm\n      that referenced\n      this pull request Aug 15, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 6c7acc9 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nSigned-off-by: Diego-Castan <diego.castan@ibm.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 27, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ a202b30 â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts &â€¦ â€¦ 9737a2e â€¦ DeepGemmExperts ( vllm-project#20725 )\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:41", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm-eval, lm_eval, gsm8k | PERF: Throughput, improvement | SERVING: vllm serve, vllm serve, serve | TEST: Test, Test, test", "analysis_extracted_at": "2025-09-07 17:50:41", "models": ["Qwen/Qwen3-30B-A3B-FP8"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=Qwen/Qwen3-30B-A3B-FP8,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model Qwen/Qwen3-30B-A3B-FP8 --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts & DeepGemmExperts (#20725)", "commit_message": "[Misc] ModularKernel : Perform WeightAndReduce inside TritonExperts & DeepGemmExperts (#20725)\n\nSigned-off-by: Varun Sundar Rabindranath <vsundarr@redhat.com>\nCo-authored-by: Varun Sundar Rabindranath <vsundarr@redhat.com>", "commit_date": "2025-07-14T19:47:16Z", "files_changed": ["vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py", "vllm/model_executor/layers/fused_moe/batched_triton_or_deep_gemm_moe.py", "vllm/model_executor/layers/fused_moe/cutlass_moe.py", "vllm/model_executor/layers/fused_moe/deep_gemm_moe.py", "vllm/model_executor/layers/fused_moe/fused_batched_moe.py", "vllm/model_executor/layers/fused_moe/fused_moe.py", "vllm/model_executor/layers/fused_moe/modular_kernel.py", "vllm/model_executor/layers/fused_moe/topk_weight_and_reduce.py", "vllm/model_executor/layers/fused_moe/triton_deep_gemm_moe.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 9, "only_test_files": 0, "only_non_test_files": 1, "num_files": 9, "num_hunks": 39, "num_edited_lines": 360, "num_non_test_edited_lines": 360, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py b/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py\nindex 70a580b9c..0b3943292 100644\n--- a/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/batched_deep_gemm_moe.py\n@@ -260,6 +260,7 @@ class BatchedDeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         hidden_states: torch.Tensor,\n         w1: torch.Tensor,\n         w2: torch.Tensor,\n+        topk_weights: torch.Tensor,\n         topk_ids: torch.Tensor,\n         activation: str,\n         global_num_experts: int,\n@@ -273,6 +274,7 @@ class BatchedDeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         workspace13: torch.Tensor,\n         workspace2: torch.Tensor,\n         expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+        apply_router_weight_on_input: bool,\n     ):\n         assert expert_tokens_meta is not None\n         expert_num_tokens = expert_tokens_meta.expert_num_tokens\ndiff --git a/vllm/model_executor/layers/fused_moe/batched_triton_or_deep_gemm_moe.py b/vllm/model_executor/layers/fused_moe/batched_triton_or_deep_gemm_moe.py\nindex 41faced58..12df9bb34 100644\n--- a/vllm/model_executor/layers/fused_moe/batched_triton_or_deep_gemm_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/batched_triton_or_deep_gemm_moe.py\n@@ -129,30 +129,22 @@ class BatchedTritonOrDeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n             return self.batched_triton_experts.workspace_shapes(\n                 a, aq, M, N, K, topk, global_num_experts, local_num_experts)\n \n-    def apply(\n-        self,\n-        output: torch.Tensor,\n-        hidden_states: torch.Tensor,\n-        w1: torch.Tensor,\n-        w2: torch.Tensor,\n-        topk_ids: torch.Tensor,\n-        activation: str,\n-        global_num_experts: int,\n-        expert_map: Optional[torch.Tensor],\n-        w1_scale: Optional[torch.Tensor],\n-        w2_scale: Optional[torch.Tensor],\n-        w1_zp: Optional[torch.Tensor],\n-        w2_zp: Optional[torch.Tensor],\n-        a1q_scale: Optional[torch.Tensor],\n-        a2_scale: Optional[torch.Tensor],\n-        workspace13: torch.Tensor,\n-        workspace2: torch.Tensor,\n-        expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n-    ):\n+    def apply(self, output: torch.Tensor, hidden_states: torch.Tensor,\n+              w1: torch.Tensor, w2: torch.Tensor, topk_weights: torch.Tensor,\n+              topk_ids: torch.Tensor, activation: str, global_num_experts: int,\n+              expert_map: Optional[torch.Tensor],\n+              w1_scale: Optional[torch.Tensor],\n+              w2_scale: Optional[torch.Tensor], w1_zp: Optional[torch.Tensor],\n+              w2_zp: Optional[torch.Tensor], a1q_scale: Optional[torch.Tensor],\n+              a2_scale: Optional[torch.Tensor], workspace13: torch.Tensor,\n+              workspace2: torch.Tensor,\n+              expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+              apply_router_weight_on_input: bool):\n         experts = (self.batched_deep_gemm_experts\n                    if self.allow_deep_gemm else self.batched_triton_experts)\n         assert experts is not None\n-        experts.apply(output, hidden_states, w1, w2, topk_ids, activation,\n-                      global_num_experts, expert_map, w1_scale, w2_scale,\n-                      w1_zp, w2_zp, a1q_scale, a2_scale, workspace13,\n-                      workspace2, expert_tokens_meta)\n+        experts.apply(output, hidden_states, w1, w2, topk_weights, topk_ids,\n+                      activation, global_num_experts, expert_map, w1_scale,\n+                      w2_scale, w1_zp, w2_zp, a1q_scale, a2_scale, workspace13,\n+                      workspace2, expert_tokens_meta,\n+                      apply_router_weight_on_input)\ndiff --git a/vllm/model_executor/layers/fused_moe/cutlass_moe.py b/vllm/model_executor/layers/fused_moe/cutlass_moe.py\nindex d6a30e342..e479f1b40 100644\n--- a/vllm/model_executor/layers/fused_moe/cutlass_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/cutlass_moe.py\n@@ -291,26 +291,17 @@ class CutlassExpertsFp8(mk.FusedMoEPermuteExpertsUnpermute):\n         return (workspace1, workspace2, output,\n                 self.out_dtype if self.out_dtype is not None else a.dtype)\n \n-    def apply(\n-        self,\n-        output: torch.Tensor,\n-        hidden_states: torch.Tensor,\n-        w1: torch.Tensor,\n-        w2: torch.Tensor,\n-        topk_ids: torch.Tensor,\n-        activation: str,\n-        global_num_experts: int,\n-        expert_map: Optional[torch.Tensor],\n-        w1_scale: Optional[torch.Tensor],\n-        w2_scale: Optional[torch.Tensor],\n-        w1_zp: Optional[torch.Tensor],\n-        w2_zp: Optional[torch.Tensor],\n-        a1q_scale: Optional[torch.Tensor],\n-        a2_scale: Optional[torch.Tensor],\n-        workspace13: torch.Tensor,\n-        workspace2: torch.Tensor,\n-        expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n-    ):\n+    def apply(self, output: torch.Tensor, hidden_states: torch.Tensor,\n+              w1: torch.Tensor, w2: torch.Tensor, topk_weights: torch.Tensor,\n+              topk_ids: torch.Tensor, activation: str, global_num_experts: int,\n+              expert_map: Optional[torch.Tensor],\n+              w1_scale: Optional[torch.Tensor],\n+              w2_scale: Optional[torch.Tensor], w1_zp: Optional[torch.Tensor],\n+              w2_zp: Optional[torch.Tensor], a1q_scale: Optional[torch.Tensor],\n+              a2_scale: Optional[torch.Tensor], workspace13: torch.Tensor,\n+              workspace2: torch.Tensor,\n+              expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+              apply_router_weight_on_input: bool):\n         assert w1_zp is None, \"w1_zp is not supported in CUTLASS MoE\"\n         assert w2_zp is None, \"w2_zp is not supported in CUTLASS MoE\"\n \ndiff --git a/vllm/model_executor/layers/fused_moe/deep_gemm_moe.py b/vllm/model_executor/layers/fused_moe/deep_gemm_moe.py\nindex b1107a1f4..cc5e7cf57 100644\n--- a/vllm/model_executor/layers/fused_moe/deep_gemm_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/deep_gemm_moe.py\n@@ -13,7 +13,7 @@ from vllm.model_executor.layers.fused_moe.moe_permute_unpermute import (\n from vllm.model_executor.layers.fused_moe.prepare_finalize import (\n     MoEPrepareAndFinalizeNoEP)\n from vllm.model_executor.layers.fused_moe.topk_weight_and_reduce import (\n-    TopKWeightAndReduceDelegate)\n+    TopKWeightAndReduceContiguous, TopKWeightAndReduceNoOP)\n from vllm.model_executor.layers.fused_moe.utils import _resize_cache\n from vllm.model_executor.layers.quantization.utils.fp8_utils import (\n     per_token_group_quant_fp8)\n@@ -90,8 +90,7 @@ class DeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         return True\n \n     def finalize_weight_and_reduce_impl(self) -> mk.TopKWeightAndReduce:\n-        # Let PrepareAndFinalize::finalize() decide the impl.\n-        return TopKWeightAndReduceDelegate()\n+        return TopKWeightAndReduceNoOP()\n \n     def workspace_shapes(\n         self, a: torch.Tensor, aq: torch.Tensor, M: int, N: int, K: int,\n@@ -104,9 +103,9 @@ class DeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         block_m = self.block_shape[0]\n         M_sum = (M * topk) + num_experts * (block_m - 1)\n         M_sum = round_up(M_sum, block_m)\n-        workspace1 = (M_sum, max(N * 2, K))\n+        workspace1 = (M_sum, max(N // 2, K))\n         workspace2 = (M_sum, max(N, K))\n-        output = (M, topk, K)\n+        output = (M, K)\n         return (workspace1, workspace2, output, a.dtype)\n \n     def apply(\n@@ -115,6 +114,7 @@ class DeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         hidden_states: torch.Tensor,\n         w1: torch.Tensor,\n         w2: torch.Tensor,\n+        topk_weights: torch.Tensor,\n         topk_ids: torch.Tensor,\n         activation: str,\n         global_num_experts: int,\n@@ -128,11 +128,14 @@ class DeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         workspace13: torch.Tensor,\n         workspace2: torch.Tensor,\n         expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+        apply_router_weight_on_input: bool,\n     ):\n         assert self.block_shape is not None\n \n         a1q = hidden_states\n         _, N, K = w1.size()\n+        M, _ = output.size()\n+        num_topk = topk_ids.size(1)\n \n         if global_num_experts == -1:\n             global_num_experts = w1.size(0)\n@@ -159,11 +162,12 @@ class DeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         # Note: M_sum is different than the pre-permuted shape of a1q.\n         M_sum = a1q.size(0)\n \n-        mm1_out = _resize_cache(workspace13, (M_sum, N))\n-        act_out = _resize_cache(workspace2, (M_sum, N // 2))\n-        quant_out = _resize_cache(workspace13.view(dtype=torch.float8_e4m3fn),\n+        mm1_out = _resize_cache(workspace2, (M_sum, N))\n+        act_out = _resize_cache(workspace13, (M_sum, N // 2))\n+        quant_out = _resize_cache(workspace2.view(dtype=torch.float8_e4m3fn),\n                                   (M_sum, N // 2))\n-        mm2_out = _resize_cache(workspace2, (M_sum, K))\n+        mm2_out = _resize_cache(workspace13, (M_sum, K))\n+        perm_out = _resize_cache(workspace2, (M * num_topk, K))\n \n         m_grouped_fp8_gemm_nt_contiguous((a1q, a1q_scale), (w1, w1_scale),\n                                          mm1_out, expert_ids)\n@@ -179,7 +183,14 @@ class DeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         m_grouped_fp8_gemm_nt_contiguous((a2q, a2q_scale), (w2, w2_scale),\n                                          mm2_out, expert_ids)\n \n-        torch.index_select(mm2_out, 0, inv_perm, out=output.view((-1, K)))\n+        torch.index_select(mm2_out, 0, inv_perm, out=perm_out)\n+\n+        TopKWeightAndReduceContiguous().apply(\n+            output=output,\n+            fused_expert_output=perm_out,\n+            topk_weights=topk_weights,\n+            topk_ids=topk_ids,\n+            apply_router_weight_on_input=apply_router_weight_on_input)\n \n \n def deep_gemm_moe_fp8(\ndiff --git a/vllm/model_executor/layers/fused_moe/fused_batched_moe.py b/vllm/model_executor/layers/fused_moe/fused_batched_moe.py\nindex 61247e930..b311ef1ac 100644\n--- a/vllm/model_executor/layers/fused_moe/fused_batched_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/fused_batched_moe.py\n@@ -696,15 +696,16 @@ class NaiveBatchedExperts(mk.FusedMoEPermuteExpertsUnpermute):\n             return t.to(f32) * group_broadcast(scale, t.shape)\n \n     def apply(self, output: torch.Tensor, hidden_states: torch.Tensor,\n-              w1: torch.Tensor, w2: torch.Tensor, topk_ids: torch.Tensor,\n-              activation: str, global_num_experts: int,\n+              w1: torch.Tensor, w2: torch.Tensor, topk_weights: torch.Tensor,\n+              topk_ids: torch.Tensor, activation: str, global_num_experts: int,\n               expert_map: Optional[torch.Tensor],\n               w1_scale: Optional[torch.Tensor],\n               w2_scale: Optional[torch.Tensor], w1_zp: Optional[torch.Tensor],\n               w2_zp: Optional[torch.Tensor], a1q_scale: Optional[torch.Tensor],\n               a2_scale: Optional[torch.Tensor], workspace13: torch.Tensor,\n               workspace2: torch.Tensor,\n-              expert_tokens_meta: Optional[mk.ExpertTokensMetadata]):\n+              expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+              apply_router_weight_on_input: bool):\n         assert hidden_states.dim() == 3\n         assert expert_tokens_meta is not None\n         expert_num_tokens = expert_tokens_meta.expert_num_tokens\n@@ -899,15 +900,16 @@ class BatchedTritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         return (workspace13, workspace2, output, a.dtype)\n \n     def apply(self, output: torch.Tensor, hidden_states: torch.Tensor,\n-              w1: torch.Tensor, w2: torch.Tensor, topk_ids: torch.Tensor,\n-              activation: str, global_num_experts: int,\n+              w1: torch.Tensor, w2: torch.Tensor, topk_weights: torch.Tensor,\n+              topk_ids: torch.Tensor, activation: str, global_num_experts: int,\n               expert_map: Optional[torch.Tensor],\n               w1_scale: Optional[torch.Tensor],\n               w2_scale: Optional[torch.Tensor], w1_zp: Optional[torch.Tensor],\n               w2_zp: Optional[torch.Tensor], a1q_scale: Optional[torch.Tensor],\n               a2_scale: Optional[torch.Tensor], workspace13: torch.Tensor,\n               workspace2: torch.Tensor,\n-              expert_tokens_meta: Optional[mk.ExpertTokensMetadata]):\n+              expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+              apply_router_weight_on_input: bool):\n         # Check constraints.\n         if self.use_int4_w4a16:\n             assert hidden_states.size(-1) // 2 == w1.size(2), (\ndiff --git a/vllm/model_executor/layers/fused_moe/fused_moe.py b/vllm/model_executor/layers/fused_moe/fused_moe.py\nindex 6a9767fc6..f0bffc7da 100644\n--- a/vllm/model_executor/layers/fused_moe/fused_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/fused_moe.py\n@@ -26,7 +26,7 @@ from vllm.model_executor.layers.fused_moe.moe_align_block_size import (\n from vllm.model_executor.layers.fused_moe.prepare_finalize import (\n     MoEPrepareAndFinalizeNoEP)\n from vllm.model_executor.layers.fused_moe.topk_weight_and_reduce import (\n-    TopKWeightAndReduceDelegate)\n+    TopKWeightAndReduceNoOP)\n from vllm.model_executor.layers.fused_moe.utils import (\n     _resize_cache, moe_kernel_quantize_input)\n from vllm.model_executor.layers.quantization.utils.mxfp4_utils import (\n@@ -1606,8 +1606,7 @@ class TritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         return True\n \n     def finalize_weight_and_reduce_impl(self) -> mk.TopKWeightAndReduce:\n-        # Let PrepareAndFinalize::finalize() decide the impl.\n-        return TopKWeightAndReduceDelegate()\n+        return TopKWeightAndReduceNoOP()\n \n     def workspace_shapes(\n         self,\n@@ -1620,9 +1619,9 @@ class TritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         global_num_experts: int,\n         local_num_experts: int,\n     ) -> tuple[tuple[int, ...], tuple[int, ...], tuple[int, ...], torch.dtype]:\n-        workspace1 = (M, topk, max(N * 2, K))\n-        workspace2 = (M, topk, N)\n-        output = (M, topk, K)\n+        workspace1 = (M, topk, max(N // 2, K))\n+        workspace2 = (M, topk, max(N, K))\n+        output = (M, K)\n         return (workspace1, workspace2, output, a.dtype)\n \n     def apply(\n@@ -1631,6 +1630,7 @@ class TritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         hidden_states: torch.Tensor,\n         w1: torch.Tensor,\n         w2: torch.Tensor,\n+        topk_weights: torch.Tensor,\n         topk_ids: torch.Tensor,\n         activation: str,\n         global_num_experts: int,\n@@ -1644,6 +1644,7 @@ class TritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         workspace13: torch.Tensor,\n         workspace2: torch.Tensor,\n         expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+        apply_router_weight_on_input: bool,\n     ):\n         # Check constraints.\n         if self.use_int4_w4a16:\n@@ -1696,37 +1697,39 @@ class TritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n             raise ValueError(\n                 f\"Unsupported compute_type: {hidden_states.dtype}\")\n \n-        # We can reuse the memory between these because by the time we need\n-        # cache3, we're done with cache1\n-        intermediate_cache1 = _resize_cache(workspace13,\n+        # Note that the output tensor might be in workspace1\n+        intermediate_cache1 = _resize_cache(workspace2,\n                                             (num_tokens, top_k_num, N))\n-        intermediate_cache2 = _resize_cache(workspace2,\n+        intermediate_cache2 = _resize_cache(workspace13,\n                                             (num_tokens * top_k_num, N // 2))\n+        intermediate_cache3 = _resize_cache(workspace2,\n+                                            (num_tokens, top_k_num, K))\n \n         sorted_token_ids, expert_ids, num_tokens_post_padded = (\n             moe_align_block_size(topk_ids, config['BLOCK_SIZE_M'],\n                                  global_num_experts, expert_map))\n \n-        invoke_fused_moe_kernel(hidden_states,\n-                                w1,\n-                                intermediate_cache1,\n-                                a1q_scale,\n-                                w1_scale,\n-                                w1_zp,\n-                                None,\n-                                sorted_token_ids,\n-                                expert_ids,\n-                                num_tokens_post_padded,\n-                                False,\n-                                top_k_num,\n-                                config,\n-                                compute_type=compute_type,\n-                                use_fp8_w8a8=self.use_fp8_w8a8,\n-                                use_int8_w8a8=self.use_int8_w8a8,\n-                                use_int8_w8a16=self.use_int8_w8a16,\n-                                use_int4_w4a16=self.use_int4_w4a16,\n-                                per_channel_quant=self.per_act_token_quant,\n-                                block_shape=self.block_shape)\n+        invoke_fused_moe_kernel(\n+            hidden_states,\n+            w1,\n+            intermediate_cache1,\n+            a1q_scale,\n+            w1_scale,\n+            w1_zp,\n+            None,  # topk_weights\n+            sorted_token_ids,\n+            expert_ids,\n+            num_tokens_post_padded,\n+            False,  # mul_routed_weights\n+            top_k_num,\n+            config,\n+            compute_type=compute_type,\n+            use_fp8_w8a8=self.use_fp8_w8a8,\n+            use_int8_w8a8=self.use_int8_w8a8,\n+            use_int8_w8a16=self.use_int8_w8a16,\n+            use_int4_w4a16=self.use_int4_w4a16,\n+            per_channel_quant=self.per_act_token_quant,\n+            block_shape=self.block_shape)\n \n         self.activation(activation, intermediate_cache2,\n                         intermediate_cache1.view(-1, N))\n@@ -1739,15 +1742,15 @@ class TritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n \n         invoke_fused_moe_kernel(qintermediate_cache2,\n                                 w2,\n-                                output,\n+                                intermediate_cache3,\n                                 a2q_scale,\n                                 w2_scale,\n                                 w2_zp,\n-                                None,\n+                                topk_weights,\n                                 sorted_token_ids,\n                                 expert_ids,\n                                 num_tokens_post_padded,\n-                                False,\n+                                not apply_router_weight_on_input,\n                                 1,\n                                 config,\n                                 compute_type=compute_type,\n@@ -1758,6 +1761,8 @@ class TritonExperts(mk.FusedMoEPermuteExpertsUnpermute):\n                                 per_channel_quant=self.per_act_token_quant,\n                                 block_shape=self.block_shape)\n \n+        ops.moe_sum(intermediate_cache3, output)\n+\n \n def modular_triton_fused_moe(\n     use_fp8_w8a8: bool,\ndiff --git a/vllm/model_executor/layers/fused_moe/modular_kernel.py b/vllm/model_executor/layers/fused_moe/modular_kernel.py\nindex d0d8c7d6f..028eee241 100644\n--- a/vllm/model_executor/layers/fused_moe/modular_kernel.py\n+++ b/vllm/model_executor/layers/fused_moe/modular_kernel.py\n@@ -360,6 +360,7 @@ class FusedMoEPermuteExpertsUnpermute(ABC):\n         hidden_states: torch.Tensor,\n         w1: torch.Tensor,\n         w2: torch.Tensor,\n+        topk_weights: torch.Tensor,\n         topk_ids: torch.Tensor,\n         activation: str,\n         global_num_experts: int,\n@@ -373,6 +374,7 @@ class FusedMoEPermuteExpertsUnpermute(ABC):\n         workspace13: torch.Tensor,\n         workspace2: torch.Tensor,\n         expert_tokens_meta: Optional[ExpertTokensMetadata],\n+        apply_router_weight_on_input: bool,\n     ):\n         \"\"\"\n         This function computes the intermediate result of a Mixture of Experts\n@@ -384,6 +386,8 @@ class FusedMoEPermuteExpertsUnpermute(ABC):\n           layer.\n         - w1 (torch.Tensor): The first set of expert weights.\n         - w2 (torch.Tensor): The second set of expert weights.\n+        - topk_weights: A map of row to expert weights. Some implementations\n+          choose to do weight application. \n         - topk_ids (torch.Tensor): A map of row to expert id.\n         - activation (str): The activation function to apply after the first\n           MoE layer.\n@@ -409,6 +413,9 @@ class FusedMoEPermuteExpertsUnpermute(ABC):\n           ExpertTokensMetadata object containing gpu/cpu tensors\n           as big as the number of local experts with the information about the\n           number of tokens assigned to each local expert.\n+        - apply_router_weight_on_input: True if router weights are already\n+          applied on the input. This is relevant if the implementation\n+          chooses to do weight application.\n         \"\"\"\n         raise NotImplementedError\n \n@@ -452,17 +459,21 @@ class FusedMoEModularKernel(torch.nn.Module):\n                 f\"{fused_experts.__class__.__name__}.\"\n                 f\"{fused_experts.activation_formats[0]}\")\n \n-    def _do_fused_experts(\n-            self, fused_out: Optional[torch.Tensor], a1: torch.Tensor,\n-            a1q: torch.Tensor, w1: torch.Tensor, w2: torch.Tensor,\n-            topk_ids: torch.Tensor, activation: str, global_num_experts: int,\n-            local_num_experts: int, expert_map: Optional[torch.Tensor],\n-            w1_scale: Optional[torch.Tensor], w2_scale: Optional[torch.Tensor],\n-            w1_zp: Optional[torch.Tensor], w2_zp: Optional[torch.Tensor],\n-            a1q_scale: Optional[torch.Tensor],\n-            a2_scale: Optional[torch.Tensor],\n-            expert_tokens_meta: Optional[ExpertTokensMetadata]\n-    ) -> torch.Tensor:\n+    def _do_fused_experts(self, fused_out: Optional[torch.Tensor],\n+                          a1: torch.Tensor, a1q: torch.Tensor,\n+                          w1: torch.Tensor, w2: torch.Tensor,\n+                          topk_weights: torch.Tensor, topk_ids: torch.Tensor,\n+                          activation: str, global_num_experts: int,\n+                          local_num_experts: int,\n+                          expert_map: Optional[torch.Tensor],\n+                          w1_scale: Optional[torch.Tensor],\n+                          w2_scale: Optional[torch.Tensor],\n+                          w1_zp: Optional[torch.Tensor],\n+                          w2_zp: Optional[torch.Tensor],\n+                          a1q_scale: Optional[torch.Tensor],\n+                          a2_scale: Optional[torch.Tensor],\n+                          expert_tokens_meta: Optional[ExpertTokensMetadata],\n+                          apply_router_weight_on_input: bool) -> torch.Tensor:\n \n         _, M, N, K, top_k = _moe_problem_size(a1q, w1, w2, topk_ids)\n \n@@ -485,36 +496,49 @@ class FusedMoEModularKernel(torch.nn.Module):\n             # reuse workspace13 for the output\n             fused_out = _resize_cache(workspace13, fused_out_shape)\n \n-        self.fused_experts.apply(fused_out,\n-                                 a1q,\n-                                 w1,\n-                                 w2,\n-                                 topk_ids=topk_ids,\n-                                 activation=activation,\n-                                 global_num_experts=global_num_experts,\n-                                 expert_map=expert_map,\n-                                 w1_scale=w1_scale,\n-                                 w2_scale=w2_scale,\n-                                 w1_zp=w1_zp,\n-                                 w2_zp=w2_zp,\n-                                 a1q_scale=a1q_scale,\n-                                 a2_scale=a2_scale,\n-                                 workspace13=workspace13,\n-                                 workspace2=workspace2,\n-                                 expert_tokens_meta=expert_tokens_meta)\n+        self.fused_experts.apply(\n+            fused_out,\n+            a1q,\n+            w1,\n+            w2,\n+            topk_weights=topk_weights,\n+            topk_ids=topk_ids,\n+            activation=activation,\n+            global_num_experts=global_num_experts,\n+            expert_map=expert_map,\n+            w1_scale=w1_scale,\n+            w2_scale=w2_scale,\n+            w1_zp=w1_zp,\n+            w2_zp=w2_zp,\n+            a1q_scale=a1q_scale,\n+            a2_scale=a2_scale,\n+            workspace13=workspace13,\n+            workspace2=workspace2,\n+            expert_tokens_meta=expert_tokens_meta,\n+            apply_router_weight_on_input=apply_router_weight_on_input)\n \n         return fused_out\n \n     def _maybe_chunk_fused_experts(\n-            self, a1: torch.Tensor, a1q: torch.Tensor, w1: torch.Tensor,\n-            w2: torch.Tensor, topk_ids: torch.Tensor, activation: str,\n-            global_num_experts: int, local_num_experts: int,\n-            expert_map: Optional[torch.Tensor],\n-            w1_scale: Optional[torch.Tensor], w2_scale: Optional[torch.Tensor],\n-            w1_zp: Optional[torch.Tensor], w2_zp: Optional[torch.Tensor],\n-            a1q_scale: Optional[torch.Tensor],\n-            a2_scale: Optional[torch.Tensor],\n-            expert_tokens_meta: Optional[ExpertTokensMetadata]\n+        self,\n+        a1: torch.Tensor,\n+        a1q: torch.Tensor,\n+        w1: torch.Tensor,\n+        w2: torch.Tensor,\n+        topk_weights: torch.Tensor,\n+        topk_ids: torch.Tensor,\n+        activation: str,\n+        global_num_experts: int,\n+        local_num_experts: int,\n+        expert_map: Optional[torch.Tensor],\n+        w1_scale: Optional[torch.Tensor],\n+        w2_scale: Optional[torch.Tensor],\n+        w1_zp: Optional[torch.Tensor],\n+        w2_zp: Optional[torch.Tensor],\n+        a1q_scale: Optional[torch.Tensor],\n+        a2_scale: Optional[torch.Tensor],\n+        expert_tokens_meta: Optional[ExpertTokensMetadata],\n+        apply_router_weight_on_input: bool,\n     ) -> torch.Tensor:\n \n         _, M, N, K, top_k = _moe_problem_size(a1q, w1, w2, topk_ids)\n@@ -529,6 +553,7 @@ class FusedMoEModularKernel(torch.nn.Module):\n                 a1q=a1q,\n                 w1=w1,\n                 w2=w2,\n+                topk_weights=topk_weights,\n                 topk_ids=topk_ids,\n                 activation=activation,\n                 global_num_experts=global_num_experts,\n@@ -540,7 +565,8 @@ class FusedMoEModularKernel(torch.nn.Module):\n                 w2_zp=w2_zp,\n                 a1q_scale=a1q_scale,\n                 a2_scale=a2_scale,\n-                expert_tokens_meta=expert_tokens_meta)\n+                expert_tokens_meta=expert_tokens_meta,\n+                apply_router_weight_on_input=apply_router_weight_on_input)\n \n         # Chunking required case\n         assert num_chunks > 1\n@@ -557,11 +583,12 @@ class FusedMoEModularKernel(torch.nn.Module):\n         def slice_input_tensors(\n             chunk_idx: int\n         ) -> tuple[torch.Tensor, Optional[torch.Tensor],\n-                   Optional[torch.Tensor], torch.Tensor]:\n+                   Optional[torch.Tensor], torch.Tensor, torch.Tensor]:\n             s = chunk_idx * CHUNK_SIZE\n             e = min(s + CHUNK_SIZE, M)\n             return (a1q[s:e], _chunk_scales(a1q_scale, s, e),\n-                    _chunk_scales(a2_scale, s, e), topk_ids[s:e])\n+                    _chunk_scales(a2_scale, s,\n+                                  e), topk_ids[s:e], topk_weights[s:e])\n \n         def slice_output_tensor(chunk_idx: int) -> torch.Tensor:\n             assert fused_out.size(0) % M == 0, (\n@@ -594,7 +621,7 @@ class FusedMoEModularKernel(torch.nn.Module):\n                 expert_num_tokens_cpu=c_expert_num_tokens_cpu)\n \n         for chunk_idx in range(num_chunks):\n-            c_a1q, c_a1q_scale, c_a2_scale, c_topk_ids = (\n+            c_a1q, c_a1q_scale, c_a2_scale, c_topk_ids, c_topk_weights = (\n                 slice_input_tensors(chunk_idx))\n \n             c_expert_tokens_meta = None\n@@ -603,23 +630,26 @@ class FusedMoEModularKernel(torch.nn.Module):\n                     expert_tokens_meta, c_topk_ids, local_num_experts,\n                     expert_map)\n \n-            self._do_fused_experts(fused_out=slice_output_tensor(chunk_idx),\n-                                   a1=a1,\n-                                   a1q=c_a1q,\n-                                   w1=w1,\n-                                   w2=w2,\n-                                   topk_ids=c_topk_ids,\n-                                   activation=activation,\n-                                   global_num_experts=global_num_experts,\n-                                   local_num_experts=local_num_experts,\n-                                   expert_map=expert_map,\n-                                   w1_scale=w1_scale,\n-                                   w2_scale=w2_scale,\n-                                   w1_zp=w1_zp,\n-                                   w2_zp=w2_zp,\n-                                   a1q_scale=c_a1q_scale,\n-                                   a2_scale=c_a2_scale,\n-                                   expert_tokens_meta=c_expert_tokens_meta)\n+            self._do_fused_experts(\n+                fused_out=slice_output_tensor(chunk_idx),\n+                a1=a1,\n+                a1q=c_a1q,\n+                w1=w1,\n+                w2=w2,\n+                topk_weights=c_topk_weights,\n+                topk_ids=c_topk_ids,\n+                activation=activation,\n+                global_num_experts=global_num_experts,\n+                local_num_experts=local_num_experts,\n+                expert_map=expert_map,\n+                w1_scale=w1_scale,\n+                w2_scale=w2_scale,\n+                w1_zp=w1_zp,\n+                w2_zp=w2_zp,\n+                a1q_scale=c_a1q_scale,\n+                a2_scale=c_a2_scale,\n+                expert_tokens_meta=c_expert_tokens_meta,\n+                apply_router_weight_on_input=apply_router_weight_on_input)\n \n         return fused_out\n \n@@ -719,6 +749,7 @@ class FusedMoEModularKernel(torch.nn.Module):\n                 a1q=a1q,\n                 w1=w1,\n                 w2=w2,\n+                topk_weights=topk_weights,\n                 topk_ids=topk_ids,\n                 activation=activation,\n                 global_num_experts=global_num_experts,\n@@ -730,7 +761,8 @@ class FusedMoEModularKernel(torch.nn.Module):\n                 w2_zp=w2_zp,\n                 a1q_scale=a1q_scale,\n                 a2_scale=a2_scale,\n-                expert_tokens_meta=expert_tokens_meta)\n+                expert_tokens_meta=expert_tokens_meta,\n+                apply_router_weight_on_input=apply_router_weight_on_input)\n \n         self.prepare_finalize.finalize(\n             output, fused_out, topk_weights, topk_ids,\ndiff --git a/vllm/model_executor/layers/fused_moe/topk_weight_and_reduce.py b/vllm/model_executor/layers/fused_moe/topk_weight_and_reduce.py\nindex 9a5315b8b..fb398eec1 100644\n--- a/vllm/model_executor/layers/fused_moe/topk_weight_and_reduce.py\n+++ b/vllm/model_executor/layers/fused_moe/topk_weight_and_reduce.py\n@@ -48,11 +48,18 @@ class TopKWeightAndReduceNoOP(mk.TopKWeightAndReduce):\n               fused_expert_output: torch.Tensor, topk_weights: torch.Tensor,\n               topk_ids: torch.Tensor,\n               apply_router_weight_on_input: bool) -> torch.Tensor:\n-        # Relax this if an explicit copy is necessary. Note that,\n-        # if a copy is employed we have to make sure that the\n-        # tensors don't overlap\n-        assert output is None\n-        return fused_expert_output\n+        # Weight application and reduction operations are already done.\n+        if output is None:\n+            return fused_expert_output\n+\n+        # MoEPrepareAndFinalizeNoEP needs the output to be in the `output`\n+        # tensor.\n+        assert output.size() == fused_expert_output.size(), (\n+            \"output shape is expected to match the fused_expert_output shape. \"\n+            f\"But got output={output.size()}, \"\n+            f\"used_expert_output={fused_expert_output.size()}\")\n+        output.copy_(fused_expert_output, non_blocking=True)\n+        return output\n \n \n class TopKWeightAndReduceContiguous(mk.TopKWeightAndReduce):\ndiff --git a/vllm/model_executor/layers/fused_moe/triton_deep_gemm_moe.py b/vllm/model_executor/layers/fused_moe/triton_deep_gemm_moe.py\nindex fefe74cc4..2f35c19b7 100644\n--- a/vllm/model_executor/layers/fused_moe/triton_deep_gemm_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/triton_deep_gemm_moe.py\n@@ -122,6 +122,7 @@ class TritonOrDeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         hidden_states: torch.Tensor,\n         w1: torch.Tensor,\n         w2: torch.Tensor,\n+        topk_weights: torch.Tensor,\n         topk_ids: torch.Tensor,\n         activation: str,\n         global_num_experts: int,\n@@ -135,6 +136,7 @@ class TritonOrDeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n         workspace13: torch.Tensor,\n         workspace2: torch.Tensor,\n         expert_tokens_meta: Optional[mk.ExpertTokensMetadata],\n+        apply_router_weight_on_input: bool,\n     ):\n         use_deep_gemm = (self.allow_deep_gemm\n                          and (_valid_deep_gemm(hidden_states, w1, w2)\n@@ -148,6 +150,7 @@ class TritonOrDeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n             hidden_states,\n             w1,\n             w2,\n+            topk_weights,\n             topk_ids,\n             activation,\n             global_num_experts,\n@@ -161,4 +164,5 @@ class TritonOrDeepGemmExperts(mk.FusedMoEPermuteExpertsUnpermute):\n             workspace13,\n             workspace2,\n             expert_tokens_meta,\n+            apply_router_weight_on_input,\n         )", "apis": ["FusedMoEModularKernel.forward", "FusedMoEPermuteExpertsUnpermute.apply", "DeepGemmExperts.apply", "TritonExperts.apply", "TopKWeightAndReduceNoOP.apply"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/modular_kernel.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/deep_gemm_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/triton_deep_gemm_moe.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit makes non-trivial modifications to core source files (non-test code) by updating the internal Mixture of Experts (MoE) kernel logic. It adds new parameters (topk_weights and apply_router_weight_on_input) and changes workspace sizing and tensor indexing to incorporate weight-and-reduce operations directly inside high-performance components like TritonExperts and DeepGemmExperts. These modifications target a more efficient data handling strategy and kernel operation, which are likely aimed at optimizing performance on CPU workloads. The changes are not superficial refactoring or documentation fixes but adjustments to the computational kernels that are integral to performance.", "llm_api_reason": "This commit modifies several methods responsible for executing the fused MoE kernel. In particular, it adds new parameters (topk_weights and apply_router_weight_on_input) to the method signatures of various apply functions in implementations of the abstract API FusedMoEPermuteExpertsUnpermute, including those in DeepGemmExperts, TritonExperts, CutlassExpertsFp8, BatchedDeepGemmExperts, BatchedTritonOrDeepGemmExperts, and even in the FusedMoEModularKernelâ€™s internal methods. It also updates the TopKWeightAndReduce implementations accordingly. These changes affect the downstream behavior of the weight application and reduction step in the MoE inference pipeline."}
{"commit_hash": "22dd9c2730dc1124b9d0ac15fff223d0b8d9020b", "pr_url": "https://github.com/vllm-project/vllm/pull/20308", "pr_date": "2025-07-07", "timeline_text": "Copy link Contributor jvlunteren commented Jul 1, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR introduces an optimization to the unified triton attention kernel ( #16828 and #19152 ) that enhances prefill attention performance. The key improvement involves reducing the number of tiles processed during the prefill phase by leveraging the causal mask to skip unnecessary computations. This results in more efficient execution, particularly for long prompts. Performance The following results were obtained for meta-llama/Llama-3.1-8B-Instruct on an NVIDIA H100 GPU, by running $ VLLM_ATTENTION_BACKEND=TRITON_ATTN_VLLM_V1 VLLM_USE_V1=1 python benchmarks/benchmark_latency.py \\\n    --model meta-llama/Llama-3.1-8B-Instruct \\\n    --input-len <input-length> --output-len 4 \\\n    --batch-size <batch-size> for the current triton unified attention kernel, and the updated triton unified attention kernel (this PR). Results for a batch size 1 are shown in the following graph. The input (prompt) length (in tokens) was varied in these experiments across the following values: 500, 1000, 1500, 2000, 4000, 8000, and 16000. The number of warmup iterations and measurement iterations were left at the default values of 10 and 30 respectively. As illustrated in the graph above, this PR improves the performance of the Triton Unified Attention Kernel by approximately 1.75 times for a batch size of 1 and an input length of 16000 tokens. Additional results were collected using benchmark_serving.py , which only includes sequence lengths under 2000 tokens: Current triton unified attention kernel: $ python benchmarks/benchmark_serving.py \\\n    --model meta-llama/Llama-3.1-8B-Instruct \\\n    --dataset-name sharegpt \\\n    --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json\n============ Serving Benchmark Result ============\nSuccessful requests:                     984\nBenchmark duration (s):                  22.18\nTotal input tokens:                      210771\nTotal generated tokens:                  195009\nRequest throughput (req/s):              44.37\nOutput token throughput (tok/s):         8793.44\nTotal Token throughput (tok/s):          18297.62\n---------------Time to First Token----------------\nMean TTFT (ms):                          3874.12\nMedian TTFT (ms):                        3715.54\nP99 TTFT (ms):                           7060.57\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          88.60\nMedian TPOT (ms):                        51.50\nP99 TPOT (ms):                           233.82\n---------------Inter-token Latency----------------\nMean ITL (ms):                           40.26\nMedian ITL (ms):                         25.51\nP99 ITL (ms):                            239.07\n================================================== Updated triton unified attention kernel (this PR): $ python benchmarks/benchmark_serving.py \\\n    --model meta-llama/Llama-3.1-8B-Instruct \\\n    --dataset-name sharegpt \\\n    --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json\n============ Serving Benchmark Result ============\nSuccessful requests:                     984\nBenchmark duration (s):                  21.44\nTotal input tokens:                      210460\nTotal generated tokens:                  195875\nRequest throughput (req/s):              45.90\nOutput token throughput (tok/s):         9137.19\nTotal Token throughput (tok/s):          18954.74\n---------------Time to First Token----------------\nMean TTFT (ms):                          3588.36\nMedian TTFT (ms):                        3478.75\nP99 TTFT (ms):                           6540.15\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          83.17\nMedian TPOT (ms):                        47.72\nP99 TPOT (ms):                           220.70\n---------------Inter-token Latency----------------\nMean ITL (ms):                           38.12\nMedian ITL (ms):                         25.28\nP99 ITL (ms):                            223.90 Despite the relatively short prompt lengths used in this benchmark, the results still demonstrate a ~3% improvement in throughput, along with over 5% reductions in latency metrics (TTFT, TPOT, and ITL). Correctness V1 FlashAttention : VLLM_USE_V1=1 lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct --tasks gsm8k --num_fewshot 5 --batch_size auto --limit 500\n\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.794|Â±  |0.0181|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.772|Â±  |0.0188| Updated triton unified attention kernel (this PR): VLLM_USE_V1=1 VLLM_ATTENTION_BACKEND=TRITON_ATTN_VLLM_V1 lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct --tasks gsm8k --num_fewshot 5 --batch_size auto --limit 500\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.800|Â±  |0.0179|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.784|Â±  |0.0184| How is this performance improvement achieved? The triton unified attention kernel employs a loop that iteratively processes multiple tiles, computing attention locally for each tile and accumulating the results across tiles to form the final output. During prefill processing, a causal mask is applied to each tile to ensure that attention is computed only over past and current tokens. In the current implementation, up to half of the tiles may be fully masked out during processing, resulting in redundant computation and reduced efficiency. This PR addresses the issue by skipping such tiles, ensuring that only those containing unmasked tokens are processed. cc @tdoublep Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions optimization of causal masking for prefill attention â€¦ 9641d0f Signed-off-by: Jan van Lunteren <jvl@zurich.ibm.com> gemini-code-assist bot reviewed Jul 1, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @jvlunteren , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request focuses on optimizing the prefill attention phase within the Triton Unified Attention Kernel. The core improvement involves intelligently skipping unnecessary computations for fully masked tiles, leading to enhanced efficiency, especially for processing long input sequences. This results in notable performance gains across various prompt lengths while maintaining model correctness. Highlights Performance Optimization : Implemented an optimization to the Triton Unified Attention Kernel specifically targeting the prefill attention phase. Causal Mask Leveraging : The optimization works by leveraging the causal mask to identify and skip processing of fully masked tiles, thereby reducing redundant computations during prefill. Significant Speedup for Long Prompts : Achieves significant performance improvements for very long prompts, demonstrating up to a 1.75x speedup for 16,000-token inputs on NVIDIA H100 GPUs. General Throughput and Latency Gains : Even for typical serving workloads with shorter prompts, the PR shows measurable gains, including approximately 3% improvement in request throughput and over 5% reductions in Time to First Token (TTFT), Time per Output Token (TPOT), and Inter-token Latency (ITL). Correctness Verified : Correctness benchmarks using lm_eval confirm that the optimization maintains or slightly improves model accuracy metrics, ensuring no regression in output quality. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with ðŸ‘ and ðŸ‘Ž on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . â†© Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jul 1, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This PR optimizes the unified triton attention kernel by reducing the number of tiles processed during the prefill phase, leading to significant performance improvements, especially for long prompts. The change is well-justified by the performance benchmarks. A suggestion has been made to improve the readability of the core calculation for better maintainability. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/attention/ops/triton_unified_attention.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . formatting â€¦ 70a6abe Signed-off-by: Jan van Lunteren <jvl@zurich.ibm.com> Copy link github-actions bot commented Jul 1, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . SageMoore approved these changes Jul 1, 2025 View reviewed changes Copy link Contributor SageMoore left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good @jvlunteren . Thanks for the contribution! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 jvlunteren reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction tlrmchlsmth reviewed Jul 1, 2025 View reviewed changes vllm/attention/ops/triton_unified_attention.py Outdated Comment on lines 148 to 151 num_blocks = cdiv_fn( tl.minimum( context_len + q_block_local_idx * BLOCK_Q + (BLOCK_M - 1) // num_queries_per_kv + 1, seq_len), BLOCK_SIZE) Copy link Collaborator tlrmchlsmth Jul 1, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Worth adding a comment to explain the optimization? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 jvlunteren reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author jvlunteren Jul 2, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Done! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tlrmchlsmth approved these changes Jul 1, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Very nice find Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 jvlunteren reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction added comment â€¦ d26316e Signed-off-by: Jan van Lunteren <jvl@zurich.ibm.com> LucasWilkinson approved these changes Jul 7, 2025 View reviewed changes LucasWilkinson enabled auto-merge (squash) July 7, 2025 14:05 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jul 7, 2025 Hide details View details LucasWilkinson merged commit 22dd9c2 into vllm-project : main Jul 7, 2025 82 checks passed Uh oh! There was an error while loading. Please reload this page . huydhn pushed a commit\n        to huydhn/vllm\n      that referenced\n      this pull request Jul 8, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ 1572109 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> Chen-zexi pushed a commit\n        to Chen-zexi/vllm\n      that referenced\n      this pull request Jul 13, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ d1d442e vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> patrickvonplaten pushed a commit\n        to patrickvonplaten/vllm\n      that referenced\n      this pull request Jul 15, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ 182f805 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>\nSigned-off-by: Patrick von Platen <patrick.v.platen@gmail.com> LyrisZhong pushed a commit\n        to LyrisZhong/vllm\n      that referenced\n      this pull request Jul 23, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ 6dd288b vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ dc7e000 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> jvlunteren deleted the jvl-causal-mask-opt branch August 4, 2025 08:40 Pradyun92 pushed a commit\n        to Pradyun92/vllm\n      that referenced\n      this pull request Aug 6, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ 7d742bd vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> npanpaliya pushed a commit\n        to odh-on-pz/vllm-upstream\n      that referenced\n      this pull request Aug 6, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ bcda609 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> jinzhen-lin pushed a commit\n        to jinzhen-lin/vllm\n      that referenced\n      this pull request Aug 9, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ 6d70cdb vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com> epwalsh pushed a commit\n        to epwalsh/vllm\n      that referenced\n      this pull request Aug 27, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ 6f1d223 vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel ( â€¦ 873623a vllm-project#20308 )\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:44", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, lm_eval | PERF: TTFT, TTFT, TTFT | SERVING: Serving, Serving, serving | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:50:44", "models": ["meta-llama/Llama-3.1-8B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel (#20308)", "commit_message": "[Kernel] Optimize Prefill Attention in Unified Triton Attention Kernel (#20308)\n\nSigned-off-by: Jan van Lunteren <jvl@zurich.ibm.com>", "commit_date": "2025-07-07T19:08:12Z", "files_changed": ["vllm/attention/ops/triton_unified_attention.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 14, "num_non_test_edited_lines": 14, "commit_year": 2025}, "diff_text": "diff --git a/vllm/attention/ops/triton_unified_attention.py b/vllm/attention/ops/triton_unified_attention.py\nindex c65f09523..f9645f651 100644\n--- a/vllm/attention/ops/triton_unified_attention.py\n+++ b/vllm/attention/ops/triton_unified_attention.py\n@@ -145,7 +145,19 @@ def kernel_unified_attention_2d(\n                               mask=query_mask_1,\n                               other=0.0)\n \n-    num_blocks = cdiv_fn(seq_len, BLOCK_SIZE)\n+    # compute the length of the longest sequence prefix spanned by any\n+    # query token in the current q_block (q_block_local_idx)\n+    max_seq_prefix_len = context_len + q_block_local_idx * BLOCK_Q + (\n+        BLOCK_M - 1) // num_queries_per_kv + 1\n+\n+    # adjust for potential padding in the last q_block by considering the\n+    # actual sequence length\n+    max_seq_prefix_len = tl.minimum(max_seq_prefix_len, seq_len)\n+\n+    # calculate the number of tiles (blocks) that need to be processed to\n+    # cover the longest sequence prefix (due to causal masking, blocks beyond\n+    # this prefix can be skipped)\n+    num_blocks = cdiv_fn(max_seq_prefix_len, BLOCK_SIZE)\n \n     # iterate through tiles\n     for j in range(0, num_blocks):", "apis": ["torch.ops.vllm.unified_attention", "vllm.attention.ops.triton_unified_attention_2d"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/layer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/layer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/prefix_prefill.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test file (triton_unified_attention.py) with non-trivial changes that adjust how many attention blocks (tiles) are processed by computing the longest sequence prefix to potentially skip unnecessary work. Although the commit message mentions â€œoptimizeâ€ and specifies prefill attention, the changes illustrate a careful adjustment of the loop boundaries rather than a mere refactor, bug fix, or documentation update. This is a performance optimization affecting the kernelâ€™s computation, satisfying the conditions for general performance enhancement on CPU.", "llm_api_reason": "The commit updates the internal tritonâ€based kernel (kernel_unified_attention_2d) used for â€œunified attentionâ€ in prefill mode. It now computes the number of tiles to process based on the longest sequence prefix spanned by the query block (adjusting for padding) so that blocks beyond the causal mask need not be processed. Although this change is in lowâ€level kernel code, it affects the behavior of the unified attention custom op (exposed as a Python binding via torch.ops.vllm.unified_attention) that is used by the higherâ€level Attention layer in vLLM."}
{"commit_hash": "9a3b88328f7e434cac35b90ee463de6689f9a833", "pr_url": "https://github.com/vllm-project/vllm/pull/19939", "pr_date": "2025-06-21", "timeline_text": "Copy link Contributor vadiklyutiy commented Jun 21, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results Purpose Speedup of MRoPE prepare inputs. #16881 got stuck for a while. I combined parts of #16881 and #17617 to minimize changes and brings sufficient speedup. MRotaryEmbedding.get_next_input_positions_tensor takes a lot of time. Use numpy to speedup it. Performance Test Result I used vllm serve Qwen/Qwen2.5-VL-3B-Instruct --disable-log-requests --no-enable-prefix-caching as a server and fib benchmark -rps 50 --input-token-distribution uniform 250 300     --output-token-distribution uniform 150 250 --num-of-imgs-per-req 1     --img-ratios-per-req 512x512 -n 1000 --base-url http://localhost:8000     --endpoint v1/chat/completions --backend openai-chat to make workload (send 50 requests per sec with one 512x512 image per request). I decorated GPUModelRunner._prepare_inputs with nvtx to measure the time. _prepare_inputs average time Before: 3.869 ms With this PR: 1.487 ms (speedup 2.6x) For info, with #17617 : 2.511 ms E2E performance improvement on Qwen2.5-VL-3B-Instruct with high load is around 1.5%. cc @imkero @ywang96 @simon-mo Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Speedup MRoPE prepare inputs â€¦ c44c815 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> vadiklyutiy requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners June 21, 2025 17:54 Copy link github-actions bot commented Jun 21, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gemini-code-assist bot reviewed Jun 21, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @vadiklyutiy , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request focuses on a targeted performance enhancement for the MRoPE input preparation within the model executor. By transitioning a critical position calculation from a PyTorch-based approach to a more efficient NumPy implementation, it aims to reduce latency in the _prepare_inputs stage, thereby contributing to overall system throughput and responsiveness. The changes are designed to be minimally invasive while delivering substantial speedups in a key computational bottleneck. Highlights Performance Optimization : This pull request introduces a significant performance optimization for the Multi-Query Rotary Positional Embedding (MRoPE) input preparation, specifically targeting the get_next_input_positions_tensor function which was identified as a bottleneck. NumPy Integration : The core of the optimization involves refactoring the position calculation logic to leverage NumPy for improved efficiency. A new static method, mrope_assign_next_input_positions , has been added to MRotaryEmbedding to perform these calculations directly using NumPy arrays. GPU Model Runner Update : The GPUModelRunner has been updated to utilize this new NumPy-based method. This includes creating a NumPy view of the existing CPU-bound position tensor ( self.mrope_positions_cpu.numpy() ) to allow direct, efficient assignment of calculated positions. Measured Speedup : Performance benchmarks show a 2.59x speedup for the _prepare_inputs average time (from 3.869 ms to 1.496 ms) and an overall E2E performance improvement of approximately 1.5% on the Qwen2.5-VL-3B-Instruct model under high load. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with ðŸ‘ and ðŸ‘Ž on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . â†© Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mergify bot added qwen Related to Qwen models v1 labels Jun 21, 2025 gemini-code-assist bot reviewed Jun 21, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request aims to speed up the MRoPE input preparation by leveraging numpy for calculations on CPU-pinned memory, which is a great approach. The changes look solid and the performance improvement is significant. I have one suggestion to further optimize the new numpy-based function by using vectorized operations instead of nested Python loops. This should provide an additional performance boost and make the code more idiomatic. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/rotary_embedding.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . fix comment â€¦ 029f1e3 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jun 23, 2025 WoosukKwon approved these changes Jun 23, 2025 View reviewed changes vllm/model_executor/layers/rotary_embedding.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . fix another comment â€¦ 8baa18e Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> Hide details View details WoosukKwon merged commit 9a3b883 into vllm-project : main Jun 24, 2025 66 of 69 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Member ywang96 commented Jun 24, 2025 Sorry for the late comment but this is great! ðŸ‘ 1 vadiklyutiy reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Yikun mentioned this pull request Jun 24, 2025 [Bugfix] Sync MRotaryEmbedding interface change to recover CI vllm-project/vllm-ascend#1399 Merged Yikun pushed a commit\n        to vllm-project/vllm-ascend\n      that referenced\n      this pull request Jun 24, 2025 [Bugfix] Sync MRotaryEmbedding interface change to recover CI ( #1399 ) â€¦ 5f5800b ### What this PR does / why we need it?\n\nSync MRotaryEmbedding interface change to recover main CI\n( vllm-project/vllm#19939 )\n\n### Does this PR introduce _any_ user-facing change?\nNo\n\n### How was this patch tested?\nCI passed\n\n---------\n\nSigned-off-by: wangli <wangli858794774@gmail.com> gmarinho2 pushed a commit\n        to gmarinho2/vllm\n      that referenced\n      this pull request Jun 26, 2025 [PERF] Speedup of MRoPE prepare inputs ( vllm-project#19939 ) â€¦ 2d7f8c3 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> weijinqian0 pushed a commit\n        to weijinqian0/vllm-ascend\n      that referenced\n      this pull request Jun 30, 2025 [Bugfix] Sync MRotaryEmbedding interface change to recover CI ( vllm-pâ€¦ â€¦ f3dc487 â€¦roject#1399 )\n\n### What this PR does / why we need it?\n\nSync MRotaryEmbedding interface change to recover main CI\n( vllm-project/vllm#19939 )\n\n### Does this PR introduce _any_ user-facing change?\nNo\n\n### How was this patch tested?\nCI passed\n\n---------\n\nSigned-off-by: wangli <wangli858794774@gmail.com> xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Jun 30, 2025 [PERF] Speedup of MRoPE prepare inputs ( vllm-project#19939 ) â€¦ 0033778 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> wseaton pushed a commit\n        to wseaton/vllm\n      that referenced\n      this pull request Jun 30, 2025 [PERF] Speedup of MRoPE prepare inputs ( vllm-project#19939 ) â€¦ 874817e Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Will Eaton <weaton@redhat.com> wseaton pushed a commit\n        to wseaton/vllm\n      that referenced\n      this pull request Jun 30, 2025 [PERF] Speedup of MRoPE prepare inputs ( vllm-project#19939 ) â€¦ 3c936c6 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> wwl2755-google pushed a commit\n        to wwl2755-google/vllm\n      that referenced\n      this pull request Jul 1, 2025 [PERF] Speedup of MRoPE prepare inputs ( vllm-project#19939 ) â€¦ 4807582 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [PERF] Speedup of MRoPE prepare inputs ( vllm-project#19939 ) â€¦ f9327f0 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [PERF] Speedup of MRoPE prepare inputs ( vllm-project#19939 ) â€¦ f84ab7e Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:49", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, latency, Performance Test | SERVING: vllm serve, serve | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:50:49", "models": ["Qwen/Qwen2.5-VL-3B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=Qwen/Qwen2.5-VL-3B-Instruct --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model Qwen/Qwen2.5-VL-3B-Instruct --dataset-name random --num-prompts 1000", "commit_subject": "[PERF] Speedup of MRoPE prepare inputs (#19939)", "commit_message": "[PERF] Speedup of MRoPE prepare inputs (#19939)\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>", "commit_date": "2025-06-23T23:01:26-07:00", "files_changed": ["vllm/model_executor/layers/rotary_embedding.py", "vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 4, "num_edited_lines": 35, "num_non_test_edited_lines": 35, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/rotary_embedding.py b/vllm/model_executor/layers/rotary_embedding.py\nindex 9de233896..b7bb2affc 100644\n--- a/vllm/model_executor/layers/rotary_embedding.py\n+++ b/vllm/model_executor/layers/rotary_embedding.py\n@@ -26,6 +26,7 @@\n import math\n from typing import Any, Optional, Union\n \n+import numpy as np\n import torch\n import torch.nn as nn\n from transformers import PretrainedConfig\n@@ -1458,15 +1459,14 @@ class MRotaryEmbedding(RotaryEmbedding):\n         ]\n \n     @staticmethod\n-    def get_next_input_positions_tensor(\n-        mrope_position_delta: int,\n-        context_len: int,\n-        seq_len: int,\n-    ) -> torch.Tensor:\n-        return torch.arange(\n-            mrope_position_delta + context_len,\n-            mrope_position_delta + seq_len,\n-        ).expand(3, -1)\n+    def get_next_input_positions_tensor(out: np.ndarray, out_offset: int,\n+                                        mrope_position_delta: int,\n+                                        context_len: int, num_new_tokens: int):\n+\n+        values = np.arange(mrope_position_delta + context_len,\n+                           mrope_position_delta + context_len + num_new_tokens,\n+                           dtype=out.dtype)\n+        out[:, out_offset:out_offset + num_new_tokens] = values\n \n     @classmethod\n     def omni_get_updates_use_audio_in_video(\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 520d8fb18..40639fdf2 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -262,6 +262,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                 dtype=torch.int64,\n                 device=\"cpu\",\n                 pin_memory=self.pin_memory)\n+            self.mrope_positions_np = self.mrope_positions_cpu.numpy()\n \n         # Only relevant for models using ALiBi (e.g, MPT)\n         self.use_alibi = check_use_alibi(model_config)\n@@ -889,15 +890,13 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                 dst_start = mrope_pos_ptr\n                 dst_end = mrope_pos_ptr + completion_part_len\n \n-                self.mrope_positions_cpu[:, dst_start:dst_end] = \\\n-                    MRotaryEmbedding.get_next_input_positions_tensor(\n-                        req.mrope_position_delta,\n-                        context_len=num_computed_tokens +\n-                        prompt_part_len,\n-                        seq_len=num_computed_tokens +\n-                        prompt_part_len +\n-                        completion_part_len,\n-                    )\n+                MRotaryEmbedding.get_next_input_positions_tensor(\n+                    out=self.mrope_positions_np,\n+                    out_offset=dst_start,\n+                    mrope_position_delta=req.mrope_position_delta,\n+                    context_len=num_computed_tokens + prompt_part_len,\n+                    num_new_tokens=completion_part_len,\n+                )\n \n                 mrope_pos_ptr += completion_part_len", "apis": ["MRotaryEmbedding.get_next_input_positions_tensor", "GPUModelRunner._calc_mrope_positions"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/rotary_embedding.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/model_runner.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies source code in non-test files (rotary_embedding.py and gpu_model_runner.py) in a non-trivial manner. It replaces a Torch-based implementation with a NumPy-based implementation for preparing input positions, which can reduce overhead and thus improve performance on CPU. The commit message also has a \"[PERF]\" label and a description (\"Speedup of MRoPE prepare inputs\"), and the changes affect a high-level API related to model execution. The modifications are directly aimed at better performance and are testable on CPU without the need for GPU accelerators. All conditions for a performance optimization commit are satisfied.", "llm_api_reason": "This commit no longer creates and returns a new tensor for computing MRoPE position offsets. Instead, it modifies the static method in MRotaryEmbedding to take an output numpy array and an offset and write the new position values directly into that array. In addition, the GPU model runnerâ€™s code that uses this method was updated accordingly so that it now passes self.mrope_positions_np (built from the CPU buffer) and proper slice parameters. These changes reduce memory allocations and improve performance while preparing input positions for MRoPE."}
{"commit_hash": "7661e92ef85e552936195ae4b803e292b9a96776", "pr_url": "https://github.com/vllm-project/vllm/pull/19249", "pr_date": "2025-06-06", "timeline_text": "Copy link Collaborator jeejeelee commented Jun 6, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Essential Elements of an Effective PR Description Checklist The purpose of the PR, such as \"Fix some issue (link existing issues this PR will resolve)\". The test plan, such as providing test command. The test results, such as pasting the results comparison before and after, or e2e results Purpose Test Plan Test Result Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Done â€¦ 57ae581 Signed-off-by: Jee Jee Li <pandaleefree@gmail.com> Copy link Contributor gemini-code-assist bot commented Jun 6, 2025 Warning You have reached your daily quota limit. Please wait up to 24 hours and I will start processing your requests again! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . jeejeelee commented Jun 6, 2025 View reviewed changes vllm/model_executor/models/nemotron_h.py @@ -435,7 +444,6 @@ class NemotronHForCausalLM(nn.Module, HasInnerState, SupportsLoRA, SupportsPP, \"k_proj\", \"v_proj\", ], \"gate_up_proj\": [\"up_proj\", \"down_proj\"] Copy link Collaborator Author jeejeelee Jun 6, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It's incorrect property, delete it Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions jeejeelee commented Jun 6, 2025 View reviewed changes vllm/model_executor/models/nemotron_h.py ) -> None: super().__init__() self.up_proj = MergedColumnParallelLinear ( self.up_proj = ColumnParallelLinear ( Copy link Collaborator Author jeejeelee Jun 6, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Use ColumnParallelLinear , there's no need to use MergedColumnParallelLinear Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions jeejeelee requested a review\n  from DarkLight1337 June 6, 2025 03:52 Copy link github-actions bot commented Jun 6, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . DarkLight1337 approved these changes Jun 6, 2025 View reviewed changes Copy link Member DarkLight1337 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for simplifying! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions DarkLight1337 enabled auto-merge (squash) June 6, 2025 08:10 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Jun 6, 2025 Hide details View details DarkLight1337 merged commit 7661e92 into vllm-project : main Jun 6, 2025 79 checks passed Uh oh! There was an error while loading. Please reload this page . jeejeelee deleted the fix-nemotron_h branch June 6, 2025 10:31 minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [Model] Optimize nemotron_h implementation ( vllm-project#19249 ) â€¦ 8ba4ebe Signed-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: minpeter <kali2005611@gmail.com> avigny pushed a commit\n        to avigny/vllm\n      that referenced\n      this pull request Jul 31, 2025 [Model] Optimize nemotron_h implementation ( vllm-project#19249 ) â€¦ 80ed32a Signed-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: avigny <47987522+avigny@users.noreply.github.com> googlercolin pushed a commit\n        to googlercolin/vllm\n      that referenced\n      this pull request Aug 29, 2025 [Model] Optimize nemotron_h implementation ( vllm-project#19249 ) â€¦ 9cf44d5 Signed-off-by: Jee Jee Li <pandaleefree@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:52", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:50:52", "models": ["nvidia/Nemotron-4-340B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=nvidia/Nemotron-4-340B-Instruct --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model nvidia/Nemotron-4-340B-Instruct --dataset-name sharegpt --request-rate 1", "commit_subject": "[Model] Optimize nemotron_h implementation (#19249)", "commit_message": "[Model] Optimize nemotron_h implementation (#19249)\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>", "commit_date": "2025-06-06T10:05:14Z", "files_changed": ["vllm/model_executor/models/nemotron_h.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 7, "num_edited_lines": 24, "num_non_test_edited_lines": 24, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/models/nemotron_h.py b/vllm/model_executor/models/nemotron_h.py\nindex 2ef8d3115..3424efa80 100644\n--- a/vllm/model_executor/models/nemotron_h.py\n+++ b/vllm/model_executor/models/nemotron_h.py\n@@ -1,4 +1,5 @@\n # SPDX-License-Identifier: Apache-2.0\n+# SPDX-FileCopyrightText: Copyright contributors to the vLLM project\n \n # Adapted from https://github.com/vllm-project/vllm/blob/94d8ec8d2bcb4ec55e33022b313c7e978edf05e1/vllm/model_executor/models/bamba.py\n # Copyright 2024 HuggingFace Inc. team. All rights reserved.\n@@ -29,7 +30,7 @@ from vllm.distributed.parallel_state import get_pp_group\n from vllm.forward_context import get_forward_context\n from vllm.model_executor.layers.activation import ReLUSquaredActivation\n from vllm.model_executor.layers.layernorm import RMSNorm\n-from vllm.model_executor.layers.linear import (MergedColumnParallelLinear,\n+from vllm.model_executor.layers.linear import (ColumnParallelLinear,\n                                                QKVParallelLinear,\n                                                RowParallelLinear)\n from vllm.model_executor.layers.logits_processor import LogitsProcessor\n@@ -63,19 +64,22 @@ class NemotronHMLP(nn.Module):\n         config: NemotronHConfig,\n         quant_config: Optional[QuantizationConfig] = None,\n         bias: bool = False,\n+        prefix: str = \"\",\n     ) -> None:\n         super().__init__()\n-        self.up_proj = MergedColumnParallelLinear(\n+        self.up_proj = ColumnParallelLinear(\n             input_size=config.hidden_size,\n-            output_sizes=[config.intermediate_size],\n+            output_size=config.intermediate_size,\n             bias=bias,\n             quant_config=quant_config,\n+            prefix=f\"{prefix}.up_proj\",\n         )\n         self.down_proj = RowParallelLinear(\n             input_size=config.intermediate_size,\n             output_size=config.hidden_size,\n             bias=bias,\n             quant_config=quant_config,\n+            prefix=f\"{prefix}.down_proj\",\n         )\n         self.act_fn = ReLUSquaredActivation()\n \n@@ -99,9 +103,12 @@ class NemotronHMLPDecoderLayer(nn.Module):\n         super().__init__()\n         self.config = config\n \n-        self.mixer = NemotronHMLP(config,\n-                                  quant_config=quant_config,\n-                                  bias=config.mlp_bias)\n+        self.mixer = NemotronHMLP(\n+            config,\n+            quant_config=quant_config,\n+            bias=config.mlp_bias,\n+            prefix=f\"{prefix}.mixer\",\n+        )\n \n         self.norm = RMSNorm(config.hidden_size, eps=config.rms_norm_eps)\n \n@@ -207,12 +214,14 @@ class NemotronHAttention(nn.Module):\n             self.total_num_kv_heads,\n             bias=False,\n             quant_config=quant_config,\n+            prefix=f\"{prefix}.qkv_proj\",\n         )\n         self.o_proj = RowParallelLinear(\n             self.total_num_heads * self.head_dim,\n             config.hidden_size,\n             bias=False,\n             quant_config=quant_config,\n+            prefix=f\"{prefix}.o_proj\",\n         )\n \n         self.attn = Attention(\n@@ -253,7 +262,7 @@ class NemotronHAttentionDecoderLayer(nn.Module):\n             layer_idx,\n             cache_config,\n             quant_config,\n-            prefix,\n+            prefix=f\"{prefix}.mixer\",\n         )\n \n         self.norm = RMSNorm(config.hidden_size, eps=config.rms_norm_eps)\n@@ -435,7 +444,6 @@ class NemotronHForCausalLM(nn.Module, HasInnerState, SupportsLoRA, SupportsPP,\n             \"k_proj\",\n             \"v_proj\",\n         ],\n-        \"gate_up_proj\": [\"up_proj\", \"down_proj\"]\n     }\n \n     # LoRA specific attributes", "apis": ["NemotronHMLP.__init__", "NemotronHMLPDecoderLayer.__init__", "NemotronHAttention.__init__", "NemotronHAttentionDecoderLayer.__init__", "NemotronHModel.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/nemotron_h.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/configs/nemotron_h.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit modifies a non-test source file in the models directory and makes nonâ€trivial changes: it replaces a merged linear implementation (MergedColumnParallelLinear) with a regular one (ColumnParallelLinear), adjusts the argument signature (output_sizes â†’ output_size), and adds a new prefix parameter to several linear layer instantiations. Although the commit message says â€œOptimize nemotron_h implementationâ€ and the modifications seem to be aimed at improving the moduleâ€™s internal instantiation (which may affect runtime efficiency), the changes are not merely cosmetic or documentation fixes, and they appear targeted at refining the performance characteristics of a key model component. Therefore, considering it is an internal, CPU-testable tweak to a high-level API, the commit qualifies as performance/optimization related.", "llm_api_reason": "The changes in this commit update the NemotronH model implementation to pass a new \"prefix\" parameter into various child layer constructors and replace one linear layer API. In NemotronHMLPâ€™s constructor the MergedColumnParallelLinear call is replaced by ColumnParallelLinear with an added prefix parameter, and similarly the attention and decoder layer initializations are updated to consistently pass a formatted prefix to submodules (qkv_proj, o_proj, and the mixer in both MLP and Attention decoders). These modifications affect the initialization and forward-pass behavior of several high-level NemotronH APIs within the vLLM library."}
{"commit_hash": "e7523c2e031bc96740723ab63833d1cf94229ab4", "pr_url": "https://github.com/vllm-project/vllm/pull/18608", "pr_date": "2025-05-23", "timeline_text": "Copy link Contributor lgeiger commented May 23, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR replaces flashinfer.sampling.top_k_top_p_sampling_from_probs with flashinfer.sampling.top_k_top_p_sampling_from_logits . The top_k_top_p_sampling_from_props path calls (softmax) -> top_k_renorm_probs -> top_p_sampling_from_probs , top_k_top_p_sampling_from_logits calls top_k_mask_logits -> softmax -> top_p_sampling_from_probs which is faster. In a quick micro benchmark on an L40s GPU I am seeing a 9.3 % speedup with this PR and jitted flashinfer using Cuda 12.8. Expand for script to reproduce toy benchmark import time import torch import flashinfer . sampling from vllm . platforms import current_platform from vllm . utils import STR_DTYPE_TO_TORCH_DTYPE , FlexibleArgumentParser @ torch . inference_mode () def main ( batch_size : int , num_classes : int , dtype : torch . dtype , seed : int = 0 , num_warmup_iters : int = 5 , num_iters : int = 100 ,\n) -> None : current_platform . seed_everything ( seed ) torch . set_default_device ( \"cuda\" ) logits = torch . randn ( batch_size , num_classes , dtype = dtype ) k = torch . ones ( batch_size , dtype = torch . int32 ) * 64 p = torch . ones ( batch_size , dtype = dtype ) * 0.95 def run_cuda_benchmark ( num_iters : int ) -> float : torch . cuda . synchronize () start_time = time . perf_counter () for _ in range ( num_iters ): # probs = logits.softmax(dim=-1, dtype=torch.float32) # next_token_ids = flashinfer.sampling.top_k_top_p_sampling_from_probs( # probs, k, p, deterministic=True) next_token_ids = flashinfer . sampling . top_k_top_p_sampling_from_logits ( logits , k , p , deterministic = True ) torch . cuda . synchronize () end_time = time . perf_counter () return ( end_time - start_time ) / num_iters print ( \"Warming up...\" ) run_benchmark = run_cuda_benchmark run_benchmark ( num_iters = num_warmup_iters ) latency = run_benchmark ( num_iters = num_iters ) print ( f\"Kernel running time: { latency * 1000000 :.3f } us\" ) if __name__ == \"__main__\" : parser = FlexibleArgumentParser ( description = \"Benchmark the layernorm kernel.\" ) parser . add_argument ( \"--batch-size\" , type = int , default = 40 ) parser . add_argument ( \"--num-classes\" , type = int , default = 262208 ) parser . add_argument ( \"--add-residual\" , action = \"store_true\" ) parser . add_argument ( \"--dtype\" , type = str , choices = [ \"half\" , \"bfloat16\" , \"float\" ], default = \"float\" ) parser . add_argument ( \"--seed\" , type = int , default = 0 ) parser . add_argument ( \"--num-warmup-iters\" , type = int , default = 5 ) parser . add_argument ( \"--num-iters\" , type = int , default = 5000 , help = \"Number of benchmark iterations.\" ) args = parser . parse_args () print ( args ) main ( batch_size = args . batch_size , num_classes = args . num_classes , dtype = STR_DTYPE_TO_TORCH_DTYPE [ args . dtype ], seed = args . seed , num_warmup_iters = args . num_warmup_iters , num_iters = args . num_iters ,\n    ) End to end this also results in a 1.75 % improvement in throughput for google/gemma-3-12b-it : vllm serve google/gemma-3-12b-it --disable-log-requests\npython benchmarks/benchmark_serving.py --backend openai-chat --model google/gemma-3-12b-it --endpoint /v1/chat/completions --dataset-name hf --dataset-path lmarena-ai/VisionArena-Chat --hf-split train --num-prompts 1000 Baseline : ============ Serving Benchmark Result ============\nSuccessful requests:                     984\nBenchmark duration (s):                  187.19\nTotal input tokens:                      95362\nTotal generated tokens:                  115951\nRequest throughput (req/s):              5.26\nOutput token throughput (tok/s):         619.43\nTotal Token throughput (tok/s):          1128.87\n---------------Time to First Token----------------\nMean TTFT (ms):                          92076.57\nMedian TTFT (ms):                        87454.65\nP99 TTFT (ms):                           176229.15\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          123.15\nMedian TPOT (ms):                        126.41\nP99 TPOT (ms):                           474.41\n---------------Inter-token Latency----------------\nMean ITL (ms):                           134.43\nMedian ITL (ms):                         65.22\nP99 ITL (ms):                            592.16\n================================================== This PR : ============ Serving Benchmark Result ============\nSuccessful requests:                     984\nBenchmark duration (s):                  184.04\nTotal input tokens:                      95362\nTotal generated tokens:                  116033\nRequest throughput (req/s):              5.35\nOutput token throughput (tok/s):         630.47\nTotal Token throughput (tok/s):          1148.62\n---------------Time to First Token----------------\nMean TTFT (ms):                          90823.37\nMedian TTFT (ms):                        85678.72\nP99 TTFT (ms):                           175009.27\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          120.16\nMedian TPOT (ms):                        125.98\nP99 TPOT (ms):                           444.52\n---------------Inter-token Latency----------------\nMean ITL (ms):                           133.26\nMedian ITL (ms):                         65.33\nP99 ITL (ms):                            592.79\n================================================== Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions lgeiger requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners May 23, 2025 11:41 Copy link github-actions bot commented May 23, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label May 23, 2025 lgeiger force-pushed the flashinfer-sample-logits branch\n    from 2eb6e2f to a33f48e Compare May 23, 2025 11:43 mgoin reviewed May 23, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks reasonable to me, thanks for the performance analysis. Just a nit Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/sample/ops/topk_topp_sampler.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . lgeiger force-pushed the flashinfer-sample-logits branch\n    from 561d1d4 to 1046e20 Compare May 23, 2025 23:38 mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label May 24, 2025 lgeiger changed the title [Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs [V1][Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs May 25, 2025 Ubuntu and others added 2 commits May 25, 2025 23:32 [Sampler] Use FlashInfer sampling from logits â€¦ 005f201 Signed-off-by: Lukas Geiger <lukas.geiger94@gmail.com> Update docstrings â€¦ f3eecb9 Signed-off-by: Lukas Geiger <lukas.geiger94@gmail.com> lgeiger force-pushed the flashinfer-sample-logits branch\n    from 1046e20 to f3eecb9 Compare May 25, 2025 22:32 mgoin approved these changes May 26, 2025 View reviewed changes Hide details View details mgoin merged commit e7523c2 into vllm-project : main May 26, 2025 62 checks passed Uh oh! There was an error while loading. Please reload this page . lgeiger deleted the flashinfer-sample-logits branch May 26, 2025 15:55 gshtras added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request May 27, 2025 Upstream merge 2025 05 27 ( #557 ) â€¦ 1900335 * Add files via uploadAdd fused MoE kernel tuning configs (fp8_w8a8) for DeepSeek V3/R1 on a single-node 8x NVIDIA H20 96GB setup ( vllm-project#18337 )\n\n* [Misc] Fix typo ( vllm-project#18330 )\n\n* Neuron up mistral ( vllm-project#18222 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* fix CUDA_check redefinition in vllm-project#17918 ( vllm-project#18287 )\n\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\n\n* [neuron] fix authorization issue ( vllm-project#18364 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Misc] Allow `AutoWeightsLoader` to skip loading weights with specific substr in name ( vllm-project#18358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] [Bugfix]: tensor parallel with prompt embeds ( vllm-project#18171 )\n\nSigned-off-by: Nan2018 <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\n\n* [release] Change dockerhub username for TPU release ( vllm-project#18389 )\n\n* [Bugfix] fix adding bias twice in ipex GPTQ quantization ( vllm-project#18363 )\n\nSigned-off-by: rand-fly <randfly@outlook.com>\n\n* [doc] update env variable export ( vllm-project#18391 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Add LoRA code owner ( vllm-project#18387 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Update cpu.txt ( vllm-project#18398 )\n\nSigned-off-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\n\n* [CI] Add mteb testing to test the accuracy of the embedding model ( vllm-project#17175 )\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\n\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\n\n* [Misc] refactor prompt embedding examples ( vllm-project#18405 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Minor] Rename quantization nvfp4 to modelopt_fp4 ( vllm-project#18356 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Model] use AutoWeightsLoader for bloom ( vllm-project#18300 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [Kernel] update comment for KV shape in unified triton attn ( vllm-project#18099 )\n\nSigned-off-by: haochengxia <xhc_1007@163.com>\n\n* fix:Build torch wheel inline rather than picking from nightly ( vllm-project#18351 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\n\n* [TPU] Re-enable the Pallas MoE kernel ( vllm-project#18025 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [Bugfix] config.head_dim is now explicitly set to None ( vllm-project#18432 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [Bug] Fix moe_sum signature ( vllm-project#18440 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* Revert \"[Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\" ( vllm-project#18456 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Failing Test] Fix nixl connector test when promt size < block size ( vllm-project#18429 )\n\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\n\n* [Misc] MultiConnector._connectors type ( vllm-project#18423 )\n\nSigned-off-by: nicklucche <nlucches@redhat.com>\n\n* [Frontend] deprecate `--device` arg ( vllm-project#18399 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [V1] Fix general plugins not loaded in engine for multiproc ( vllm-project#18326 )\n\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\n\n* [Misc] refactor disaggregated-prefill-v1 example ( vllm-project#18474 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Failing Test] Fix test_events.py ( vllm-project#18460 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [MODEL] FalconH1 ( vllm-project#18406 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [Doc] fix arg docstring in linear layers ( vllm-project#18410 )\n\nSigned-off-by: giantcroc <1204449533@qq.com>\n\n* [Bugfix] Reduce moe_sum test size to avoid OOM ( vllm-project#18484 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* [Build] fix Dockerfile shell ( vllm-project#18402 )\n\n* [Misc] Update deprecation message for `--enable-reasoning` ( vllm-project#18404 )\n\n* [ROCm][Kernel][V1] Enable AMD Radeon GPU Custom Paged Attention on v1 ( vllm-project#17004 )\n\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\n\n* Remove incorrect env value\n\n* Revert \"[v1] Support multiple KV cache groups in GPU model runner ( vllm-project#17945 ) ( vllm-project#18459 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [FEAT][ROCm] Upgrade AITER MLA v1 backend ( vllm-project#18338 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\n\n* [Bugfix] Consistent ascii handling in tool parsers ( vllm-project#17704 )\n\nSigned-off-by: Sebastian SchÃ¶nnenbeck <sebastian.schoennenbeck@comma-soft.com>\n\n* [FalconH1] Fix output dtype in RMSNorm fallback path for Falcon-H1 (e.g. 0.5B) ( vllm-project#18500 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [MISC] update project urls in pyproject.toml ( vllm-project#18519 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [CI] Fix race condition with StatelessProcessGroup.barrier ( vllm-project#18506 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Intialize io_thread_pool attribute in the beginning. ( vllm-project#18331 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [Bugfix] Inconsistent token calculation compared to HF in llava family ( vllm-project#18479 )\n\nSigned-off-by: jaycha <jaycha@ncsoft.com>\n\n* [BugFix][DP] Send DP wave completion only from `dp_rank==0` ( vllm-project#18502 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\n\n* [Bugfix][Model] Make Olmo2Model weight loading return loaded weights ( vllm-project#18504 )\n\nSigned-off-by: Shane A <shanea@allenai.org>\n\n* [Bugfix] Fix LoRA test ( vllm-project#18518 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Doc] Fix invalid JSON in example args ( vllm-project#18527 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Neuron] Update Dockerfile.neuron to use latest neuron release (2.23) ( vllm-project#18512 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* Update default neuron config for speculation ( vllm-project#18274 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* Order sequence ids + config update to support specifying custom quantization layers ( vllm-project#18279 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18526 )\n\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Add kwargs to RequestOutput __init__ to be forward compatible ( vllm-project#18513 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [CI/Build] Update bamba test model location ( vllm-project#18544 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc] Support --stream arg in openai_completion_client.py script ( vllm-project#18388 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Use random hidden states in dummy sampler run ( vllm-project#18543 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\n\n* [Doc] Add stream flag for chat completion example ( vllm-project#18524 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [BugFix][CPU] Fix x86 SHM distributed module initialization ( vllm-project#18536 )\n\nSigned-off-by: jiang.li <jiang1.li@intel.com>\n\n* [Misc] improve Automatic Prefix Caching example ( vllm-project#18554 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Call `ndarray.tobytes()` directly instead of `ndarray.data.tobytes()` ( vllm-project#18347 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Bugfix] make `test_openai_schema.py` pass ( vllm-project#18224 )\n\nSigned-off-by: David Xia <david@davidxia.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Platform] Move platform check to right place ( vllm-project#18470 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Compile][Platform] Make PiecewiseBackend pluggable and extendable ( vllm-project#18076 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Build/CI] Fix CUDA 11.8 build ( vllm-project#17679 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Tool] Add NIXL installation script ( vllm-project#18172 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [V1][Spec Decode][Bugfix] Load quantize weights for EAGLE ( vllm-project#18290 )\n\n* [Frontend][Bug Fix] Update llama4 pythonic jinja template and llama4_pythonic parser ( vllm-project#17917 )\n\nSigned-off-by: Kai Wu <kaiwu@meta.com>\n\n* [Frontend] [Core] Add Tensorizer support for V1, LoRA adapter serialization and deserialization ( vllm-project#17926 )\n\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\n\n* [AMD] [P/D] Compute num gpus for ROCm correctly in run_accuracy_test.sh ( vllm-project#18568 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* Re-submit: Fix: Proper RGBA -> RGB conversion for PIL images. ( vllm-project#18569 )\n\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\n\n* [V1][Spec Decoding] Use model_loader.get_model() to load models ( vllm-project#18273 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Enable hybrid attention models for Transformers backend ( vllm-project#18494 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] refactor: simplify input validation and num_requests handling in _convert_v1_inputs ( vllm-project#18482 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [BugFix] Increase TP execute_model timeout ( vllm-project#18558 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [Bugfix] Set `KVTransferConfig.engine_id` in post_init ( vllm-project#18576 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Spec Decode] Make EAGLE3 draft token ID mapping optional ( vllm-project#18488 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Neuron] Remove bypass on EAGLEConfig and add a test ( vllm-project#18514 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\n\n* [Bugfix][Benchmarks] Fix a benchmark of deepspeed-mii backend to use api_key ( vllm-project#17291 )\n\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\n\n* [Misc] Replace `cuda` hard code with `current_platform` ( vllm-project#16983 )\n\nSigned-off-by: shen-shanshan <467638484@qq.com>\n\n* [Hardware] correct method signatures for HPU,ROCm,XPU ( vllm-project#18551 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\n\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\n\n* [Feature]Add async tensor parallelism using compilation pass ( vllm-project#17882 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* [Doc] Update quickstart and install for cu128 using `--torch-backend=auto` ( vllm-project#18505 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Feature][V1]: suupports cached_tokens in response usage ( vllm-project#18149 )\n\nCo-authored-by: simon-mo <xmo@berkeley.edu>\n\n* [Bugfix] Add half type support in reshape_and_cache_cpu_impl on x86 cpu platform ( vllm-project#18430 )\n\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\n\n* Migrate docs from Sphinx to MkDocs ( vllm-project#18145 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Revert \"[V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\" ( vllm-project#18600 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Model] Fix baichuan model loader for tp ( vllm-project#18597 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [V0][Bugfix] Fix parallel sampling performance regression when guided decoding is enabled ( vllm-project#17731 )\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\n\n* Add myself as docs code owner ( vllm-project#18605 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Hardware][CPU] Update intel_extension_for_pytorch 2.7.0 and move to `requirements/cpu.txt`  ( vllm-project#18542 )\n\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\n\n* [CI] fix kv_cache_type argument ( vllm-project#18594 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Doc] Fix indent of contributing to vllm ( vllm-project#18611 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* Replace `{func}` with mkdocs style links ( vllm-project#18610 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Fix V1 flag being set in entrypoints tests ( vllm-project#18598 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Fix examples with code blocks in docs ( vllm-project#18609 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix transformers model impl ignored for mixtral quant ( vllm-project#18602 )\n\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\n\n* Include private attributes in API documentation ( vllm-project#18614 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] add Haystack integration ( vllm-project#18601 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Build/CI] Fixup CUDA compiler version check for CUDA_SUPPORTED_ARCHS ( vllm-project#18579 )\n\n* [Doc] Fix markdown list indentation for MkDocs rendering ( vllm-project#18620 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [Doc] Use a different color for the announcement ( vllm-project#18616 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Refactor pplx init logic to make it modular (prepare for deepep) ( vllm-project#18200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix figures in design doc ( vllm-project#18612 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Change mkdocs to not use directory urls ( vllm-project#18622 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Redo \"Support multiple KV cache groups in GPU model runner ( vllm-project#17945 )\" ( vllm-project#18593 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc] fix list formatting ( vllm-project#18624 )\n\nSigned-off-by: David Xia <david@davidxia.com>\n\n* [Doc] Fix top-level API links/docs ( vllm-project#18621 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Avoid documenting dynamic / internal modules ( vllm-project#18626 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix broken links and unlinked docs, add shortcuts to home sidebar ( vllm-project#18627 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support Deepseek MTP ( vllm-project#18435 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use prebuilt FlashInfer x86_64 PyTorch 2.7 CUDA 12.8 wheel for CI ( vllm-project#18537 )\n\nSigned-off-by: Huy Do <huydhn@gmail.com>\n\n* [CI] Enable test_initialization to run on V1 ( vllm-project#16736 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Doc] Update references to doc files ( vllm-project#18637 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ModelOpt] Introduce VLLM_MAX_TOKENS_PER_EXPERT_FP4_MOE env var to control blockscale tensor allocation ( vllm-project#18160 )\n\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\n\n* [Bugfix] Migrate to REGEX Library to prevent catastrophic backtracking ( vllm-project#18454 )\n\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\n\n* [Bugfix][Nixl] Fix Preemption Bug ( vllm-project#18631 )\n\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\n\n* config.py: Clarify that only local GGUF checkpoints are supported. ( vllm-project#18623 )\n\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\n\n* FIX MOE issue in AutoRound format ( vllm-project#18586 )\n\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\n\n* [V1][Spec Decode] Small refactors to improve eagle bookkeeping performance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Frontend] improve vllm serve --help display ( vllm-project#18643 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Model] Add support for Qwen2.5-Omni-7B-AWQ (Qwen2_5OmniForConditionalGeneration) ( vllm-project#18647 )\n\n* [V1][Spec Decode] Support multi-layer eagle draft model ( vllm-project#18030 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Doc] Update README links, mark external links ( vllm-project#18635 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC][pre-commit] Add pre-commit check for triton import ( vllm-project#17716 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Doc] Fix indentation problems in V0 Paged Attention docs ( vllm-project#18659 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Add community links ( vllm-project#18657 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] use AutoWeightsLoader for gpt2 ( vllm-project#18625 )\n\nSigned-off-by: zt2370 <ztang2370@gmail.com>\n\n* [Doc] Reorganize user guide ( vllm-project#18661 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] `chmod +x` to `cleanup_pr_body.sh` ( vllm-project#18650 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC] typo fix and clean import ( vllm-project#18664 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [BugFix] Fix import error for fused_moe ( vllm-project#18642 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [CI] enforce import regex instead of re ( vllm-project#18665 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* fix(regression): clone from reference items ( vllm-project#18662 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [CI/Build] fix permission denied issue ( vllm-project#18645 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [BugFix][Spec Decode] Improve Prefix Caching Logic in Speculative Decoding ( vllm-project#18668 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Fix _pickle.PicklingError: Can't pickle <class 'transformers_modules.deepseek-ai.DeepSeek-V2-Lite... ( vllm-project#18640 )\n\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\n\n* [MISC] correct signature for LoaderFunction ( vllm-project#18670 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc]Replace `cuda` hard code with `current_platform` in Ray ( vllm-project#14668 )\n\nSigned-off-by: noemotiovon <757486878@qq.com>\n\n* [Misc][ModelScope] Change to use runtime VLLM_USE_MODELSCOPE ( vllm-project#18655 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [VLM] Initialize video input support for InternVL models ( vllm-project#18499 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* Speed up the `kernels/quantization/` tests ( vllm-project#18669 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [BUGFIX] catch subclass first for try...except ( vllm-project#18672 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc] Reduce logs on startup ( vllm-project#18649 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] fix broken links ( vllm-project#18671 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [doc] improve readability ( vllm-project#18675 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix cpu usage and cache hit stats reporting on cpu environment ( vllm-project#18674 )\n\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [CI/build] fix no regex ( vllm-project#18676 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] small improve ( vllm-project#18680 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix profiling dummy data for Pixtral ( vllm-project#18677 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Core][Multimodal] Convert PIL Image to array without data copy when hashing ( vllm-project#18682 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [CI/Build][Doc] Update `gte-Qwen2-1.5B-instruct` usage ( vllm-project#18683 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Fixed the abnormally high TTFT issue in the PD disaggregation example ( vllm-project#18644 )\n\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\n\n* refactor: simplify request handler, use positive condition check for handler assignment ( vllm-project#18690 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Fix the lm_head in gpt_bigcode in lora mode ( vllm-project#6357 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\n\n* [CI] add missing argument ( vllm-project#18694 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [GH] Add issue template for reporting CI failures ( vllm-project#18696 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix issue template format ( vllm-project#18699 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Mistral-format models with sliding window ( vllm-project#18693 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Replace `math.isclose` with `pytest.approx` ( vllm-project#18703 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] fix dump_input for str type ( vllm-project#18697 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Model] Add support for YARN in NemotronNAS models ( vllm-project#18427 )\n\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\n\n* [CI/Build] Split pooling and generation extended language models tests in CI ( vllm-project#18705 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Add tensor parallel size = 2 test to HPU CI ( vllm-project#18709 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Misc] add AutoGen integration ( vllm-project#18712 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix]: handle hf-xet CAS error when loading Qwen3 weights in vLLM ( vllm-project#18701 )\n\n* [Doc] Improve API docs ( vllm-project#18713 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples and further reorganize user guide ( vllm-project#18666 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Llama GGUF initialization ( vllm-project#18717 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs ( vllm-project#18608 )\n\n* Convert `examples` to `ruff-format` ( vllm-project#18400 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Model][Gemma3] Simplify image input validation ( vllm-project#18710 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Misc] improve web section group title display ( vllm-project#18684 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [V1][Quantization] Add CUDA graph compatible v1 GGUF support ( vllm-project#18646 )\n\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Model][Gemma3] Cast image pixel values already on CPU ( vllm-project#18732 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [FEAT] [ROCm] Upgrade AITER Fused MoE kernels. ( vllm-project#18271 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Doc] Update OOT model docs ( vllm-project#18742 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Update reproducibility doc and example ( vllm-project#18741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] improve docs ( vllm-project#18734 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* feat(rocm-support): support mamba2 on rocm ( vllm-project#18565 )\n\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Fix multiple containers using the same name in run-hpu-test.sh ( vllm-project#18752 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Doc] cleanup deprecated flag for doc ( vllm-project#18715 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* Minor fix about MooncakeStoreConnector ( vllm-project#18721 )\n\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\n\n* [Build] fix cpu build missing libtbbmalloc.so ( vllm-project#18744 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [BUG FIX] minicpm ( vllm-project#18739 )\n\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\n\n* [Doc]  Convert Sphinx directives ( `{class}`, `{meth}`, `{attr}`, ...) to MkDocs format for better documentation linking ( vllm-project#18663 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [CI/Build] Remove imports of built-in `re` ( vllm-project#18750 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Metrics] Add API for accessing in-memory Prometheus metrics ( vllm-project#17010 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Disable prefix cache by default for benchmark ( vllm-project#18639 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* optimize get_kv_cache_torch_dtype ( vllm-project#18531 )\n\nSigned-off-by: idellzheng <idellzheng@tencent.com>\n\n* [Core] Automatically cast multi-modal input dtype ( vllm-project#18756 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Mistral tool calling when content is list ( vllm-project#18729 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n---------\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Nan2018 <nan@protopia.ai>\nSigned-off-by: rand-fly <randfly@outlook.com>\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: calvin chen <120380290@qq.com>\nSigned-off-by: haochengxia <xhc_1007@163.com>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: Bill Nell <bnell@redhat.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\nSigned-off-by: nicklucche <nlucches@redhat.com>\nSigned-off-by: Kebe <mail@kebe7jun.com>\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\nSigned-off-by: rabi <ramishra@redhat.com>\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nSigned-off-by: giantcroc <1204449533@qq.com>\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nSigned-off-by: Sebastian SchÃ¶nnenbeck <sebastian.schoennenbeck@comma-soft.com>\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: jaycha <jaycha@ncsoft.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Shane A <shanea@allenai.org>\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nSigned-off-by: Linkun <github@lkchen.net>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: googs1025 <googs1025@gmail.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: jiang.li <jiang1.li@intel.com>\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\nSigned-off-by: David Xia <david@davidxia.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nSigned-off-by: Kai Wu <kaiwu@meta.com>\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\nSigned-off-by: shen-shanshan <467638484@qq.com>\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\nSigned-off-by: cascade812 <cascade812@outlook.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Huy Do <huydhn@gmail.com>\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: zt2370 <ztang2370@gmail.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\nSigned-off-by: noemotiovon <757486878@qq.com>\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nSigned-off-by: idellzheng <idellzheng@tencent.com>\nCo-authored-by: sunyicode0012 <116338547+sunyicode0012@users.noreply.github.com>\nCo-authored-by: Gong Shufan <2624542821@qq.com>\nCo-authored-by: Satyajith Chilappagari <satchill@amazon.com>\nCo-authored-by: Lucia Fang <116399278+luccafong@users.noreply.github.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Nan Qin <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Random Fly <renfei8@live.cn>\nCo-authored-by: Reid <61492567+reidliu41@users.noreply.github.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\nCo-authored-by: wang.yuqi <noooop@126.com>\nCo-authored-by: ç‡ƒ <wulipc@163.com>\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Calvin Chen <45745657+calvin0327@users.noreply.github.com>\nCo-authored-by: Percy <xhc_1007@163.com>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: bnellnm <49004751+bnellnm@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: wwl2755 <wangwenlong2755@gmail.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Kebe <mail@kebe7jun.com>\nCo-authored-by: Yong Hoon Shin <48474650+sarckk@users.noreply.github.com>\nCo-authored-by: Rabi Mishra <ramishra@redhat.com>\nCo-authored-by: Dhia Eddine Rhaiem <163106757+dhiaEddineRhaiem@users.noreply.github.com>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\nCo-authored-by: GiantCroc <1204449533@qq.com>\nCo-authored-by: Hyogeun Oh (ì˜¤íš¨ê·¼) <ohg3417@gmail.com>\nCo-authored-by: Hosang <156028780+hyoon1@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Sebastian Schoennenbeck <sebastian.schoennenbeck@comma-soft.com>\nCo-authored-by: Ning Xie <andy.xning@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: youngrok cha <line0930@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\nCo-authored-by: Shane A <shanea@allenai.org>\nCo-authored-by: aws-elaineyz <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: CYJiang <86391540+googs1025@users.noreply.github.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Lukas Geiger <lukas.geiger94@gmail.com>\nCo-authored-by: David Xia <david@davidxia.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ekagra Ranjan <3116519+ekagra-ranjan@users.noreply.github.com>\nCo-authored-by: Kai Wu <kaiwu@meta.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Chenheli Hua <huachenheli@outlook.com>\nCo-authored-by: Benjamin Chislett <chislett.ben@gmail.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Teruaki Ishizaki <tell.ishi@gmail.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: RonaldBXu <72748153+RonaldBXu@users.noreply.github.com>\nCo-authored-by: cascade <cascade812@outlook.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Yuqi Zhang <zhangyuqi94@gmail.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Kay Yan <kay.yan@daocloud.io>\nCo-authored-by: Tristan Leclercq <49700633+tristanleclercq@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\nCo-authored-by: Huy Do <huydhn@gmail.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: Feng XiaoLong <79261065+Crucifixion-Fxl@users.noreply.github.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Mathieu BorderÃ© <mathieu@bordere.org>\nCo-authored-by: Wenhua Cheng <wenhua.cheng@intel.com>\nCo-authored-by: qizixi <22851944+zixi-qi@users.noreply.github.com>\nCo-authored-by: Yuanhao WU <Nalkey@users.noreply.github.com>\nCo-authored-by: ztang2370 <ztang2370@gmail.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: Seiji Eicher <58963096+eicherseiji@users.noreply.github.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: AlexZhao <zhaohaidao2008@hotmail.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Naveassaf <55059536+Naveassaf@users.noreply.github.com>\nCo-authored-by: Åukasz Durejko <lukasz.durejko@intel.com>\nCo-authored-by: dylan <xuhao296@qq.com>\nCo-authored-by: almersawi <43927639+almersawi@users.noreply.github.com>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: Åukasz Durejko <ldurejko@habana.ai>\nCo-authored-by: maobaolong <baoloongmao@tencent.com>\nCo-authored-by: Shawn Huang <57223022+huangyuxiang03@users.noreply.github.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: chunxiaozheng <55471457+chunxiaozheng@users.noreply.github.com> amitm02 pushed a commit\n        to amitm02/vllm\n      that referenced\n      this pull request Jun 1, 2025 [V1][Sampler] Improve performance of FlashInfer sampling by sampling â€¦ â€¦ ab2be96 â€¦logits instead of probs ( vllm-project#18608 )\n\nSigned-off-by: amit <amit.man@gmail.com> minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [V1][Sampler] Improve performance of FlashInfer sampling by sampling â€¦ â€¦ e158269 â€¦logits instead of probs ( vllm-project#18608 )\n\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:50:56", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, TTFT | SERVING: vllm serve, vllm serve, Serving | TEST: test, test, Test", "analysis_extracted_at": "2025-09-07 17:50:56", "models": ["google/gemma-3-12b-it"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_serving.py --backend openai-chat --model google/gemma-3-12b-it --endpoint /v1/chat/completions --dataset-name hf --dataset-path lmarena-ai/VisionArena-Chat --hf-split train --num-prompts 1000", "commit_subject": "[V1][Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs (#18608)", "commit_message": "[V1][Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs (#18608)", "commit_date": "2025-05-26T11:49:36-04:00", "files_changed": ["vllm/v1/sample/ops/topk_topp_sampler.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 17, "num_non_test_edited_lines": 17, "commit_year": 2025}, "diff_text": "diff --git a/vllm/v1/sample/ops/topk_topp_sampler.py b/vllm/v1/sample/ops/topk_topp_sampler.py\nindex 5d8b3f423..4a5fbb10d 100644\n--- a/vllm/v1/sample/ops/topk_topp_sampler.py\n+++ b/vllm/v1/sample/ops/topk_topp_sampler.py\n@@ -89,18 +89,18 @@ class TopKTopPSampler(nn.Module):\n         p: Optional[torch.Tensor],\n     ) -> torch.Tensor:\n         \"\"\"More optimized implementation for top-k and top-p sampling.\"\"\"\n-        probs = logits.softmax(dim=-1, dtype=torch.float32)\n         if k is None and p is None:\n             # We prefer `random_sample` over `flashinfer_sample` when sorting is\n             # not needed. This is because `random_sample` does not require\n             # CPU-GPU synchronization while `flashinfer_sample` does.\n+            probs = logits.softmax(dim=-1, dtype=torch.float32)\n             return random_sample(probs, generators)\n         if generators:\n             logger.warning(\"FlashInfer 0.2.3+ does not support \"\n                            \"per-request generators. Falling back to \"\n                            \"PyTorch-native implementation.\")\n             return self.forward_native(logits, generators, k, p)\n-        return flashinfer_sample(probs, k, p, generators)\n+        return flashinfer_sample(logits, k, p, generators)\n \n     def forward_tpu(\n         self,\n@@ -254,17 +254,17 @@ def random_sample(\n \n \n def flashinfer_sample(\n-    probs: torch.Tensor,\n+    logits: torch.Tensor,\n     k: Optional[torch.Tensor],\n     p: Optional[torch.Tensor],\n     generators: dict[int, torch.Generator],\n ) -> torch.Tensor:\n-    \"\"\"Sample from the probabilities using FlashInfer.\n+    \"\"\"Sample from the logits using FlashInfer.\n \n     Statistically, this function is equivalent to the `random_sample` function.\n     However, this function is faster because it avoids sorting the logits tensor\n     via rejection sampling.\n-    \n+\n     NOTE: The outputs of this function do not necessarily match the outputs of\n     the `random_sample` function. It only guarantees that the outputs are\n     statistically equivalent.\n@@ -274,18 +274,19 @@ def flashinfer_sample(\n     the synchronization overhead.\n     \"\"\"\n     assert not (k is None and p is None)\n-\n     if k is None:\n         # Top-p only.\n+        probs = logits.softmax(dim=-1, dtype=torch.float32)\n         next_token_ids = flashinfer.sampling.top_p_sampling_from_probs(\n             probs, p, deterministic=True)\n     elif p is None:\n         # Top-k only.\n+        probs = logits.softmax(dim=-1, dtype=torch.float32)\n         next_token_ids = flashinfer.sampling.top_k_sampling_from_probs(\n             probs, k, deterministic=True)\n     else:\n         # Both top-k and top-p.\n-        next_token_ids = (flashinfer.sampling.top_k_top_p_sampling_from_probs(\n-            probs, k, p, deterministic=True))\n+        next_token_ids = flashinfer.sampling.top_k_top_p_sampling_from_logits(\n+            logits, k, p, deterministic=True)\n \n     return next_token_ids.view(-1)", "apis": ["vllm.v1.sample.ops.topk_topp_sampler.TopKTopPSampler.forward_cuda", "vllm.v1.sample.ops.topk_topp_sampler.flashinfer_sample"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/ops/topk_topp_sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file where it changes how sampling is performed. Specifically, it removes redundant softmax computations and directly passes logits to the FlashInfer sampling functions, which is a change aimed at reducing computational overhead (i.e., optimizing performance). The commit message clearly indicates the intended performance improvement and the changes affect a high-level API without being a refactoring or bug fix. The modifications are relevant to CPU performance and not tied to any specific hardware. Therefore, the commit meets the conditions for a performance or optimization change.", "llm_api_reason": "The commit changes how FlashInfer sampling is performed by using the raw logits rather than the softmax probabilities. In the TopKTopPSampler.forward_cuda method, the flashinfer_sample function is now called with logits, and in flashinfer_sample itself, the parameter is renamed from â€œprobsâ€ to â€œlogitsâ€ with the appropriate softmax applied conditionally. This improves performance by avoiding unnecessary computation and synchronization overhead."}
{"commit_hash": "d55e446d1320d0f5f22bc3584f81f18d7924f166", "pr_url": "https://github.com/vllm-project/vllm/pull/18424", "pr_date": "2025-05-20", "timeline_text": "Copy link Collaborator zixi-qi commented May 20, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Applied several small refactors to improve eagle bookkeeping performance: async h2d with pinned memory removed a synchronization point by caching total number of tokens in SpecDecodeMetadata use torch.zeros to replace torch.empty + assignment (h2d) Saves ~50us time per iteration on Llama3 8b w/ bs=2. before after Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 draftbk reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction zixi-qi requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners May 20, 2025 15:58 Copy link github-actions bot commented May 20, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label May 20, 2025 Copy link mergify bot commented May 21, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @zixi-qi . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label May 21, 2025 WoosukKwon reviewed May 21, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @zixi-qi Thanks for the PR! Left some minor comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/worker/gpu_model_runner.py Outdated Comment on lines 1379 to 1380 num_tokens = spec_decode_metadata.total_num_scheduled_tokens - \\ sum(num_rejected_tokens) Copy link Collaborator WoosukKwon May 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: please refrain from using \\ Suggested change num_tokens = spec_decode_metadata . total_num_scheduled_tokens - \\ sum ( num_rejected_tokens ) num_tokens = ( spec_decode_metadata . total_num_scheduled_tokens - sum ( num_rejected_tokens ) ) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 zixi-qi reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator Author zixi-qi May 23, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks updated! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/worker/gpu_model_runner.py Outdated @@ -883,6 +883,7 @@ def _calc_spec_decode_metadata( target_logits_indices=target_logits_indices, bonus_logits_indices=bonus_logits_indices, logits_indices=logits_indices, total_num_scheduled_tokens=cu_num_scheduled_tokens[-1], Copy link Collaborator WoosukKwon May 21, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do we actually need to store it in SpecDecodeMetadata ? I'm wondering because the same variable is available in execute_model . Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author zixi-qi May 23, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment You are right, removed the additional field in SpecDecodeMetadata Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link leo-cf-tian commented May 21, 2025 (Follow-up to a deleted comment) I flagged an issue here a few minutes ago and it turns out the error was from the base repo, not this PR. Deleted the earlier comment from earlier and made this one to avoid confusion. Sorry if I cause any trouble. ðŸ‘ 2 zixi-qi and WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot removed\n  the needs-rebase label May 23, 2025 zixi-qi force-pushed the spec_decode_perf branch\n    from 20b3864 to d07a3c5 Compare May 23, 2025 21:03 Copy link mergify bot commented May 23, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @zixi-qi . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label May 23, 2025 zixi-qi added 3 commits May 23, 2025 15:18 small perf improvements â€¦ 2e5efa8 Signed-off-by: qizixi <qizixi@meta.com> address comments â€¦ 0e1d9af Signed-off-by: qizixi <qizixi@meta.com> rebase â€¦ 2945178 Signed-off-by: qizixi <qizixi@meta.com> zixi-qi force-pushed the spec_decode_perf branch\n    from d07a3c5 to 2945178 Compare May 23, 2025 22:21 mergify bot removed\n  the needs-rebase label May 23, 2025 WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label May 24, 2025 WoosukKwon approved these changes May 24, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon enabled auto-merge (squash) May 24, 2025 03:27 Hide details View details WoosukKwon merged commit d55e446 into vllm-project : main May 24, 2025 71 checks passed Uh oh! There was an error while loading. Please reload this page . zzzyq pushed a commit\n        to zzzyq/vllm\n      that referenced\n      this pull request May 24, 2025 [V1][Spec Decode] Small refactors to improve eagle bookkeeping perforâ€¦ â€¦ be2ab55 â€¦mance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com> zixi-qi deleted the spec_decode_perf branch May 24, 2025 15:11 zzzyq pushed a commit\n        to zzzyq/vllm\n      that referenced\n      this pull request May 25, 2025 [V1][Spec Decode] Small refactors to improve eagle bookkeeping perforâ€¦ â€¦ 89c1867 â€¦mance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com> gshtras added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request May 27, 2025 Upstream merge 2025 05 27 ( #557 ) â€¦ 1900335 * Add files via uploadAdd fused MoE kernel tuning configs (fp8_w8a8) for DeepSeek V3/R1 on a single-node 8x NVIDIA H20 96GB setup ( vllm-project#18337 )\n\n* [Misc] Fix typo ( vllm-project#18330 )\n\n* Neuron up mistral ( vllm-project#18222 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* fix CUDA_check redefinition in vllm-project#17918 ( vllm-project#18287 )\n\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\n\n* [neuron] fix authorization issue ( vllm-project#18364 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Misc] Allow `AutoWeightsLoader` to skip loading weights with specific substr in name ( vllm-project#18358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] [Bugfix]: tensor parallel with prompt embeds ( vllm-project#18171 )\n\nSigned-off-by: Nan2018 <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\n\n* [release] Change dockerhub username for TPU release ( vllm-project#18389 )\n\n* [Bugfix] fix adding bias twice in ipex GPTQ quantization ( vllm-project#18363 )\n\nSigned-off-by: rand-fly <randfly@outlook.com>\n\n* [doc] update env variable export ( vllm-project#18391 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Add LoRA code owner ( vllm-project#18387 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Update cpu.txt ( vllm-project#18398 )\n\nSigned-off-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\n\n* [CI] Add mteb testing to test the accuracy of the embedding model ( vllm-project#17175 )\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\n\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\n\n* [Misc] refactor prompt embedding examples ( vllm-project#18405 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Minor] Rename quantization nvfp4 to modelopt_fp4 ( vllm-project#18356 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Model] use AutoWeightsLoader for bloom ( vllm-project#18300 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [Kernel] update comment for KV shape in unified triton attn ( vllm-project#18099 )\n\nSigned-off-by: haochengxia <xhc_1007@163.com>\n\n* fix:Build torch wheel inline rather than picking from nightly ( vllm-project#18351 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\n\n* [TPU] Re-enable the Pallas MoE kernel ( vllm-project#18025 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [Bugfix] config.head_dim is now explicitly set to None ( vllm-project#18432 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [Bug] Fix moe_sum signature ( vllm-project#18440 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* Revert \"[Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\" ( vllm-project#18456 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Failing Test] Fix nixl connector test when promt size < block size ( vllm-project#18429 )\n\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\n\n* [Misc] MultiConnector._connectors type ( vllm-project#18423 )\n\nSigned-off-by: nicklucche <nlucches@redhat.com>\n\n* [Frontend] deprecate `--device` arg ( vllm-project#18399 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [V1] Fix general plugins not loaded in engine for multiproc ( vllm-project#18326 )\n\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\n\n* [Misc] refactor disaggregated-prefill-v1 example ( vllm-project#18474 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Failing Test] Fix test_events.py ( vllm-project#18460 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [MODEL] FalconH1 ( vllm-project#18406 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [Doc] fix arg docstring in linear layers ( vllm-project#18410 )\n\nSigned-off-by: giantcroc <1204449533@qq.com>\n\n* [Bugfix] Reduce moe_sum test size to avoid OOM ( vllm-project#18484 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* [Build] fix Dockerfile shell ( vllm-project#18402 )\n\n* [Misc] Update deprecation message for `--enable-reasoning` ( vllm-project#18404 )\n\n* [ROCm][Kernel][V1] Enable AMD Radeon GPU Custom Paged Attention on v1 ( vllm-project#17004 )\n\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\n\n* Remove incorrect env value\n\n* Revert \"[v1] Support multiple KV cache groups in GPU model runner ( vllm-project#17945 ) ( vllm-project#18459 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [FEAT][ROCm] Upgrade AITER MLA v1 backend ( vllm-project#18338 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\n\n* [Bugfix] Consistent ascii handling in tool parsers ( vllm-project#17704 )\n\nSigned-off-by: Sebastian SchÃ¶nnenbeck <sebastian.schoennenbeck@comma-soft.com>\n\n* [FalconH1] Fix output dtype in RMSNorm fallback path for Falcon-H1 (e.g. 0.5B) ( vllm-project#18500 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [MISC] update project urls in pyproject.toml ( vllm-project#18519 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [CI] Fix race condition with StatelessProcessGroup.barrier ( vllm-project#18506 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Intialize io_thread_pool attribute in the beginning. ( vllm-project#18331 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [Bugfix] Inconsistent token calculation compared to HF in llava family ( vllm-project#18479 )\n\nSigned-off-by: jaycha <jaycha@ncsoft.com>\n\n* [BugFix][DP] Send DP wave completion only from `dp_rank==0` ( vllm-project#18502 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\n\n* [Bugfix][Model] Make Olmo2Model weight loading return loaded weights ( vllm-project#18504 )\n\nSigned-off-by: Shane A <shanea@allenai.org>\n\n* [Bugfix] Fix LoRA test ( vllm-project#18518 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Doc] Fix invalid JSON in example args ( vllm-project#18527 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Neuron] Update Dockerfile.neuron to use latest neuron release (2.23) ( vllm-project#18512 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* Update default neuron config for speculation ( vllm-project#18274 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* Order sequence ids + config update to support specifying custom quantization layers ( vllm-project#18279 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18526 )\n\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Add kwargs to RequestOutput __init__ to be forward compatible ( vllm-project#18513 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [CI/Build] Update bamba test model location ( vllm-project#18544 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc] Support --stream arg in openai_completion_client.py script ( vllm-project#18388 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Use random hidden states in dummy sampler run ( vllm-project#18543 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\n\n* [Doc] Add stream flag for chat completion example ( vllm-project#18524 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [BugFix][CPU] Fix x86 SHM distributed module initialization ( vllm-project#18536 )\n\nSigned-off-by: jiang.li <jiang1.li@intel.com>\n\n* [Misc] improve Automatic Prefix Caching example ( vllm-project#18554 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Call `ndarray.tobytes()` directly instead of `ndarray.data.tobytes()` ( vllm-project#18347 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Bugfix] make `test_openai_schema.py` pass ( vllm-project#18224 )\n\nSigned-off-by: David Xia <david@davidxia.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Platform] Move platform check to right place ( vllm-project#18470 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Compile][Platform] Make PiecewiseBackend pluggable and extendable ( vllm-project#18076 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Build/CI] Fix CUDA 11.8 build ( vllm-project#17679 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Tool] Add NIXL installation script ( vllm-project#18172 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [V1][Spec Decode][Bugfix] Load quantize weights for EAGLE ( vllm-project#18290 )\n\n* [Frontend][Bug Fix] Update llama4 pythonic jinja template and llama4_pythonic parser ( vllm-project#17917 )\n\nSigned-off-by: Kai Wu <kaiwu@meta.com>\n\n* [Frontend] [Core] Add Tensorizer support for V1, LoRA adapter serialization and deserialization ( vllm-project#17926 )\n\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\n\n* [AMD] [P/D] Compute num gpus for ROCm correctly in run_accuracy_test.sh ( vllm-project#18568 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* Re-submit: Fix: Proper RGBA -> RGB conversion for PIL images. ( vllm-project#18569 )\n\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\n\n* [V1][Spec Decoding] Use model_loader.get_model() to load models ( vllm-project#18273 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Enable hybrid attention models for Transformers backend ( vllm-project#18494 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] refactor: simplify input validation and num_requests handling in _convert_v1_inputs ( vllm-project#18482 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [BugFix] Increase TP execute_model timeout ( vllm-project#18558 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [Bugfix] Set `KVTransferConfig.engine_id` in post_init ( vllm-project#18576 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Spec Decode] Make EAGLE3 draft token ID mapping optional ( vllm-project#18488 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Neuron] Remove bypass on EAGLEConfig and add a test ( vllm-project#18514 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\n\n* [Bugfix][Benchmarks] Fix a benchmark of deepspeed-mii backend to use api_key ( vllm-project#17291 )\n\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\n\n* [Misc] Replace `cuda` hard code with `current_platform` ( vllm-project#16983 )\n\nSigned-off-by: shen-shanshan <467638484@qq.com>\n\n* [Hardware] correct method signatures for HPU,ROCm,XPU ( vllm-project#18551 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\n\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\n\n* [Feature]Add async tensor parallelism using compilation pass ( vllm-project#17882 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* [Doc] Update quickstart and install for cu128 using `--torch-backend=auto` ( vllm-project#18505 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Feature][V1]: suupports cached_tokens in response usage ( vllm-project#18149 )\n\nCo-authored-by: simon-mo <xmo@berkeley.edu>\n\n* [Bugfix] Add half type support in reshape_and_cache_cpu_impl on x86 cpu platform ( vllm-project#18430 )\n\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\n\n* Migrate docs from Sphinx to MkDocs ( vllm-project#18145 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Revert \"[V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\" ( vllm-project#18600 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Model] Fix baichuan model loader for tp ( vllm-project#18597 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [V0][Bugfix] Fix parallel sampling performance regression when guided decoding is enabled ( vllm-project#17731 )\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\n\n* Add myself as docs code owner ( vllm-project#18605 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Hardware][CPU] Update intel_extension_for_pytorch 2.7.0 and move to `requirements/cpu.txt`  ( vllm-project#18542 )\n\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\n\n* [CI] fix kv_cache_type argument ( vllm-project#18594 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Doc] Fix indent of contributing to vllm ( vllm-project#18611 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* Replace `{func}` with mkdocs style links ( vllm-project#18610 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Fix V1 flag being set in entrypoints tests ( vllm-project#18598 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Fix examples with code blocks in docs ( vllm-project#18609 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix transformers model impl ignored for mixtral quant ( vllm-project#18602 )\n\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\n\n* Include private attributes in API documentation ( vllm-project#18614 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] add Haystack integration ( vllm-project#18601 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Build/CI] Fixup CUDA compiler version check for CUDA_SUPPORTED_ARCHS ( vllm-project#18579 )\n\n* [Doc] Fix markdown list indentation for MkDocs rendering ( vllm-project#18620 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [Doc] Use a different color for the announcement ( vllm-project#18616 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Refactor pplx init logic to make it modular (prepare for deepep) ( vllm-project#18200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix figures in design doc ( vllm-project#18612 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Change mkdocs to not use directory urls ( vllm-project#18622 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Redo \"Support multiple KV cache groups in GPU model runner ( vllm-project#17945 )\" ( vllm-project#18593 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc] fix list formatting ( vllm-project#18624 )\n\nSigned-off-by: David Xia <david@davidxia.com>\n\n* [Doc] Fix top-level API links/docs ( vllm-project#18621 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Avoid documenting dynamic / internal modules ( vllm-project#18626 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix broken links and unlinked docs, add shortcuts to home sidebar ( vllm-project#18627 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support Deepseek MTP ( vllm-project#18435 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use prebuilt FlashInfer x86_64 PyTorch 2.7 CUDA 12.8 wheel for CI ( vllm-project#18537 )\n\nSigned-off-by: Huy Do <huydhn@gmail.com>\n\n* [CI] Enable test_initialization to run on V1 ( vllm-project#16736 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Doc] Update references to doc files ( vllm-project#18637 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ModelOpt] Introduce VLLM_MAX_TOKENS_PER_EXPERT_FP4_MOE env var to control blockscale tensor allocation ( vllm-project#18160 )\n\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\n\n* [Bugfix] Migrate to REGEX Library to prevent catastrophic backtracking ( vllm-project#18454 )\n\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\n\n* [Bugfix][Nixl] Fix Preemption Bug ( vllm-project#18631 )\n\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\n\n* config.py: Clarify that only local GGUF checkpoints are supported. ( vllm-project#18623 )\n\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\n\n* FIX MOE issue in AutoRound format ( vllm-project#18586 )\n\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\n\n* [V1][Spec Decode] Small refactors to improve eagle bookkeeping performance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Frontend] improve vllm serve --help display ( vllm-project#18643 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Model] Add support for Qwen2.5-Omni-7B-AWQ (Qwen2_5OmniForConditionalGeneration) ( vllm-project#18647 )\n\n* [V1][Spec Decode] Support multi-layer eagle draft model ( vllm-project#18030 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Doc] Update README links, mark external links ( vllm-project#18635 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC][pre-commit] Add pre-commit check for triton import ( vllm-project#17716 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Doc] Fix indentation problems in V0 Paged Attention docs ( vllm-project#18659 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Add community links ( vllm-project#18657 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] use AutoWeightsLoader for gpt2 ( vllm-project#18625 )\n\nSigned-off-by: zt2370 <ztang2370@gmail.com>\n\n* [Doc] Reorganize user guide ( vllm-project#18661 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] `chmod +x` to `cleanup_pr_body.sh` ( vllm-project#18650 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC] typo fix and clean import ( vllm-project#18664 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [BugFix] Fix import error for fused_moe ( vllm-project#18642 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [CI] enforce import regex instead of re ( vllm-project#18665 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* fix(regression): clone from reference items ( vllm-project#18662 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [CI/Build] fix permission denied issue ( vllm-project#18645 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [BugFix][Spec Decode] Improve Prefix Caching Logic in Speculative Decoding ( vllm-project#18668 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Fix _pickle.PicklingError: Can't pickle <class 'transformers_modules.deepseek-ai.DeepSeek-V2-Lite... ( vllm-project#18640 )\n\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\n\n* [MISC] correct signature for LoaderFunction ( vllm-project#18670 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc]Replace `cuda` hard code with `current_platform` in Ray ( vllm-project#14668 )\n\nSigned-off-by: noemotiovon <757486878@qq.com>\n\n* [Misc][ModelScope] Change to use runtime VLLM_USE_MODELSCOPE ( vllm-project#18655 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [VLM] Initialize video input support for InternVL models ( vllm-project#18499 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* Speed up the `kernels/quantization/` tests ( vllm-project#18669 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [BUGFIX] catch subclass first for try...except ( vllm-project#18672 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc] Reduce logs on startup ( vllm-project#18649 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] fix broken links ( vllm-project#18671 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [doc] improve readability ( vllm-project#18675 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix cpu usage and cache hit stats reporting on cpu environment ( vllm-project#18674 )\n\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [CI/build] fix no regex ( vllm-project#18676 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] small improve ( vllm-project#18680 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix profiling dummy data for Pixtral ( vllm-project#18677 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Core][Multimodal] Convert PIL Image to array without data copy when hashing ( vllm-project#18682 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [CI/Build][Doc] Update `gte-Qwen2-1.5B-instruct` usage ( vllm-project#18683 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Fixed the abnormally high TTFT issue in the PD disaggregation example ( vllm-project#18644 )\n\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\n\n* refactor: simplify request handler, use positive condition check for handler assignment ( vllm-project#18690 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Fix the lm_head in gpt_bigcode in lora mode ( vllm-project#6357 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\n\n* [CI] add missing argument ( vllm-project#18694 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [GH] Add issue template for reporting CI failures ( vllm-project#18696 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix issue template format ( vllm-project#18699 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Mistral-format models with sliding window ( vllm-project#18693 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Replace `math.isclose` with `pytest.approx` ( vllm-project#18703 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] fix dump_input for str type ( vllm-project#18697 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Model] Add support for YARN in NemotronNAS models ( vllm-project#18427 )\n\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\n\n* [CI/Build] Split pooling and generation extended language models tests in CI ( vllm-project#18705 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Add tensor parallel size = 2 test to HPU CI ( vllm-project#18709 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Misc] add AutoGen integration ( vllm-project#18712 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix]: handle hf-xet CAS error when loading Qwen3 weights in vLLM ( vllm-project#18701 )\n\n* [Doc] Improve API docs ( vllm-project#18713 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples and further reorganize user guide ( vllm-project#18666 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Llama GGUF initialization ( vllm-project#18717 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs ( vllm-project#18608 )\n\n* Convert `examples` to `ruff-format` ( vllm-project#18400 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Model][Gemma3] Simplify image input validation ( vllm-project#18710 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Misc] improve web section group title display ( vllm-project#18684 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [V1][Quantization] Add CUDA graph compatible v1 GGUF support ( vllm-project#18646 )\n\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Model][Gemma3] Cast image pixel values already on CPU ( vllm-project#18732 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [FEAT] [ROCm] Upgrade AITER Fused MoE kernels. ( vllm-project#18271 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Doc] Update OOT model docs ( vllm-project#18742 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Update reproducibility doc and example ( vllm-project#18741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] improve docs ( vllm-project#18734 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* feat(rocm-support): support mamba2 on rocm ( vllm-project#18565 )\n\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Fix multiple containers using the same name in run-hpu-test.sh ( vllm-project#18752 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Doc] cleanup deprecated flag for doc ( vllm-project#18715 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* Minor fix about MooncakeStoreConnector ( vllm-project#18721 )\n\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\n\n* [Build] fix cpu build missing libtbbmalloc.so ( vllm-project#18744 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [BUG FIX] minicpm ( vllm-project#18739 )\n\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\n\n* [Doc]  Convert Sphinx directives ( `{class}`, `{meth}`, `{attr}`, ...) to MkDocs format for better documentation linking ( vllm-project#18663 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [CI/Build] Remove imports of built-in `re` ( vllm-project#18750 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Metrics] Add API for accessing in-memory Prometheus metrics ( vllm-project#17010 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Disable prefix cache by default for benchmark ( vllm-project#18639 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* optimize get_kv_cache_torch_dtype ( vllm-project#18531 )\n\nSigned-off-by: idellzheng <idellzheng@tencent.com>\n\n* [Core] Automatically cast multi-modal input dtype ( vllm-project#18756 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Mistral tool calling when content is list ( vllm-project#18729 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n---------\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Nan2018 <nan@protopia.ai>\nSigned-off-by: rand-fly <randfly@outlook.com>\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: calvin chen <120380290@qq.com>\nSigned-off-by: haochengxia <xhc_1007@163.com>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: Bill Nell <bnell@redhat.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\nSigned-off-by: nicklucche <nlucches@redhat.com>\nSigned-off-by: Kebe <mail@kebe7jun.com>\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\nSigned-off-by: rabi <ramishra@redhat.com>\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nSigned-off-by: giantcroc <1204449533@qq.com>\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nSigned-off-by: Sebastian SchÃ¶nnenbeck <sebastian.schoennenbeck@comma-soft.com>\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: jaycha <jaycha@ncsoft.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Shane A <shanea@allenai.org>\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nSigned-off-by: Linkun <github@lkchen.net>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: googs1025 <googs1025@gmail.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: jiang.li <jiang1.li@intel.com>\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\nSigned-off-by: David Xia <david@davidxia.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nSigned-off-by: Kai Wu <kaiwu@meta.com>\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\nSigned-off-by: shen-shanshan <467638484@qq.com>\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\nSigned-off-by: cascade812 <cascade812@outlook.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Huy Do <huydhn@gmail.com>\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: zt2370 <ztang2370@gmail.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\nSigned-off-by: noemotiovon <757486878@qq.com>\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nSigned-off-by: idellzheng <idellzheng@tencent.com>\nCo-authored-by: sunyicode0012 <116338547+sunyicode0012@users.noreply.github.com>\nCo-authored-by: Gong Shufan <2624542821@qq.com>\nCo-authored-by: Satyajith Chilappagari <satchill@amazon.com>\nCo-authored-by: Lucia Fang <116399278+luccafong@users.noreply.github.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Nan Qin <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Random Fly <renfei8@live.cn>\nCo-authored-by: Reid <61492567+reidliu41@users.noreply.github.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\nCo-authored-by: wang.yuqi <noooop@126.com>\nCo-authored-by: ç‡ƒ <wulipc@163.com>\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Calvin Chen <45745657+calvin0327@users.noreply.github.com>\nCo-authored-by: Percy <xhc_1007@163.com>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: bnellnm <49004751+bnellnm@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: wwl2755 <wangwenlong2755@gmail.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Kebe <mail@kebe7jun.com>\nCo-authored-by: Yong Hoon Shin <48474650+sarckk@users.noreply.github.com>\nCo-authored-by: Rabi Mishra <ramishra@redhat.com>\nCo-authored-by: Dhia Eddine Rhaiem <163106757+dhiaEddineRhaiem@users.noreply.github.com>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\nCo-authored-by: GiantCroc <1204449533@qq.com>\nCo-authored-by: Hyogeun Oh (ì˜¤íš¨ê·¼) <ohg3417@gmail.com>\nCo-authored-by: Hosang <156028780+hyoon1@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Sebastian Schoennenbeck <sebastian.schoennenbeck@comma-soft.com>\nCo-authored-by: Ning Xie <andy.xning@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: youngrok cha <line0930@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\nCo-authored-by: Shane A <shanea@allenai.org>\nCo-authored-by: aws-elaineyz <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: CYJiang <86391540+googs1025@users.noreply.github.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Lukas Geiger <lukas.geiger94@gmail.com>\nCo-authored-by: David Xia <david@davidxia.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ekagra Ranjan <3116519+ekagra-ranjan@users.noreply.github.com>\nCo-authored-by: Kai Wu <kaiwu@meta.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Chenheli Hua <huachenheli@outlook.com>\nCo-authored-by: Benjamin Chislett <chislett.ben@gmail.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Teruaki Ishizaki <tell.ishi@gmail.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: RonaldBXu <72748153+RonaldBXu@users.noreply.github.com>\nCo-authored-by: cascade <cascade812@outlook.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Yuqi Zhang <zhangyuqi94@gmail.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Kay Yan <kay.yan@daocloud.io>\nCo-authored-by: Tristan Leclercq <49700633+tristanleclercq@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\nCo-authored-by: Huy Do <huydhn@gmail.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: Feng XiaoLong <79261065+Crucifixion-Fxl@users.noreply.github.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Mathieu BorderÃ© <mathieu@bordere.org>\nCo-authored-by: Wenhua Cheng <wenhua.cheng@intel.com>\nCo-authored-by: qizixi <22851944+zixi-qi@users.noreply.github.com>\nCo-authored-by: Yuanhao WU <Nalkey@users.noreply.github.com>\nCo-authored-by: ztang2370 <ztang2370@gmail.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: Seiji Eicher <58963096+eicherseiji@users.noreply.github.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: AlexZhao <zhaohaidao2008@hotmail.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Naveassaf <55059536+Naveassaf@users.noreply.github.com>\nCo-authored-by: Åukasz Durejko <lukasz.durejko@intel.com>\nCo-authored-by: dylan <xuhao296@qq.com>\nCo-authored-by: almersawi <43927639+almersawi@users.noreply.github.com>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: Åukasz Durejko <ldurejko@habana.ai>\nCo-authored-by: maobaolong <baoloongmao@tencent.com>\nCo-authored-by: Shawn Huang <57223022+huangyuxiang03@users.noreply.github.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: chunxiaozheng <55471457+chunxiaozheng@users.noreply.github.com> minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [V1][Spec Decode] Small refactors to improve eagle bookkeeping perforâ€¦ â€¦ e2fbc5c â€¦mance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:00", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, profiling | SERVING: vllm serve, serve, Frontend | TEST: test, test, Test", "analysis_extracted_at": "2025-09-07 17:51:00", "models": ["meta-llama/Llama-3-8B"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3-8B --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3-8B --batch-size 2", "commit_subject": "[V1][Spec Decode] Small refactors to improve eagle bookkeeping performance (#18424)", "commit_message": "[V1][Spec Decode] Small refactors to improve eagle bookkeeping performance (#18424)\n\nSigned-off-by: qizixi <qizixi@meta.com>", "commit_date": "2025-05-24T06:51:22Z", "files_changed": ["tests/v1/spec_decode/test_eagle.py", "vllm/v1/spec_decode/eagle.py", "vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 0, "num_files": 3, "num_hunks": 8, "num_edited_lines": 40, "num_non_test_edited_lines": 34, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/spec_decode/test_eagle.py b/tests/v1/spec_decode/test_eagle.py\nindex e000d955c..7be1c5b89 100644\n--- a/tests/v1/spec_decode/test_eagle.py\n+++ b/tests/v1/spec_decode/test_eagle.py\n@@ -100,8 +100,12 @@ def test_prepare_inputs():\n         dtype=torch.int32,\n         device=device)\n \n+    # n1 + n2 + n3 - a - b -c\n+    num_tokens = cu_target_query_lens[-1].item() - num_rejected_tokens.sum(\n+    ).item()\n+\n     cu_num_tokens, token_indices = EagleProposer.prepare_inputs(\n-        cu_target_query_lens, num_rejected_tokens)\n+        cu_target_query_lens, num_rejected_tokens, num_tokens)\n \n     assert torch.equal(cu_num_tokens, expected_cu_num_tokens)\n     assert token_indices.shape[0] == expected_cu_num_tokens[-1].item()\ndiff --git a/vllm/v1/spec_decode/eagle.py b/vllm/v1/spec_decode/eagle.py\nindex 3926a86ee..876e1ddd1 100644\n--- a/vllm/v1/spec_decode/eagle.py\n+++ b/vllm/v1/spec_decode/eagle.py\n@@ -271,6 +271,7 @@ class EagleProposer:\n         cu_target_query_lens: torch.Tensor,\n         # [batch_size]\n         num_rejected_tokens: torch.Tensor,\n+        num_tokens: int,\n     ) -> tuple[torch.Tensor, torch.Tensor]:\n         # cu_target_query_lens: [0, a, a + b, a + b + c]\n         # num_rejected_tokens: [n1, n2, n3]\n@@ -288,18 +289,13 @@ class EagleProposer:\n \n         # [a - n1, b - n2, c - n3] ->\n         # [0, a - n1, a + b - n1 - n2, a + b + c - n1 - n2 - n3]\n-        cu_num_tokens = torch.empty_like(cu_target_query_lens)\n+        cu_num_tokens = torch.zeros_like(cu_target_query_lens)\n         torch.cumsum(num_tokens_per_req, dim=0, out=cu_num_tokens[1:])\n-        cu_num_tokens[0] = 0\n-\n-        # FIXME(woosuk): Avoid synchronization.\n-        num_tokens = cu_num_tokens[-1].item()\n         token_indices = torch.empty(\n             num_tokens,\n             dtype=torch.int32,\n-            device=cu_num_tokens.device,\n+            device=cu_target_query_lens.device,\n         )\n-\n         batch_size = num_rejected_tokens.shape[0]\n         BLOCK_SIZE = 1024\n         prepare_eagle_input_kernel[(batch_size, )](\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 42847e2f8..5120495db 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -34,8 +34,8 @@ from vllm.multimodal.utils import group_mm_inputs_by_modality\n from vllm.sampling_params import SamplingType\n from vllm.sequence import IntermediateTensors\n from vllm.utils import (STR_DTYPE_TO_TORCH_DTYPE, DeviceMemoryProfiler,\n-                        GiB_bytes, LazyLoader, cdiv, check_use_alibi,\n-                        is_pin_memory_available)\n+                        GiB_bytes, LazyLoader, async_tensor_h2d, cdiv,\n+                        check_use_alibi, is_pin_memory_available)\n from vllm.v1.attention.backends.flash_attn import FlashAttentionMetadata\n from vllm.v1.attention.backends.utils import CommonAttentionMetadata\n from vllm.v1.core.encoder_cache_manager import compute_encoder_budget\n@@ -281,7 +281,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n     def _may_reorder_batch(self, scheduler_output: \"SchedulerOutput\") -> bool:\n         \"\"\"\n         Update the order of requests in the batch based on the attention\n-        backend's needs. For example, some attention backends (namely MLA) may \n+        backend's needs. For example, some attention backends (namely MLA) may\n         want to separate requests based on if the attention computation will be\n         compute-bound or memory-bound.\n \n@@ -1360,9 +1360,10 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                                scheduler_output.num_scheduled_tokens[req_id])\n                     next_token_id = req_state.get_token_id(seq_len)\n                 next_token_ids.append(next_token_id)\n-            next_token_ids = torch.tensor(next_token_ids,\n-                                          dtype=torch.int32,\n-                                          device=self.device)\n+            next_token_ids = async_tensor_h2d(next_token_ids,\n+                                              dtype=torch.int32,\n+                                              target_device=self.device,\n+                                              pin_memory=True)\n             eagle_attn_metadata = attn_metadata[self.drafter.attn_layer_name]\n \n             # NOTE: deepseek_mtp uses MLA which does not have `block_table`\n@@ -1390,14 +1391,16 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                     n + 1 - len(valid_sampled_token_ids[i]) if n > 0 else 0\n                     for i, n in enumerate(num_draft_tokens)\n                 ]\n-                num_rejected_tokens = torch.tensor(\n+                num_rejected_tokens_tensor = async_tensor_h2d(\n                     num_rejected_tokens,\n                     dtype=torch.int32,\n-                    device=self.device,\n-                )\n+                    target_device=self.device,\n+                    pin_memory=True)\n+                num_tokens = num_scheduled_tokens - sum(num_rejected_tokens)\n                 cu_num_tokens, token_indices = self.drafter.prepare_inputs(\n                     eagle_attn_metadata.query_start_loc,\n-                    num_rejected_tokens,\n+                    num_rejected_tokens_tensor,\n+                    num_tokens,\n                 )\n                 target_token_ids = self.input_ids[token_indices]\n                 target_positions = positions[token_indices]\n@@ -1408,7 +1411,6 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                     target_hidden_states = hidden_states[token_indices]\n                 target_slot_mapping = eagle_attn_metadata.slot_mapping[\n                     token_indices]\n-\n             draft_token_ids = self.drafter.propose(\n                 target_token_ids=target_token_ids,\n                 target_positions=target_positions,", "apis": ["vllm.v1.spec_decode.eagle.EagleProposer.prepare_inputs", "vllm.worker.GPUModelRunner.execute_model"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/eagle.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/configs/eagle.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test files (specifically, vllm/v1/spec_decode/eagle.py and vllm/v1/worker/gpu_model_runner.py) and adjusts the implementation details by replacing torch.empty with torch.zeros_like, removing unnecessary synchronization by passing in a computed num_tokens rather than recomputing it, and replacing blocking tensor creation with asynchronous tensor transfers using async_tensor_h2d. These changes are aimed at improving the internal bookkeeping performance of a core component (EagleProposer) and a performance-sensitive GPU model runner, rather than just refactoring or patching bugs. The modifications target the performance (on CPU) of existing APIs. Therefore, the commit satisfies the conditions for being a performance or optimization related change.", "llm_api_reason": "This commit refactors eagle speculative decoding bookkeeping. In tests, the prepare_inputs API of EagleProposer now requires an additional num_tokens parameter and internally uses torch.zeros_like instead of torch.empty_like for clarity. In GPUModelRunner, lowâ€level tensor conversions in the eagle decoding branch are switched to use async_tensor_h2d (improving asynchronous memory transfers), and the computation of num_tokens has been adjusted accordingly. These changes collectively aim at improving bookkeeping and performance in eagle speculative decoding."}
{"commit_hash": "e493e48524e9e78ab33eafec6461b3940e361189", "pr_url": "https://github.com/vllm-project/vllm/pull/17731", "pr_date": "2025-05-06", "timeline_text": "Copy link Contributor shadeMe commented May 6, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . ParallelSampleSequenceGroup.add_request has to copy the original SamplingParams instance as many times as the number of requested samples. This is currently done with a copy.deepcopy call, which is not advisable as the the logits_processors field could contain arbitrary Python objects with expensive-to-copy state. This happens to be the case with the current guided decoding logits processors, scaling linearly with the value of SamplingParams.n and introducing a bottleneck in the hot path. A similar issue was previous identified, and SamplingParams.clone was introduced to workaround this issue - it attempts to call a clone function on each logits processor object, with the assumption that classes can implement this method to minimize the overhead by performing shallow copies when possible. However, not all existing logits processors implement this method. Nor does the ParallelSampleSequenceGroup class avail itself of the SamplingParams.clone method. This commit introduces the following changes: Modify ParallelSampleSequenceGroup.add_request to call SamplingParams.clone instead of copy.deepcopy . Update the logits processors of the guidance , outlines and xgrammar backends to expose a clone method for the efficient copying of mutable state. The lm-format-enforcer backend was left untouched as the logits processor implementation is external to vLLM. Benchmark For text generation w/t Nvidia L4, Phi-1.5, n=3 in an async setup, we see the ParallelSampleSequenceGroup.add_request call dominating the runtime during a 180 second profile (after warm-up/with in-flight requests) of the original code (anywhere b'ween 60%-86% of the total runtime depending on the backend). With the above changes, this is essentially eliminated (0.01%-0.6%). Guidance Outlines Xgrammar Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 3 Xarbirus, chaunceyjiang, and dtransposed reacted with thumbs up emoji ðŸŽ‰ 1 bi1101 reacted with hooray emoji All reactions ðŸ‘ 3 reactions ðŸŽ‰ 1 reaction [Bugfix] Fix parallel sampling performance regression when guided decâ€¦ â€¦ 59f7675 â€¦oding is enabled\n\n`ParallelSampleSequenceGroup.add_request` has to copy the original `SamplingParams` instance as\nmany times as the number of requested samples. This is currently done with a `copy.deepcopy` call,\nwhich is not advisable as the the `logits_processors` field could contain arbitrary Python objects\nwith expensive-to-copy state. This happens to be the case with the current guided decoding logits\nprocessors, scaling linearly with the value of `SamplingParams.n` and introducing a bottleneck in the\nhot path.\n\nA similar issue was previous identified, and `SamplingParams.clone` was introduced to workaround this\nissue - it attempts to call a `clone` function on each logits processor object, with the assumption that\nclasses can implement this method to minimize the overhead by performing shallow copies when possible.\nHowever, not all existing logits processors implement this method. Nor does the `ParallelSampleSequenceGroup`\nclass avail itself of the `SamplingParams.clone` method.\n\nThis commit introduces the following changes:\n* Modify `ParallelSampleSequenceGroup.add_request` to call `SamplingParams.clone` instead of `copy.deepcopy`.\n* Update the logits processors of the `guidance`, `outlines` and `xgrammar` backends to expose a `clone` method\n  for the efficient copying of mutable state.\n\nThe `lm-format-enforcer` backend was left untouched as the logits processor implementation is external to\nvLLM.\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com> shadeMe requested review from mgoin and russellb as code owners May 6, 2025 16:26 Copy link github-actions bot commented May 6, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the structured-output label May 6, 2025 github-project-automation bot added this to Structured Output May 6, 2025 njhill added\n  the v0 label May 6, 2025 Copy link Contributor chaunceyjiang commented May 7, 2025 @shadeMe Hi, sorry for the off-topic questionâ€”how did you generate this performance chart? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mypy fixes â€¦ ded6280 Signed-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com> shadeMe force-pushed the v0/fix/logitsprocessor-parallel-sampling-guided-decoding-deepcopy branch\n    from 15e45cf to ded6280 Compare May 7, 2025 09:17 Copy link Contributor Author shadeMe commented May 7, 2025 @shadeMe Hi, sorry for the off-topic questionâ€”how did you generate this performance chart? It's with the speedscope tool. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor dtransposed commented May 9, 2025 Overlap with #16349 just FYI All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented May 12, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @shadeMe . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label May 12, 2025 Merge branch 'main' into v0/fix/logitsprocessor-parallel-sampling-guiâ€¦ â€¦ 6172283 â€¦ded-decoding-deepcopy\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com> mergify bot removed\n  the needs-rebase label May 13, 2025 mgoin approved these changes May 16, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Seems reasonable to me, but would like @russellb or @aarnphm to confirm before merge Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label May 16, 2025 bi1101 mentioned this pull request May 16, 2025 [Bug]:Structured outputs inference often took a very long time,and eventually causing a timeout and vLLM engine crushing. #10081 Open 1 task aarnphm approved these changes May 17, 2025 View reviewed changes Copy link Collaborator aarnphm left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I'm good with this for structured outputs, and good to merge in guidance and xgrammar first before #15975 . iirc we will have to deepcopy the logit processors regardless if users use a custom logit processor? so essentially this change in sequence.py could potentially be breaking for users in V0 engine? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/guided_decoding/outlines_logits_processors.py Comment on lines +59 to +64 def clone(self) -> \"BaseLogitsProcessor\": cloned = copy.copy(self) cloned._guide = self._guide.copy() cloned._fsm_state = copy.deepcopy(self._fsm_state) return cloned Copy link Collaborator aarnphm May 17, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I would like to get #15975 in first before assigning this private attrs. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 shadeMe reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author shadeMe commented May 19, 2025 iirc we will have to deepcopy the logit processors regardless if users use a custom logit processor? so essentially this change in sequence.py could potentially be breaking for users in V0 engine? Breaking perhaps along the same lines as the original PR that introduced the SamplingParams.clone method - this PR just brings the parallel sampling code inline with its non-parallel counterpart. We could theoretically preserve the existing behaviour while excluding the structured outputs processors, but it would result in leaky abstractions. ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Merge remote-tracking branch 'origin/main' into v0/fix/logitsprocessoâ€¦ â€¦ a17fb77 â€¦r-parallel-sampling-guided-decoding-deepcopy russellb enabled auto-merge (squash) May 19, 2025 14:18 Copy link Member russellb commented May 19, 2025 merged from main to see if that gets CI passing All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author shadeMe commented May 21, 2025 The CI failures appear to be unrelated AFAICT? The failing tests use the default n=1 and do not use structured outputs. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member DarkLight1337 commented May 23, 2025 Can you merge from main to fix the CI failures? ðŸ‘ 1 shadeMe reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Merge branch 'main' into v0/fix/logitsprocessor-parallel-sampling-guiâ€¦ â€¦ b8b3fd7 â€¦ded-decoding-deepcopy Hide details View details vllm-bot merged commit e493e48 into vllm-project : main May 23, 2025 53 of 58 checks passed Uh oh! There was an error while loading. Please reload this page . github-project-automation bot moved this to Done in Structured Output May 23, 2025 bi1101 mentioned this pull request May 23, 2025 [Usage]: Regex Structured Output Became Very Slow #18546 Open 1 task zzzyq pushed a commit\n        to zzzyq/vllm\n      that referenced\n      this pull request May 24, 2025 [V0][Bugfix] Fix parallel sampling performance regression when guidedâ€¦ â€¦ 3b77312 â€¦ decoding is enabled ( vllm-project#17731 )\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com> Copy link Member DarkLight1337 commented May 24, 2025 It appears that the samplers test failure on main is caused by this PR. PTAL https://buildkite.com/vllm/ci/builds/20641/steps?jid=0196fcb9-d7f7-4ff4-ad54-260dfc784dae All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . DarkLight1337 mentioned this pull request May 24, 2025 [Bug][Failing Test]: Samplers Test - samplers/test_seeded_generate.py #18656 Closed 1 task Copy link Collaborator aarnphm commented May 24, 2025 This might have to do with deepcopy ðŸ¤” All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gshtras added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request May 27, 2025 Upstream merge 2025 05 27 ( #557 ) â€¦ 1900335 * Add files via uploadAdd fused MoE kernel tuning configs (fp8_w8a8) for DeepSeek V3/R1 on a single-node 8x NVIDIA H20 96GB setup ( vllm-project#18337 )\n\n* [Misc] Fix typo ( vllm-project#18330 )\n\n* Neuron up mistral ( vllm-project#18222 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* fix CUDA_check redefinition in vllm-project#17918 ( vllm-project#18287 )\n\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\n\n* [neuron] fix authorization issue ( vllm-project#18364 )\n\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\n\n* [Misc] Allow `AutoWeightsLoader` to skip loading weights with specific substr in name ( vllm-project#18358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Core] [Bugfix]: tensor parallel with prompt embeds ( vllm-project#18171 )\n\nSigned-off-by: Nan2018 <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\n\n* [release] Change dockerhub username for TPU release ( vllm-project#18389 )\n\n* [Bugfix] fix adding bias twice in ipex GPTQ quantization ( vllm-project#18363 )\n\nSigned-off-by: rand-fly <randfly@outlook.com>\n\n* [doc] update env variable export ( vllm-project#18391 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Add LoRA code owner ( vllm-project#18387 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Update cpu.txt ( vllm-project#18398 )\n\nSigned-off-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\n\n* [CI] Add mteb testing to test the accuracy of the embedding model ( vllm-project#17175 )\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\n\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\n\n* [Misc] refactor prompt embedding examples ( vllm-project#18405 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Minor] Rename quantization nvfp4 to modelopt_fp4 ( vllm-project#18356 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Model] use AutoWeightsLoader for bloom ( vllm-project#18300 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [Kernel] update comment for KV shape in unified triton attn ( vllm-project#18099 )\n\nSigned-off-by: haochengxia <xhc_1007@163.com>\n\n* fix:Build torch wheel inline rather than picking from nightly ( vllm-project#18351 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\n\n* [TPU] Re-enable the Pallas MoE kernel ( vllm-project#18025 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [Bugfix] config.head_dim is now explicitly set to None ( vllm-project#18432 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [Bug] Fix moe_sum signature ( vllm-project#18440 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* Revert \"[Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18407 )\" ( vllm-project#18456 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Failing Test] Fix nixl connector test when promt size < block size ( vllm-project#18429 )\n\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\n\n* [Misc] MultiConnector._connectors type ( vllm-project#18423 )\n\nSigned-off-by: nicklucche <nlucches@redhat.com>\n\n* [Frontend] deprecate `--device` arg ( vllm-project#18399 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [V1] Fix general plugins not loaded in engine for multiproc ( vllm-project#18326 )\n\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\n\n* [Misc] refactor disaggregated-prefill-v1 example ( vllm-project#18474 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Failing Test] Fix test_events.py ( vllm-project#18460 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [MODEL] FalconH1 ( vllm-project#18406 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [Doc] fix arg docstring in linear layers ( vllm-project#18410 )\n\nSigned-off-by: giantcroc <1204449533@qq.com>\n\n* [Bugfix] Reduce moe_sum test size to avoid OOM ( vllm-project#18484 )\n\nSigned-off-by: Bill Nell <bnell@redhat.com>\n\n* [Build] fix Dockerfile shell ( vllm-project#18402 )\n\n* [Misc] Update deprecation message for `--enable-reasoning` ( vllm-project#18404 )\n\n* [ROCm][Kernel][V1] Enable AMD Radeon GPU Custom Paged Attention on v1 ( vllm-project#17004 )\n\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\n\n* Remove incorrect env value\n\n* Revert \"[v1] Support multiple KV cache groups in GPU model runner ( vllm-project#17945 ) ( vllm-project#18459 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [FEAT][ROCm] Upgrade AITER MLA v1 backend ( vllm-project#18338 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\n\n* [Bugfix] Consistent ascii handling in tool parsers ( vllm-project#17704 )\n\nSigned-off-by: Sebastian SchÃ¶nnenbeck <sebastian.schoennenbeck@comma-soft.com>\n\n* [FalconH1] Fix output dtype in RMSNorm fallback path for Falcon-H1 (e.g. 0.5B) ( vllm-project#18500 )\n\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\n\n* [MISC] update project urls in pyproject.toml ( vllm-project#18519 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [CI] Fix race condition with StatelessProcessGroup.barrier ( vllm-project#18506 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Intialize io_thread_pool attribute in the beginning. ( vllm-project#18331 )\n\nSigned-off-by: rabi <ramishra@redhat.com>\n\n* [Bugfix] Inconsistent token calculation compared to HF in llava family ( vllm-project#18479 )\n\nSigned-off-by: jaycha <jaycha@ncsoft.com>\n\n* [BugFix][DP] Send DP wave completion only from `dp_rank==0` ( vllm-project#18502 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\n\n* [Bugfix][Model] Make Olmo2Model weight loading return loaded weights ( vllm-project#18504 )\n\nSigned-off-by: Shane A <shanea@allenai.org>\n\n* [Bugfix] Fix LoRA test ( vllm-project#18518 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Doc] Fix invalid JSON in example args ( vllm-project#18527 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Neuron] Update Dockerfile.neuron to use latest neuron release (2.23) ( vllm-project#18512 )\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\n\n* Update default neuron config for speculation ( vllm-project#18274 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* Order sequence ids + config update to support specifying custom quantization layers ( vllm-project#18279 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\n\n* [Bugfix] Fix MRoPE Errors in the Qwen-VL Model When Processing Pure Text ( vllm-project#18526 )\n\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Add kwargs to RequestOutput __init__ to be forward compatible ( vllm-project#18513 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [CI/Build] Update bamba test model location ( vllm-project#18544 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc] Support --stream arg in openai_completion_client.py script ( vllm-project#18388 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Use random hidden states in dummy sampler run ( vllm-project#18543 )\n\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\n\n* [Doc] Add stream flag for chat completion example ( vllm-project#18524 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* [BugFix][CPU] Fix x86 SHM distributed module initialization ( vllm-project#18536 )\n\nSigned-off-by: jiang.li <jiang1.li@intel.com>\n\n* [Misc] improve Automatic Prefix Caching example ( vllm-project#18554 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] Call `ndarray.tobytes()` directly instead of `ndarray.data.tobytes()` ( vllm-project#18347 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Bugfix] make `test_openai_schema.py` pass ( vllm-project#18224 )\n\nSigned-off-by: David Xia <david@davidxia.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Platform] Move platform check to right place ( vllm-project#18470 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Compile][Platform] Make PiecewiseBackend pluggable and extendable ( vllm-project#18076 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Build/CI] Fix CUDA 11.8 build ( vllm-project#17679 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Tool] Add NIXL installation script ( vllm-project#18172 )\n\nSigned-off-by: Linkun <github@lkchen.net>\n\n* [V1][Spec Decode][Bugfix] Load quantize weights for EAGLE ( vllm-project#18290 )\n\n* [Frontend][Bug Fix] Update llama4 pythonic jinja template and llama4_pythonic parser ( vllm-project#17917 )\n\nSigned-off-by: Kai Wu <kaiwu@meta.com>\n\n* [Frontend] [Core] Add Tensorizer support for V1, LoRA adapter serialization and deserialization ( vllm-project#17926 )\n\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\n\n* [AMD] [P/D] Compute num gpus for ROCm correctly in run_accuracy_test.sh ( vllm-project#18568 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* Re-submit: Fix: Proper RGBA -> RGB conversion for PIL images. ( vllm-project#18569 )\n\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\n\n* [V1][Spec Decoding] Use model_loader.get_model() to load models ( vllm-project#18273 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Enable hybrid attention models for Transformers backend ( vllm-project#18494 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] refactor: simplify input validation and num_requests handling in _convert_v1_inputs ( vllm-project#18482 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [BugFix] Increase TP execute_model timeout ( vllm-project#18558 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [Bugfix] Set `KVTransferConfig.engine_id` in post_init ( vllm-project#18576 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Spec Decode] Make EAGLE3 draft token ID mapping optional ( vllm-project#18488 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Neuron] Remove bypass on EAGLEConfig and add a test ( vllm-project#18514 )\n\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\n\n* [Bugfix][Benchmarks] Fix a benchmark of deepspeed-mii backend to use api_key ( vllm-project#17291 )\n\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\n\n* [Misc] Replace `cuda` hard code with `current_platform` ( vllm-project#16983 )\n\nSigned-off-by: shen-shanshan <467638484@qq.com>\n\n* [Hardware] correct method signatures for HPU,ROCm,XPU ( vllm-project#18551 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\n\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\n\n* [Feature]Add async tensor parallelism using compilation pass ( vllm-project#17882 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* [Doc] Update quickstart and install for cu128 using `--torch-backend=auto` ( vllm-project#18505 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Feature][V1]: suupports cached_tokens in response usage ( vllm-project#18149 )\n\nCo-authored-by: simon-mo <xmo@berkeley.edu>\n\n* [Bugfix] Add half type support in reshape_and_cache_cpu_impl on x86 cpu platform ( vllm-project#18430 )\n\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\n\n* Migrate docs from Sphinx to MkDocs ( vllm-project#18145 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Revert \"[V1] [Bugfix] eagle bugfix and enable correct lm_head for multimodal ( vllm-project#18034 )\" ( vllm-project#18600 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix][Model] Fix baichuan model loader for tp ( vllm-project#18597 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [V0][Bugfix] Fix parallel sampling performance regression when guided decoding is enabled ( vllm-project#17731 )\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\n\n* Add myself as docs code owner ( vllm-project#18605 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Hardware][CPU] Update intel_extension_for_pytorch 2.7.0 and move to `requirements/cpu.txt`  ( vllm-project#18542 )\n\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\n\n* [CI] fix kv_cache_type argument ( vllm-project#18594 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Doc] Fix indent of contributing to vllm ( vllm-project#18611 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* Replace `{func}` with mkdocs style links ( vllm-project#18610 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Fix V1 flag being set in entrypoints tests ( vllm-project#18598 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Fix examples with code blocks in docs ( vllm-project#18609 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Fix transformers model impl ignored for mixtral quant ( vllm-project#18602 )\n\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\n\n* Include private attributes in API documentation ( vllm-project#18614 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] add Haystack integration ( vllm-project#18601 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix][Build/CI] Fixup CUDA compiler version check for CUDA_SUPPORTED_ARCHS ( vllm-project#18579 )\n\n* [Doc] Fix markdown list indentation for MkDocs rendering ( vllm-project#18620 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [Doc] Use a different color for the announcement ( vllm-project#18616 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Refactor pplx init logic to make it modular (prepare for deepep) ( vllm-project#18200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Fix figures in design doc ( vllm-project#18612 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Change mkdocs to not use directory urls ( vllm-project#18622 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Redo \"Support multiple KV cache groups in GPU model runner ( vllm-project#17945 )\" ( vllm-project#18593 )\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\n\n* [Doc] fix list formatting ( vllm-project#18624 )\n\nSigned-off-by: David Xia <david@davidxia.com>\n\n* [Doc] Fix top-level API links/docs ( vllm-project#18621 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Avoid documenting dynamic / internal modules ( vllm-project#18626 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix broken links and unlinked docs, add shortcuts to home sidebar ( vllm-project#18627 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support Deepseek MTP ( vllm-project#18435 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use prebuilt FlashInfer x86_64 PyTorch 2.7 CUDA 12.8 wheel for CI ( vllm-project#18537 )\n\nSigned-off-by: Huy Do <huydhn@gmail.com>\n\n* [CI] Enable test_initialization to run on V1 ( vllm-project#16736 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Doc] Update references to doc files ( vllm-project#18637 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [ModelOpt] Introduce VLLM_MAX_TOKENS_PER_EXPERT_FP4_MOE env var to control blockscale tensor allocation ( vllm-project#18160 )\n\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\n\n* [Bugfix] Migrate to REGEX Library to prevent catastrophic backtracking ( vllm-project#18454 )\n\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\n\n* [Bugfix][Nixl] Fix Preemption Bug ( vllm-project#18631 )\n\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\n\n* config.py: Clarify that only local GGUF checkpoints are supported. ( vllm-project#18623 )\n\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\n\n* FIX MOE issue in AutoRound format ( vllm-project#18586 )\n\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\n\n* [V1][Spec Decode] Small refactors to improve eagle bookkeeping performance ( vllm-project#18424 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Frontend] improve vllm serve --help display ( vllm-project#18643 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Model] Add support for Qwen2.5-Omni-7B-AWQ (Qwen2_5OmniForConditionalGeneration) ( vllm-project#18647 )\n\n* [V1][Spec Decode] Support multi-layer eagle draft model ( vllm-project#18030 )\n\nSigned-off-by: qizixi <qizixi@meta.com>\n\n* [Doc] Update README links, mark external links ( vllm-project#18635 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC][pre-commit] Add pre-commit check for triton import ( vllm-project#17716 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Doc] Fix indentation problems in V0 Paged Attention docs ( vllm-project#18659 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Add community links ( vllm-project#18657 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Model] use AutoWeightsLoader for gpt2 ( vllm-project#18625 )\n\nSigned-off-by: zt2370 <ztang2370@gmail.com>\n\n* [Doc] Reorganize user guide ( vllm-project#18661 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] `chmod +x` to `cleanup_pr_body.sh` ( vllm-project#18650 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [MISC] typo fix and clean import ( vllm-project#18664 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [BugFix] Fix import error for fused_moe ( vllm-project#18642 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [CI] enforce import regex instead of re ( vllm-project#18665 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* fix(regression): clone from reference items ( vllm-project#18662 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [CI/Build] fix permission denied issue ( vllm-project#18645 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [BugFix][Spec Decode] Improve Prefix Caching Logic in Speculative Decoding ( vllm-project#18668 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Fix _pickle.PicklingError: Can't pickle <class 'transformers_modules.deepseek-ai.DeepSeek-V2-Lite... ( vllm-project#18640 )\n\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\n\n* [MISC] correct signature for LoaderFunction ( vllm-project#18670 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc]Replace `cuda` hard code with `current_platform` in Ray ( vllm-project#14668 )\n\nSigned-off-by: noemotiovon <757486878@qq.com>\n\n* [Misc][ModelScope] Change to use runtime VLLM_USE_MODELSCOPE ( vllm-project#18655 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [VLM] Initialize video input support for InternVL models ( vllm-project#18499 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* Speed up the `kernels/quantization/` tests ( vllm-project#18669 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [BUGFIX] catch subclass first for try...except ( vllm-project#18672 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Misc] Reduce logs on startup ( vllm-project#18649 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [doc] fix broken links ( vllm-project#18671 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [doc] improve readability ( vllm-project#18675 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix cpu usage and cache hit stats reporting on cpu environment ( vllm-project#18674 )\n\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [CI/build] fix no regex ( vllm-project#18676 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Misc] small improve ( vllm-project#18680 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Fix profiling dummy data for Pixtral ( vllm-project#18677 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Core][Multimodal] Convert PIL Image to array without data copy when hashing ( vllm-project#18682 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [CI/Build][Doc] Update `gte-Qwen2-1.5B-instruct` usage ( vllm-project#18683 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Fixed the abnormally high TTFT issue in the PD disaggregation example ( vllm-project#18644 )\n\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\n\n* refactor: simplify request handler, use positive condition check for handler assignment ( vllm-project#18690 )\n\nSigned-off-by: googs1025 <googs1025@gmail.com>\n\n* [Bugfix] Fix the lm_head in gpt_bigcode in lora mode ( vllm-project#6357 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\n\n* [CI] add missing argument ( vllm-project#18694 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [GH] Add issue template for reporting CI failures ( vllm-project#18696 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Fix issue template format ( vllm-project#18699 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Mistral-format models with sliding window ( vllm-project#18693 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI/Build] Replace `math.isclose` with `pytest.approx` ( vllm-project#18703 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [CI] fix dump_input for str type ( vllm-project#18697 )\n\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\n\n* [Model] Add support for YARN in NemotronNAS models ( vllm-project#18427 )\n\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\n\n* [CI/Build] Split pooling and generation extended language models tests in CI ( vllm-project#18705 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Add tensor parallel size = 2 test to HPU CI ( vllm-project#18709 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Misc] add AutoGen integration ( vllm-project#18712 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Bugfix]: handle hf-xet CAS error when loading Qwen3 weights in vLLM ( vllm-project#18701 )\n\n* [Doc] Improve API docs ( vllm-project#18713 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Move examples and further reorganize user guide ( vllm-project#18666 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Llama GGUF initialization ( vllm-project#18717 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Sampler] Improve performance of FlashInfer sampling by sampling logits instead of probs ( vllm-project#18608 )\n\n* Convert `examples` to `ruff-format` ( vllm-project#18400 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Model][Gemma3] Simplify image input validation ( vllm-project#18710 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [Misc] improve web section group title display ( vllm-project#18684 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [V1][Quantization] Add CUDA graph compatible v1 GGUF support ( vllm-project#18646 )\n\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Model][Gemma3] Cast image pixel values already on CPU ( vllm-project#18732 )\n\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\n\n* [FEAT] [ROCm] Upgrade AITER Fused MoE kernels. ( vllm-project#18271 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [Doc] Update OOT model docs ( vllm-project#18742 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Doc] Update reproducibility doc and example ( vllm-project#18741 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] improve docs ( vllm-project#18734 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* feat(rocm-support): support mamba2 on rocm ( vllm-project#18565 )\n\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\n\n* [Hardware][Intel-Gaudi] [CI/Build] Fix multiple containers using the same name in run-hpu-test.sh ( vllm-project#18752 )\n\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\n\n* [Doc] cleanup deprecated flag for doc ( vllm-project#18715 )\n\nSigned-off-by: calvin chen <120380290@qq.com>\n\n* Minor fix about MooncakeStoreConnector ( vllm-project#18721 )\n\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\n\n* [Build] fix cpu build missing libtbbmalloc.so ( vllm-project#18744 )\n\nSigned-off-by: Kebe <mail@kebe7jun.com>\n\n* [BUG FIX] minicpm ( vllm-project#18739 )\n\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\n\n* [Doc]  Convert Sphinx directives ( `{class}`, `{meth}`, `{attr}`, ...) to MkDocs format for better documentation linking ( vllm-project#18663 )\n\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\n\n* [CI/Build] Remove imports of built-in `re` ( vllm-project#18750 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1][Metrics] Add API for accessing in-memory Prometheus metrics ( vllm-project#17010 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Disable prefix cache by default for benchmark ( vllm-project#18639 )\n\nSigned-off-by: cascade812 <cascade812@outlook.com>\n\n* optimize get_kv_cache_torch_dtype ( vllm-project#18531 )\n\nSigned-off-by: idellzheng <idellzheng@tencent.com>\n\n* [Core] Automatically cast multi-modal input dtype ( vllm-project#18756 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Mistral tool calling when content is list ( vllm-project#18729 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n---------\n\nSigned-off-by: Satyajith Chilappagari <satchill@amazon.com>\nSigned-off-by: Lucia Fang <fanglu@fb.com>\nSigned-off-by: Liangfu Chen <liangfc@amazon.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Nan2018 <nan@protopia.ai>\nSigned-off-by: rand-fly <randfly@outlook.com>\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: calvin chen <120380290@qq.com>\nSigned-off-by: haochengxia <xhc_1007@163.com>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: Bill Nell <bnell@redhat.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: wwl2755 <wangwenlong2755@gmail.com>\nSigned-off-by: nicklucche <nlucches@redhat.com>\nSigned-off-by: Kebe <mail@kebe7jun.com>\nSigned-off-by: Yong Hoon Shin <yhshin@meta.com>\nSigned-off-by: rabi <ramishra@redhat.com>\nSigned-off-by: dhia.rhaiem <dhia.rhaiem@tii.ae>\nSigned-off-by: giantcroc <1204449533@qq.com>\nSigned-off-by: Hosang Yoon <hosang.yoon@amd.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nSigned-off-by: Sebastian SchÃ¶nnenbeck <sebastian.schoennenbeck@comma-soft.com>\nSigned-off-by: Andy Xie <andy.xning@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: jaycha <jaycha@ncsoft.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Shane A <shanea@allenai.org>\nSigned-off-by: Elaine Zhao <elaineyz@amazon.com>\nSigned-off-by: Linkun <github@lkchen.net>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: googs1025 <googs1025@gmail.com>\nSigned-off-by: Bowen Wang <abmfy@icloud.com>\nSigned-off-by: jiang.li <jiang1.li@intel.com>\nSigned-off-by: Lukas Geiger <lukas.geiger94@gmail.com>\nSigned-off-by: David Xia <david@davidxia.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tysmith@redhat.com>\nSigned-off-by: Kai Wu <kaiwu@meta.com>\nSigned-off-by: Sanger Steel <sangersteel@gmail.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Chenheli Hua <huachenheli@outlook.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Teruaki Ishizaki <teruaki.ishizaki@ntt.com>\nSigned-off-by: shen-shanshan <467638484@qq.com>\nSigned-off-by: Ronald Xu <ronaldxu@amazon.com>\nSigned-off-by: cascade812 <cascade812@outlook.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com>\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\nSigned-off-by: Zerohertz <ohg3417@gmail.com>\nSigned-off-by: Tristan Leclercq <tristanleclercq@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Huy Do <huydhn@gmail.com>\nSigned-off-by: Pavani Majety <pmajety@nvidia.com>\nSigned-off-by: Crucifixion-Fxl <xmufxl@gmail.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nSigned-off-by: Mathieu Bordere <mathieu@letmetweakit.com>\nSigned-off-by: wenhuach21 <wenhua.cheng@intel.com>\nSigned-off-by: qizixi <qizixi@meta.com>\nSigned-off-by: zt2370 <ztang2370@gmail.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Seiji Eicher <seiji@anyscale.com>\nSigned-off-by: noemotiovon <757486878@qq.com>\nSigned-off-by: zzzyq <zhangyuqi94@gmail.com>\nSigned-off-by: zhaohaidao <zhaohaidao2008@hotmail.com>\nSigned-off-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Max de Bayser <maxdebayser@gmail.com>\nSigned-off-by: Nave Assaf <nassaf@nvidia.com>\nSigned-off-by: Lukasz Durejko <ldurejko@habana.ai>\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nSigned-off-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nSigned-off-by: baoloongmao <baoloongmao@tencent.com>\nSigned-off-by: huangyuxiang03 <huangyx0321@gmail.com>\nSigned-off-by: idellzheng <idellzheng@tencent.com>\nCo-authored-by: sunyicode0012 <116338547+sunyicode0012@users.noreply.github.com>\nCo-authored-by: Gong Shufan <2624542821@qq.com>\nCo-authored-by: Satyajith Chilappagari <satchill@amazon.com>\nCo-authored-by: Lucia Fang <116399278+luccafong@users.noreply.github.com>\nCo-authored-by: Lucia (Lu) Fang <fanglu@meta.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Nan Qin <nan@protopia.ai>\nCo-authored-by: Andrew Sansom <andrew@protopia.ai>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Random Fly <renfei8@live.cn>\nCo-authored-by: Reid <61492567+reidliu41@users.noreply.github.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: æ±ªå¿—é¹ <wangzhipeng628@gmail.com>\nCo-authored-by: wang.yuqi <noooop@126.com>\nCo-authored-by: ç‡ƒ <wulipc@163.com>\nCo-authored-by: æ¾çµ <wpf272043@alibaba-inc.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Calvin Chen <45745657+calvin0327@users.noreply.github.com>\nCo-authored-by: Percy <xhc_1007@163.com>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: bnellnm <49004751+bnellnm@users.noreply.github.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: wwl2755 <wangwenlong2755@gmail.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Kebe <mail@kebe7jun.com>\nCo-authored-by: Yong Hoon Shin <48474650+sarckk@users.noreply.github.com>\nCo-authored-by: Rabi Mishra <ramishra@redhat.com>\nCo-authored-by: Dhia Eddine Rhaiem <163106757+dhiaEddineRhaiem@users.noreply.github.com>\nCo-authored-by: younesbelkada <younesbelkada@gmail.com>\nCo-authored-by: Ilyas Chahed <ilyas.chahed@tii.ae>\nCo-authored-by: Jingwei Zuo <jingwei.zuo@tii.ae>\nCo-authored-by: GiantCroc <1204449533@qq.com>\nCo-authored-by: Hyogeun Oh (ì˜¤íš¨ê·¼) <ohg3417@gmail.com>\nCo-authored-by: Hosang <156028780+hyoon1@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Sebastian Schoennenbeck <sebastian.schoennenbeck@comma-soft.com>\nCo-authored-by: Ning Xie <andy.xning@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: youngrok cha <line0930@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: kourosh hakhamaneshi <kourosh@anyscale.com>\nCo-authored-by: Shane A <shanea@allenai.org>\nCo-authored-by: aws-elaineyz <elaineyz@amazon.com>\nCo-authored-by: Shashwat Srijan <sssrijan@amazon.com>\nCo-authored-by: Aakash Shetty <sheaak@amazon.com>\nCo-authored-by: Tailin Pan <tailinpa@amazon.com>\nCo-authored-by: Rishabh Rajesh <rishyraj@amazon.com>\nCo-authored-by: Yishan McNabb <yishanm@amazon.com>\nCo-authored-by: Patrick Lange <patlange@amazon.com>\nCo-authored-by: Maxwell Goldberg <mgld@amazon.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: CYJiang <86391540+googs1025@users.noreply.github.com>\nCo-authored-by: Bowen Wang <abmfy@icloud.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Lukas Geiger <lukas.geiger94@gmail.com>\nCo-authored-by: David Xia <david@davidxia.com>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ekagra Ranjan <3116519+ekagra-ranjan@users.noreply.github.com>\nCo-authored-by: Kai Wu <kaiwu@meta.com>\nCo-authored-by: Sanger Steel <sangersteel@gmail.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Chenheli Hua <huachenheli@outlook.com>\nCo-authored-by: Benjamin Chislett <chislett.ben@gmail.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Teruaki Ishizaki <tell.ishi@gmail.com>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: RonaldBXu <72748153+RonaldBXu@users.noreply.github.com>\nCo-authored-by: cascade <cascade812@outlook.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Yuqi Zhang <zhangyuqi94@gmail.com>\nCo-authored-by: Yuqi Zhang <yuqizhang@google.com>\nCo-authored-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Kay Yan <kay.yan@daocloud.io>\nCo-authored-by: Tristan Leclercq <49700633+tristanleclercq@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Rui Qiao <ruisearch42@gmail.com>\nCo-authored-by: Huy Do <huydhn@gmail.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: Feng XiaoLong <79261065+Crucifixion-Fxl@users.noreply.github.com>\nCo-authored-by: Crucifixion-Fxl <xmufxl@gmail.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Mathieu BorderÃ© <mathieu@bordere.org>\nCo-authored-by: Wenhua Cheng <wenhua.cheng@intel.com>\nCo-authored-by: qizixi <22851944+zixi-qi@users.noreply.github.com>\nCo-authored-by: Yuanhao WU <Nalkey@users.noreply.github.com>\nCo-authored-by: ztang2370 <ztang2370@gmail.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: Seiji Eicher <58963096+eicherseiji@users.noreply.github.com>\nCo-authored-by: Chenguang Li <757486878@qq.com>\nCo-authored-by: Isotr0py <2037008807@qq.com>\nCo-authored-by: AlexZhao <zhaohaidao2008@hotmail.com>\nCo-authored-by: zhaohaiyuan <zhaohaiyuan@xiaohongshu.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Naveassaf <55059536+Naveassaf@users.noreply.github.com>\nCo-authored-by: Åukasz Durejko <lukasz.durejko@intel.com>\nCo-authored-by: dylan <xuhao296@qq.com>\nCo-authored-by: almersawi <43927639+almersawi@users.noreply.github.com>\nCo-authored-by: Islam Almersawi <islam.almersawi@openinnovation.ai>\nCo-authored-by: Åukasz Durejko <ldurejko@habana.ai>\nCo-authored-by: maobaolong <baoloongmao@tencent.com>\nCo-authored-by: Shawn Huang <57223022+huangyuxiang03@users.noreply.github.com>\nCo-authored-by: huangyuxiang03 <huangyx0321@gmail.com>\nCo-authored-by: chunxiaozheng <55471457+chunxiaozheng@users.noreply.github.com> minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [V0][Bugfix] Fix parallel sampling performance regression when guidedâ€¦ â€¦ ac503be â€¦ decoding is enabled ( vllm-project#17731 )\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:04", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, profile, profiling | SERVING: vllm serve, serve, Frontend | TEST: test, test, Test", "analysis_extracted_at": "2025-09-07 17:51:04", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V0][Bugfix] Fix parallel sampling performance regression when guided decoding is enabled (#17731)", "commit_message": "[V0][Bugfix] Fix parallel sampling performance regression when guided decoding is enabled (#17731)\n\nSigned-off-by: Madeesh Kannan <shadeMe@users.noreply.github.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>", "commit_date": "2025-05-23T03:38:23-07:00", "files_changed": ["vllm/model_executor/guided_decoding/guidance_logits_processors.py", "vllm/model_executor/guided_decoding/outlines_logits_processors.py", "vllm/model_executor/guided_decoding/xgrammar_decoding.py", "vllm/sequence.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 4, "only_test_files": 0, "only_non_test_files": 1, "num_files": 4, "num_hunks": 9, "num_edited_lines": 48, "num_non_test_edited_lines": 48, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/guided_decoding/guidance_logits_processors.py b/vllm/model_executor/guided_decoding/guidance_logits_processors.py\nindex 4b45c272a..e17df68b4 100644\n--- a/vllm/model_executor/guided_decoding/guidance_logits_processors.py\n+++ b/vllm/model_executor/guided_decoding/guidance_logits_processors.py\n@@ -1,4 +1,5 @@\n # SPDX-License-Identifier: Apache-2.0\n+import copy\n import os\n from typing import Any\n \n@@ -34,9 +35,24 @@ class GuidanceLogitsProcessor:\n         self.grammar = grammar\n         self.tokenizer = tokenizer\n         self.tokenizer_name = tokenizer.name_or_path\n+        self.ll_tokenizer = None\n+        self.ll_matcher = None\n+        self.bitmask = None\n         self.new_sampling = False\n         self.initialized = False\n \n+    def clone(self) -> \"GuidanceLogitsProcessor\":\n+        cloned = copy.copy(self)\n+        if self.initialized:\n+            cloned.ll_matcher = llguidance.LLMatcher(\n+                self.ll_tokenizer,  # type: ignore[assignment]\n+                self.grammar,\n+                log_level=int(os.environ.get(\"LLGUIDANCE_LOG_LEVEL\", \"1\")),\n+            )\n+            self.bitmask = llguidance.torch.allocate_token_bitmask(\n+                1, self.ll_tokenizer.vocab_size)  # type: ignore[attr-defined]\n+        return cloned\n+\n     def _initialize(self):\n         if self.initialized:\n             return\n@@ -56,7 +72,7 @@ class GuidanceLogitsProcessor:\n \n         # create reusable bitmask\n         self.bitmask = llguidance.torch.allocate_token_bitmask(\n-            1, self.ll_tokenizer.vocab_size)\n+            1, self.ll_tokenizer.vocab_size)  # type: ignore[attr-defined]\n \n         self.initialized = True\n \n@@ -70,15 +86,17 @@ class GuidanceLogitsProcessor:\n         self._initialize()\n \n         if self.new_sampling and len(input_ids) > 0:\n-            self.ll_matcher.consume_token(input_ids[-1])\n-            err = self.ll_matcher.get_error()\n+            self.ll_matcher.consume_token(  # type: ignore[attr-defined]\n+                input_ids[-1])\n+            err = self.ll_matcher.get_error()  # type: ignore[attr-defined]\n             if err:\n                 logger.warning(\"Error in LLMatcher: %s\", err)\n \n         llguidance.torch.fill_next_token_bitmask(self.ll_matcher, self.bitmask,\n                                                  0)\n         llguidance.torch.apply_token_bitmask_inplace(\n-            scores, self.bitmask.to(scores.device))\n+            scores,\n+            self.bitmask.to(scores.device))  # type: ignore[attr-defined]\n \n         self.new_sampling = True\n \ndiff --git a/vllm/model_executor/guided_decoding/outlines_logits_processors.py b/vllm/model_executor/guided_decoding/outlines_logits_processors.py\nindex 8ae7c7b6b..6986b6554 100644\n--- a/vllm/model_executor/guided_decoding/outlines_logits_processors.py\n+++ b/vllm/model_executor/guided_decoding/outlines_logits_processors.py\n@@ -56,6 +56,12 @@ class BaseLogitsProcessor:\n         self._fsm_state: defaultdict[int, Union[int,\n                                                 CFGState]] = defaultdict(int)\n \n+    def clone(self) -> \"BaseLogitsProcessor\":\n+        cloned = copy.copy(self)\n+        cloned._guide = self._guide.copy()\n+        cloned._fsm_state = copy.deepcopy(self._fsm_state)\n+        return cloned\n+\n     def __call__(self, input_ids: list[int],\n                  scores: torch.Tensor) -> torch.Tensor:\n         \"\"\"Use the FSM to bias the logits before sampling the next token.\"\"\"\n@@ -218,6 +224,12 @@ class CFGLogitsProcessor(BaseLogitsProcessor):\n                          reasoner)\n         self._guide = self._guide.copy()\n \n+    def clone(self) -> \"CFGLogitsProcessor\":\n+        cloned = copy.copy(self)\n+        cloned._fsm_state = copy.deepcopy(self._fsm_state)\n+        cloned._guide = self._guide.copy()\n+        return cloned\n+\n \n @lru_cache(maxsize=32)\n def _adapt_tokenizer(tokenizer: PreTrainedTokenizerBase):\ndiff --git a/vllm/model_executor/guided_decoding/xgrammar_decoding.py b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\nindex 8e40da4b3..7ca7bab81 100644\n--- a/vllm/model_executor/guided_decoding/xgrammar_decoding.py\n+++ b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\n@@ -302,8 +302,9 @@ class XGrammarLogitsProcessor:\n     prefilled: bool = field(default=False)\n \n     def __post_init__(self):\n-        self.tokenizer_info = self.config.tokenizer_info(\n-            self.config.tokenizer_data)\n+        if self.tokenizer_info is None:\n+            self.tokenizer_info = self.config.tokenizer_info(\n+                self.config.tokenizer_data)\n \n     def __getstate__(self) -> dict[str, Any]:\n         return {'config': self.config, 'reasoner': self.reasoner}\n@@ -400,7 +401,8 @@ class XGrammarLogitsProcessor:\n     def clone(self) -> XGrammarLogitsProcessor:\n         \"\"\"Create a new instance with shared compiled grammar\n           but separate state\"\"\"\n-        new_processor = XGrammarLogitsProcessor(self.config, self.reasoner)\n+        new_processor = XGrammarLogitsProcessor(self.config, self.reasoner,\n+                                                None, self.tokenizer_info)\n \n         # Share the compiled grammar context (immutable after compilation)\n         new_processor.ctx = self.ctx\ndiff --git a/vllm/sequence.py b/vllm/sequence.py\nindex f5f9c56a7..f3dfd32d9 100644\n--- a/vllm/sequence.py\n+++ b/vllm/sequence.py\n@@ -1494,7 +1494,7 @@ class ParallelSampleSequenceGroup(SequenceGroupBase):\n         for i in range(original_params.n):\n             request_id_i = f\"{request_id}_parallel_sample_{i}\"\n             group.seq_id_to_index[request_id_i] = i\n-            params = copy.deepcopy(original_params)\n+            params = params.clone()\n             params.n = 1\n             if params.seed is not None:\n                 params.seed += i", "apis": ["GuidanceLogitsProcessor.clone", "BaseLogitsProcessor.clone", "CFGLogitsProcessor.clone", "XGrammarLogitsProcessor.clone", "SamplingParams.clone"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/sequence.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit addresses a parallel sampling performance regression when guided decoding is enabled. It modifies multiple non-test source files by changing how objects are cloned (e.g., replacing a deepcopy with a clone method in sequence.py) and updating related functions in guided decoding modules. Although the commit message includes a bugfix tag, it specifically refers to a performance regression, and the changes aim at improving the execution speed of guided decoding under parallel sampling. The modifications are non-trivial and affect internal/high-level APIs without being tied to GPU-specific optimizations. Therefore, the commit meets the criteria for being performance-related.", "llm_api_reason": "The commit adds new â€œcloneâ€ methods to multiple guided decoding logits processor classes. In guidance_logits_processors.py, a clone() is introduced to copy a GuidanceLogitsProcessor instance while reinitializing certain internal state. Similarly, in outlines_logits_processors.py both BaseLogitsProcessor and CFGLogitsProcessor receive new clone() implementations, and in xgrammar_decoding.py the clone() method of XGrammarLogitsProcessor is modified to pass tokenizer_info. Additionally, in sequence.py the usage of deep-copying of sampling parameters is replaced by invoking a clone() method, affecting the SamplingParams API."}
{"commit_hash": "67da5720d4ed2aa1f615ec812031f4f3753b3f62", "pr_url": "https://github.com/vllm-project/vllm/pull/17973", "pr_date": "2025-05-16", "timeline_text": "Copy link Contributor vadiklyutiy commented May 12, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Description of Problem In Qwen2.5-VL rotary position embedding constant tensors creates in the beginning of model's forward . Before this PR there were a mix of CPU and GPU tensors and (small) data pieces transferred back and forward to device. Profile looked like below pink tmp is begining of Qwen2_5_VisionTransformer.forward() before main transformer started. Solution This PR: makes a refactoring and put all tensors necessary to create constant mrope data to CPU (similar to how it works for mrope for language (part of) models) regroup calculation by grid_thw line and cache results Now profile looks like below Performance results Run Qwen2.5-3B-VL on H100 with following command line vllm serve Qwen/Qwen2.5-VL-3B-Instruct --disable-log-requests --max-num-seqs 1024  --block-size 16 --max-num-batched-tokens 2048 Construction of constant mrope tensors itself speeded up 5+ times . E2E measured with https://github.com/CentML/flexible-inference-bench fib benchmark -rps 50 --input-token-distribution uniform 250 300 --output-token-distribution uniform 150 250 --num-of-imgs-per-req 1 --img-ratios-per-req 512x512 -n 1000 --base-url http://localhost:8000 --endpoint v1/chat/completions --backend openai-chat The above runs 1000 requests, 50 reqs/sec, every request has one 512x512 image. Measured average reqs/s. Made 11 runs and took median Before: 25.99 reqs/s After: 26.63 req/s Speed up: 2.46% Correctness Run lm_eval with chartqa and mmmu lm_eval --model vllm-vlm --model_args \"pretrained=Qwen/Qwen2.5-VL-3B-Instruct,model=Qwen/Qwen2.5-VL-3B-Instruct\"  --tasks mmmu_val,chartqa  --batch_size 32 --apply_chat_template Before |                 Tasks                 |Version|Filter|n-shot|     Metric      |   |Value |   |Stderr|\n|---------------------------------------|------:|------|-----:|-----------------|---|-----:|---|-----:|\n|chartqa                                |      0|none  |     0|anywhere_accuracy|â†‘  |0.8072|Â±  |0.0079|\n|                                       |       |none  |     0|exact_match      |â†‘  |0.5712|Â±  |0.0099|\n|                                       |       |none  |     0|relaxed_accuracy |â†‘  |0.8040|Â±  |0.0079|\n\n|             Groups             |Version|Filter|n-shot|Metric|   |Value |   |Stderr|\n|--------------------------------|------:|------|------|------|---|-----:|---|-----:|\n|mmmu_val                        |      0|none  |      |acc   |â†‘  |0.4567|Â±  |0.0159|\n| - Art and Design               |      0|none  |      |acc   |â†‘  |0.5583|Â±  |0.0437|\n| - Business                     |      0|none  |      |acc   |â†‘  |0.3733|Â±  |0.0395|\n| - Health and Medicine          |      0|none  |      |acc   |â†‘  |0.5267|Â±  |0.0406|\n| - Humanities and Social Science|      0|none  |      |acc   |â†‘  |0.7000|Â±  |0.0412|\n| - Science                      |      0|none  |      |acc   |â†‘  |0.3267|Â±  |0.0386|\n| - Tech and Engineering         |      0|none  |      |acc   |â†‘  |0.3619|Â±  |0.0326| After |                 Tasks                 |Version|Filter|n-shot|     Metric      |   |Value |   |Stderr|\n|---------------------------------------|------:|------|-----:|-----------------|---|-----:|---|-----:|\n|chartqa                                |      0|none  |     0|anywhere_accuracy|â†‘  |0.8032|Â±  |0.0080|\n|                                       |       |none  |     0|exact_match      |â†‘  |0.5756|Â±  |0.0099|\n|                                       |       |none  |     0|relaxed_accuracy |â†‘  |0.8016|Â±  |0.0080|\n\n|             Groups             |Version|Filter|n-shot|Metric|   |Value |   |Stderr|\n|--------------------------------|------:|------|------|------|---|-----:|---|-----:|\n|mmmu_val                        |      0|none  |      |acc   |â†‘  |0.4544|Â±  |0.0159|\n| - Art and Design               |      0|none  |      |acc   |â†‘  |0.5583|Â±  |0.0443|\n| - Business                     |      0|none  |      |acc   |â†‘  |0.3733|Â±  |0.0395|\n| - Health and Medicine          |      0|none  |      |acc   |â†‘  |0.5067|Â±  |0.0407|\n| - Humanities and Social Science|      0|none  |      |acc   |â†‘  |0.7083|Â±  |0.0411|\n| - Science                      |      0|none  |      |acc   |â†‘  |0.3267|Â±  |0.0386|\n| - Tech and Engineering         |      0|none  |      |acc   |â†‘  |0.3619|Â±  |0.0327| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Speed up Qwen2.5-VL model by speed up rotary position embedding constâ€¦ â€¦ 7eec475 â€¦ Tensors creation\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> Copy link github-actions bot commented May 12, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . pre-commit fixes â€¦ ab81b1d Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> simon-mo approved these changes May 14, 2025 View reviewed changes Copy link Collaborator simon-mo left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment thank you for the optimization, please run a mmmu or chartqa evaluation to verify the correctness of the changes. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 vadiklyutiy reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/model_executor/models/qwen2_5_vl.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/models/qwen2_5_vl.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . revome unnecessary coments â€¦ 5d0b6e2 Signed-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai> Copy link Contributor Author vadiklyutiy commented May 15, 2025 thank you for the optimization, please run a mmmu or chartqa evaluation to verify the correctness of the changes. I added to description results of mmmu and chartqa \"before\" and \"after\" ðŸ‘ 1 simon-mo reacted with thumbs up emoji ðŸš€ 1 simon-mo reacted with rocket emoji All reactions ðŸ‘ 1 reaction ðŸš€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . simon-mo enabled auto-merge (squash) May 15, 2025 01:10 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label May 15, 2025 WoosukKwon disabled auto-merge May 15, 2025 01:37 Copy link Collaborator WoosukKwon commented May 15, 2025 @imkero Could you please take a final look? I'm not sure if this overlaps with #14684 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented May 15, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @vadiklyutiy . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label May 15, 2025 Merge branch 'main' into rope-const-creation-speedup 20808fa mergify bot removed\n  the needs-rebase label May 16, 2025 Copy link Collaborator WoosukKwon commented May 16, 2025 @vadiklyutiy QQ: Why does this PR change the accuracy (though the diff is small)? I thought the PR doesn't change the computation at all. Can we somehow strictly match the accuracy? I'm a bit careful about this because we've seen a few bugs regarding m-rope. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator simon-mo commented May 16, 2025 @WoosukKwon these tests are not deterministic due to temperature, I read values and apply the stderr; seems no change to accuracy to me. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor imkero commented May 16, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . The idea of this PR is similar to #14684 . And it is verified by both #14684 and this PR that such approach will gain some performance improvement. If the inference result slightly changed in this PR, maybe we should compare the generated m-rope pos seq and window_index seq  output with those generated by main branch. Also check if we are testing with greedy decoding. By the way I suggest that we can keep image_grid_thw and video_grid_thw in CPU all the time by modifying vllm/multimodal/inputs.py::MultiModalKwargs::as_kwargs (here vLLM move all mm data to device by default, and still needed to move them back to host later) @staticmethod\n  def as_kwargs(\n      batched_inputs: BatchedTensorInputs,\n      *,\n      device: torch.types.Device,\n  ) -> BatchedTensorInputs:\n      json_inputs = cast(JSONTree[torch.Tensor], batched_inputs) + # keep Qwen2/2.5-VL's image_grid_thw and video_grid_thw in cpu + image_grid_thw = None + video_grid_thw = None + if isinstance(json_inputs, dict): + image_grid_thw = json_inputs.pop(\"image_grid_thw\", None) + video_grid_thw = json_inputs.pop(\"video_grid_thw\", None) json_mapped = json_map_leaves(\n          lambda x: x.to(device, non_blocking=True),\n          json_inputs,\n      ) + if image_grid_thw is not None: + json_mapped[\"image_grid_thw\"] = image_grid_thw  # type: ignore + if video_grid_thw is not None: + json_mapped[\"video_grid_thw\"] = video_grid_thw  # type: ignore return cast(BatchedTensorInputs, json_mapped) All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator WoosukKwon commented May 16, 2025 @simon-mo @imkero Thanks for the explanation. Ok let's merge this PR for v0.9.0 and further improve it with @imkero 's suggestion All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details WoosukKwon merged commit 67da572 into vllm-project : main May 16, 2025 65 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author vadiklyutiy commented May 16, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @WoosukKwon As @simon-mo said lm_eval isn't deterministic. To dispel doubts in correctness I wrote the following test that compare \"before\" and \"after\" implementations. In test I took Qwen2_5_VisionTransformer before and after and copy to test. Clean both to calculate only rotary_pos_emb , window_index , cu_window_seqlens , and cu_seqlens . Test takes arbitrary grid_thw , run both version and compare results. Test accept following args --samples number of different grid to test --max-t max value of t --max-h max value of h --max-w max value of w --max-images - len(grid_thw) The following runs successfully passed: $ python test_qwen25_vl_transformer.py --mass-test --samples 10000 --max-t 50 --max-h 100 --max-w 100 --max-images 5 $python test_qwen25_vl_transformer.py --mass-test --samples 10000 --max-t 100 --max-h 250 --max-w 250 --max-images 10 Hope that resolved worries about correctness Test source import torch import torch . nn as nn import torch . nn . functional as F from functools import lru_cache import argparse import numpy as np import random import tqdm import sys class TestFailureException ( Exception ): \"\"\"Exception raised when the test results don't match between old and new implementations.\"\"\" pass class Qwen2_5_VisionRotaryEmbedding ( nn . Module ): def __init__ ( self , dim : int , theta : float = 10000.0 ) -> None : super (). __init__ () self . dim = dim self . theta = theta inv_freq = 1.0 / ( theta ** ( torch . arange ( 0 , dim , 2 , dtype = torch . float , device = 'cpu' ) / dim )) self . register_buffer ( \"inv_freq\" , inv_freq , persistent = False ) self . _seq_len_cached = 0 self . _freqs_cached = None def update_freqs_cache ( self , seqlen : int ) -> None : if seqlen > self . _seq_len_cached : seqlen *= 2 self . _seq_len_cached = seqlen self . inv_freq = 1.0 / ( self . theta ** ( torch . arange ( 0 , self . dim , 2 , dtype = torch . float , device = self . inv_freq . device ) / self . dim )) seq = torch . arange ( seqlen , device = self . inv_freq . device , dtype = self . inv_freq . dtype ) freqs = torch . outer ( seq , self . inv_freq ) self . _freqs_cached = freqs def forward ( self , seqlen : int ) -> torch . Tensor : self . update_freqs_cache ( seqlen ) return self . _freqs_cached [: seqlen ] class Qwen2_5_VisionTransformer_New ( nn . Module ): def __init__ ( self , hidden_size = 1152 , num_heads = 16 , window_size = 32 , patch_size = 14 , spatial_merge_size = 2 , fullatt_block_indexes = [ 0 , 1 , 2 , 3 , 8 , 9 , 10 , 11 , 16 , 17 , 18 , 19 , 24 , 25 , 26 , 27 ],\n    ) -> None : super (). __init__ () self . hidden_size = hidden_size self . num_heads = num_heads self . window_size = window_size self . patch_size = patch_size self . spatial_merge_size = spatial_merge_size self . fullatt_block_indexes = fullatt_block_indexes self . spatial_merge_unit = self . spatial_merge_size ** 2 head_dim = self . hidden_size // self . num_heads self . rotary_pos_emb = Qwen2_5_VisionRotaryEmbedding ( head_dim // 2 ) @ property def dtype ( self ) -> torch . dtype : return torch . float32 @ property def device ( self ) -> torch . device : return torch . device ( 'cpu' ) def rotary_pos_emb_thw ( self , t , h , w ): hpos_ids = torch . arange ( h ). unsqueeze ( 1 ). expand ( - 1 , w ) wpos_ids = torch . arange ( w ). unsqueeze ( 0 ). expand ( h , - 1 ) hpos_ids = hpos_ids . reshape ( h // self . spatial_merge_size , self . spatial_merge_size , w // self . spatial_merge_size , self . spatial_merge_size ,\n        ). permute ( 0 , 2 , 1 , 3 ). flatten () wpos_ids = wpos_ids . reshape ( h // self . spatial_merge_size , self . spatial_merge_size , w // self . spatial_merge_size , self . spatial_merge_size ,\n        ). permute ( 0 , 2 , 1 , 3 ). flatten () pos_ids = torch . stack ([ hpos_ids , wpos_ids ], dim = - 1 ). repeat ( t , 1 ) max_size = max ( h , w ) rotary_pos_emb_full = self . rotary_pos_emb ( max_size ) rotary_pos_emb = rotary_pos_emb_full [ pos_ids ]. flatten ( 1 ) rotary_pos_emb = rotary_pos_emb . reshape ( rotary_pos_emb . shape [ 0 ] // self . spatial_merge_unit , self . spatial_merge_unit , - 1 ) return rotary_pos_emb def get_window_index_thw ( self , grid_t , grid_h , grid_w ): vit_merger_window_size = ( self . window_size // self . spatial_merge_size // self . patch_size ) llm_grid_h = grid_h // self . spatial_merge_size llm_grid_w = grid_w // self . spatial_merge_size index = torch . arange ( grid_t * llm_grid_h * llm_grid_w ). reshape ( grid_t , llm_grid_h , llm_grid_w ) pad_h = vit_merger_window_size - llm_grid_h % vit_merger_window_size pad_w = vit_merger_window_size - llm_grid_w % vit_merger_window_size num_windows_h = ( llm_grid_h + pad_h ) // vit_merger_window_size num_windows_w = ( llm_grid_w + pad_w ) // vit_merger_window_size index_padded = F . pad ( index , ( 0 , pad_w , 0 , pad_h ), 'constant' , - 100 ) index_padded = index_padded . reshape ( grid_t , num_windows_h , vit_merger_window_size , num_windows_w , vit_merger_window_size ) index_padded = index_padded . permute ( 0 , 1 , 3 , 2 , 4 ). reshape ( grid_t , num_windows_h * num_windows_w , vit_merger_window_size , vit_merger_window_size ) seqlens = ( index_padded != - 100 ). sum ([ 2 , 3 ]). reshape ( - 1 ) index_padded = index_padded . reshape ( - 1 ) index_new = index_padded [ index_padded != - 100 ] cu_seqlens_tmp = seqlens . cumsum ( 0 ) * self . spatial_merge_unit cu_seqlens_tmp = cu_seqlens_tmp . to ( dtype = torch . int32 ) cu_seqlens_tmp = torch . unique_consecutive ( cu_seqlens_tmp ) return index_new , cu_seqlens_tmp @ lru_cache ( maxsize = 1024 ) # noqa: B019 def get_rope_by_thw ( self , t , h , w ): window_index_thw , cu_seqlens_window_thw = self . get_window_index_thw ( t , h , w ) rotary_pos_emb_thw = self . rotary_pos_emb_thw ( t , h , w ) rotary_pos_emb_thw = rotary_pos_emb_thw [ window_index_thw , :, :] rotary_pos_emb_thw = rotary_pos_emb_thw . flatten ( start_dim = 0 , end_dim = 1 ) cu_seqlens_thw = torch . repeat_interleave ( torch . tensor ([ h * w ], dtype = torch . int32 ), t ) return ( rotary_pos_emb_thw , window_index_thw , cu_seqlens_window_thw , cu_seqlens_thw ) def process_grid_thw ( self , grid_thw ): rotary_pos_emb = [] window_index = [] cu_window_seqlens = [ torch . tensor ([ 0 ], dtype = torch . int32 )] cu_seqlens = [] window_index_id = 0 cu_window_seqlens_last = 0 for t , h , w in grid_thw : t , h , w = int ( t ), int ( h ), int ( w ) llm_h = h // self . spatial_merge_size llm_w = w // self . spatial_merge_size ( rotary_pos_emb_thw , window_index_thw , cu_seqlens_window_thw , cu_seqlens_thw ,\n            ) = self . get_rope_by_thw ( t , h , w ) window_index . append ( window_index_thw + window_index_id ) window_index_id += ( t * llm_h * llm_w ) cu_seqlens_window_thw = ( cu_seqlens_window_thw + cu_window_seqlens_last ) cu_window_seqlens_last = cu_seqlens_window_thw [ - 1 ] cu_window_seqlens . append ( cu_seqlens_window_thw ) rotary_pos_emb . append ( rotary_pos_emb_thw ) cu_seqlens . append ( cu_seqlens_thw ) rotary_pos_emb = torch . cat ( rotary_pos_emb ) window_index = torch . cat ( window_index ) cu_window_seqlens = torch . cat ( cu_window_seqlens ) cu_window_seqlens = torch . unique_consecutive ( cu_window_seqlens ) cu_seqlens = torch . cat ( cu_seqlens ) cu_seqlens = torch . cumsum ( cu_seqlens , dim = 0 , dtype = torch . int32 ) cu_seqlens = F . pad ( cu_seqlens , ( 1 , 0 ), \"constant\" , 0 ) return rotary_pos_emb , window_index , cu_window_seqlens , cu_seqlens class Qwen2_5_VisionTransformer_Old ( nn . Module ): def __init__ ( self , hidden_size = 1152 , num_heads = 16 , window_size = 32 , patch_size = 14 , spatial_merge_size = 2 , fullatt_block_indexes = [ 0 , 1 , 2 , 3 , 8 , 9 , 10 , 11 , 16 , 17 , 18 , 19 , 24 , 25 , 26 , 27 ],\n    ) -> None : super (). __init__ () self . hidden_size = hidden_size self . num_heads = num_heads self . window_size = window_size self . patch_size = patch_size self . spatial_merge_size = spatial_merge_size self . fullatt_block_indexes = fullatt_block_indexes self . spatial_merge_unit = self . spatial_merge_size ** 2 head_dim = self . hidden_size // self . num_heads self . rotary_pos_emb = Qwen2_5_VisionRotaryEmbedding ( head_dim // 2 ) @ property def dtype ( self ) -> torch . dtype : return torch . float32 @ property def device ( self ) -> torch . device : return torch . device ( 'cpu' ) def rot_pos_emb ( self , grid_thw : torch . Tensor ) -> torch . Tensor : pos_ids = [] for t , h , w in grid_thw : hpos_ids = torch . arange ( h ). unsqueeze ( 1 ). expand ( - 1 , w ) wpos_ids = torch . arange ( w ). unsqueeze ( 0 ). expand ( h , - 1 ) hpos_ids = hpos_ids . reshape ( h // self . spatial_merge_size , self . spatial_merge_size , w // self . spatial_merge_size , self . spatial_merge_size ,\n            ). permute ( 0 , 2 , 1 , 3 ). flatten () wpos_ids = wpos_ids . reshape ( h // self . spatial_merge_size , self . spatial_merge_size , w // self . spatial_merge_size , self . spatial_merge_size ,\n            ). permute ( 0 , 2 , 1 , 3 ). flatten () pos_ids . append ( torch . stack ([ hpos_ids , wpos_ids ], dim = - 1 ). repeat ( t , 1 )) pos_ids = torch . cat ( pos_ids , dim = 0 ) max_grid_size = grid_thw [:, 1 :]. max () rotary_pos_emb_full = self . rotary_pos_emb ( max_grid_size ) rotary_pos_emb = rotary_pos_emb_full [ pos_ids ]. flatten ( 1 ) return rotary_pos_emb def get_window_index ( self , grid_thw ): window_index : list = [] cu_window_seqlens : list = [ 0 ] window_index_id = 0 vit_merger_window_size = ( self . window_size // self . spatial_merge_size // self . patch_size ) for grid_t , grid_h , grid_w in grid_thw : llm_grid_h = grid_h // self . spatial_merge_size llm_grid_w = grid_w // self . spatial_merge_size index = torch . arange ( grid_t * llm_grid_h * llm_grid_w ). reshape ( grid_t , llm_grid_h , llm_grid_w ) pad_h = vit_merger_window_size - llm_grid_h % vit_merger_window_size pad_w = vit_merger_window_size - llm_grid_w % vit_merger_window_size num_windows_h = ( llm_grid_h + pad_h ) // vit_merger_window_size num_windows_w = ( llm_grid_w + pad_w ) // vit_merger_window_size index_padded = F . pad ( index , ( 0 , pad_w , 0 , pad_h ), 'constant' , - 100 ) index_padded = index_padded . reshape ( grid_t , num_windows_h , vit_merger_window_size , num_windows_w , vit_merger_window_size ) index_padded = index_padded . permute ( 0 , 1 , 3 , 2 , 4 ). reshape ( grid_t , num_windows_h * num_windows_w , vit_merger_window_size , vit_merger_window_size ) seqlens = ( index_padded != - 100 ). sum ([ 2 , 3 ]). reshape ( - 1 ) index_padded = index_padded . reshape ( - 1 ) index_new = index_padded [ index_padded != - 100 ] window_index . append ( index_new + window_index_id ) cu_seqlens_tmp = seqlens . cumsum ( 0 ) * self . spatial_merge_unit + cu_window_seqlens [ - 1 ] cu_window_seqlens . extend ( cu_seqlens_tmp . tolist ()) window_index_id += ( grid_t * llm_grid_h * llm_grid_w ). item () window_index = torch . cat ( window_index , dim = 0 ) return window_index , cu_window_seqlens def compute_attn_mask_seqlen ( self , cu_seqlens : torch . Tensor ,\n    ) -> tuple [ None , None ]: return None , None def process_grid_thw ( self , grid_thw_list ): # Convert list to tensor for compatibility with old model grid_thw = torch . tensor ( grid_thw_list , dtype = torch . int32 ) # Compute positional embeddings rotary_pos_emb = self . rot_pos_emb ( grid_thw ) # Compute window indices and seqlens window_index , cu_window_seqlens = self . get_window_index ( grid_thw ) cu_window_seqlens = torch . tensor ( cu_window_seqlens , device = window_index . device , dtype = torch . int32 ) cu_window_seqlens = torch . unique_consecutive ( cu_window_seqlens ) # Compute sequence lengths cu_seqlens = torch . repeat_interleave ( grid_thw [:, 1 ] * grid_thw [:, 2 ], grid_thw [:, 0 ]). cumsum ( dim = 0 , dtype = torch . int32 ) cu_seqlens = F . pad ( cu_seqlens , ( 1 , 0 ), \"constant\" , 0 ) return rotary_pos_emb , window_index , cu_window_seqlens , cu_seqlens def tensor_equals ( t1 , t2 , name = None , rtol = 1e-5 , atol = 1e-5 ): if t1 . shape != t2 . shape : if name : print ( f\"âœ— { name } shapes differ: { t1 . shape } vs { t2 . shape } \" ) return False equal = torch . allclose ( t1 , t2 , rtol = rtol , atol = atol ) if not equal : # Find the positions where they differ diff_mask = ~ torch . isclose ( t1 , t2 , rtol = rtol , atol = atol ) if diff_mask . sum () > 0 : diff_pos = diff_mask . nonzero () first_diff = diff_pos [ 0 ]. tolist () t1_val = t1 [ tuple ( first_diff )] t2_val = t2 [ tuple ( first_diff )] if name : print ( f\"âœ— { name } values differ at { first_diff } : { t1_val } vs { t2_val } \" ) print ( f\"Total number of different values: { diff_mask . sum (). item () } / { t1 . numel () } \" ) else : if name : print ( f\"âœ— { name } values differ but couldn't identify position\" ) # Print some stats about the differences if name and t1 . numel () < 100 : print ( f\"Old: { t1 . flatten (). tolist () } \" ) print ( f\"New: { t2 . flatten (). tolist () } \" ) return False if name : print ( f\"âœ“ { name } matched\" ) return True def run_test ( grid_thw , verbose = True ): # Create models new_model = Qwen2_5_VisionTransformer_New () old_model = Qwen2_5_VisionTransformer_Old () if verbose : print ( \" \\n Testing with grid_thw:\" , grid_thw ) # Test the new model rotary_pos_emb_new , window_index_new , cu_window_seqlens_new , cu_seqlens_new = new_model . process_grid_thw ( grid_thw ) if verbose : print ( \" \\n New model outputs:\" ) print ( f\"rotary_pos_emb shape: { rotary_pos_emb_new . shape } \" ) print ( f\"window_index shape: { window_index_new . shape } \" ) print ( f\"cu_window_seqlens shape: { cu_window_seqlens_new . shape } \" ) print ( f\"cu_seqlens shape: { cu_seqlens_new . shape } \" ) # Test the old model rotary_pos_emb_old , window_index_old , cu_window_seqlens_old , cu_seqlens_old = old_model . process_grid_thw ( grid_thw ) if verbose : print ( \" \\n Old model outputs:\" ) print ( f\"rotary_pos_emb shape: { rotary_pos_emb_old . shape } \" ) print ( f\"window_index shape: { window_index_old . shape } \" ) print ( f\"cu_window_seqlens shape: { cu_window_seqlens_old . shape } \" ) print ( f\"cu_seqlens shape: { cu_seqlens_old . shape } \" ) # Compare outputs if verbose : print ( \" \\n Comparing outputs:\" ) match_rotary = tensor_equals ( rotary_pos_emb_old , rotary_pos_emb_new , \"rotary_pos_emb\" if verbose else None ) match_window = tensor_equals ( window_index_old , window_index_new , \"window_index\" if verbose else None ) match_cu_window = tensor_equals ( cu_window_seqlens_old , cu_window_seqlens_new , \"cu_window_seqlens\" if verbose else None ) match_cu_seq = tensor_equals ( cu_seqlens_old , cu_seqlens_new , \"cu_seqlens\" if verbose else None ) all_match = match_rotary and match_window and match_cu_window and match_cu_seq if verbose : print ( f\" \\n All outputs match: { all_match } \" ) if not all_match : error_msg = f\"Test failed for grid_thw= { grid_thw } : Outputs between old and new implementations do not match\" raise TestFailureException ( error_msg ) return all_match def run_mass_test ( t_range = ( 1 , 50 ), h_range = ( 1 , 250 ), w_range = ( 1 , 250 ), num_samples = 100 , max_images_per_sample = 1 , seed = 42 ): \"\"\" Run mass testing by sampling grid_thw configurations from the specified ranges. Args: t_range: Tuple of (min_t, max_t) h_range: Tuple of (min_h, max_h) w_range: Tuple of (min_w, max_w) num_samples: Number of random samples to test max_images_per_sample: Maximum number of images per sample seed: Random seed for reproducibility \"\"\" random . seed ( seed ) # Ensure minimum h and w values are at least 2 (spatial_merge_size) # This is required by the model architecture min_t = max ( 1 , t_range [ 0 ]) min_h = max ( 2 , h_range [ 0 ]) # Minimum must be at least spatial_merge_size min_w = max ( 2 , w_range [ 0 ]) # Minimum must be at least spatial_merge_size max_t = t_range [ 1 ] max_h = h_range [ 1 ] max_w = w_range [ 1 ] t_range = ( min_t , max_t ) h_range = ( min_h , max_h ) w_range = ( min_w , max_w ) print ( f\"Running mass testing with { num_samples } samples\" ) print ( f\"T range: { t_range } \" ) print ( f\"H range: { h_range } \" ) print ( f\"W range: { w_range } \" ) print ( f\"Max images per sample: { max_images_per_sample } \" ) # Include edge cases edge_cases = [ # Smallest valid values [[ min_t , min_h , min_w ]], # Largest values [[ max_t , max_h , max_w ]], # Min t, max h, w [[ min_t , max_h , max_w ]], # Max t, min h, w [[ max_t , min_h , min_w ]], # Mixed values [[ min_t , max_h , min_w ]],\n        [[ max_t , min_h , max_w ]], # Values divisible by window_size/spatial_merge_size/patch_size [[ min_t , 16 , 16 ]], # 16 = 32/2/1 (window_size/spatial_merge_size/1) [[ min_t , 32 , 32 ]], # 32 = 32/2/0.5 (window_size/spatial_merge_size/0.5) ] # Add multi-image edge cases if max_images_per_sample > 1 if max_images_per_sample > 1 : multi_image_edge_cases = [ # Multiple small images [[ min_t , min_h , min_w ], [ min_t , min_h , min_w ]], # One small, one large [[ min_t , min_h , min_w ], [ max_t , max_h , max_w ]], # Maximum number of images with varied sizes [[ min_t , min_h , min_w ]] * max_images_per_sample ,\n        ] edge_cases . extend ( multi_image_edge_cases ) # Test edge cases first print ( \" \\n Testing edge cases:\" ) for i , grid_thw in enumerate ( edge_cases ): try : print ( f\"Edge case { i + 1 } / { len ( edge_cases ) } : { grid_thw } \" ) run_test ( grid_thw , verbose = False ) print ( f\"âœ“ Edge case { i + 1 } passed\" ) except TestFailureException as e : print ( f\" \\n ERROR: { e } \" ) return False except Exception as e : print ( f\" \\n Unexpected error for grid_thw= { grid_thw } : { e } \" ) print ( f\"Exception details: { type ( e ). __name__ } : { e } \" ) return False # Generate random samples for the mass test samples = [] for _ in range ( num_samples ): # Decide how many images to include in this sample num_images = random . randint ( 1 , max_images_per_sample ) # Generate grid_thw for each image sample = [] for _ in range ( num_images ): t = random . randint ( min_t , max_t ) h = random . randint ( min_h , max_h ) w = random . randint ( min_h , max_w ) # Ensure h and w are multiples of spatial_merge_size (2) h = ( h // 2 ) * 2 w = ( w // 2 ) * 2 if h == 0 : h = 2 if w == 0 : w = 2 sample . append ([ t , h , w ]) samples . append ( sample ) # Run the mass test with a progress bar print ( f\" \\n Running { num_samples } random samples:\" ) progress_bar = tqdm . tqdm ( total = num_samples ) for i , grid_thw in enumerate ( samples ): try : run_test ( grid_thw , verbose = False ) progress_bar . update ( 1 ) except TestFailureException as e : progress_bar . close () print ( f\" \\n ERROR at sample { i + 1 } / { num_samples } : { e } \" ) return False except Exception as e : progress_bar . close () print ( f\" \\n Unexpected error at sample { i + 1 } / { num_samples } for grid_thw= { grid_thw } : { e } \" ) print ( f\"Exception details: { type ( e ). __name__ } : { e } \" ) return False progress_bar . close () print ( f\" \\n All { num_samples } samples passed successfully!\" ) return True if __name__ == \"__main__\" : parser = argparse . ArgumentParser ( description = 'Test Qwen2.5-VL Vision Transformer' ) parser . add_argument ( '--grid_t' , type = int , default = 1 , help = 'Grid size T' ) parser . add_argument ( '--grid_h' , type = int , default = 36 , help = 'Grid size H' ) parser . add_argument ( '--grid_w' , type = int , default = 36 , help = 'Grid size W' ) parser . add_argument ( '--multiple' , action = 'store_true' , help = 'Test with multiple images' ) parser . add_argument ( '--large' , action = 'store_true' , help = 'Test with many high-resolution images' ) parser . add_argument ( '--mass-test' , action = 'store_true' , help = 'Run mass testing with many grid configurations' ) parser . add_argument ( '--samples' , type = int , default = 100 , help = 'Number of samples for mass testing' ) parser . add_argument ( '--seed' , type = int , default = 42 , help = 'Random seed for mass testing' ) parser . add_argument ( '--max-t' , type = int , default = 50 , help = 'Maximum T value for mass testing' ) parser . add_argument ( '--max-h' , type = int , default = 250 , help = 'Maximum H value for mass testing' ) parser . add_argument ( '--max-w' , type = int , default = 250 , help = 'Maximum W value for mass testing' ) parser . add_argument ( '--max-images' , type = int , default = 1 , help = 'Maximum number of images per sample for mass testing' ) args = parser . parse_args () if args . mass_test : success = run_mass_test ( t_range = ( 1 , args . max_t ), h_range = ( 1 , args . max_h ), w_range = ( 1 , args . max_w ), num_samples = args . samples , max_images_per_sample = args . max_images , seed = args . seed ) sys . exit ( 0 if success else 1 ) else : if args . large : # Test with a large number of high-resolution images/videos grid_thw = [\n                [ 1 , 224 , 224 ], # High-res image 1 [ 1 , 112 , 112 ], # Medium-res image [ 4 , 96 , 96 ], # Video 1 [ 1 , 168 , 168 ], # Another image [ 2 , 128 , 224 ], # Video 2 [ 1 , 224 , 224 ], # High-res image 2 [ 3 , 64 , 128 ], # Video 3 [ 1 , 96 , 96 ], # Small image [ 6 , 64 , 64 ], # Longer video [ 1 , 192 , 192 ] # Another image ] print ( \"Testing with large dataset (many high-resolution images/videos)\" ) elif args . multiple : # Test with multiple images grid_thw = [\n                [ 1 , 36 , 36 ], # First image [ 2 , 48 , 64 ], # Second image (video) [ 1 , 24 , 24 ] # Third image ] print ( \"Testing with multiple images\" ) else : # Test with a single image grid_thw = [[ args . grid_t , args . grid_h , args . grid_w ]] try : # Run correctness test run_test ( grid_thw ) print ( \" \\n Test completed successfully!\" ) except TestFailureException as e : print ( f\" \\n ERROR: { e } \" ) sys . exit ( 1 ) # Exit with error code ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji â¤ï¸ 1 WoosukKwon reacted with heart emoji All reactions ðŸ‘ 1 reaction â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . zzzyq pushed a commit\n        to zzzyq/vllm\n      that referenced\n      this pull request May 24, 2025 [PERF] Speed up Qwen2.5-VL model by speed up rotary position embedding ( â€¦ 92d9cdb vllm-project#17973 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com> mergify bot added\n  the qwen Related to Qwen models label Jun 19, 2025 minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [PERF] Speed up Qwen2.5-VL model by speed up rotary position embedding ( â€¦ 65b6ec6 vllm-project#17973 )\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:07", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, lm_eval | PERF: req/s, optimization, optimization | SERVING: vllm serve, serve | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:51:07", "models": ["Qwen/Qwen2.5-7B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=Qwen/Qwen2.5-7B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model Qwen/Qwen2.5-7B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[PERF] Speed up Qwen2.5-VL model by speed up rotary position embedding (#17973)", "commit_message": "[PERF] Speed up Qwen2.5-VL model by speed up rotary position embedding (#17973)\n\nSigned-off-by: Vadim Gimpelson <vadim.gimpelson@centml.ai>", "commit_date": "2025-05-15T23:31:02-07:00", "files_changed": ["vllm/model_executor/models/qwen2_5_vl.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 7, "num_edited_lines": 204, "num_non_test_edited_lines": 204, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/models/qwen2_5_vl.py b/vllm/model_executor/models/qwen2_5_vl.py\nindex 5904ad1f1..68dd07820 100644\n--- a/vllm/model_executor/models/qwen2_5_vl.py\n+++ b/vllm/model_executor/models/qwen2_5_vl.py\n@@ -25,7 +25,7 @@\n # limitations under the License.\n \"\"\"Inference-only Qwen2.5-VL model compatible with HuggingFace weights.\"\"\"\n from collections.abc import Iterable, Mapping\n-from functools import partial\n+from functools import lru_cache, partial\n from typing import Callable, Literal, Optional, TypedDict, Union\n \n import torch\n@@ -478,8 +478,8 @@ class Qwen2_5_VisionRotaryEmbedding(nn.Module):\n         super().__init__()\n         self.dim = dim\n         self.theta = theta\n-        inv_freq = 1.0 / (theta\n-                          **(torch.arange(0, dim, 2, dtype=torch.float) / dim))\n+        inv_freq = 1.0 / (theta**(\n+            torch.arange(0, dim, 2, dtype=torch.float, device='cpu') / dim))\n         self.register_buffer(\"inv_freq\", inv_freq, persistent=False)\n         self._seq_len_cached = 0\n         self._freqs_cached = None\n@@ -520,7 +520,7 @@ class Qwen2_5_VisionTransformer(nn.Module):\n         self.hidden_size = vision_config.hidden_size\n         self.num_heads = vision_config.num_heads\n \n-        # args for get_window_index\n+        # args for get_window_index_thw\n         self.window_size = vision_config.window_size\n         self.patch_size = vision_config.patch_size\n         self.spatial_merge_size = vision_config.spatial_merge_size\n@@ -567,65 +567,71 @@ class Qwen2_5_VisionTransformer(nn.Module):\n     def device(self) -> torch.device:\n         return self.patch_embed.proj.weight.device\n \n-    def rot_pos_emb(self, grid_thw: torch.Tensor) -> torch.Tensor:\n-        pos_ids = []\n-        for t, h, w in grid_thw:\n-            hpos_ids = torch.arange(h).unsqueeze(1).expand(-1, w)\n-            wpos_ids = torch.arange(w).unsqueeze(0).expand(h, -1)\n-            hpos_ids = hpos_ids.reshape(\n-                h // self.spatial_merge_size,\n-                self.spatial_merge_size,\n-                w // self.spatial_merge_size,\n-                self.spatial_merge_size,\n-            ).permute(0, 2, 1, 3).flatten()\n-            wpos_ids = wpos_ids.reshape(\n-                h // self.spatial_merge_size,\n-                self.spatial_merge_size,\n-                w // self.spatial_merge_size,\n-                self.spatial_merge_size,\n-            ).permute(0, 2, 1, 3).flatten()\n-            pos_ids.append(\n-                torch.stack([hpos_ids, wpos_ids], dim=-1).repeat(t, 1))\n-        pos_ids = torch.cat(pos_ids, dim=0)\n-        max_grid_size = grid_thw[:, 1:].max()\n-        rotary_pos_emb_full = self.rotary_pos_emb(max_grid_size)\n+    def rotary_pos_emb_thw(self, t, h, w):\n+        hpos_ids = torch.arange(h).unsqueeze(1).expand(-1, w)\n+        wpos_ids = torch.arange(w).unsqueeze(0).expand(h, -1)\n+        hpos_ids = hpos_ids.reshape(\n+            h // self.spatial_merge_size,\n+            self.spatial_merge_size,\n+            w // self.spatial_merge_size,\n+            self.spatial_merge_size,\n+        ).permute(0, 2, 1, 3).flatten()\n+        wpos_ids = wpos_ids.reshape(\n+            h // self.spatial_merge_size,\n+            self.spatial_merge_size,\n+            w // self.spatial_merge_size,\n+            self.spatial_merge_size,\n+        ).permute(0, 2, 1, 3).flatten()\n+        pos_ids = torch.stack([hpos_ids, wpos_ids], dim=-1).repeat(t, 1)\n+        max_size = max(h, w)\n+        rotary_pos_emb_full = self.rotary_pos_emb(max_size)\n         rotary_pos_emb = rotary_pos_emb_full[pos_ids].flatten(1)\n+        rotary_pos_emb = rotary_pos_emb.reshape(\n+            rotary_pos_emb.shape[0] // self.spatial_merge_unit,\n+            self.spatial_merge_unit, -1)\n+\n         return rotary_pos_emb\n \n-    def get_window_index(self, grid_thw):\n-        window_index: list = []\n-        cu_window_seqlens: list = [0]\n-        window_index_id = 0\n+    def get_window_index_thw(self, grid_t, grid_h, grid_w):\n         vit_merger_window_size = (self.window_size //\n                                   self.spatial_merge_size // self.patch_size)\n \n-        for grid_t, grid_h, grid_w in grid_thw:\n-            llm_grid_h = grid_h // self.spatial_merge_size\n-            llm_grid_w = grid_w // self.spatial_merge_size\n-            index = torch.arange(grid_t * llm_grid_h * llm_grid_w).reshape(\n-                grid_t, llm_grid_h, llm_grid_w)\n-            pad_h = vit_merger_window_size - llm_grid_h % vit_merger_window_size\n-            pad_w = vit_merger_window_size - llm_grid_w % vit_merger_window_size\n-            num_windows_h = (llm_grid_h + pad_h) // vit_merger_window_size\n-            num_windows_w = (llm_grid_w + pad_w) // vit_merger_window_size\n-            index_padded = F.pad(index, (0, pad_w, 0, pad_h), 'constant', -100)\n-            index_padded = index_padded.reshape(grid_t, num_windows_h,\n-                                                vit_merger_window_size,\n-                                                num_windows_w,\n-                                                vit_merger_window_size)\n-            index_padded = index_padded.permute(0, 1, 3, 2, 4).reshape(\n-                grid_t, num_windows_h * num_windows_w, vit_merger_window_size,\n-                vit_merger_window_size)\n-            seqlens = (index_padded != -100).sum([2, 3]).reshape(-1)\n-            index_padded = index_padded.reshape(-1)\n-            index_new = index_padded[index_padded != -100]\n-            window_index.append(index_new + window_index_id)\n-            cu_seqlens_tmp = seqlens.cumsum(\n-                0) * self.spatial_merge_unit + cu_window_seqlens[-1]\n-            cu_window_seqlens.extend(cu_seqlens_tmp.tolist())\n-            window_index_id += (grid_t * llm_grid_h * llm_grid_w).item()\n-        window_index = torch.cat(window_index, dim=0)\n-        return window_index, cu_window_seqlens\n+        llm_grid_h = grid_h // self.spatial_merge_size\n+        llm_grid_w = grid_w // self.spatial_merge_size\n+        index = torch.arange(grid_t * llm_grid_h * llm_grid_w).reshape(\n+            grid_t, llm_grid_h, llm_grid_w)\n+        pad_h = vit_merger_window_size - llm_grid_h % vit_merger_window_size\n+        pad_w = vit_merger_window_size - llm_grid_w % vit_merger_window_size\n+        num_windows_h = (llm_grid_h + pad_h) // vit_merger_window_size\n+        num_windows_w = (llm_grid_w + pad_w) // vit_merger_window_size\n+        index_padded = F.pad(index, (0, pad_w, 0, pad_h), 'constant', -100)\n+        index_padded = index_padded.reshape(grid_t, num_windows_h,\n+                                            vit_merger_window_size,\n+                                            num_windows_w,\n+                                            vit_merger_window_size)\n+        index_padded = index_padded.permute(0, 1, 3, 2, 4).reshape(\n+            grid_t, num_windows_h * num_windows_w, vit_merger_window_size,\n+            vit_merger_window_size)\n+        seqlens = (index_padded != -100).sum([2, 3]).reshape(-1)\n+        index_padded = index_padded.reshape(-1)\n+        index_new = index_padded[index_padded != -100]\n+        cu_seqlens_tmp = seqlens.cumsum(0) * self.spatial_merge_unit\n+        cu_seqlens_tmp = cu_seqlens_tmp.to(dtype=torch.int32)\n+        cu_seqlens_tmp = torch.unique_consecutive(cu_seqlens_tmp)\n+\n+        return index_new, cu_seqlens_tmp\n+\n+    @lru_cache(maxsize=1024)  # noqa: B019\n+    def get_rope_by_thw(self, t, h, w):\n+        window_index_thw, cu_seqlens_window_thw = self.get_window_index_thw(\n+            t, h, w)\n+        rotary_pos_emb_thw = self.rotary_pos_emb_thw(t, h, w)\n+        rotary_pos_emb_thw = rotary_pos_emb_thw[window_index_thw, :, :]\n+        rotary_pos_emb_thw = rotary_pos_emb_thw.flatten(start_dim=0, end_dim=1)\n+        cu_seqlens_thw = torch.repeat_interleave(\n+            torch.tensor([h * w], dtype=torch.int32), t)\n+        return (rotary_pos_emb_thw, window_index_thw, cu_seqlens_window_thw,\n+                cu_seqlens_thw)\n \n     def compute_attn_mask_seqlen(\n         self,\n@@ -641,45 +647,74 @@ class Qwen2_5_VisionTransformer(nn.Module):\n     def forward(\n         self,\n         x: torch.Tensor,\n-        grid_thw: torch.Tensor,\n+        grid_thw: list[list[int]],\n     ) -> torch.Tensor:\n         # patchify\n+        seq_len, _ = x.size()\n+        rotary_pos_emb = []\n+        window_index: list = []\n+        cu_window_seqlens: list = [torch.tensor([0], dtype=torch.int32)]\n+        cu_seqlens: list = []\n+\n         hidden_states = x.to(device=self.device, dtype=self.dtype)\n         hidden_states = self.patch_embed(hidden_states)\n \n-        # compute position embedding\n-        rotary_pos_emb = self.rot_pos_emb(grid_thw)\n+        window_index_id = 0\n+        cu_window_seqlens_last = 0\n+        for t, h, w in grid_thw:\n+            t, h, w = int(t), int(h), int(w)\n+            llm_h = h // self.spatial_merge_size\n+            llm_w = w // self.spatial_merge_size\n+\n+            (\n+                rotary_pos_emb_thw,\n+                window_index_thw,\n+                cu_seqlens_window_thw,\n+                cu_seqlens_thw,\n+            ) = self.get_rope_by_thw(t, h, w)\n+\n+            window_index.append(window_index_thw + window_index_id)\n+            window_index_id += (t * llm_h * llm_w)\n+\n+            cu_seqlens_window_thw = (cu_seqlens_window_thw +\n+                                     cu_window_seqlens_last)\n+            cu_window_seqlens_last = cu_seqlens_window_thw[-1]\n+            cu_window_seqlens.append(cu_seqlens_window_thw)\n \n-        # windows attention\n-        window_index, cu_window_seqlens = self.get_window_index(grid_thw)\n-        cu_window_seqlens = torch.tensor(\n-            cu_window_seqlens,\n-            device=hidden_states.device,\n-            dtype=grid_thw.dtype if torch.jit.is_tracing() else torch.int32)\n+            rotary_pos_emb.append(rotary_pos_emb_thw)\n+\n+            cu_seqlens.append(cu_seqlens_thw)\n+\n+        rotary_pos_emb = torch.cat(rotary_pos_emb)\n+        window_index = torch.cat(window_index)\n+        cu_window_seqlens = torch.cat(cu_window_seqlens)\n         cu_window_seqlens = torch.unique_consecutive(cu_window_seqlens)\n-        seq_len, _ = hidden_states.size()\n-        hidden_states = hidden_states.reshape(\n-            seq_len // self.spatial_merge_unit, self.spatial_merge_unit, -1)\n-        hidden_states = hidden_states[window_index, :, :]\n-        hidden_states = hidden_states.reshape(seq_len, -1)\n-        rotary_pos_emb = rotary_pos_emb.reshape(\n-            seq_len // self.spatial_merge_unit, self.spatial_merge_unit, -1)\n-        rotary_pos_emb = rotary_pos_emb[window_index, :, :]\n-        rotary_pos_emb = rotary_pos_emb.reshape(seq_len, -1)\n-        # compute cu_seqlens\n-        cu_seqlens = torch.repeat_interleave(grid_thw[:, 1] * grid_thw[:, 2],\n-                                             grid_thw[:, 0]).cumsum(\n-                                                 dim=0, dtype=torch.int32)\n+        cu_seqlens = torch.cat(cu_seqlens)\n+        cu_seqlens = torch.cumsum(cu_seqlens, dim=0, dtype=torch.int32)\n         cu_seqlens = F.pad(cu_seqlens, (1, 0), \"constant\", 0)\n \n         # transformers\n-        hidden_states = hidden_states.unsqueeze(1)\n-\n         # pre-compute seqlens for window/full attn to reduce cuMemcpy operations\n         max_seqlen_full, seqlens_full = self.compute_attn_mask_seqlen(\n             cu_seqlens)\n         max_seqlen_window, seqlens_window = self.compute_attn_mask_seqlen(\n             cu_window_seqlens)\n+\n+        cu_seqlens = cu_seqlens.to(device=self.device, non_blocking=True)\n+        cu_window_seqlens = cu_window_seqlens.to(device=self.device,\n+                                                 non_blocking=True)\n+        rotary_pos_emb = rotary_pos_emb.to(device=self.device,\n+                                           non_blocking=True)\n+        window_index = window_index.to(device=hidden_states.device,\n+                                       non_blocking=True)\n+\n+        hidden_states = hidden_states.reshape(\n+            seq_len // self.spatial_merge_unit, self.spatial_merge_unit, -1)\n+        hidden_states = hidden_states[window_index, :, :]\n+        hidden_states = hidden_states.reshape(seq_len, -1)\n+\n+        hidden_states = hidden_states.unsqueeze(1)\n+\n         for layer_num, blk in enumerate(self.blocks):\n             if layer_num in self.fullatt_block_indexes:\n                 cu_seqlens_now = cu_seqlens\n@@ -932,12 +967,13 @@ class Qwen2_5_VLForConditionalGeneration(nn.Module, SupportsMultiModal,\n \n         grid_thw = image_input[\"image_grid_thw\"]\n         assert grid_thw.ndim == 2\n+        grid_thw_list = grid_thw.tolist()\n \n         if image_input[\"type\"] == \"image_embeds\":\n             image_embeds = image_input[\"image_embeds\"].type(self.visual.dtype)\n         else:\n             pixel_values = image_input[\"pixel_values\"].type(self.visual.dtype)\n-            image_embeds = self.visual(pixel_values, grid_thw=grid_thw)\n+            image_embeds = self.visual(pixel_values, grid_thw=grid_thw_list)\n \n         # Split concatenated embeddings for each image item.\n         merge_size = self.visual.spatial_merge_size\n@@ -951,13 +987,15 @@ class Qwen2_5_VLForConditionalGeneration(nn.Module, SupportsMultiModal,\n \n         grid_thw = video_input[\"video_grid_thw\"]\n         assert grid_thw.ndim == 2\n+        grid_thw_list = grid_thw.tolist()\n \n         if video_input[\"type\"] == \"video_embeds\":\n             video_embeds = video_input[\"video_embeds\"].type(self.visual.dtype)\n         else:\n             pixel_values_videos = video_input[\"pixel_values_videos\"].type(\n                 self.visual.dtype)\n-            video_embeds = self.visual(pixel_values_videos, grid_thw=grid_thw)\n+            video_embeds = self.visual(pixel_values_videos,\n+                                       grid_thw=grid_thw_list)\n \n         # Split concatenated embeddings for each video item.\n         merge_size = self.visual.spatial_merge_size", "apis": ["Qwen2_5_VisionTransformer.forward", "Qwen2_5_VisionTransformer.get_window_index_thw", "Qwen2_5_VisionTransformer.get_rope_by_thw", "Qwen2_5_VLForConditionalGeneration.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/qwen2_5_vl.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file and makes non-trivial changes to the computation of rotary position embeddings, window indexing, and sequence length handling. It introduces caching via lru_cache and restructures the functions to streamline and speed up these computations, which directly impacts the performance of the model's inference. The improvements target CPU-based operations and are not just refactoring or bug fixes; they optimize the performance of a high-level API in the model. Therefore, the commit satisfies the conditions for being performance or optimization related.", "llm_api_reason": "This commit refactors the rotary position embedding functionality for the Qwen2.5-VL model. It replaces the old â€œrot_pos_embâ€ function with a new â€œrotary_pos_emb_thwâ€ method, renames and revises â€œget_window_indexâ€ to â€œget_window_index_thwâ€, and introduces a cached â€œget_rope_by_thwâ€ to precompute rotary embeddings. The forward pass in the vision transformer is adjusted to expect grid parameters as a list (improving both performance and clarity), and the multimodal generation routine now passes these grid lists to the visual encoder. Overall, the changes aim to speed up inference while ensuring correct positional embedding computation for image/video inputs."}
{"commit_hash": "015069b01741e9ecb9e604c7fe87fbdfc306ebe5", "pr_url": "https://github.com/vllm-project/vllm/pull/17515", "pr_date": "2025-05-01", "timeline_text": "Copy link Contributor chaunceyjiang commented May 1, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . FIX #17369 (comment) Use string partition instead of regex Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [Misc]: Optimize the Qwen3_ReasoningParser extract_reasoning_content â€¦ 493c2a8 Signed-off-by: chaunceyjiang <chaunceyjiang@gmail.com> Copy link github-actions bot commented May 1, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . chaunceyjiang changed the title [Misc]: Optimize the Qwen3_ReasoningParser extract_reasoning_content [Misc] Optimize the Qwen3_ReasoningParser extract_reasoning_content May 1, 2025 Copy link Contributor Author chaunceyjiang commented May 1, 2025 /cc @gaocegege PTAL. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gaocegege reviewed May 1, 2025 View reviewed changes Copy link Contributor gaocegege left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment We could remove self.reasoning_regex Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [Misc]: Optimize the Qwen3_ReasoningParser extract_reasoning_content â€¦ d165310 Signed-off-by: chaunceyjiang <chaunceyjiang@gmail.com> Copy link Contributor Author chaunceyjiang commented May 1, 2025 We could remove self.reasoning_regex Done. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . gaocegege approved these changes May 1, 2025 View reviewed changes Copy link Contributor Author chaunceyjiang commented May 1, 2025 /cc @DarkLight1337 PTAL. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . DarkLight1337 approved these changes May 1, 2025 View reviewed changes Hide details View details vllm-bot merged commit 015069b into vllm-project : main May 1, 2025 20 of 21 checks passed Uh oh! There was an error while loading. Please reload this page . chaunceyjiang deleted the qwen3_opttimize branch May 1, 2025 10:41 radeksm pushed a commit\n        to radeksm/vllm\n      that referenced\n      this pull request May 2, 2025 [Misc] Optimize the Qwen3_ReasoningParser extract_reasoning_content ( vâ€¦ â€¦ 2429b35 â€¦llm-project#17515 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [Misc] Optimize the Qwen3_ReasoningParser extract_reasoning_content ( vâ€¦ â€¦ 69172c0 â€¦llm-project#17515 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> zzzyq pushed a commit\n        to zzzyq/vllm\n      that referenced\n      this pull request May 24, 2025 [Misc] Optimize the Qwen3_ReasoningParser extract_reasoning_content ( vâ€¦ â€¦ c15fd57 â€¦llm-project#17515 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: Yuqi Zhang <yuqizhang@google.com> minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [Misc] Optimize the Qwen3_ReasoningParser extract_reasoning_content ( vâ€¦ â€¦ 2891c03 â€¦llm-project#17515 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:10", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:51:10", "models": ["Qwen/Qwen3-7B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=Qwen/Qwen3-7B-Instruct --tasks gsm8k --batch_size 8"], "perf_command": "python benchmarks/benchmark_serving.py --model Qwen/Qwen3-7B-Instruct --dataset-name sharegpt --request-rate 1", "commit_subject": "[Misc] Optimize the Qwen3_ReasoningParser extract_reasoning_content (#17515)", "commit_message": "[Misc] Optimize the Qwen3_ReasoningParser extract_reasoning_content (#17515)\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>", "commit_date": "2025-05-01T03:29:01-07:00", "files_changed": ["vllm/reasoning/qwen3_reasoning_parser.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 53, "num_non_test_edited_lines": 53, "commit_year": 2025}, "diff_text": "diff --git a/vllm/reasoning/qwen3_reasoning_parser.py b/vllm/reasoning/qwen3_reasoning_parser.py\nindex f588f4016..7095034b1 100644\n--- a/vllm/reasoning/qwen3_reasoning_parser.py\n+++ b/vllm/reasoning/qwen3_reasoning_parser.py\n@@ -1,6 +1,5 @@\n # SPDX-License-Identifier: Apache-2.0\n \n-import re\n from collections.abc import Sequence\n from typing import Optional, Union\n \n@@ -31,9 +30,6 @@ class Qwen3ReasoningParser(ReasoningParser):\n         self.think_start_token = \"<think>\"\n         self.think_end_token = \"</think>\"\n \n-        self.reasoning_regex = re.compile(\n-            rf\"{self.think_start_token}(.*?){self.think_end_token}\", re.DOTALL)\n-\n         if not self.model_tokenizer:\n             raise ValueError(\n                 \"The model tokenizer must be passed to the ReasoningParser \"\n@@ -121,29 +117,34 @@ class Qwen3ReasoningParser(ReasoningParser):\n     def extract_reasoning_content(\n             self, model_output: str, request: ChatCompletionRequest\n     ) -> tuple[Optional[str], Optional[str]]:\n+        \"\"\"\n+        Extract reasoning content from the model output.\n+\n+        For text <think>abc</think>xyz:\n+        - 'abc' goes to reasoning_content\n+        - 'xyz' goes to content\n \n-        # Check if the model output contains the <think> tokens.\n+        Returns:\n+            tuple[Optional[str], Optional[str]]: reasoning content and content\n+        \"\"\"\n+\n+        # Check if the model output contains the <think> and </think> tokens.\n         if (self.think_start_token not in model_output\n                 or self.think_end_token not in model_output):\n             return None, model_output\n-        else:\n-            # Use a regex to find the reasoning content\n-            reasoning_content = self.reasoning_regex.findall(model_output)[0]\n-\n-            # Remove the reasoning content from the model output\n-            # Although <think> token is always at the\n-            # beginning of the line, we cannot guarantee that the\n-            # other models will follow this convention.\n-            # Therefore, we need to add :start_index.\n-            start_index = model_output.find(self.think_start_token)\n-            if start_index != -1:\n-                end_index = start_index + len(\n-                    f\"{self.think_start_token}{reasoning_content}{self.think_end_token}\"\n-                )\n-                model_output = model_output[:start_index] + \\\n-                                model_output[end_index:]\n-\n-                if len(model_output) == 0:\n-                    return reasoning_content, None\n-\n-            return reasoning_content, model_output\n+        # Check if the <think> is present in the model output, remove it\n+        # if it is present.\n+        model_output_parts = model_output.partition(self.think_start_token)\n+        model_output = model_output_parts[2] if model_output_parts[\n+            1] else model_output_parts[0]\n+        # Check if the model output contains the </think> tokens.\n+        # If the end token is not found, return the model output as is.\n+        if self.think_end_token not in model_output:\n+            return None, model_output\n+\n+        # Extract reasoning content from the model output.\n+        reasoning_content, _, content = model_output.partition(\n+            self.think_end_token)\n+\n+        final_content = content or None\n+        return reasoning_content, final_content", "apis": ["Qwen3ReasoningParser.extract_reasoning_content"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/reasoning/qwen3_reasoning_parser.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/online_serving/openai_chat_completion_with_reasoning.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/online_serving/openai_chat_completion_with_reasoning_streaming.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a core (non-test) source file by changing the implementation of the extract_reasoning_content function in the Qwen3ReasoningParser. The changes remove the use of regular expressions (which can be computationally heavier) and instead leverage string partitioning to extract content, which is typically more efficient. This alteration is intended to optimize the performance of the reasoning extraction process, satisfying the criteria for performance optimization (CPU-based and amenable to testing without specialized hardware) without being merely a trivial refactor or documentation fix.", "llm_api_reason": "The commit removes the regex-based extraction logic from the extract_reasoning_content method of the Qwen3ReasoningParser class, optimizing how reasoning content is parsed from the modelâ€™s output by using string partitioning instead. This update improves performance while maintaining the same API interface."}
{"commit_hash": "bc7c4d206bbfb56b06d218b6c2971e8ca191db36", "pr_url": "https://github.com/vllm-project/vllm/pull/13305", "pr_date": "2025-04-23", "timeline_text": "Copy link Contributor maleksan85 commented Feb 14, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Speed up prefix prefill with vLLM V1 on AMG GPUs Improvements: Vectorization in the context loop (most complex one as k cache shape is very specific) Refactoring for online softmax computation Refactoring to the kernel so autotune might select the best configs per shape Plus adding new spectrum of unrolling/staging in autotuner More details on triton kernel tunning: https://rocm.docs.amd.com/en/docs-6.1.1/how-to/llm-fine-tuning-optimization/optimizing-triton-kernel.html see last comments Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions SageMoore added 30 commits February 5, 2025 20:42 init â€¦ b6b00d7 Signed-off-by: Sage Moore <sage@neuralmagic.com> temporarily remove torch from requirements-build â€¦ fa52268 Signed-off-by: Sage Moore <sage@neuralmagic.com> move rocm logic to its own attention backend â€¦ f563276 Signed-off-by: Sage Moore <sage@neuralmagic.com> actually add backend â€¦ 2a03b92 Signed-off-by: Sage Moore <sage@neuralmagic.com> more rocm refactoring â€¦ 4bdf7de Signed-off-by: Sage Moore <sage@neuralmagic.com> Merge branch 'main' of https://github.com/neuralmagic/vllm into sage/â€¦ â€¦ 875fcfc â€¦amd-v1 more rocm refactoring â€¦ e507e30 Signed-off-by: Sage Moore <sage@neuralmagic.com> hack to fix the multiprocessing isssue â€¦ b9ce259 Signed-off-by: Sage Moore <sage@neuralmagic.com> minor print fix â€¦ f2cc5e3 Signed-off-by: Sage Moore <sage@neuralmagic.com> remove cruft â€¦ d6f6c5c Signed-off-by: Sage Moore <sage@neuralmagic.com> format â€¦ 2bf214a Signed-off-by: Sage Moore <sage@neuralmagic.com> modify requirements files â€¦ 11411cb Signed-off-by: Sage Moore <sage@neuralmagic.com> remove basic.py changes â€¦ c2499bf Signed-off-by: Sage Moore <sage@neuralmagic.com> cleanup â€¦ cf6f691 Signed-off-by: Sage Moore <sage@neuralmagic.com> add support for passing in softmax scales to the context_attn_fwd â€¦ 4505f53 Signed-off-by: Sage Moore <sage@neuralmagic.com> Merge branch 'main' of https://github.com/neuralmagic/vllm into sage/â€¦ â€¦ 9a0416a â€¦amd-v1 added requirements-rocm-build â€¦ ef9ae86 Signed-off-by: Sage Moore <sage@neuralmagic.com> Merge branch 'main' of https://github.com/neuralmagic/vllm into sage/â€¦ â€¦ 0ccef65 â€¦amd-v1 minor setup.py fix â€¦ a00a2d9 Signed-off-by: Sage Moore <sage@neuralmagic.com> add batch size back in â€¦ afb15f5 Signed-off-by: Sage Moore <sage@neuralmagic.com> revert setup.py change â€¦ 08a25b7 Signed-off-by: Sage Moore <sage@neuralmagic.com> update setup.py â€¦ 55eb036 Signed-off-by: Sage Moore <sage@neuralmagic.com> init â€¦ 95df571 Signed-off-by: Sage Moore <sage@neuralmagic.com> init â€¦ 0bfe435 Signed-off-by: Sage Moore <sage@neuralmagic.com> Merge branch 'main' of https://github.com/neuralmagic/vllm into sage/â€¦ â€¦ 4b62de2 â€¦amd-v1\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com> minor fix â€¦ d2f3c85 Signed-off-by: Sage Moore <sage@neuralmagic.com> Merge branch 'main' of https://github.com/neuralmagic/vllm into sage/â€¦ â€¦ 442bc7b â€¦amd-v1 minor fix â€¦ 9472636 Signed-off-by: Sage Moore <sage@neuralmagic.com> Merge branch 'main' of https://github.com/neuralmagic/vllm into sage/â€¦ â€¦ c7497f3 â€¦prefix-prefill-refactor update error messages â€¦ 21d8d6a Signed-off-by: Sage Moore <sage@neuralmagic.com> 83 hidden items Load moreâ€¦ Copy link Contributor Author maleksan85 commented Apr 8, 2025 HIP_VISIBLE_DEVICES=6 VLLM_ENABLE_V1_MULTIPROCESSING=0 VLLM_USE_V1=1 lm_eval --model vllm --model_args pretrained=/data/models/Llama-3.1-8B-Instruct --tasks gsm8k --num_fewshot 5 --batch_size auto -\n-limit 500 2025-04-08:18:10:02,846 INFO     [lm_eval.loggers.evaluation_tracker:272] Output path not provided, skipping saving results aggregated vllm (pretrained=/data/models/Llama-3.1-8B-Instruct), gen_kwargs: (None), limit: 500.0, num_fewshot: 5, batch_size: auto Tasks Version Filter n-shot Metric Value Stderr gsm8k 3 flexible-extract 5 exact_match â†‘ 0.808 Â± 0.0176 strict-match 5 exact_match â†‘ 0.782 Â± 0.0185 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author maleksan85 commented Apr 8, 2025 python3 benchmarks/benchmark_serving.py --backend vllm --model /data/models/Llama-3.1-70B-Instruct --dataset-name random --random-input-len 10000 --random-output-len 100 --num-prompts 300 --seed 42 --ignore-eos --percentile-metrics \"ttft,tpot,itl,e2el\" PR (like 20% gain) ============ Serving Benchmark Result ============\nSuccessful requests:                     300\nBenchmark duration (s):                  409.78\nTotal input tokens:                      3000000\nTotal generated tokens:                  30000\nRequest throughput (req/s):              0.73\nOutput token throughput (tok/s):         73.21\nTotal Token throughput (tok/s):          7394.28\n---------------Time to First Token----------------\nMean TTFT (ms):                          205042.73\nMedian TTFT (ms):                        203406.19\nP99 TTFT (ms):                           400609.81\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          1610.15\nMedian TPOT (ms):                        2027.83\nP99 TPOT (ms):                           2239.19\n---------------Inter-token Latency----------------\nMean ITL (ms):                           1610.15\nMedian ITL (ms):                         80.56\nP99 ITL (ms):                            5252.32\n----------------End-to-end Latency----------------\nMean E2EL (ms):                          364447.21\nMedian E2EL (ms):                        404161.34\nP99 E2EL (ms):                           409588.24\n================================================== Upstream ============ Serving Benchmark Result ============\nSuccessful requests:                     300\nBenchmark duration (s):                  498.15\nTotal input tokens:                      3000000\nTotal generated tokens:                  30000\nRequest throughput (req/s):              0.60\nOutput token throughput (tok/s):         60.22\nTotal Token throughput (tok/s):          6082.51\n---------------Time to First Token----------------\nMean TTFT (ms):                          249095.71\nMedian TTFT (ms):                        248711.87\nP99 TTFT (ms):                           488484.85\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          1957.47\nMedian TPOT (ms):                        2462.50\nP99 TPOT (ms):                           2732.60\n---------------Inter-token Latency----------------\nMean ITL (ms):                           1957.47\nMedian ITL (ms):                         80.32\nP99 ITL (ms):                            8005.81\n----------------End-to-end Latency----------------\nMean E2EL (ms):                          442885.68\nMedian E2EL (ms):                        492500.58\nP99 E2EL (ms):                           497952.19\n================================================== All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author maleksan85 commented Apr 8, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . python3 benchmarks/benchmark_serving.py --backend vllm --model /data/models/Llama-3.1-70B-Instruct --dataset-name random --random-input-len 5000 --random-output-len 100 --num-prompts 500 --seed 42 --ignore-eos --percentile-metrics \"ttft,tpot,itl,e2el\" PR (10% gain) ============ Serving Benchmark Result ============\nSuccessful requests:                     500\nBenchmark duration (s):                  319.37\nTotal input tokens:                      2500000\nTotal generated tokens:                  50000\nRequest throughput (req/s):              1.57\nOutput token throughput (tok/s):         156.56\nTotal Token throughput (tok/s):          7984.50\n---------------Time to First Token----------------\nMean TTFT (ms):                          155485.39\nMedian TTFT (ms):                        149836.40\nP99 TTFT (ms):                           310684.27\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          1219.18\nMedian TPOT (ms):                        1556.81\nP99 TPOT (ms):                           1629.28\n---------------Inter-token Latency----------------\nMean ITL (ms):                           1219.18\nMedian ITL (ms):                         77.67\nP99 ITL (ms):                            4265.61\n----------------End-to-end Latency----------------\nMean E2EL (ms):                          276184.44\nMedian E2EL (ms):                        310784.82\nP99 E2EL (ms):                           319205.24\n================================================== Upstream ============ Serving Benchmark Result ============\nSuccessful requests:                     500\nBenchmark duration (s):                  355.99\nTotal input tokens:                      2500000\nTotal generated tokens:                  50000\nRequest throughput (req/s):              1.40\nOutput token throughput (tok/s):         140.45\nTotal Token throughput (tok/s):          7163.04\n---------------Time to First Token----------------\nMean TTFT (ms):                          172121.19\nMedian TTFT (ms):                        162339.60\nP99 TTFT (ms):                           349045.74\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          1369.76\nMedian TPOT (ms):                        1699.35\nP99 TPOT (ms):                           1892.04\n---------------Inter-token Latency----------------\nMean ITL (ms):                           1369.76\nMedian ITL (ms):                         78.00\nP99 ITL (ms):                            6167.44\n----------------End-to-end Latency----------------\nMean E2EL (ms):                          307727.51\nMedian E2EL (ms):                        349138.54\nP99 E2EL (ms):                           355831.83\n================================================== All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . root and others added 9 commits April 9, 2025 03:54 renaming kernel â€¦ 5d9a929 Signed-off-by: root <root@banff-cyxtera-s65-4.amd.com>\n\nSigned-off-by:  <> clean up and fix for failed kernel tests â€¦ 27f044b Signed-off-by: Aleksandr Malyshev <maleksan@amd.com> clean up and fix for failed kernel tests â€¦ cfd60c9 Signed-off-by: Aleksandr Malyshev <maleksan@amd.com> clean up and fix for failed kernel tests â€¦ 0a26697 Signed-off-by: Aleksandr Malyshev <maleksan@amd.com> got rid of autotuner and get stable runs right from the first iteration â€¦ 35a6e49 Signed-off-by: maleksan85 <maleksan@amd.com> restoring paged attn as there is no autotuning anymore and that will â€¦ â€¦ 6d5b3f2 â€¦no be error during start\n\nSigned-off-by: maleksan85 <maleksan@amd.com> poking test rerun as one failed and seems not because of this change â€¦ 7140d1a Signed-off-by: maleksan85 <maleksan@amd.com> Merge branch 'main' of github.com:vllm-project/vllm into upstream_preâ€¦ â€¦ 169f714 â€¦fix_prefill_speed_up Merge branch 'upstream/main' into upstream_prefix_prefill_speed_up f437b11 SageMoore reviewed Apr 14, 2025 View reviewed changes Copy link Contributor SageMoore left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks reasonable. Just a few nits. Thanks for all of the hard work making this kernel faster. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 maleksan85 reacted with heart emoji All reactions â¤ï¸ 1 reaction vllm/attention/ops/prefix_prefill.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/attention/ops/prefix_prefill.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . maleksan85 added 4 commits April 14, 2025 22:43 comment correction â€¦ ba078b6 Signed-off-by: maleksan85 <maleksan@amd.com> dot operation in triton doesn't support k to be 8 so increasing blockâ€¦ â€¦ 617ef08 â€¦ size to most commonly used\n\nSigned-off-by: maleksan85 <maleksan@amd.com> to kick CIs again Async Engine, Inputs, Utils, Worker Test seems flaky â€¦ 771ad9e Signed-off-by: maleksan85 <maleksan@amd.com> to kick CIs again â€¦ b6bf365 Signed-off-by: maleksan85 <maleksan@amd.com> bringlein mentioned this pull request Apr 16, 2025 [Kernel] Adding basic Triton JitCache for triton_attn #16606 Open Hide details View details vllm-bot merged commit bc7c4d2 into vllm-project : main Apr 23, 2025 41 of 46 checks passed Uh oh! There was an error while loading. Please reload this page . frieda-huang pushed a commit\n        to frieda-huang/vllm\n      that referenced\n      this pull request Apr 23, 2025 [Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 ( vllm-proâ€¦ â€¦ 5b0368a â€¦ject#13305 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: Frieda (Jingying) Huang <jingyingfhuang@gmail.com> gshtras added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Apr 25, 2025 Upstream merge 2025 04 25 ( #524 ) â€¦ 28007b0 * [BugFix] Remove default multiproc executor `collective_rpc` timeout ( vllm-project#17000 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [Core][V1][TPU] Enable structured decoding on TPU V1 ( vllm-project#16499 )\n\nSigned-off-by: Chenyaaang <chenyangli@google.com>\n\n* [Bugfix] validate urls object for multimodal content parts ( vllm-project#16990 )\n\nSigned-off-by: Guillaume Calmettes <gcalmettes@scaleway.com>\n\n* add Dockerfile build vllm against torch nightly ( vllm-project#16936 )\n\nSigned-off-by: Yang Wang <elainewy@meta.com>\n\n* [Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 ( vllm-project#13305 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com>\n\n* [V1][DP] More robust DP/EP dummy request coordination ( vllm-project#16277 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [BugFix] Revert ROCm Custom Paged Attention Env Flag Check ( vllm-project#17022 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* Revert \"[Misc] Add S3 environment variables for better support of MinIO.\" ( vllm-project#17021 )\n\n* [misc] tune some env vars for GB200 ( vllm-project#16992 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [INTEL-HPU][v0] Port delayed sampling to upstream ( vllm-project#16949 )\n\nSigned-off-by: Michal Adamczyk <michal.adamczyk@intel.com>\nSigned-off-by: Chendi Xue <chendi.xue@intel.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\n\n* [doc] add download path tips ( vllm-project#17013 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [Bugfix] Triton FA function takes no keyword arguments ( vllm-project#16902 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n* [V1] Avoid socket errors during shutdown when requests are in in-flight ( vllm-project#16807 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [BugFix] llama4 fa3 fix - RuntimeError: scheduler_metadata must have shape (metadata_size) ( vllm-project#16998 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Misc] Improve readability of get_open_port function. ( vllm-project#17024 )\n\nSigned-off-by: gitover22 <qidizou88@gmail.com>\n\n* [Bugfix] Fix AssertionError: skip_special_tokens=False is not supported for Mistral tokenizers ( vllm-project#16964 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [CI] Run v1/test_serial_utils.py in CI ( vllm-project#16996 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Mistral-format support for compressed-tensors ( vllm-project#16803 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* Categorize `tests/kernels/` based on kernel type ( vllm-project#16799 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Doc] Add top anchor and a note to quantization/bitblas.md ( vllm-project#17042 )\n\nSigned-off-by: windsonsea <haifeng.yao@daocloud.io>\n\n* Ensure that `pid` passed to `kill_process_tree` is `int` for `mypy` ( vllm-project#17051 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI] Update structured-output label automation ( vllm-project#17055 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Improve Transformers backend model loading QoL ( vllm-project#17039 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* `CacheConfig.block_size` should always be `int` when used ( vllm-project#17052 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Use `@property` and private field for `data_parallel_rank_local` ( vllm-project#17053 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] Support guidance:no-additional-properties for compatibility with xgrammar ( vllm-project#15949 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\n\n* [BugFix][V1] Fix int32 token index overflow when preparing input ids ( vllm-project#16806 )\n\n* [V1][Spec Decode] Always use argmax for sampling draft tokens  ( vllm-project#16899 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [CI/Build] workaround for CI build failure ( vllm-project#17070 )\n\nSigned-off-by: csy1204 <josang1204@gmail.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\n\n* [Quantization]add prefix for commandA quantized model ( vllm-project#17017 )\n\n* [Minor] Use larger batch sizes for A100/B100/B200/MI300x ( vllm-project#17073 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Enable V1 usage stats ( vllm-project#16986 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* More informative error when using Transformers backend ( vllm-project#16988 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Addendum Fix to support FIPS enabled machines with MD5 hashing ( vllm-project#17043 )\n\nSigned-off-by: sydarb <areebsyed237@gmail.com>\n\n* [Bugfix][Core] add seq_id_to_seq_group clearing to avoid memory leak when sâ€¦ ( vllm-project#16472 )\n\nSigned-off-by: å¼€å“² <kaizhe.zy@alibaba-inc.com>\nCo-authored-by: å¼€å“² <kaizhe.zy@alibaba-inc.com>\n\n* [V1] Update structured output ( vllm-project#16812 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [doc] update to hyperlink ( vllm-project#17096 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* Add docs for runai_streamer_sharded ( vllm-project#17093 )\n\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [Chore] Remove Sampler from Model Code ( vllm-project#17084 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* Disable enforce_eager for V1 TPU sampler and structured output tests ( vllm-project#17016 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* Simplify `TokenizerGroup` ( vllm-project#16790 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Fix OOT registration test ( vllm-project#17099 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][PP] Optimization: continue scheduling prefill chunks ( vllm-project#17080 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [Misc] Remove OLMo2 config copy ( vllm-project#17066 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Improve static type checking in `LoRAModelRunnerMixin` ( vllm-project#17104 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][Structured Output] Clear xgrammar compiler object when engine core shut down to avoid nanobind leaked warning ( vllm-project#16954 )\n\nSigned-off-by: shen-shanshan <467638484@qq.com>\n\n* [Frontend] Using matryoshka_dimensions control the allowed output dimensions. ( vllm-project#16970 )\n\n* Add missing rocm_skinny_gemms kernel test to CI ( vllm-project#17060 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Misc] refactor example series - structured outputs ( vllm-project#17040 )\n\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\n\n* [V1][Spec Decoding] Add num_drafts and num_accepted_tokens_per_position metrics ( vllm-project#16665 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [CI] Add automation for the `tool-calling` github label ( vllm-project#17118 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Updating builkite job for IBM Power  ( vllm-project#17111 )\n\nSigned-off-by: Aaruni Aggarwal <aaruniagg@gmail.com>\n\n* existing torch installation pip command fix for docs ( vllm-project#17059 )\n\n* Molmo Requirements ( vllm-project#17026 )\n\nSigned-off-by: Eyshika Agarwal <eyshikaengineer@gmail.com>\nSigned-off-by: eyshika <eyshikaengineer@gmail.com>\n\n* Add `:markdownhelp:` to `EngineArgs` docs so markdown docstrings render properly ( vllm-project#17124 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Improve configs - `LoRAConfig` + `PromptAdapterConfig` ( vllm-project#16980 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Generate correct github links for decorated functions ( vllm-project#17125 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Add collective_rpc to llm engine ( vllm-project#16999 )\n\nSigned-off-by: Yinghai Lu <yinghai@thinkingmachines.ai>\n\n* Add chat template for Llama 4 models ( vllm-project#16428 )\n\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\n\n* [Misc] Add example to run DeepSeek with Ray Serve LLM ( vllm-project#17134 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Better error message for missing mistral params.json ( vllm-project#17132 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* Use custom address for listening socket ( vllm-project#15988 )\n\nSigned-off-by: Jens Glaser <glaserj@ornl.gov>\n\n* [FEAT] [ROCm]: AITER Fused MOE V1 Support ( vllm-project#16752 )\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\n\n* [Attention] FA3 decode perf improvement - single mma warp group support for head dim 128 ( vllm-project#16864 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* fix float16 support for kimi-vl ( vllm-project#17156 )\n\nCo-authored-by: zhouzaida <zhouzaida@msh.team>\n\n* [Doc] V1 : Update LoRA status ( vllm-project#17133 )\n\nSigned-off-by: varun sundar rabindranath <vsundarr@redhat.com>\nCo-authored-by: varun sundar rabindranath <vsundarr@redhat.com>\n\n* [Docs] Fix True->true in supported_models.md ( vllm-project#17141 )\n\n* Move missed `SchedulerConfig` args into scheduler config group in `EngineArgs` ( vllm-project#17131 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] Clean up redundant code in uniproc_executor.py ( vllm-project#16762 )\n\nSigned-off-by: Lifu Huang <lifu.hlf@gmail.com>\n\n* [Bugfix][Misc] Use TritonPlaceholderModule to defensively import triton ( vllm-project#15099 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [Misc] Benchmark Serving Script Support Appending Results ( vllm-project#17028 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [Perf]Optimize rotary_emb implementation to use Triton operator for improved inference performance ( vllm-project#16457 )\n\nSigned-off-by: cynthieye <yexin93@qq.com>\nCo-authored-by: MagnetoWang <magnetowang@outlook.com>\n\n* [Bugfix] remove fallback in guided_json (int range, patterns) ( vllm-project#16725 )\n\nSigned-off-by: csy1204 <josang1204@gmail.com>\nCo-authored-by: ì¡°ìƒì—°[í”Œë ˆì´ìŠ¤ AI] <sang-yeon.cho@navercorp.com>\n\n* [Quantization][FP8] Add support for FP8 models with input_scale for output projection and QK quantization ( vllm-project#15734 )\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Luka GovediÄ <lgovedic@redhat.com>\nCo-authored-by: Luka GovediÄ <lgovedic@redhat.com>\n\n* [Doc] Add headings to improve gptqmodel.md ( vllm-project#17164 )\n\nSigned-off-by: windsonsea <haifeng.yao@daocloud.io>\n\n* Only turn on FastIncrementalDetokenizer when tokenizers >= 0.21.1 ( vllm-project#17158 )\n\n* [Doc] Add two links to disagg_prefill.md ( vllm-project#17168 )\n\nSigned-off-by: windsonsea <haifeng.yao@daocloud.io>\n\n* [Doc] Move todo out of beam search docstring ( vllm-project#17183 )\n\nSigned-off-by: Alex-Brooks <Alex.Brooks@ibm.com>\n\n* [Bugfix] Fix mistral model tests ( vllm-project#17181 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Bugfix] Fix Mistral ChatCompletionRequest Body Exception ( vllm-project#16769 )\n\nSigned-off-by: Jasmond Loh <Jasmond.Loh@hotmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* Fix API typo and remove FP8 on V1 restriction\n\n---------\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Chenyaaang <chenyangli@google.com>\nSigned-off-by: Guillaume Calmettes <gcalmettes@scaleway.com>\nSigned-off-by: Yang Wang <elainewy@meta.com>\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Michal Adamczyk <michal.adamczyk@intel.com>\nSigned-off-by: Chendi Xue <chendi.xue@intel.com>\nSigned-off-by: reidliu41 <reid201711@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: gitover22 <qidizou88@gmail.com>\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: windsonsea <haifeng.yao@daocloud.io>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: csy1204 <josang1204@gmail.com>\nSigned-off-by: sydarb <areebsyed237@gmail.com>\nSigned-off-by: å¼€å“² <kaizhe.zy@alibaba-inc.com>\nSigned-off-by: Omer Dayan (SW-GPU) <omer@run.ai>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: shen-shanshan <467638484@qq.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Aaruni Aggarwal <aaruniagg@gmail.com>\nSigned-off-by: Eyshika Agarwal <eyshikaengineer@gmail.com>\nSigned-off-by: eyshika <eyshikaengineer@gmail.com>\nSigned-off-by: Yinghai Lu <yinghai@thinkingmachines.ai>\nSigned-off-by: Max de Bayser <mbayser@br.ibm.com>\nSigned-off-by: Jens Glaser <glaserj@ornl.gov>\nSigned-off-by: varun sundar rabindranath <vsundarr@redhat.com>\nSigned-off-by: Lifu Huang <lifu.hlf@gmail.com>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: cynthieye <yexin93@qq.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Luka GovediÄ <lgovedic@redhat.com>\nSigned-off-by: Alex-Brooks <Alex.Brooks@ibm.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: Jasmond Loh <Jasmond.Loh@hotmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Chenyaaang <42742451+Chenyaaang@users.noreply.github.com>\nCo-authored-by: Guillaume Calmettes <gcalmettes@scaleway.com>\nCo-authored-by: Yang Wang <elainewy@meta.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Chendi.Xue <chendi.xue@intel.com>\nCo-authored-by: Michal Adamczyk <madamczyk@habana.ai>\nCo-authored-by: Reid <61492567+reidliu41@users.noreply.github.com>\nCo-authored-by: reidliu41 <reid201711@gmail.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: huafeng <qidizou88@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Michael Yao <haifeng.yao@daocloud.io>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Yong Hoon Shin <48474650+sarckk@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Sangyeon Cho <josang1204@gmail.com>\nCo-authored-by: Chen Xia <cxia0209@gmail.com>\nCo-authored-by: Areeb Syed <areebsyed237@gmail.com>\nCo-authored-by: å¼ å®‡ <zhangyuygss@outlook.com>\nCo-authored-by: å¼€å“² <kaizhe.zy@alibaba-inc.com>\nCo-authored-by: omer-dayan <omdayan@nvidia.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Shanshan Shen <467638484@qq.com>\nCo-authored-by: wang.yuqi <noooop@126.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Aaruni Aggarwal <47731267+AaruniAggarwal@users.noreply.github.com>\nCo-authored-by: Atilla <48064466+atilla00@users.noreply.github.com>\nCo-authored-by: Eyshika Agarwal <eyshikaengineer@gmail.com>\nCo-authored-by: Yinghai Lu <yinghai@thinkingmachines.ai>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: jglaser <glaserj@ornl.gov>\nCo-authored-by: tjtanaa <tunjian.tan@embeddedllm.com>\nCo-authored-by: Zaida Zhou <58739961+zhouzaida@users.noreply.github.com>\nCo-authored-by: zhouzaida <zhouzaida@msh.team>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: varun sundar rabindranath <vsundarr@redhat.com>\nCo-authored-by: Lifu Huang <lifu.hlf@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: yexin(å¶é‘«) <yexin93@qq.com>\nCo-authored-by: MagnetoWang <magnetowang@outlook.com>\nCo-authored-by: ì¡°ìƒì—°[í”Œë ˆì´ìŠ¤ AI] <sang-yeon.cho@navercorp.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: Luka GovediÄ <lgovedic@redhat.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Alex Brooks <alex.brooks@ibm.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Jasmond L <120363110+JasmondL@users.noreply.github.com> jikunshang pushed a commit\n        to jikunshang/vllm\n      that referenced\n      this pull request Apr 29, 2025 [Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 ( vllm-proâ€¦ â€¦ c8ceba9 â€¦ject#13305 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com> huydhn mentioned this pull request Apr 29, 2025 Fix some speculative decode tests with tl.dot #17371 Merged lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 [Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 ( vllm-proâ€¦ â€¦ 4bf77e2 â€¦ject#13305 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com> adobrzyn pushed a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Apr 30, 2025 [Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 ( vllm-proâ€¦ â€¦ d4a8c54 â€¦ject#13305 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: Agata Dobrzyniewicz <adobrzyniewicz@habana.ai> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 ( vllm-proâ€¦ â€¦ f32d058 â€¦ject#13305 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> ckhordiasma mentioned this pull request May 14, 2025 nm vllm ent 0.8.5 sync red-hat-data-services/vllm#139 Merged minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 ( vllm-proâ€¦ â€¦ b3ce066 â€¦ject#13305 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:14", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, gsm8k | PERF: ttft, TTFT, TTFT | SERVING: Serving, Serving, Serving | TEST: test, Test, test", "analysis_extracted_at": "2025-09-07 17:51:14", "models": ["meta-llama/Llama-3.1-8B-Instruct", "mistralai/Mistral-7B-Instruct-v0.3"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=mistralai/Mistral-7B-Instruct-v0.3,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 (#13305)", "commit_message": "[Kernel][ROCM] Upstream prefix prefill speed up for vLLM V1 (#13305)\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: root <root@banff-cyxtera-s65-4.amd.com>\nSigned-off-by: maleksan85 <maleksan@amd.com>\nSigned-off-by: <>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s65-4.amd.com>", "commit_date": "2025-04-22T19:11:56-07:00", "files_changed": ["tests/core/block/e2e/test_correctness.py", "vllm/attention/ops/prefix_prefill.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 0, "num_files": 2, "num_hunks": 4, "num_edited_lines": 1640, "num_non_test_edited_lines": 1634, "commit_year": 2025}, "diff_text": "diff --git a/tests/core/block/e2e/test_correctness.py b/tests/core/block/e2e/test_correctness.py\nindex e9b537ed5..9e8e315d8 100644\n--- a/tests/core/block/e2e/test_correctness.py\n+++ b/tests/core/block/e2e/test_correctness.py\n@@ -195,15 +195,15 @@ def test_lookahead_greedy_equality_with_preemption(baseline_llm_generator,\n     ])\n @pytest.mark.parametrize(\"per_test_common_llm_kwargs\",\n                          [{\n-                             \"block_size\": 8,\n+                             \"block_size\": 16,\n                              \"max_num_batched_tokens\": 2,\n                              \"max_num_seqs\": 2,\n                          }, {\n-                             \"block_size\": 8,\n+                             \"block_size\": 16,\n                              \"max_num_batched_tokens\": 3,\n                              \"max_num_seqs\": 2,\n                          }, {\n-                             \"block_size\": 8,\n+                             \"block_size\": 16,\n                              \"max_num_batched_tokens\": 256,\n                              \"max_num_seqs\": 10,\n                          }])\ndiff --git a/vllm/attention/ops/prefix_prefill.py b/vllm/attention/ops/prefix_prefill.py\nindex e0478c2ae..a8c8d8409 100644\n--- a/vllm/attention/ops/prefix_prefill.py\n+++ b/vllm/attention/ops/prefix_prefill.py\n@@ -16,831 +16,778 @@ NUM_WARPS = 4 if current_platform.is_rocm() else 8\n # To check compatibility\n IS_TURING = current_platform.get_device_capability() == (7, 5)\n \n-if triton.__version__ >= \"2.1.0\":\n-\n-    @triton.jit\n-    def _fwd_kernel(\n-        Q,\n-        K,\n-        V,\n-        K_cache,\n-        V_cache,\n-        B_Loc,\n-        sm_scale,\n-        k_scale,\n-        v_scale,\n-        B_Start_Loc,\n-        B_Seqlen,\n-        block_size,\n-        x,\n-        Out,\n-        stride_b_loc_b,\n-        stride_b_loc_s,\n-        stride_qbs,\n-        stride_qh,\n-        stride_qd,\n-        stride_kbs,\n-        stride_kh,\n-        stride_kd,\n-        stride_vbs,\n-        stride_vh,\n-        stride_vd,\n-        stride_obs,\n-        stride_oh,\n-        stride_od,\n-        stride_k_cache_bs,\n-        stride_k_cache_h,\n-        stride_k_cache_d,\n-        stride_k_cache_bl,\n-        stride_k_cache_x,\n-        stride_v_cache_bs,\n-        stride_v_cache_h,\n-        stride_v_cache_d,\n-        stride_v_cache_bl,\n-        num_queries_per_kv: int,\n-        IN_PRECISION: tl.constexpr,\n-        BLOCK_M: tl.constexpr,\n-        BLOCK_DMODEL: tl.constexpr,  # head size\n-        BLOCK_DMODEL_PADDED: tl.constexpr,  # head size padded to a power of 2\n-        BLOCK_N: tl.constexpr,\n-        SLIDING_WINDOW: tl.constexpr,\n-        SKIP_DECODE: tl.constexpr,\n-    ):\n-\n-        cur_batch = tl.program_id(0)\n-        cur_head = tl.program_id(1)\n-        start_m = tl.program_id(2)\n-\n-        cur_kv_head = cur_head // num_queries_per_kv\n-\n-        cur_batch_seq_len = tl.load(B_Seqlen + cur_batch)\n-        cur_batch_in_all_start_index = tl.load(B_Start_Loc + cur_batch)\n-        cur_batch_in_all_stop_index = tl.load(B_Start_Loc + cur_batch + 1)\n-        cur_batch_query_len = (cur_batch_in_all_stop_index -\n-                               cur_batch_in_all_start_index)\n-        cur_batch_ctx_len = cur_batch_seq_len - cur_batch_query_len\n-\n-        if SKIP_DECODE and cur_batch_query_len == 1:\n-            return\n-\n-        # start position inside of the query\n-        # generally, N goes over kv, while M goes over query_len\n-        block_start_loc = BLOCK_M * start_m\n-\n-        # initialize offsets\n-        # [N]; starts at 0\n-        offs_n = tl.arange(0, BLOCK_N)\n-        # [D]; starts at 0\n-        offs_d = tl.arange(0, BLOCK_DMODEL_PADDED)\n-        # [M]; starts at current position in query\n-        offs_m = start_m * BLOCK_M + tl.arange(0, BLOCK_M)\n-        # [M,D]\n-        off_q = (\n-            (cur_batch_in_all_start_index + offs_m[:, None]) * stride_qbs +\n-            cur_head * stride_qh + offs_d[None, :] * stride_qd)\n-\n-        dim_mask = tl.where(\n-            tl.arange(0, BLOCK_DMODEL_PADDED) < BLOCK_DMODEL, 1,\n-            0).to(tl.int1)  # [D]\n-\n-        q = tl.load(Q + off_q,\n-                    mask=dim_mask[None, :] &\n-                    (offs_m[:, None] < cur_batch_query_len),\n-                    other=0.0)  # [M,D]\n-\n-        # initialize pointer to m and l\n-        m_i = tl.zeros([BLOCK_M], dtype=tl.float32) - float(\"inf\")  # [M]\n-        l_i = tl.zeros([BLOCK_M], dtype=tl.float32)  # [M]\n-        acc = tl.zeros([BLOCK_M, BLOCK_DMODEL_PADDED],\n-                       dtype=tl.float32)  # [M,D]\n-\n-        # compute query against context (no causal mask here)\n-        for start_n in range(0, cur_batch_ctx_len, BLOCK_N):\n-            start_n = tl.multiple_of(start_n, BLOCK_N)\n-            # -- compute qk ----\n-            bn = tl.load(B_Loc + cur_batch * stride_b_loc_b +\n-                         ((start_n + offs_n) // block_size) * stride_b_loc_s,\n-                         mask=(start_n + offs_n) < cur_batch_ctx_len,\n-                         other=0)  # [N]\n-            # [D,N]\n-            off_k = (bn[None, :] * stride_k_cache_bs +\n-                     cur_kv_head * stride_k_cache_h +\n-                     (offs_d[:, None] // x) * stride_k_cache_d +\n-                     ((start_n + offs_n[None, :]) % block_size) *\n-                     stride_k_cache_bl +\n-                     (offs_d[:, None] % x) * stride_k_cache_x)\n-            # [N,D]\n-            off_v = (\n-                bn[:, None] * stride_v_cache_bs +\n-                cur_kv_head * stride_v_cache_h +\n-                offs_d[None, :] * stride_v_cache_d +\n-                (start_n + offs_n[:, None]) % block_size * stride_v_cache_bl)\n-            k_load = tl.load(K_cache + off_k,\n-                             mask=dim_mask[:, None] &\n-                             ((start_n + offs_n[None, :]) < cur_batch_ctx_len),\n-                             other=0.0)  # [D,N]\n-\n-            if k_load.dtype.is_fp8():\n-                k = (k_load.to(tl.float32) * tl.load(k_scale)).to(q.dtype)\n-            else:\n-                k = k_load\n-\n-            qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)  # [M,N]\n-            qk = tl.dot(q, k, acc=qk, input_precision=IN_PRECISION)\n-            qk = tl.where((start_n + offs_n[None, :]) < cur_batch_ctx_len, qk,\n-                          float(\"-inf\"))\n-            qk *= sm_scale\n-            if SLIDING_WINDOW > 0:\n-                # (cur_batch_ctx_len + offs_m[:, None]) are the positions of\n-                # Q entries in sequence\n-                # (start_n + offs_n[None, :]) are the positions of\n-                # KV entries in sequence\n-                # So the condition makes sure each entry in Q only attends\n-                # to KV entries not more than SLIDING_WINDOW away.\n-                #\n-                # We can't use -inf here, because the\n-                # sliding window may lead to the entire row being masked.\n-                # This then makes m_ij contain -inf, which causes NaNs in\n-                # exp().\n-                qk = tl.where((cur_batch_ctx_len + offs_m[:, None]) -\n-                              (start_n + offs_n[None, :]) < SLIDING_WINDOW, qk,\n-                              -10000)\n-\n-            # -- compute m_ij, p, l_ij\n-            m_ij = tl.max(qk, 1)  # [M]\n-            p = tl.exp(qk - m_ij[:, None])  # [M,N]\n-            l_ij = tl.sum(p, 1)  # [M]\n-            # -- update m_i and l_i\n-            m_i_new = tl.maximum(m_i, m_ij)  # [M]\n-            alpha = tl.exp(m_i - m_i_new)  # [M]\n-            beta = tl.exp(m_ij - m_i_new)  # [M]\n-            l_i_new = alpha * l_i + beta * l_ij  # [M]\n-\n-            # -- update output accumulator --\n-            # scale p\n-            p_scale = beta / l_i_new\n-            p = p * p_scale[:, None]\n-            # scale acc\n-            acc_scale = l_i / l_i_new * alpha\n-            acc = acc * acc_scale[:, None]\n-            # update acc\n-            v_load = tl.load(V_cache + off_v,\n-                             mask=dim_mask[None, :] &\n-                             ((start_n + offs_n[:, None]) < cur_batch_ctx_len),\n-                             other=0.0)  # [N,D]\n-            if v_load.dtype.is_fp8():\n-                v = (v_load.to(tl.float32) * tl.load(v_scale)).to(q.dtype)\n-            else:\n-                v = v_load\n-            p = p.to(v.dtype)\n-\n-            acc = tl.dot(p, v, acc=acc, input_precision=IN_PRECISION)\n-            # # update m_i and l_i\n-            l_i = l_i_new\n-            m_i = m_i_new\n-\n-        off_k = (offs_n[None, :] * stride_kbs + cur_kv_head * stride_kh +\n-                 offs_d[:, None] * stride_kd)\n-        off_v = (offs_n[:, None] * stride_vbs + cur_kv_head * stride_vh +\n-                 offs_d[None, :] * stride_vd)\n-        k_ptrs = K + off_k\n-        v_ptrs = V + off_v\n-\n-        # block_mask is 0 when we're already past the current query length\n-        block_mask = tl.where(block_start_loc < cur_batch_query_len, 1, 0)\n-\n-        # compute query against itself (with causal mask)\n-        for start_n in range(0, block_mask * (start_m + 1) * BLOCK_M, BLOCK_N):\n-            start_n = tl.multiple_of(start_n, BLOCK_N)\n-            # -- compute qk ----\n-            k = tl.load(k_ptrs +\n-                        (cur_batch_in_all_start_index + start_n) * stride_kbs,\n-                        mask=dim_mask[:, None] &\n-                        ((start_n + offs_n[None, :]) < cur_batch_query_len),\n-                        other=0.0)\n-\n-            qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n-            qk = tl.dot(q, k, acc=qk, input_precision=IN_PRECISION)\n-            qk *= sm_scale\n-            # apply causal mask\n-            qk = tl.where(offs_m[:, None] >= (start_n + offs_n[None, :]), qk,\n-                          float(\"-inf\"))\n-            if SLIDING_WINDOW > 0:\n-                qk = tl.where(\n-                    offs_m[:, None] - (start_n + offs_n[None, :])\n-                    < SLIDING_WINDOW, qk, -10000)\n-\n-            # -- compute m_ij, p, l_ij\n-            m_ij = tl.max(qk, 1)\n-            p = tl.exp(qk - m_ij[:, None])\n-            l_ij = tl.sum(p, 1)\n-            # -- update m_i and l_i\n-            m_i_new = tl.maximum(m_i, m_ij)\n-            alpha = tl.exp(m_i - m_i_new)\n-            beta = tl.exp(m_ij - m_i_new)\n-            l_i_new = alpha * l_i + beta * l_ij\n-            # -- update output accumulator --\n-            # scale p\n-            p_scale = beta / l_i_new\n-            p = p * p_scale[:, None]\n-            # scale acc\n-            acc_scale = l_i / l_i_new * alpha\n-            acc = acc * acc_scale[:, None]\n-            # update acc\n-            v = tl.load(v_ptrs +\n-                        (cur_batch_in_all_start_index + start_n) * stride_vbs,\n-                        mask=dim_mask[None, :] &\n-                        ((start_n + offs_n[:, None]) < cur_batch_query_len),\n-                        other=0.0)\n-            p = p.to(v.dtype)\n-\n-            acc = tl.dot(p, v, acc=acc, input_precision=IN_PRECISION)\n-            # update m_i and l_i\n-            l_i = l_i_new\n-            m_i = m_i_new\n-        # initialize pointers to output\n-        off_o = (\n-            (cur_batch_in_all_start_index + offs_m[:, None]) * stride_obs +\n-            cur_head * stride_oh + offs_d[None, :] * stride_od)\n-        out_ptrs = Out + off_o\n-        tl.store(out_ptrs,\n-                 acc,\n-                 mask=dim_mask[None, :] &\n-                 (offs_m[:, None] < cur_batch_query_len))\n+\n+# Here's an example autotuner config for this kernel. This config does provide\n+# a performance improvement, but dramatically increases first call latency in\n+# triton 3.2. Because of this tradeoff, it's currently commented out.\n+# @triton.autotune(\n+#     configs=[\n+#         triton.Config({'BLOCK_M': 128, 'BLOCK_N': 64, \\\n+#                         \"num_unroll_cache\": 4, \\\n+#                         \"num_unroll_request\": 1 } | \\\n+#                         ({\"kpack\": 2, \"waves_per_eu\": 2} \\\n+#                             if current_platform.is_rocm() else {}), \\\n+#                         num_warps=4, \\\n+#                         num_stages=1)\n+#     ],\n+#     key=[\"BLOCK_SIZE\", \"MAX_Q_LEN\", \"MAX_CTX_LEN\"]\n+# )\n+@triton.jit\n+def _fwd_kernel(Q,\n+                K,\n+                V,\n+                K_cache,\n+                V_cache,\n+                B_Loc,\n+                sm_scale,\n+                k_scale,\n+                v_scale,\n+                B_Start_Loc,\n+                B_Seqlen,\n+                x: tl.constexpr,\n+                Out,\n+                stride_b_loc_b,\n+                stride_b_loc_s,\n+                stride_qbs,\n+                stride_qh,\n+                stride_qd,\n+                stride_kbs,\n+                stride_kh,\n+                stride_kd,\n+                stride_vbs,\n+                stride_vh,\n+                stride_vd,\n+                stride_obs,\n+                stride_oh,\n+                stride_od,\n+                stride_k_cache_bs,\n+                stride_k_cache_h,\n+                stride_k_cache_d,\n+                stride_k_cache_bl: tl.constexpr,\n+                stride_k_cache_x,\n+                stride_v_cache_bs,\n+                stride_v_cache_h,\n+                stride_v_cache_d,\n+                stride_v_cache_bl,\n+                num_queries_per_kv: tl.constexpr,\n+                IN_PRECISION: tl.constexpr,\n+                BLOCK_M: tl.constexpr,\n+                BLOCK_DMODEL: tl.constexpr,\n+                BLOCK_DMODEL_PADDED: tl.constexpr,\n+                BLOCK_SIZE: tl.constexpr,\n+                BLOCK_N: tl.constexpr,\n+                SLIDING_WINDOW: tl.constexpr,\n+                num_unroll_cache: tl.constexpr,\n+                num_unroll_request: tl.constexpr,\n+                SKIP_DECODE: tl.constexpr,\n+                MAX_Q_LEN: tl.constexpr = 0,\n+                MAX_CTX_LEN: tl.constexpr = 0):\n+\n+    cur_batch = tl.program_id(0)\n+    cur_head = tl.program_id(1)\n+    start_m = tl.program_id(2)\n+\n+    cur_kv_head = cur_head // num_queries_per_kv\n+\n+    cur_batch_seq_len = tl.load(B_Seqlen + cur_batch)\n+    cur_batch_in_all_start_index = tl.load(B_Start_Loc + cur_batch)\n+    cur_batch_in_all_stop_index = tl.load(B_Start_Loc + cur_batch + 1)\n+    cur_batch_query_len = (cur_batch_in_all_stop_index -\n+                           cur_batch_in_all_start_index)\n+    cur_batch_ctx_len = cur_batch_seq_len - cur_batch_query_len\n+\n+    if SKIP_DECODE and cur_batch_query_len == 1:\n         return\n \n-    @triton.jit\n-    def _fwd_kernel_flash_attn_v2(\n-        Q,\n-        K,\n-        V,\n-        K_cache,\n-        V_cache,\n-        B_Loc,\n-        sm_scale,\n-        B_Start_Loc,\n-        B_Seqlen,\n-        B_Ctxlen,\n-        block_size,\n-        x,\n-        Out,\n-        stride_b_loc_b,\n-        stride_b_loc_s,\n-        stride_qbs,\n-        stride_qh,\n-        stride_qd,\n-        stride_kbs,\n-        stride_kh,\n-        stride_kd,\n-        stride_vbs,\n-        stride_vh,\n-        stride_vd,\n-        stride_obs,\n-        stride_oh,\n-        stride_od,\n-        stride_k_cache_bs,\n-        stride_k_cache_h,\n-        stride_k_cache_d,\n-        stride_k_cache_bl,\n-        stride_k_cache_x,\n-        stride_v_cache_bs,\n-        stride_v_cache_h,\n-        stride_v_cache_d,\n-        stride_v_cache_bl,\n-        num_queries_per_kv: int,\n-        BLOCK_M: tl.constexpr,\n-        BLOCK_DMODEL: tl.constexpr,\n-        BLOCK_N: tl.constexpr,\n-    ):\n-        cur_batch = tl.program_id(0)\n-        cur_head = tl.program_id(1)\n-        start_m = tl.program_id(2)\n-\n-        cur_kv_head = cur_head // num_queries_per_kv\n-\n-        cur_batch_ctx_len = tl.load(B_Ctxlen + cur_batch)\n-        cur_batch_seq_len = tl.load(B_Seqlen + cur_batch)\n-        cur_batch_in_all_start_index = tl.load(B_Start_Loc + cur_batch)\n-\n-        block_start_loc = BLOCK_M * start_m\n-\n-        # initialize offsets\n-        offs_n = tl.arange(0, BLOCK_N)\n-        offs_d = tl.arange(0, BLOCK_DMODEL)\n-        offs_m = start_m * BLOCK_M + tl.arange(0, BLOCK_M)\n-        off_q = (\n-            (cur_batch_in_all_start_index + offs_m[:, None]) * stride_qbs +\n-            cur_head * stride_qh + offs_d[None, :] * stride_qd)\n-\n-        q = tl.load(Q + off_q,\n-                    mask=offs_m[:, None]\n-                    < cur_batch_seq_len - cur_batch_ctx_len,\n+    # start position inside of the query\n+    # generally, N goes over kv, while M goes over query_len\n+    block_start_loc = BLOCK_M * start_m\n+\n+    # initialize offsets\n+    # [BLOCK_SIZE]; starts at 0\n+    offs_bs_n = tl.arange(0, BLOCK_SIZE)\n+    # [N]; starts at 0\n+    offs_n = tl.arange(0, BLOCK_N)\n+    # [D]; starts at 0\n+    offs_d = tl.arange(0, BLOCK_DMODEL_PADDED)\n+    # [M]; starts at current position in query\n+    offs_m = start_m * BLOCK_M + tl.arange(0, BLOCK_M)\n+    # [M,D]\n+    off_q = ((cur_batch_in_all_start_index + offs_m[:, None]) * stride_qbs +\n+             cur_head * stride_qh + offs_d[None, :] * stride_qd)\n+\n+    dim_mask = tl.where(\n+        tl.arange(0, BLOCK_DMODEL_PADDED) < BLOCK_DMODEL, 1,\n+        0).to(tl.int1)  # [D]\n+\n+    q = tl.load(Q + off_q,\n+                mask=dim_mask[None, :] &\n+                (offs_m[:, None] < cur_batch_query_len),\n+                other=0.0)  # [M,D]\n+\n+    # initialize pointer to m and l\n+    m_i = tl.full([BLOCK_M], float(\"-inf\"), dtype=tl.float32)\n+    l_i = tl.full([BLOCK_M], 1.0, dtype=tl.float32)\n+    acc = tl.zeros([BLOCK_M, BLOCK_DMODEL_PADDED], dtype=tl.float32)  # [M,D]\n+\n+    # compute query against context (no causal mask here)\n+    for start_n in tl.range(0, cur_batch_ctx_len, BLOCK_SIZE, \\\n+                            loop_unroll_factor=num_unroll_cache):\n+        start_n = tl.multiple_of(start_n, BLOCK_SIZE)\n+        # -- compute qk ----\n+        bn = tl.load(B_Loc + cur_batch * stride_b_loc_b +\n+                     (start_n // BLOCK_SIZE) * stride_b_loc_s)\n+        # [D,BLOCK_SIZE]\n+        off_k = (\n+            bn[None, :] * stride_k_cache_bs + cur_kv_head * stride_k_cache_h +\n+            (offs_d[:, None] // x) * stride_k_cache_d +\n+            ((start_n + offs_bs_n[None, :]) % BLOCK_SIZE) * stride_k_cache_bl +\n+            (offs_d[:, None] % x) * stride_k_cache_x)\n+\n+        # [BLOCK_SIZE,D]\n+        off_v = (bn[:, None] * stride_v_cache_bs +\n+                 cur_kv_head * stride_v_cache_h +\n+                 offs_d[None, :] * stride_v_cache_d +\n+                 offs_bs_n[:, None] * stride_v_cache_bl)\n+\n+        if start_n + BLOCK_SIZE > cur_batch_ctx_len or \\\n+            BLOCK_DMODEL != BLOCK_DMODEL_PADDED:\n+            k_load = tl.load(\n+                K_cache + off_k,\n+                mask=dim_mask[:, None] &\n+                ((start_n + offs_bs_n[None, :]) < cur_batch_ctx_len),\n+                other=0.0)  # [D,N]\n+        else:\n+            k_load = tl.load(K_cache + off_k)\n+\n+        if k_load.dtype.is_fp8():\n+            k = (k_load.to(tl.float32) * tl.load(k_scale)).to(q.dtype)\n+        else:\n+            k = k_load\n+\n+        qk = tl.zeros([BLOCK_M, BLOCK_SIZE], dtype=tl.float32)  # [M,N]\n+        qk = tl.dot(q, k, acc=qk, input_precision=IN_PRECISION)\n+        qk = tl.where((start_n + offs_bs_n[None, :]) < cur_batch_ctx_len, qk,\n+                      float(\"-inf\"))\n+        qk *= sm_scale\n+        if SLIDING_WINDOW > 0:\n+            # (cur_batch_ctx_len + offs_m[:, None]) are the positions of\n+            # Q entries in sequence\n+            # (start_n + offs_bs_n[None, :]) are the positions of\n+            # KV entries in sequence\n+            # So the condition makes sure each entry in Q only attends\n+            # to KV entries not more than SLIDING_WINDOW away.\n+            #\n+            # We can't use -inf here, because the\n+            # sliding window may lead to the entire row being masked.\n+            # This then makes m_ij contain -inf, which causes NaNs in\n+            # exp().\n+            qk = tl.where((cur_batch_ctx_len + offs_m[:, None]) -\n+                          (start_n + offs_bs_n[None, :]) < SLIDING_WINDOW, qk,\n+                          -10000)\n+\n+        # compute running maximum\n+        m_ij = tl.maximum(m_i, tl.max(qk, axis=1))\n+        p = tl.exp(qk - m_ij[:, None])\n+        l_ij = tl.sum(p, axis=1)\n+        alpha = tl.exp(m_i - m_ij)\n+        acc = acc * alpha[:, None]\n+\n+        # update acc\n+        if start_n + BLOCK_SIZE > cur_batch_ctx_len or \\\n+            BLOCK_DMODEL != BLOCK_DMODEL_PADDED:\n+            v_load = tl.load(\n+                V_cache + off_v,\n+                mask=dim_mask[None, :] &\n+                ((start_n + offs_bs_n[:, None]) < cur_batch_ctx_len),\n+                other=0.0)  # [N,D]\n+        else:\n+            v_load = tl.load(V_cache + off_v)\n+\n+        if v_load.dtype.is_fp8():\n+            v = (v_load.to(tl.float32) * tl.load(v_scale)).to(q.dtype)\n+        else:\n+            v = v_load\n+        p = p.to(v.dtype)\n+\n+        acc = tl.dot(p, v, acc=acc, input_precision=IN_PRECISION)\n+        # # update m_i and l_i\n+        l_i = l_i * alpha + l_ij\n+        m_i = m_ij\n+\n+    off_k = (offs_n[None, :] * stride_kbs + cur_kv_head * stride_kh +\n+             offs_d[:, None] * stride_kd)\n+    off_v = (offs_n[:, None] * stride_vbs + cur_kv_head * stride_vh +\n+             offs_d[None, :] * stride_vd)\n+    k_ptrs = K + off_k\n+    v_ptrs = V + off_v\n+\n+    # block_mask is 0 when we're already past the current query length\n+    block_mask = tl.where(block_start_loc < cur_batch_query_len, 1, 0)\n+\n+    # compute query against itself (with causal mask)\n+    for start_n in tl.range(0, \\\n+                        block_mask * (start_m + 1) * BLOCK_M, BLOCK_N, \\\n+                        loop_unroll_factor=num_unroll_request):\n+        start_n = tl.multiple_of(start_n, BLOCK_N)\n+        # -- compute qk ----\n+        k = tl.load(k_ptrs +\n+                    (cur_batch_in_all_start_index + start_n) * stride_kbs,\n+                    mask=dim_mask[:, None] &\n+                    ((start_n + offs_n[None, :]) < cur_batch_query_len),\n                     other=0.0)\n \n-        # # initialize pointer to m and l\n-        m_i = tl.zeros([BLOCK_M], dtype=tl.float32) - float(\"inf\")\n-        l_i = tl.zeros([BLOCK_M], dtype=tl.float32)\n-        acc = tl.zeros([BLOCK_M, BLOCK_DMODEL], dtype=tl.float32)\n-\n-        for start_n in range(0, cur_batch_ctx_len, BLOCK_N):\n-            start_n = tl.multiple_of(start_n, BLOCK_N)\n-            # -- compute qk ----\n-            bn = tl.load(B_Loc + cur_batch * stride_b_loc_b +\n-                         ((start_n + offs_n) // block_size) * stride_b_loc_s,\n-                         mask=(start_n + offs_n) < cur_batch_ctx_len,\n-                         other=0)\n-            off_k = (bn[None, :] * stride_k_cache_bs +\n-                     cur_kv_head * stride_k_cache_h +\n-                     (offs_d[:, None] // x) * stride_k_cache_d +\n-                     ((start_n + offs_n[None, :]) % block_size) *\n-                     stride_k_cache_bl +\n-                     (offs_d[:, None] % x) * stride_k_cache_x)\n-            off_v = (\n-                bn[:, None] * stride_v_cache_bs +\n-                cur_kv_head * stride_v_cache_h +\n-                offs_d[None, :] * stride_v_cache_d +\n-                (start_n + offs_n[:, None]) % block_size * stride_v_cache_bl)\n-            k = tl.load(K_cache + off_k,\n-                        mask=(start_n + offs_n[None, :]) < cur_batch_ctx_len,\n-                        other=0.0)\n-            qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n-            qk += tl.dot(q, k)\n-            qk = tl.where((start_n + offs_n[None, :]) < cur_batch_ctx_len, qk,\n-                          float(\"-inf\"))\n-            qk *= sm_scale\n-\n-            # -- compute m_ij, p, l_ij\n-            m_ij = tl.max(qk, 1)\n-            m_i_new = tl.maximum(m_i, m_ij)\n-            p = tl.math.exp(qk - m_i_new[:, None])\n-            l_ij = tl.sum(p, 1)\n-            # -- update m_i and l_i\n-\n-            alpha = tl.math.exp(m_i - m_i_new)\n-            l_i_new = alpha * l_i + l_ij\n-            # -- update output accumulator --\n-            # scale p\n-            # scale acc\n-            acc_scale = alpha\n-            # acc_scale = l_i / l_i_new * alpha\n-            acc = acc * acc_scale[:, None]\n-            # update acc\n-            v = tl.load(V_cache + off_v,\n-                        mask=(start_n + offs_n[:, None]) < cur_batch_ctx_len,\n-                        other=0.0)\n-\n-            p = p.to(v.dtype)\n-            acc += tl.dot(p, v)\n-            # update m_i and l_i\n-            l_i = l_i_new\n-            m_i = m_i_new\n-\n-        off_k = (offs_n[None, :] * stride_kbs + cur_kv_head * stride_kh +\n-                 offs_d[:, None] * stride_kd)\n-        off_v = (offs_n[:, None] * stride_vbs + cur_kv_head * stride_vh +\n-                 offs_d[None, :] * stride_vd)\n-        k_ptrs = K + off_k\n-        v_ptrs = V + off_v\n-\n-        block_mask = tl.where(\n-            block_start_loc < cur_batch_seq_len - cur_batch_ctx_len, 1, 0)\n-\n-        for start_n in range(0, block_mask * (start_m + 1) * BLOCK_M, BLOCK_N):\n-            start_n = tl.multiple_of(start_n, BLOCK_N)\n-            # -- compute qk ----\n-            k = tl.load(k_ptrs +\n-                        (cur_batch_in_all_start_index + start_n) * stride_kbs,\n-                        mask=(start_n + offs_n[None, :])\n-                        < cur_batch_seq_len - cur_batch_ctx_len,\n-                        other=0.0)\n-\n-            qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n-            qk += tl.dot(q, k)\n-            qk *= sm_scale\n-            qk = tl.where(offs_m[:, None] >= (start_n + offs_n[None, :]), qk,\n-                          float(\"-inf\"))\n-\n-            # -- compute m_ij, p, l_ij\n-            m_ij = tl.max(qk, 1)\n-            m_i_new = tl.maximum(m_i, m_ij)\n-            p = tl.math.exp(qk - m_i_new[:, None])\n-            l_ij = tl.sum(p, 1)\n-            # -- update m_i and l_i\n-\n-            alpha = tl.math.exp(m_i - m_i_new)\n-            l_i_new = alpha * l_i + l_ij\n-            # -- update output accumulator --\n-            # scale p\n-            # scale acc\n-            acc_scale = alpha\n-            # acc_scale = l_i / l_i_new * alpha\n-            acc = acc * acc_scale[:, None]\n-            # update acc\n-            v = tl.load(v_ptrs +\n-                        (cur_batch_in_all_start_index + start_n) * stride_vbs,\n-                        mask=(start_n + offs_n[:, None])\n-                        < cur_batch_seq_len - cur_batch_ctx_len,\n-                        other=0.0)\n-\n-            p = p.to(v.dtype)\n-            acc += tl.dot(p, v)\n-            # update m_i and l_i\n-            l_i = l_i_new\n-            m_i = m_i_new\n-\n-        # acc /= l_i[:, None]\n-        # initialize pointers to output\n-        off_o = (\n-            (cur_batch_in_all_start_index + offs_m[:, None]) * stride_obs +\n-            cur_head * stride_oh + offs_d[None, :] * stride_od)\n-        out_ptrs = Out + off_o\n-        tl.store(out_ptrs,\n-                 acc,\n-                 mask=offs_m[:, None] < cur_batch_seq_len - cur_batch_ctx_len)\n-        return\n-\n-    @triton.jit\n-    def _fwd_kernel_alibi(\n-        Q,\n-        K,\n-        V,\n-        K_cache,\n-        V_cache,\n-        B_Loc,\n-        sm_scale,\n-        k_scale,\n-        v_scale,\n-        B_Start_Loc,\n-        B_Seqlen,\n-        Alibi_slopes,\n-        block_size,\n-        x,\n-        Out,\n-        stride_b_loc_b,\n-        stride_b_loc_s,\n-        stride_qbs,\n-        stride_qh,\n-        stride_qd,\n-        stride_kbs,\n-        stride_kh,\n-        stride_kd,\n-        stride_vbs,\n-        stride_vh,\n-        stride_vd,\n-        stride_obs,\n-        stride_oh,\n-        stride_od,\n-        stride_k_cache_bs,\n-        stride_k_cache_h,\n-        stride_k_cache_d,\n-        stride_k_cache_bl,\n-        stride_k_cache_x,\n-        stride_v_cache_bs,\n-        stride_v_cache_h,\n-        stride_v_cache_d,\n-        stride_v_cache_bl,\n-        num_queries_per_kv: int,\n-        IN_PRECISION: tl.constexpr,\n-        BLOCK_M: tl.constexpr,\n-        BLOCK_DMODEL: tl.constexpr,  # head size\n-        BLOCK_DMODEL_PADDED: tl.constexpr,  # head size padded to a power of 2\n-        BLOCK_N: tl.constexpr,\n-        SKIP_DECODE: tl.constexpr,\n-    ):\n-        # attn_bias[]\n-        cur_batch = tl.program_id(0)\n-        cur_head = tl.program_id(1)\n-        start_m = tl.program_id(2)\n-\n-        cur_kv_head = cur_head // num_queries_per_kv\n-\n-        # cur_batch_seq_len: the length of prompts\n-        # cur_batch_ctx_len: the length of prefix\n-        # cur_batch_in_all_start_index: the start id of the dim=0\n-        cur_batch_seq_len = tl.load(B_Seqlen + cur_batch)\n-        cur_batch_in_all_start_index = tl.load(B_Start_Loc + cur_batch)\n-        cur_batch_in_all_stop_index = tl.load(B_Start_Loc + cur_batch + 1)\n-        cur_batch_query_len = (cur_batch_in_all_stop_index -\n-                               cur_batch_in_all_start_index)\n-        cur_batch_ctx_len = cur_batch_seq_len - cur_batch_query_len\n-\n-        if SKIP_DECODE and cur_batch_query_len == 1:\n-            return\n-\n-        block_start_loc = BLOCK_M * start_m\n-\n-        # initialize offsets\n-        offs_n = tl.arange(0, BLOCK_N)\n-        offs_d = tl.arange(0, BLOCK_DMODEL_PADDED)\n-        offs_m = start_m * BLOCK_M + tl.arange(0, BLOCK_M)\n-        off_q = (\n-            (cur_batch_in_all_start_index + offs_m[:, None]) * stride_qbs +\n-            cur_head * stride_qh + offs_d[None, :] * stride_qd)\n-\n-        dim_mask = tl.where(\n-            tl.arange(0, BLOCK_DMODEL_PADDED) < BLOCK_DMODEL, 1, 0).to(tl.int1)\n-\n-        q = tl.load(Q + off_q,\n+        qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n+        qk = tl.dot(q, k, acc=qk, input_precision=IN_PRECISION)\n+        qk *= sm_scale\n+        # apply causal mask\n+        qk = tl.where(offs_m[:, None] >= (start_n + offs_n[None, :]), qk,\n+                      float(\"-inf\"))\n+        if SLIDING_WINDOW > 0:\n+            qk = tl.where(\n+                offs_m[:, None] - (start_n + offs_n[None, :]) < SLIDING_WINDOW,\n+                qk, -10000)\n+\n+        # compute running maximum\n+        m_ij = tl.maximum(m_i, tl.max(qk, axis=1))\n+        p = tl.exp(qk - m_ij[:, None])\n+        l_ij = tl.sum(p, axis=1)\n+        alpha = tl.exp(m_i - m_ij)\n+        acc = acc * alpha[:, None]\n+\n+        # update acc\n+        v = tl.load(v_ptrs +\n+                    (cur_batch_in_all_start_index + start_n) * stride_vbs,\n                     mask=dim_mask[None, :] &\n-                    (offs_m[:, None] < cur_batch_seq_len - cur_batch_ctx_len),\n+                    ((start_n + offs_n[:, None]) < cur_batch_query_len),\n+                    other=0.0)\n+        p = p.to(v.dtype)\n+\n+        acc = tl.dot(p, v, acc=acc, input_precision=IN_PRECISION)\n+        # update m_i and l_i\n+        l_i = l_i * alpha + l_ij\n+        m_i = m_ij\n+\n+    acc = acc / l_i[:, None]\n+\n+    # initialize pointers to output\n+    off_o = ((cur_batch_in_all_start_index + offs_m[:, None]) * stride_obs +\n+             cur_head * stride_oh + offs_d[None, :] * stride_od)\n+    out_ptrs = Out + off_o\n+    tl.store(out_ptrs,\n+             acc,\n+             mask=dim_mask[None, :] & (offs_m[:, None] < cur_batch_query_len))\n+    return\n+\n+\n+@triton.jit\n+def _fwd_kernel_flash_attn_v2(\n+    Q,\n+    K,\n+    V,\n+    K_cache,\n+    V_cache,\n+    B_Loc,\n+    sm_scale,\n+    B_Start_Loc,\n+    B_Seqlen,\n+    B_Ctxlen,\n+    block_size,\n+    x,\n+    Out,\n+    stride_b_loc_b,\n+    stride_b_loc_s,\n+    stride_qbs,\n+    stride_qh,\n+    stride_qd,\n+    stride_kbs,\n+    stride_kh,\n+    stride_kd,\n+    stride_vbs,\n+    stride_vh,\n+    stride_vd,\n+    stride_obs,\n+    stride_oh,\n+    stride_od,\n+    stride_k_cache_bs,\n+    stride_k_cache_h,\n+    stride_k_cache_d,\n+    stride_k_cache_bl,\n+    stride_k_cache_x,\n+    stride_v_cache_bs,\n+    stride_v_cache_h,\n+    stride_v_cache_d,\n+    stride_v_cache_bl,\n+    num_queries_per_kv: int,\n+    BLOCK_M: tl.constexpr,\n+    BLOCK_DMODEL: tl.constexpr,\n+    BLOCK_N: tl.constexpr,\n+):\n+    cur_batch = tl.program_id(0)\n+    cur_head = tl.program_id(1)\n+    start_m = tl.program_id(2)\n+\n+    cur_kv_head = cur_head // num_queries_per_kv\n+\n+    cur_batch_ctx_len = tl.load(B_Ctxlen + cur_batch)\n+    cur_batch_seq_len = tl.load(B_Seqlen + cur_batch)\n+    cur_batch_in_all_start_index = tl.load(B_Start_Loc + cur_batch)\n+\n+    block_start_loc = BLOCK_M * start_m\n+\n+    # initialize offsets\n+    offs_n = tl.arange(0, BLOCK_N)\n+    offs_d = tl.arange(0, BLOCK_DMODEL)\n+    offs_m = start_m * BLOCK_M + tl.arange(0, BLOCK_M)\n+    off_q = ((cur_batch_in_all_start_index + offs_m[:, None]) * stride_qbs +\n+             cur_head * stride_qh + offs_d[None, :] * stride_qd)\n+\n+    q = tl.load(Q + off_q,\n+                mask=offs_m[:, None] < cur_batch_seq_len - cur_batch_ctx_len,\n+                other=0.0)\n+\n+    # # initialize pointer to m and l\n+    m_i = tl.zeros([BLOCK_M], dtype=tl.float32) - float(\"inf\")\n+    l_i = tl.zeros([BLOCK_M], dtype=tl.float32)\n+    acc = tl.zeros([BLOCK_M, BLOCK_DMODEL], dtype=tl.float32)\n+\n+    for start_n in range(0, cur_batch_ctx_len, BLOCK_N):\n+        start_n = tl.multiple_of(start_n, BLOCK_N)\n+        # -- compute qk ----\n+        bn = tl.load(B_Loc + cur_batch * stride_b_loc_b +\n+                     ((start_n + offs_n) // block_size) * stride_b_loc_s,\n+                     mask=(start_n + offs_n) < cur_batch_ctx_len,\n+                     other=0)\n+        off_k = (\n+            bn[None, :] * stride_k_cache_bs + cur_kv_head * stride_k_cache_h +\n+            (offs_d[:, None] // x) * stride_k_cache_d +\n+            ((start_n + offs_n[None, :]) % block_size) * stride_k_cache_bl +\n+            (offs_d[:, None] % x) * stride_k_cache_x)\n+        off_v = (bn[:, None] * stride_v_cache_bs +\n+                 cur_kv_head * stride_v_cache_h +\n+                 offs_d[None, :] * stride_v_cache_d +\n+                 (start_n + offs_n[:, None]) % block_size * stride_v_cache_bl)\n+        k = tl.load(K_cache + off_k,\n+                    mask=(start_n + offs_n[None, :]) < cur_batch_ctx_len,\n+                    other=0.0)\n+        qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n+        qk += tl.dot(q, k)\n+        qk = tl.where((start_n + offs_n[None, :]) < cur_batch_ctx_len, qk,\n+                      float(\"-inf\"))\n+        qk *= sm_scale\n+\n+        # -- compute m_ij, p, l_ij\n+        m_ij = tl.max(qk, 1)\n+        m_i_new = tl.maximum(m_i, m_ij)\n+        p = tl.math.exp(qk - m_i_new[:, None])\n+        l_ij = tl.sum(p, 1)\n+        # -- update m_i and l_i\n+\n+        alpha = tl.math.exp(m_i - m_i_new)\n+        l_i_new = alpha * l_i + l_ij\n+        # -- update output accumulator --\n+        # scale p\n+        # scale acc\n+        acc_scale = alpha\n+        # acc_scale = l_i / l_i_new * alpha\n+        acc = acc * acc_scale[:, None]\n+        # update acc\n+        v = tl.load(V_cache + off_v,\n+                    mask=(start_n + offs_n[:, None]) < cur_batch_ctx_len,\n+                    other=0.0)\n+\n+        p = p.to(v.dtype)\n+        acc += tl.dot(p, v)\n+        # update m_i and l_i\n+        l_i = l_i_new\n+        m_i = m_i_new\n+\n+    off_k = (offs_n[None, :] * stride_kbs + cur_kv_head * stride_kh +\n+             offs_d[:, None] * stride_kd)\n+    off_v = (offs_n[:, None] * stride_vbs + cur_kv_head * stride_vh +\n+             offs_d[None, :] * stride_vd)\n+    k_ptrs = K + off_k\n+    v_ptrs = V + off_v\n+\n+    block_mask = tl.where(\n+        block_start_loc < cur_batch_seq_len - cur_batch_ctx_len, 1, 0)\n+\n+    for start_n in range(0, block_mask * (start_m + 1) * BLOCK_M, BLOCK_N):\n+        start_n = tl.multiple_of(start_n, BLOCK_N)\n+        # -- compute qk ----\n+        k = tl.load(k_ptrs +\n+                    (cur_batch_in_all_start_index + start_n) * stride_kbs,\n+                    mask=(start_n + offs_n[None, :])\n+                    < cur_batch_seq_len - cur_batch_ctx_len,\n                     other=0.0)\n \n-        # # initialize pointer to m and l\n-        m_i = tl.zeros([BLOCK_M], dtype=tl.float32) - float(\"inf\")\n-        l_i = tl.zeros([BLOCK_M], dtype=tl.float32)\n-        acc = tl.zeros([BLOCK_M, BLOCK_DMODEL_PADDED], dtype=tl.float32)\n-\n-        alibi_slope = tl.load(Alibi_slopes + cur_head)\n-        alibi_start_q = tl.arange(\n-            0, BLOCK_M) + block_start_loc + cur_batch_ctx_len\n-        alibi_start_k = 0\n-        for start_n in range(0, cur_batch_ctx_len, BLOCK_N):\n-            start_n = tl.multiple_of(start_n, BLOCK_N)\n-            # -- compute qk ----\n-            bn = tl.load(B_Loc + cur_batch * stride_b_loc_b +\n-                         ((start_n + offs_n) // block_size) * stride_b_loc_s,\n-                         mask=(start_n + offs_n) < cur_batch_ctx_len,\n-                         other=0)\n-            off_k = (bn[None, :] * stride_k_cache_bs +\n-                     cur_kv_head * stride_k_cache_h +\n-                     (offs_d[:, None] // x) * stride_k_cache_d +\n-                     ((start_n + offs_n[None, :]) % block_size) *\n-                     stride_k_cache_bl +\n-                     (offs_d[:, None] % x) * stride_k_cache_x)\n-            off_v = (\n-                bn[:, None] * stride_v_cache_bs +\n-                cur_kv_head * stride_v_cache_h +\n-                offs_d[None, :] * stride_v_cache_d +\n-                (start_n + offs_n[:, None]) % block_size * stride_v_cache_bl)\n-            k_load = tl.load(K_cache + off_k,\n-                             mask=dim_mask[:, None] &\n-                             ((start_n + offs_n[None, :]) < cur_batch_ctx_len),\n-                             other=0.0)  # [D,N]\n-\n-            if k_load.dtype.is_fp8():\n-                k = (k_load.to(tl.float32) * tl.load(k_scale)).to(q.dtype)\n-            else:\n-                k = k_load\n-\n-            qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n-            qk = tl.dot(q, k, acc=qk, input_precision=IN_PRECISION)\n-            qk = tl.where((start_n + offs_n[None, :]) < cur_batch_ctx_len, qk,\n-                          float(\"-inf\"))\n-            qk *= sm_scale\n-\n-            # load alibi\n-            alibi = (tl.arange(0, BLOCK_N)[None, :] + alibi_start_k -\n-                     alibi_start_q[:, None]) * alibi_slope\n-            alibi = tl.where(\n-                (alibi <= 0) & (alibi_start_q[:, None] < cur_batch_seq_len),\n-                alibi, float(\"-inf\"))\n-            qk += alibi\n-            alibi_start_k += BLOCK_N\n-\n-            # -- compute m_ij, p, l_ij\n-            m_ij = tl.max(qk, 1)\n-            m_i_new = tl.maximum(m_i, m_ij)\n-            p = tl.math.exp(qk - m_i_new[:, None])\n-            l_ij = tl.sum(p, 1)\n-            # -- update m_i and l_i\n-\n-            alpha = tl.math.exp(m_i - m_i_new)\n-            l_i_new = alpha * l_i + l_ij\n-            # -- update output accumulator --\n-            # scale p\n-            # scale acc\n-            acc_scale = alpha\n-            # acc_scale = l_i / l_i_new * alpha\n-            acc = acc * acc_scale[:, None]\n-            # update acc\n-            v_load = tl.load(V_cache + off_v,\n-                             mask=dim_mask[None, :] &\n-                             ((start_n + offs_n[:, None]) < cur_batch_ctx_len),\n-                             other=0.0)\n-            if v_load.dtype.is_fp8():\n-                v = (v_load.to(tl.float32) * tl.load(v_scale)).to(q.dtype)\n-            else:\n-                v = v_load\n-            p = p.to(v.dtype)\n-\n-            acc = tl.dot(p, v, acc=acc, input_precision='ieee')\n-            # update m_i and l_i\n-            l_i = l_i_new\n-            m_i = m_i_new\n-\n-        off_k = (offs_n[None, :] * stride_kbs + cur_kv_head * stride_kh +\n-                 offs_d[:, None] * stride_kd)\n-        off_v = (offs_n[:, None] * stride_vbs + cur_kv_head * stride_vh +\n-                 offs_d[None, :] * stride_vd)\n-        k_ptrs = K + off_k\n-        v_ptrs = V + off_v\n-\n-        block_mask = tl.where(\n-            block_start_loc < cur_batch_seq_len - cur_batch_ctx_len, 1, 0)\n-\n-        # init alibi\n-        alibi_slope = tl.load(Alibi_slopes + cur_head)\n-        alibi_start_q = tl.arange(\n-            0, BLOCK_M) + block_start_loc + cur_batch_ctx_len\n-        alibi_start_k = cur_batch_ctx_len\n-        # # init debugger\n-        # offset_db_q = tl.arange(0, BLOCK_M) + block_start_loc\n-        # offset_db_k = tl.arange(0, BLOCK_N)\n-        # calc q[BLOCK_M, BLOCK_MODEL] mul k[prefix_len: , BLOCK_DMODEL]\n-        for start_n in range(0, block_mask * (start_m + 1) * BLOCK_M, BLOCK_N):\n-            start_n = tl.multiple_of(start_n, BLOCK_N)\n-            # -- compute qk ----\n-            k = tl.load(k_ptrs +\n-                        (cur_batch_in_all_start_index + start_n) * stride_kbs,\n-                        mask=dim_mask[:, None] &\n-                        ((start_n + offs_n[None, :])\n-                         < cur_batch_seq_len - cur_batch_ctx_len),\n-                        other=0.0)\n-\n-            qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n-            qk = tl.dot(q, k, acc=qk, input_precision='ieee')\n-            qk *= sm_scale\n-            qk = tl.where(offs_m[:, None] >= (start_n + offs_n[None, :]), qk,\n-                          float(\"-inf\"))\n-\n-            # load alibi\n-            alibi = (tl.arange(0, BLOCK_N)[None, :] + alibi_start_k -\n-                     alibi_start_q[:, None]) * alibi_slope\n-            alibi = tl.where(\n-                (alibi <= 0) & (alibi_start_q[:, None] < cur_batch_seq_len),\n-                alibi, float(\"-inf\"))\n-            qk += alibi\n-            alibi_start_k += BLOCK_N\n-\n-            # -- compute m_ij, p, l_ij\n-            m_ij = tl.max(qk, 1)\n-            m_i_new = tl.maximum(m_i, m_ij)\n-            p = tl.math.exp(qk - m_i_new[:, None])\n-            l_ij = tl.sum(p, 1)\n-            # -- update m_i and l_i\n-\n-            alpha = tl.math.exp(m_i - m_i_new)\n-            l_i_new = alpha * l_i + l_ij\n-            # -- update output accumulator --\n-            # scale p\n-            # scale acc\n-            acc_scale = alpha\n-            # acc_scale = l_i / l_i_new * alpha\n-            acc = acc * acc_scale[:, None]\n-            # update acc\n-            v = tl.load(v_ptrs +\n-                        (cur_batch_in_all_start_index + start_n) * stride_vbs,\n-                        mask=dim_mask[None, :] &\n-                        ((start_n + offs_n[:, None])\n-                         < cur_batch_seq_len - cur_batch_ctx_len),\n-                        other=0.0)\n-            p = p.to(v.dtype)\n-\n-            acc = tl.dot(p, v, acc=acc, input_precision='ieee')\n-            # update m_i and l_i\n-            l_i = l_i_new\n-            m_i = m_i_new\n-\n-        acc = acc / l_i[:, None]\n-\n-        # initialize pointers to output\n-        off_o = (\n-            (cur_batch_in_all_start_index + offs_m[:, None]) * stride_obs +\n-            cur_head * stride_oh + offs_d[None, :] * stride_od)\n-        out_ptrs = Out + off_o\n-        tl.store(out_ptrs,\n-                 acc,\n-                 mask=dim_mask[None, :] &\n-                 (offs_m[:, None] < cur_batch_seq_len - cur_batch_ctx_len))\n+        qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n+        qk += tl.dot(q, k)\n+        qk *= sm_scale\n+        qk = tl.where(offs_m[:, None] >= (start_n + offs_n[None, :]), qk,\n+                      float(\"-inf\"))\n+\n+        # -- compute m_ij, p, l_ij\n+        m_ij = tl.max(qk, 1)\n+        m_i_new = tl.maximum(m_i, m_ij)\n+        p = tl.math.exp(qk - m_i_new[:, None])\n+        l_ij = tl.sum(p, 1)\n+        # -- update m_i and l_i\n+\n+        alpha = tl.math.exp(m_i - m_i_new)\n+        l_i_new = alpha * l_i + l_ij\n+        # -- update output accumulator --\n+        # scale p\n+        # scale acc\n+        acc_scale = alpha\n+        # acc_scale = l_i / l_i_new * alpha\n+        acc = acc * acc_scale[:, None]\n+        # update acc\n+        v = tl.load(v_ptrs +\n+                    (cur_batch_in_all_start_index + start_n) * stride_vbs,\n+                    mask=(start_n + offs_n[:, None])\n+                    < cur_batch_seq_len - cur_batch_ctx_len,\n+                    other=0.0)\n+\n+        p = p.to(v.dtype)\n+        acc += tl.dot(p, v)\n+        # update m_i and l_i\n+        l_i = l_i_new\n+        m_i = m_i_new\n+\n+    # acc /= l_i[:, None]\n+    # initialize pointers to output\n+    off_o = ((cur_batch_in_all_start_index + offs_m[:, None]) * stride_obs +\n+             cur_head * stride_oh + offs_d[None, :] * stride_od)\n+    out_ptrs = Out + off_o\n+    tl.store(out_ptrs,\n+             acc,\n+             mask=offs_m[:, None] < cur_batch_seq_len - cur_batch_ctx_len)\n+    return\n+\n+\n+@triton.jit\n+def _fwd_kernel_alibi(\n+    Q,\n+    K,\n+    V,\n+    K_cache,\n+    V_cache,\n+    B_Loc,\n+    sm_scale,\n+    k_scale,\n+    v_scale,\n+    B_Start_Loc,\n+    B_Seqlen,\n+    Alibi_slopes,\n+    block_size,\n+    x,\n+    Out,\n+    stride_b_loc_b,\n+    stride_b_loc_s,\n+    stride_qbs,\n+    stride_qh,\n+    stride_qd,\n+    stride_kbs,\n+    stride_kh,\n+    stride_kd,\n+    stride_vbs,\n+    stride_vh,\n+    stride_vd,\n+    stride_obs,\n+    stride_oh,\n+    stride_od,\n+    stride_k_cache_bs,\n+    stride_k_cache_h,\n+    stride_k_cache_d,\n+    stride_k_cache_bl,\n+    stride_k_cache_x,\n+    stride_v_cache_bs,\n+    stride_v_cache_h,\n+    stride_v_cache_d,\n+    stride_v_cache_bl,\n+    num_queries_per_kv: int,\n+    IN_PRECISION: tl.constexpr,\n+    BLOCK_M: tl.constexpr,\n+    BLOCK_DMODEL: tl.constexpr,  # head size\n+    BLOCK_DMODEL_PADDED: tl.constexpr,  # head size padded to a power of 2\n+    BLOCK_N: tl.constexpr,\n+    SKIP_DECODE: tl.constexpr,\n+):\n+    # attn_bias[]\n+    cur_batch = tl.program_id(0)\n+    cur_head = tl.program_id(1)\n+    start_m = tl.program_id(2)\n+\n+    cur_kv_head = cur_head // num_queries_per_kv\n+\n+    # cur_batch_seq_len: the length of prompts\n+    # cur_batch_ctx_len: the length of prefix\n+    # cur_batch_in_all_start_index: the start id of the dim=0\n+    cur_batch_seq_len = tl.load(B_Seqlen + cur_batch)\n+    cur_batch_in_all_start_index = tl.load(B_Start_Loc + cur_batch)\n+    cur_batch_in_all_stop_index = tl.load(B_Start_Loc + cur_batch + 1)\n+    cur_batch_query_len = (cur_batch_in_all_stop_index -\n+                           cur_batch_in_all_start_index)\n+    cur_batch_ctx_len = cur_batch_seq_len - cur_batch_query_len\n+\n+    if SKIP_DECODE and cur_batch_query_len == 1:\n         return\n \n-    @torch.inference_mode()\n-    def context_attention_fwd(q,\n-                              k,\n-                              v,\n-                              o,\n-                              kv_cache_dtype: str,\n-                              k_cache,\n-                              v_cache,\n-                              b_loc,\n-                              b_start_loc,\n-                              b_seq_len,\n-                              max_seq_len,\n-                              max_input_len,\n-                              k_scale: torch.Tensor,\n-                              v_scale: torch.Tensor,\n-                              alibi_slopes=None,\n-                              sliding_window=None,\n-                              sm_scale=None,\n-                              skip_decode=False):\n-\n-        q_dtype_is_f32 = q.dtype is torch.float32\n+    block_start_loc = BLOCK_M * start_m\n+\n+    # initialize offsets\n+    offs_n = tl.arange(0, BLOCK_N)\n+    offs_d = tl.arange(0, BLOCK_DMODEL_PADDED)\n+    offs_m = start_m * BLOCK_M + tl.arange(0, BLOCK_M)\n+    off_q = ((cur_batch_in_all_start_index + offs_m[:, None]) * stride_qbs +\n+             cur_head * stride_qh + offs_d[None, :] * stride_qd)\n+\n+    dim_mask = tl.where(\n+        tl.arange(0, BLOCK_DMODEL_PADDED) < BLOCK_DMODEL, 1, 0).to(tl.int1)\n+\n+    q = tl.load(Q + off_q,\n+                mask=dim_mask[None, :] &\n+                (offs_m[:, None] < cur_batch_seq_len - cur_batch_ctx_len),\n+                other=0.0)\n+\n+    # # initialize pointer to m and l\n+    m_i = tl.zeros([BLOCK_M], dtype=tl.float32) - float(\"inf\")\n+    l_i = tl.zeros([BLOCK_M], dtype=tl.float32)\n+    acc = tl.zeros([BLOCK_M, BLOCK_DMODEL_PADDED], dtype=tl.float32)\n+\n+    alibi_slope = tl.load(Alibi_slopes + cur_head)\n+    alibi_start_q = tl.arange(0, BLOCK_M) + block_start_loc + cur_batch_ctx_len\n+    alibi_start_k = 0\n+    for start_n in range(0, cur_batch_ctx_len, BLOCK_N):\n+        start_n = tl.multiple_of(start_n, BLOCK_N)\n+        # -- compute qk ----\n+        bn = tl.load(B_Loc + cur_batch * stride_b_loc_b +\n+                     ((start_n + offs_n) // block_size) * stride_b_loc_s,\n+                     mask=(start_n + offs_n) < cur_batch_ctx_len,\n+                     other=0)\n+        off_k = (\n+            bn[None, :] * stride_k_cache_bs + cur_kv_head * stride_k_cache_h +\n+            (offs_d[:, None] // x) * stride_k_cache_d +\n+            ((start_n + offs_n[None, :]) % block_size) * stride_k_cache_bl +\n+            (offs_d[:, None] % x) * stride_k_cache_x)\n+        off_v = (bn[:, None] * stride_v_cache_bs +\n+                 cur_kv_head * stride_v_cache_h +\n+                 offs_d[None, :] * stride_v_cache_d +\n+                 (start_n + offs_n[:, None]) % block_size * stride_v_cache_bl)\n+        k_load = tl.load(K_cache + off_k,\n+                         mask=dim_mask[:, None] &\n+                         ((start_n + offs_n[None, :]) < cur_batch_ctx_len),\n+                         other=0.0)  # [D,N]\n+\n+        if k_load.dtype.is_fp8():\n+            k = (k_load.to(tl.float32) * tl.load(k_scale)).to(q.dtype)\n+        else:\n+            k = k_load\n+\n+        qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n+        qk = tl.dot(q, k, acc=qk, input_precision=IN_PRECISION)\n+        qk = tl.where((start_n + offs_n[None, :]) < cur_batch_ctx_len, qk,\n+                      float(\"-inf\"))\n+        qk *= sm_scale\n+\n+        # load alibi\n+        alibi = (tl.arange(0, BLOCK_N)[None, :] + alibi_start_k -\n+                 alibi_start_q[:, None]) * alibi_slope\n+        alibi = tl.where(\n+            (alibi <= 0) & (alibi_start_q[:, None] < cur_batch_seq_len), alibi,\n+            float(\"-inf\"))\n+        qk += alibi\n+        alibi_start_k += BLOCK_N\n+\n+        # -- compute m_ij, p, l_ij\n+        m_ij = tl.max(qk, 1)\n+        m_i_new = tl.maximum(m_i, m_ij)\n+        p = tl.math.exp(qk - m_i_new[:, None])\n+        l_ij = tl.sum(p, 1)\n+        # -- update m_i and l_i\n+\n+        alpha = tl.math.exp(m_i - m_i_new)\n+        l_i_new = alpha * l_i + l_ij\n+        # -- update output accumulator --\n+        # scale p\n+        # scale acc\n+        acc_scale = alpha\n+        # acc_scale = l_i / l_i_new * alpha\n+        acc = acc * acc_scale[:, None]\n+        # update acc\n+        v_load = tl.load(V_cache + off_v,\n+                         mask=dim_mask[None, :] &\n+                         ((start_n + offs_n[:, None]) < cur_batch_ctx_len),\n+                         other=0.0)\n+        if v_load.dtype.is_fp8():\n+            v = (v_load.to(tl.float32) * tl.load(v_scale)).to(q.dtype)\n+        else:\n+            v = v_load\n+        p = p.to(v.dtype)\n+\n+        acc = tl.dot(p, v, acc=acc, input_precision='ieee')\n+        # update m_i and l_i\n+        l_i = l_i_new\n+        m_i = m_i_new\n+\n+    off_k = (offs_n[None, :] * stride_kbs + cur_kv_head * stride_kh +\n+             offs_d[:, None] * stride_kd)\n+    off_v = (offs_n[:, None] * stride_vbs + cur_kv_head * stride_vh +\n+             offs_d[None, :] * stride_vd)\n+    k_ptrs = K + off_k\n+    v_ptrs = V + off_v\n+\n+    block_mask = tl.where(\n+        block_start_loc < cur_batch_seq_len - cur_batch_ctx_len, 1, 0)\n+\n+    # init alibi\n+    alibi_slope = tl.load(Alibi_slopes + cur_head)\n+    alibi_start_q = tl.arange(0, BLOCK_M) + block_start_loc + cur_batch_ctx_len\n+    alibi_start_k = cur_batch_ctx_len\n+    # # init debugger\n+    # offset_db_q = tl.arange(0, BLOCK_M) + block_start_loc\n+    # offset_db_k = tl.arange(0, BLOCK_N)\n+    # calc q[BLOCK_M, BLOCK_MODEL] mul k[prefix_len: , BLOCK_DMODEL]\n+    for start_n in range(0, block_mask * (start_m + 1) * BLOCK_M, BLOCK_N):\n+        start_n = tl.multiple_of(start_n, BLOCK_N)\n+        # -- compute qk ----\n+        k = tl.load(\n+            k_ptrs + (cur_batch_in_all_start_index + start_n) * stride_kbs,\n+            mask=dim_mask[:, None] & ((start_n + offs_n[None, :])\n+                                      < cur_batch_seq_len - cur_batch_ctx_len),\n+            other=0.0)\n+\n+        qk = tl.zeros([BLOCK_M, BLOCK_N], dtype=tl.float32)\n+        qk = tl.dot(q, k, acc=qk, input_precision='ieee')\n+        qk *= sm_scale\n+        qk = tl.where(offs_m[:, None] >= (start_n + offs_n[None, :]), qk,\n+                      float(\"-inf\"))\n+\n+        # load alibi\n+        alibi = (tl.arange(0, BLOCK_N)[None, :] + alibi_start_k -\n+                 alibi_start_q[:, None]) * alibi_slope\n+        alibi = tl.where(\n+            (alibi <= 0) & (alibi_start_q[:, None] < cur_batch_seq_len), alibi,\n+            float(\"-inf\"))\n+        qk += alibi\n+        alibi_start_k += BLOCK_N\n+\n+        # -- compute m_ij, p, l_ij\n+        m_ij = tl.max(qk, 1)\n+        m_i_new = tl.maximum(m_i, m_ij)\n+        p = tl.math.exp(qk - m_i_new[:, None])\n+        l_ij = tl.sum(p, 1)\n+        # -- update m_i and l_i\n+\n+        alpha = tl.math.exp(m_i - m_i_new)\n+        l_i_new = alpha * l_i + l_ij\n+        # -- update output accumulator --\n+        # scale p\n+        # scale acc\n+        acc_scale = alpha\n+        # acc_scale = l_i / l_i_new * alpha\n+        acc = acc * acc_scale[:, None]\n+        # update acc\n+        v = tl.load(\n+            v_ptrs + (cur_batch_in_all_start_index + start_n) * stride_vbs,\n+            mask=dim_mask[None, :] & ((start_n + offs_n[:, None])\n+                                      < cur_batch_seq_len - cur_batch_ctx_len),\n+            other=0.0)\n+        p = p.to(v.dtype)\n+\n+        acc = tl.dot(p, v, acc=acc, input_precision='ieee')\n+        # update m_i and l_i\n+        l_i = l_i_new\n+        m_i = m_i_new\n+\n+    acc = acc / l_i[:, None]\n+\n+    # initialize pointers to output\n+    off_o = ((cur_batch_in_all_start_index + offs_m[:, None]) * stride_obs +\n+             cur_head * stride_oh + offs_d[None, :] * stride_od)\n+    out_ptrs = Out + off_o\n+    tl.store(out_ptrs,\n+             acc,\n+             mask=dim_mask[None, :] &\n+             (offs_m[:, None] < cur_batch_seq_len - cur_batch_ctx_len))\n+    return\n+\n+\n+@torch.inference_mode()\n+def context_attention_fwd(q,\n+                          k,\n+                          v,\n+                          o,\n+                          kv_cache_dtype: str,\n+                          k_cache,\n+                          v_cache,\n+                          b_loc,\n+                          b_start_loc,\n+                          b_seq_len,\n+                          max_seq_len,\n+                          max_input_len,\n+                          k_scale: torch.Tensor,\n+                          v_scale: torch.Tensor,\n+                          alibi_slopes=None,\n+                          sliding_window=None,\n+                          sm_scale=None,\n+                          skip_decode=False):\n+\n+    q_dtype_is_f32 = q.dtype is torch.float32\n+\n+    # Turing does have tensor core for float32 multiplication\n+    # use ieee as fallback for triton kernels work. There is also\n+    # warning on vllm/config.py to inform users this fallback\n+    # implementation\n+    IN_PRECISION = 'ieee' if IS_TURING and q_dtype_is_f32 else None\n+\n+    # Conversion of FP8 Tensor from uint8 storage to\n+    # appropriate torch.dtype for interpretation by Triton\n+    if \"fp8\" in kv_cache_dtype:\n+        assert (k_cache.dtype == torch.uint8)\n+        assert (v_cache.dtype == torch.uint8)\n+\n+        if kv_cache_dtype in (\"fp8\", \"fp8_e4m3\"):\n+            target_dtype = current_platform.fp8_dtype()\n+        elif kv_cache_dtype == \"fp8_e5m2\":\n+            target_dtype = torch.float8_e5m2\n+        else:\n+            raise ValueError(\"Unsupported FP8 dtype:\", kv_cache_dtype)\n+\n+        k_cache = k_cache.view(target_dtype)\n+        v_cache = v_cache.view(target_dtype)\n+\n+    if (k_cache.dtype == torch.uint8\n+            or v_cache.dtype == torch.uint8 and kv_cache_dtype == \"auto\"):\n+        raise ValueError(\"kv_cache_dtype='auto' unsupported for\\\n+            FP8 KV Cache prefill kernel\")\n+\n+    # shape constraints\n+    Lq, Lk, Lv = q.shape[-1], k.shape[-1], v.shape[-1]\n+    assert Lq == Lk and Lk == Lv\n+    # round up Lk to a power of 2 - this is required for Triton block size\n+    Lk_padded = triton.next_power_of_2(Lk)\n+\n+    if sm_scale is None:\n+        sm_scale = 1.0 / (Lq**0.5)\n+    batch, head = b_seq_len.shape[0], q.shape[1]\n+    num_queries_per_kv = q.shape[1] // k.shape[1]\n+\n+    assert batch + 1 == len(b_start_loc)\n+\n+    # 0 means \"disable\"\n+    if sliding_window is None or sliding_window <= 0:\n+        sliding_window = 0\n+\n+    if alibi_slopes is not None:\n         # need to reduce num. blocks when using fp32\n         # due to increased use of GPU shared memory\n         # if q.dtype is torch.float32:\n         BLOCK = BASE_BLOCK // 2 if q_dtype_is_f32 else BASE_BLOCK\n-\n-        # Turing does have tensor core for float32 multiplication\n-        # use ieee as fallback for triton kernels work. There is also\n-        # warning on vllm/config.py to inform users this fallback\n-        # implementation\n-        IN_PRECISION = 'ieee' if IS_TURING and q_dtype_is_f32 else None\n-\n-        # Conversion of FP8 Tensor from uint8 storage to\n-        # appropriate torch.dtype for interpretation by Triton\n-        if \"fp8\" in kv_cache_dtype:\n-            assert (k_cache.dtype == torch.uint8)\n-            assert (v_cache.dtype == torch.uint8)\n-\n-            if kv_cache_dtype in (\"fp8\", \"fp8_e4m3\"):\n-                target_dtype = current_platform.fp8_dtype()\n-            elif kv_cache_dtype == \"fp8_e5m2\":\n-                target_dtype = torch.float8_e5m2\n-            else:\n-                raise ValueError(\"Unsupported FP8 dtype:\", kv_cache_dtype)\n-\n-            k_cache = k_cache.view(target_dtype)\n-            v_cache = v_cache.view(target_dtype)\n-\n-        if (k_cache.dtype == torch.uint8\n-                or v_cache.dtype == torch.uint8 and kv_cache_dtype == \"auto\"):\n-            raise ValueError(\"kv_cache_dtype='auto' unsupported for\\\n-                FP8 KV Cache prefill kernel\")\n-\n-        # shape constraints\n-        Lq, Lk, Lv = q.shape[-1], k.shape[-1], v.shape[-1]\n-        assert Lq == Lk and Lk == Lv\n-        # round up Lk to a power of 2 - this is required for Triton block size\n-        Lk_padded = triton.next_power_of_2(Lk)\n-\n-        if sm_scale is None:\n-            sm_scale = 1.0 / (Lq**0.5)\n-        batch, head = b_seq_len.shape[0], q.shape[1]\n-        num_queries_per_kv = q.shape[1] // k.shape[1]\n-\n-        assert batch + 1 == len(b_start_loc)\n-        grid = (batch, head, triton.cdiv(max_input_len, BLOCK))  # batch, head,\n-\n-        # 0 means \"disable\"\n-        if sliding_window is None or sliding_window <= 0:\n-            sliding_window = 0\n-\n-        if alibi_slopes is not None:\n-            _fwd_kernel_alibi[grid](\n-                q,\n-                k,\n-                v,\n-                k_cache,\n-                v_cache,\n-                b_loc,\n-                sm_scale,\n-                k_scale,\n-                v_scale,\n-                b_start_loc,\n-                b_seq_len,\n-                alibi_slopes,\n-                v_cache.shape[3],\n-                k_cache.shape[4],\n-                o,\n-                b_loc.stride(0),\n-                b_loc.stride(1),\n-                q.stride(0),\n-                q.stride(1),\n-                q.stride(2),\n-                k.stride(0),\n-                k.stride(1),\n-                k.stride(2),\n-                v.stride(0),\n-                v.stride(1),\n-                v.stride(2),\n-                o.stride(0),\n-                o.stride(1),\n-                o.stride(2),\n-                k_cache.stride(0),\n-                k_cache.stride(1),\n-                k_cache.stride(2),\n-                k_cache.stride(3),\n-                k_cache.stride(\n-                    4\n-                ),  #[num_blocks, num_kv_heads, head_size/x, block_size, x]\n-                v_cache.stride(0),\n-                v_cache.stride(1),\n-                v_cache.stride(2),\n-                v_cache.stride(\n-                    3),  #[num_blocks, num_kv_heads, head_size, block_size]\n-                num_queries_per_kv=num_queries_per_kv,\n-                IN_PRECISION=IN_PRECISION,\n-                BLOCK_M=BLOCK,\n-                BLOCK_DMODEL=Lk,\n-                BLOCK_DMODEL_PADDED=Lk_padded,\n-                BLOCK_N=BLOCK,\n-                SKIP_DECODE=skip_decode,\n-                num_warps=NUM_WARPS,\n-                num_stages=1,\n-            )\n-            return\n-\n-        _fwd_kernel[grid](\n+        # batch, head,\n+        grid = (batch, head, triton.cdiv(max_input_len, BLOCK))\n+        _fwd_kernel_alibi[grid](\n             q,\n             k,\n             v,\n@@ -852,6 +799,7 @@ if triton.__version__ >= \"2.1.0\":\n             v_scale,\n             b_start_loc,\n             b_seq_len,\n+            alibi_slopes,\n             v_cache.shape[3],\n             k_cache.shape[4],\n             o,\n@@ -886,9 +834,69 @@ if triton.__version__ >= \"2.1.0\":\n             BLOCK_DMODEL=Lk,\n             BLOCK_DMODEL_PADDED=Lk_padded,\n             BLOCK_N=BLOCK,\n-            SLIDING_WINDOW=sliding_window,\n             SKIP_DECODE=skip_decode,\n             num_warps=NUM_WARPS,\n             num_stages=1,\n         )\n         return\n+\n+    max_seq_len = 0 if max_seq_len is None else max_seq_len\n+    extra_kargs = {}\n+    if current_platform.is_rocm():\n+        extra_kargs = {\"kpack\": 2, \"waves_per_eu\": 2}\n+\n+    grid = lambda META: (batch, head,\n+                         triton.cdiv(max_input_len, META[\"BLOCK_M\"]))\n+    _fwd_kernel[grid](\n+        q,\n+        k,\n+        v,\n+        k_cache,\n+        v_cache,\n+        b_loc,\n+        sm_scale,\n+        k_scale,\n+        v_scale,\n+        b_start_loc,\n+        b_seq_len,\n+        k_cache.shape[4],\n+        o,\n+        b_loc.stride(0),\n+        b_loc.stride(1),\n+        q.stride(0),\n+        q.stride(1),\n+        q.stride(2),\n+        k.stride(0),\n+        k.stride(1),\n+        k.stride(2),\n+        v.stride(0),\n+        v.stride(1),\n+        v.stride(2),\n+        o.stride(0),\n+        o.stride(1),\n+        o.stride(2),\n+        k_cache.stride(0),\n+        k_cache.stride(1),\n+        k_cache.stride(2),\n+        k_cache.stride(3),\n+        k_cache.stride(\n+            4),  #[num_blocks, num_kv_heads, head_size/x, block_size, x]\n+        v_cache.stride(0),\n+        v_cache.stride(1),\n+        v_cache.stride(2),\n+        v_cache.stride(3),  #[num_blocks, num_kv_heads, head_size, block_size]\n+        BLOCK_SIZE=v_cache.shape[3],\n+        num_queries_per_kv=num_queries_per_kv,\n+        IN_PRECISION=IN_PRECISION,\n+        BLOCK_DMODEL=Lk,\n+        BLOCK_DMODEL_PADDED=Lk_padded,\n+        SLIDING_WINDOW=sliding_window,\n+        SKIP_DECODE=skip_decode,\n+        BLOCK_M=128,\n+        BLOCK_N=64,\n+        num_unroll_cache=4,\n+        num_unroll_request=1,\n+        num_warps=4,\n+        num_stages=1,\n+        **extra_kargs)\n+    return", "apis": ["vllm.attention.ops.prefix_prefill.context_attention_fwd"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/prefix_prefill.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/layer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/layer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit makes extensive modifications to the production code in the source file \"vllm/attention/ops/prefix_prefill.py\" (in addition to minor test adjustment in a test file) and the extensive changes include rewriting kernels with new autotuning configs and parameter adjustments for the main attention computation. The changes are clearly aimed at speeding up the prefix prefill operation (which is a key performance component) by reconfiguring and tuning the kernel parameters. This is a non-trivial performance optimization change rather than a mere bug fix, refactor, or documentation update. The improvements target CPU performance and affect a high-level API in the repo. Therefore, all the conditions for a performance/optimization commit are satisfied.", "llm_api_reason": "This commit modifies both a test file and key parts of the Triton kernels in the prefix prefill implementation. In the test file the â€œblock_sizeâ€ parameter is updated from 8 to 16, while in the vllm/attention/ops/prefix_prefill.py file several Tritonâ€kernel functions (_fwd_kernel, _fwd_kernel_flash_attn_v2, and _fwd_kernel_alibi) are modified to improve performance (especially for ROCM) and adjust autotuning parameters. Ultimately, the publicly exposed API â€œcontext_attention_fwdâ€ (decorated with @torch.inference_mode()) is affected, since it calls into these modified kernels. Other functions are internal helpers and are not considered highâ€level APIs, so the affected API is the context_attention_fwd entry point in the prefix_prefill module."}
{"commit_hash": "299ebb62b269ce167eb1c71b5e39a1dc1f65ce1c", "pr_url": "https://github.com/vllm-project/vllm/pull/16436", "pr_date": "2025-04-10", "timeline_text": "Copy link Contributor chanh commented Apr 10, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This code inside apply_penalties does advanced indexing on a tensor which triggers nonzero which requires a CPU sync currently with PyTorch. With torch.cuda.set_sync_debug_mode(\"warn\") PyTorch framework confirms this: /home/coder/vllm/venv/lib/python3.10/site-packages/torch/cuda/__init__.py:1067: UserWarning: Synchronization debug mode is a prototype feature and does not yet detect all synchronizing operations (Triggered internally at /pytorch/torch/csrc/cuda/Module.cpp:915.)\n  torch._C._cuda_set_sync_debug_mode(debug_mode)\n/home/coder/vllm/vllm/model_executor/layers/utils.py:52: UserWarning: called a synchronizing CUDA operation (Triggered internally at /pytorch/c10/cuda/CUDAFunctions.cpp:152.)\n  logits[logits > 0] /= torch.where(prompt_mask | output_mask,\n/home/coder/vllm/vllm/model_executor/layers/utils.py:54: UserWarning: called a synchronizing CUDA operation (Triggered internally at /pytorch/c10/cuda/CUDAFunctions.cpp:152.)\n  logits[logits <= 0] *= torch.where(prompt_mask | output_mask,\n/home/coder/vllm/vllm/v1/worker/gpu_model_runner.py:1153: UserWarning: called a synchronizing CUDA operation (Triggered internally at /pytorch/c10/cuda/CUDAFunctions.cpp:152.)\n  valid_sampled_token_ids = sampled_token_ids.tolist() This seems to be a known issue and was encountered here: pytorch/pytorch#12461 nonzero that is called in this conversion has a legitimate synchronization - it is necessary to pass the information from the device about how many non-zero elements were found in the boolean index tensor, as this information would be later required on the cpu, to resize the index tensor, and to configure launch parameters/kernel arguments for subsequent kernels. I'm not sure this sync can be avoided, because if mask comes as a result of an operation on the GPU, CPU has no way of getting the number of nonzeros in the mask, which is objectively needed. By refactoring the code to avoid the indexing, we can remove the sync and allow much more of the sampling phase CPU work to overlap with the forward pass on the GPU, providing an 8% speedup to decoding for smaller models. Before: ============ Serving Benchmark Result ============\nSuccessful requests:                     100       \nBenchmark duration (s):                  103.22    \nTotal input tokens:                      100000    \nTotal generated tokens:                  10000     \nRequest throughput (req/s):              0.97      \nOutput token throughput (tok/s):         96.88     \nTotal Token throughput (tok/s):          1065.73   \n---------------Time to First Token----------------\nMean TTFT (ms):                          37.21     \nMedian TTFT (ms):                        32.09     \nP99 TTFT (ms):                           71.54     \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          6.74      \nMedian TPOT (ms):                        6.67      \nP99 TPOT (ms):                           7.20      \n---------------Inter-token Latency----------------\nMean ITL (ms):                           6.74      \nMedian ITL (ms):                         6.69      \nP99 ITL (ms):                            7.93      \n================================================== After: ============ Serving Benchmark Result ============\nSuccessful requests:                     100       \nBenchmark duration (s):                  103.17    \nTotal input tokens:                      100000    \nTotal generated tokens:                  10000     \nRequest throughput (req/s):              0.97      \nOutput token throughput (tok/s):         96.93     \nTotal Token throughput (tok/s):          1066.19   \n---------------Time to First Token----------------\nMean TTFT (ms):                          35.62     \nMedian TTFT (ms):                        30.71     \nP99 TTFT (ms):                           60.89     \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          6.18      \nMedian TPOT (ms):                        6.11      \nP99 TPOT (ms):                           6.50      \n---------------Inter-token Latency----------------\nMean ITL (ms):                           6.18      \nMedian ITL (ms):                         6.12      \nP99 ITL (ms):                            7.43      \n================================================== Benchmark: VLLM_FLASH_ATTN_VERSION=3 VLLM_USE_V1=1 vllm serve Qwen/Qwen2.5-1.5B-Instruct --enable-prefix-caching --dtype float16 --disable-log-requests -O3\n\nvllm bench serve \\\n        --model Qwen/Qwen2.5-1.5B-Instruct \\\n        --request-rate 1 \\\n        --num-prompts 100 \\\n        --random-input-len 1000 \\\n        --random-output-len 100 \\\n        --tokenizer Qwen/Qwen2.5-1.5B-Instruct \\\n        --ignore-eos Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 3 njhill, houseroad, and WoosukKwon reacted with thumbs up emoji ðŸ‘€ 1 mgoin reacted with eyes emoji All reactions ðŸ‘ 3 reactions ðŸ‘€ 1 reaction Chanh Nguyen added 2 commits April 10, 2025 21:17 Fix penalties function causing CUDA sync â€¦ a319ec0 Signed-off-by: Chanh Nguyen <cnguyen@linkedin.com> Fix penalties function causing CUDA sync â€¦ cab436d Signed-off-by: Chanh Nguyen <cnguyen@linkedin.com> Copy link github-actions bot commented Apr 10, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . chanh marked this pull request as ready for review April 11, 2025 04:12 Merge branch 'main' into cnguyen/penalties dff03c5 chanh changed the title Speed up decode by remove synchronizing operation in sampler [Core] Speed up decode by remove synchronizing operation in sampler Apr 18, 2025 WoosukKwon self-assigned this Apr 21, 2025 WoosukKwon approved these changes Apr 21, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @chanh Sorry for the late review. This is really great! Nice optimization! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Apr 21, 2025 WoosukKwon enabled auto-merge (squash) April 21, 2025 16:28 Hide details View details WoosukKwon merged commit 299ebb6 into vllm-project : main Apr 21, 2025 61 checks passed Uh oh! There was an error while loading. Please reload this page . frieda-huang pushed a commit\n        to frieda-huang/vllm\n      that referenced\n      this pull request Apr 23, 2025 [Core] Speed up decode by remove synchronizing operation in sampler ( vâ€¦ â€¦ cdcb192 â€¦llm-project#16436 )\n\nSigned-off-by: Chanh Nguyen <cnguyen@linkedin.com>\nCo-authored-by: Chanh Nguyen <cnguyen@linkedin.com>\nSigned-off-by: Frieda (Jingying) Huang <jingyingfhuang@gmail.com> jikunshang pushed a commit\n        to jikunshang/vllm\n      that referenced\n      this pull request Apr 29, 2025 [Core] Speed up decode by remove synchronizing operation in sampler ( vâ€¦ â€¦ 69e7495 â€¦llm-project#16436 )\n\nSigned-off-by: Chanh Nguyen <cnguyen@linkedin.com>\nCo-authored-by: Chanh Nguyen <cnguyen@linkedin.com> lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 [Core] Speed up decode by remove synchronizing operation in sampler ( vâ€¦ â€¦ 603d269 â€¦llm-project#16436 )\n\nSigned-off-by: Chanh Nguyen <cnguyen@linkedin.com>\nCo-authored-by: Chanh Nguyen <cnguyen@linkedin.com> adobrzyn pushed a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Apr 30, 2025 [Core] Speed up decode by remove synchronizing operation in sampler ( vâ€¦ â€¦ 56cdbf0 â€¦llm-project#16436 )\n\nSigned-off-by: Chanh Nguyen <cnguyen@linkedin.com>\nCo-authored-by: Chanh Nguyen <cnguyen@linkedin.com>\nSigned-off-by: Agata Dobrzyniewicz <adobrzyniewicz@habana.ai> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [Core] Speed up decode by remove synchronizing operation in sampler ( vâ€¦ â€¦ 375f86a â€¦llm-project#16436 )\n\nSigned-off-by: Chanh Nguyen <cnguyen@linkedin.com>\nCo-authored-by: Chanh Nguyen <cnguyen@linkedin.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> ckhordiasma mentioned this pull request May 14, 2025 nm vllm ent 0.8.5 sync red-hat-data-services/vllm#139 Merged minpeter pushed a commit\n        to minpeter/vllm\n      that referenced\n      this pull request Jun 24, 2025 [Core] Speed up decode by remove synchronizing operation in sampler ( vâ€¦ â€¦ cd510d8 â€¦llm-project#16436 )\n\nSigned-off-by: Chanh Nguyen <cnguyen@linkedin.com>\nCo-authored-by: Chanh Nguyen <cnguyen@linkedin.com>\nSigned-off-by: minpeter <kali2005611@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:17", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, TTFT | SERVING: vllm serve, Serving, Serving | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:51:17", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "vllm bench serve --model Qwen/Qwen2.5-1.5B-Instruct --request-rate 1 --num-prompts 100 --random-input-len 1000 --random-output-len 100 --tokenizer Qwen/Qwen2.5-1.5B-Instruct --ignore-eos", "commit_subject": "[Core] Speed up decode by remove synchronizing operation in sampler (#16436)", "commit_message": "[Core] Speed up decode by remove synchronizing operation in sampler (#16436)\n\nSigned-off-by: Chanh Nguyen <cnguyen@linkedin.com>\nCo-authored-by: Chanh Nguyen <cnguyen@linkedin.com>", "commit_date": "2025-04-21T18:18:22Z", "files_changed": ["vllm/model_executor/layers/utils.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 13, "num_non_test_edited_lines": 13, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/utils.py b/vllm/model_executor/layers/utils.py\nindex a9ef97391..5e56be061 100644\n--- a/vllm/model_executor/layers/utils.py\n+++ b/vllm/model_executor/layers/utils.py\n@@ -47,10 +47,15 @@ def apply_penalties(logits: torch.Tensor, prompt_tokens_tensor: torch.Tensor,\n         output_tokens_tensor, vocab_size, num_seqs)\n     repetition_penalties = repetition_penalties.unsqueeze(dim=1).repeat(\n         1, vocab_size)\n-    logits[logits > 0] /= torch.where(prompt_mask | output_mask,\n-                                      repetition_penalties, 1.0)[logits > 0]\n-    logits[logits <= 0] *= torch.where(prompt_mask | output_mask,\n-                                       repetition_penalties, 1.0)[logits <= 0]\n+\n+    # If token appears in prompt or output, apply, otherwise use 1.0 for no-op.\n+    penalties = torch.where(prompt_mask | output_mask, repetition_penalties,\n+                            1.0)\n+\n+    # If logits are positive, divide by penalty, otherwise multiply by penalty.\n+    scaling = torch.where(logits > 0, 1.0 / penalties, penalties)\n+    logits *= scaling\n+\n     # We follow the definition in OpenAI API.\n     # Refer to https://platform.openai.com/docs/api-reference/parameter-details\n     logits -= frequency_penalties.unsqueeze(dim=1) * output_bin_counts", "apis": ["vllm.model_executor.layers.utils.apply_penalties"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_completion.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file and changes the core mathematical operations in the decode process. The transformation in the code replaces two separate element-wise operations (division and multiplication) with a single multiplication by a scaling factor computed in a more consolidated manner. The commit message clearly indicates that its goal is to â€œSpeed up decode,â€ meaning it's intended to optimize performance. Although it does not explicitly mention performance in the patch diff, the commit message and the nature of the change (refactoring how the logits are scaled) are directly performance-related and affect the high-level decode function, making it testable on CPU. Thus, the changes satisfy the conditions for a performance or optimization related commit.", "llm_api_reason": "The commit modifies the core logic of penalty application in the function that adjusts logits. Instead of performing separate division and multiplication operations based on whether the logits are positive or not, it now computes a penalty tensor (using a torch.where) and then determines a unified scaling factor (again via torch.where) that is applied directly to the logits. This change aims to reduce synchronizing operations in the sampler and boost decode speed."}
{"commit_hash": "3092375e274e9e003961e600e10a6192d33ceaa0", "pr_url": "https://github.com/vllm-project/vllm/pull/16432", "pr_date": "2025-04-10", "timeline_text": "Copy link Contributor p88h commented Apr 10, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . FIX #16185 ( link existing issues this PR will resolve ) This is a rebase of #16279 which had too entangled commits. Implements additional handling of MultimodalKwargs on top of #13790 Further improves memory usage on top of improvements in #16273 by another 50% Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 ywang96 and DarkLight1337 reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions p88h requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners April 10, 2025 21:02 Copy link github-actions bot commented Apr 10, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Apr 10, 2025 p88h force-pushed the serialize-multimodal-kwargs branch\n    from 3268c77 to 43d87ec Compare April 10, 2025 21:15 p88h mentioned this pull request Apr 10, 2025 [V1][Performance] Implement custom serializaton for MultiModalKwargs #16279 Closed p88h force-pushed the serialize-multimodal-kwargs branch\n    from 43d87ec to f4832a7 Compare April 10, 2025 21:41 Copy link Member ywang96 commented Apr 10, 2025 @p88h This is amazing! Have you tried running some benchmarks to see the throughput performance impact of this PR? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author p88h commented Apr 10, 2025 @ywang96 I've added a benchmark table to the linked bug #16185 My benchmark focused on memory performance rather than throughput, and only used a single model.  It should not really change throughput that much other than in cases that do run into memory issues, though. I'll try running some throughput checks tomorrow All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . njhill reviewed Apr 10, 2025 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks @p88h ! I think this looks good. The main thing I think is to add custom serialization for the field . And we'll probably want to add a few more comments since it's tightly coupled with the custom tensor encoding format. Also, I haven't looked closely at the entire flow, but in the case of MMKs created from items, it might make sense to defer the population of their data (via the \"reduce\" operations). Since that will be repeated in the receiving process and causes extra cpu and mem overhead since tensors may get stacked etc. It would be nice if there was a way for this to happen lazily but I guess that depends on how the data is later accessed. cc @ywang96 @DarkLight1337 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . tests/v1/test_serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Member njhill commented Apr 11, 2025 Also, I haven't looked closely at the entire flow, but in the case of MMKs created from items, it might make sense to defer the population of their data (via the \"reduce\" operations). Since that will be repeated in the receiving process and causes extra cpu and mem overhead since tensors may get stacked etc. It would be nice if there was a way for this to happen lazily but I guess that depends on how the data is later accessed. FYI I've opened another PR to help with this: #16440 . It should in theory help all of the cases not just the multi-proc case. It would still be additionally beneficial to postpone doing this reduce operation until after being transferred to the engine though. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . DarkLight1337 reviewed Apr 11, 2025 View reviewed changes tests/v1/test_serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . xtknight mentioned this pull request Apr 11, 2025 [Performance]: MultiModalKwargs serialization has significant impact on E2E latency (w/ proof-of-concept patch) #16461 Closed 1 task Copy link Contributor Author p88h commented Apr 11, 2025 I have some experimental data with this PR in place. Interestingly it performs much better with zero-copy disabled In this new benchmark,` I am feeding gradually increasing document sets to the engine. Turns out custom serialization helps less than expected - I think previously it was augmented by the cache, but now all files are unique so results are a bit different. The 'mix' performance case measures running all prompts together (15 total, with 128 images total) after they have been initially processed one-by-one, so it's expected that it's performing much better / cached. config / benchmark case       | 4 images | 8 images | 16 images | 32 images | t.max | t.mix\n------------------------------+----------+----------+-----------+-----------+-------+-------\nbaseline (zero-copy disabled) | 3.55 GB  | 5.11 GB  | 9.96 GB   | 22.54 GB  | 90.4s | 44.1s\nbaseline (zero-copy enabled)  | 3.50 GB  | 5.01 GB  | 9.87 GB   | 22.56 GB  | 75.3s | 39.4s\n#16432 (zero-copy enabled)    | 3.40 GB  | 4.75 GB  | 8.53 GB   | 22.02 GB  | 13.8s | 36.1s\n#16432 (zero-copy disabled)   | 3.28 GB  | 3.95 GB  | 4.76 GB   | 5.85 GB   | 14.4s | 36.3s All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . p88h force-pushed the serialize-multimodal-kwargs branch\n    from d56435a to 408f36b Compare April 11, 2025 12:03 mergify bot added documentation Improvements or additions to documentation ci/build tpu Related to Google TPUs labels Apr 11, 2025 p88h and others added 4 commits April 11, 2025 14:04 Implement efficient serialization of MultiModalKwargs â€¦ 7b6b7ba In addition to serializing base Tensors, this now allows to pass\nTensors embedded in MultiModalKwargs correctly.\n\nHandles both V0 and V1 style args.\n\nImproves memory usage with large multimodal payloads by a further\n50% (but still not on par with single-threaded behavior).\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com> Apply suggestions from code review â€¦ 4bdd16e Co-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Staszek Pasko <staszek@gmail.com> Additional fixes after code review â€¦ e5931af Signed-off-by: Staszek Pasko <staszek@gmail.com> Fix some broken bits & reformat â€¦ 6641584 Signed-off-by: Staszek Pasko <staszek@gmail.com> p88h force-pushed the serialize-multimodal-kwargs branch\n    from 408f36b to 6641584 Compare April 11, 2025 12:05 mergify bot removed\n  the tpu Related to Google TPUs label Apr 11, 2025 Add custom support for MultiModalFieldConfig, less pickle â€¦ a94df99 Signed-off-by: Staszek Pasko <staszek@gmail.com> mergify bot added\n  the multi-modality Related to multi-modality (#4194) label Apr 11, 2025 45 hidden items Load moreâ€¦ p88h added 2 commits April 16, 2025 07:33 Merge branch 'vllm-project:main' into serialize-multimodal-kwargs d7cb694 style â€¦ 7511262 Signed-off-by: Staszek Pasko <staszek@gmail.com> p88h requested a review\n  from njhill April 16, 2025 09:39 Merge branch 'vllm-project:main' into serialize-multimodal-kwargs 97188e6 njhill reviewed Apr 16, 2025 View reviewed changes vllm/v1/serial_utils.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . remove unnecessary comment â€¦ 48ab2d9 Signed-off-by: Staszek Pasko <staszek@gmail.com> p88h requested a review\n  from njhill April 16, 2025 15:00 njhill approved these changes Apr 16, 2025 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for the great work @p88h ! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 1 p88h reacted with hooray emoji All reactions ðŸŽ‰ 1 reaction njhill added ready ONLY add when PR is ready to merge/full CI is needed performance Performance-related issues labels Apr 16, 2025 p88h force-pushed the serialize-multimodal-kwargs branch\n    from 1f2779a to 48ab2d9 Compare April 16, 2025 19:35 Merge branch 'vllm-project:main' into serialize-multimodal-kwargs a60333e Copy link Member njhill commented Apr 16, 2025 Looks like a CI test is failing - but unfortunately the root cause is obscured (the OOM failure of the subsequent test is a result of improper cleanup after the original failure). This should hopefully be addressed by #11737 . In the meantime I can try running this test locally. p.s. there's no need to keep rebasing on latest main, this just causes all the tests to start over. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Accommodate floats in NestedTensors â€¦ 281f0f1 Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Member njhill commented Apr 16, 2025 It turns out it was because sometimes MMKwargs can contain non-tensor data (specifically \"second_per_grid_ts\": [1.0] in this case). So I pushed an update to allow floats and ints too. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details njhill merged commit 3092375 into vllm-project : main Apr 17, 2025 42 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author p88h commented Apr 17, 2025 Thank you ! I was about to go back to debugging this morning ;) ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . lionelvillard pushed a commit\n        to lionelvillard/vllm\n      that referenced\n      this pull request Apr 17, 2025 [V1][Performance] Implement custom serializaton for MultiModalKwargs â€¦ â€¦ c2df8d3 â€¦[Rebased] ( vllm-project#16432 )\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com> DarkLight1337 mentioned this pull request Apr 17, 2025 [Bug]: Unable to deploy Qwen2.5-VL-3B-Instruct  after updating vLLM to latest version #16791 Closed 1 task p88h mentioned this pull request Apr 17, 2025 [Bug]: Mistral 3.1 Small Image inference is broken on 0.8.4 #16675 Closed 1 task njhill mentioned this pull request Apr 18, 2025 [BugFix] Support bf16 in zero-copy tensor serialization #16860 Closed p88h deleted the serialize-multimodal-kwargs branch April 18, 2025 20:22 yangw-dev pushed a commit\n        to yangw-dev/vllm\n      that referenced\n      this pull request Apr 21, 2025 [V1][Performance] Implement custom serializaton for MultiModalKwargs â€¦ â€¦ 2f35558 â€¦[Rebased] ( vllm-project#16432 )\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Yang Wang <elainewy@meta.com> DarkLight1337 mentioned this pull request Apr 28, 2025 [Feature]: Performance issue, when using Qwen2.5-VL-32B-Instruct model for multi graph inference #17297 Closed 1 task jikunshang pushed a commit\n        to jikunshang/vllm\n      that referenced\n      this pull request Apr 29, 2025 [V1][Performance] Implement custom serializaton for MultiModalKwargs â€¦ â€¦ 6fcc767 â€¦[Rebased] ( vllm-project#16432 )\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com> lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 [V1][Performance] Implement custom serializaton for MultiModalKwargs â€¦ â€¦ 365538f â€¦[Rebased] ( vllm-project#16432 )\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com> adobrzyn pushed a commit\n        to HabanaAI/vllm-fork\n      that referenced\n      this pull request Apr 30, 2025 [V1][Performance] Implement custom serializaton for MultiModalKwargs â€¦ â€¦ 0c1294a â€¦[Rebased] ( vllm-project#16432 )\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Agata Dobrzyniewicz <adobrzyniewicz@habana.ai> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [V1][Performance] Implement custom serializaton for MultiModalKwargs â€¦ â€¦ f09c519 â€¦[Rebased] ( vllm-project#16432 )\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> ckhordiasma mentioned this pull request May 14, 2025 nm vllm ent 0.8.5 sync red-hat-data-services/vllm#139 Merged Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:22", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: throughput, throughput, throughput | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:51:22", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][Performance] Implement custom serializaton for MultiModalKwargs [Rebased] (#16432)", "commit_message": "[V1][Performance] Implement custom serializaton for MultiModalKwargs [Rebased] (#16432)\n\nSigned-off-by: Staszek Pasko <staszek@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>", "commit_date": "2025-04-16T19:28:32-07:00", "files_changed": ["tests/v1/test_serial_utils.py", "vllm/envs.py", "vllm/v1/serial_utils.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 0, "num_files": 3, "num_hunks": 12, "num_edited_lines": 218, "num_non_test_edited_lines": 119, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/test_serial_utils.py b/tests/v1/test_serial_utils.py\nindex bc0e0cbd8..e58d3c403 100644\n--- a/tests/v1/test_serial_utils.py\n+++ b/tests/v1/test_serial_utils.py\n@@ -1,10 +1,16 @@\n # SPDX-License-Identifier: Apache-2.0\n from collections import UserDict\n from dataclasses import dataclass\n+from typing import Optional\n \n+import msgspec\n import numpy as np\n import torch\n \n+from vllm.multimodal.inputs import (MultiModalBatchedField,\n+                                    MultiModalFieldElem, MultiModalKwargs,\n+                                    MultiModalKwargsItem,\n+                                    MultiModalSharedField, NestedTensors)\n from vllm.v1.serial_utils import MsgpackDecoder, MsgpackEncoder\n \n \n@@ -50,7 +56,7 @@ def test_encode_decode():\n         large_non_contig_tensor=torch.rand(1024, 512)[:, 10:20],\n     )\n \n-    encoder = MsgpackEncoder()\n+    encoder = MsgpackEncoder(size_threshold=256)\n     decoder = MsgpackDecoder(MyType)\n \n     encoded = encoder.encode(obj)\n@@ -78,6 +84,97 @@ def test_encode_decode():\n     assert_equal(decoded2, obj)\n \n \n+class MyRequest(msgspec.Struct):\n+    mm: Optional[list[MultiModalKwargs]]\n+\n+\n+def test_multimodal_kwargs():\n+    d = {\n+        \"foo\":\n+        torch.zeros(20000, dtype=torch.float16),\n+        \"bar\": [torch.zeros(i * 1000, dtype=torch.int8) for i in range(3)],\n+        \"baz\": [\n+            torch.rand((256), dtype=torch.float16),\n+            [\n+                torch.rand((1, 12), dtype=torch.float32),\n+                torch.rand((3, 5, 7), dtype=torch.float64),\n+            ], [torch.rand((4, 4), dtype=torch.float16)]\n+        ],\n+    }\n+\n+    # pack mm kwargs into a mock request so that it can be decoded properly\n+    req = MyRequest(mm=[MultiModalKwargs(d)])\n+\n+    encoder = MsgpackEncoder()\n+    decoder = MsgpackDecoder(MyRequest)\n+\n+    encoded = encoder.encode(req)\n+\n+    assert len(encoded) == 6\n+\n+    total_len = sum(memoryview(x).cast(\"B\").nbytes for x in encoded)\n+\n+    # expected total encoding length, should be 44536, +-20 for minor changes\n+    assert total_len >= 44516 and total_len <= 44556\n+    decoded: MultiModalKwargs = decoder.decode(encoded).mm[0]\n+    assert all(nested_equal(d[k], decoded[k]) for k in d)\n+\n+\n+def test_multimodal_items_by_modality():\n+    e1 = MultiModalFieldElem(\"audio\", \"a0\", torch.zeros(1000,\n+                                                        dtype=torch.int16),\n+                             MultiModalBatchedField())\n+    e2 = MultiModalFieldElem(\n+        \"video\",\n+        \"v0\",\n+        [torch.zeros(1000, dtype=torch.int8) for _ in range(4)],\n+        MultiModalBatchedField(),\n+    )\n+    e3 = MultiModalFieldElem(\"image\", \"i0\", torch.zeros(1000,\n+                                                        dtype=torch.int32),\n+                             MultiModalSharedField(4))\n+    e4 = MultiModalFieldElem(\"image\", \"i1\", torch.zeros(1000,\n+                                                        dtype=torch.int32),\n+                             MultiModalBatchedField())\n+    audio = MultiModalKwargsItem.from_elems([e1])\n+    video = MultiModalKwargsItem.from_elems([e2])\n+    image = MultiModalKwargsItem.from_elems([e3, e4])\n+    mm = MultiModalKwargs.from_items([audio, video, image])\n+\n+    # pack mm kwargs into a mock request so that it can be decoded properly\n+    req = MyRequest([mm])\n+\n+    encoder = MsgpackEncoder()\n+    decoder = MsgpackDecoder(MyRequest)\n+\n+    encoded = encoder.encode(req)\n+\n+    assert len(encoded) == 8\n+\n+    total_len = sum(memoryview(x).cast(\"B\").nbytes for x in encoded)\n+\n+    # expected total encoding length, should be 14255, +-20 for minor changes\n+    assert total_len >= 14235 and total_len <= 14275\n+    decoded: MultiModalKwargs = decoder.decode(encoded).mm[0]\n+\n+    # check all modalities were recovered and do some basic sanity checks\n+    assert len(decoded.modalities) == 3\n+    images = decoded.get_items(\"image\")\n+    assert len(images) == 1\n+    assert len(images[0].items()) == 2\n+    assert list(images[0].keys()) == [\"i0\", \"i1\"]\n+\n+    # check the tensor contents and layout in the main dict\n+    assert all(nested_equal(mm[k], decoded[k]) for k in mm)\n+\n+\n+def nested_equal(a: NestedTensors, b: NestedTensors):\n+    if isinstance(a, torch.Tensor):\n+        return torch.equal(a, b)\n+    else:\n+        return all(nested_equal(x, y) for x, y in zip(a, b))\n+\n+\n def assert_equal(obj1: MyType, obj2: MyType):\n     assert torch.equal(obj1.tensor1, obj2.tensor1)\n     assert obj1.a_string == obj2.a_string\ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex f80bf878f..d32968c3d 100644\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -107,6 +107,7 @@ if TYPE_CHECKING:\n     VLLM_TPU_BUCKET_PADDING_GAP: int = 0\n     VLLM_USE_DEEP_GEMM: bool = False\n     VLLM_XGRAMMAR_CACHE_MB: int = 0\n+    VLLM_MSGPACK_ZERO_COPY_THRESHOLD: int = 256\n \n \n def get_default_cache_root():\n@@ -704,6 +705,16 @@ environment_variables: dict[str, Callable[[], Any]] = {\n     # It can be changed with this variable if needed for some reason.\n     \"VLLM_XGRAMMAR_CACHE_MB\":\n     lambda: int(os.getenv(\"VLLM_XGRAMMAR_CACHE_MB\", \"512\")),\n+\n+    # Control the threshold for msgspec to use 'zero copy' for\n+    # serialization/deserialization of tensors. Tensors below\n+    # this limit will be encoded into the msgpack buffer, and\n+    # tensors above will instead be sent via a separate message.\n+    # While the sending side still actually copies the tensor\n+    # in all cases, on the receiving side, tensors above this\n+    # limit will actually be zero-copy decoded.\n+    \"VLLM_MSGPACK_ZERO_COPY_THRESHOLD\":\n+    lambda: int(os.getenv(\"VLLM_MSGPACK_ZERO_COPY_THRESHOLD\", \"256\")),\n }\n \n # end-env-vars-definition\ndiff --git a/vllm/v1/serial_utils.py b/vllm/v1/serial_utils.py\nindex 3af6793fd..4f7987ee4 100644\n--- a/vllm/v1/serial_utils.py\n+++ b/vllm/v1/serial_utils.py\n@@ -1,5 +1,6 @@\n # SPDX-License-Identifier: Apache-2.0\n \n+import dataclasses\n import pickle\n from collections.abc import Sequence\n from inspect import isclass\n@@ -12,12 +13,26 @@ import torch\n import zmq\n from msgspec import msgpack\n \n+from vllm import envs\n+from vllm.multimodal.inputs import (BaseMultiModalField,\n+                                    MultiModalBatchedField,\n+                                    MultiModalFieldConfig, MultiModalFieldElem,\n+                                    MultiModalFlatField, MultiModalKwargs,\n+                                    MultiModalKwargsItem,\n+                                    MultiModalSharedField, NestedTensors)\n+\n CUSTOM_TYPE_PICKLE = 1\n CUSTOM_TYPE_CLOUDPICKLE = 2\n CUSTOM_TYPE_RAW_VIEW = 3\n \n-# TODO calibrate this size\n-MIN_NOCOPY_BUF_SIZE = 512\n+# MultiModalField class serialization type map.\n+# These need to list all possible field types and match them\n+# to factory methods in `MultiModalFieldConfig`.\n+MMF_CLASS_TO_FACTORY: dict[type[BaseMultiModalField], str] = {\n+    MultiModalFlatField: \"flat\",\n+    MultiModalSharedField: \"shared\",\n+    MultiModalBatchedField: \"batched\",\n+}\n \n bytestr = Union[bytes, bytearray, memoryview, zmq.Frame]\n \n@@ -27,14 +42,20 @@ class MsgpackEncoder:\n \n     Note that unlike vanilla `msgspec` Encoders, this interface is generally\n     not thread-safe when encoding tensors / numpy arrays.\n+\n+    By default, arrays below 256B are serialized inline Larger will get sent \n+    via dedicated messages. Note that this is a per-tensor limit.\n     \"\"\"\n \n-    def __init__(self):\n+    def __init__(self, size_threshold: Optional[int] = None):\n+        if size_threshold is None:\n+            size_threshold = envs.VLLM_MSGPACK_ZERO_COPY_THRESHOLD\n         self.encoder = msgpack.Encoder(enc_hook=self.enc_hook)\n         # This is used as a local stash of buffers that we can then access from\n         # our custom `msgspec` hook, `enc_hook`. We don't have a way to\n         # pass custom data to the hook otherwise.\n         self.aux_buffers: Optional[list[bytestr]] = None\n+        self.size_threshold = size_threshold\n \n     def encode(self, obj: Any) -> Sequence[bytestr]:\n         try:\n@@ -65,6 +86,25 @@ class MsgpackEncoder:\n         if isinstance(obj, np.ndarray) and obj.dtype.kind not in ('O', 'V'):\n             return self._encode_ndarray(obj)\n \n+        if isinstance(obj, MultiModalKwargs):\n+            mm: MultiModalKwargs = obj\n+            if not mm.modalities:\n+                # just return the main dict if there are no modalities.\n+                return dict(mm)\n+\n+            # ignore the main dict, it will be re-indexed.\n+            # Encode a list of MultiModalKwargsItems as plain dicts\n+            # + special handling for .field.\n+            # Any tensors *not* indexed by modality will be ignored.\n+            return [[{\n+                \"modality\": elem.modality,\n+                \"key\": elem.key,\n+                \"data\": self._encode_nested_tensors(elem.data),\n+                \"field\": self._encode_mm_field(elem.field),\n+            } for elem in item.values()]\n+                    for itemlist in mm._items_by_modality.values()\n+                    for item in itemlist]\n+\n         if isinstance(obj, FunctionType):\n             # `pickle` is generally faster than cloudpickle, but can have\n             # problems serializing methods.\n@@ -77,8 +117,9 @@ class MsgpackEncoder:\n         self, obj: np.ndarray\n     ) -> tuple[str, tuple[int, ...], Union[int, memoryview]]:\n         assert self.aux_buffers is not None\n+        # If the array is non-contiguous, we need to copy it first\n         arr_data = obj.data if obj.data.c_contiguous else obj.tobytes()\n-        if not obj.shape or obj.nbytes < MIN_NOCOPY_BUF_SIZE:\n+        if not obj.shape or obj.nbytes < self.size_threshold:\n             # Encode small arrays and scalars inline. Using this extension type\n             # ensures we can avoid copying when decoding.\n             data = msgpack.Ext(CUSTOM_TYPE_RAW_VIEW, arr_data)\n@@ -92,6 +133,26 @@ class MsgpackEncoder:\n         # backing buffers that we've stashed in `aux_buffers`.\n         return obj.dtype.str, obj.shape, data\n \n+    def _encode_nested_tensors(self, nt: NestedTensors) -> Any:\n+        if isinstance(nt, torch.Tensor):\n+            return self._encode_ndarray(nt.numpy())\n+        if isinstance(nt, (int, float)):\n+            # Although it violates NestedTensors type, MultiModalKwargs\n+            # values are sometimes floats.\n+            return nt\n+        return [self._encode_nested_tensors(x) for x in nt]\n+\n+    def _encode_mm_field(self, field: BaseMultiModalField):\n+        # Figure out the factory name for the field type.\n+        name = MMF_CLASS_TO_FACTORY.get(field.__class__)\n+        if not name:\n+            raise TypeError(f\"Unsupported field type: {field.__class__}\")\n+        # We just need to copy all of the field values in order\n+        # which will be then used to reconstruct the field.\n+        field_values = (getattr(field, f.name)\n+                        for f in dataclasses.fields(field))\n+        return name, *field_values\n+\n \n class MsgpackDecoder:\n     \"\"\"Decoder with custom torch tensor and numpy array serialization.\n@@ -126,13 +187,50 @@ class MsgpackDecoder:\n                 return self._decode_ndarray(obj)\n             if issubclass(t, torch.Tensor):\n                 return torch.from_numpy(self._decode_ndarray(obj))\n+            if issubclass(t, MultiModalKwargs):\n+                if isinstance(obj, list):\n+                    return MultiModalKwargs.from_items(\n+                        self._decode_mm_items(obj))\n+                return MultiModalKwargs({\n+                    k: self._decode_nested_tensors(v)\n+                    for k, v in obj.items()\n+                })\n         return obj\n \n     def _decode_ndarray(self, arr: Any) -> np.ndarray:\n         dtype, shape, data = arr\n-        buffer = self.aux_buffers[data] if isinstance(data, int) else data\n+        # Copy from inline representation, otherwise Torch is unhappy since\n+        # the returned memory is non-writeable.\n+        buffer = self.aux_buffers[data] if isinstance(data, int) \\\n+            else bytearray(data)\n         return np.ndarray(buffer=buffer, dtype=np.dtype(dtype), shape=shape)\n \n+    def _decode_mm_items(self, obj: list) -> list[MultiModalKwargsItem]:\n+        decoded_items = []\n+        for item in obj:\n+            elems = []\n+            for v in item:\n+                v[\"data\"] = self._decode_nested_tensors(v[\"data\"])\n+                # Reconstruct the field processor using MultiModalFieldConfig\n+                factory_meth_name, *field_args = v[\"field\"]\n+                factory_meth = getattr(MultiModalFieldConfig,\n+                                       factory_meth_name)\n+                v[\"field\"] = factory_meth(None, *field_args).field\n+                elems.append(MultiModalFieldElem(**v))\n+            decoded_items.append(MultiModalKwargsItem.from_elems(elems))\n+        return decoded_items\n+\n+    def _decode_nested_tensors(self, obj: Any) -> NestedTensors:\n+        if isinstance(obj, (int, float)):\n+            # Although it violates NestedTensors type, MultiModalKwargs\n+            # values are sometimes floats.\n+            return obj\n+        if not isinstance(obj, list):\n+            raise TypeError(f\"Unexpected NestedTensors contents: {type(obj)}\")\n+        if obj and isinstance(obj[0], str):\n+            return torch.from_numpy(self._decode_ndarray(obj))\n+        return [self._decode_nested_tensors(x) for x in obj]\n+\n     def ext_hook(self, code: int, data: memoryview) -> Any:\n         if code == CUSTOM_TYPE_RAW_VIEW:\n             return data", "apis": ["MsgpackEncoder.__init__", "MsgpackEncoder.encode", "MsgpackDecoder.decode"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/serial_utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/envs.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/multimodal/inputs.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies both test files and source code in vllm/envs.py and vllm/v1/serial_utils.py. It adds a new environment variable VLLM_MSGPACK_ZERO_COPY_THRESHOLD and uses it in the MsgpackEncoder to decide whether to inline or use zero-copy deserialization for tensors. This change alters the serialization strategy to improve performance by reducing unnecessary copies on the receiving side. The modifications are non-trivial, affect a high-level API (serialization/deserialization), and are designed for CPU performance improvements. Hence, the commit meets the criteria for being performance/optimization related.", "llm_api_reason": "The commit updates the serialization utilities in vllm/v1/serial_utils.py and adds tests for multimodal kwargs in tests/v1/test_serial_utils.py. In MsgpackEncoder, the constructor is modified to accept a size_threshold parameter (defaulting from the environment variable), and the encode() method now handles instances of MultiModalKwargs specially (i.e. it encodes its items into a list of plain dicts with extra field metadata). In MsgpackDecoder, new logic is introduced to decode MultiModalKwargs objects (using a helper method _decode_mm_items) as well as adjustments for zero-copy decoding. These changes affect the public APIs for serializing and deserializing model requests using MsgpackEncoder and MsgpackDecoder."}
{"commit_hash": "93e5f3c5fb4a4bbd49610efb96aad30df95fca66", "pr_url": "https://github.com/vllm-project/vllm/pull/16484", "pr_date": "2025-04-12", "timeline_text": "Copy link Contributor SnowCharmQ commented Apr 11, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR enhances the performance of the method _prepare_inputs in gpu_model_runner.py by replacing the original Python loop implementation with map and numpy array operations. On my clusters, it can achieve nearly a twofold performance improvement. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Optimize prepare inputs for GPU model runner 7018c25 SnowCharmQ requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners April 11, 2025 13:00 Copy link github-actions bot commented Apr 11, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Apr 11, 2025 Format code â€¦ d150bd3 Signed-off-by: snowcharm <snowcharmqq@gmail.com> njhill reviewed Apr 11, 2025 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks @SnowCharmQ , this is great! On my clusters, it can achieve nearly a twofold performance improvement. Presumably you're referring to the improvement of this loop, not end-to-end? :) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/worker/gpu_model_runner.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author SnowCharmQ commented Apr 11, 2025 Thanks @SnowCharmQ , this is great! On my clusters, it can achieve nearly a twofold performance improvement. Presumably you're referring to the improvement of this loop, not end-to-end? :) Hi @njhill , the improvement refers to the loop exactly. Sorry for the confusion :) ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Improve readability â€¦ ef6fdea Co-authored-by: Nick Hill <nhill@redhat.com> njhill added ready ONLY add when PR is ready to merge/full CI is needed performance Performance-related issues labels Apr 11, 2025 njhill approved these changes Apr 11, 2025 View reviewed changes Copy link Contributor Author SnowCharmQ commented Apr 12, 2025 Hi @njhill , I noticed an issue with the CI check. Do you have any idea what might be going wrong and how it can be resolved? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details DarkLight1337 merged commit 93e5f3c into vllm-project : main Apr 12, 2025 56 of 57 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Member DarkLight1337 commented Apr 12, 2025 I retried the test and it passes now ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . SnowCharmQ deleted the perf-runner branch April 19, 2025 08:44 yangw-dev pushed a commit\n        to yangw-dev/vllm\n      that referenced\n      this pull request Apr 21, 2025 [Perf] Optimize Preparing Inputs for GPU Model Runner ( vllm-project#1â€¦ â€¦ 17c1504 â€¦6484 )\n\nSigned-off-by: snowcharm <snowcharmqq@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Yang Wang <elainewy@meta.com> jikunshang pushed a commit\n        to jikunshang/vllm\n      that referenced\n      this pull request Apr 29, 2025 [Perf] Optimize Preparing Inputs for GPU Model Runner ( vllm-project#1â€¦ â€¦ 7b6eb48 â€¦6484 )\n\nSigned-off-by: snowcharm <snowcharmqq@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com> lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 [Perf] Optimize Preparing Inputs for GPU Model Runner ( vllm-project#1â€¦ â€¦ 3e46b61 â€¦6484 )\n\nSigned-off-by: snowcharm <snowcharmqq@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [Perf] Optimize Preparing Inputs for GPU Model Runner ( vllm-project#1â€¦ â€¦ 5e88ae2 â€¦6484 )\n\nSigned-off-by: snowcharm <snowcharmqq@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:25", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: improvement, improvement, improvement | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:51:25", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Perf] Optimize Preparing Inputs for GPU Model Runner (#16484)", "commit_message": "[Perf] Optimize Preparing Inputs for GPU Model Runner (#16484)\n\nSigned-off-by: snowcharm <snowcharmqq@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>", "commit_date": "2025-04-12T22:54:37+08:00", "files_changed": ["vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 12, "num_non_test_edited_lines": 12, "commit_year": 2025}, "diff_text": "diff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 0e70d77e1..70e8bd75e 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -484,14 +484,10 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         self.input_batch.block_table.commit(num_reqs)\n \n         # Get the number of scheduled tokens for each request.\n-        # TODO: The Python loop can be slow. Optimize.\n-        num_scheduled_tokens = np.empty(num_reqs, dtype=np.int32)\n-        max_num_scheduled_tokens = 0\n-        for i, req_id in enumerate(self.input_batch.req_ids):\n-            num_tokens = scheduler_output.num_scheduled_tokens[req_id]\n-            num_scheduled_tokens[i] = num_tokens\n-            max_num_scheduled_tokens = max(max_num_scheduled_tokens,\n-                                           num_tokens)\n+        req_ids = self.input_batch.req_ids\n+        tokens = [scheduler_output.num_scheduled_tokens[i] for i in req_ids]\n+        num_scheduled_tokens = np.array(tokens, dtype=np.int32)\n+        max_num_scheduled_tokens = max(tokens)\n \n         # Get request indices.\n         # E.g., [2, 5, 3] -> [0, 0, 1, 1, 1, 1, 1, 2, 2, 2]", "apis": ["vllm.v1.worker.gpu_model_runner.GPUModelRunner._prepare_inputs"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file (gpu_model_runner.py) by replacing a Python loop with a list comprehension and numpy array conversion to prepare token inputs. This change is non-trivial and targets the performance of the data preparation stage, which runs on the CPU even though it is part of the GPU model runner. The commit message multiplies performance implications and the change optimizes a CPU-bound operation without being specific to only one hardware type. Therefore, it satisfies the performance/optimization conditions.", "llm_api_reason": "This commit optimizes the way GPUModelRunner prepares input tokens by replacing an explicit Python loop with a list comprehension and a call to np.array, which results in faster computation of the number of scheduled tokens and the maximum scheduled token count. This change affects the internal method responsible for preparing inputs in the GPUModelRunner."}
{"commit_hash": "bd6028d6b0bbc0c569ece0535067081c5e8bdc14", "pr_url": "https://github.com/vllm-project/vllm/pull/16512", "pr_date": "2025-04-12", "timeline_text": "Copy link Member mgoin commented Apr 11, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Clear speedup for latency case, adapted from sgl-project/sglang@ 86a876d (thank you!) Llama Scout FP8 on 2xH100, input/output=1000/1000 batch_size=1 # benchmark\npython benchmarks/benchmark_latency.py --model RedHatAI/Llama-4-Scout-17B-16E-Instruct-FP8-dynamic --max-model-len 8000 --tensor-parallel-size 2 --input-len 1000 --output-len 1000 --batch-size 1 --num-iters-warmup 5 --num-iters 5 \n\n# torch.topk\nAvg latency: 12.93838309822604 seconds\n10% percentile latency: 12.891319572227076 seconds\n25% percentile latency: 12.904249292099848 seconds\n50% percentile latency: 12.921604027971625 seconds\n75% percentile latency: 12.932637538062409 seconds\n90% percentile latency: 13.00348993963562 seconds\n99% percentile latency: 13.046001380579547 seconds\n\n# fast_topk\nAvg latency: 12.725665437569841 seconds\n10% percentile latency: 12.664348530210555 seconds\n25% percentile latency: 12.665923552820459 seconds\n50% percentile latency: 12.72062187595293 seconds\n75% percentile latency: 12.734881401993334 seconds\n90% percentile latency: 12.800113665964455 seconds\n99% percentile latency: 12.839253024347126 seconds Llama Scout FP8 on 2xH100, input/output=1000/1000 batch_size=32 # benchmark\npython benchmarks/benchmark_latency.py --model RedHatAI/Llama-4-Scout-17B-16E-Instruct-FP8-dynamic --max-model-len 8000 --tensor-parallel-size 2 --input-len 1000 --output-len 1000 --batch-size 32 --num-iters-warmup 3 --num-iters 3\n\n# torch.topk\nAvg latency: 23.997261434715863 seconds\n10% percentile latency: 23.722837531426922 seconds\n25% percentile latency: 23.844304106081836 seconds\n50% percentile latency: 24.04674839717336 seconds\n75% percentile latency: 24.174962244578637 seconds\n90% percentile latency: 24.251890553021802 seconds\n99% percentile latency: 24.298047538087705 seconds\n\n# fast_topk\nAvg latency: 23.815591983729973 seconds\n10% percentile latency: 23.6753818389494 seconds\n25% percentile latency: 23.733925551641732 seconds\n50% percentile latency: 23.831498406128958 seconds\n75% percentile latency: 23.905211627017707 seconds\n90% percentile latency: 23.949439559550957 seconds\n99% percentile latency: 23.975976319070906 seconds Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 1 yeqcharlotte reacted with hooray emoji All reactions ðŸŽ‰ 1 reaction Optimized topk for topk=1 (Llama-4) â€¦ a22a82d Signed-off-by: mgoin <mgoin64@gmail.com> Copy link github-actions bot commented Apr 11, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . njhill approved these changes Apr 11, 2025 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Wow, nice! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member njhill commented Apr 11, 2025 @mgoin could we use this for other moes too? e.g. in https://github.com/vllm-project/vllm/blob/main/vllm/model_executor/layers/fused_moe/fused_moe.py#L886 ? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author mgoin commented Apr 11, 2025 @njhill unfortunately most other moes do not use a topk=1 AFAIK, but maybe the overhead is minimal enough to use just in case ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin added performance Performance-related issues ready ONLY add when PR is ready to merge/full CI is needed labels Apr 12, 2025 houseroad approved these changes Apr 12, 2025 View reviewed changes Copy link Collaborator houseroad left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Oh, nice trick. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details DarkLight1337 merged commit bd6028d into vllm-project : main Apr 12, 2025 64 checks passed Uh oh! There was an error while loading. Please reload this page . yangw-dev pushed a commit\n        to yangw-dev/vllm\n      that referenced\n      this pull request Apr 21, 2025 Optimized topk for topk=1 (Llama-4) ( vllm-project#16512 ) â€¦ 751844d Signed-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Yang Wang <elainewy@meta.com> jikunshang pushed a commit\n        to jikunshang/vllm\n      that referenced\n      this pull request Apr 29, 2025 Optimized topk for topk=1 (Llama-4) ( vllm-project#16512 ) â€¦ e6bca68 Signed-off-by: mgoin <mgoin64@gmail.com> lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 Optimized topk for topk=1 (Llama-4) ( vllm-project#16512 ) â€¦ ef7a8ef Signed-off-by: mgoin <mgoin64@gmail.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 Optimized topk for topk=1 (Llama-4) ( vllm-project#16512 ) â€¦ 7987452 Signed-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:28", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: latency, latency, latency | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:51:28", "models": ["RedHatAI/Llama-4-Scout-17B-16E-Instruct-FP8-dynamic"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=RedHatAI/Llama-4-Scout-17B-16E-Instruct-FP8-dynamic,tensor_parallel_size=2 --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_latency.py --model RedHatAI/Llama-4-Scout-17B-16E-Instruct-FP8-dynamic --max-model-len 8000 --tensor-parallel-size 2 --input-len 1000 --output-len 1000 --batch-size 1 --num-iters-warmup 5 --num-iters 5", "commit_subject": "Optimized topk for topk=1 (Llama-4) (#16512)", "commit_message": "Optimized topk for topk=1 (Llama-4) (#16512)\n\nSigned-off-by: mgoin <mgoin64@gmail.com>", "commit_date": "2025-04-12T14:21:08+08:00", "files_changed": ["vllm/model_executor/models/llama4.py", "vllm/model_executor/models/utils.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 3, "num_edited_lines": 13, "num_non_test_edited_lines": 13, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/models/llama4.py b/vllm/model_executor/models/llama4.py\nindex 8785e9dcf..51efbfe20 100644\n--- a/vllm/model_executor/models/llama4.py\n+++ b/vllm/model_executor/models/llama4.py\n@@ -37,7 +37,7 @@ from vllm.model_executor.layers.rotary_embedding import get_rope\n from vllm.model_executor.model_loader.weight_utils import default_weight_loader\n \n from .llama import LlamaForCausalLM, LlamaMLP, LlamaModel\n-from .utils import (AutoWeightsLoader, extract_layer_index,\n+from .utils import (AutoWeightsLoader, extract_layer_index, fast_topk,\n                     is_pp_missing_parameter)\n \n \n@@ -50,7 +50,7 @@ class Llama4MoE(nn.Module):\n         topk: int,\n         renormalize: bool,\n     ) -> Tuple[torch.Tensor, torch.Tensor]:\n-        router_scores, router_indices = torch.topk(gating_output, topk, dim=-1)\n+        router_scores, router_indices = fast_topk(gating_output, topk, dim=-1)\n         router_scores = torch.sigmoid(router_scores.float()).to(\n             hidden_states.dtype)\n         return (router_scores, router_indices.to(torch.int32))\ndiff --git a/vllm/model_executor/models/utils.py b/vllm/model_executor/models/utils.py\nindex f197434f3..7ed0560ee 100644\n--- a/vllm/model_executor/models/utils.py\n+++ b/vllm/model_executor/models/utils.py\n@@ -703,3 +703,12 @@ def cast_overflow_tensors(\n         clamp_value = torch.finfo(tensors.dtype).max - offset\n         tensors = torch.clamp(tensors, min=-clamp_value, max=clamp_value)\n     return tensors\n+\n+\n+def fast_topk(values, topk, dim):\n+    if topk == 1:\n+        # Use max along the specified dimension to get both value and index\n+        return torch.max(values, dim=dim, keepdim=True)\n+    else:\n+        # Use topk for efficiency with larger k values\n+        return torch.topk(values, topk, dim=dim)", "apis": ["vllm.model_executor.models.llama4.Llama4MoE.custom_routing_function", "vllm.model_executor.models.utils.fast_topk"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/llama4.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/adapter_commons/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/multimodal/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/profiler/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/online_serving/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/kernels/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/benchmarks/cutlass_benchmarks/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/structured_output/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/model_loader/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/benchmarks/lib/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/punica_wrapper/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/sched/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/distributed/kv_transfer/kv_connector/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/tool_parsers/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/ops/triton_ops/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/quark/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/compressed_tensors/utils.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/llama.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit introduces an alternative implementation for the topk functionality, where for the case topk==1 it uses torch.max (which is generally faster) instead of torch.topk. This change is applied to non-test source code files (llama4.py and utils.py) and is not a mere refactoring or documentation update; rather, it replaces a function call with a more optimized version that improves the performance of a core API call. The modification affects CPU performance and is testable without GPU, fulfilling the performance optimization criteria.", "llm_api_reason": "The commit updates the Llama-4 implementation by switching the routing function in Llama4MoE to use a custom â€œfast_topkâ€ routine instead of directly calling torch.topk. It adds an optimized topk function (fast_topk) in the models/utils.py file, which returns torch.max when topk==1 and falls back to torch.topk otherwise. This change improves efficiency for the common case of topk=1 in Llama-4."}
{"commit_hash": "b10e51989551cd80dd74079429ccf91f0807bd92", "pr_url": "https://github.com/vllm-project/vllm/pull/16135", "pr_date": "2025-04-06", "timeline_text": "Copy link Collaborator WoosukKwon commented Apr 6, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Minor optimizations Avoid redundant dictionary lookups cached_block_hash_to_block[block_hash] Avoid creating a list by using next Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions WoosukKwon added 2 commits April 6, 2025 11:11 [V1][Minor] Optimize get_cached_block â€¦ 94d9874 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Avoid creating list â€¦ 05a922a Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon requested review from robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners April 6, 2025 18:19 Copy link github-actions bot commented Apr 6, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Apr 6, 2025 WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Apr 6, 2025 njhill approved these changes Apr 6, 2025 View reviewed changes comaniac approved these changes Apr 6, 2025 View reviewed changes comaniac enabled auto-merge (squash) April 6, 2025 19:06 Hide details View details comaniac merged commit b10e519 into main Apr 6, 2025 61 checks passed Uh oh! There was an error while loading. Please reload this page . comaniac deleted the minor-cache-opt branch April 6, 2025 20:48 lengrongfu pushed a commit\n        to lengrongfu/vllm\n      that referenced\n      this pull request Apr 7, 2025 [V1][Minor] Optimize get_cached_block ( vllm-project#16135 ) 5aaddbc yangw-dev pushed a commit\n        to yangw-dev/vllm\n      that referenced\n      this pull request Apr 21, 2025 [V1][Minor] Optimize get_cached_block ( vllm-project#16135 ) â€¦ eeeccf2 Signed-off-by: Yang Wang <elainewy@meta.com> lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 [V1][Minor] Optimize get_cached_block ( vllm-project#16135 ) ff21ef5 RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [V1][Minor] Optimize get_cached_block ( vllm-project#16135 ) â€¦ 3d2f574 Signed-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:31", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:51:31", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][Minor] Optimize get_cached_block (#16135)", "commit_message": "[V1][Minor] Optimize get_cached_block (#16135)", "commit_date": "2025-04-06T20:48:14Z", "files_changed": ["vllm/v1/core/block_pool.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 10, "num_non_test_edited_lines": 10, "commit_year": 2025}, "diff_text": "diff --git a/vllm/v1/core/block_pool.py b/vllm/v1/core/block_pool.py\nindex 43f30f710..74f3f7852 100644\n--- a/vllm/v1/core/block_pool.py\n+++ b/vllm/v1/core/block_pool.py\n@@ -67,11 +67,11 @@ class BlockPool:\n         Returns:\n             The cached block if it exists, or None.\n         \"\"\"\n-        if block_hash in self.cached_block_hash_to_block:\n-            first_block_id = list(\n-                self.cached_block_hash_to_block[block_hash].keys())[0]\n-            return self.cached_block_hash_to_block[block_hash][first_block_id]\n-        return None\n+        cached_blocks = self.cached_block_hash_to_block.get(block_hash)\n+        if not cached_blocks:\n+            return None\n+        first_block_id = next(iter(cached_blocks))\n+        return cached_blocks[first_block_id]\n \n     def cache_full_blocks(\n         self,", "apis": ["vllm.v1.core.block_pool.BlockPool.get_cached_block"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/core/block_pool.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/request.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/adapter_commons/request.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/lora/request.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/structured_output/request.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test source file and replaces a method used to retrieve a cached block. Instead of building a list of keys and then extracting the first element, it now uses next(iter(...)) directly. Although the commit message includes the term \"Optimize\" and the change is minor, the intention is to improve the performance of the get_cached_block function by reducing unnecessary overhead in list construction. This qualifies as a performance optimization affecting a core API that runs on the CPU and is testable without specific hardware. Therefore, this commit meets the criteria for a performance/optimization-related change.", "llm_api_reason": "This commit optimizes the implementation of the get_cached_block method in the BlockPool class. The new code replaces explicit key lookup and list conversion with a more concise approach using the dictionaryâ€™s get() method and next(iter(...)). This change improves readability and potentially performance when retrieving a cached block."}
{"commit_hash": "35fad35a485eac9195c510731ba4a9d297dfd963", "pr_url": "https://github.com/vllm-project/vllm/pull/15478", "pr_date": "2025-03-26", "timeline_text": "Copy link Member njhill commented Mar 25, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . When there's top-k in the batch but no top-p. For 128k vocab, 1024 batch size, 500 ops on A100, where max top k is 10: Before: 11.571 sec After: 2.136 sec Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [V1][Sampler] Faster top-k only implementation â€¦ bcee0c4 Signed-off-by: Nick Hill <nhill@redhat.com> njhill requested review from WoosukKwon , robertgshaw2-redhat , ywang96 , comaniac and alexm-redhat as code owners March 25, 2025 15:43 Copy link github-actions bot commented Mar 25, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Mar 25, 2025 njhill mentioned this pull request Mar 25, 2025 [V1][TPU] Speed up top-k on TPU by using torch.topk #15242 Merged njhill commented Mar 25, 2025 View reviewed changes vllm/v1/sample/ops/topk_topp_sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . NickLucche approved these changes Mar 25, 2025 View reviewed changes Copy link Contributor NickLucche left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Tested on TPU this won't work out of the box due to some broadcasting issue. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Also in-place cumsum for top-p â€¦ 7156150 Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Member Author njhill commented Mar 25, 2025 @NickLucche that's strange. Which op has that issue? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor NickLucche commented Mar 25, 2025 Not too surprising, torch xla has more constraining rules on broadcasting. This is the first error I have encountered F0325 16:28:32.957930 1304047 debug_macros.h:21] Non-OK-status: status.status()\nStatus: INVALID_ARGUMENT: Input dimension should be either 1 or equal to the output dimension it is broadcasting into; the 0th operand dimension is 4, the 0th output dimension is 1.\n*** Begin stack trace ***\n\ttsl::CurrentStackTrace[abi:cxx11]()\n\txla::Shape const* ConsumeValue<xla::Shape const*>(absl::lts_20230802::StatusOr<xla::Shape const*>&&)\n\ttorch_xla::ShapeHelper::ShapeOfXlaOp(xla::XlaOp)\n\ttorch_xla::InferOutputShape(absl::lts_20230802::Span<xla::Shape const>, std::function<xla::XlaOp (absl::lts_20230802::Span<xla::XlaOp const>)> const&)\n\t\n\t\n\ttorch_xla::XlaNode::GetOpShape(std::function<xla::Shape ()> const&) const\n\ttorch_xla::XlaNode::XlaNode(torch::lazy::OpKind, c10::ArrayRef<torch::lazy::Value>, std::function<xla::Shape ()> const&, unsigned long, torch::lazy::hash_t)\n\ttorch_xla::Gather::Gather(torch::lazy::Value const&, long, torch::lazy::Value const&)\n\tstd::shared_ptr<torch::lazy::Node> torch_xla::MakeNode<torch_xla::Gather, torch::lazy::Value, long&, torch::lazy::Value>(torch::lazy::Value&&, long&, torch::lazy::Value&&)\n\ttorch_xla::tensor_methods::gather(c10::intrusive_ptr<torch_xla::XLATensor, c10::detail::intrusive_target_default_null_type<torch_xla::XLATensor> > const&, long, c10::intrusive_ptr<torch_xla::XLATensor, c10::detail::intrusive_target_default_null_type<torch_xla::XLATensor> > const&)\n\ttorch_xla::XLANativeFunctions::gather(at::Tensor const&, long, at::Tensor const&, bool)\n\t\n\t\n\tat::_ops::gather::redispatch(c10::DispatchKeySet, at::Tensor const&, long, at::Tensor const&, bool)\n\t\n\t\n\tat::_ops::gather::call(at::Tensor const&, long, at::Tensor const&, bool) on the .gather op. I expanded k but then ran into another issue. ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon reviewed Mar 25, 2025 View reviewed changes vllm/v1/sample/ops/topk_topp_sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Add comments â€¦ 1feffb0 Signed-off-by: Nick Hill <nhill@redhat.com> WoosukKwon reviewed Mar 25, 2025 View reviewed changes vllm/v1/sample/ops/topk_topp_sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/sample/ops/topk_topp_sampler.py @@ -138,8 +138,25 @@ def apply_top_k_top_p( This function sorts the logits tensor, which can be slow for large batches. \"\"\" if k is None and p is None: if p is None: if k is None: Copy link Collaborator WoosukKwon Mar 25, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do we have a unit test checking the correctness of this? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author njhill Mar 26, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment We should really have blanket coverage for this kind of thing, including different combinations of parameters (i.e. top-k with/without top-p etc.). I'm not sure whether we do though. I will check and add a unit test to compare the two impls. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Add comments about in-place logits updates. â€¦ be9e5d7 Signed-off-by: Nick Hill <nhill@redhat.com> NickLucche suggested changes Mar 26, 2025 View reviewed changes Copy link Contributor NickLucche left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I tested this version again today and it's working on TPU too, nice one @njhill thanks! I was wondering could we still factor-out this topk opt into its own function so I can call it from TPU side? We agreed with @WoosukKwon to try and keep things separated, I'd like to keep forward_tpu around. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor NickLucche commented Mar 26, 2025 Something like a5bf849 #diff-6047245d864bf5fd68b5b947b735beca94723bad40d20bfc0803d9b3eea5c1edR121-R136 . Wdyt? Of course I'd wait for this PR to land and then rebase, I've shamelessly just copy-pasted your code there. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . NickLucche mentioned this pull request Mar 26, 2025 [V1][TPU] Enable Top K #15489 Merged njhill added 2 commits March 26, 2025 07:17 Add test â€¦ c09dd00 Signed-off-by: Nick Hill <nhill@redhat.com> Move to separate function per @NickLucche 's request â€¦ e47f5b9 Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Member Author njhill commented Mar 26, 2025 Thanks @NickLucche , I've split into separate function. And @WoosukKwon I've added a correctness test. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . njhill added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 26, 2025 WoosukKwon approved these changes Mar 26, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Thanks for addressing my comments. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details njhill merged commit 35fad35 into vllm-project : main Mar 26, 2025 39 checks passed Uh oh! There was an error while loading. Please reload this page . njhill deleted the torch-topk branch March 26, 2025 17:56 hyeygit mentioned this pull request Mar 30, 2025 [V1][TPU] TPU-optimized top-p implementation (avoids scattering). #15736 Merged Copy link Contributor hyeygit commented Mar 30, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @njhill really neat idea to threshold the logits! However I think one corner case where this would break is if there are duplicate elements in the logit that equal the cut off value (i.e. top_k_mask ). For example, given an input of [1, 2, 2, 2, 3] and k=3 , the current apply_top_k_only would return [-inf, 2, 2, 2, 3] while the correct result should be [-inf, -inf, 2, 2, 3] . In #15736 I use a similar thresholding logic for top-p, but introduced a small random perturbation to break the ties. Maybe the same idea can be used here for top-k as well. ðŸ‘ 1 NickLucche reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . NickLucche mentioned this pull request Apr 1, 2025 [Core] Optimize topp/topk calculation in sampler #12156 Closed Alex4210987 pushed a commit\n        to LeiWang1999/vllm-bitblas\n      that referenced\n      this pull request Apr 5, 2025 [V1][Sampler] Faster top-k only implementation ( vllm-project#15478 ) â€¦ 0e57df7 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: xinyuxiao <xinyuxiao2024@gmail.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [V1][Sampler] Faster top-k only implementation ( vllm-project#15478 ) â€¦ c116565 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 [V1][Sampler] Faster top-k only implementation ( vllm-project#15478 ) â€¦ 2b30424 Signed-off-by: Nick Hill <nhill@redhat.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [V1][Sampler] Faster top-k only implementation ( vllm-project#15478 ) â€¦ eaded4b Signed-off-by: Nick Hill <nhill@redhat.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [V1][Sampler] Faster top-k only implementation ( vllm-project#15478 ) â€¦ c7eb537 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:35", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: Faster, Faster, Faster | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:51:35", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][Sampler] Faster top-k only implementation (#15478)", "commit_message": "[V1][Sampler] Faster top-k only implementation (#15478)\n\nSigned-off-by: Nick Hill <nhill@redhat.com>", "commit_date": "2025-03-26T10:56:47-07:00", "files_changed": ["tests/v1/sample/test_topk_topp_sampler.py", "vllm/v1/sample/ops/topk_topp_sampler.py", "vllm/v1/sample/sampler.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 0, "num_files": 3, "num_hunks": 7, "num_edited_lines": 96, "num_non_test_edited_lines": 59, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/sample/test_topk_topp_sampler.py b/tests/v1/sample/test_topk_topp_sampler.py\nnew file mode 100644\nindex 000000000..8a5076412\n--- /dev/null\n+++ b/tests/v1/sample/test_topk_topp_sampler.py\n@@ -0,0 +1,37 @@\n+# SPDX-License-Identifier: Apache-2.0\n+import torch\n+from torch import Generator\n+\n+from vllm.v1.sample.ops.topk_topp_sampler import apply_top_k_top_p\n+\n+DEVICE = \"cuda\"\n+\n+BATCH_SIZE = 1024\n+VOCAB_SIZE = 128 * 1024\n+\n+\n+def test_topk_impl_equivalance():\n+\n+    with torch.device(DEVICE):\n+        generator = Generator(device=DEVICE).manual_seed(33)\n+\n+        logits = torch.rand((BATCH_SIZE, VOCAB_SIZE), generator=generator)\n+\n+        # Random top-k values between 1 and 9.\n+        k = torch.randint(1, 10, (BATCH_SIZE, ), generator=generator)\n+\n+        # Set k=vocab_size for ~50% of requests in the batch (top-k disabled).\n+        k.masked_fill_(\n+            torch.randint(0,\n+                          2, (BATCH_SIZE, ),\n+                          generator=generator,\n+                          dtype=bool), VOCAB_SIZE)\n+\n+        # Top-k only implementation\n+        result1 = apply_top_k_top_p(logits=logits.clone(), k=k, p=None)\n+\n+        # Top-p + top-k\n+        no_op_top_p = torch.tensor([1.0])\n+        result2 = apply_top_k_top_p(logits=logits.clone(), k=k, p=no_op_top_p)\n+\n+        assert torch.allclose(result1, result2)\ndiff --git a/vllm/v1/sample/ops/topk_topp_sampler.py b/vllm/v1/sample/ops/topk_topp_sampler.py\nindex 1dea71187..5dfcae08b 100644\n--- a/vllm/v1/sample/ops/topk_topp_sampler.py\n+++ b/vllm/v1/sample/ops/topk_topp_sampler.py\n@@ -19,6 +19,12 @@ except ImportError:\n \n \n class TopKTopPSampler(nn.Module):\n+    \"\"\"\n+    Module that performs optional top-k and top-p filtering followed by\n+    weighted random sampling of logits.\n+\n+    Implementations may update the logits tensor in-place.\n+    \"\"\"\n \n     def __init__(self):\n         super().__init__()\n@@ -84,7 +90,11 @@ class TopKTopPSampler(nn.Module):\n         k: Optional[torch.Tensor],\n         p: Optional[torch.Tensor],\n     ) -> torch.Tensor:\n-        \"\"\"PyTorch-native implementation of top-k and top-p sampling.\"\"\"\n+        \"\"\"\n+        PyTorch-native implementation of top-k and top-p sampling.\n+\n+        The logits tensor may be updated in-place.\n+        \"\"\"\n         logits = apply_top_k_top_p(logits, k, p)\n         probs = logits.softmax(dim=-1, dtype=torch.float32)\n         return random_sample(probs, generators)\n@@ -136,10 +146,18 @@ def apply_top_k_top_p(\n ) -> torch.Tensor:\n     \"\"\"Apply top-k and top-p masks to the logits.\n \n-    This function sorts the logits tensor, which can be slow for large batches.\n+    If a top-p is used, this function will sort the logits tensor,\n+    which can be slow for large batches.\n+\n+    The logits tensor may be updated in-place.\n     \"\"\"\n-    if k is None and p is None:\n-        return logits\n+    if p is None:\n+        if k is None:\n+            return logits\n+\n+        # Avoid sorting vocab for top-k only case.\n+        return apply_top_k_only(logits, k)\n+\n     logits_sort, logits_idx = logits.sort(dim=-1, descending=False)\n \n     if k is not None:\n@@ -153,7 +171,7 @@ def apply_top_k_top_p(\n     if p is not None:\n         # Apply top-p.\n         probs_sort = logits_sort.softmax(dim=-1)\n-        probs_sum = probs_sort.cumsum(dim=-1)\n+        probs_sum = torch.cumsum(probs_sort, dim=-1, out=probs_sort)\n         top_p_mask = probs_sum <= 1 - p.unsqueeze(dim=1)\n         # at least one\n         top_p_mask[:, -1] = False\n@@ -164,6 +182,31 @@ def apply_top_k_top_p(\n     return logits\n \n \n+def apply_top_k_only(\n+    logits: torch.Tensor,\n+    k: torch.Tensor,\n+) -> torch.Tensor:\n+    \"\"\"\n+    Apply top-k mask to the logits.\n+\n+    This implementation doesn't involve sorting the entire vocab.\n+\n+    The logits tensor may be updated in-place.\n+    \"\"\"\n+    no_top_k_mask = k == logits.shape[1]\n+    # Set non-top-k rows to 1 so that we can gather.\n+    k = k.masked_fill(no_top_k_mask, 1)\n+    max_top_k = k.max()\n+    # topk.values tensor has shape [batch_size, max_top_k].\n+    # Convert top k to 0-based index in range [0, max_top_k).\n+    k_index = k.sub_(1).unsqueeze(1)\n+    top_k_mask = logits.topk(max_top_k, dim=1).values.gather(1, k_index)\n+    # Handle non-topk rows.\n+    top_k_mask.masked_fill_(no_top_k_mask.unsqueeze(1), -float(\"inf\"))\n+    logits.masked_fill_(logits < top_k_mask, -float(\"inf\"))\n+    return logits\n+\n+\n def random_sample(\n     probs: torch.Tensor,\n     generators: dict[int, torch.Generator],\ndiff --git a/vllm/v1/sample/sampler.py b/vllm/v1/sample/sampler.py\nindex 397a049dc..004f98496 100644\n--- a/vllm/v1/sample/sampler.py\n+++ b/vllm/v1/sample/sampler.py\n@@ -87,6 +87,12 @@ class Sampler(nn.Module):\n         logits: torch.Tensor,\n         sampling_metadata: SamplingMetadata,\n     ) -> torch.Tensor:\n+        \"\"\"Sample logits based on sampling metadata.\n+\n+        The various logits processing functions called in this method\n+        may update the logits tensor in-place.\n+        \"\"\"\n+\n         assert not (sampling_metadata.all_greedy\n                     and sampling_metadata.all_random)\n         if sampling_metadata.all_random:", "apis": ["vllm.v1.sample.ops.topk_topp_sampler.apply_top_k_top_p", "vllm.v1.sample.ops.topk_topp_sampler.apply_top_k_only", "vllm.v1.sample.ops.topk_topp_sampler.TopKTopPSampler.forward_native", "vllm.v1.sample.sampler.Sampler.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/ops/topk_topp_sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit introduces a faster top-k only implementation by adding a new function (\"apply_top_k_only\") that avoids sorting the entire vocabulary, which is a costly operation. This change directly affects a core sampling function, making it more efficient. The modifications are made in source code files (vllm/v1/sample/ops/topk_topp_sampler.py and vllm/v1/sample/sampler.py) and are not limited to tests or documentation. While the commit message mentions \"Faster\", it directly implements performance improvement rather than just refactoring or renaming functions, and it impacts high-level API performance without being hardware specific. Therefore, the commit is performance/optimization related.", "llm_api_reason": "This commit improves the performance of top-k sampling by adding a specialized â€œtop-k onlyâ€ implementation. It updates the apply_top_k_top_p function to bypass an expensive sort when only top-k filtering is needed and introduces a new helper function, apply_top_k_only, that directly applies the top-k mask without sorting the whole vocabulary. In addition, the docstrings in TopKTopPSampler and the Sampler layer are enhanced to reflect that the logits tensor may be updated in-place. These changes affect the sampling API functions that process and transform logits before token selection."}
{"commit_hash": "9d72daf4ced05a5fec1ad8ea2914a39296f402da", "pr_url": "https://github.com/vllm-project/vllm/pull/15156", "pr_date": "2025-03-24", "timeline_text": "Copy link Member njhill commented Mar 19, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Queue operations showed up when profiling high qps. Since we coalesce RequestOutput objects, we don't need to use an actual queue. This changes to merge the outputs when added rather than when removed. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [V1][Perf] Simpler request output queues â€¦ e852802 Since we coalesce RequestOutput objects we don't need to use an actual queue.\n\nThis changes to merge the outputs when added rather than when removed.\n\nSigned-off-by: Nick Hill <nhill@redhat.com> njhill requested review from WoosukKwon , robertgshaw2-redhat , ywang96 , comaniac and alexm-redhat as code owners March 19, 2025 19:57 Copy link github-actions bot commented Mar 19, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Mar 19, 2025 njhill mentioned this pull request Mar 19, 2025 [BugFix][V1] Fix parallel sampling finishing/aborts #14512 Merged njhill added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 19, 2025 houseroad reviewed Mar 21, 2025 View reviewed changes vllm/v1/engine/output_processor.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented Mar 21, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @njhill . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Mar 21, 2025 houseroad reviewed Mar 21, 2025 View reviewed changes Copy link Collaborator houseroad left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Looks good to me. Wondering if we should have some e2e test? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Merge remote-tracking branch 'origin/main' into queueless-output â€¦ 8fe1e45 Signed-off-by: Nick Hill <nhill@redhat.com>\n\n# Conflicts:\n#\tvllm/v1/engine/async_llm.py\n#\tvllm/v1/engine/llm_engine.py\n#\tvllm/v1/engine/parallel_sampling.py mergify bot removed\n  the needs-rebase label Mar 21, 2025 comaniac approved these changes Mar 21, 2025 View reviewed changes Copy link Collaborator comaniac left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM. Only a nit. A unit test is definitely nice to have. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/v1/engine/output_processor.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . njhill added\n  the needs-tests Tests needed for this PR label Mar 24, 2025 robertgshaw2-redhat reviewed Mar 24, 2025 View reviewed changes vllm/v1/engine/output_processor.py else: self.output = output async def get(self) -> RequestOutput: Copy link Collaborator robertgshaw2-redhat Mar 24, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do you think we should have an invariant that output is not None if self.ready.wait() is true? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author njhill Mar 24, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment That is the case but I'm not sure what you're suggesting to add here? self.ready.wait() just waits for the condition to be set, it can only ever return True (not even sure why it returns that rather than None ). And then we immediately check self.output again before continuing. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions robertgshaw2-redhat and others added 4 commits March 24, 2025 17:47 added unit test â€¦ 47e611d Signed-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com> removed stray file â€¦ af4e13b Signed-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com> updated â€¦ 7382f62 Signed-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com> Merge pull request #5 from robertgshaw2-redhat/add-test â€¦ 12b2758 added unit test njhill removed\n  the needs-tests Tests needed for this PR label Mar 24, 2025 njhill added 2 commits March 24, 2025 11:18 Update docstring with more detail â€¦ 639386c Signed-off-by: Nick Hill <nhill@redhat.com> Merge remote-tracking branch 'refs/remotes/origin/main' into queuelesâ€¦ â€¦ 4612dc5 â€¦s-output Copy link Member Author njhill commented Mar 24, 2025 Thanks for adding a test @robertgshaw2-redhat ! This should be good to merge now once the CI finishes. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat enabled auto-merge (squash) March 24, 2025 19:28 Copy link Collaborator robertgshaw2-redhat commented Mar 24, 2025 Looks good to me. Wondering if we should have some e2e test? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . robertgshaw2-redhat closed this Mar 24, 2025 auto-merge was automatically disabled March 24, 2025 19:29 Pull request was closed robertgshaw2-redhat reopened this Mar 24, 2025 robertgshaw2-redhat enabled auto-merge (squash) March 24, 2025 19:30 Hide details View details robertgshaw2-redhat merged commit 9d72daf into vllm-project : main Mar 24, 2025 36 of 38 checks passed Uh oh! There was an error while loading. Please reload this page . njhill deleted the queueless-output branch March 24, 2025 22:44 erictang000 pushed a commit\n        to erictang000/vllm\n      that referenced\n      this pull request Mar 25, 2025 [V1][Perf] Simpler request output queues ( vllm-project#15156 ) â€¦ 4739656 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nCo-authored-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com> wrmedford pushed a commit\n        to wrmedford/vllm\n      that referenced\n      this pull request Mar 26, 2025 [V1][Perf] Simpler request output queues ( vllm-project#15156 ) â€¦ e13c5d5 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nCo-authored-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nSigned-off-by: Wes Medford <wryanmedford@gmail.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [V1][Perf] Simpler request output queues ( vllm-project#15156 ) â€¦ e5e7849 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nCo-authored-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed lk-chen pushed a commit\n        to lk-chen/vllm\n      that referenced\n      this pull request Apr 29, 2025 [V1][Perf] Simpler request output queues ( vllm-project#15156 ) â€¦ 6a3df39 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nCo-authored-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [V1][Perf] Simpler request output queues ( vllm-project#15156 ) â€¦ 7dcaa26 Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nCo-authored-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [V1][Perf] Simpler request output queues ( vllm-project#15156 ) â€¦ 048639f Signed-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nCo-authored-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:38", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: qps, profiling | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:51:38", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][Perf] Simpler request output queues (#15156)", "commit_message": "[V1][Perf] Simpler request output queues (#15156)\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>\nCo-authored-by: rshaw@neuralmagic.com <robertgshaw2@gmail.com>", "commit_date": "2025-03-24T22:44:08Z", "files_changed": ["tests/v1/engine/test_output_processor.py", "vllm/v1/engine/async_llm.py", "vllm/v1/engine/output_processor.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 0, "num_files": 3, "num_hunks": 12, "num_edited_lines": 171, "num_non_test_edited_lines": 82, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/engine/test_output_processor.py b/tests/v1/engine/test_output_processor.py\nindex 388f7f45e..9ac42dbc3 100644\n--- a/tests/v1/engine/test_output_processor.py\n+++ b/tests/v1/engine/test_output_processor.py\n@@ -11,11 +11,13 @@ from tests.v1.engine.utils import (NUM_PROMPT_LOGPROBS_UNDER_TEST,\n                                    STOP_STRINGS,\n                                    DummyOutputProcessorTestVectors,\n                                    MockEngineCore)\n+from vllm.outputs import CompletionOutput, RequestOutput\n from vllm.sampling_params import RequestOutputKind, SamplingParams\n from vllm.sequence import PromptLogprobs, SampleLogprobs\n from vllm.transformers_utils.tokenizer import AnyTokenizer\n from vllm.v1.engine import EngineCoreRequest\n-from vllm.v1.engine.output_processor import OutputProcessor\n+from vllm.v1.engine.output_processor import (OutputProcessor,\n+                                             RequestOutputCollector)\n from vllm.v1.metrics.stats import IterationStats\n \n \n@@ -834,3 +836,88 @@ def test_iteration_stats(dummy_test_vectors):\n \n     assert iteration_stats.num_prompt_tokens == 0\n     assert iteration_stats.num_generation_tokens == num_active\n+\n+\n+@pytest.mark.asyncio\n+async def test_request_output_collector():\n+    NUM_REQS = 3\n+    TEXT = \"a\"\n+\n+    def make_outputs() -> list[RequestOutput]:\n+        return [\n+            RequestOutput(\n+                request_id=\"my-request-id\",\n+                prompt=None,\n+                prompt_token_ids=[1, 2, 3],\n+                prompt_logprobs=None,\n+                outputs=[\n+                    CompletionOutput(\n+                        index=0,\n+                        text=TEXT,\n+                        token_ids=[idx],\n+                        cumulative_logprob=(idx + 1 * 1.0),\n+                        logprobs=[{\n+                            \"a\": idx,\n+                            \"b\": idx\n+                        }],\n+                        finish_reason=\"length\" if\n+                        (idx == NUM_REQS - 1) else None,\n+                    )\n+                ],\n+                finished=(idx == NUM_REQS - 1),\n+            ) for idx in range(NUM_REQS)\n+        ]\n+\n+    collector = RequestOutputCollector(RequestOutputKind.DELTA)\n+\n+    # CASE 1: Put then get.\n+    outputs = make_outputs()\n+    collector.put(outputs[0])\n+    output = await collector.get()\n+    assert not collector.ready.is_set()\n+    assert collector.output is None\n+    assert output.outputs[0].text == \"a\"\n+    assert output.outputs[0].token_ids == [0]\n+\n+    # CASE 2: 2 puts then get.\n+    num_to_put = 2\n+    outputs = make_outputs()\n+    for i in range(num_to_put):\n+        collector.put(outputs[i])\n+    output = await collector.get()\n+    assert not collector.ready.is_set()\n+    assert collector.output is None\n+\n+    assert not output.finished\n+    # Text, token_ids, and logprobs should get merged.\n+    assert output.outputs[0].text == TEXT * num_to_put\n+    for tok_0, tok_1 in zip(output.outputs[0].token_ids,\n+                            list(range(num_to_put))):\n+        assert tok_0 == tok_1\n+    assert len(output.outputs[0].logprobs) == num_to_put\n+\n+    # Cumulative logprobs should be the last one.\n+    cumulative_logprob_expected = 1.0 * num_to_put\n+    assert output.outputs[0].cumulative_logprob == cumulative_logprob_expected\n+\n+    # CASE 3: Put all 3 (including a finished).\n+    num_to_put = 3\n+    outputs = make_outputs()\n+    for i in range(num_to_put):\n+        collector.put(outputs[i])\n+    output = await collector.get()\n+    assert not collector.ready.is_set()\n+    assert collector.output is None\n+\n+    assert output.finished\n+    assert output.outputs[0].finish_reason == \"length\"\n+    # Text, token_ids, and logprobs should get merged.\n+    assert output.outputs[0].text == TEXT * num_to_put\n+    for tok_0, tok_1 in zip(output.outputs[0].token_ids,\n+                            list(range(num_to_put))):\n+        assert tok_0 == tok_1\n+    assert len(output.outputs[0].logprobs) == num_to_put\n+\n+    # Cumulative logprobs should be the last one.\n+    cumulative_logprob_expected = 1.0 * num_to_put\n+    assert output.outputs[0].cumulative_logprob == cumulative_logprob_expected\ndiff --git a/vllm/v1/engine/async_llm.py b/vllm/v1/engine/async_llm.py\nindex e0169f1a4..3a6811db3 100644\n--- a/vllm/v1/engine/async_llm.py\n+++ b/vllm/v1/engine/async_llm.py\n@@ -21,14 +21,15 @@ from vllm.lora.request import LoRARequest\n from vllm.outputs import RequestOutput\n from vllm.pooling_params import PoolingParams\n from vllm.prompt_adapter.request import PromptAdapterRequest\n-from vllm.sampling_params import RequestOutputKind, SamplingParams\n+from vllm.sampling_params import SamplingParams\n from vllm.transformers_utils.tokenizer import AnyTokenizer\n from vllm.transformers_utils.tokenizer_group import init_tokenizer_from_configs\n from vllm.usage.usage_lib import UsageContext\n from vllm.utils import Device, cdiv, kill_process_tree\n from vllm.v1.engine import EngineCoreRequest\n from vllm.v1.engine.core_client import EngineCoreClient\n-from vllm.v1.engine.output_processor import OutputProcessor\n+from vllm.v1.engine.output_processor import (OutputProcessor,\n+                                             RequestOutputCollector)\n from vllm.v1.engine.parallel_sampling import ParentRequest\n from vllm.v1.engine.processor import Processor\n from vllm.v1.executor.abstract import Executor\n@@ -176,11 +177,14 @@ class AsyncLLM(EngineClient):\n         trace_headers: Optional[Mapping[str, str]] = None,\n         prompt_adapter_request: Optional[PromptAdapterRequest] = None,\n         priority: int = 0,\n-    ) -> asyncio.Queue[RequestOutput]:\n+    ) -> RequestOutputCollector:\n         \"\"\"Add new request to the AsyncLLM.\"\"\"\n \n-        # Create a new output queue for the request.\n-        queue: asyncio.Queue[RequestOutput] = asyncio.Queue()\n+        assert isinstance(params, SamplingParams), \\\n+            \"Pooling is not supported in V1\"\n+\n+        # Create a new output collector for the request.\n+        queue = RequestOutputCollector(output_kind=params.output_kind)\n \n         # Convert Input --> Request.\n         request = self.processor.process_inputs(request_id, prompt, params,\n@@ -189,17 +193,15 @@ class AsyncLLM(EngineClient):\n                                                 prompt_adapter_request,\n                                                 priority)\n \n-        n = params.n if isinstance(params, SamplingParams) else 1\n-\n-        if n == 1:\n+        if params.n == 1:\n             await self._add_request(request, None, 0, queue)\n             return queue\n \n         # Fan out child requests (for n>1).\n         parent_request = ParentRequest(request_id, params)\n-        for idx in range(n):\n+        for idx in range(params.n):\n             request_id, params = parent_request.get_child_info(idx)\n-            child_request = request if idx == n - 1 else copy(request)\n+            child_request = request if idx == params.n - 1 else copy(request)\n             child_request.request_id = request_id\n             child_request.sampling_params = params\n             await self._add_request(child_request, parent_request, idx, queue)\n@@ -207,7 +209,7 @@ class AsyncLLM(EngineClient):\n \n     async def _add_request(self, request: EngineCoreRequest,\n                            parent_req: Optional[ParentRequest], index: int,\n-                           queue: asyncio.Queue[RequestOutput]):\n+                           queue: RequestOutputCollector):\n \n         # Add the request to OutputProcessor (this process).\n         self.output_processor.add_request(request, parent_req, index, queue)\n@@ -272,15 +274,7 @@ class AsyncLLM(EngineClient):\n             while not finished:\n                 # Note: drain queue without await if possible (avoids\n                 # task switching under load which helps performance).\n-                out = q.get_nowait() if not q.empty() else await q.get()\n-\n-                # Coalesce any additional queued outputs\n-                while not q.empty():\n-                    next_out = q.get_nowait()\n-                    if sampling_params.output_kind == RequestOutputKind.DELTA:\n-                        out.add(next_out)\n-                    else:\n-                        out = next_out\n+                out = q.get_nowait() or await q.get()\n \n                 # Note: both OutputProcessor and EngineCore handle their\n                 # own request cleanup based on finished.\ndiff --git a/vllm/v1/engine/output_processor.py b/vllm/v1/engine/output_processor.py\nindex 12df34177..1e67bed26 100644\n--- a/vllm/v1/engine/output_processor.py\n+++ b/vllm/v1/engine/output_processor.py\n@@ -17,6 +17,46 @@ from vllm.v1.metrics.stats import (IterationStats, LoRARequestStates,\n                                    RequestStateStats)\n \n \n+class RequestOutputCollector:\n+    \"\"\"\n+    Collects streamed RequestOutputs per individual request,\n+    for hand-off to the consuming asyncio generate task.\n+\n+    When streaming deltas, RequestOutputs are merged if the\n+    producer gets ahead of the consumer.\n+    \"\"\"\n+\n+    def __init__(self, output_kind: RequestOutputKind):\n+        self.aggregate = output_kind == RequestOutputKind.DELTA\n+        self.output: Optional[RequestOutput] = None\n+        self.ready = asyncio.Event()\n+\n+    def put(self, output: RequestOutput) -> None:\n+        if self.output is None:\n+            self.output = output\n+            self.ready.set()\n+        elif self.aggregate:\n+            # Coalesce the outputs in delta case.\n+            self.output.add(output)\n+        else:\n+            # Just replace latest in non-delta case.\n+            self.output = output\n+\n+    async def get(self) -> RequestOutput:\n+        while (output := self.output) is None:\n+            await self.ready.wait()\n+        self.output = None\n+        self.ready.clear()\n+        return output\n+\n+    def get_nowait(self) -> Optional[RequestOutput]:\n+        output = self.output\n+        if output is not None:\n+            self.output = None\n+            self.ready.clear()\n+        return output\n+\n+\n @dataclass\n class OutputProcessorOutput:\n \n@@ -39,7 +79,7 @@ class RequestState:\n         detokenizer: IncrementalDetokenizer,\n         max_tokens_param: Optional[int],\n         arrival_time: float,\n-        queue: Optional[asyncio.Queue[RequestOutput]],\n+        queue: Optional[RequestOutputCollector],\n         log_stats: bool,\n     ):\n         self.request_id = request_id\n@@ -66,7 +106,7 @@ class RequestState:\n         request: EngineCoreRequest,\n         parent_req: Optional[ParentRequest],\n         request_index: int,\n-        queue: Optional[asyncio.Queue[RequestOutput]],\n+        queue: Optional[RequestOutputCollector],\n         log_stats: bool,\n     ) -> \"RequestState\":\n         if not request.sampling_params.detokenize:\n@@ -217,7 +257,7 @@ class OutputProcessor:\n         request: EngineCoreRequest,\n         parent_req: Optional[ParentRequest] = None,\n         request_index: int = 0,\n-        queue: Optional[asyncio.Queue[RequestOutput]] = None,\n+        queue: Optional[RequestOutputCollector] = None,\n     ) -> None:\n         request_id = request.request_id\n         if request_id in self.request_states:\n@@ -300,7 +340,7 @@ class OutputProcessor:\n                     new_token_ids, finish_reason, stop_reason):\n                 if req_state.queue is not None:\n                     # AsyncLLM: put into queue for handling by generate().\n-                    req_state.queue.put_nowait(request_output)\n+                    req_state.queue.put(request_output)\n                 else:\n                     # LLMEngine: return list of RequestOutputs.\n                     request_outputs.append(request_output)", "apis": ["AsyncLLM.add_request", "AsyncLLM.generate", "RequestOutputCollector.put", "RequestOutputCollector.get"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/async_llm.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/output_processor.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/outputs.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/outputs.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "This commit modifies both a test file and core engine files (async_llm.py and output_processor.py) by replacing a standard asyncio.Queue with a custom RequestOutputCollector. The changes aim to reduce unnecessary task switching under load by coalescing outputs and simplifying the queuing mechanism. The code comments explicitly mention avoiding task switching to help performance, and the commit message is tagged with â€œ[Perf]â€. These modifications affect a high-level API (the request output processing pipeline) and are designed to yield CPU-level performance improvements without any GPU-specific changes. All conditions for a performance/optimization-related commit are met.", "llm_api_reason": "The commit refactors how streamed outputs are queued and merged by replacing the use of asyncio.Queue with a new RequestOutputCollector in both the AsyncLLM and OutputProcessor modules. It updates the AsyncLLM.add_request and generate methods (which now operate with RequestOutputCollector) and adds/coalesces merging logic in the RequestOutputCollectorâ€™s put and get methods. These changes affect how request outputs are collected and later merged when using delta mode."}
{"commit_hash": "296f927f2493908984707354e3cc5d7b2e41650b", "pr_url": "https://github.com/vllm-project/vllm/pull/14857", "pr_date": "2025-03-21", "timeline_text": "Copy link Contributor cyang49 commented Mar 15, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This is a re-attempt to fix mamba2's excessive memory copies. The previous solution failed due to difference in semantics when indexing tensor with tensor.  This new solution directly utilizes indexing with state_indices_tensor to create tensor views and simplified the code without over-engineering. FIX #14778 The results from benchmark_serving on single H100-80GB GPU (Actually I found high variance of throughput numbers from consecutive tests of the same code base when using this benchmark. Not sure if this is meaningful to report? @njhill @tlrmchlsmth ) Benchmark serving main ============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  291.76    \nTotal input tokens:                      215201    \nTotal generated tokens:                  198343    \nRequest throughput (req/s):              3.43      \nOutput token throughput (tok/s):         679.81    \nTotal Token throughput (tok/s):          1417.39   \n---------------Time to First Token----------------\nMean TTFT (ms):                          108636.82 \nMedian TTFT (ms):                        96115.48  \nP99 TTFT (ms):                           276325.38 \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          409.48    \nMedian TPOT (ms):                        427.24    \nP99 TPOT (ms):                           655.84    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           352.50    \nMedian ITL (ms):                         606.12    \nP99 ITL (ms):                            969.64    \n================================================== Benchmark serving with this PR ============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  252.11    \nTotal input tokens:                      215201    \nTotal generated tokens:                  198343    \nRequest throughput (req/s):              3.97      \nOutput token throughput (tok/s):         786.73    \nTotal Token throughput (tok/s):          1640.33   \n---------------Time to First Token----------------\nMean TTFT (ms):                          97161.98  \nMedian TTFT (ms):                        94360.96  \nP99 TTFT (ms):                           237572.12 \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          355.17    \nMedian TPOT (ms):                        381.49    \nP99 TPOT (ms):                           548.15    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           306.68    \nMedian ITL (ms):                         501.06    \nP99 ITL (ms):                            750.59    \n================================================== lm-eval main |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.22|Â±  |0.0416|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.32|Â±  |0.0469| lm-eval with this PR |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.22|Â±  |0.0416|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.32|Â±  |0.0469| cc @fabianlim @yury-tokpanov Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 fabianlim and yury-tokpanov reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions Copy link github-actions bot commented Mar 15, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Mar 15, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Experiment to test semantics of calling zero_() on indexed tensor >>> import torch\n>>> x = torch.randperm(10)\n>>> y = torch.randperm(10)\n>>> x\ntensor([5, 4, 6, 2, 0, 3, 8, 9, 7, 1])\n>>> y\ntensor([6, 8, 3, 2, 7, 5, 9, 4, 1, 0])\n>>> x[y<5].zero_()\ntensor([0, 0, 0, 0, 0])\n>>> x\ntensor([5, 4, 6, 2, 0, 3, 8, 9, 7, 1])\n>>> x[y<5] = 0\n>>> x\ntensor([5, 4, 0, 0, 0, 3, 8, 0, 0, 0]) From this experiment, It seems that zero_() wouldn't give the right results? The zero init code should be the following instead? This would be index_put_ if has_initial_states is not None and torch.any(\n                    has_initial_states):\n                zero_init_indices = mamba_cache_params.state_indices_tensor[\n                    ~has_initial_states]\n                mamba_cache_params.ssm_state[zero_init_indices] = 0\n                initial_states = mamba_cache_params.ssm_state[\n                    mamba_cache_params.state_indices_tensor] Another reference states: The copy is performed right away â€“ but note the exception to this (mentioned in the quoted documentation) when you are assigning to an indexed tensor. lm-eval results with this change |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.22|Â±  |0.0416|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.32|Â±  |0.0469| benchmark results with this change ============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  250.68    \nTotal input tokens:                      215201    \nTotal generated tokens:                  198343    \nRequest throughput (req/s):              3.99      \nOutput token throughput (tok/s):         791.23    \nTotal Token throughput (tok/s):          1649.71   \n---------------Time to First Token----------------\nMean TTFT (ms):                          95232.94  \nMedian TTFT (ms):                        85040.17  \nP99 TTFT (ms):                           231833.63 \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          337.99    \nMedian TPOT (ms):                        351.17    \nP99 TPOT (ms):                           522.21    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           292.12    \nMedian ITL (ms):                         494.48    \nP99 ITL (ms):                            730.20    \n================================================== All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . njhill approved these changes Mar 17, 2025 View reviewed changes Copy link Member njhill left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM, thanks @cyang49 ! I've run into similar issue with in-place updates in the past Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 1 cyang49 reacted with rocket emoji All reactions ðŸš€ 1 reaction Copy link Contributor yury-tokpanov commented Mar 18, 2025 how are you deploying your model's server? Seems like Bamba config lacks max model length, so vllm picks up something really big and enables chunked prefill, which is slow. Just setting --max-model-len 4096 is enough to disable chunked prefill: vllm serve ibm-ai-platform/Bamba-9B --dtype float16 --gpu-memory-utilization 0.9 --max-model-len 4096 . Without chunked prefill, I'm getting much better and more stable numbers for serving metrics. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth approved these changes Mar 20, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM and confirmed the gsm8k results on my end this time Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tlrmchlsmth added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 20, 2025 tlrmchlsmth enabled auto-merge (squash) March 20, 2025 15:15 Copy link Contributor Author cyang49 commented Mar 20, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Build failed.. will try rebasing main [2025-03-20T15:54:50Z] FAILED tool_use/test_chat_completions.py::test_chat_completion_with_tools[granite-3.0-8b] - AssertionError: assert 'Of course! H...p everything!' == 'Of course! H...p everything!'\n[2025-03-20T15:54:50Z]\n[2025-03-20T15:54:50Z]   - Of course! Here's a joke for you: Why don't scientists trust atoms? Because they make up everything!\n[2025-03-20T15:54:50Z]   + Of course! Here's a joke for you:\n[2025-03-20T15:54:50Z]   +\n[2025-03-20T15:54:50Z]   + Why don't scientists trust atoms?\n[2025-03-20T15:54:50Z]   +\n[2025-03-20T15:54:50Z]   + Because they make up everything! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cyang49 added 2 commits March 20, 2025 16:10 simplify and optimize mamba2 code that caused flurry of memcpys â€¦ d0a7427 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> Use assignment instead of zero_ on indexed ssm_state â€¦ 2807c52 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> auto-merge was automatically disabled March 20, 2025 20:10 Head branch was pushed to by a user without write access cyang49 force-pushed the pr_mamba2_mem_fix branch\n    from 0f41a64 to 2807c52 Compare March 20, 2025 20:10 tlrmchlsmth enabled auto-merge (squash) March 20, 2025 20:32 Copy link Collaborator tlrmchlsmth commented Mar 20, 2025 Ok! If it fails again, let's take a look at the failures and force merge if unrelated (feel free to ping me on this @cyang49 ) All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Mar 20, 2025 @tlrmchlsmth failed again on V1 test of Qwen.. :( All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details vllm-bot merged commit 296f927 into vllm-project : main Mar 21, 2025 32 of 35 checks passed Uh oh! There was an error while loading. Please reload this page . cyang49 deleted the pr_mamba2_mem_fix branch March 24, 2025 22:00 erictang000 pushed a commit\n        to erictang000/vllm\n      that referenced\n      this pull request Mar 25, 2025 [Model] RE: Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecâ€¦ â€¦ 93fab96 â€¦essary Memory Copies ( vllm-project#14857 )\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [Model] RE: Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecâ€¦ â€¦ 0dbd3df â€¦essary Memory Copies ( vllm-project#14857 )\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Model] RE: Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecâ€¦ â€¦ 252cff0 â€¦essary Memory Copies ( vllm-project#14857 )\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [Model] RE: Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecâ€¦ â€¦ 97055ac â€¦essary Memory Copies ( vllm-project#14857 )\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:42", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm-eval, lm-eval, lm-eval | PERF: TTFT, TTFT, TTFT | SERVING: vllm serve, serving, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:51:42", "models": ["ibm-ai-platform/Bamba-9B"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=ibm-ai-platform/Bamba-9B,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model ibm-ai-platform/Bamba-9B --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Model] RE: Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessary Memory Copies  (#14857)", "commit_message": "[Model] RE: Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessary Memory Copies  (#14857)\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>", "commit_date": "2025-03-20T19:21:08-07:00", "files_changed": ["vllm/model_executor/layers/mamba/mamba_mixer2.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 13, "num_non_test_edited_lines": 13, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/mamba/mamba_mixer2.py b/vllm/model_executor/layers/mamba/mamba_mixer2.py\nindex fec6d6112..d7a45bc51 100644\n--- a/vllm/model_executor/layers/mamba/mamba_mixer2.py\n+++ b/vllm/model_executor/layers/mamba/mamba_mixer2.py\n@@ -470,10 +470,11 @@ class MambaMixer2(CustomOp):\n         if has_prefill:\n \n             initial_states = None\n-            if has_initial_states is not None and any(has_initial_states):\n-                for idx in mamba_cache_params.state_indices_tensor[\n-                        ~has_initial_states]:\n-                    mamba_cache_params.ssm_state[idx].zero_()\n+            if has_initial_states is not None and torch.any(\n+                    has_initial_states):\n+                zero_init_indices = mamba_cache_params.state_indices_tensor[\n+                    ~has_initial_states]\n+                mamba_cache_params.ssm_state[zero_init_indices] = 0\n                 initial_states = mamba_cache_params.ssm_state[\n                     mamba_cache_params.state_indices_tensor]\n \n@@ -499,8 +500,8 @@ class MambaMixer2(CustomOp):\n \n             # update ssm states\n             # - varlen state is a (batch, nheads, headdim, dstate) tensor\n-            for i, idx in enumerate(mamba_cache_params.state_indices_tensor):\n-                mamba_cache_params.ssm_state[idx].copy_(varlen_state[i])\n+            mamba_cache_params.ssm_state[\n+                mamba_cache_params.state_indices_tensor] = varlen_state\n \n             # - reshape\n             hidden_states = scan_output.view(seq_len, -1)", "apis": ["MambaMixer2.forward_cuda", "mamba_mixer2"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/mamba/mamba_mixer2.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mamba2.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mamba_cache.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a non-test file (mamba_mixer2.py) and changes the implementation of state initialization and update by replacing Python loops with tensor indexing assignments, likely reducing unnecessary memory copy operations. The commit message also hints at performance improvements (\"Fixing Flurry of Unnecessary Memory Copies\"). These changes affect the underlying operations (memory copy, state updates) that can impact the performance of high-level APIs. The modifications are non-trivial code changes intended to optimize runtime performance on CPU, not bug fixes or simple refactoring. Therefore, the commit meets the criteria for being performance/optimization related.", "llm_api_reason": "The commit refactors parts of the prefill branch in the MambaMixer2 custom op implementation to avoid iterative memory copy operations by replacing Python loops with vectorized tensor slicing assignments. This change affects the internal behavior of the forward_cuda method of the MambaMixer2 class and the registered mamba_mixer2 op function that dispatches to it."}
{"commit_hash": "22d33baca2c0c639cfd45c48e99803e56c3efa74", "pr_url": "https://github.com/vllm-project/vllm/pull/15150", "pr_date": "2025-03-19", "timeline_text": "Copy link Member njhill commented Mar 19, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Avoid the merging overhead in most common case. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [Misc][Perf] merge_async_iterators fast-path for single-prompt requests â€¦ c1fe348 Avoid the merging overhead in most common case.\n\nSigned-off-by: Nick Hill <nhill@redhat.com> Copy link github-actions bot commented Mar 19, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . njhill changed the title [Misc][Perf] merge_async_iterators fast-path for single-prompt requests [FrontEnd][Perf] merge_async_iterators fast-path for single-prompt requests Mar 19, 2025 robertgshaw2-redhat approved these changes Mar 19, 2025 View reviewed changes robertgshaw2-redhat enabled auto-merge (squash) March 19, 2025 18:39 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 19, 2025 Hide details View details robertgshaw2-redhat merged commit 22d33ba into vllm-project : main Mar 19, 2025 43 checks passed Uh oh! There was an error while loading. Please reload this page . njhill deleted the single-generator branch March 19, 2025 22:41 lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [FrontEnd][Perf] merge_async_iterators fast-path for single-prompt â€¦ â€¦ bed8d39 â€¦requests ( vllm-project#15150 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [FrontEnd][Perf] merge_async_iterators fast-path for single-prompt â€¦ â€¦ 3f204af â€¦requests ( vllm-project#15150 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [FrontEnd][Perf] merge_async_iterators fast-path for single-prompt â€¦ â€¦ f205d3b â€¦requests ( vllm-project#15150 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:45", "has_lm_eval": false, "has_performance": false, "has_serving": true, "has_general_test": true, "test_details": "SERVING: FrontEnd, FrontEnd, FrontEnd | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:51:45", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[FrontEnd][Perf] `merge_async_iterators` fast-path for single-prompt requests (#15150)", "commit_message": "[FrontEnd][Perf] `merge_async_iterators` fast-path for single-prompt requests (#15150)\n\nSigned-off-by: Nick Hill <nhill@redhat.com>", "commit_date": "2025-03-19T21:04:41Z", "files_changed": ["vllm/utils.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 5, "num_non_test_edited_lines": 5, "commit_year": 2025}, "diff_text": "diff --git a/vllm/utils.py b/vllm/utils.py\nindex 79787303a..9bc081890 100644\n--- a/vllm/utils.py\n+++ b/vllm/utils.py\n@@ -411,6 +411,11 @@ async def merge_async_iterators(\n     When it yields, it yields a tuple (i, item) where i is the index of the\n     iterator that yields the item.\n     \"\"\"\n+    if len(iterators) == 1:\n+        # Fast-path single iterator case.\n+        async for item in iterators[0]:\n+            yield 0, item\n+        return\n \n     loop = asyncio.get_running_loop()", "apis": ["vllm.utils.merge_async_iterators"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/api_server.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_completion.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/async_llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit adds a fast-path for the case where there is only one iterator in merge_async_iterators, which is a non-trivial change in the source code (vllm/utils.py) that directly optimizes the performance for single-prompt requests. This change improves efficiency by reducing overhead in that scenario, affecting performance on a CPU and being testable without specialized hardware. Thus, it meets the conditions for a performance/optimization related commit.", "llm_api_reason": "The commit adds a fast-path in the merge_async_iterators helper that checks for a single iterator and yields its items directly, bypassing the normal merging loop. This performance optimization affects any public or high-level code that relies on merge_async_iterators for combining asynchronous generators (for example, in streaming responses in the API endpoints)."}
{"commit_hash": "99abb8b650c66664cdc84d815b7f306f33bd9881", "pr_url": "https://github.com/vllm-project/vllm/pull/14930", "pr_date": "2025-03-18", "timeline_text": "Copy link Collaborator WoosukKwon commented Mar 17, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR optimizes the rejection sampler in #13933 with custom Triton kernels. By using the Triton kernels, the PR brings the following benefits: Now we use the flattened shape [num_tokens, vocab_size] for the logits tensors, instead of [batch_size, max_spec_len, vocab_size] . This reduces the GPU memory usage a lot. Zero synchronization between CPU and GPU. Remove inefficient data movement (i.e., a bunch of cat , gather , etc.) (Arguably) easier-to-read code Performance benchmark: Llama 3.1 8B, ShareGPT, 1xH100, temperature 0.1 SD config: --speculative-model \"[ngram]\" --ngram_prompt_lookup_min 5 --ngram-prompt-lookup-max 5 --num_speculative_tokens 3 Throughput (reqs/s) main (w/o SD) 51.49 main (w/ SD) 54.41 This PR (w/ SD) 64.16 25% throughput increase compared to main w/o SD, and 18% increase compared to main w/ SD. Accuracy benchmark: GSM8K, Llama 3.1 8B Instruct, 5 shots Temperature Exact match w/o SD 0.0 75.7 1.0 50.9 w/ SD 0.0 75.9 1.0 51.8 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸŽ‰ 4 robertgshaw2-redhat, LiuXiaoxuanPKU, MARD1NO, and mlinmg reacted with hooray emoji All reactions ðŸŽ‰ 4 reactions WoosukKwon added 30 commits March 14, 2025 20:41 tmp â€¦ c09ae5e Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ e3f3513 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix shape â€¦ be535aa Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ be950c7 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ 1fee177 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Add parse_outputs â€¦ d30970e Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ 32fefa1 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ 4a93973 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ f2455fd Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> kernel â€¦ fbba0ff Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> kernel â€¦ 255d1ee Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ 22c9515 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> comment â€¦ c631935 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ 566caea Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ c427ffd Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ d896f41 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ cb8e699 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ c0bcf5a Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ ae3d7fc Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ 412e2f4 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> remove â€¦ df66124 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> opt â€¦ 704da77 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ 4f95ca9 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> opt softmax & fix recompilation â€¦ 803c9de Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> minor â€¦ 9cc9349 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> remove envs â€¦ 2b69e51 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into v1-opt-rej d374d59 Merge branch 'main' into v1-opt-rej d4a6437 fix â€¦ 75e93aa Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ 5a86ff3 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> 24 hidden items Load moreâ€¦ WoosukKwon added 6 commits March 17, 2025 10:12 fix test â€¦ 8b7a398 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into v1-opt-rej b303722 Merge branch 'main' into v1-opt-rej a0440c8 comment â€¦ 40f334a Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> comment â€¦ 6935bfd Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix shape mismatch â€¦ 0baa33e Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> LiuXiaoxuanPKU reviewed Mar 18, 2025 View reviewed changes Copy link Collaborator LiuXiaoxuanPKU left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Finished the rejection_sampler.py, will continue other files tonight Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/sample/rejection_sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/sample/rejection_sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/sample/rejection_sampler.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . LiuXiaoxuanPKU reviewed Mar 18, 2025 View reviewed changes vllm/v1/sample/rejection_sampler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . WoosukKwon added 4 commits March 18, 2025 12:17 Merge branch 'main' into v1-opt-rej 459b2fa fix docstrings â€¦ aaf2316 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix dtype â€¦ 531068e Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> add comment â€¦ 69c88b8 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon requested a review\n  from LiuXiaoxuanPKU March 18, 2025 19:29 LiuXiaoxuanPKU approved these changes Mar 18, 2025 View reviewed changes Copy link Collaborator LiuXiaoxuanPKU left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM, thanks! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details WoosukKwon merged commit 99abb8b into main Mar 18, 2025 29 of 32 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the v1-opt-rej branch March 18, 2025 21:31 youkaichao reviewed Mar 19, 2025 View reviewed changes vllm/v1/sample/ops/utils.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . CXIAAAAA mentioned this pull request Mar 19, 2025 [Feature]: Add likaixin/InstructCoder as spec decode benchmark dataset option #14045 Closed 1 task This was referenced Mar 21, 2025 [Bug]: v1 speculate decoding NgramProposer experiences service exceptions during stress testing #14742 Closed add last slot for the invalid_token in greedy rejection sampler, specdec #14519 Closed WoosukKwon mentioned this pull request Apr 2, 2025 [Bug]: [V1][SpecDec] RuntimeError: CUDA error: an illegal memory access was encountered #13673 Closed 1 task lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [V1][Spec Decode] Optimize Rejection Sampler with Triton Kernels ( vllâ€¦ â€¦ f928001 â€¦m-project#14930 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [V1][Spec Decode] Optimize Rejection Sampler with Triton Kernels ( vllâ€¦ â€¦ 0e57658 â€¦m-project#14930 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [V1][Spec Decode] Optimize Rejection Sampler with Triton Kernels ( vllâ€¦ â€¦ 08577f8 â€¦m-project#14930 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> mmyxym reviewed Aug 5, 2025 View reviewed changes vllm/v1/sample/rejection_sampler.py GREEDY_TEMPERATURE: tl.constexpr = -1 # Maximum number of speculative draft tokens allowed per request in a single # step. This value is chosen to be large enough to handle typical use cases. MAX_SPEC_LEN = 32 Copy link mmyxym Aug 5, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Hi @WoosukKwon , is there any limitation MAX_SPEC_LEN should be 32? Can it be larger? Thanks. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author WoosukKwon Aug 28, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @mmyxym There's no blocker to make it 64. Everything should work if you just change the number. I just thought 32 would be enough for all practical use cases. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mergify bot added\n  the speculative-decoding label Aug 5, 2025 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:49", "has_lm_eval": true, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: GSM8K | PERF: Throughput, throughput | TEST: test, test, testing", "analysis_extracted_at": "2025-09-07 17:51:49", "models": ["meta-llama/Llama-3.1-8B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=meta-llama/Llama-3.1-8B-Instruct --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.1-8B-Instruct --dataset-name sharegpt --num-prompts 1000", "commit_subject": "[V1][Spec Decode] Optimize Rejection Sampler with Triton Kernels (#14930)", "commit_message": "[V1][Spec Decode] Optimize Rejection Sampler with Triton Kernels (#14930)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2025-03-18T14:31:54-07:00", "files_changed": ["tests/v1/sample/test_rejection_sampler.py", "vllm/envs.py", "vllm/v1/outputs.py", "vllm/v1/sample/ops/utils.py", "vllm/v1/sample/rejection_sampler.py", "vllm/v1/spec_decode/metadata.py", "vllm/v1/spec_decode/utils.py", "vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 7, "only_test_files": 0, "only_non_test_files": 0, "num_files": 8, "num_hunks": 34, "num_edited_lines": 1329, "num_non_test_edited_lines": 1098, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/sample/test_rejection_sampler.py b/tests/v1/sample/test_rejection_sampler.py\nindex 84139a40b..8c423e367 100644\n--- a/tests/v1/sample/test_rejection_sampler.py\n+++ b/tests/v1/sample/test_rejection_sampler.py\n@@ -6,20 +6,23 @@ import torch\n import torch.nn.functional as F\n \n from vllm.v1.sample.metadata import SamplingMetadata\n-from vllm.v1.sample.rejection_sampler import INVALID_TOKEN_ID, RejectionSampler\n+from vllm.v1.sample.rejection_sampler import (PLACEHOLDER_TOKEN_ID,\n+                                              RejectionSampler)\n+from vllm.v1.spec_decode.metadata import SpecDecodeMetadata\n \n-DEVICE = \"cpu\"\n+DEVICE = \"cuda\"\n \n \n @pytest.fixture\n-def sampler():\n+def rejection_sampler():\n     return RejectionSampler()\n \n \n-def create_logits_tensor(token_ids: list[list[int]],\n+def create_logits_tensor(output_token_ids: list[list[int]],\n                          vocab_size: int = 100) -> torch.Tensor:\n     \"\"\"Helper function to create logits tensor that \n        will produce desired token ids on argmax\"\"\"\n+    token_ids = [tokens[:-1] for tokens in output_token_ids]\n     num_total_tokens = sum(len(tokens) for tokens in token_ids)\n     logits = torch.full((num_total_tokens, vocab_size), -100.0, device=DEVICE)\n     start_loc = 0\n@@ -31,15 +34,22 @@ def create_logits_tensor(token_ids: list[list[int]],\n \n \n def create_sampling_metadata(\n-        all_greedy: bool,\n-        generators: Optional[dict[int, Any]] = None) -> SamplingMetadata:\n+    all_greedy: bool,\n+    temperature: Optional[torch.Tensor] = None,\n+    generators: Optional[dict[int, Any]] = None,\n+) -> SamplingMetadata:\n     \"\"\"Create a v1 sampling metadata object with all_greedy set \n         to the given value. Either all greedy or all random sampling \n         is used.\n     \"\"\"\n     generators = generators or {}\n+    if all_greedy:\n+        temperature = None\n+    else:\n+        assert temperature is not None\n+\n     return SamplingMetadata(\n-        temperature=torch.tensor([]),\n+        temperature=temperature,\n         all_greedy=all_greedy,\n         all_random=not all_greedy,\n         top_p=None,\n@@ -61,7 +71,7 @@ def create_sampling_metadata(\n \n \n ########################### Tests for Greedy Sampling ###################\n-def test_perfect_match(sampler):\n+def test_perfect_match(rejection_sampler):\n     \"\"\"Test when output tokens perfectly match speculated tokens\"\"\"\n     spec_tokens = [[1, 2, 3]]\n     output_tokens = [[1, 2, 3, 4]]  # 4 is the bonus token\n@@ -70,15 +80,23 @@ def test_perfect_match(sampler):\n     logits = create_logits_tensor(output_tokens)\n     bonus_token_tensor = torch.tensor([output_tokens[0][-1]],\n                                       device=logits.device)\n-\n-    output = sampler(spec_tokens, None, bonus_token_tensor, logits, metadata)\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(spec_tokens,\n+                                                         device=logits.device)\n+\n+    output = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=None,\n+        target_logits=logits,\n+        bonus_token_ids=bonus_token_tensor,\n+        sampling_metadata=metadata,\n+    )\n     expected = torch.tensor([[1, 2, 3, 4]],\n                             dtype=torch.int,\n                             device=logits.device)\n     assert torch.equal(output, expected)\n \n \n-def test_early_mismatch(sampler):\n+def test_early_mismatch(rejection_sampler):\n     \"\"\"Test when there's an early mismatch in tokens\"\"\"\n     spec_tokens = [[1, 2, 3]]\n     output_tokens = [[1, 5, 3, 4]]  # Mismatch at position 1\n@@ -87,15 +105,25 @@ def test_early_mismatch(sampler):\n     logits = create_logits_tensor(output_tokens)\n     bonus_token_tensor = torch.tensor([output_tokens[0][-1]],\n                                       device=logits.device)\n-\n-    output = sampler(spec_tokens, None, bonus_token_tensor, logits, metadata)\n-    expected = torch.tensor([[1, 5, INVALID_TOKEN_ID, INVALID_TOKEN_ID]],\n-                            dtype=torch.int,\n-                            device=logits.device)\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(spec_tokens,\n+                                                         device=logits.device)\n+\n+    output = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=None,\n+        target_logits=logits,\n+        bonus_token_ids=bonus_token_tensor,\n+        sampling_metadata=metadata,\n+    )\n+    expected = torch.tensor(\n+        [[1, 5, PLACEHOLDER_TOKEN_ID, PLACEHOLDER_TOKEN_ID]],\n+        dtype=torch.int,\n+        device=logits.device,\n+    )\n     assert torch.equal(output, expected)\n \n \n-def test_multiple_sequences(sampler):\n+def test_multiple_sequences(rejection_sampler):\n     \"\"\"Test handling multiple sequences of speculated tokens\"\"\"\n     spec_tokens = [[1, 2], [3]]\n     output_tokens = [[1, 2, 5], [3,\n@@ -105,15 +133,23 @@ def test_multiple_sequences(sampler):\n     logits = create_logits_tensor(output_tokens)\n     bonus_token_tensor = torch.tensor(\n         [output_tokens[0][-1], output_tokens[1][-1]], device=logits.device)\n-\n-    output = sampler(spec_tokens, None, bonus_token_tensor, logits, metadata)\n-    expected = torch.tensor([[1, 2, 5], [3, 4, INVALID_TOKEN_ID]],\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(spec_tokens,\n+                                                         device=logits.device)\n+\n+    output = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=None,\n+        target_logits=logits,\n+        bonus_token_ids=bonus_token_tensor,\n+        sampling_metadata=metadata,\n+    )\n+    expected = torch.tensor([[1, 2, 5], [3, 4, PLACEHOLDER_TOKEN_ID]],\n                             dtype=torch.int,\n                             device=logits.device)\n     assert torch.equal(output, expected)\n \n \n-def test_single_token_sequence(sampler):\n+def test_single_token_sequence(rejection_sampler):\n     \"\"\"Test handling sequences with single token\"\"\"\n     spec_tokens = [[1]]\n     output_tokens = [[1, 2]]  # Single token with bonus token 2\n@@ -122,13 +158,21 @@ def test_single_token_sequence(sampler):\n     logits = create_logits_tensor(output_tokens)\n     bonus_token_tensor = torch.tensor([output_tokens[0][-1]],\n                                       device=logits.device)\n-\n-    output = sampler(spec_tokens, None, bonus_token_tensor, logits, metadata)\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(spec_tokens,\n+                                                         device=logits.device)\n+\n+    output = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=None,\n+        target_logits=logits,\n+        bonus_token_ids=bonus_token_tensor,\n+        sampling_metadata=metadata,\n+    )\n     expected = torch.tensor([[1, 2]], dtype=torch.int, device=logits.device)\n     assert torch.equal(output, expected)\n \n \n-def test_empty_sequence(sampler):\n+def test_empty_sequence(rejection_sampler):\n     \"\"\"Test handling empty sequence of speculated tokens\"\"\"\n     spec_tokens: list[list[int]] = [[]]\n     output_tokens = [[5]]  # Just the bonus token\n@@ -137,13 +181,21 @@ def test_empty_sequence(sampler):\n     logits = create_logits_tensor(output_tokens)\n     bonus_token_tensor = torch.tensor([output_tokens[0][-1]],\n                                       device=logits.device)\n-\n-    output = sampler(spec_tokens, None, bonus_token_tensor, logits, metadata)\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(spec_tokens,\n+                                                         device=logits.device)\n+\n+    output = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=None,\n+        target_logits=logits,\n+        bonus_token_ids=bonus_token_tensor,\n+        sampling_metadata=metadata,\n+    )\n     expected = torch.tensor([[5]], dtype=torch.int, device=logits.device)\n     assert torch.equal(output, expected)\n \n \n-def test_multiple_mismatches(sampler):\n+def test_multiple_mismatches(rejection_sampler):\n     \"\"\"Test handling multiple sequences with mismatches\"\"\"\n     spec_tokens = [[1, 2, 3], [4, 5, 6]]\n     output_tokens = [[1, 2, 7, 6], [4, 8, 6,\n@@ -153,12 +205,22 @@ def test_multiple_mismatches(sampler):\n     logits = create_logits_tensor(output_tokens)\n     bonus_token_tensor = torch.tensor(\n         [output_tokens[0][-1], output_tokens[1][-1]], device=logits.device)\n-\n-    output = sampler(spec_tokens, None, bonus_token_tensor, logits, metadata)\n-    expected = torch.tensor([[1, 2, 7, INVALID_TOKEN_ID],\n-                             [4, 8, INVALID_TOKEN_ID, INVALID_TOKEN_ID]],\n-                            dtype=torch.int,\n-                            device=logits.device)\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(spec_tokens,\n+                                                         device=logits.device)\n+\n+    output = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=None,\n+        target_logits=logits,\n+        bonus_token_ids=bonus_token_tensor,\n+        sampling_metadata=metadata,\n+    )\n+    expected = torch.tensor(\n+        [[1, 2, 7, PLACEHOLDER_TOKEN_ID],\n+         [4, 8, PLACEHOLDER_TOKEN_ID, PLACEHOLDER_TOKEN_ID]],\n+        dtype=torch.int,\n+        device=logits.device,\n+    )\n     assert torch.equal(output, expected)\n \n \n@@ -166,18 +228,27 @@ def test_multiple_mismatches(sampler):\n     \"spec_tokens,output_tokens,expected\",\n     [\n         ([[1, 2]], [[1, 2, 3]], [[1, 2, 3]]),  # Perfect match with bonus\n-        ([[1]], [[2, 3]], [[2, INVALID_TOKEN_ID]]),  # First mismatch\n+        ([[1]], [[2, 3]], [[2, PLACEHOLDER_TOKEN_ID]]),  # First mismatch\n         ([[1, 2], [3, 4]], [[1, 5, 6], [3, 4, 7]],\n-         [[1, 5, INVALID_TOKEN_ID], [3, 4, 7]]),  # Mixed matches\n+         [[1, 5, PLACEHOLDER_TOKEN_ID], [3, 4, 7]]),  # Mixed matches\n     ])\n-def test_parametrized_cases(sampler, spec_tokens, output_tokens, expected):\n+def test_parametrized_cases(rejection_sampler, spec_tokens, output_tokens,\n+                            expected):\n     \"\"\"Parametrized test for various matching scenarios\"\"\"\n     metadata = create_sampling_metadata(all_greedy=True)\n     logits = create_logits_tensor(output_tokens)\n     bonus_token_tensor = torch.tensor([tokens[-1] for tokens in output_tokens],\n                                       device=logits.device)\n-\n-    output = sampler(spec_tokens, None, bonus_token_tensor, logits, metadata)\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(spec_tokens,\n+                                                         device=logits.device)\n+\n+    output = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=None,\n+        target_logits=logits,\n+        bonus_token_ids=bonus_token_tensor,\n+        sampling_metadata=metadata,\n+    )\n     expected_tensor = torch.tensor(expected,\n                                    dtype=torch.int,\n                                    device=logits.device)\n@@ -190,21 +261,31 @@ def test_parametrized_cases(sampler, spec_tokens, output_tokens, expected):\n @pytest.mark.parametrize(\"batch_size\", [1, 4, 8])\n @pytest.mark.parametrize(\"frac_seeded\", [0.0, 0.5])\n @pytest.mark.parametrize(\"n_rep\", [20])\n-def test_deterministic_when_seeded(sampler, k: int, vocab_size: int,\n-                                   batch_size: int, frac_seeded: float,\n-                                   n_rep: int):\n-    draft_probs = torch.rand(batch_size, k, vocab_size, dtype=torch.float32)\n-    target_probs = torch.rand(batch_size * (k + 1),\n-                              vocab_size,\n-                              dtype=torch.float32)\n+def test_deterministic_when_seeded(\n+    rejection_sampler,\n+    k: int,\n+    vocab_size: int,\n+    batch_size: int,\n+    frac_seeded: float,\n+    n_rep: int,\n+):\n+    num_tokens = batch_size * k\n+    draft_probs = torch.rand(num_tokens,\n+                             vocab_size,\n+                             dtype=torch.float32,\n+                             device=DEVICE)\n+    draft_probs = F.softmax(draft_probs, dim=-1)\n+    target_logits = torch.rand_like(draft_probs)\n     bonus_token_ids = torch.randint(low=0,\n                                     high=vocab_size,\n                                     size=(batch_size, 1),\n-                                    dtype=torch.int64)\n+                                    dtype=torch.int64,\n+                                    device=DEVICE)\n     draft_token_ids = torch.randint(low=0,\n                                     high=vocab_size,\n                                     size=(batch_size, k),\n-                                    dtype=torch.int64)\n+                                    dtype=torch.int64,\n+                                    device=DEVICE)\n \n     seeded_mask = torch.rand(batch_size, dtype=torch.float32) <= frac_seeded\n \n@@ -215,10 +296,21 @@ def test_deterministic_when_seeded(sampler, k: int, vocab_size: int,\n             for i in range(batch_size) if seeded_mask[i]\n         }\n \n+        temperature = torch.ones(batch_size,\n+                                 dtype=torch.float32,\n+                                 device=DEVICE)\n         sampling_metadata = create_sampling_metadata(all_greedy=False,\n+                                                     temperature=temperature,\n                                                      generators=seeded_seqs)\n-        rep_result = sampler(draft_token_ids.tolist(), draft_probs,\n-                             bonus_token_ids, target_probs, sampling_metadata)\n+        spec_decode_metadata = SpecDecodeMetadata.make_dummy(\n+            draft_token_ids.tolist(), device=DEVICE)\n+        rep_result = rejection_sampler(\n+            spec_decode_metadata,\n+            draft_probs=draft_probs,\n+            target_logits=target_logits,\n+            bonus_token_ids=bonus_token_ids,\n+            sampling_metadata=sampling_metadata,\n+        )\n \n         results.append(rep_result)\n \n@@ -257,10 +349,10 @@ def test_rejection_sampling_approximates_target_distribution():\n     num_reference_probs = 100\n \n     # Prepare draft, target, and reference probability distributions\n-    draft_probs, target_probs = (F.softmax(\n-        torch.rand(vocab_size, dtype=torch.float32),\n-        dim=-1,\n-    ) for _ in range(2))\n+    draft_probs = F.softmax(torch.rand(vocab_size, dtype=torch.float32),\n+                            dim=-1)\n+    target_logits = torch.rand(vocab_size, dtype=torch.float32)\n+    target_probs = F.softmax(target_logits, dim=-1)\n     reference_probs = F.softmax(\n         torch.rand(num_reference_probs, vocab_size, dtype=torch.float32),\n         dim=-1,\n@@ -273,7 +365,7 @@ def test_rejection_sampling_approximates_target_distribution():\n     for num_samples in sample_sizes:\n         # Sample using rejection sampling.\n         rej_sample_probs = estimate_rejection_sampling_pdf(\n-            draft_probs, target_probs, k, vocab_size, num_samples)\n+            draft_probs, target_logits, k, vocab_size, num_samples)\n         rej_sample_probs = rej_sample_probs.to(DEVICE)\n \n         # Average distance from reference probs.\n@@ -313,7 +405,7 @@ def get_ratio_first_to_last(elements: list[float]) -> float:\n \n def estimate_rejection_sampling_pdf(\n     draft_probs: torch.Tensor,\n-    target_probs: torch.Tensor,\n+    target_logits: torch.Tensor,\n     k: int,\n     vocab_size: int,\n     num_samples: int,\n@@ -323,35 +415,44 @@ def estimate_rejection_sampling_pdf(\n \n     Args:\n         draft_probs: Draft probability distribution.\n-        target_probs: Target probability distribution.\n+        target_logits: Target logits.\n         num_samples: Number of samples to draw.\n \n     Returns:\n         Estimated probability distribution of the output tokens.\n     \"\"\"\n-    sampler = RejectionSampler()\n-    # Repeat draft probs num_samples times.\n+    rejection_sampler = RejectionSampler()\n+    num_tokens = num_samples * k\n+    # Repeat draft probs num_samples * k times.\n     draft_probs = draft_probs.reshape(1, 1,\n                                       vocab_size).repeat(num_samples, k, 1)\n \n-    # Repeat target probs num_samples * (k + 1) times.\n-    target_probs = target_probs.reshape(1, 1, vocab_size).repeat(\n-        num_samples, k + 1, 1).reshape(num_samples * (k + 1), vocab_size)\n+    # Repeat target probs num_tokens times.\n+    target_logits = target_logits.reshape(1, vocab_size).repeat(num_tokens, 1)\n \n     # Randomly sample draft token ids from draft probs.\n     draft_token_ids = torch.multinomial(draft_probs[:, 0, :],\n                                         num_samples=k,\n                                         replacement=True).reshape(\n                                             num_samples, k)\n+    draft_probs = draft_probs.view(num_tokens, vocab_size)\n \n     # Bonus tokens not used but required.\n     bonus_token_ids = torch.zeros((1, 1), dtype=torch.int64,\n                                   device=DEVICE).repeat(num_samples, 1)\n \n-    sampling_metadata = create_sampling_metadata(all_greedy=False)\n-    output_token_ids = sampler(draft_token_ids.tolist(), draft_probs,\n-                               bonus_token_ids, target_probs,\n-                               sampling_metadata)\n+    temperature = torch.ones(num_samples, dtype=torch.float32, device=DEVICE)\n+    sampling_metadata = create_sampling_metadata(all_greedy=False,\n+                                                 temperature=temperature)\n+    spec_decode_metadata = SpecDecodeMetadata.make_dummy(\n+        draft_token_ids.tolist(), device=bonus_token_ids.device)\n+    output_token_ids = rejection_sampler(\n+        spec_decode_metadata,\n+        draft_probs=draft_probs,\n+        target_logits=target_logits,\n+        bonus_token_ids=bonus_token_ids,\n+        sampling_metadata=sampling_metadata,\n+    )\n     output_token_ids = output_token_ids[:, :-1].flatten()\n \n     hist = torch.histogram(output_token_ids.to(dtype=torch.float,\ndiff --git a/vllm/envs.py b/vllm/envs.py\nindex bf214f314..b2937462a 100644\n--- a/vllm/envs.py\n+++ b/vllm/envs.py\n@@ -35,7 +35,6 @@ if TYPE_CHECKING:\n     VLLM_TRACE_FUNCTION: int = 0\n     VLLM_ATTENTION_BACKEND: Optional[str] = None\n     VLLM_USE_FLASHINFER_SAMPLER: Optional[bool] = None\n-    VLLM_USE_FLASHINFER_REJECTION_SAMPLER: bool = False\n     VLLM_FLASHINFER_FORCE_TENSOR_CORES: bool = False\n     VLLM_PP_LAYER_PARTITION: Optional[str] = None\n     VLLM_CPU_KVCACHE_SPACE: int = 0\ndiff --git a/vllm/v1/outputs.py b/vllm/v1/outputs.py\nindex edae654b5..6f4641717 100644\n--- a/vllm/v1/outputs.py\n+++ b/vllm/v1/outputs.py\n@@ -46,7 +46,7 @@ class SamplerOutput:\n     # [num_reqs, max_num_generated_tokens]\n     # Different requests can have different number of generated tokens.\n     # All requests are padded to max_num_generated_tokens.\n-    # INVALID_TOKEN_ID (-1 by default) is used for padding.\n+    # PLACEHOLDER_TOKEN_ID (-1 by default) is used for padding.\n     sampled_token_ids: torch.Tensor\n     logprobs_tensors: Optional[LogprobsTensors]\n \ndiff --git a/vllm/v1/sample/ops/utils.py b/vllm/v1/sample/ops/utils.py\nnew file mode 100644\nindex 000000000..a54e20603\n--- /dev/null\n+++ b/vllm/v1/sample/ops/utils.py\n@@ -0,0 +1,30 @@\n+# SPDX-License-Identifier: Apache-2.0\n+from typing import Union\n+\n+import torch\n+\n+\n+def compiled_softmax(\n+    logits: torch.Tensor,\n+    temperature: Union[float, torch.Tensor] = 1.0,\n+) -> torch.Tensor:\n+    \"\"\"Faster softmax kernel generated by torch.compile.\n+\n+    Args:\n+        logits: [n, vocab_size]\n+        temperature: [n] or float\n+    \"\"\"\n+    # NOTE(woosuk): Avoid recompilation by marking the first dim as dynamic.\n+    torch._dynamo.mark_dynamic(logits, index=0)\n+    if isinstance(temperature, torch.Tensor):\n+        torch._dynamo.mark_dynamic(temperature, index=0)\n+    return _softmax(logits, temperature)\n+\n+\n+@torch.compile\n+def _softmax(\n+    logits: torch.Tensor,\n+    temperature: Union[float, torch.Tensor],\n+) -> torch.Tensor:\n+    logits = logits / temperature\n+    return torch.softmax(logits, dim=-1, dtype=torch.float32)\ndiff --git a/vllm/v1/sample/rejection_sampler.py b/vllm/v1/sample/rejection_sampler.py\nindex 5601c62e9..6284ae4b4 100644\n--- a/vllm/v1/sample/rejection_sampler.py\n+++ b/vllm/v1/sample/rejection_sampler.py\n@@ -3,25 +3,32 @@ from typing import Optional\n \n import torch\n import torch.nn as nn\n-from torch.nn.utils.rnn import pad_sequence\n+import triton\n+import triton.language as tl\n \n from vllm.logger import init_logger\n from vllm.v1.sample.metadata import SamplingMetadata\n-from vllm.v1.spec_decode.utils import random_sample\n+from vllm.v1.sample.ops.utils import compiled_softmax\n+from vllm.v1.spec_decode.metadata import SpecDecodeMetadata\n \n logger = init_logger(__name__)\n-INVALID_TOKEN_ID = -1\n+\n+PLACEHOLDER_TOKEN_ID: tl.constexpr = -1\n+GREEDY_TEMPERATURE: tl.constexpr = -1\n+# Maximum number of speculative draft tokens allowed per request in a single\n+# step. This value is chosen to be large enough to handle typical use cases.\n+MAX_SPEC_LEN = 32\n \n \n class RejectionSampler(nn.Module):\n     \"\"\"\n-    The implementation strictly follows the algorithm described in \n+    The implementation strictly follows the algorithm described in\n         https://arxiv.org/abs/2211.17192.\n     However, we want to clarify the terminology used in the implementation:\n-    accepted tokens: tokens that are accepted based on the relationship \n+    accepted tokens: tokens that are accepted based on the relationship\n             between the \"raw\" draft and target probabilities.\n     recovered tokens: tokens that are sampled based on the adjusted probability\n-        distribution, which is derived from both the draft and target \n+        distribution, which is derived from both the draft and target\n         probabilities.\n     bonus tokens:\n         If all proposed tokens are accepted, the bonus token is added to the\n@@ -31,48 +38,42 @@ class RejectionSampler(nn.Module):\n         sampling process. For example, we can use top_p, top_k sampling for\n         bonus tokens, while spec decode does not support these sampling\n         strategies.\n-    output tokens: \n-        Tokens are finally generated with the rejection sampler. \n+    output tokens:\n+        Tokens are finally generated with the rejection sampler.\n         output tokens = accepted tokens + recovered tokens + bonus tokens\n     \"\"\"\n \n-    def __init__(self):\n-        super().__init__()\n-\n     def forward(\n         self,\n-        draft_token_ids: list[list[int]],\n+        metadata: SpecDecodeMetadata,\n+        # [num_tokens, vocab_size]\n         draft_probs: Optional[torch.Tensor],\n-        bonus_token_ids_tensor: torch.Tensor,  # [batch_size, 1]\n-        target_probs: torch.Tensor,  # [num_total_tokens, vocab_size]\n+        # [num_tokens, vocab_size]\n+        target_logits: torch.Tensor,\n+        # [batch_size, 1]\n+        bonus_token_ids: torch.Tensor,\n         sampling_metadata: SamplingMetadata,\n     ) -> torch.Tensor:\n         '''\n         Args:\n-            draft_token_ids (List[List[int]]):\n-                A 2D list of token IDs for each request in the batch. \n-                Each request might have different number of draft tokens. \n-                It may also contain empty lists for requests that have \n-                no draft tokens.\n+            metadata:\n+                Metadata for spec decoding.\n             draft_probs (Optional[torch.Tensor]):\n                 Probability distribution for the draft tokens. Shape is\n-                [batch_size, max_spec_len, vocab_size]. Can be None if \n-                probabilities are not provided, which is the case for\n-                ngram spec decode.\n+                [num_tokens, vocab_size]. Can be None if probabilities are\n+                not provided, which is the case for ngram spec decode.\n+            target_logits (torch.Tensor):\n+                Target model's logits probability distribution.\n+                Shape is [num_tokens, vocab_size]. Here, probabilities from\n+                different requests are flattened into a single tensor because\n+                this is the shape of the output logits.\n             bonus_token_ids_tensor (torch.Tensor):\n-                A tensor containing bonus tokens. Shape is [batch_size, 1]. \n-                Bonus tokens are added to the end of the sequence if all \n-                proposed tokens are accepted. We generate the bonus tokens \n-                outside of the rejection sampler with the default sampling \n-                strategy. It allows for more flexibility in the sampling \n+                A tensor containing bonus tokens. Shape is [batch_size, 1].\n+                Bonus tokens are added to the end of the sequence if all\n+                proposed tokens are accepted. We generate the bonus tokens\n+                outside of the rejection sampler with the default sampling\n+                strategy. It allows for more flexibility in the sampling\n                 process such as top_p, top_k sampling.\n-            target_probs (torch.Tensor):\n-                Target model probability distribution.\n-                Shape is [num_total_tokens, vocab_size]. num_total_tokens \n-                is the total number of tokens from all requests. Here, \n-                probabilities from different requests are flattened into\n-                a single tensor because this is the shape of the output \n-                logits.\n             sampling_metadata (SamplingMetadata):\n                 Additional metadata needed for sampling, such as temperature,\n                 top-k/top-p parameters, or other relevant information.\n@@ -80,268 +81,481 @@ class RejectionSampler(nn.Module):\n             output_token_ids (torch.Tensor):\n                 A tensor containing the final output token IDs.\n         '''\n-\n-        # NOTE: The following input preparationg can be moved\n-        # to the model runner with a persistent manner for better\n-        # performance.\n-        # Convert draft token IDs to a tensor, split by sample_lens, then pad.\n-        draft_token_ids = [\n-            torch.tensor(x, dtype=int, device='cpu') for x in draft_token_ids\n-        ]\n-        draft_token_ids_tensor = pad_sequence(draft_token_ids,\n-                                              batch_first=True,\n-                                              padding_value=INVALID_TOKEN_ID)\n-\n-        # NOTE: CPU <-> GPU synchronization happens here.\n-        draft_token_ids_tensor = draft_token_ids_tensor.to(target_probs.device)\n-\n-        # Create one-hot tensor for draft token ids.\n-        # This is used for ngram where we don't have draft_probs.\n-        if draft_probs is None and not sampling_metadata.all_greedy:\n-            vocab_size = target_probs.size(-1)\n-            draft_probs = _create_greedy_token_probs(draft_token_ids_tensor,\n-                                                     vocab_size,\n-                                                     target_probs.device)\n-        sample_lens = [len(x) + 1 for x in draft_token_ids]\n-        target_probs = _convert_2d_probs(target_probs, sample_lens)\n-\n-        return self.forward_native(draft_token_ids_tensor, draft_probs,\n-                                   bonus_token_ids_tensor, target_probs,\n-                                   sampling_metadata)\n-\n-    # TODO: The following method can be optimized for better performance.\n-    def forward_native(\n-        self,\n-        draft_token_ids_tensor: torch.Tensor,\n-        # [batch_size, max_spec_len, vocab_size]\n-        draft_probs: Optional[torch.Tensor],\n-        bonus_token_ids_tensor: torch.Tensor,\n-        # [batch_size, max_spec_len + 1, vocab_size]\n-        target_probs: torch.Tensor,\n-        sampling_metadata: SamplingMetadata,\n-    ) -> torch.Tensor:\n-        # Add 1 to include the 'bonus' token.\n-        if sampling_metadata.all_greedy:\n-            # Produce a mask that remains 1 (True) until the first\n-            # mismatch (cumprod turns 0 after a mismatch).\n-            target_token_ids_tensor = target_probs.argmax(dim=-1)\n-            accept_mask = (target_token_ids_tensor[:, :-1] ==\n-                           draft_token_ids_tensor).cumprod(dim=1)\n-\n-            # Identify valid positions (non-padding).\n-            valid_mask = target_token_ids_tensor != INVALID_TOKEN_ID\n-            # Generate mask with bonus token.\n-            generate_mask = torch.cat([\n-                accept_mask,\n-                torch.zeros(accept_mask.size(0), 1, device=accept_mask.device)\n-            ],\n-                                      dim=1).to(torch.bool) & valid_mask\n-            zeros_mask = (generate_mask == 0)\n-            first_zero_idx = zeros_mask.float().argmax(dim=1)\n-            # Figure out which rows actually contain at least one zero.\n-            rows_with_zero = zeros_mask.any(dim=1)\n-            # Use indexing to set the first zero in each of those rows to 1.\n-            generate_mask[rows_with_zero, first_zero_idx[rows_with_zero]] = 1\n-\n-            output_token_ids = target_token_ids_tensor\n-            output_token_ids[~generate_mask] = INVALID_TOKEN_ID\n-        else:\n-            # Reference: https://arxiv.org/pdf/2211.17192\n-            # 1. Extract the probabilities of the draft tokens.\n-            # [batch_size, max_spec_len]\n-            batch_size = draft_token_ids_tensor.size(0)\n-            max_spec_len = draft_token_ids_tensor.size(1)\n-            invalid_idx = draft_token_ids_tensor == INVALID_TOKEN_ID\n-            draft_token_ids_tensor[invalid_idx] = 0\n-            assert draft_probs is not None\n-            draft_token_probs = draft_probs.gather(\n-                dim=-1, index=draft_token_ids_tensor.unsqueeze(-1)).squeeze(-1)\n-            target_token_probs = target_probs.gather(\n-                dim=-1, index=draft_token_ids_tensor.unsqueeze(-1)).squeeze(-1)\n-            # Force the probabilities of invalid tokens to inf\n-            # so that they are not accepted.\n-            draft_token_probs[invalid_idx] = float('inf')\n-\n-            # 2. Generate uniform samples.\n-            # [batch_size, max_spec_len + 1]\n-            uniform_samples = _create_uniform_samples(\n-                sampling_metadata.generators, batch_size, max_spec_len,\n-                target_probs.device)\n-\n-            # 3. Accept or reject the samples.\n-            # [batch_size, max_spec_len]\n-            # If the draft token probabilities are 0, set them to the smallest\n-            # positive normal value representable by float32.\n-            safe_draft_probs = torch.where(draft_token_probs > 0,\n-                                           draft_token_probs,\n-                                           torch.finfo(torch.float32).tiny)\n-            accepted = uniform_samples <= target_token_probs / safe_draft_probs\n-            accept_mask = accepted.cumprod(dim=1)\n-            # Set the token ids to the draft token ids if accepted, otherwise\n-            # set them to INVALID_TOKEN_ID.\n-            accepted_token_ids = (draft_token_ids_tensor * accept_mask +\n-                                  INVALID_TOKEN_ID * (1 - accept_mask))\n-\n-            # 4. Adjust the distribution for the recovered tokens.\n-            # Clamp the bonus probabilities to the smallest positive normal\n-            # value representable by float32.\n-            bonus_prob = torch.clamp(target_probs[:, :-1, :] - draft_probs,\n-                                     min=torch.finfo(torch.float32).tiny)\n-            normalized_bonus_prob = bonus_prob / bonus_prob.sum(dim=-1,\n-                                                                keepdim=True)\n-\n-            # 5. Sample recovered token ids.\n-            recovered_token_ids = random_sample(\n-                normalized_bonus_prob,\n-                sampling_metadata.generators).reshape(batch_size, max_spec_len)\n-\n-            # 6. Get the final output token ids.\n-            # output_token_ids = accepted_token_ids +\n-            #                    recovered_token_ids +\n-            #                    bonus_token_id\n-            recovered_bonus_token_ids = torch.cat(\n-                [recovered_token_ids, bonus_token_ids_tensor], dim=1)\n-            # Generate mask with bonus tokens.\n-            generate_mask = torch.cat([\n-                accept_mask,\n-                torch.zeros(batch_size, 1, device=accept_mask.device)\n-            ],\n-                                      dim=1).to(torch.bool)\n-            zeros_mask = (generate_mask == 0)\n-            first_zero_idx = zeros_mask.float().argmax(dim=1)\n-            output_token_ids = torch.cat([\n-                accepted_token_ids,\n-                torch.full((batch_size, 1),\n-                           fill_value=INVALID_TOKEN_ID,\n-                           device=accept_mask.device)\n-            ],\n-                                         dim=1)\n-            output_token_ids[torch.arange(batch_size),\n-                             first_zero_idx] = recovered_bonus_token_ids[\n-                                 torch.arange(batch_size), first_zero_idx]\n-\n+        assert metadata.max_spec_len <= MAX_SPEC_LEN\n+        # [num_tokens, vocab_size]\n+        target_probs = compute_probs(\n+            target_logits,\n+            metadata.cu_num_draft_tokens,\n+            sampling_metadata,\n+        )\n+\n+        output_token_ids = rejection_sample(\n+            metadata.draft_token_ids,\n+            metadata.num_draft_tokens,\n+            metadata.max_spec_len,\n+            metadata.cu_num_draft_tokens,\n+            draft_probs,\n+            target_probs,\n+            bonus_token_ids,\n+            sampling_metadata,\n+        )\n         return output_token_ids\n \n-    def compute_probs(self, logits: torch.Tensor,\n-                      sampling_metadata: SamplingMetadata,\n-                      sample_lens: list[int]) -> torch.Tensor:\n-        \"\"\"\n-        Compute probability distribution from logits based on sampling metadata.\n-    \n-        This function applies temperature scaling to the logits and converts \n-        them to probabilities using softmax. Note that division by \n-        temperature is not performed inplace to preserve the original logits \n-        tensor, which will be used by the original sampler to get bonus tokens.\n-        \n-        Args:\n-            logits: Input logits tensor to be converted to probabilities\n-            sampling_metadata: Metadata containing sampling parameters such \n-                    as temperature and whether greedy sampling is used\n-            sample_lens: List of sample lengths used for repeating \n-                    temperature values\n-            \n-        Returns:\n-            torch.Tensor: Probability distribution (softmax of scaled logits) \n-                    if non-greedy sampling is used, otherwise returns the \n-                    original logits\n-        \"\"\"\n+    @staticmethod\n+    def parse_output(\n+        output_token_ids: torch.Tensor,\n+        vocab_size: int,\n+    ) -> list[list[int]]:\n+        output_token_ids_np = output_token_ids.cpu().numpy()\n+        # Create mask for valid tokens.\n+        valid_mask = ((output_token_ids_np != PLACEHOLDER_TOKEN_ID) &\n+                      (output_token_ids_np < vocab_size))\n+        outputs = [\n+            row[valid_mask[i]].tolist()\n+            for i, row in enumerate(output_token_ids_np)\n+        ]\n+        return outputs\n+\n+\n+def rejection_sample(\n+    # [num_tokens]\n+    draft_token_ids: torch.Tensor,\n+    # [batch_size]\n+    num_draft_tokens: list[int],\n+    max_spec_len: int,\n+    # [batch_size]\n+    cu_num_draft_tokens: torch.Tensor,\n+    # [num_tokens, vocab_size]\n+    draft_probs: Optional[torch.Tensor],\n+    # [num_tokens, vocab_size]\n+    target_probs: torch.Tensor,\n+    # [batch_size, 1]\n+    bonus_token_ids: torch.Tensor,\n+    sampling_metadata: SamplingMetadata,\n+) -> torch.Tensor:\n+    assert draft_token_ids.ndim == 1\n+    assert draft_probs is None or draft_probs.ndim == 2\n+    assert cu_num_draft_tokens.ndim == 1\n+    assert target_probs.ndim == 2\n+\n+    batch_size = len(num_draft_tokens)\n+    num_tokens = draft_token_ids.shape[0]\n+    vocab_size = target_probs.shape[-1]\n+    device = target_probs.device\n+    assert draft_token_ids.is_contiguous()\n+    assert draft_probs is None or draft_probs.is_contiguous()\n+    assert target_probs.is_contiguous()\n+    assert bonus_token_ids.is_contiguous()\n+    assert target_probs.shape == (num_tokens, vocab_size)\n+\n+    # Create output buffer.\n+    output_token_ids = torch.empty(\n+        (batch_size, max_spec_len + 1),\n+        dtype=torch.int32,  # Consistent with SamplerOutput.sampled_token_ids.\n+        device=device,\n+    )\n+    output_token_ids.fill_(PLACEHOLDER_TOKEN_ID)\n+\n+    if sampling_metadata.all_greedy:\n+        is_greedy = None\n+    else:\n+        is_greedy = sampling_metadata.temperature == GREEDY_TEMPERATURE\n+    if not sampling_metadata.all_random:\n+        # Rejection sampling for greedy sampling requests.\n+        target_argmax = target_probs.argmax(dim=-1)\n+        rejection_greedy_sample_kernel[(batch_size, )](\n+            output_token_ids,\n+            cu_num_draft_tokens,\n+            draft_token_ids,\n+            target_argmax,\n+            bonus_token_ids,\n+            is_greedy,\n+            max_spec_len,\n+            num_warps=1,\n+        )\n         if sampling_metadata.all_greedy:\n-            return logits\n-        assert sampling_metadata.temperature is not None\n-        # We should optimize the following code as\n-        # it will cause CPU -> GPU synchronization.\n-        temperature = torch.repeat_interleave(\n-            sampling_metadata.temperature,\n-            torch.tensor(sample_lens,\n-                         device=sampling_metadata.temperature.device))\n-        temperature = temperature.unsqueeze(dim=1)\n-        logits = logits / temperature\n-        return logits.softmax(dim=-1, dtype=torch.float32)\n-\n-\n-def _create_greedy_token_probs(\n-    token_ids: torch.Tensor,\n-    vocab_size: int,\n-    out_device: torch.device,\n+            return output_token_ids\n+\n+    # Generate uniform probabilities for rejection sampling.\n+    # [num_tokens]\n+    uniform_probs = generate_uniform_probs(\n+        num_tokens,\n+        num_draft_tokens,\n+        sampling_metadata.generators,\n+        device,\n+    )\n+\n+    # Sample recovered tokens for each position.\n+    # [num_tokens]\n+    recovered_token_ids = sample_recovered_tokens(\n+        max_spec_len,\n+        num_draft_tokens,\n+        cu_num_draft_tokens,\n+        draft_token_ids,\n+        draft_probs,\n+        target_probs,\n+        sampling_metadata,\n+        device,\n+    )\n+\n+    # Rejection sampling for random sampling requests.\n+    rejection_random_sample_kernel[(batch_size, )](\n+        output_token_ids,\n+        cu_num_draft_tokens,\n+        draft_token_ids,\n+        draft_probs,\n+        target_probs,\n+        bonus_token_ids,\n+        recovered_token_ids,\n+        uniform_probs,\n+        is_greedy,\n+        max_spec_len,\n+        vocab_size,\n+        IS_NGRAM=draft_probs is None,\n+        num_warps=1,\n+    )\n+    return output_token_ids\n+\n+\n+def compute_probs(\n+    logits: torch.Tensor,  # [num_tokens, vocab_size]\n+    cu_num_draft_tokens: torch.Tensor,  # [batch_size]\n+    sampling_metadata: SamplingMetadata,\n ) -> torch.Tensor:\n-    batch_size, num_tokens = token_ids.shape\n-\n-    token_probs = torch.zeros(batch_size,\n-                              num_tokens,\n-                              vocab_size,\n-                              dtype=torch.float,\n-                              device=out_device)\n-\n-    # Ignore INVALID_TOKEN_ID.\n-    valid_mask = (token_ids != INVALID_TOKEN_ID)\n-    valid_indices = token_ids.clone()\n-    valid_indices[~valid_mask] = 0\n-\n-    token_probs.scatter_(dim=2,\n-                         index=valid_indices.unsqueeze(-1),\n-                         src=valid_mask.unsqueeze(-1).float())\n-\n-    return token_probs\n-\n-\n-def _convert_2d_probs(\n-        probs: torch.Tensor,  # [num_total_tokens, vocab_size]\n-        sample_lens: list[int]) -> torch.Tensor:\n+    \"\"\"Compute probability distribution from logits based on sampling metadata.\n+\n+    This function applies temperature scaling to the logits and converts\n+    them to probabilities using softmax. For greedy decoding, it returns\n+    the original logits.\n+\n+    Args:\n+        logits: Input logits tensor to be converted to probabilities.\n+        cu_num_draft_tokens: Cumulative number of draft tokens.\n+        sampling_metadata: Metadata containing sampling parameters such as\n+            temperature and whether greedy sampling is used.\n+\n+    Returns:\n+        torch.Tensor: Probability distribution (softmax of scaled logits)\n+            if non-greedy sampling is used, otherwise returns the\n+            original logits.\n     \"\"\"\n-        Converts a 2D tensor of probabilities to a 3D tensor with padding.\n-        [num_total_tokens, vocab_size] -> \n-            [batch_size, max_spec_len + 1, vocab_size]\n+    assert logits.ndim == 2\n+    assert cu_num_draft_tokens.ndim == 1\n+    if sampling_metadata.all_greedy:\n+        return logits\n+\n+    num_tokens = logits.shape[0]\n+    batch_size = cu_num_draft_tokens.shape[0]\n+    expanded_temperature = torch.empty(\n+        (num_tokens, 1),\n+        dtype=torch.float32,\n+        device=logits.device,\n+    )\n+    expand_kernel[(batch_size, )](\n+        expanded_temperature,\n+        sampling_metadata.temperature,\n+        cu_num_draft_tokens,\n+        GREEDY_TEMPERATURE,  # replace_from\n+        1,  # replace_to\n+        MAX_NUM_TOKENS=MAX_SPEC_LEN,\n+        num_warps=1,\n+    )\n+    output_prob = compiled_softmax(logits, expanded_temperature)\n+    return output_prob\n+\n+\n+def generate_uniform_probs(\n+    num_tokens: int,\n+    num_draft_tokens: list[int],\n+    generators: dict[int, torch.Generator],\n+    device: torch.device,\n+) -> torch.Tensor:\n     \"\"\"\n-    cumulative_lens = torch.cumsum(torch.tensor(sample_lens,\n-                                                device=probs.device),\n-                                   dim=0)\n-    split_indices = cumulative_lens[:-1].tolist()  # Exclude last index\n-\n-    # Split into chunks without loops\n-    chunks = torch.tensor_split(probs, split_indices, dim=0)\n-\n-    # Pad all sequences to maximum length\n-    padded_probs = pad_sequence(chunks, batch_first=True, padding_value=0.0)\n-    return padded_probs\n-\n-\n-def _create_uniform_samples(seeded_seqs: dict[int, torch.Generator],\n-                            batch_size: int, k: int,\n-                            device: torch.device) -> torch.Tensor:\n+    Generates a batch of uniform random samples, with optional seeding\n+    if available.\n+\n+    This method creates a tensor of shape `(num_tokens, )` filled\n+    with uniform random values in the range [0, 1). If `generators` is provided,\n+    the requests with their own seeds will use the provided `torch.Generator`\n+    for reproducibility. The samples for the other requests will be generated\n+    without a seed.\n+\n+    Args:\n+        num_tokens : int\n+            Total number of tokens.\n+        num_draft_tokens : List[List[int]]\n+            Number of draft tokens per request.\n+        generators : Optional[Dict[int, torch.Generator]]\n+            A dictionary mapping indices in the batch to\n+            `torch.Generator` objects.\n+        device : torch.device\n+            The device on which to allocate the tensor.\n+    Returns:\n+        uniform_rand : torch.Tensor\n+            A tensor of shape `(num_tokens, )` containing uniform\n+            random values in the range [0, 1).\n     \"\"\"\n-        Generates a batch of uniform random samples, with optional seeding \n-        for specific sequences.\n-\n-        This method creates a tensor of shape `(batch_size, k)` filled \n-        with uniform random values in the range [0, 1). If `seeded_seqs` \n-        is provided, the sequences corresponding to specific indices \n-        will be generated using the provided `torch.Generator` for \n-        reproducibility. The other sequences will be generated without \n-        a seed.\n-\n-        Args:\n-            seeded_seqs : Optional[Dict[int, torch.Generator]]\n-                A dictionary mapping indices in the batch to \n-                `torch.Generator` objects.\n-            batch_size : int\n-                The number of sequences to generate.\n-            k : int\n-                The number of random samples per sequence.\n-            device : torch.device\n-                The device on which to allocate the tensor.\n-\n-        Returns:\n-            uniform_rand : torch.Tensor\n-                A tensor of shape `(batch_size, k)` containing uniform \n-                random values in the range [0, 1).\n-        \"\"\"\n-\n-    uniform_rand = torch.rand(batch_size,\n-                              k,\n-                              dtype=torch.float32,\n-                              device=device)\n-    # Apply seeded generators only where needed\n-    if seeded_seqs:\n-        for idx, generator in seeded_seqs.items():\n-            uniform_rand[idx].uniform_(0, 1, generator=generator)\n-    return uniform_rand\n+    uniform_probs = torch.rand(\n+        (num_tokens, ),\n+        dtype=torch.float32,\n+        device=device,\n+    )\n+    start_idx = 0\n+    for req_idx, n in enumerate(num_draft_tokens):\n+        # Do not generate random numbers for requests with no draft tokens.\n+        # This can be important for reproducibility.\n+        if n == 0:\n+            continue\n+        end_idx = start_idx + n\n+        generator = generators.get(req_idx)\n+        if generator is not None:\n+            uniform_probs[start_idx:end_idx].uniform_(generator=generator)\n+        start_idx = end_idx\n+    return uniform_probs\n+\n+\n+def sample_recovered_tokens(\n+    max_spec_len: int,\n+    num_draft_tokens: list[int],\n+    # [batch_size]\n+    cu_num_draft_tokens: torch.Tensor,\n+    # [num_tokens]\n+    draft_token_ids: torch.Tensor,\n+    # [num_tokens, vocab_size]\n+    draft_probs: Optional[torch.Tensor],\n+    # [num_tokens, vocab_size]\n+    target_probs: torch.Tensor,\n+    sampling_metadata: SamplingMetadata,\n+    device: torch.device,\n+) -> torch.Tensor:\n+    # NOTE(woosuk): Create only one distribution for each request.\n+    batch_size = len(num_draft_tokens)\n+    vocab_size = target_probs.shape[-1]\n+    q = torch.empty(\n+        (batch_size, vocab_size),\n+        dtype=torch.float32,\n+        device=device,\n+    )\n+    q.exponential_()\n+    for i, generator in sampling_metadata.generators.items():\n+        # Do not generate random numbers for requests with no draft tokens.\n+        # This can be important for reproducibility.\n+        if num_draft_tokens[i] > 0:\n+            q[i].exponential_(generator=generator)\n+\n+    recovered_token_ids = torch.empty_like(draft_token_ids)\n+    sample_recovered_tokens_kernel[(batch_size, max_spec_len)](\n+        recovered_token_ids,\n+        cu_num_draft_tokens,\n+        draft_token_ids,\n+        draft_probs,\n+        target_probs,\n+        q,\n+        vocab_size,\n+        triton.next_power_of_2(vocab_size),\n+        IS_NGRAM=draft_probs is None,\n+    )\n+    return recovered_token_ids\n+\n+\n+# NOTE(woosuk): Avoid specialization to prevent unnecessary recompilation.\n+@triton.jit(do_not_specialize=[\"max_spec_len\"])\n+def rejection_greedy_sample_kernel(\n+    output_token_ids_ptr,  # [batch_size, max_spec_len + 1]\n+    cu_num_draft_tokens_ptr,  # [batch_size]\n+    draft_token_ids_ptr,  # [num_tokens]\n+    target_argmax_ptr,  # [num_tokens]\n+    bonus_token_ids_ptr,  # [batch_size]\n+    is_greedy_ptr,  # [batch_size] or None\n+    max_spec_len,\n+):\n+    req_idx = tl.program_id(0)\n+    # FIXME(woosuk): Because is_greedy_ptr is not None at profiling run,\n+    # re-compilation may happen during runtime when is_greedy_ptr is None.\n+    if is_greedy_ptr is None:\n+        is_greedy = True\n+    else:\n+        is_greedy = tl.load(is_greedy_ptr + req_idx)\n+    if not is_greedy:\n+        # Early exit for non-greedy sampling requests.\n+        return\n+\n+    if req_idx == 0:\n+        start_idx = 0\n+    else:\n+        start_idx = tl.load(cu_num_draft_tokens_ptr + req_idx - 1)\n+    end_idx = tl.load(cu_num_draft_tokens_ptr + req_idx)\n+    num_draft_tokens = end_idx - start_idx\n+\n+    rejected = False\n+    for pos in range(num_draft_tokens):\n+        if not rejected:\n+            draft_token_id = tl.load(draft_token_ids_ptr + start_idx + pos)\n+            target_argmax_id = tl.load(target_argmax_ptr + start_idx + pos)\n+            tl.store(output_token_ids_ptr + req_idx * (max_spec_len + 1) + pos,\n+                     target_argmax_id)\n+            if draft_token_id != target_argmax_id:\n+                # Reject.\n+                rejected = True\n+\n+    if not rejected:\n+        # If all tokens are accepted, append the bonus token.\n+        bonus_token_id = tl.load(bonus_token_ids_ptr + req_idx)\n+        tl.store(\n+            output_token_ids_ptr + req_idx * (max_spec_len + 1) +\n+            num_draft_tokens, bonus_token_id)\n+\n+\n+# NOTE(woosuk): Avoid specialization to prevent unnecessary recompilation.\n+@triton.jit(do_not_specialize=[\"max_spec_len\"])\n+def rejection_random_sample_kernel(\n+    output_token_ids_ptr,  # [batch_size, max_spec_len + 1]\n+    cu_num_draft_tokens_ptr,  # [batch_size]\n+    draft_token_ids_ptr,  # [num_tokens]\n+    draft_probs_ptr,  # [num_tokens, vocab_size] or None\n+    target_probs_ptr,  # [num_tokens, vocab_size]\n+    bonus_token_ids_ptr,  # [batch_size]\n+    recovered_token_ids_ptr,  # [num_tokens]\n+    uniform_probs_ptr,  # [num_tokens]\n+    is_greedy_ptr,  # [batch_size]\n+    max_spec_len,\n+    vocab_size,\n+    IS_NGRAM: tl.constexpr,\n+):\n+    req_idx = tl.program_id(0)\n+    is_greedy = tl.load(is_greedy_ptr + req_idx)\n+    if is_greedy:\n+        # Early exit for greedy sampling requests.\n+        return\n+\n+    if req_idx == 0:\n+        start_idx = 0\n+    else:\n+        start_idx = tl.load(cu_num_draft_tokens_ptr + req_idx - 1)\n+    end_idx = tl.load(cu_num_draft_tokens_ptr + req_idx)\n+    num_draft_tokens = end_idx - start_idx\n+\n+    rejected = False\n+    for pos in range(num_draft_tokens):\n+        if not rejected:\n+            draft_token_id = tl.load(draft_token_ids_ptr + start_idx + pos)\n+            if IS_NGRAM:\n+                draft_prob = 1\n+            else:\n+                draft_prob = tl.load(draft_probs_ptr +\n+                                     (start_idx + pos) * vocab_size +\n+                                     draft_token_id)\n+            target_prob = tl.load(target_probs_ptr +\n+                                  (start_idx + pos) * vocab_size +\n+                                  draft_token_id)\n+            uniform_prob = tl.load(uniform_probs_ptr + start_idx + pos)\n+            # NOTE(woosuk): While the draft probability should never be 0,\n+            # we check it to avoid NaNs. If it happens to be 0, we reject.\n+            if draft_prob > 0 and target_prob / draft_prob >= uniform_prob:\n+                # Accept.\n+                token_id = draft_token_id\n+            else:\n+                # Reject. Use recovered token.\n+                rejected = True\n+                token_id = tl.load(recovered_token_ids_ptr + start_idx + pos)\n+            tl.store(output_token_ids_ptr + req_idx * (max_spec_len + 1) + pos,\n+                     token_id)\n+\n+    if not rejected:\n+        # If all tokens are accepted, append the bonus token.\n+        bonus_token_id = tl.load(bonus_token_ids_ptr + req_idx)\n+        tl.store(\n+            output_token_ids_ptr + req_idx * (max_spec_len + 1) +\n+            num_draft_tokens, bonus_token_id)\n+\n+\n+# NOTE(woosuk): Avoid specialization to prevent unnecessary recompilation.\n+@triton.jit(do_not_specialize=[\"replace_from\", \"replace_to\"])\n+def expand_kernel(\n+    output_ptr,  # [num_tokens]\n+    input_ptr,  # [batch_size]\n+    cu_num_tokens_ptr,  # [batch_size]\n+    replace_from,\n+    replace_to,\n+    MAX_NUM_TOKENS: tl.constexpr,\n+):\n+    req_idx = tl.program_id(0)\n+    if req_idx == 0:  # noqa: SIM108\n+        start_idx = 0\n+    else:\n+        start_idx = tl.load(cu_num_tokens_ptr + req_idx - 1)\n+    end_idx = tl.load(cu_num_tokens_ptr + req_idx)\n+    num_tokens = end_idx - start_idx\n+\n+    src_val = tl.load(input_ptr + req_idx)\n+    src_val = tl.where(src_val == replace_from, replace_to, src_val)\n+    offset = tl.arange(0, MAX_NUM_TOKENS)\n+    tl.store(output_ptr + start_idx + offset,\n+             src_val,\n+             mask=offset < num_tokens)\n+\n+\n+@triton.jit\n+def sample_recovered_tokens_kernel(\n+    output_token_ids_ptr,  # [num_tokens]\n+    cu_num_draft_tokens_ptr,  # [batch_size]\n+    draft_token_ids_ptr,  # [num_tokens]\n+    draft_probs_ptr,  # [num_tokens, vocab_size] or None\n+    target_probs_ptr,  # [num_tokens, vocab_size]\n+    q_ptr,  # [batch_size, vocab_size]\n+    vocab_size,\n+    PADDED_VOCAB_SIZE: tl.constexpr,\n+    IS_NGRAM: tl.constexpr,\n+):\n+    req_idx = tl.program_id(0)\n+    if req_idx == 0:\n+        start_idx = 0\n+    else:\n+        start_idx = tl.load(cu_num_draft_tokens_ptr + req_idx - 1)\n+    end_idx = tl.load(cu_num_draft_tokens_ptr + req_idx)\n+    num_draft_tokens = end_idx - start_idx\n+\n+    # Early exit for out-of-range positions.\n+    pos = tl.program_id(1)\n+    if pos >= num_draft_tokens:\n+        return\n+\n+    vocab_offset = tl.arange(0, PADDED_VOCAB_SIZE)\n+    if IS_NGRAM:\n+        draft_token_id = tl.load(draft_token_ids_ptr + start_idx + pos)\n+        orig_prob = tl.load(target_probs_ptr + (start_idx + pos) * vocab_size +\n+                            draft_token_id)\n+        # Temporarily zero out the probability of the draft token.\n+        # This is essentially the same as target_prob - draft_prob, except that\n+        # n-gram does not have draft_prob. We regard it as 1.\n+        tl.store(\n+            target_probs_ptr + (start_idx + pos) * vocab_size + draft_token_id,\n+            0)\n+        prob = tl.load(target_probs_ptr + (start_idx + pos) * vocab_size +\n+                       vocab_offset,\n+                       mask=vocab_offset < vocab_size,\n+                       other=0)\n+    else:\n+        draft_prob = tl.load(draft_probs_ptr + (start_idx + pos) * vocab_size +\n+                             vocab_offset,\n+                             mask=vocab_offset < vocab_size,\n+                             other=0)\n+        target_prob = tl.load(target_probs_ptr +\n+                              (start_idx + pos) * vocab_size + vocab_offset,\n+                              mask=vocab_offset < vocab_size,\n+                              other=0)\n+        prob = tl.maximum(target_prob - draft_prob, 0)\n+        # NOTE(woosuk): We don't need `prob = prob / tl.sum(prob)` here because\n+        # `tl.argmax` will select the maximum value.\n+\n+    q = tl.load(q_ptr + req_idx * vocab_size + vocab_offset,\n+                mask=vocab_offset < vocab_size,\n+                other=float(\"-inf\"))\n+    recovered_id = tl.argmax(prob / q, axis=-1)\n+    tl.store(output_token_ids_ptr + start_idx + pos, recovered_id)\n+\n+    if IS_NGRAM:\n+        # Restore the original probability.\n+        tl.store(\n+            target_probs_ptr + (start_idx + pos) * vocab_size + draft_token_id,\n+            orig_prob)\ndiff --git a/vllm/v1/spec_decode/metadata.py b/vllm/v1/spec_decode/metadata.py\nnew file mode 100644\nindex 000000000..1cf650d5f\n--- /dev/null\n+++ b/vllm/v1/spec_decode/metadata.py\n@@ -0,0 +1,61 @@\n+# SPDX-License-Identifier: Apache-2.0\n+from dataclasses import dataclass\n+\n+import numpy as np\n+import torch\n+\n+\n+@dataclass\n+class SpecDecodeMetadata:\n+\n+    # [num_tokens]\n+    draft_token_ids: torch.Tensor\n+    # [batch_size]\n+    num_draft_tokens: list[int]\n+    # [batch_size]\n+    cu_num_draft_tokens: torch.Tensor\n+    # [num_tokens]\n+    target_logits_indices: torch.Tensor\n+    # [batch_size]\n+    bonus_logits_indices: torch.Tensor\n+    # [num_tokens + batch_size]\n+    logits_indices: torch.Tensor\n+\n+    def __post_init__(self):\n+        self.max_spec_len = max(self.num_draft_tokens)\n+\n+    @classmethod\n+    def make_dummy(\n+        cls,\n+        draft_token_ids: list[list[int]],\n+        device: torch.device,\n+    ) -> \"SpecDecodeMetadata\":\n+        batch_size = len(draft_token_ids)\n+        num_draft_tokens = [len(ids) for ids in draft_token_ids]\n+        flattened_draft_token_ids = sum(draft_token_ids, [])\n+        num_tokens = len(flattened_draft_token_ids)\n+\n+        draft_token_ids_tensor = torch.tensor(flattened_draft_token_ids,\n+                                              dtype=torch.int32,\n+                                              device=device)\n+        cu_num_draft_tokens = np.cumsum(num_draft_tokens, dtype=np.int32)\n+        cu_num_draft_tokens_tensor = torch.from_numpy(cu_num_draft_tokens).to(\n+            device)\n+\n+        target_logits_indices = torch.zeros(num_tokens,\n+                                            dtype=torch.int32,\n+                                            device=device)\n+        bonus_logits_indices = torch.zeros(batch_size,\n+                                           dtype=torch.int32,\n+                                           device=device)\n+        logits_indices = torch.zeros(num_tokens + batch_size,\n+                                     dtype=torch.int32,\n+                                     device=device)\n+        return cls(\n+            draft_token_ids=draft_token_ids_tensor,\n+            num_draft_tokens=num_draft_tokens,\n+            cu_num_draft_tokens=cu_num_draft_tokens_tensor,\n+            target_logits_indices=target_logits_indices,\n+            bonus_logits_indices=bonus_logits_indices,\n+            logits_indices=logits_indices,\n+        )\ndiff --git a/vllm/v1/spec_decode/utils.py b/vllm/v1/spec_decode/utils.py\nindex 584140136..d5329ef7b 100644\n--- a/vllm/v1/spec_decode/utils.py\n+++ b/vllm/v1/spec_decode/utils.py\n@@ -1,5 +1,4 @@\n # SPDX-License-Identifier: Apache-2.0\n-from vllm.v1.sample.ops.topk_topp_sampler import random_sample  # noqa\n from vllm.v1.worker.gpu_input_batch import InputBatch\n \n \ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 66015382b..657333c6d 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -34,7 +34,8 @@ from vllm.v1.kv_cache_interface import (FullAttentionSpec, KVCacheConfig,\n from vllm.v1.outputs import (EMPTY_MODEL_RUNNER_OUTPUT, LogprobsTensors,\n                              ModelRunnerOutput)\n from vllm.v1.sample.metadata import SamplingMetadata\n-from vllm.v1.sample.rejection_sampler import INVALID_TOKEN_ID, RejectionSampler\n+from vllm.v1.sample.rejection_sampler import RejectionSampler\n+from vllm.v1.spec_decode.metadata import SpecDecodeMetadata\n from vllm.v1.spec_decode.ngram_proposer import NgramProposer\n from vllm.v1.spec_decode.utils import is_spec_decode_supported\n from vllm.v1.utils import bind_kv_cache\n@@ -149,7 +150,6 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         self.use_spec_decode = False\n         if self.speculative_config:\n             self.use_spec_decode = True\n-            self.rejection_sampler = RejectionSampler()\n             # TODO: find a better way to check if we are using ngram.\n             assert self.speculative_config.ngram_prompt_lookup_min, \\\n                     \"Currently, only ngram spec decode is supported in V1.\"\n@@ -162,6 +162,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                     self.speculative_config.ngram_prompt_lookup_min,\n                     self.speculative_config.num_speculative_tokens,\n                 )\n+                self.rejection_sampler = RejectionSampler()\n \n         # Request states.\n         self.requests: dict[str, CachedRequestState] = {}\n@@ -452,7 +453,8 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n     def _prepare_inputs(\n         self,\n         scheduler_output: \"SchedulerOutput\",\n-    ) -> tuple[FlashAttentionMetadata, torch.Tensor]:\n+    ) -> tuple[FlashAttentionMetadata, torch.Tensor,\n+               Optional[SpecDecodeMetadata]]:\n         total_num_scheduled_tokens = scheduler_output.total_num_scheduled_tokens\n         assert total_num_scheduled_tokens > 0\n         num_reqs = self.input_batch.num_reqs\n@@ -577,22 +579,33 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n \n         use_spec_decode = len(\n             scheduler_output.scheduled_spec_decode_tokens) > 0\n-        if use_spec_decode:\n-            logits_indices = self._calc_spec_decode_metadata(\n-                scheduler_output, cu_num_tokens)\n-        else:\n+        if not use_spec_decode:\n             # NOTE(woosuk): Due to chunked prefills, the batch may contain\n             # partial requests. While we should not sample any token\n             # from these partial requests, we do so for simplicity.\n             # We will ignore the sampled tokens from the partial requests.\n             # TODO: Support prompt logprobs.\n             logits_indices = attn_metadata.query_start_loc[1:] - 1\n+            spec_decode_metadata = None\n+        else:\n+            # Get the number of draft tokens for each request.\n+            # Iterate over the dictionary rather than all requests since not all\n+            # requests have draft tokens.\n+            num_draft_tokens = np.zeros(num_reqs, dtype=np.int32)\n+            for req_id, draft_token_ids in (\n+                    scheduler_output.scheduled_spec_decode_tokens.items()):\n+                req_idx = self.input_batch.req_id_to_index[req_id]\n+                num_draft_tokens[req_idx] = len(draft_token_ids)\n+\n+            spec_decode_metadata = self._calc_spec_decode_metadata(\n+                num_draft_tokens, cu_num_tokens)\n+            logits_indices = spec_decode_metadata.logits_indices\n \n         # Hot-Swap lora model\n         if self.lora_config:\n             self.set_active_loras(self.input_batch, num_scheduled_tokens)\n \n-        return attn_metadata, logits_indices\n+        return attn_metadata, logits_indices, spec_decode_metadata\n \n     def _compute_cascade_attn_prefix_len(\n         self,\n@@ -732,50 +745,79 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n \n     def _calc_spec_decode_metadata(\n         self,\n-        scheduler_output: \"SchedulerOutput\",\n-        cu_num_tokens: np.ndarray,\n-    ) -> torch.Tensor:\n-        # Get the number of spec decode tokens for each request.\n-        num_reqs = self.input_batch.num_reqs\n-        num_spec_decode_tokens = np.empty(num_reqs, dtype=np.int32)\n-        for i, req_id in enumerate(self.input_batch.req_ids):\n-            num_spec_decode_tokens[i] = len(\n-                scheduler_output.scheduled_spec_decode_tokens.get(req_id, ()))\n-\n-        # Get spec decode logits indices.\n-        # E.g.,   num_scheduled_tokens: [4, 100, 3,   100, 2]\n-        #         cu_num_tokens:        [4, 104, 107, 207, 209]\n-        #         num_spec_tokens_list: [3, 0,   2,   0,   1]\n-        #         num_sampled_tokens:   [4, 1,   3,   1,   2]\n-        #         spec_decode_logits_indices:\n-        #                 [0, 1, 2, 3, 103, 104, 105, 106, 206, 207, 208]\n-        num_sampled_tokens = num_spec_decode_tokens + 1\n-        # logits_start_loc: [0, 103, 104, 206, 207]\n-        logits_start_loc = cu_num_tokens - num_sampled_tokens\n-        # [0, 103, 104, 206, 207] ->\n-        #               [0, 0, 0, 0, 103, 104, 104, 104, 206, 207, 207]\n-        logits_start_loc = np.repeat(logits_start_loc, num_sampled_tokens)\n-        # The following three lines:\n-        # [4, 1,   3,   1,   2] -> [0, 1, 2, 3, 0, 0, 1, 2, 0, 0, 1]\n-        # Step 1. [4, 1, 3, 1, 2] -> [4, 5, 8, 9, 11]\n-        cu_num_sampled_tokens = np.cumsum(num_sampled_tokens)\n-        # Step 2. [4, 5, 8, 9, 11] -> [0, 4, 5, 8, 9]\n-        #         -> [0, 0, 0, 0, 4, 5, 5, 5, 8, 9, 9]\n-        cumsums_sampled_offsets = np.repeat(\n-            cu_num_sampled_tokens - num_sampled_tokens, num_sampled_tokens)\n-        # Step 3.  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n-        #       -  [0, 0, 0, 0, 4, 5, 5, 5, 8, 9, 9]\n-        #      -> [0, 1, 2, 3, 0, 0, 1, 2, 0, 0, 1]\n-        total_num_sampled_tokens = num_sampled_tokens.sum()\n-        sampled_arange = (self.arange_np[:total_num_sampled_tokens] -\n-                          cumsums_sampled_offsets)\n-\n-        # [0, 0, 0, 0, 103, 104, 104, 104, 206, 207, 207] ->\n-        # [0, 1, 2, 3, 103, 104, 105, 106, 206, 207, 208]\n-        spec_decode_logits_indices = logits_start_loc + sampled_arange\n-        return torch.from_numpy(spec_decode_logits_indices).to(\n+        num_draft_tokens: np.ndarray,\n+        cu_num_scheduled_tokens: np.ndarray,\n+    ) -> SpecDecodeMetadata:\n+        # Inputs:\n+        # cu_num_scheduled_tokens:  [  4, 104, 107, 207, 209]\n+        # num_draft_tokens:         [  3,   0,   2,   0,   1]\n+        # Outputs:\n+        # cu_num_draft_tokens:      [  3,   3,   5,   5,   6]\n+        # logits_indices:           [  0,   1,   2,   3, 103, 104, 105, 106,\n+        #                            206, 207, 208]\n+        # target_logits_indices:    [  0,   1,   2,   5,   6,   9]\n+        # bonus_logits_indices:     [  3,   4,   7,   8,  10]\n+\n+        # Compute the logits indices.\n+        # [4, 1, 3, 1, 2]\n+        num_sampled_tokens = num_draft_tokens + 1\n+        # Step 1. [4, 5, 8, 9, 11]\n+        cu_num_sampled_tokens = np.cumsum(num_sampled_tokens, dtype=np.int32)\n+        total_num_sampled_tokens = cu_num_sampled_tokens[-1]\n+        # Step 2. [0, 0, 0, 0, 4, 5, 5, 5, 8, 9, 9]\n+        cumsums_offsets = np.repeat(cu_num_sampled_tokens - num_sampled_tokens,\n+                                    num_sampled_tokens)\n+        # Step 3. [0, 1, 2, 3, 0, 0, 1, 2, 0, 0, 1]\n+        arange = self.arange_np[:total_num_sampled_tokens] - cumsums_offsets\n+        # Step 4. [0, 0, 0, 0, 103, 104, 104, 104, 206, 207, 207]\n+        logits_indices = np.repeat(\n+            cu_num_scheduled_tokens - num_sampled_tokens, num_sampled_tokens)\n+        # Step 5. [0, 1, 2, 3, 103, 104, 105, 106, 206, 207, 208]\n+        logits_indices += arange\n+\n+        # Compute the bonus logits indices.\n+        bonus_logits_indices = cu_num_sampled_tokens - 1\n+\n+        # Compute the draft logits indices.\n+        # [3, 3, 5, 5, 6]\n+        cu_num_draft_tokens = np.cumsum(num_draft_tokens, dtype=np.int32)\n+        total_num_draft_tokens = cu_num_draft_tokens[-1]\n+        # [0, 0, 0, 3, 3, 5]\n+        cumsums_offsets = np.repeat(cu_num_draft_tokens - num_draft_tokens,\n+                                    num_draft_tokens)\n+        # [0, 1, 2, 0, 1, 0]\n+        arange = self.arange_np[:total_num_draft_tokens] - cumsums_offsets\n+        # [0, 0, 0, 5, 5, 9]\n+        target_logits_indices = np.repeat(\n+            cu_num_sampled_tokens - num_sampled_tokens, num_draft_tokens)\n+        # [0, 1, 2, 5, 6, 9]\n+        target_logits_indices += arange\n+\n+        # TODO: Optimize the CPU -> GPU copy.\n+        cu_num_draft_tokens = torch.from_numpy(cu_num_draft_tokens).to(\n+            self.device, non_blocking=True)\n+        logits_indices = torch.from_numpy(logits_indices).to(self.device,\n+                                                             non_blocking=True)\n+        target_logits_indices = torch.from_numpy(target_logits_indices).to(\n+            self.device, non_blocking=True)\n+        bonus_logits_indices = torch.from_numpy(bonus_logits_indices).to(\n             self.device, non_blocking=True)\n \n+        # Compute the draft token ids.\n+        # draft_token_indices:      [  1,   2,   3, 105, 106, 208]\n+        draft_token_ids = self.input_ids[logits_indices]\n+        draft_token_ids = draft_token_ids[target_logits_indices + 1]\n+\n+        metadata = SpecDecodeMetadata(\n+            draft_token_ids=draft_token_ids,\n+            num_draft_tokens=num_draft_tokens.tolist(),\n+            cu_num_draft_tokens=cu_num_draft_tokens,\n+            target_logits_indices=target_logits_indices,\n+            bonus_logits_indices=bonus_logits_indices,\n+            logits_indices=logits_indices,\n+        )\n+        return metadata\n+\n     def _execute_encoder(self, scheduler_output: \"SchedulerOutput\"):\n         scheduled_encoder_inputs = scheduler_output.scheduled_encoder_inputs\n         if not scheduled_encoder_inputs:\n@@ -931,7 +973,8 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n             encoder_outputs = []\n \n         # Prepare the decoder inputs.\n-        attn_metadata, logits_indices = self._prepare_inputs(scheduler_output)\n+        attn_metadata, logits_indices, spec_decode_metadata = (\n+            self._prepare_inputs(scheduler_output))\n         num_scheduled_tokens = scheduler_output.total_num_scheduled_tokens\n         if (self.use_cuda_graph\n                 and num_scheduled_tokens <= self.cudagraph_batch_sizes[-1]):\n@@ -1006,31 +1049,29 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n \n         # Sample the next token and get logprobs if needed.\n         sampling_metadata = self.input_batch.sampling_metadata\n-        if not self.use_spec_decode:\n+        if spec_decode_metadata is None:\n             sampler_output = self.model.sample(\n                 logits=logits,\n                 sampling_metadata=sampling_metadata,\n             )\n         else:\n-            draft_token_ids = [\n-                scheduler_output.scheduled_spec_decode_tokens.get(req_id, [])\n-                for req_id in self.input_batch.req_ids\n-            ]\n-            sample_lens = [len(tokens) + 1 for tokens in draft_token_ids]\n-            recover_logits_idx = np.cumsum(sample_lens) - 1\n-            target_probs = self.rejection_sampler.compute_probs(\n-                logits, sampling_metadata, sample_lens)\n+            # TODO(woosuk): Optimize the memory usage.\n+            bonus_logits = logits[spec_decode_metadata.bonus_logits_indices]\n             sampler_output = self.model.sample(\n-                logits=logits[recover_logits_idx, :],\n+                logits=bonus_logits,\n                 sampling_metadata=sampling_metadata,\n             )\n             bonus_token_ids = sampler_output.sampled_token_ids\n+\n+            # TODO(woosuk): Optimize the memory usage.\n+            target_logits = logits[spec_decode_metadata.target_logits_indices]\n             output_token_ids = self.rejection_sampler(\n-                draft_token_ids,\n+                spec_decode_metadata,\n                 None,  # draft_probs\n+                target_logits,\n                 bonus_token_ids,\n-                target_probs,\n-                sampling_metadata)\n+                sampling_metadata,\n+            )\n             sampler_output.sampled_token_ids = output_token_ids\n \n         # TODO(woosuk): The following loop can be slow since it iterates over\n@@ -1066,13 +1107,8 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n             valid_sampled_token_ids = sampled_token_ids.tolist()\n         else:\n             # Includes spec decode tokens.\n-            valid_mask = sampled_token_ids != INVALID_TOKEN_ID\n-            gen_lens = valid_mask.sum(dim=1).tolist()\n-            # TODO(woosuk): Optimize this.\n-            valid_sampled_token_ids = [\n-                seq.tolist()\n-                for seq in sampled_token_ids[valid_mask].split(gen_lens)\n-            ]\n+            valid_sampled_token_ids = self.rejection_sampler.parse_output(\n+                sampled_token_ids, self.input_batch.vocab_size)\n \n         if not self.use_spec_decode:\n             spec_token_ids = None\n@@ -1316,6 +1352,33 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                     \"initializing the engine.\") from e\n             else:\n                 raise e\n+        if self.use_spec_decode:\n+            draft_token_ids = [[0] for _ in range(num_reqs)]\n+            dummy_spec_decode_metadata = SpecDecodeMetadata.make_dummy(\n+                draft_token_ids, self.device)\n+\n+            num_tokens = sum(len(ids) for ids in draft_token_ids)\n+            # draft_probs = torch.randn(\n+            #     num_tokens, logits.shape[-1], device=self.device,\n+            #     dtype=logits.dtype)\n+            draft_probs = None\n+            target_logits = torch.randn(num_tokens,\n+                                        logits.shape[-1],\n+                                        device=self.device,\n+                                        dtype=logits.dtype)\n+            # NOTE(woosuk): Here, we should use int32 because the sampler uses\n+            # int32 for bonus_token_ids. If the dtype mismatches, re-compilation\n+            # will occur at runtime.\n+            bonus_token_ids = torch.zeros(num_reqs,\n+                                          device=self.device,\n+                                          dtype=torch.int32)\n+            self.rejection_sampler(\n+                dummy_spec_decode_metadata,\n+                draft_probs,\n+                target_logits,\n+                bonus_token_ids,\n+                dummy_metadata,\n+            )\n         return sampler_output\n \n     def profile_run(self) -> None:", "apis": ["RejectionSampler.forward", "RejectionSampler.parse_output", "SpecDecodeMetadata.make_dummy", "compiled_softmax"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/rejection_sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/pool/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit makes extensive changes to the core sampling implementation, particularly the RejectionSampler in the source code (non-test files) by introducing optimizations via Triton kernels and a compiled softmax function. These changes aim to improve the performance of the sampler by leveraging low-level kernel optimizations on the CPU. The modifications not only refactor the code but significantly alter the mechanism for performing rejection sampling, which is a performance-critical part of the system. The changes affect high-level APIs in the repository and they are testable on CPU. Despite modifications in test files, the source code responsible for performance is clearly optimized through these changes.", "llm_api_reason": "This commit reworks how rejection sampling is performed in spec decode. In particular, it changes the RejectionSampler API to expect a SpecDecodeMetadata instance and target logits rather than separate draft tokens and probability tensors. Several Triton kernels are added to accelerate the sampling process (e.g. rejection_greedy_sample_kernel, rejection_random_sample_kernel, expand_kernel, and sample_recovered_tokens_kernel), and a new compiled softmax utility (compiled_softmax) is introduced under vllm.sample.ops.utils. Additionally, a new SpecDecodeMetadata class with a make_dummy classmethod is provided to support dummy spec decode metadata. These changes affect the topâ€‘level Python APIs for rejection sampling (RejectionSampler.forward and its parse_output helper), the SpecDecodeMetadata.make_dummy factory method, and the compiled_softmax function used to compute the scaled softmax probabilities."}
{"commit_hash": "ccf02fcbaebb1a5b59dfc6c7cb64aa7cc489f04c", "pr_url": "https://github.com/vllm-project/vllm/pull/14848", "pr_date": "2025-03-15", "timeline_text": "Copy link Collaborator tlrmchlsmth commented Mar 15, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . â€¦nnecessary Memory Copies  ( #14778 )\" This reverts commit fe66b34 . lm_eval --model vllm \\\n    --model_args pretrained=ibm-ai-platform/Bamba-9B,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.8 \\\n    --tasks gsm8k --limit 100 \\\n    --batch_size auto main:\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |    0|Â±  |     0|\n|     |       |strict-match    |     5|exact_match|â†‘  |    0|Â±  |     0|\n\n\nthis PR:\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.22|Â±  |0.0416|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.32|Â±  |0.0469| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ â€¦ 9baec50 â€¦nnecessary Memory Copies ( #14778 )\"\n\nThis reverts commit fe66b34 . Copy link github-actions bot commented Mar 15, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . DarkLight1337 approved these changes Mar 15, 2025 View reviewed changes Hide details View details vllm-bot merged commit ccf02fc into main Mar 15, 2025 19 checks passed Uh oh! There was an error while loading. Please reload this page . vllm-bot deleted the revert_mamba_vmap branch March 15, 2025 03:45 lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ ( â€¦ 69ebbe1 vllm-project#14848 )\n\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ ( â€¦ 40cd8aa vllm-project#14848 ) RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ ( â€¦ 0129fdd vllm-project#14848 )\n\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:52", "has_lm_eval": true, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, gsm8k, gsm8k | TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:51:52", "models": ["ibm-ai-platform/Bamba-9B"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=ibm-ai-platform/Bamba-9B,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model ibm-ai-platform/Bamba-9B --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ (#14848)", "commit_message": "Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ (#14848)", "commit_date": "2025-03-14T20:45:42-07:00", "files_changed": ["vllm/model_executor/layers/mamba/mamba_mixer2.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 30, "num_non_test_edited_lines": 30, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/mamba/mamba_mixer2.py b/vllm/model_executor/layers/mamba/mamba_mixer2.py\nindex 5b19e3f35..b53a540ed 100644\n--- a/vllm/model_executor/layers/mamba/mamba_mixer2.py\n+++ b/vllm/model_executor/layers/mamba/mamba_mixer2.py\n@@ -466,17 +466,10 @@ class MambaMixer2(CustomOp):\n         if has_prefill:\n \n             initial_states = None\n-\n-            if has_initial_states is not None and torch.any(\n-                    has_initial_states):\n-\n-                # vectorized ssm_state zero init\n-                batched_zero_init_func = torch.vmap(\n-                    lambda idx: mamba_cache_params.ssm_state[idx].zero_())\n-                batched_zero_init_func(\n-                    mamba_cache_params.\n-                    state_indices_tensor[~has_initial_states].unsqueeze(\n-                        dim=-1), )\n+            if has_initial_states is not None and any(has_initial_states):\n+                for idx in mamba_cache_params.state_indices_tensor[\n+                        ~has_initial_states]:\n+                    mamba_cache_params.ssm_state[idx].zero_()\n                 initial_states = mamba_cache_params.ssm_state[\n                     mamba_cache_params.state_indices_tensor]\n \n@@ -500,17 +493,10 @@ class MambaMixer2(CustomOp):\n                 dt_limit=(0.0, float(\"inf\")),\n             )\n \n-            # vectorized ssm state update using vmap\n-            # the 1d state_indices_tensor needs to be unsqueezed to avoid vmap\n-            # limitation which doesn't allow use of `item()`\n-            # Note: the lambda capture can happen where ssm_state is initialized\n-            #       instead of here\n-            batched_copy = torch.vmap(\n-                lambda idx, source_state: mamba_cache_params.ssm_state[\n-                    idx].copy_(source_state))\n-            batched_copy(\n-                mamba_cache_params.state_indices_tensor.unsqueeze(dim=-1),\n-                varlen_state)\n+            # update ssm states\n+            # - varlen state is a (batch, nheads, headdim, dstate) tensor\n+            for i, idx in enumerate(mamba_cache_params.state_indices_tensor):\n+                mamba_cache_params.ssm_state[idx].copy_(varlen_state[i])\n \n             # - reshape\n             hidden_states = scan_output.view(seq_len, -1)", "apis": ["Mamba2DecoderLayer.forward", "Mamba2Model.forward", "Mamba2ForCausalLM.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mamba2.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mamba_cache.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit reverts previously introduced performance tweaksâ€”in this case, vectorized operations using torch.vmapâ€”switching back to explicit loops for state initialization and update. It affects a non-test source code file in the high-level model executor module and is directly related to performance optimizations (or their rollback). While it does not add a new performance optimization, it is clearly tied to performance behavior (undoing the optimization tweaks), and meets the criteria given.", "llm_api_reason": "This commit reverts recent performance tweaks in the Mamba2 mixer layer. Instead of using torch.vmap for vectorized initialization and update of the SSM state, the code now iterates with forâ€loops. Since the MambaMixer2 is used by Mamba2DecoderLayer (which in turn is used in Mamba2Model and Mamba2ForCausalLM), these changes affect the forward computation during model inference."}
{"commit_hash": "fe66b34728e5d383e3d19aefc544eeee808c99fb", "pr_url": "https://github.com/vllm-project/vllm/pull/14778", "pr_date": "2025-03-14", "timeline_text": "Copy link Contributor cyang49 commented Mar 13, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . We found an issue while profiling vLLM running Bamba-9B model inference. Before: As can be seen in the Nsight Systems trace, per Mamba layer there are 2 phases where frequent memory copies happen. They are not necessary, or can be fused to reduce the number of copies. This PR fixes these issues. After: For the test case (offline mode, batch size=64, short prompt) I used, the fix reduces the prefill mamba layer latency from 5ms to 3ms. The results from benchmark_serving on single H100-80GB GPU Before: ============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  283.22    \nTotal input tokens:                      215201    \nTotal generated tokens:                  198343    \nRequest throughput (req/s):              3.53      \nOutput token throughput (tok/s):         700.32    \nTotal Token throughput (tok/s):          1460.17   \n---------------Time to First Token----------------\nMean TTFT (ms):                          105627.40 \nMedian TTFT (ms):                        94728.54  \nP99 TTFT (ms):                           264194.77 \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          393.83    \nMedian TPOT (ms):                        413.59    \nP99 TPOT (ms):                           615.34    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           339.72    \nMedian ITL (ms):                         589.56    \nP99 ITL (ms):                            751.76    \n================================================== After: python benchmarks/benchmark_serving.py --model $MODEL_PATH  --dataset-name sharegpt     --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json\n\n============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  260.19    \nTotal input tokens:                      215201    \nTotal generated tokens:                  198343    \nRequest throughput (req/s):              3.84      \nOutput token throughput (tok/s):         762.29    \nTotal Token throughput (tok/s):          1589.37   \n---------------Time to First Token----------------\nMean TTFT (ms):                          96566.51  \nMedian TTFT (ms):                        84883.05  \nP99 TTFT (ms):                           245639.66 \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          366.31    \nMedian TPOT (ms):                        371.88    \nP99 TPOT (ms):                           680.49    \n---------------Inter-token Latency----------------\nMean ITL (ms):                           311.69    \nMedian ITL (ms):                         507.96    \nP99 ITL (ms):                            741.83    \n================================================== The total token throughput improved by about 8%. Note: There is another sequential for loop which can be fixed similarly. My test case doesn't hit this control path, though. @fabianlim could you comment? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link github-actions bot commented Mar 13, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cyang49 force-pushed the pr_mamba2_optimizations branch\n      2 times, most recently\n    from c33319f to 7fe5d58 Compare March 13, 2025 19:24 tlrmchlsmth reviewed Mar 13, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice performance pickup. Is this the other sequential for loop you mentioned? vllm/vllm/model_executor/layers/mamba/mamba_mixer2.py Lines 470 to 472\n      in 02fcaa3 for idx in mamba_cache_params . state_indices_tensor [ ~ has_initial_states ]: mamba_cache_params . ssm_state [ idx ]. zero_ () Do you want to handle it in this PR? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/layers/mamba/mamba_mixer2.py Comment on lines +502 to +510 batched_copy = torch.vmap( lambda idx, source_state: mamba_cache_params.ssm_state[ idx].copy_(source_state)) Copy link Collaborator tlrmchlsmth Mar 13, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This might be handy to have as a method of MambaCacheParams in mamba_cache.py Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 fabianlim reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Contributor Author cyang49 Mar 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @tlrmchlsmth could you clarify if you mean to have this logic as a member function of MambaCacheParams ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator tlrmchlsmth Mar 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment That's right, that's what I meant, although I don's see a way to factor out commonality between batched_copy and batched_zero_init_func so I'm not sure it would clean anything up. # Note: the lambda capture can happen where ssm_state is initialized\n       #       instead of here Is there some overhead that we should try to avoid here? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author cyang49 Mar 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The current lambda capture code is safe. The comment is just theorizing about removing redundancy. I don't know this part well enough yet. Attempting to \"optimize\" may introduce bugs. I'd leave it as is for now. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor Author cyang49 commented Mar 13, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Nice performance pickup. Is this the other sequential for loop you mentioned? vllm/vllm/model_executor/layers/mamba/mamba_mixer2.py Lines 470 to 472\n      in 02fcaa3 for idx in mamba_cache_params . state_indices_tensor [ ~ has_initial_states ]: mamba_cache_params . ssm_state [ idx ]. zero_ () Do you want to handle it in this PR? I need @fabianlim 's input on how to hit that case. It can be a separate PR or if I know how to test it tomorrow. Next week I'll be traveling and may not have time to do it All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor fabianlim commented Mar 14, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . since the mamba2 unit tests are not automated maybe we should run them once ? @tlrmchlsmth @cyang49 this will be true if, at least one of the sequences in the current step has an initial state, which is determined by the prescence of a context. This means that either a i) chunked prefill step or ii) decode step will hit this case. has_initial_states = attn_metadata.context_lens_tensor > 0 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Mar 14, 2025 I vectorized the zero init loop and observed a slight improvement in total token throughput ============ Serving Benchmark Result ============\nSuccessful requests:                     1000\nBenchmark duration (s):                  247.81\nTotal input tokens:                      215201\nTotal generated tokens:                  198343\nRequest throughput (req/s):              4.04\nOutput token throughput (tok/s):         800.37\nTotal Token throughput (tok/s):          1668.76\n---------------Time to First Token----------------\nMean TTFT (ms):                          97128.43\nMedian TTFT (ms):                        89290.52\nP99 TTFT (ms):                           233402.22\n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          360.62\nMedian TPOT (ms):                        355.58\nP99 TPOT (ms):                           992.48\n---------------Inter-token Latency----------------\nMean ITL (ms):                           294.58\nMedian ITL (ms):                         503.07\nP99 ITL (ms):                            570.28\n================================================== ðŸ‘ 1 fabianlim reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Mar 14, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @tlrmchlsmth it would be nice if we can merge this one soon, if the functionality & no negative performance impact are verified. I noticed from the trace that there are other inefficiencies in  mamba2, but I'll submit a separate PR after my trip. Let me know if there's anything else that needs changing. Thanks! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth approved these changes Mar 14, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM, thanks! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions tlrmchlsmth added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 14, 2025 cyang49 added 4 commits March 14, 2025 13:03 vectorize copy loop for speedup â€¦ e0883a3 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> replace any with torch.any to reduce overhead â€¦ 81488ad Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> lint â€¦ 86ca9b5 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> Vectorize zero init of ssm_state â€¦ 0142ba3 Signed-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> cyang49 force-pushed the pr_mamba2_optimizations branch\n    from 9584558 to 0142ba3 Compare March 14, 2025 17:11 Copy link Member DarkLight1337 commented Mar 14, 2025 Some CI failures have recently been fixed on main, so I suggest you to merge from main if you haven't already ðŸ‘ 1 cyang49 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details tlrmchlsmth merged commit fe66b34 into vllm-project : main Mar 14, 2025 31 checks passed Uh oh! There was an error while loading. Please reload this page . cyang49 deleted the pr_mamba2_optimizations branch March 14, 2025 21:24 Copy link Contributor yury-tokpanov commented Mar 14, 2025 Testing this. We did notice the same in our profiles of mamba2. Overall, occupancy was pretty low in comparison to flash attention kernels. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth added a commit\n      that referenced\n      this pull request Mar 15, 2025 Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ â€¦ 9baec50 â€¦nnecessary Memory Copies ( #14778 )\"\n\nThis reverts commit fe66b34 . yury-tokpanov added a commit\n        to Zyphra/vllm\n      that referenced\n      this pull request Mar 15, 2025 Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ â€¦ efb7f02 â€¦nnecessary Memory Copies ( vllm-project#14778 )\"\n\nThis reverts commit fe66b34 . tlrmchlsmth mentioned this pull request Mar 15, 2025 Revert \"[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Uâ€¦ #14848 Merged Copy link Contributor yury-tokpanov commented Mar 15, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . this breaks mamba2 based models, unfortunately: Command I ran on H100: lm_eval --model vllm --model_args pretrained=ibm-ai-platform/Bamba-9B,dtype=float16,gpu_memory_utilization=0.9,max_model_len=4096 --batch_size auto --trust_remote_code --cache_requests true --tasks gsm8k bamba-9b with this PR: Tasks Version Filter n-shot Metric Value Stderr gsm8k 3 flexible-extract 5 exact_match â†‘ 0.0781 Â± 0.0074 strict-match 5 exact_match â†‘ 0.0569 Â± 0.0064 bamba-9b with PR reverted: Tasks Version Filter n-shot Metric Value Stderr gsm8k 3 flexible-extract 5 exact_match â†‘ 0.2449 Â± 0.0118 strict-match 5 exact_match â†‘ 0.3692 Â± 0.0133 All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cyang49 restored the pr_mamba2_optimizations branch March 15, 2025 01:47 Copy link Contributor Author cyang49 commented Mar 15, 2025 Weird, it passed when I tested locally? Both value and stderr should be 0s? |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |    0|Â±  |     0|\n|     |       |strict-match    |     5|exact_match|â†‘  |    0|Â±  |     0| All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor yury-tokpanov commented Mar 15, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Weird, it passed when I tested locally? Both value and stderr should be 0s? |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |    0|Â±  |     0|\n|     |       |strict-match    |     5|exact_match|â†‘  |    0|Â±  |     0| No, it shouldn't be 0 accuracy. 0 means the model failed completely on a test. For the full gsm8k eval Bamba-9b should be around 37% on a strict-match accuracy (with around 1% stderr). I checked other mamba2 models (Codestral-7B, Zamba2), they are also down. Do you have Slack? I'd suggest you join vLLM dev Slack, we have a channel there to discuss hybrid models: https://slack.vllm.ai/ ðŸ‘€ 1 cyang49 reacted with eyes emoji All reactions ðŸ‘€ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Mar 15, 2025 Weird, it passed when I tested locally? Both value and stderr should be 0s? |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |    0|Â±  |     0|\n|     |       |strict-match    |     5|exact_match|â†‘  |    0|Â±  |     0| No, it shouldn't be 9 accuracy. 0 means the model failed completely on a test. For the full gsm8k eval Bamba-9b should be around 37% on a strict-match accuracy (with around 1% stderr). I checked other mamba2 models (Codestral-7B, Zamba2), they are also down. Do you have Slack? I'd suggest you join vLLM dev Slack, we have a channel there to discuss hybrid models: https://slack.vllm.ai/ Ah, thanks for explaining. I'll debug it when I get a chance. I'll also get on the vllm slack ðŸ‘ 1 yury-tokpanov reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor yury-tokpanov commented Mar 15, 2025 I think the issue is with ssm state copy, zero-initialization appears to be working fine. ðŸ‘ 1 cyang49 reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Mar 15, 2025 I think the issue is with ssm state copy, zero-initialization appears to be working fine. It could also be that lm-eval doesn't go through the zero-init path, though All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Contributor Author cyang49 commented Mar 15, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . It appears the problem is that the semantics of the line mamba_cache_params.ssm_state[idx].copy_(varlen_state[i]) in the for loop is different from mamba_cache_params.ssm_state[idx].copy_(source_state) in the lambda function :( In the former, idx is a scalar integer value and the in-place copy happens, but in the latter, idx is an integer tensor and the indexing semantics is different. I suspect that the in-place copy doesn't happen as expected - I experimented with these two cases in the python interpreter.. It looks like the in-place zero_() part should  have the same issue. Not sure why it didn't cause a problem for gsm8k All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . cyang49 mentioned this pull request Mar 15, 2025 [Model] RE: Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessary Memory Copies #14857 Merged Copy link Contributor fabianlim commented Mar 15, 2025 @cyang49 when idx is a tensor is a copy-view, so thats why the inplace does not update the master copy. That is why i needed to loop it with a scalar in the first place. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessaâ€¦ â€¦ b5a740f â€¦ry Memory Copies ( vllm-project#14778 )\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessaâ€¦ â€¦ 7f3f2fc â€¦ry Memory Copies ( vllm-project#14778 )\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessaâ€¦ â€¦ fa2cba1 â€¦ry Memory Copies ( vllm-project#14778 )\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:55", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm-eval, gsm8k | PERF: TTFT, TTFT, TTFT | SERVING: Serving, Serving, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:51:55", "models": ["ibm-ai-platform/Bamba-9B"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=ibm-ai-platform/Bamba-9B,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model ibm-ai-platform/Bamba-9B --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessary Memory Copies  (#14778)", "commit_message": "[Model] Mamba2 Prefill Performance Tweaks: Fixing Flurry of Unnecessary Memory Copies  (#14778)\n\nSigned-off-by: Chih-Chieh-Yang <7364402+cyang49@users.noreply.github.com>", "commit_date": "2025-03-14T16:36:18-04:00", "files_changed": ["vllm/model_executor/layers/mamba/mamba_mixer2.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 30, "num_non_test_edited_lines": 30, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/mamba/mamba_mixer2.py b/vllm/model_executor/layers/mamba/mamba_mixer2.py\nindex b53a540ed..5b19e3f35 100644\n--- a/vllm/model_executor/layers/mamba/mamba_mixer2.py\n+++ b/vllm/model_executor/layers/mamba/mamba_mixer2.py\n@@ -466,10 +466,17 @@ class MambaMixer2(CustomOp):\n         if has_prefill:\n \n             initial_states = None\n-            if has_initial_states is not None and any(has_initial_states):\n-                for idx in mamba_cache_params.state_indices_tensor[\n-                        ~has_initial_states]:\n-                    mamba_cache_params.ssm_state[idx].zero_()\n+\n+            if has_initial_states is not None and torch.any(\n+                    has_initial_states):\n+\n+                # vectorized ssm_state zero init\n+                batched_zero_init_func = torch.vmap(\n+                    lambda idx: mamba_cache_params.ssm_state[idx].zero_())\n+                batched_zero_init_func(\n+                    mamba_cache_params.\n+                    state_indices_tensor[~has_initial_states].unsqueeze(\n+                        dim=-1), )\n                 initial_states = mamba_cache_params.ssm_state[\n                     mamba_cache_params.state_indices_tensor]\n \n@@ -493,10 +500,17 @@ class MambaMixer2(CustomOp):\n                 dt_limit=(0.0, float(\"inf\")),\n             )\n \n-            # update ssm states\n-            # - varlen state is a (batch, nheads, headdim, dstate) tensor\n-            for i, idx in enumerate(mamba_cache_params.state_indices_tensor):\n-                mamba_cache_params.ssm_state[idx].copy_(varlen_state[i])\n+            # vectorized ssm state update using vmap\n+            # the 1d state_indices_tensor needs to be unsqueezed to avoid vmap\n+            # limitation which doesn't allow use of `item()`\n+            # Note: the lambda capture can happen where ssm_state is initialized\n+            #       instead of here\n+            batched_copy = torch.vmap(\n+                lambda idx, source_state: mamba_cache_params.ssm_state[\n+                    idx].copy_(source_state))\n+            batched_copy(\n+                mamba_cache_params.state_indices_tensor.unsqueeze(dim=-1),\n+                varlen_state)\n \n             # - reshape\n             hidden_states = scan_output.view(seq_len, -1)", "apis": ["MambaMixer2.forward_cuda", "mamba_mixer2"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/mamba/mamba_mixer2.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mamba2.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/mamba_cache.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a core file (mamba_mixer2.py) in a non-test location where vectorized operations (using torch.vmap) are introduced. This change replaces loop-based memory copy operations in two places (zero initializations and state updates) with batched vectorized operations. Its intent is to reduce unnecessary memory copies, hence optimizing performance for prefill operations. The adjustments are non-trivial modifications to source code (not just documentation or refactoring) and are aimed at improving CPU performance without involving GPU-specific changes. Therefore, this commit satisfies the conditions for being performance/optimization related.", "llm_api_reason": "The commit replaces two explicit Python loops in the prefill branch of the forward_cuda method of the MambaMixer2 custom op with vectorized versions using torch.vmap. This improves the performance by avoiding per-index iteration when zeroing and copying the ssm_state from the mamba_cache_params. Since the change is in the forward_cuda implementation of the MambaMixer2 custom op (and indirectly in its registered function mamba_mixer2), the affected highâ€level APIs are those that invoke these operations during model inference in Mamba2."}
{"commit_hash": "70b808fe1a63322bc6bf5f46a91981a8f6b8af00", "pr_url": "https://github.com/vllm-project/vllm/pull/14377", "pr_date": "2025-03-11", "timeline_text": "Copy link Contributor cynthieye commented Mar 6, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . qwen2-vl logic optimization: During each forward propagation, the xformer branch of Qwen2VisionTransformer will execute multiple tensor tolist methods (flash attn branch will execute multiple tensor items) to force the GPU tensor to be copied to the CPU, triggering CUDAMemcpyAsync to increase time consumption. Since the input and output are the same multiple times, it will be executed once, and the remaining will reuse the first result. After optimization, the online environment xformer branch QPS can be improved by 15%, and the flash attn branch QPS can be improved by 7% Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 2 imkero and ywang96 reacted with thumbs up emoji All reactions ðŸ‘ 2 reactions DarkLight1337 requested review from Isotr0py and ywang96 March 7, 2025 06:41 Isotr0py approved these changes Mar 7, 2025 View reviewed changes Copy link Member Isotr0py left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thanks for this optimization! Can you please also update qwen2.5-vl as well? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . â¤ï¸ 1 cynthieye reacted with heart emoji All reactions â¤ï¸ 1 reaction vllm/model_executor/models/qwen2_vl.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/model_executor/models/qwen2_vl.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . cynthieye changed the title feat:Optimize qwen2-vl to reduce cudaMemcpyAsync [Perf]:Optimize qwen2-vl to reduce cudaMemcpyAsync Mar 10, 2025 cynthieye force-pushed the main branch\n      3 times, most recently\n    from ae09649 to 1fbb69c Compare March 10, 2025 06:53 Isotr0py enabled auto-merge (squash) March 10, 2025 09:50 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 10, 2025 auto-merge was automatically disabled March 10, 2025 13:26 Head branch was pushed to by a user without write access cynthieye force-pushed the main branch\n    from a4d7e3a to 37e543a Compare March 10, 2025 13:26 [Perf]: Optimize qwen2-vl to reduce cudaMemcpyAsync â€¦ 347de39 Signed-off-by: cynthieye <987073381@qq.com> cynthieye force-pushed the main branch\n    from 37e543a to 347de39 Compare March 10, 2025 13:29 cynthieye mentioned this pull request Mar 10, 2025 [CI failed]: V1 Test Failed due to \"No available memory for the cache blocks\" in GitHub Actions #14574 Closed 1 task empty test â€¦ fd105c1 Signed-off-by: cynthieye <987073381@qq.com> Copy link Member ywang96 commented Mar 11, 2025 @cynthieye Thank you for making this PR! Can you update this branch with our main branch? I think thr CI error should be fixed on main a while ago. â¤ï¸ 1 cynthieye reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ywang96 approved these changes Mar 11, 2025 View reviewed changes Copy link Member ywang96 left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Left a few comments - Otherwise LGTM! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/models/qwen2_5_vl.py Outdated @@ -259,6 +259,8 @@ def forward( x: torch.Tensor, cu_seqlens: torch.Tensor, rotary_pos_emb: torch.Tensor, max_seqlen: int = None, Copy link Member ywang96 Mar 11, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Shouldn't max_seqlen be also Optional[int] ? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/models/qwen2_5_vl.py Outdated Comment on lines 372 to 373 max_seqlen: int, seqlens: list[int], Copy link Member ywang96 Mar 11, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Please modify the typing accordingly Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/models/qwen2_vl.py Outdated Comment on lines 310 to 311 max_seqlen: int = None, seqlens: Optional[list[int]] = None, Copy link Member ywang96 Mar 11, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment ditto Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/models/qwen2_vl.py Outdated Comment on lines 417 to 418 max_seqlen: int, seqlens: list[int], Copy link Member ywang96 Mar 11, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment ditto Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/model_executor/models/qwen2_5_vl.py Outdated Comment on lines 372 to 373 max_seqlen: int, seqlens: list[int], Copy link Member ywang96 Mar 11, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment I think it's probably a good idea to add a small documentation here to indicate that max_seqlen is only used for FA and seqlens is only used to xformers. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions cynthieye added 3 commits March 11, 2025 13:12 [Perf]: Fix formatting issues â€¦ 9959792 Signed-off-by: cynthieye <987073381@qq.com> Merge remote-tracking branch 'upstream/main' c03f59d [Perf]: Fix formatting issues â€¦ ddb8dd3 Signed-off-by: cynthieye <987073381@qq.com> ywang96 enabled auto-merge (squash) March 11, 2025 06:25 Hide details View details ywang96 merged commit 70b808f into vllm-project : main Mar 11, 2025 33 checks passed Uh oh! There was an error while loading. Please reload this page . This was referenced Mar 20, 2025 [Bugfix] Fix incorrect qwen2.5-vl attention mask pre-computation #15200 Merged [Misc] Add attention mask pre-computation optimization back to Qwen2.5-VL #15273 Merged lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [Perf]:Optimize qwen2-vl to reduce cudaMemcpyAsync ( vllm-project#14377 ) â€¦ d468e24 Signed-off-by: cynthieye <987073381@qq.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Perf]:Optimize qwen2-vl to reduce cudaMemcpyAsync ( vllm-project#14377 ) â€¦ 8ece569 Signed-off-by: cynthieye <987073381@qq.com> RichardoMrMu pushed a commit\n        to RichardoMrMu/vllm\n      that referenced\n      this pull request May 12, 2025 [Perf]:Optimize qwen2-vl to reduce cudaMemcpyAsync ( vllm-project#14377 ) â€¦ 21ac3af Signed-off-by: cynthieye <987073381@qq.com>\nSigned-off-by: Mu Huai <tianbowen.tbw@antgroup.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:51:59", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: QPS, QPS, optimization | TEST: Test, test, test", "analysis_extracted_at": "2025-09-07 17:51:59", "models": ["Qwen/Qwen2-VL-2B", "Qwen/Qwen2-VL-7B", "Qwen/Qwen2.5-VL-3B", "Qwen/Qwen2.5-VL-7B"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=Qwen/Qwen2-VL-7B --tasks mmlu --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model Qwen/Qwen2-VL-7B --dataset-name random --request-rate 1", "commit_subject": "[Perf]:Optimize qwen2-vl to reduce cudaMemcpyAsync (#14377)", "commit_message": "[Perf]:Optimize qwen2-vl to reduce cudaMemcpyAsync (#14377)\n\nSigned-off-by: cynthieye <987073381@qq.com>", "commit_date": "2025-03-11T07:39:56Z", "files_changed": ["vllm/model_executor/models/qwen2_5_vl.py", "vllm/model_executor/models/qwen2_vl.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 12, "num_edited_lines": 94, "num_non_test_edited_lines": 94, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/models/qwen2_5_vl.py b/vllm/model_executor/models/qwen2_5_vl.py\nindex ef3d28c80..ae48c7794 100644\n--- a/vllm/model_executor/models/qwen2_5_vl.py\n+++ b/vllm/model_executor/models/qwen2_5_vl.py\n@@ -255,10 +255,12 @@ class Qwen2_5_VisionAttention(nn.Module):\n         return q, k, v\n \n     def forward(\n-        self,\n-        x: torch.Tensor,\n-        cu_seqlens: torch.Tensor,\n-        rotary_pos_emb: torch.Tensor,\n+            self,\n+            x: torch.Tensor,\n+            cu_seqlens: torch.Tensor,\n+            rotary_pos_emb: torch.Tensor,\n+            max_seqlen: Optional[int] = None,  # Only used for Flash Attention\n+            seqlens: Optional[list[int]] = None,  # Only used for xFormers\n     ) -> torch.Tensor:\n         # [s, b, c] --> [s, b, head * 3 * head_dim]\n         x, _ = self.qkv(x)\n@@ -285,7 +287,6 @@ class Qwen2_5_VisionAttention(nn.Module):\n \n             q, k, v = (rearrange(x, \"b s ... -> (b s) ...\") for x in [q, k, v])\n \n-            max_seqlen = (cu_seqlens[1:] - cu_seqlens[:-1]).max().item()\n             output = flash_attn_varlen_func(q,\n                                             k,\n                                             v,\n@@ -321,7 +322,6 @@ class Qwen2_5_VisionAttention(nn.Module):\n             from xformers import ops as xops\n             from xformers.ops.fmha.attn_bias import BlockDiagonalMask\n \n-            seqlens = (cu_seqlens[1:] - cu_seqlens[:-1]).tolist()\n             attn_bias = BlockDiagonalMask.from_seqlens(q_seqlen=seqlens,\n                                                        kv_seqlen=None,\n                                                        device=q.device)\n@@ -364,11 +364,20 @@ class Qwen2_5_VisionBlock(nn.Module):\n                                      quant_config=quant_config,\n                                      prefix=f\"{prefix}.mlp\")\n \n-    def forward(self, x: torch.Tensor, cu_seqlens: torch.Tensor,\n-                rotary_pos_emb: torch.Tensor) -> torch.Tensor:\n+    def forward(\n+            self,\n+            x: torch.Tensor,\n+            cu_seqlens: torch.Tensor,\n+            rotary_pos_emb: torch.Tensor,\n+            max_seqlen: Optional[int] = None,  # Only used for Flash Attention\n+            seqlens: Optional[list[int]] = None,  # Only used for xFormers\n+    ) -> torch.Tensor:\n         x = x + self.attn(self.norm1(x),\n                           cu_seqlens=cu_seqlens,\n-                          rotary_pos_emb=rotary_pos_emb)\n+                          rotary_pos_emb=rotary_pos_emb,\n+                          max_seqlen=max_seqlen,\n+                          seqlens=seqlens)\n+\n         x = x + self.mlp(self.norm2(x))\n         return x\n \n@@ -528,6 +537,7 @@ class Qwen2_5_VisionTransformer(nn.Module):\n             quant_config=quant_config,\n             prefix=f\"{prefix}.merger\",\n         )\n+        self.attn_backend: _Backend = get_vit_attn_backend(support_fa=True)\n \n     @property\n     def dtype(self) -> torch.dtype:\n@@ -633,14 +643,25 @@ class Qwen2_5_VisionTransformer(nn.Module):\n \n         # transformers\n         hidden_states = hidden_states.unsqueeze(1)\n+\n+        max_seqlen = None\n+        seqlens = None\n+        if self.attn_backend == _Backend.FLASH_ATTN:\n+            max_seqlen = (cu_seqlens[1:] - cu_seqlens[:-1]).max().item()\n+        elif self.attn_backend == _Backend.XFORMERS:\n+            seqlens = (cu_seqlens[1:] - cu_seqlens[:-1]).tolist()\n         for layer_num, blk in enumerate(self.blocks):\n             if layer_num in self.fullatt_block_indexes:\n                 cu_seqlens_now = cu_seqlens\n             else:\n                 cu_seqlens_now = cu_window_seqlens\n-            hidden_states = blk(hidden_states,\n-                                cu_seqlens=cu_seqlens_now,\n-                                rotary_pos_emb=rotary_pos_emb)\n+            hidden_states = blk(\n+                hidden_states,\n+                cu_seqlens=cu_seqlens_now,\n+                rotary_pos_emb=rotary_pos_emb,\n+                max_seqlen=max_seqlen,\n+                seqlens=seqlens,\n+            )\n \n         # For Qwen2.5-VL-3B, float16 will overflow at last block\n         # for long visual tokens sequences.\ndiff --git a/vllm/model_executor/models/qwen2_vl.py b/vllm/model_executor/models/qwen2_vl.py\nindex ac3d154dd..0e9fa7183 100644\n--- a/vllm/model_executor/models/qwen2_vl.py\n+++ b/vllm/model_executor/models/qwen2_vl.py\n@@ -303,10 +303,12 @@ class Qwen2VisionAttention(nn.Module):\n         return q, k, v\n \n     def forward(\n-        self,\n-        x: torch.Tensor,\n-        cu_seqlens: torch.Tensor,\n-        rotary_pos_emb: torch.Tensor,\n+            self,\n+            x: torch.Tensor,\n+            cu_seqlens: torch.Tensor,\n+            rotary_pos_emb: torch.Tensor,\n+            max_seqlen: Optional[int] = None,  # Only used for Flash Attention\n+            seqlens: Optional[list[int]] = None,  # Only used for xFormers\n     ) -> torch.Tensor:\n \n         # [s, b, c] --> [s, b, 3 * head * head_dim]\n@@ -329,7 +331,6 @@ class Qwen2VisionAttention(nn.Module):\n \n             q, k, v = (rearrange(x, \"b s ... -> (b s) ...\") for x in [q, k, v])\n \n-            max_seqlen = (cu_seqlens[1:] - cu_seqlens[:-1]).max().item()\n             output = flash_attn_varlen_func(q,\n                                             k,\n                                             v,\n@@ -365,7 +366,6 @@ class Qwen2VisionAttention(nn.Module):\n             from xformers import ops as xops\n             from xformers.ops.fmha.attn_bias import BlockDiagonalMask\n \n-            seqlens = (cu_seqlens[1:] - cu_seqlens[:-1]).tolist()\n             attn_bias = BlockDiagonalMask.from_seqlens(q_seqlen=seqlens,\n                                                        kv_seqlen=None,\n                                                        device=q.device)\n@@ -409,11 +409,22 @@ class Qwen2VisionBlock(nn.Module):\n                                   quant_config=quant_config,\n                                   prefix=f\"{prefix}.mlp\")\n \n-    def forward(self, x: torch.Tensor, cu_seqlens: torch.Tensor,\n-                rotary_pos_emb: torch.Tensor) -> torch.Tensor:\n-        x = x + self.attn(self.norm1(x),\n-                          cu_seqlens=cu_seqlens,\n-                          rotary_pos_emb=rotary_pos_emb)\n+    def forward(\n+            self,\n+            x: torch.Tensor,\n+            cu_seqlens: torch.Tensor,\n+            rotary_pos_emb: torch.Tensor,\n+            max_seqlen: Optional[int] = None,  # Only used for Flash Attention\n+            seqlens: Optional[list[int]] = None,  # Only used for xFormers\n+    ) -> torch.Tensor:\n+        x = x + self.attn(\n+            self.norm1(x),\n+            cu_seqlens=cu_seqlens,\n+            rotary_pos_emb=rotary_pos_emb,\n+            max_seqlen=max_seqlen,\n+            seqlens=seqlens,\n+        )\n+\n         x = x + self.mlp(self.norm2(x))\n         return x\n \n@@ -570,6 +581,7 @@ class Qwen2VisionTransformer(nn.Module):\n             quant_config=quant_config,\n             prefix=f\"{prefix}.merger\",\n         )\n+        self.attn_backend: _Backend = get_vit_attn_backend(support_fa=True)\n \n     @property\n     def dtype(self) -> torch.dtype:\n@@ -624,8 +636,21 @@ class Qwen2VisionTransformer(nn.Module):\n \n         # transformers\n         x = x.unsqueeze(1)\n+\n+        max_seqlen = None\n+        seqlens = None\n+        if self.attn_backend == _Backend.FLASH_ATTN:\n+            max_seqlen = (cu_seqlens[1:] - cu_seqlens[:-1]).max().item()\n+        elif self.attn_backend == _Backend.XFORMERS:\n+            seqlens = (cu_seqlens[1:] - cu_seqlens[:-1]).tolist()\n         for blk in self.blocks:\n-            x = blk(x, cu_seqlens=cu_seqlens, rotary_pos_emb=rotary_pos_emb)\n+            x = blk(\n+                x,\n+                cu_seqlens=cu_seqlens,\n+                rotary_pos_emb=rotary_pos_emb,\n+                max_seqlen=max_seqlen,\n+                seqlens=seqlens,\n+            )\n \n         # adapter\n         x = self.merger(x)", "apis": ["Qwen2VisionAttention.forward", "Qwen2VisionBlock.forward", "Qwen2VisionTransformer.forward", "Qwen2_5_VisionAttention.forward", "Qwen2_5_VisionTransformer.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/qwen2_vl.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/qwen2_5_vl.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/multimodal/registry.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/inputs/registry.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/registry.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/chat_templates/registry.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies two non-test source files that are core to the model executor implementation. The changes adjust the forward function signatures by adding optional arguments (max_seqlen and seqlens) used for Flash Attention and xFormers, and remove redundant calculations of these values. These changes are aimed at reducing overhead (e.g., likely to reduce extra cudaMemcpyAsync calls as noted in the commit message) by allowing the caller to provide precomputed values. This modification, while involving refactoring, is targeted at optimizing performance by streamlining the computation pathway in high-level APIs and internal modules. The commit is not just a simple bug fix or feature addition; it is a performance optimization affecting CPU workflows and is general rather than hardware-specific.", "llm_api_reason": "The commit adds two optional parameters â€œmax_seqlenâ€ and â€œseqlensâ€ to the forward methods in the vision attention, block, and transformer modules for both Qwen2-VL and Qwen2.5-VL implementations so that the appropriate attention mask information is computed only once (or in a more efficient way) and passed to the underlying flash attention / xFormers routines. This change reduces the need for extra cudaMemcpy (thus optimizing performance), and it affects the forward methods of the vision-related modules in both versions. Based on the commit, the affected public python APIs are the forward methods of Qwen2VisionAttention, Qwen2VisionBlock, Qwen2VisionTransformer, Qwen2_5_VisionAttention, and Qwen2_5_VisionTransformer."}
{"commit_hash": "fb0acb6c72874e98617cabee4ff4851569374fc9", "pr_url": "https://github.com/vllm-project/vllm/pull/14540", "pr_date": "2025-03-10", "timeline_text": "Copy link Collaborator simon-mo commented Mar 10, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR helps V1 to mostly match and exceed (in most cases) V0's performance for MLA. Mostly by two things Fix @LucasWilkinson 's rotary_emb specialization ( [Perf] Reduce MLA CPU overheads in V1 #14384 , Revert \"[Perf] Reduce MLA CPU overheads in V1 (#14384)\" #14471 , [Bugfix] DeepSeek Accuracy #14476 ) to reduce CPU overhead. Identified that the cause of 0 GSM8K score comes from the cuda kernel needs the input to be continuous. Fixed it by make the input contiguous if possible. A better fix will be to change the kernel (help wanted). Reordered some operation in the build function, which ended up costing quite a bit overhead in my timing (p99 tail latency up to 1ms) This is by ensuring there is not GPU -> CPU communication. CPU -> GPU is fine. All the following ran in 8xH200. Performance Test (R1) We are still a bit worse on the short range but we became significantly better on longer range. 64% boost for 6k input. VLLM_USE_V1=1 python benchmarks/benchmark_throughput.py --model /home/vllm-dev/DeepSeek-R1 --load-format dummy --trust-remote-code --input-len 3000 --output-len 1000 --num-prompts 50 --tensor-parallel-size 8 Throughput: 1.09 requests/s, 4342.27 total tokens/s, 1085.57 output tokens/s VLLM_USE_V1=0 python benchmarks/benchmark_throughput.py --model /home/vllm-dev/DeepSeek-R1 --load-format dummy --trust-remote-code --input-len 3000 --output-len 1000 --num-prompts 50 --tensor-parallel-size 8 Throughput: 1.13 requests/s, 4536.67 total tokens/s, 1134.17 output tokens/s VLLM_USE_V1=1 python benchmarks/benchmark_throughput.py --model /home/vllm-dev/DeepSeek-R1 --load-format dummy --trust-remote-code --input-len 6000 --output-len 1000 --num-prompts 50 --tensor-parallel-size 8 Throughput: 0.87 requests/s, 6060.61 total tokens/s, 865.80 output tokens/s VLLM_USE_V1=0 python benchmarks/benchmark_throughput.py --model /home/vllm-dev/DeepSeek-R1 --load-format dummy --trust-remote-code --input-len 6000 --output-len 1000 --num-prompts 50 --tensor-parallel-size 8 Throughput: 0.53 requests/s, 3692.82 total tokens/s, 527.55 output tokens/s Performance Test (Small) We are 15% better for small model for 3k input. VLLM_USE_V1=1 python benchmarks/benchmark_throughput.py --model deepseek-ai/DeepSeek-V2-Lite --load-format dummy --trust-remote-code --input-len 3000 --output-len 1000 --num-prompts 50 Throughput: 3.84 requests/s, 15364.27 total tokens/s, 3841.07 output tokens/s VLLM_USE_V1=0 python benchmarks/benchmark_throughput.py --model deepseek-ai/DeepSeek-V2-Lite --load-format dummy --trust-remote-code --input-len 3000 --output-len 1000 --num-prompts 50 Throughput: 3.32 requests/s, 13275.67 total tokens/s, 3318.92 output tokens/s VLLM_USE_V1=0 python benchmarks/benchmark_throughput.py --model deepseek-ai/DeepSeek-V2-Lite --load-format dummy --trust-remote-code --input-len 3000 --output-len 1000 --num-prompts 50 --enable-chunked-prefill false Throughput: 3.32 requests/s, 13264.68 total tokens/s, 3316.17 output tokens/s Accuracy Test No regression. VLLM_USE_V1=\"1\" lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-V2-Lite-Chat,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.9,trust_remote_code=True,max_model_len=16384 --task gsm8k --num_fewshot=5 --limit 100 --log_samples --output_path lmeval-results\n\nvllm (pretrained=deepseek-ai/DeepSeek-V2-Lite-Chat,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.9,trust_remote_code=True,max_model_len=16384), gen_kwargs: (None), limit: 100.0, num_fewshot: 5, batch_size: 1\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.65|Â±  |0.0479|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.64|Â±  |0.0482|\n\n\nVLLM_USE_V1=\"0\" lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-V2-Lite-Chat,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.9,trust_remote_code=True,max_model_len=16384 --task gsm8k --num_fewshot=5 --limit 100 --log_samples --output_path lmeval-results\n\nvllm (pretrained=deepseek-ai/DeepSeek-V2-Lite-Chat,tensor_parallel_size=1,dtype=auto,gpu_memory_utilization=0.9,trust_remote_code=True,max_model_len=16384), gen_kwargs: (None), limit: 100.0, num_fewshot: 5, batch_size: 1\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.66|Â±  |0.0476|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.66|Â±  |0.0476| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [Perf] Improve MLA on V1 â€¦ e3c00a1 Signed-off-by: simon-mo <simon.mo@hey.com> simon-mo requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners March 10, 2025 05:50 Copy link github-actions bot commented Mar 10, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Mar 10, 2025 simon-mo requested a review\n  from LucasWilkinson March 10, 2025 05:51 simon-mo added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 10, 2025 fix lint â€¦ 8cf800f Signed-off-by: simon-mo <simon.mo@hey.com> tlrmchlsmth approved these changes Mar 10, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions LucasWilkinson approved these changes Mar 10, 2025 View reviewed changes Copy link Collaborator LucasWilkinson left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM left 1 nit. Thanks for working on this! (sorry this fell on your plate) good catch on number 2! my bad for not catching this! I was wondering if it would be better compute on the CPU in V1 but didn't really keep pushing on that, ill try to be more careful about reviewing CPU->GPU transfers in the future Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/attention/backends/mla/common.py Outdated decode_q_pe_input = (decode_q_pe.clone().contiguous() if not decode_q_pe.is_contiguous() else decode_q_pe) Copy link Collaborator LucasWilkinson Mar 10, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment nit: do we need clone here? my understanding is .continuous() will implicitly do a clone if its not contiguous and no-op if it already is: >>> x1 = torch.rand((4,4))\n>>> x2 = x1.t()\n>>> x1.is_contiguous()\nTrue\n>>> x2.is_contiguous()\nFalse\n>>> x1.data_ptr()\n94306274798528\n>>> x1.contiguous().data_ptr()\n94306274798528\n>>> x2.data_ptr()\n94306274798528\n>>> x2.contiguous().data_ptr()\n94306363886080 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator LucasWilkinson Mar 10, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment i.e. I think we can drop this line and just do: decode_q_pe[...], decode_k_pe[...] = self.rotary_emb(\n                 attn_metadata.decode.input_positions, decode_q_pe.contiguous(),\n                 decode_k_pe) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author simon-mo Mar 10, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yup great point and i verified the perf. clone was a left over from previous debugging but your solution is great! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions simpler code from lucas â€¦ f8c28a4 Signed-off-by: simon-mo <simon.mo@hey.com> simon-mo enabled auto-merge (squash) March 10, 2025 16:13 simon-mo disabled auto-merge March 10, 2025 19:06 Hide details View details simon-mo merged commit fb0acb6 into vllm-project : main Mar 10, 2025 29 of 31 checks passed Uh oh! There was an error while loading. Please reload this page . LucasWilkinson mentioned this pull request Mar 11, 2025 [Bugfix] DeepSeek Accuracy #14476 Merged Copy link Contributor ZhongYingMatrix commented Mar 13, 2025 hi @simon-mo Thx for ur great work! Speaking of D2H operation, I notice that has_context on here would be a single element bool tensor, which incur H2D in following condition operation. Would it has an impact on performance? cc @LucasWilkinson All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author simon-mo commented Mar 13, 2025 good find. Fix welcomed! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . hmellor mentioned this pull request Apr 2, 2025 [Performance]: 0.8.1 vs 0.7.4dev122 R1 H20 performance benchmark testï¼Œ0.8.1 What is the reason for the 14% performance improvement(throughput tokens/s) #15881 Closed 1 task lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [Perf] Improve MLA on V1 ( vllm-project#14540 ) â€¦ 8e41390 Signed-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Perf] Improve MLA on V1 ( vllm-project#14540 ) â€¦ ba35e3b Signed-off-by: simon-mo <simon.mo@hey.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:03", "has_lm_eval": true, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, lm_eval, GSM8K | PERF: Throughput, Throughput, Throughput | TEST: Test, Test, Test", "analysis_extracted_at": "2025-09-07 17:52:03", "models": ["deepseek-ai/DeepSeek-V2-Lite", "deepseek-ai/DeepSeek-V2-Lite-Chat"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-V2-Lite,dtype=float16 --tasks gsm8k --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-V2-Lite-Chat,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-V2-Lite --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Perf] Improve MLA on V1 (#14540)", "commit_message": "[Perf] Improve MLA on V1 (#14540)\n\nSigned-off-by: simon-mo <simon.mo@hey.com>", "commit_date": "2025-03-10T12:06:58-07:00", "files_changed": ["vllm/v1/attention/backends/mla/common.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 7, "num_edited_lines": 68, "num_non_test_edited_lines": 68, "commit_year": 2025}, "diff_text": "diff --git a/vllm/v1/attention/backends/mla/common.py b/vllm/v1/attention/backends/mla/common.py\nindex 0b0f52167..526b792ab 100644\n--- a/vllm/v1/attention/backends/mla/common.py\n+++ b/vllm/v1/attention/backends/mla/common.py\n@@ -223,6 +223,7 @@ from vllm.model_executor.layers.quantization.utils.fp8_utils import (\n from vllm.model_executor.layers.quantization.utils.quant_utils import (\n     scaled_quantize)\n from vllm.model_executor.layers.rotary_embedding import RotaryEmbedding\n+from vllm.platforms import current_platform\n from vllm.utils import cdiv, round_down\n \n try:\n@@ -471,18 +472,23 @@ class MLACommonMetadataBuilder(Generic[M]):\n               common_prefix_len: int) -> M:\n         assert self._num_decodes + self._num_prefills == num_reqs\n \n+        # Note(simon): be careful about the CPU <> GPU memory movement in this\n+        # function. We should avoid GPU -> CPU sync as much as possible because\n+        # it blocks on all previous kernels.\n         device = self.runner.device\n-        query_start_loc = self.runner.query_start_loc_cpu[:num_reqs + 1].to(\n-            device, non_blocking=True)\n-        seq_lens = self.runner.seq_lens_cpu[:num_reqs].to(device,\n-                                                          non_blocking=True)\n         block_table = (\n             self.runner.input_batch.block_table.get_device_tensor()[:num_reqs])\n+        query_start_loc = self.runner.query_start_loc_cpu[:num_reqs + 1].to(\n+            device, non_blocking=True)\n         slot_mapping = self.runner.slot_mapping_cpu[:num_actual_tokens].to(\n             device, non_blocking=True).long()\n         input_positions = self.runner.positions_cpu[:num_actual_tokens].to(\n             device, non_blocking=True).long()\n \n+        seq_lens_cpu = self.runner.seq_lens_cpu[:num_reqs]\n+        seq_lens = seq_lens_cpu.to(device, non_blocking=True)\n+        max_query_len = seq_lens_cpu.max().item()\n+\n         prefill_metadata = None\n         if self._num_prefills > 0:\n             reqs_start = self._num_decodes  # prefill_start\n@@ -490,24 +496,22 @@ class MLACommonMetadataBuilder(Generic[M]):\n \n             context_lens_cpu = self.runner.input_batch.\\\n                 num_computed_tokens_cpu_tensor[reqs_start:num_reqs]\n-            context_lens = context_lens_cpu.to(device, non_blocking=True)\n+            max_context_len_cpu = context_lens_cpu.max().item()\n+            num_prefills_with_context_cpu = (context_lens_cpu > 0).sum().item()\n \n             chunked_context_metadata = None\n             if self.chunked_prefill_enabled and self._num_prefills > 0 \\\n-                and context_lens.max() > 0:\n+                and max_context_len_cpu > 0:\n                 # NOTE: it is recommend you read the `Chunked Prefill` section\n                 # in the comment at the top of the file before trying to\n                 # understand the following code\n \n-                num_prefills_with_context = (context_lens > 0).sum().item()\n-\n                 # currently we allocate an equal amount of workspace for each\n                 # prefill in the batch, we could probably use a more advanced\n                 # algorithm here and allocate more workspace to prefills with\n                 # longer context lengths\n-                max_context_chunk = \\\n-                    self.chunked_prefill_workspace_size \\\n-                        // num_prefills_with_context\n+                max_context_chunk = (self.chunked_prefill_workspace_size //\n+                                     num_prefills_with_context_cpu)\n \n                 # align max_context_chunk to page_size by rounding down,\n                 # currently the `gather_cache` kernel cannot handle\n@@ -516,30 +520,35 @@ class MLACommonMetadataBuilder(Generic[M]):\n                                                self.page_size)\n \n                 assert max_context_chunk > 0\n-                num_chunks = cdiv(context_lens.max(), max_context_chunk)\n+                num_chunks = cdiv(max_context_len_cpu, max_context_chunk)\n \n                 # if `max_context_chunk = 256`, `num_chunks = 3`, and\n                 #   `num_prefills_with_context = 4`, create a tensor that looks\n                 # like\n                 #  [[0, 0, 0, 0], [256, 256, 256, 256], [512, 512, 512, 512]]\n+                # Note(simon): this is done in CPU because of downstream's\n+                # of `to_list`.\n                 chunk_starts = \\\n-                    torch.arange(num_chunks, device=device, dtype=torch.int32) \\\n+                    torch.arange(num_chunks, dtype=torch.int32) \\\n                     .unsqueeze(1).expand(-1, self._num_prefills) \\\n                     * max_context_chunk\n-                chunk_ends = torch.min(context_lens.unsqueeze(0),\n+                chunk_ends = torch.min(context_lens_cpu.unsqueeze(0),\n                                        chunk_starts + max_context_chunk)\n                 chunk_seq_lens = (chunk_ends - chunk_starts).clamp(min=0)\n-                _chunk_cu_seq_lens = chunk_seq_lens.cumsum(dim=1).to(\n-                    torch.int32)\n-                zero = torch.zeros(num_chunks,\n-                                   dtype=torch.int32,\n-                                   device=device).unsqueeze(-1)\n+\n+                cu_seq_lens_cpu = torch.zeros(num_chunks,\n+                                              self._num_prefills + 1,\n+                                              dtype=torch.int32,\n+                                              pin_memory=True)\n+                torch.cumsum(chunk_seq_lens,\n+                             dim=1,\n+                             out=cu_seq_lens_cpu[:, 1:],\n+                             dtype=torch.int32)\n \n                 chunked_context_metadata = \\\n                     MLACommonPrefillMetadata.ChunkedContextMetadata(\n-                    cu_seq_lens=torch.cat(\n-                        [zero, _chunk_cu_seq_lens], dim=1),\n-                    starts=chunk_starts,\n+                    cu_seq_lens=cu_seq_lens_cpu.to(device, non_blocking=True),\n+                    starts=chunk_starts.to(device, non_blocking=True),\n                     seq_tot=chunk_seq_lens.sum(dim=1).tolist(),\n                     max_seq_lens=chunk_seq_lens.max(dim=1).values.tolist(),\n                     workspace=self.chunked_prefill_workspace,\n@@ -553,7 +562,7 @@ class MLACommonMetadataBuilder(Generic[M]):\n                 block_table=block_table[reqs_start:, ...],\n                 query_start_loc=query_start_loc[reqs_start:] -\n                 query_start_loc[reqs_start],\n-                max_query_len=seq_lens[reqs_start:].max().item(),\n+                max_query_len=max_query_len,\n                 chunked_context=chunked_context_metadata,\n             )\n \n@@ -629,7 +638,9 @@ class MLACommonImpl(MLAAttentionImpl[M], Generic[M]):\n         # already inside an attention custom op), pull out the forward\n         # method from the rotary embedding and call it directly\n         # TODO(lucas): we should probably find a cleaner way to do this\n-        self.rotary_emb = rotary_emb._forward_method\n+        self.rotary_emb = rotary_emb.forward_native\n+        if current_platform.is_cuda():\n+            self.rotary_emb = rotary_emb.forward_cuda\n \n         self.q_proj = q_proj\n         self.kv_b_proj = kv_b_proj\n@@ -1043,17 +1054,20 @@ class MLACommonImpl(MLAAttentionImpl[M], Generic[M]):\n             decode_q_nope = self._q_proj_and_k_up_proj(decode_hs_or_q_c)\n             decode_q_pe = torch.matmul(decode_hs_or_q_c, self.W_QR)\\\n                 .view(-1, self.num_heads, self.qk_rope_head_dim)\n+\n             decode_q_pe[...], decode_k_pe[...] = self.rotary_emb(\n-                attn_metadata.decode.input_positions, decode_q_pe, decode_k_pe)\n+                attn_metadata.decode.input_positions, decode_q_pe.contiguous(),\n+                decode_k_pe)\n \n         if has_prefill:\n             assert attn_metadata.prefill is not None\n             prefill_q = self.q_proj(prefill_hs_or_q_c)[0]\\\n                 .view(-1, self.num_heads, self.qk_head_dim)\n             prefill_q_pe = prefill_q[..., self.qk_nope_head_dim:]\n+\n             prefill_q_pe[...], prefill_k_pe[...] = self.rotary_emb(\n-                attn_metadata.prefill.input_positions, prefill_q_pe,\n-                prefill_k_pe)\n+                attn_metadata.prefill.input_positions,\n+                prefill_q_pe.contiguous(), prefill_k_pe)\n \n         # write the latent and rope to kv cache\n         if kv_cache.numel() > 0:", "apis": ["MLACommonMetadataBuilder.build", "MLACommonImpl.__init__", "MLACommonImpl.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/cutlass_mla.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/flashmla.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/flashmla.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/flashmla.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies MLA backend source code in a non-test file by reorganizing GPU/CPU memory operations and tensor movements to avoid unnecessary synchronization. The changes address performance by reducing potential blocking during memory transfers and optimizing control flow based on the current platform, switching between CUDA and native implementations. The modifications are non-trivial and affect key internal APIs used in top-level attention functionalities. The commit message â€œ[Perf] Improve MLA on V1â€ and the code changes suggest improvements to processing efficiency on CPU devices (and not just GPU/TPU specific hardware). Therefore, the commit meets the performance optimization criteria.", "llm_api_reason": "This commit improves the performance of the MLA backend in V1 by optimizing GPUâ€“CPU tensor transfers and ensuring that the rotary embedding is routed to the appropriate implementation based on the current platform. In the metadata builder, the build method is refined to minimize blocking transfers (by computing max_query_len on the CPU and avoiding unnecessary device transfers) and to correctly set up chunked context metadata. In the MLACommonImpl class, the rotary embedding method is updated to use forward_native by default and forward_cuda when running on CUDA, ensuring a more efficient execution path."}
{"commit_hash": "ca7a2d5f28eac9621474563cdda0e08596222755", "pr_url": "https://github.com/vllm-project/vllm/pull/14471", "pr_date": "2025-03-08", "timeline_text": "Copy link Collaborator tlrmchlsmth commented Mar 8, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Running VLLM_USE_V1=1 vllm serve deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct --tensor_parallel_size=2 --port 8192 --trust-remote-code and then lm_eval --model local-completions --tasks gsm8k --model_args model=deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct,base_url=http://127.0.0.1:8192/v1/completions,num_concurrent=5,max_retries=3,tokenized_requests=False --limit 100 On current main we see: |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.06|Â±  |0.0239|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.00|Â±  |0.0000| This PR: |Tasks|Version|     Filter     |n-shot|  Metric   |   |Value|   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  | 0.77|Â±  |0.0423|\n|     |       |strict-match    |     5|exact_match|â†‘  | 0.77|Â±  |0.0423| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Revert \"[Perf] Reduce MLA CPU overheads in V1 ( #14384 )\" â€¦ c671cd9 This reverts commit dae6896 . tlrmchlsmth requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners March 8, 2025 03:13 Copy link github-actions bot commented Mar 8, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth mentioned this pull request Mar 8, 2025 [Bugfix][V1] Handle MLA in kv_cache_interface #14462 Merged mergify bot added\n  the v1 label Mar 8, 2025 simon-mo approved these changes Mar 8, 2025 View reviewed changes Hide details View details simon-mo merged commit ca7a2d5 into main Mar 8, 2025 21 of 23 checks passed Uh oh! There was an error while loading. Please reload this page . simon-mo deleted the revert_rope_mla_bug branch March 8, 2025 06:18 simon-mo added a commit\n        to simon-mo/vllm\n      that referenced\n      this pull request Mar 9, 2025 Revert \"Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#1â€¦ â€¦ ef04b8d â€¦4384 )\" ( vllm-project#14471 )\"\n\nThis reverts commit ca7a2d5 .\n\nSigned-off-by: simon-mo <simon.mo@hey.com> simon-mo mentioned this pull request Mar 10, 2025 [Perf] Improve MLA on V1 #14540 Merged Alexei-V-Ivanov-AMD added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Mar 11, 2025 Merging in the latest merge from vllm-project to ROCm ( #472 ) â€¦ a699a11 * Fix `head_dim` not existing in all model configs (Transformers backend) ( vllm-project#14141 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V0][Metrics] Remove unimplemented `vllm:tokens_total` ( vllm-project#14134 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V0][Metrics] Deprecate some KV/prefix cache metrics ( vllm-project#14136 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1] Simplify stats logging ( vllm-project#14082 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [WIP][[V1][Metrics] Implement max_num_generation_tokens,  request_params_n, and request_params_max_tokens metrics ( vllm-project#14055 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Allow shared_experts skip quantization for DeepSeekV2/V3 ( vllm-project#14100 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add GPTQModel ( vllm-project#14056 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Add comments to the new ragged paged attention Pallas kernel ( vllm-project#14155 )\n\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\n\n* [Model] Add support for GraniteMoeShared models ( vllm-project#13313 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [core] moe fp8 block quant tuning support ( vllm-project#14068 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Remove lru_cache in NvmlCudaPlatform ( vllm-project#14156 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] Pass all driver env vars to ray workers unless excluded ( vllm-project#14099 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use math.prod instead of np.prod for trivial ops ( vllm-project#14142 )\n\n* Fix benchmark_moe.py tuning for CUDA devices ( vllm-project#14164 )\n\n* [platform] add debug logging during inferring the device type ( vllm-project#14195 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [sleep mode] error out with expandable_segments ( vllm-project#14189 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [doc] add \"Failed to infer device type\" to faq ( vllm-project#14200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Restrict MacOS CPU detection ( vllm-project#14210 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][BugFix] Fix remaining sync engine client shutdown errors/hangs ( vllm-project#13869 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V0][Metrics] Deprecate some questionable request time metrics ( vllm-project#14135 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][Molmo] Fix get_multimodal_embeddings() in molmo.py ( vllm-project#14161 )\n\n* add cutlass support for blackwell fp8 gemm ( vllm-project#13798 )\n\n* [TPU][Profiler] Support start_profile/stop_profile in TPU worker ( vllm-project#13988 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* Fix performance when `--generation-config` is not `None` ( vllm-project#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] Do `prompt_logprobs` clamping for chat as well as completions ( vllm-project#14225 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Update Dockerfile dependency image ( vllm-project#14215 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1][Metrics] Add design doc ( vllm-project#12745 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Security] Serialize using safetensors instead of pickle in Mooncake Pipe ( vllm-project#14228 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Clean up unused padding_idx variables across many model definitions ( vllm-project#13240 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [ROCm] Disable a few more kernel tests that are broken on ROCm ( vllm-project#14145 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [V1][TPU] TPU multimodal model support for ragged attention ( vllm-project#14158 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [misc] announce china meetup ( vllm-project#14248 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Moved numba from common requirements to cuda/rocm specific requirements ( vllm-project#14199 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* Disable GPTQ AllSpark kernels for CUDA Compiler < 12.0 ( vllm-project#14157 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Bugfix] Fix gptq_marlin for deepseek-v3 ( vllm-project#13750 )\n\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\n\n* [V1][Bugfix] Do not reset prefix caching metrics ( vllm-project#14235 )\n\n* [Model] New model support for Phi-4-multimodal-instruct ( vllm-project#14119 )\n\n* [V1] EP/TP MoE + DP Attention ( vllm-project#13931 )\n\n* [platforms] improve rocm debugging info ( vllm-project#14257 )\n\n* Temporarily disable test_awq_gemm_opcheck ( vllm-project#14251 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Frontend] Allow return_tokens_as_token_ids to be passed as a request param ( vllm-project#14066 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\n\n* [Misc][V1] Avoid using `envs.VLLM_USE_V1` in mm processing ( vllm-project#14256 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][V1] Fix allowed_token_ids for v1 Sampler ( vllm-project#14169 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Update nginx guide: remove privileged from vllm container run and add target GPU ID ( vllm-project#14217 )\n\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\n\n* [Doc] [3/N] Refer code examples for common cases in dev multimodal processor ( vllm-project#14278 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Small update for external_launcher backend docs ( vllm-project#14288 )\n\n* [V1][Frontend] Add Testing For V1 Runtime Parameters ( vllm-project#14159 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [LoRA] Remove linear hack outside transformers backend ( vllm-project#14177 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Add Qwen2MoeForCausalLM moe tuning support  ( vllm-project#14276 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* prefix_caching.md: Fixed typo ( vllm-project#14293 )\n\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\n\n* [Bugfix] Fix broken vision language example ( vllm-project#14292 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Docs] Add Meta Slides ( vllm-project#14297 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [V1][Minor] Remove obsolete FIXME comment ( vllm-project#14304 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* Deprecate `best_of` Sampling Parameter in anticipation for vLLM V1 ( vllm-project#13997 )\n\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][BugFix] Fix for mixed top_k batch ( vllm-project#14301 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\n\n* [misc] Add FlashMLA as a new option of VLLM_ATTENTION_BACKEND env ( vllm-project#14267 )\n\n* [V1][Easy] Add empty allowed_token_ids in the v1 sampler test ( vllm-project#14308 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* init\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Bugfix] Fix DeepSeek MTP crash when using TP1ModelRunner with CUDA graph due to shape mismatch ( vllm-project#14237 )\n\nSigned-off-by: pyc96 <pychen96@gmail.com>\n\n* [Bugfix] Remove num_tokens_across_dp ( vllm-project#14302 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [BugFix] Fix prefix caching V0 MLA ( vllm-project#14255 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\n\n* [CI/Build] Use spawn multiprocessing mode for V1 test pipeline ( vllm-project#14243 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Add benchmark for DeepGEMM and vLLM Block FP8 Dense GEMM ( vllm-project#13917 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Build] Add UV_HTTP_TIMEOUT to avoid timeout during installation ( vllm-project#13850 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] MLA + V1, illegal memory access and accuracy issues ( vllm-project#14253 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [misc] Mention `ray list nodes` command to troubleshoot ray issues ( vllm-project#14318 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [Bugfix][Structured Output] Support outlines engine with reasoning outputs for DeepSeek R1 ( vllm-project#14114 )\n\n* [V1] LoRA - Enable more V1 tests ( vllm-project#14315 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix][CI] ALiBi test case in xformers multi_query_kv_attention ( vllm-project#11301 )\n\n* [Hardware] Update the flash attn tag to support Blackwell ( vllm-project#14244 )\n\n* [Model] Update Paligemma multimodal processing with PromptUpdate  ( vllm-project#14015 )\n\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1][VLM][Pixtral-HF] Support Pixtral-HF on V1 ( vllm-project#14275 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Core] Optimizing cross-attention `QKVParallelLinear` computation ( vllm-project#12325 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\n\n* [Frontend][Docs] Transcription API streaming ( vllm-project#13301 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Doc] Update reasoning with stream example to use OpenAI library ( vllm-project#14077 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Doc] Correct beam_search using in generative_models.md ( vllm-project#14363 )\n\n* [Kernel] [V1] Improved performance for V1 Triton (ROCm) backend  ( vllm-project#14152 )\n\n* [Bugfix][Core] fix abort_seq_group and memory leak when n>1 ( vllm-project#14326 )\n\nSigned-off-by: courage17340 <courage17340@163.com>\n\n* [Core] Don't use cache during multi-modal profiling ( vllm-project#14336 )\n\n* [Doc] Fix date typo in README.md ( vllm-project#14366 )\n\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\n\n* [RLHF] use worker_extension_cls for compatibility with V0 and V1 ( vllm-project#14185 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Reinstate `best_of` for V0 ( vllm-project#14356 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Adding cpu inference with VXE ISA for s390x architecture ( vllm-project#12613 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\n\n* Add authors to license header. ( vllm-project#14371 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\n\n* Fix mla prefill context performance ( vllm-project#13897 )\n\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\n\n* [V1] Do not detokenize if sampling param detokenize is False ( vllm-project#14224 )\n\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Distributed] Add enable_expert_parallel arg ( vllm-project#14305 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build] Use uv python for docker rather than ppa:deadsnakes/ppa ( vllm-project#13569 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [CI] Disable spawn when running V1 Test ( vllm-project#14345 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Kernel] Add needs_fixed_stride_order tag to most GEMMs ( vllm-project#14306 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bugfix] Fix use_direct_call condition in FusedMoE layer for  ( vllm-project#14382 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bug] Fix Attention when ignored in by quant_method ( vllm-project#14313 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][Bugfix] Standardize quantized kv cache rejection for attention backends ( vllm-project#14221 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add nsight guide to profiling docs ( vllm-project#14298 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* cleanup boolean logic\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Hardware][TPU]Enable ragged paged attention kernel and resolve recompilation issue ( vllm-project#14310 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Doc] Fix a typo ( vllm-project#14385 )\n\n* [Bugfix] Correctly call `cudaProfilerStop` in benchmarks script ( vllm-project#14183 )\n\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\n\n* [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [FP8] Refactor apply_fp8_linear and apply_fp8_linear_generic into an object ( vllm-project#14390 )\n\nSigned-off-by: luka <luka@neuralmagic.com>\n\n* [BugFix] Illegal Memory Access in the blockwise cutlass fp8 GEMMs ( vllm-project#14396 )\n\n* [Bugfix] Fix JambaForCausalLM LoRA  ( vllm-project#14370 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Build] Add nightly wheel fallback when latest commit wheel unavailable ( vllm-project#14358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* OpenVINO: added CPU-like conditions ( vllm-project#14338 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [GH] Auto-apply multi-modality label to relevant PRs ( vllm-project#14402 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* correct wrong markdown syntax ( vllm-project#14414 )\n\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\n\n* [Bugfix] Further clean up LoRA test ( vllm-project#14422 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Clean up multi-modal processors ( vllm-project#14417 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Set default value of seed to None ( vllm-project#14274 )\n\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\n\n* [BUGFIX] Skip tokenization support for throughput benchmark ( vllm-project#12712 )\n\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\n\n* Fix missing `kv_caches` and `attn_metadata` in `OpenVINOCausalLM` ( vllm-project#14271 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Use the optimized block sizes after tuning the kernel. ( vllm-project#14329 )\n\n* [V1][Core] Support for Structured Outputs ( vllm-project#12388 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Doc] Update prefix_caching.md to match the example image ( vllm-project#14420 )\n\n* [Benchmarks] Make detokenization optional in benchmark scripts ( vllm-project#11697 )\n\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\n\n* comments\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Kernel] optimize performance of gptq marlin kernel when n is small ( vllm-project#14138 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [Misc] Add Phi4-MM example ( vllm-project#14343 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [v1] torch.compile integration explanation ( vllm-project#14437 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Eagerly remove finished requests from the batch ( vllm-project#14388 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V1][Metrics] Fix traceback with preemptions+LoRA ( vllm-project#14220 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Fix torch_xla which can't handle None seed introduced in vllm-project#14274 ( vllm-project#14459 )\n\nSigned-off-by: Yarong Mu <ymu@google.com>\n\n* [V1] Prompt logprobs + APC compatibility; prompt logprobs reqs cannot fill APC ( vllm-project#13949 )\n\n* [Bugfix][V1] Handle MLA in kv_cache_interface ( vllm-project#14462 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vllm-project#14471 )\n\n* [Bugfix][Disaggregated] Add a check in send_kv_caches_and_hidden_states and fix the reshape of the KVCache ( vllm-project#14369 )\n\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\n\n* [MISC][V1] Register process killing handler only in the main thread ( vllm-project#14380 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] add `extra_args` to `SamplingParams` ( vllm-project#13300 )\n\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\n\n* [CI/Build] refactor: set timezone of container to UTC ( vllm-project#12888 )\n\nSigned-off-by: Roger Meier <r.meier@siemens.com>\n\n* Default to `generation_config` from model ( vllm-project#12622 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc]add doc for Qwen models tool calling ( vllm-project#14478 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Doc] Added QwQ-32B to the supported models list in the reasoning outâ€¦ ( vllm-project#14479 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Bugfix] Make the deviceprofiler include LoRA memory. ( vllm-project#14469 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Add training doc signposting to TRL ( vllm-project#14439 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Build/BugFix] Fix hopper 12.8 build ( vllm-project#14354 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add RLHF document ( vllm-project#14482 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Use a fixed seed to avoid flaky tests ( vllm-project#14480 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] TPU - Add tensor parallel support via Ray ( vllm-project#13618 )\n\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\n\n* [VLM] Add TP support for Phi-4-MM ( vllm-project#14453 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] add `use_tqdm_on_load` to reduce logs ( vllm-project#14407 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [V1][Core] Fix memory issue with logits & sampling ( vllm-project#13776 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [benchmarks] Add option to use unique jsonschema for each request ( vllm-project#14457 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Don't run ruff at all on 3rd party libs ( vllm-project#14493 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Move requirements into their own directory ( vllm-project#12547 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] DeepSeek Accuracy ( vllm-project#14476 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [Bugfix] Fix profiling OOM and decouple encoder multimodal profiling ( vllm-project#14361 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Update CODEOWNERS for structured output ( vllm-project#14496 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Upgrade to Python 3.9 typing for additional directories ( vllm-project#14492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support bad_words in sampler ( vllm-project#13376 )\n\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* Revert \"[V1][Core] Fix memory issue with logits & sampling\" ( vllm-project#14504 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Attention] Default to FlashMLA backend for MLA ( vllm-project#14451 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [V1][TPU] Remove unnecessary padding for running on TPU. ( vllm-project#14467 )\n\n* [Feat] Support chunked prefill for LMCache connector ( vllm-project#14505 )\n\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\n\n* [Bugfix] Fix tqdm progress bar when SamplingParams.n > 1 ( vllm-project#12428 )\n\nSigned-off-by: Yuchen Yan <740987012@qq.com>\n\n* [Bugfix] Revert QKVCrossParallelLinear usage in Mllama to keep BNB quantization work ( vllm-project#14498 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] Fix the recompiling issue in logits processor after warmup ( vllm-project#14510 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Misc] Ensure out-of-tree quantization method recognize by cli args ( vllm-project#14328 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Bugfix] Wrong requirements path - rocm ( vllm-project#14527 )\n\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\n\n* [Feature] Consolidate performance benchmark datasets ( vllm-project#14036 )\n\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Add log information for handle_process_request. ( vllm-project#14130 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Docs] Mention `model_impl` arg when explaining Transformers fallback ( vllm-project#14552 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] support image embeds ( vllm-project#13955 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Kernel] Add more dtype support for GGUF kernels ( vllm-project#14043 )\n\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\n\n* [Doc] Update PaliGemma note to a warning ( vllm-project#14565 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* V1 rocm support ( #469 )\n\n* Initial commit for V1 successfull compilation\n\n* Small improvement for linear\n\n* Small improvement for linear\n\n* making use of forward_cuda for all except ROPE in llama\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* nightly_fixed_aiter_integration_final_20250305 README update ( #470 )\n\n* nightly_fixed_aiter_integration_final_20250305 README update (perf results only)\n\n* Update Docker Manifest git hash\n\n* Update Docker Manifest and added nightly_fixed_aiter_integration_final_20250305\n\n* some more updates\n\n* Update AITER section with example\n\n* Updated AITER command with larger batch size and model name\n\n* Fixing typo\n\n* Removed --max-model-len in AITER command\n\n* Updating AITER instructions\n\n* typo\n\n* Another typo\n\n* Whitespace\n\n* modifying whats new section\n\n* Another typo\n\n---------\n\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: pyc96 <pychen96@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\nSigned-off-by: courage17340 <courage17340@163.com>\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\nSigned-off-by: luka <luka@neuralmagic.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Yarong Mu <ymu@google.com>\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\nSigned-off-by: Roger Meier <r.meier@siemens.com>\nSigned-off-by: WangErXiao <863579016@qq.com>\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Yuchen Yan <740987012@qq.com>\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Qubitium-ModelCloud <qubitium@modelcloud.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: iefgnoix <isaacwxf23@gmail.com>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Zhanwen Chen <phil.zhanwen.chen@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: kushanam <42385577+kushanam@users.noreply.github.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: rainkert <93575312+rainkert@users.noreply.github.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: Congcong Chen <congcongchen@microsoft.com>\nCo-authored-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Iacopo Poli <iacopo@lighton.ai>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Zhe Zhang <zhz@apache.org>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: DaividFrank <49250948+DaividFrank@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Vincent <vincentzhongy+githubvincent4@gmail.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\nCo-authored-by: Serena <yangsijia.614@bytedance.com>\nCo-authored-by: pyc96 <pychen96@gmail.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Ce Gao <cegao@tensorchord.ai>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: kYLe <kylhuang@nvidia.com>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: Yanyi Liu <wolfsonliu@163.com>\nCo-authored-by: Irina Yuryeva <76484191+upayuryeva@users.noreply.github.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: courage17340 <courage17340@users.noreply.github.com>\nCo-authored-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\nCo-authored-by: Himanshu Jaju <hj@mistral.ai>\nCo-authored-by: Chengji Yao <chengjiyao@google.com>\nCo-authored-by: Daniel Li <dyli@google.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Peng Li <justdoit.pli@gmail.com>\nCo-authored-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: York-RDWang <103811994+York-RDWang@users.noreply.github.com>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: yarongmu-google <150371854+yarongmu-google@users.noreply.github.com>\nCo-authored-by: afeldman-nm <156691304+afeldman-nm@users.noreply.github.com>\nCo-authored-by: Mathis Felardos <mathis@mistral.ai>\nCo-authored-by: Aviv Keshet <akeshet@scaledcognition.com>\nCo-authored-by: Roger Meier <r.meier@siemens.com>\nCo-authored-by: Robin <863579016@qq.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-redhat@users.noreply.github.com>\nCo-authored-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Yuchen Yan <50619811+yanyc428@users.noreply.github.com>\nCo-authored-by: Martin Hoyer <mhoyer@redhat.com>\nCo-authored-by: Jennifer Zhao <JenZhao@users.noreply.github.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: Szymon OÅ¼Ã³g <58388001+SzymonOzog@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Mcirino1 <57415822+Mcirino1@users.noreply.github.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com> captainzmc pushed a commit\n        to captainzmc/vllm\n      that referenced\n      this pull request Mar 12, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vâ€¦ â€¦ f08a8d3 â€¦llm-project#14471 ) LucasWilkinson mentioned this pull request Mar 13, 2025 [Attention] Remove slow setattr in MLA #14769 Merged lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vâ€¦ â€¦ 0492d83 â€¦llm-project#14471 )\n\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vâ€¦ â€¦ 7e10bb8 â€¦llm-project#14471 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:06", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: lm_eval, gsm8k, gsm8k | PERF: throughput, improvement, improvement | SERVING: vllm serve, serve, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:52:06", "models": ["deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct,dtype=float16 --tasks gsm8k --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "Revert \"[Perf] Reduce MLA CPU overheads in V1 (#14384)\" (#14471)", "commit_message": "Revert \"[Perf] Reduce MLA CPU overheads in V1 (#14384)\" (#14471)", "commit_date": "2025-03-07T22:18:53-08:00", "files_changed": ["vllm/model_executor/layers/rotary_embedding.py", "vllm/v1/attention/backends/mla/common.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 3, "num_edited_lines": 24, "num_non_test_edited_lines": 24, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/rotary_embedding.py b/vllm/model_executor/layers/rotary_embedding.py\nindex 48cdebee9..64c2dac52 100644\n--- a/vllm/model_executor/layers/rotary_embedding.py\n+++ b/vllm/model_executor/layers/rotary_embedding.py\n@@ -161,13 +161,8 @@ class RotaryEmbedding(CustomOp):\n     ) -> Tuple[torch.Tensor, torch.Tensor]:\n         from vllm import _custom_ops as ops\n \n-        # __setattr__ in nn.Module (called by `self.cos_sin_cache = ...`)\n-        # is expensive, so avoid calling it if possible\n-        if self.cos_sin_cache.device != query.device or \\\n-            self.cos_sin_cache.dtype != query.dtype:\n-            self.cos_sin_cache = self.cos_sin_cache.to(query.device,\n-                                                       dtype=query.dtype)\n-\n+        self.cos_sin_cache = self.cos_sin_cache.to(query.device,\n+                                                   dtype=query.dtype)\n         # ops.rotary_embedding()/batched_rotary_embedding()\n         # are in-place operations that update the query and key tensors.\n         if offsets is not None:\ndiff --git a/vllm/v1/attention/backends/mla/common.py b/vllm/v1/attention/backends/mla/common.py\nindex f3fff585b..886295ee8 100644\n--- a/vllm/v1/attention/backends/mla/common.py\n+++ b/vllm/v1/attention/backends/mla/common.py\n@@ -222,8 +222,8 @@ from vllm.model_executor.layers.quantization.utils.fp8_utils import (\n     Fp8LinearGenericOp, current_platform_fp8_dtype, is_fp8)\n from vllm.model_executor.layers.quantization.utils.quant_utils import (\n     scaled_quantize)\n-from vllm.model_executor.layers.rotary_embedding import RotaryEmbedding\n-from vllm.platforms import current_platform\n+from vllm.model_executor.layers.rotary_embedding import (\n+    DeepseekScalingRotaryEmbedding, RotaryEmbedding)\n from vllm.utils import cdiv, round_down\n \n try:\n@@ -627,15 +627,8 @@ class MLACommonImpl(MLAAttentionImpl[M], Generic[M]):\n         self.v_head_dim = v_head_dim\n \n         self.rotary_emb = rotary_emb\n-\n-        if current_platform.is_cuda():\n-            # Hack for V1 for now to avoid torch library overhead (since we are\n-            # already inside an attention custom op), pull out the forward\n-            # method from the rotary embedding and call it directly (and avoid\n-            # calling forward_native, when we can call forward_cuda)\n-            # TODO(lucas): we should probably find a cleaner way to do this\n-            self.rotary_emb = rotary_emb.forward_cuda\n-\n+        self.use_yarn_rope = isinstance(rotary_emb,\n+                                        DeepseekScalingRotaryEmbedding)\n         self.q_proj = q_proj\n         self.kv_b_proj = kv_b_proj\n         self.o_proj = o_proj", "apis": ["vllm.model_executor.layers.rotary_embedding.RotaryEmbedding.forward_cuda", "vllm.v1.attention.backends.mla.common.MLACommonImpl.__init__"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/rotary_embedding.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/cutlass_mla.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit reverts a previous change tagged as a performance improvement (â€œ[Perf] Reduce MLA CPU overheads in V1â€). It modifies multiple non-test source files. In rotary_embedding.py, it removes a conditional check before converting tensor types and devices (likely introduced previously as a performance optimization to avoid expensive __setattr__ calls). In mla/common.py it removes a hack that bypassed extra function calls on CUDA devices, reverting to a more standard behavior by using a type-check instead. These changes are non-trivial modifications to internal API behavior and impact CPU performance. They are not merely refactoring, documentation, or bug fixes. Thus, the commit is performance or optimization related.", "llm_api_reason": "In the first file the commit removes a conditional check when moving the cos_sin_cache to the queryâ€™s device and dtype inside the RotaryEmbedding.forward_cuda method â€“ now the cache is always converted. In the second file the import statement is updated to also import DeepseekScalingRotaryEmbedding, and instead of â€œhackingâ€ by replacing the rotary_emb with its forward_cuda method on CUDA platforms, the MLACommonImpl initializer now sets an attribute (use_yarn_rope) based on whether the provided rotary embedding is an instance of DeepseekScalingRotaryEmbedding. These changes affect the behavior of rotary positional embedding during inference and how the MLA attention implementation in V1 chooses its rotary method."}
{"commit_hash": "dae68969774e41b93b01cd31171ca033a92b574a", "pr_url": "https://github.com/vllm-project/vllm/pull/14384", "pr_date": "2025-03-06", "timeline_text": "Copy link Collaborator LucasWilkinson commented Mar 6, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Some temporary hacks to reduce CPU overheads in MLA caused by rotary embeddings (not in torch.compile, or a cuda-graph) Main This PR Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions reduce cpu overheads â€¦ 6e7928c Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> LucasWilkinson requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners March 6, 2025 21:38 Copy link github-actions bot commented Mar 6, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Mar 6, 2025 add a todo â€¦ 0f6abfb Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com> mgoin approved these changes Mar 6, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This is unfortunately an easy footgun to trigger, nice find. cc @WoosukKwon Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added ready ONLY add when PR is ready to merge/full CI is needed performance Performance-related issues labels Mar 6, 2025 WoosukKwon requested changes Mar 6, 2025 View reviewed changes vllm/model_executor/layers/rotary_embedding.py Comment on lines -164 to -165 self.cos_sin_cache = self.cos_sin_cache.to(query.device, dtype=query.dtype) Copy link Collaborator WoosukKwon Mar 6, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Do we actually know what this line of code is for? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author LucasWilkinson Mar 6, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment no :/ it doesnt appear to be called, but just didn't want to create behavior change in case there was a model that needs it. I can pull it out completely and we can just see if we get reports of breakages Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/attention/backends/mla/common.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author LucasWilkinson commented Mar 6, 2025 8xH200, DeepSeek-R1, VLLM_USE_V1=1 VLLM_ATTENTION_BACKEND=FLASHMLA VLLM_USE_FLASHINFER_SAMPLER=1\n\nMain:\n\n  backend  input_tokens  output_tokens  output_toks/s     req/s  median_itl_ms  median_ttft_ms\n2    vllm          1000           1000    1095.323697  1.095324      40.931626      149.658605\n1    vllm          5000           1000     517.327850  0.517328      39.956240     5627.535715\n3    vllm         10000           1000     315.639817  0.315640      39.697455    57821.907031\n0    vllm         32000           1000     106.821047  0.106821      40.109005   193232.262791\n\nThis PR:\n\n  backend  input_tokens  output_tokens  output_toks/s     req/s  median_itl_ms  median_ttft_ms\n2    vllm          1000           1000    1326.682856  1.326683      29.775325     2541.827728\n1    vllm          5000           1000     644.308764  0.644309      32.297487     5495.584260\n3    vllm         10000           1000     387.664650  0.387665      31.273896    49202.113080\n0    vllm         32000           1000     127.601311  0.127601      31.530342   166538.112456 ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji ðŸ‘€ 2 mgoin and MichoChan reacted with eyes emoji All reactions ðŸ‘ 1 reaction ðŸ‘€ 2 reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon reviewed Mar 6, 2025 View reviewed changes vllm/model_executor/layers/rotary_embedding.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . review comments + cleanup â€¦ 4e1ef0d Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com> WoosukKwon approved these changes Mar 7, 2025 View reviewed changes tlrmchlsmth approved these changes Mar 7, 2025 View reviewed changes Hide details View details vllm-bot merged commit dae6896 into vllm-project : main Mar 7, 2025 33 of 35 checks passed Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth added a commit\n      that referenced\n      this pull request Mar 8, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( #14384 )\" â€¦ c671cd9 This reverts commit dae6896 . LucasWilkinson mentioned this pull request Mar 8, 2025 [Bugfix] DeepSeek Accuracy #14476 Merged simon-mo pushed a commit\n      that referenced\n      this pull request Mar 8, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( #14384 )\" ( #14471 ) ca7a2d5 simon-mo added a commit\n        to simon-mo/vllm\n      that referenced\n      this pull request Mar 9, 2025 Revert \"Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#1â€¦ â€¦ ef04b8d â€¦4384 )\" ( vllm-project#14471 )\"\n\nThis reverts commit ca7a2d5 .\n\nSigned-off-by: simon-mo <simon.mo@hey.com> simon-mo mentioned this pull request Mar 10, 2025 [Perf] Improve MLA on V1 #14540 Merged Alexei-V-Ivanov-AMD added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Mar 11, 2025 Merging in the latest merge from vllm-project to ROCm ( #472 ) â€¦ a699a11 * Fix `head_dim` not existing in all model configs (Transformers backend) ( vllm-project#14141 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V0][Metrics] Remove unimplemented `vllm:tokens_total` ( vllm-project#14134 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V0][Metrics] Deprecate some KV/prefix cache metrics ( vllm-project#14136 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1] Simplify stats logging ( vllm-project#14082 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [WIP][[V1][Metrics] Implement max_num_generation_tokens,  request_params_n, and request_params_max_tokens metrics ( vllm-project#14055 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Allow shared_experts skip quantization for DeepSeekV2/V3 ( vllm-project#14100 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add GPTQModel ( vllm-project#14056 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Add comments to the new ragged paged attention Pallas kernel ( vllm-project#14155 )\n\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\n\n* [Model] Add support for GraniteMoeShared models ( vllm-project#13313 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [core] moe fp8 block quant tuning support ( vllm-project#14068 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Remove lru_cache in NvmlCudaPlatform ( vllm-project#14156 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] Pass all driver env vars to ray workers unless excluded ( vllm-project#14099 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use math.prod instead of np.prod for trivial ops ( vllm-project#14142 )\n\n* Fix benchmark_moe.py tuning for CUDA devices ( vllm-project#14164 )\n\n* [platform] add debug logging during inferring the device type ( vllm-project#14195 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [sleep mode] error out with expandable_segments ( vllm-project#14189 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [doc] add \"Failed to infer device type\" to faq ( vllm-project#14200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Restrict MacOS CPU detection ( vllm-project#14210 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][BugFix] Fix remaining sync engine client shutdown errors/hangs ( vllm-project#13869 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V0][Metrics] Deprecate some questionable request time metrics ( vllm-project#14135 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][Molmo] Fix get_multimodal_embeddings() in molmo.py ( vllm-project#14161 )\n\n* add cutlass support for blackwell fp8 gemm ( vllm-project#13798 )\n\n* [TPU][Profiler] Support start_profile/stop_profile in TPU worker ( vllm-project#13988 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* Fix performance when `--generation-config` is not `None` ( vllm-project#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] Do `prompt_logprobs` clamping for chat as well as completions ( vllm-project#14225 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Update Dockerfile dependency image ( vllm-project#14215 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1][Metrics] Add design doc ( vllm-project#12745 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Security] Serialize using safetensors instead of pickle in Mooncake Pipe ( vllm-project#14228 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Clean up unused padding_idx variables across many model definitions ( vllm-project#13240 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [ROCm] Disable a few more kernel tests that are broken on ROCm ( vllm-project#14145 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [V1][TPU] TPU multimodal model support for ragged attention ( vllm-project#14158 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [misc] announce china meetup ( vllm-project#14248 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Moved numba from common requirements to cuda/rocm specific requirements ( vllm-project#14199 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* Disable GPTQ AllSpark kernels for CUDA Compiler < 12.0 ( vllm-project#14157 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Bugfix] Fix gptq_marlin for deepseek-v3 ( vllm-project#13750 )\n\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\n\n* [V1][Bugfix] Do not reset prefix caching metrics ( vllm-project#14235 )\n\n* [Model] New model support for Phi-4-multimodal-instruct ( vllm-project#14119 )\n\n* [V1] EP/TP MoE + DP Attention ( vllm-project#13931 )\n\n* [platforms] improve rocm debugging info ( vllm-project#14257 )\n\n* Temporarily disable test_awq_gemm_opcheck ( vllm-project#14251 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Frontend] Allow return_tokens_as_token_ids to be passed as a request param ( vllm-project#14066 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\n\n* [Misc][V1] Avoid using `envs.VLLM_USE_V1` in mm processing ( vllm-project#14256 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][V1] Fix allowed_token_ids for v1 Sampler ( vllm-project#14169 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Update nginx guide: remove privileged from vllm container run and add target GPU ID ( vllm-project#14217 )\n\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\n\n* [Doc] [3/N] Refer code examples for common cases in dev multimodal processor ( vllm-project#14278 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Small update for external_launcher backend docs ( vllm-project#14288 )\n\n* [V1][Frontend] Add Testing For V1 Runtime Parameters ( vllm-project#14159 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [LoRA] Remove linear hack outside transformers backend ( vllm-project#14177 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Add Qwen2MoeForCausalLM moe tuning support  ( vllm-project#14276 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* prefix_caching.md: Fixed typo ( vllm-project#14293 )\n\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\n\n* [Bugfix] Fix broken vision language example ( vllm-project#14292 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Docs] Add Meta Slides ( vllm-project#14297 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [V1][Minor] Remove obsolete FIXME comment ( vllm-project#14304 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* Deprecate `best_of` Sampling Parameter in anticipation for vLLM V1 ( vllm-project#13997 )\n\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][BugFix] Fix for mixed top_k batch ( vllm-project#14301 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\n\n* [misc] Add FlashMLA as a new option of VLLM_ATTENTION_BACKEND env ( vllm-project#14267 )\n\n* [V1][Easy] Add empty allowed_token_ids in the v1 sampler test ( vllm-project#14308 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* init\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Bugfix] Fix DeepSeek MTP crash when using TP1ModelRunner with CUDA graph due to shape mismatch ( vllm-project#14237 )\n\nSigned-off-by: pyc96 <pychen96@gmail.com>\n\n* [Bugfix] Remove num_tokens_across_dp ( vllm-project#14302 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [BugFix] Fix prefix caching V0 MLA ( vllm-project#14255 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\n\n* [CI/Build] Use spawn multiprocessing mode for V1 test pipeline ( vllm-project#14243 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Add benchmark for DeepGEMM and vLLM Block FP8 Dense GEMM ( vllm-project#13917 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Build] Add UV_HTTP_TIMEOUT to avoid timeout during installation ( vllm-project#13850 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] MLA + V1, illegal memory access and accuracy issues ( vllm-project#14253 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [misc] Mention `ray list nodes` command to troubleshoot ray issues ( vllm-project#14318 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [Bugfix][Structured Output] Support outlines engine with reasoning outputs for DeepSeek R1 ( vllm-project#14114 )\n\n* [V1] LoRA - Enable more V1 tests ( vllm-project#14315 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix][CI] ALiBi test case in xformers multi_query_kv_attention ( vllm-project#11301 )\n\n* [Hardware] Update the flash attn tag to support Blackwell ( vllm-project#14244 )\n\n* [Model] Update Paligemma multimodal processing with PromptUpdate  ( vllm-project#14015 )\n\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1][VLM][Pixtral-HF] Support Pixtral-HF on V1 ( vllm-project#14275 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Core] Optimizing cross-attention `QKVParallelLinear` computation ( vllm-project#12325 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\n\n* [Frontend][Docs] Transcription API streaming ( vllm-project#13301 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Doc] Update reasoning with stream example to use OpenAI library ( vllm-project#14077 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Doc] Correct beam_search using in generative_models.md ( vllm-project#14363 )\n\n* [Kernel] [V1] Improved performance for V1 Triton (ROCm) backend  ( vllm-project#14152 )\n\n* [Bugfix][Core] fix abort_seq_group and memory leak when n>1 ( vllm-project#14326 )\n\nSigned-off-by: courage17340 <courage17340@163.com>\n\n* [Core] Don't use cache during multi-modal profiling ( vllm-project#14336 )\n\n* [Doc] Fix date typo in README.md ( vllm-project#14366 )\n\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\n\n* [RLHF] use worker_extension_cls for compatibility with V0 and V1 ( vllm-project#14185 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Reinstate `best_of` for V0 ( vllm-project#14356 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Adding cpu inference with VXE ISA for s390x architecture ( vllm-project#12613 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\n\n* Add authors to license header. ( vllm-project#14371 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\n\n* Fix mla prefill context performance ( vllm-project#13897 )\n\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\n\n* [V1] Do not detokenize if sampling param detokenize is False ( vllm-project#14224 )\n\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Distributed] Add enable_expert_parallel arg ( vllm-project#14305 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build] Use uv python for docker rather than ppa:deadsnakes/ppa ( vllm-project#13569 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [CI] Disable spawn when running V1 Test ( vllm-project#14345 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Kernel] Add needs_fixed_stride_order tag to most GEMMs ( vllm-project#14306 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bugfix] Fix use_direct_call condition in FusedMoE layer for  ( vllm-project#14382 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bug] Fix Attention when ignored in by quant_method ( vllm-project#14313 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][Bugfix] Standardize quantized kv cache rejection for attention backends ( vllm-project#14221 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add nsight guide to profiling docs ( vllm-project#14298 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* cleanup boolean logic\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Hardware][TPU]Enable ragged paged attention kernel and resolve recompilation issue ( vllm-project#14310 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Doc] Fix a typo ( vllm-project#14385 )\n\n* [Bugfix] Correctly call `cudaProfilerStop` in benchmarks script ( vllm-project#14183 )\n\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\n\n* [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [FP8] Refactor apply_fp8_linear and apply_fp8_linear_generic into an object ( vllm-project#14390 )\n\nSigned-off-by: luka <luka@neuralmagic.com>\n\n* [BugFix] Illegal Memory Access in the blockwise cutlass fp8 GEMMs ( vllm-project#14396 )\n\n* [Bugfix] Fix JambaForCausalLM LoRA  ( vllm-project#14370 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Build] Add nightly wheel fallback when latest commit wheel unavailable ( vllm-project#14358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* OpenVINO: added CPU-like conditions ( vllm-project#14338 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [GH] Auto-apply multi-modality label to relevant PRs ( vllm-project#14402 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* correct wrong markdown syntax ( vllm-project#14414 )\n\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\n\n* [Bugfix] Further clean up LoRA test ( vllm-project#14422 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Clean up multi-modal processors ( vllm-project#14417 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Set default value of seed to None ( vllm-project#14274 )\n\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\n\n* [BUGFIX] Skip tokenization support for throughput benchmark ( vllm-project#12712 )\n\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\n\n* Fix missing `kv_caches` and `attn_metadata` in `OpenVINOCausalLM` ( vllm-project#14271 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Use the optimized block sizes after tuning the kernel. ( vllm-project#14329 )\n\n* [V1][Core] Support for Structured Outputs ( vllm-project#12388 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Doc] Update prefix_caching.md to match the example image ( vllm-project#14420 )\n\n* [Benchmarks] Make detokenization optional in benchmark scripts ( vllm-project#11697 )\n\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\n\n* comments\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Kernel] optimize performance of gptq marlin kernel when n is small ( vllm-project#14138 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [Misc] Add Phi4-MM example ( vllm-project#14343 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [v1] torch.compile integration explanation ( vllm-project#14437 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Eagerly remove finished requests from the batch ( vllm-project#14388 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V1][Metrics] Fix traceback with preemptions+LoRA ( vllm-project#14220 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Fix torch_xla which can't handle None seed introduced in vllm-project#14274 ( vllm-project#14459 )\n\nSigned-off-by: Yarong Mu <ymu@google.com>\n\n* [V1] Prompt logprobs + APC compatibility; prompt logprobs reqs cannot fill APC ( vllm-project#13949 )\n\n* [Bugfix][V1] Handle MLA in kv_cache_interface ( vllm-project#14462 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vllm-project#14471 )\n\n* [Bugfix][Disaggregated] Add a check in send_kv_caches_and_hidden_states and fix the reshape of the KVCache ( vllm-project#14369 )\n\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\n\n* [MISC][V1] Register process killing handler only in the main thread ( vllm-project#14380 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] add `extra_args` to `SamplingParams` ( vllm-project#13300 )\n\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\n\n* [CI/Build] refactor: set timezone of container to UTC ( vllm-project#12888 )\n\nSigned-off-by: Roger Meier <r.meier@siemens.com>\n\n* Default to `generation_config` from model ( vllm-project#12622 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc]add doc for Qwen models tool calling ( vllm-project#14478 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Doc] Added QwQ-32B to the supported models list in the reasoning outâ€¦ ( vllm-project#14479 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Bugfix] Make the deviceprofiler include LoRA memory. ( vllm-project#14469 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Add training doc signposting to TRL ( vllm-project#14439 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Build/BugFix] Fix hopper 12.8 build ( vllm-project#14354 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add RLHF document ( vllm-project#14482 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Use a fixed seed to avoid flaky tests ( vllm-project#14480 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] TPU - Add tensor parallel support via Ray ( vllm-project#13618 )\n\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\n\n* [VLM] Add TP support for Phi-4-MM ( vllm-project#14453 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] add `use_tqdm_on_load` to reduce logs ( vllm-project#14407 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [V1][Core] Fix memory issue with logits & sampling ( vllm-project#13776 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [benchmarks] Add option to use unique jsonschema for each request ( vllm-project#14457 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Don't run ruff at all on 3rd party libs ( vllm-project#14493 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Move requirements into their own directory ( vllm-project#12547 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] DeepSeek Accuracy ( vllm-project#14476 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [Bugfix] Fix profiling OOM and decouple encoder multimodal profiling ( vllm-project#14361 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Update CODEOWNERS for structured output ( vllm-project#14496 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Upgrade to Python 3.9 typing for additional directories ( vllm-project#14492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support bad_words in sampler ( vllm-project#13376 )\n\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* Revert \"[V1][Core] Fix memory issue with logits & sampling\" ( vllm-project#14504 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Attention] Default to FlashMLA backend for MLA ( vllm-project#14451 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [V1][TPU] Remove unnecessary padding for running on TPU. ( vllm-project#14467 )\n\n* [Feat] Support chunked prefill for LMCache connector ( vllm-project#14505 )\n\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\n\n* [Bugfix] Fix tqdm progress bar when SamplingParams.n > 1 ( vllm-project#12428 )\n\nSigned-off-by: Yuchen Yan <740987012@qq.com>\n\n* [Bugfix] Revert QKVCrossParallelLinear usage in Mllama to keep BNB quantization work ( vllm-project#14498 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] Fix the recompiling issue in logits processor after warmup ( vllm-project#14510 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Misc] Ensure out-of-tree quantization method recognize by cli args ( vllm-project#14328 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Bugfix] Wrong requirements path - rocm ( vllm-project#14527 )\n\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\n\n* [Feature] Consolidate performance benchmark datasets ( vllm-project#14036 )\n\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Add log information for handle_process_request. ( vllm-project#14130 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Docs] Mention `model_impl` arg when explaining Transformers fallback ( vllm-project#14552 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] support image embeds ( vllm-project#13955 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Kernel] Add more dtype support for GGUF kernels ( vllm-project#14043 )\n\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\n\n* [Doc] Update PaliGemma note to a warning ( vllm-project#14565 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* V1 rocm support ( #469 )\n\n* Initial commit for V1 successfull compilation\n\n* Small improvement for linear\n\n* Small improvement for linear\n\n* making use of forward_cuda for all except ROPE in llama\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* nightly_fixed_aiter_integration_final_20250305 README update ( #470 )\n\n* nightly_fixed_aiter_integration_final_20250305 README update (perf results only)\n\n* Update Docker Manifest git hash\n\n* Update Docker Manifest and added nightly_fixed_aiter_integration_final_20250305\n\n* some more updates\n\n* Update AITER section with example\n\n* Updated AITER command with larger batch size and model name\n\n* Fixing typo\n\n* Removed --max-model-len in AITER command\n\n* Updating AITER instructions\n\n* typo\n\n* Another typo\n\n* Whitespace\n\n* modifying whats new section\n\n* Another typo\n\n---------\n\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: pyc96 <pychen96@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\nSigned-off-by: courage17340 <courage17340@163.com>\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\nSigned-off-by: luka <luka@neuralmagic.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Yarong Mu <ymu@google.com>\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\nSigned-off-by: Roger Meier <r.meier@siemens.com>\nSigned-off-by: WangErXiao <863579016@qq.com>\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Yuchen Yan <740987012@qq.com>\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Qubitium-ModelCloud <qubitium@modelcloud.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: iefgnoix <isaacwxf23@gmail.com>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Zhanwen Chen <phil.zhanwen.chen@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: kushanam <42385577+kushanam@users.noreply.github.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: rainkert <93575312+rainkert@users.noreply.github.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: Congcong Chen <congcongchen@microsoft.com>\nCo-authored-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Iacopo Poli <iacopo@lighton.ai>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Zhe Zhang <zhz@apache.org>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: DaividFrank <49250948+DaividFrank@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Vincent <vincentzhongy+githubvincent4@gmail.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\nCo-authored-by: Serena <yangsijia.614@bytedance.com>\nCo-authored-by: pyc96 <pychen96@gmail.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Ce Gao <cegao@tensorchord.ai>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: kYLe <kylhuang@nvidia.com>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: Yanyi Liu <wolfsonliu@163.com>\nCo-authored-by: Irina Yuryeva <76484191+upayuryeva@users.noreply.github.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: courage17340 <courage17340@users.noreply.github.com>\nCo-authored-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\nCo-authored-by: Himanshu Jaju <hj@mistral.ai>\nCo-authored-by: Chengji Yao <chengjiyao@google.com>\nCo-authored-by: Daniel Li <dyli@google.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Peng Li <justdoit.pli@gmail.com>\nCo-authored-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: York-RDWang <103811994+York-RDWang@users.noreply.github.com>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: yarongmu-google <150371854+yarongmu-google@users.noreply.github.com>\nCo-authored-by: afeldman-nm <156691304+afeldman-nm@users.noreply.github.com>\nCo-authored-by: Mathis Felardos <mathis@mistral.ai>\nCo-authored-by: Aviv Keshet <akeshet@scaledcognition.com>\nCo-authored-by: Roger Meier <r.meier@siemens.com>\nCo-authored-by: Robin <863579016@qq.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-redhat@users.noreply.github.com>\nCo-authored-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Yuchen Yan <50619811+yanyc428@users.noreply.github.com>\nCo-authored-by: Martin Hoyer <mhoyer@redhat.com>\nCo-authored-by: Jennifer Zhao <JenZhao@users.noreply.github.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: Szymon OÅ¼Ã³g <58388001+SzymonOzog@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Mcirino1 <57415822+Mcirino1@users.noreply.github.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com> captainzmc pushed a commit\n        to captainzmc/vllm\n      that referenced\n      this pull request Mar 12, 2025 [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 ) â€¦ 7e6ed97 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> captainzmc pushed a commit\n        to captainzmc/vllm\n      that referenced\n      this pull request Mar 12, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vâ€¦ â€¦ f08a8d3 â€¦llm-project#14471 ) LucasWilkinson mentioned this pull request Mar 13, 2025 [Attention] Remove slow setattr in MLA #14769 Merged hmellor mentioned this pull request Apr 2, 2025 [Performance]: 0.8.1 vs 0.7.4dev122 R1 H20 performance benchmark testï¼Œ0.8.1 What is the reason for the 14% performance improvement(throughput tokens/s) #15881 Closed 1 task lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 ) â€¦ c1c2455 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vâ€¦ â€¦ 0492d83 â€¦llm-project#14471 )\n\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 ) â€¦ d407380 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vâ€¦ â€¦ 7e10bb8 â€¦llm-project#14471 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:10", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, throughput, req/s | SERVING: Frontend, Frontend, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:52:10", "models": ["deepseek-ai/DeepSeek-R1"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[Perf] Reduce MLA CPU overheads in V1 (#14384)", "commit_message": "[Perf] Reduce MLA CPU overheads in V1 (#14384)\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>", "commit_date": "2025-03-06T19:59:14-08:00", "files_changed": ["vllm/model_executor/layers/rotary_embedding.py", "vllm/v1/attention/backends/mla/common.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 3, "num_edited_lines": 24, "num_non_test_edited_lines": 24, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/rotary_embedding.py b/vllm/model_executor/layers/rotary_embedding.py\nindex 64c2dac52..48cdebee9 100644\n--- a/vllm/model_executor/layers/rotary_embedding.py\n+++ b/vllm/model_executor/layers/rotary_embedding.py\n@@ -161,8 +161,13 @@ class RotaryEmbedding(CustomOp):\n     ) -> Tuple[torch.Tensor, torch.Tensor]:\n         from vllm import _custom_ops as ops\n \n-        self.cos_sin_cache = self.cos_sin_cache.to(query.device,\n-                                                   dtype=query.dtype)\n+        # __setattr__ in nn.Module (called by `self.cos_sin_cache = ...`)\n+        # is expensive, so avoid calling it if possible\n+        if self.cos_sin_cache.device != query.device or \\\n+            self.cos_sin_cache.dtype != query.dtype:\n+            self.cos_sin_cache = self.cos_sin_cache.to(query.device,\n+                                                       dtype=query.dtype)\n+\n         # ops.rotary_embedding()/batched_rotary_embedding()\n         # are in-place operations that update the query and key tensors.\n         if offsets is not None:\ndiff --git a/vllm/v1/attention/backends/mla/common.py b/vllm/v1/attention/backends/mla/common.py\nindex 0b55854de..5b9a4b5ca 100644\n--- a/vllm/v1/attention/backends/mla/common.py\n+++ b/vllm/v1/attention/backends/mla/common.py\n@@ -222,8 +222,8 @@ from vllm.model_executor.layers.quantization.utils.fp8_utils import (\n     apply_fp8_linear_generic, current_platform_fp8_dtype, is_fp8)\n from vllm.model_executor.layers.quantization.utils.quant_utils import (\n     scaled_quantize)\n-from vllm.model_executor.layers.rotary_embedding import (\n-    DeepseekScalingRotaryEmbedding, RotaryEmbedding)\n+from vllm.model_executor.layers.rotary_embedding import RotaryEmbedding\n+from vllm.platforms import current_platform\n from vllm.utils import cdiv, round_down\n \n try:\n@@ -627,8 +627,15 @@ class MLACommonImpl(MLAAttentionImpl[M], Generic[M]):\n         self.v_head_dim = v_head_dim\n \n         self.rotary_emb = rotary_emb\n-        self.use_yarn_rope = isinstance(rotary_emb,\n-                                        DeepseekScalingRotaryEmbedding)\n+\n+        if current_platform.is_cuda():\n+            # Hack for V1 for now to avoid torch library overhead (since we are\n+            # already inside an attention custom op), pull out the forward\n+            # method from the rotary embedding and call it directly (and avoid\n+            # calling forward_native, when we can call forward_cuda)\n+            # TODO(lucas): we should probably find a cleaner way to do this\n+            self.rotary_emb = rotary_emb.forward_cuda\n+\n         self.q_proj = q_proj\n         self.kv_b_proj = kv_b_proj\n         self.o_proj = o_proj", "apis": ["vllm.model_executor.layers.rotary_embedding.RotaryEmbedding.forward_cuda", "vllm.v1.attention.backends.mla.common.MLACommonImpl"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/rotary_embedding.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/flashmla.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/flashmla.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/flashmla.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies two non-test, source code files. In the first file, it introduces a conditional check to avoid an expensive __setattr__ call, reducing overhead by not unnecessarily transferring the tensor. In the second file, the commit selectively changes the behavior for CUDA devices by directly calling a custom forward method (forward_cuda) to bypass torch library overhead, which aims to reduce CPU overhead in the context of MLA attention. Both changes are non-trivial and aim to improve performance without altering functionalities, and are not mere bug fixes, refactoring, or new feature additions. Overall, the commit meets criteria for performance optimization on CPU/testable without solely relying on GPU-specific work.", "llm_api_reason": "In this commit the author makes two performanceâ€related changes. In the rotary embedding module, they add a conditional check to avoid unnecessarily calling nn.Moduleâ€™s expensive __setattr__ (i.e. calling .to()) on the cos_sin_cache if it is already on the correct device and dtype. In the V1 MLA attention backend, they remove the yarn rope check and insteadâ€”when running on CUDAâ€”replace the stored rotary embedding with its forward_cuda method. This change allows the attention implementation to call the rotary embeddingâ€™s CUDA implementation directly (thus reducing CPU overhead) instead of routing through a higher-level python API."}
{"commit_hash": "9f1710f1ace3535920c0bb6d4cc329c36289080e", "pr_url": "https://github.com/vllm-project/vllm/pull/13897", "pr_date": "2025-03-06", "timeline_text": "Copy link Contributor ZhongYingMatrix commented Feb 26, 2025 kv_c_normed unsqeezed leads to the following kv_b_proj slowed down. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link github-actions bot commented Feb 26, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ZhongYingMatrix force-pushed the fix_mla_prefill_context branch\n    from 6d182b2 to 6dbd7d6 Compare February 26, 2025 13:21 Fix mla prefill context performance â€¦ 6aa754e Signed-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com> ZhongYingMatrix force-pushed the fix_mla_prefill_context branch\n    from 6dbd7d6 to 6aa754e Compare March 6, 2025 09:03 ZhongYingMatrix requested review from WoosukKwon , robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners March 6, 2025 09:03 mergify bot added\n  the v1 label Mar 6, 2025 Copy link Contributor Author ZhongYingMatrix commented Mar 6, 2025 @LucasWilkinson Hi, would u please review this PR? Some shape printed In forward\nk_c_normed.shape: torch.Size([2048, 512])\nk_pe.shape: torch.Size([2048, 1, 64])\nIn _forward_prefill\nq.shape: torch.Size([2048, 16, 192])\nkv_c_normed.shape: torch.Size([2048, 512])\nk_pe.shape: torch.Size([2048, 1, 64])\nIn _compute_prefill_context\nkv_c_normed.shape: torch.Size([2048, 1, 512])     # wrongly batched matrix-vector mul\nk_pe.shape: torch.Size([2048, 1, 64]) time compare on DeepSeek-V2-Lite-Chat with 28k input_len and 64 output_len. before\nfirst_token=6.392493963241577, total=7.078949689865112\n\nafter\nfirst_token=1.7816479206085205, total=2.4884746074676514 ðŸ‘ 1 neiltian-tencent reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . LucasWilkinson approved these changes Mar 6, 2025 View reviewed changes Copy link Collaborator LucasWilkinson left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Nice find! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions LucasWilkinson enabled auto-merge (squash) March 6, 2025 10:21 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 6, 2025 auto-merge was automatically disabled March 6, 2025 11:36 Head branch was pushed to by a user without write access ZhongYingMatrix force-pushed the fix_mla_prefill_context branch\n      2 times, most recently\n    from 434cbae to 6aa754e Compare March 6, 2025 11:45 LucasWilkinson enabled auto-merge (squash) March 6, 2025 11:59 Copy link Contributor Author ZhongYingMatrix commented Mar 6, 2025 @LucasWilkinson Hi, any clue of failed checks? I suppose the minor changes do not affect the tests. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator LucasWilkinson commented Mar 6, 2025 @LucasWilkinson Hi, any clue of failed checks? I suppose the minor changes do not affect the tests. The CI can be flaky, retrying. If that doesnt work we can ask for a force merge ðŸ‘ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . simon-mo disabled auto-merge March 6, 2025 17:35 Hide details View details simon-mo merged commit 9f1710f into vllm-project : main Mar 6, 2025 52 of 54 checks passed Uh oh! There was an error while loading. Please reload this page . Alexei-V-Ivanov-AMD added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Mar 11, 2025 Merging in the latest merge from vllm-project to ROCm ( #472 ) â€¦ a699a11 * Fix `head_dim` not existing in all model configs (Transformers backend) ( vllm-project#14141 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V0][Metrics] Remove unimplemented `vllm:tokens_total` ( vllm-project#14134 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V0][Metrics] Deprecate some KV/prefix cache metrics ( vllm-project#14136 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1] Simplify stats logging ( vllm-project#14082 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [WIP][[V1][Metrics] Implement max_num_generation_tokens,  request_params_n, and request_params_max_tokens metrics ( vllm-project#14055 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Allow shared_experts skip quantization for DeepSeekV2/V3 ( vllm-project#14100 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add GPTQModel ( vllm-project#14056 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Add comments to the new ragged paged attention Pallas kernel ( vllm-project#14155 )\n\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\n\n* [Model] Add support for GraniteMoeShared models ( vllm-project#13313 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [core] moe fp8 block quant tuning support ( vllm-project#14068 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Remove lru_cache in NvmlCudaPlatform ( vllm-project#14156 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] Pass all driver env vars to ray workers unless excluded ( vllm-project#14099 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use math.prod instead of np.prod for trivial ops ( vllm-project#14142 )\n\n* Fix benchmark_moe.py tuning for CUDA devices ( vllm-project#14164 )\n\n* [platform] add debug logging during inferring the device type ( vllm-project#14195 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [sleep mode] error out with expandable_segments ( vllm-project#14189 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [doc] add \"Failed to infer device type\" to faq ( vllm-project#14200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Restrict MacOS CPU detection ( vllm-project#14210 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][BugFix] Fix remaining sync engine client shutdown errors/hangs ( vllm-project#13869 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V0][Metrics] Deprecate some questionable request time metrics ( vllm-project#14135 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][Molmo] Fix get_multimodal_embeddings() in molmo.py ( vllm-project#14161 )\n\n* add cutlass support for blackwell fp8 gemm ( vllm-project#13798 )\n\n* [TPU][Profiler] Support start_profile/stop_profile in TPU worker ( vllm-project#13988 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* Fix performance when `--generation-config` is not `None` ( vllm-project#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] Do `prompt_logprobs` clamping for chat as well as completions ( vllm-project#14225 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Update Dockerfile dependency image ( vllm-project#14215 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1][Metrics] Add design doc ( vllm-project#12745 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Security] Serialize using safetensors instead of pickle in Mooncake Pipe ( vllm-project#14228 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Clean up unused padding_idx variables across many model definitions ( vllm-project#13240 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [ROCm] Disable a few more kernel tests that are broken on ROCm ( vllm-project#14145 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [V1][TPU] TPU multimodal model support for ragged attention ( vllm-project#14158 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [misc] announce china meetup ( vllm-project#14248 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Moved numba from common requirements to cuda/rocm specific requirements ( vllm-project#14199 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* Disable GPTQ AllSpark kernels for CUDA Compiler < 12.0 ( vllm-project#14157 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Bugfix] Fix gptq_marlin for deepseek-v3 ( vllm-project#13750 )\n\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\n\n* [V1][Bugfix] Do not reset prefix caching metrics ( vllm-project#14235 )\n\n* [Model] New model support for Phi-4-multimodal-instruct ( vllm-project#14119 )\n\n* [V1] EP/TP MoE + DP Attention ( vllm-project#13931 )\n\n* [platforms] improve rocm debugging info ( vllm-project#14257 )\n\n* Temporarily disable test_awq_gemm_opcheck ( vllm-project#14251 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Frontend] Allow return_tokens_as_token_ids to be passed as a request param ( vllm-project#14066 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\n\n* [Misc][V1] Avoid using `envs.VLLM_USE_V1` in mm processing ( vllm-project#14256 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][V1] Fix allowed_token_ids for v1 Sampler ( vllm-project#14169 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Update nginx guide: remove privileged from vllm container run and add target GPU ID ( vllm-project#14217 )\n\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\n\n* [Doc] [3/N] Refer code examples for common cases in dev multimodal processor ( vllm-project#14278 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Small update for external_launcher backend docs ( vllm-project#14288 )\n\n* [V1][Frontend] Add Testing For V1 Runtime Parameters ( vllm-project#14159 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [LoRA] Remove linear hack outside transformers backend ( vllm-project#14177 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Add Qwen2MoeForCausalLM moe tuning support  ( vllm-project#14276 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* prefix_caching.md: Fixed typo ( vllm-project#14293 )\n\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\n\n* [Bugfix] Fix broken vision language example ( vllm-project#14292 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Docs] Add Meta Slides ( vllm-project#14297 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [V1][Minor] Remove obsolete FIXME comment ( vllm-project#14304 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* Deprecate `best_of` Sampling Parameter in anticipation for vLLM V1 ( vllm-project#13997 )\n\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][BugFix] Fix for mixed top_k batch ( vllm-project#14301 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\n\n* [misc] Add FlashMLA as a new option of VLLM_ATTENTION_BACKEND env ( vllm-project#14267 )\n\n* [V1][Easy] Add empty allowed_token_ids in the v1 sampler test ( vllm-project#14308 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* init\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Bugfix] Fix DeepSeek MTP crash when using TP1ModelRunner with CUDA graph due to shape mismatch ( vllm-project#14237 )\n\nSigned-off-by: pyc96 <pychen96@gmail.com>\n\n* [Bugfix] Remove num_tokens_across_dp ( vllm-project#14302 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [BugFix] Fix prefix caching V0 MLA ( vllm-project#14255 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\n\n* [CI/Build] Use spawn multiprocessing mode for V1 test pipeline ( vllm-project#14243 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Add benchmark for DeepGEMM and vLLM Block FP8 Dense GEMM ( vllm-project#13917 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Build] Add UV_HTTP_TIMEOUT to avoid timeout during installation ( vllm-project#13850 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] MLA + V1, illegal memory access and accuracy issues ( vllm-project#14253 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [misc] Mention `ray list nodes` command to troubleshoot ray issues ( vllm-project#14318 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [Bugfix][Structured Output] Support outlines engine with reasoning outputs for DeepSeek R1 ( vllm-project#14114 )\n\n* [V1] LoRA - Enable more V1 tests ( vllm-project#14315 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix][CI] ALiBi test case in xformers multi_query_kv_attention ( vllm-project#11301 )\n\n* [Hardware] Update the flash attn tag to support Blackwell ( vllm-project#14244 )\n\n* [Model] Update Paligemma multimodal processing with PromptUpdate  ( vllm-project#14015 )\n\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1][VLM][Pixtral-HF] Support Pixtral-HF on V1 ( vllm-project#14275 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Core] Optimizing cross-attention `QKVParallelLinear` computation ( vllm-project#12325 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\n\n* [Frontend][Docs] Transcription API streaming ( vllm-project#13301 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Doc] Update reasoning with stream example to use OpenAI library ( vllm-project#14077 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Doc] Correct beam_search using in generative_models.md ( vllm-project#14363 )\n\n* [Kernel] [V1] Improved performance for V1 Triton (ROCm) backend  ( vllm-project#14152 )\n\n* [Bugfix][Core] fix abort_seq_group and memory leak when n>1 ( vllm-project#14326 )\n\nSigned-off-by: courage17340 <courage17340@163.com>\n\n* [Core] Don't use cache during multi-modal profiling ( vllm-project#14336 )\n\n* [Doc] Fix date typo in README.md ( vllm-project#14366 )\n\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\n\n* [RLHF] use worker_extension_cls for compatibility with V0 and V1 ( vllm-project#14185 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Reinstate `best_of` for V0 ( vllm-project#14356 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Adding cpu inference with VXE ISA for s390x architecture ( vllm-project#12613 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\n\n* Add authors to license header. ( vllm-project#14371 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\n\n* Fix mla prefill context performance ( vllm-project#13897 )\n\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\n\n* [V1] Do not detokenize if sampling param detokenize is False ( vllm-project#14224 )\n\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Distributed] Add enable_expert_parallel arg ( vllm-project#14305 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build] Use uv python for docker rather than ppa:deadsnakes/ppa ( vllm-project#13569 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [CI] Disable spawn when running V1 Test ( vllm-project#14345 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Kernel] Add needs_fixed_stride_order tag to most GEMMs ( vllm-project#14306 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bugfix] Fix use_direct_call condition in FusedMoE layer for  ( vllm-project#14382 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bug] Fix Attention when ignored in by quant_method ( vllm-project#14313 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][Bugfix] Standardize quantized kv cache rejection for attention backends ( vllm-project#14221 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add nsight guide to profiling docs ( vllm-project#14298 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* cleanup boolean logic\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Hardware][TPU]Enable ragged paged attention kernel and resolve recompilation issue ( vllm-project#14310 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Doc] Fix a typo ( vllm-project#14385 )\n\n* [Bugfix] Correctly call `cudaProfilerStop` in benchmarks script ( vllm-project#14183 )\n\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\n\n* [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [FP8] Refactor apply_fp8_linear and apply_fp8_linear_generic into an object ( vllm-project#14390 )\n\nSigned-off-by: luka <luka@neuralmagic.com>\n\n* [BugFix] Illegal Memory Access in the blockwise cutlass fp8 GEMMs ( vllm-project#14396 )\n\n* [Bugfix] Fix JambaForCausalLM LoRA  ( vllm-project#14370 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Build] Add nightly wheel fallback when latest commit wheel unavailable ( vllm-project#14358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* OpenVINO: added CPU-like conditions ( vllm-project#14338 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [GH] Auto-apply multi-modality label to relevant PRs ( vllm-project#14402 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* correct wrong markdown syntax ( vllm-project#14414 )\n\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\n\n* [Bugfix] Further clean up LoRA test ( vllm-project#14422 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Clean up multi-modal processors ( vllm-project#14417 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Set default value of seed to None ( vllm-project#14274 )\n\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\n\n* [BUGFIX] Skip tokenization support for throughput benchmark ( vllm-project#12712 )\n\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\n\n* Fix missing `kv_caches` and `attn_metadata` in `OpenVINOCausalLM` ( vllm-project#14271 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Use the optimized block sizes after tuning the kernel. ( vllm-project#14329 )\n\n* [V1][Core] Support for Structured Outputs ( vllm-project#12388 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Doc] Update prefix_caching.md to match the example image ( vllm-project#14420 )\n\n* [Benchmarks] Make detokenization optional in benchmark scripts ( vllm-project#11697 )\n\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\n\n* comments\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Kernel] optimize performance of gptq marlin kernel when n is small ( vllm-project#14138 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [Misc] Add Phi4-MM example ( vllm-project#14343 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [v1] torch.compile integration explanation ( vllm-project#14437 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Eagerly remove finished requests from the batch ( vllm-project#14388 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V1][Metrics] Fix traceback with preemptions+LoRA ( vllm-project#14220 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Fix torch_xla which can't handle None seed introduced in vllm-project#14274 ( vllm-project#14459 )\n\nSigned-off-by: Yarong Mu <ymu@google.com>\n\n* [V1] Prompt logprobs + APC compatibility; prompt logprobs reqs cannot fill APC ( vllm-project#13949 )\n\n* [Bugfix][V1] Handle MLA in kv_cache_interface ( vllm-project#14462 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vllm-project#14471 )\n\n* [Bugfix][Disaggregated] Add a check in send_kv_caches_and_hidden_states and fix the reshape of the KVCache ( vllm-project#14369 )\n\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\n\n* [MISC][V1] Register process killing handler only in the main thread ( vllm-project#14380 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] add `extra_args` to `SamplingParams` ( vllm-project#13300 )\n\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\n\n* [CI/Build] refactor: set timezone of container to UTC ( vllm-project#12888 )\n\nSigned-off-by: Roger Meier <r.meier@siemens.com>\n\n* Default to `generation_config` from model ( vllm-project#12622 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc]add doc for Qwen models tool calling ( vllm-project#14478 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Doc] Added QwQ-32B to the supported models list in the reasoning outâ€¦ ( vllm-project#14479 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Bugfix] Make the deviceprofiler include LoRA memory. ( vllm-project#14469 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Add training doc signposting to TRL ( vllm-project#14439 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Build/BugFix] Fix hopper 12.8 build ( vllm-project#14354 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add RLHF document ( vllm-project#14482 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Use a fixed seed to avoid flaky tests ( vllm-project#14480 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] TPU - Add tensor parallel support via Ray ( vllm-project#13618 )\n\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\n\n* [VLM] Add TP support for Phi-4-MM ( vllm-project#14453 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] add `use_tqdm_on_load` to reduce logs ( vllm-project#14407 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [V1][Core] Fix memory issue with logits & sampling ( vllm-project#13776 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [benchmarks] Add option to use unique jsonschema for each request ( vllm-project#14457 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Don't run ruff at all on 3rd party libs ( vllm-project#14493 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Move requirements into their own directory ( vllm-project#12547 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] DeepSeek Accuracy ( vllm-project#14476 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [Bugfix] Fix profiling OOM and decouple encoder multimodal profiling ( vllm-project#14361 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Update CODEOWNERS for structured output ( vllm-project#14496 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Upgrade to Python 3.9 typing for additional directories ( vllm-project#14492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support bad_words in sampler ( vllm-project#13376 )\n\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* Revert \"[V1][Core] Fix memory issue with logits & sampling\" ( vllm-project#14504 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Attention] Default to FlashMLA backend for MLA ( vllm-project#14451 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [V1][TPU] Remove unnecessary padding for running on TPU. ( vllm-project#14467 )\n\n* [Feat] Support chunked prefill for LMCache connector ( vllm-project#14505 )\n\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\n\n* [Bugfix] Fix tqdm progress bar when SamplingParams.n > 1 ( vllm-project#12428 )\n\nSigned-off-by: Yuchen Yan <740987012@qq.com>\n\n* [Bugfix] Revert QKVCrossParallelLinear usage in Mllama to keep BNB quantization work ( vllm-project#14498 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] Fix the recompiling issue in logits processor after warmup ( vllm-project#14510 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Misc] Ensure out-of-tree quantization method recognize by cli args ( vllm-project#14328 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Bugfix] Wrong requirements path - rocm ( vllm-project#14527 )\n\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\n\n* [Feature] Consolidate performance benchmark datasets ( vllm-project#14036 )\n\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Add log information for handle_process_request. ( vllm-project#14130 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Docs] Mention `model_impl` arg when explaining Transformers fallback ( vllm-project#14552 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] support image embeds ( vllm-project#13955 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Kernel] Add more dtype support for GGUF kernels ( vllm-project#14043 )\n\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\n\n* [Doc] Update PaliGemma note to a warning ( vllm-project#14565 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* V1 rocm support ( #469 )\n\n* Initial commit for V1 successfull compilation\n\n* Small improvement for linear\n\n* Small improvement for linear\n\n* making use of forward_cuda for all except ROPE in llama\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* nightly_fixed_aiter_integration_final_20250305 README update ( #470 )\n\n* nightly_fixed_aiter_integration_final_20250305 README update (perf results only)\n\n* Update Docker Manifest git hash\n\n* Update Docker Manifest and added nightly_fixed_aiter_integration_final_20250305\n\n* some more updates\n\n* Update AITER section with example\n\n* Updated AITER command with larger batch size and model name\n\n* Fixing typo\n\n* Removed --max-model-len in AITER command\n\n* Updating AITER instructions\n\n* typo\n\n* Another typo\n\n* Whitespace\n\n* modifying whats new section\n\n* Another typo\n\n---------\n\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: pyc96 <pychen96@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\nSigned-off-by: courage17340 <courage17340@163.com>\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\nSigned-off-by: luka <luka@neuralmagic.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Yarong Mu <ymu@google.com>\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\nSigned-off-by: Roger Meier <r.meier@siemens.com>\nSigned-off-by: WangErXiao <863579016@qq.com>\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Yuchen Yan <740987012@qq.com>\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Qubitium-ModelCloud <qubitium@modelcloud.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: iefgnoix <isaacwxf23@gmail.com>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Zhanwen Chen <phil.zhanwen.chen@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: kushanam <42385577+kushanam@users.noreply.github.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: rainkert <93575312+rainkert@users.noreply.github.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: Congcong Chen <congcongchen@microsoft.com>\nCo-authored-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Iacopo Poli <iacopo@lighton.ai>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Zhe Zhang <zhz@apache.org>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: DaividFrank <49250948+DaividFrank@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Vincent <vincentzhongy+githubvincent4@gmail.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\nCo-authored-by: Serena <yangsijia.614@bytedance.com>\nCo-authored-by: pyc96 <pychen96@gmail.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Ce Gao <cegao@tensorchord.ai>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: kYLe <kylhuang@nvidia.com>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: Yanyi Liu <wolfsonliu@163.com>\nCo-authored-by: Irina Yuryeva <76484191+upayuryeva@users.noreply.github.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: courage17340 <courage17340@users.noreply.github.com>\nCo-authored-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\nCo-authored-by: Himanshu Jaju <hj@mistral.ai>\nCo-authored-by: Chengji Yao <chengjiyao@google.com>\nCo-authored-by: Daniel Li <dyli@google.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Peng Li <justdoit.pli@gmail.com>\nCo-authored-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: York-RDWang <103811994+York-RDWang@users.noreply.github.com>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: yarongmu-google <150371854+yarongmu-google@users.noreply.github.com>\nCo-authored-by: afeldman-nm <156691304+afeldman-nm@users.noreply.github.com>\nCo-authored-by: Mathis Felardos <mathis@mistral.ai>\nCo-authored-by: Aviv Keshet <akeshet@scaledcognition.com>\nCo-authored-by: Roger Meier <r.meier@siemens.com>\nCo-authored-by: Robin <863579016@qq.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-redhat@users.noreply.github.com>\nCo-authored-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Yuchen Yan <50619811+yanyc428@users.noreply.github.com>\nCo-authored-by: Martin Hoyer <mhoyer@redhat.com>\nCo-authored-by: Jennifer Zhao <JenZhao@users.noreply.github.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: Szymon OÅ¼Ã³g <58388001+SzymonOzog@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Mcirino1 <57415822+Mcirino1@users.noreply.github.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com> captainzmc pushed a commit\n        to captainzmc/vllm\n      that referenced\n      this pull request Mar 12, 2025 Fix mla prefill context performance ( vllm-project#13897 ) â€¦ 21fa74b Signed-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 Fix mla prefill context performance ( vllm-project#13897 ) â€¦ 45a9d2c Signed-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 Fix mla prefill context performance ( vllm-project#13897 ) â€¦ 6ac6947 Signed-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:14", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: throughput, improvement, improvement | SERVING: Frontend, Frontend, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:52:14", "models": ["deepseek-ai/DeepSeek-V2-Lite-Chat"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-V2-Lite-Chat --tasks gsm8k --num_fewshot 5"], "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-V2-Lite-Chat --input-len 28000 --output-len 64", "commit_subject": "Fix mla prefill context performance (#13897)", "commit_message": "Fix mla prefill context performance (#13897)\n\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>", "commit_date": "2025-03-06T09:35:49-08:00", "files_changed": ["vllm/attention/backends/mla/common.py", "vllm/v1/attention/backends/mla/common.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 2, "only_test_files": 0, "only_non_test_files": 1, "num_files": 2, "num_hunks": 2, "num_edited_lines": 4, "num_non_test_edited_lines": 4, "commit_year": 2025}, "diff_text": "diff --git a/vllm/attention/backends/mla/common.py b/vllm/attention/backends/mla/common.py\nindex 8184b0732..109e8496f 100644\n--- a/vllm/attention/backends/mla/common.py\n+++ b/vllm/attention/backends/mla/common.py\n@@ -1308,7 +1308,7 @@ class MLACommonImpl(MLAAttentionImpl[T], Generic[T]):\n             )\n \n             kv_c_normed = workspace[:toks]\\\n-                [..., :self.kv_lora_rank].unsqueeze(1)\n+                [..., :self.kv_lora_rank]\n             k_pe = workspace[:toks]\\\n                 [..., self.kv_lora_rank:].unsqueeze(1)\n \ndiff --git a/vllm/v1/attention/backends/mla/common.py b/vllm/v1/attention/backends/mla/common.py\nindex c98262eea..0b55854de 100644\n--- a/vllm/v1/attention/backends/mla/common.py\n+++ b/vllm/v1/attention/backends/mla/common.py\n@@ -874,7 +874,7 @@ class MLACommonImpl(MLAAttentionImpl[M], Generic[M]):\n             )\n \n             kv_c_normed = workspace[:toks]\\\n-                [..., :self.kv_lora_rank].unsqueeze(1)\n+                [..., :self.kv_lora_rank]\n             k_pe = workspace[:toks]\\\n                 [..., self.kv_lora_rank:].unsqueeze(1)", "apis": ["MLACommonImpl.forward"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/core/block/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/attention/backends/mla/common.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/ops/prefix_prefill.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies actual source code files (not test files) in the \"vllm\" repository and changes tensor slicing logic in two separate files. Instead of unsqueezing a dimension for kv_c_normed, it now directly slices out the needed part, which likely eliminates an unnecessary operation and thereby improves performance. The commit message clearly states it is a performance fix (\"Fix mla prefill context performance\") and is not merely a refactoring, bug fix, or new feature. The changed parts are in high level API functions related to attention mechanisms whose performance is critical. The changes are CPU-related and generalizable. Therefore, the commit satisfies all conditions for a performance-related optimization commit.", "llm_api_reason": "The commit removes an unnecessary unsqueeze() call when slicing the workspace to get the â€œkv_c_normedâ€ tensor. This change occurs in the MLA prefill logic in both the current and v1 branches (in the files under vllm/attention/backends/mla/common.py and vllm/v1/attention/backends/mla/common.py). In effect, the forward pass of the MLA attention implementation, which uses the computed â€œkv_c_normedâ€, is modified for better performance."}
{"commit_hash": "9badee53decb3d432dc805336abfb0eb81dfb48f", "pr_url": "https://github.com/vllm-project/vllm/pull/14223", "pr_date": "2025-03-04", "timeline_text": "Copy link Member hmellor commented Mar 4, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Adds self.default_sampling_params to: OpenAIServingChat OpenAIServingCompletion OpenAIServingTranscription LLM As you can see from the benchmarks below, the performance difference is huge: vllm serve meta-llama/Llama-3.2-1B-Instruct --disable-log-requests --generation-config auto\n\npython benchmarks/benchmark_serving.py --model meta-llama/Llama-3.2-1B-Instruct --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json Before: ============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  149.29    \nTotal input tokens:                      215196    \nTotal generated tokens:                  179873    \nRequest throughput (req/s):              6.70      \nOutput token throughput (tok/s):         1204.82   \nTotal Token throughput (tok/s):          2646.24   \n---------------Time to First Token----------------\nMean TTFT (ms):                          124792.06 \nMedian TTFT (ms):                        123725.39 \nP99 TTFT (ms):                           138387.36 \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          40.52     \nMedian TPOT (ms):                        40.52     \nP99 TPOT (ms):                           67.62     \n---------------Inter-token Latency----------------\nMean ITL (ms):                           36.56     \nMedian ITL (ms):                         37.74     \nP99 ITL (ms):                            72.37     \n================================================== After: ============ Serving Benchmark Result ============\nSuccessful requests:                     1000      \nBenchmark duration (s):                  34.24     \nTotal input tokens:                      215196    \nTotal generated tokens:                  178861    \nRequest throughput (req/s):              29.21     \nOutput token throughput (tok/s):         5224.41   \nTotal Token throughput (tok/s):          11510.15  \n---------------Time to First Token----------------\nMean TTFT (ms):                          8481.82   \nMedian TTFT (ms):                        7455.52   \nP99 TTFT (ms):                           21150.72  \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          37.85     \nMedian TPOT (ms):                        37.10     \nP99 TPOT (ms):                           51.13     \n---------------Inter-token Latency----------------\nMean ITL (ms):                           35.43     \nMedian ITL (ms):                         35.88     \nP99 ITL (ms):                            72.53     \n================================================== Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions hmellor added 2 commits March 4, 2025 17:21 Prevent reads from disk at runtime when --generation-config auto isâ€¦ â€¦ accf38d â€¦ set\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com> Don't create a footgun â€¦ e3cd61e Signed-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com> Copy link github-actions bot commented Mar 4, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the frontend label Mar 4, 2025 mgoin requested review from njhill and robertgshaw2-redhat March 4, 2025 16:49 mgoin added\n  the performance Performance-related issues label Mar 4, 2025 mgoin changed the title Fix generation config arg Fix performance of --generation-config auto Mar 4, 2025 mgoin approved these changes Mar 4, 2025 View reviewed changes Copy link Member mgoin left a comment â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good catch, this is critical to fix as try_get_generation_config could be called for each request ðŸ˜“ Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Mar 4, 2025 hmellor changed the title Fix performance of --generation-config auto Fix performance of --generation-config is not None Mar 4, 2025 Copy link Member Author hmellor commented Mar 4, 2025 Thanks for updating the title, technically --generation-config could be a file path (which would also cause this performance problem) ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Make mypy happy â€¦ 71e1cf1 Signed-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com> hmellor changed the title Fix performance of --generation-config is not None Fix performance when --generation-config is not None Mar 4, 2025 DarkLight1337 approved these changes Mar 4, 2025 View reviewed changes hmellor mentioned this pull request Mar 4, 2025 Default to generation_config from model #12622 Merged Hide details View details hmellor merged commit 9badee5 into vllm-project : main Mar 4, 2025 37 checks passed Uh oh! There was an error while loading. Please reload this page . hmellor deleted the fix-generation-config-arg branch March 4, 2025 19:59 Copy link Contributor yansh97 commented Mar 5, 2025 Very nice fix!!! Since \"--generation-config was added\", I have noticed a performance improvement when set to None, but a regression when set to \"auto\". I thought the reason is some changes in the sampling code. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Alexei-V-Ivanov-AMD added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Mar 11, 2025 Merging in the latest merge from vllm-project to ROCm ( #472 ) â€¦ a699a11 * Fix `head_dim` not existing in all model configs (Transformers backend) ( vllm-project#14141 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V0][Metrics] Remove unimplemented `vllm:tokens_total` ( vllm-project#14134 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V0][Metrics] Deprecate some KV/prefix cache metrics ( vllm-project#14136 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1] Simplify stats logging ( vllm-project#14082 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [WIP][[V1][Metrics] Implement max_num_generation_tokens,  request_params_n, and request_params_max_tokens metrics ( vllm-project#14055 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Allow shared_experts skip quantization for DeepSeekV2/V3 ( vllm-project#14100 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add GPTQModel ( vllm-project#14056 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Add comments to the new ragged paged attention Pallas kernel ( vllm-project#14155 )\n\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\n\n* [Model] Add support for GraniteMoeShared models ( vllm-project#13313 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [core] moe fp8 block quant tuning support ( vllm-project#14068 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Remove lru_cache in NvmlCudaPlatform ( vllm-project#14156 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] Pass all driver env vars to ray workers unless excluded ( vllm-project#14099 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use math.prod instead of np.prod for trivial ops ( vllm-project#14142 )\n\n* Fix benchmark_moe.py tuning for CUDA devices ( vllm-project#14164 )\n\n* [platform] add debug logging during inferring the device type ( vllm-project#14195 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [sleep mode] error out with expandable_segments ( vllm-project#14189 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [doc] add \"Failed to infer device type\" to faq ( vllm-project#14200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Restrict MacOS CPU detection ( vllm-project#14210 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][BugFix] Fix remaining sync engine client shutdown errors/hangs ( vllm-project#13869 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V0][Metrics] Deprecate some questionable request time metrics ( vllm-project#14135 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][Molmo] Fix get_multimodal_embeddings() in molmo.py ( vllm-project#14161 )\n\n* add cutlass support for blackwell fp8 gemm ( vllm-project#13798 )\n\n* [TPU][Profiler] Support start_profile/stop_profile in TPU worker ( vllm-project#13988 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* Fix performance when `--generation-config` is not `None` ( vllm-project#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] Do `prompt_logprobs` clamping for chat as well as completions ( vllm-project#14225 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Update Dockerfile dependency image ( vllm-project#14215 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1][Metrics] Add design doc ( vllm-project#12745 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Security] Serialize using safetensors instead of pickle in Mooncake Pipe ( vllm-project#14228 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Clean up unused padding_idx variables across many model definitions ( vllm-project#13240 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [ROCm] Disable a few more kernel tests that are broken on ROCm ( vllm-project#14145 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [V1][TPU] TPU multimodal model support for ragged attention ( vllm-project#14158 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [misc] announce china meetup ( vllm-project#14248 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Moved numba from common requirements to cuda/rocm specific requirements ( vllm-project#14199 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* Disable GPTQ AllSpark kernels for CUDA Compiler < 12.0 ( vllm-project#14157 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Bugfix] Fix gptq_marlin for deepseek-v3 ( vllm-project#13750 )\n\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\n\n* [V1][Bugfix] Do not reset prefix caching metrics ( vllm-project#14235 )\n\n* [Model] New model support for Phi-4-multimodal-instruct ( vllm-project#14119 )\n\n* [V1] EP/TP MoE + DP Attention ( vllm-project#13931 )\n\n* [platforms] improve rocm debugging info ( vllm-project#14257 )\n\n* Temporarily disable test_awq_gemm_opcheck ( vllm-project#14251 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Frontend] Allow return_tokens_as_token_ids to be passed as a request param ( vllm-project#14066 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\n\n* [Misc][V1] Avoid using `envs.VLLM_USE_V1` in mm processing ( vllm-project#14256 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][V1] Fix allowed_token_ids for v1 Sampler ( vllm-project#14169 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Update nginx guide: remove privileged from vllm container run and add target GPU ID ( vllm-project#14217 )\n\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\n\n* [Doc] [3/N] Refer code examples for common cases in dev multimodal processor ( vllm-project#14278 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Small update for external_launcher backend docs ( vllm-project#14288 )\n\n* [V1][Frontend] Add Testing For V1 Runtime Parameters ( vllm-project#14159 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [LoRA] Remove linear hack outside transformers backend ( vllm-project#14177 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Add Qwen2MoeForCausalLM moe tuning support  ( vllm-project#14276 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* prefix_caching.md: Fixed typo ( vllm-project#14293 )\n\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\n\n* [Bugfix] Fix broken vision language example ( vllm-project#14292 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Docs] Add Meta Slides ( vllm-project#14297 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [V1][Minor] Remove obsolete FIXME comment ( vllm-project#14304 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* Deprecate `best_of` Sampling Parameter in anticipation for vLLM V1 ( vllm-project#13997 )\n\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][BugFix] Fix for mixed top_k batch ( vllm-project#14301 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\n\n* [misc] Add FlashMLA as a new option of VLLM_ATTENTION_BACKEND env ( vllm-project#14267 )\n\n* [V1][Easy] Add empty allowed_token_ids in the v1 sampler test ( vllm-project#14308 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* init\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Bugfix] Fix DeepSeek MTP crash when using TP1ModelRunner with CUDA graph due to shape mismatch ( vllm-project#14237 )\n\nSigned-off-by: pyc96 <pychen96@gmail.com>\n\n* [Bugfix] Remove num_tokens_across_dp ( vllm-project#14302 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [BugFix] Fix prefix caching V0 MLA ( vllm-project#14255 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\n\n* [CI/Build] Use spawn multiprocessing mode for V1 test pipeline ( vllm-project#14243 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Add benchmark for DeepGEMM and vLLM Block FP8 Dense GEMM ( vllm-project#13917 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Build] Add UV_HTTP_TIMEOUT to avoid timeout during installation ( vllm-project#13850 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] MLA + V1, illegal memory access and accuracy issues ( vllm-project#14253 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [misc] Mention `ray list nodes` command to troubleshoot ray issues ( vllm-project#14318 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [Bugfix][Structured Output] Support outlines engine with reasoning outputs for DeepSeek R1 ( vllm-project#14114 )\n\n* [V1] LoRA - Enable more V1 tests ( vllm-project#14315 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix][CI] ALiBi test case in xformers multi_query_kv_attention ( vllm-project#11301 )\n\n* [Hardware] Update the flash attn tag to support Blackwell ( vllm-project#14244 )\n\n* [Model] Update Paligemma multimodal processing with PromptUpdate  ( vllm-project#14015 )\n\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1][VLM][Pixtral-HF] Support Pixtral-HF on V1 ( vllm-project#14275 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Core] Optimizing cross-attention `QKVParallelLinear` computation ( vllm-project#12325 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\n\n* [Frontend][Docs] Transcription API streaming ( vllm-project#13301 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Doc] Update reasoning with stream example to use OpenAI library ( vllm-project#14077 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Doc] Correct beam_search using in generative_models.md ( vllm-project#14363 )\n\n* [Kernel] [V1] Improved performance for V1 Triton (ROCm) backend  ( vllm-project#14152 )\n\n* [Bugfix][Core] fix abort_seq_group and memory leak when n>1 ( vllm-project#14326 )\n\nSigned-off-by: courage17340 <courage17340@163.com>\n\n* [Core] Don't use cache during multi-modal profiling ( vllm-project#14336 )\n\n* [Doc] Fix date typo in README.md ( vllm-project#14366 )\n\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\n\n* [RLHF] use worker_extension_cls for compatibility with V0 and V1 ( vllm-project#14185 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Reinstate `best_of` for V0 ( vllm-project#14356 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Adding cpu inference with VXE ISA for s390x architecture ( vllm-project#12613 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\n\n* Add authors to license header. ( vllm-project#14371 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\n\n* Fix mla prefill context performance ( vllm-project#13897 )\n\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\n\n* [V1] Do not detokenize if sampling param detokenize is False ( vllm-project#14224 )\n\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Distributed] Add enable_expert_parallel arg ( vllm-project#14305 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build] Use uv python for docker rather than ppa:deadsnakes/ppa ( vllm-project#13569 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [CI] Disable spawn when running V1 Test ( vllm-project#14345 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Kernel] Add needs_fixed_stride_order tag to most GEMMs ( vllm-project#14306 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bugfix] Fix use_direct_call condition in FusedMoE layer for  ( vllm-project#14382 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bug] Fix Attention when ignored in by quant_method ( vllm-project#14313 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][Bugfix] Standardize quantized kv cache rejection for attention backends ( vllm-project#14221 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add nsight guide to profiling docs ( vllm-project#14298 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* cleanup boolean logic\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Hardware][TPU]Enable ragged paged attention kernel and resolve recompilation issue ( vllm-project#14310 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Doc] Fix a typo ( vllm-project#14385 )\n\n* [Bugfix] Correctly call `cudaProfilerStop` in benchmarks script ( vllm-project#14183 )\n\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\n\n* [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [FP8] Refactor apply_fp8_linear and apply_fp8_linear_generic into an object ( vllm-project#14390 )\n\nSigned-off-by: luka <luka@neuralmagic.com>\n\n* [BugFix] Illegal Memory Access in the blockwise cutlass fp8 GEMMs ( vllm-project#14396 )\n\n* [Bugfix] Fix JambaForCausalLM LoRA  ( vllm-project#14370 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Build] Add nightly wheel fallback when latest commit wheel unavailable ( vllm-project#14358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* OpenVINO: added CPU-like conditions ( vllm-project#14338 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [GH] Auto-apply multi-modality label to relevant PRs ( vllm-project#14402 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* correct wrong markdown syntax ( vllm-project#14414 )\n\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\n\n* [Bugfix] Further clean up LoRA test ( vllm-project#14422 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Clean up multi-modal processors ( vllm-project#14417 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Set default value of seed to None ( vllm-project#14274 )\n\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\n\n* [BUGFIX] Skip tokenization support for throughput benchmark ( vllm-project#12712 )\n\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\n\n* Fix missing `kv_caches` and `attn_metadata` in `OpenVINOCausalLM` ( vllm-project#14271 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Use the optimized block sizes after tuning the kernel. ( vllm-project#14329 )\n\n* [V1][Core] Support for Structured Outputs ( vllm-project#12388 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Doc] Update prefix_caching.md to match the example image ( vllm-project#14420 )\n\n* [Benchmarks] Make detokenization optional in benchmark scripts ( vllm-project#11697 )\n\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\n\n* comments\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Kernel] optimize performance of gptq marlin kernel when n is small ( vllm-project#14138 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [Misc] Add Phi4-MM example ( vllm-project#14343 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [v1] torch.compile integration explanation ( vllm-project#14437 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Eagerly remove finished requests from the batch ( vllm-project#14388 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V1][Metrics] Fix traceback with preemptions+LoRA ( vllm-project#14220 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Fix torch_xla which can't handle None seed introduced in vllm-project#14274 ( vllm-project#14459 )\n\nSigned-off-by: Yarong Mu <ymu@google.com>\n\n* [V1] Prompt logprobs + APC compatibility; prompt logprobs reqs cannot fill APC ( vllm-project#13949 )\n\n* [Bugfix][V1] Handle MLA in kv_cache_interface ( vllm-project#14462 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vllm-project#14471 )\n\n* [Bugfix][Disaggregated] Add a check in send_kv_caches_and_hidden_states and fix the reshape of the KVCache ( vllm-project#14369 )\n\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\n\n* [MISC][V1] Register process killing handler only in the main thread ( vllm-project#14380 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] add `extra_args` to `SamplingParams` ( vllm-project#13300 )\n\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\n\n* [CI/Build] refactor: set timezone of container to UTC ( vllm-project#12888 )\n\nSigned-off-by: Roger Meier <r.meier@siemens.com>\n\n* Default to `generation_config` from model ( vllm-project#12622 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc]add doc for Qwen models tool calling ( vllm-project#14478 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Doc] Added QwQ-32B to the supported models list in the reasoning outâ€¦ ( vllm-project#14479 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Bugfix] Make the deviceprofiler include LoRA memory. ( vllm-project#14469 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Add training doc signposting to TRL ( vllm-project#14439 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Build/BugFix] Fix hopper 12.8 build ( vllm-project#14354 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add RLHF document ( vllm-project#14482 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Use a fixed seed to avoid flaky tests ( vllm-project#14480 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] TPU - Add tensor parallel support via Ray ( vllm-project#13618 )\n\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\n\n* [VLM] Add TP support for Phi-4-MM ( vllm-project#14453 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] add `use_tqdm_on_load` to reduce logs ( vllm-project#14407 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [V1][Core] Fix memory issue with logits & sampling ( vllm-project#13776 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [benchmarks] Add option to use unique jsonschema for each request ( vllm-project#14457 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Don't run ruff at all on 3rd party libs ( vllm-project#14493 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Move requirements into their own directory ( vllm-project#12547 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] DeepSeek Accuracy ( vllm-project#14476 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [Bugfix] Fix profiling OOM and decouple encoder multimodal profiling ( vllm-project#14361 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Update CODEOWNERS for structured output ( vllm-project#14496 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Upgrade to Python 3.9 typing for additional directories ( vllm-project#14492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support bad_words in sampler ( vllm-project#13376 )\n\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* Revert \"[V1][Core] Fix memory issue with logits & sampling\" ( vllm-project#14504 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Attention] Default to FlashMLA backend for MLA ( vllm-project#14451 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [V1][TPU] Remove unnecessary padding for running on TPU. ( vllm-project#14467 )\n\n* [Feat] Support chunked prefill for LMCache connector ( vllm-project#14505 )\n\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\n\n* [Bugfix] Fix tqdm progress bar when SamplingParams.n > 1 ( vllm-project#12428 )\n\nSigned-off-by: Yuchen Yan <740987012@qq.com>\n\n* [Bugfix] Revert QKVCrossParallelLinear usage in Mllama to keep BNB quantization work ( vllm-project#14498 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] Fix the recompiling issue in logits processor after warmup ( vllm-project#14510 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Misc] Ensure out-of-tree quantization method recognize by cli args ( vllm-project#14328 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Bugfix] Wrong requirements path - rocm ( vllm-project#14527 )\n\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\n\n* [Feature] Consolidate performance benchmark datasets ( vllm-project#14036 )\n\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Add log information for handle_process_request. ( vllm-project#14130 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Docs] Mention `model_impl` arg when explaining Transformers fallback ( vllm-project#14552 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] support image embeds ( vllm-project#13955 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Kernel] Add more dtype support for GGUF kernels ( vllm-project#14043 )\n\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\n\n* [Doc] Update PaliGemma note to a warning ( vllm-project#14565 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* V1 rocm support ( #469 )\n\n* Initial commit for V1 successfull compilation\n\n* Small improvement for linear\n\n* Small improvement for linear\n\n* making use of forward_cuda for all except ROPE in llama\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* nightly_fixed_aiter_integration_final_20250305 README update ( #470 )\n\n* nightly_fixed_aiter_integration_final_20250305 README update (perf results only)\n\n* Update Docker Manifest git hash\n\n* Update Docker Manifest and added nightly_fixed_aiter_integration_final_20250305\n\n* some more updates\n\n* Update AITER section with example\n\n* Updated AITER command with larger batch size and model name\n\n* Fixing typo\n\n* Removed --max-model-len in AITER command\n\n* Updating AITER instructions\n\n* typo\n\n* Another typo\n\n* Whitespace\n\n* modifying whats new section\n\n* Another typo\n\n---------\n\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: pyc96 <pychen96@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\nSigned-off-by: courage17340 <courage17340@163.com>\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\nSigned-off-by: luka <luka@neuralmagic.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Yarong Mu <ymu@google.com>\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\nSigned-off-by: Roger Meier <r.meier@siemens.com>\nSigned-off-by: WangErXiao <863579016@qq.com>\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Yuchen Yan <740987012@qq.com>\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Qubitium-ModelCloud <qubitium@modelcloud.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: iefgnoix <isaacwxf23@gmail.com>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Zhanwen Chen <phil.zhanwen.chen@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: kushanam <42385577+kushanam@users.noreply.github.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: rainkert <93575312+rainkert@users.noreply.github.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: Congcong Chen <congcongchen@microsoft.com>\nCo-authored-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Iacopo Poli <iacopo@lighton.ai>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Zhe Zhang <zhz@apache.org>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: DaividFrank <49250948+DaividFrank@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Vincent <vincentzhongy+githubvincent4@gmail.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\nCo-authored-by: Serena <yangsijia.614@bytedance.com>\nCo-authored-by: pyc96 <pychen96@gmail.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Ce Gao <cegao@tensorchord.ai>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: kYLe <kylhuang@nvidia.com>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: Yanyi Liu <wolfsonliu@163.com>\nCo-authored-by: Irina Yuryeva <76484191+upayuryeva@users.noreply.github.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: courage17340 <courage17340@users.noreply.github.com>\nCo-authored-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\nCo-authored-by: Himanshu Jaju <hj@mistral.ai>\nCo-authored-by: Chengji Yao <chengjiyao@google.com>\nCo-authored-by: Daniel Li <dyli@google.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Peng Li <justdoit.pli@gmail.com>\nCo-authored-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: York-RDWang <103811994+York-RDWang@users.noreply.github.com>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: yarongmu-google <150371854+yarongmu-google@users.noreply.github.com>\nCo-authored-by: afeldman-nm <156691304+afeldman-nm@users.noreply.github.com>\nCo-authored-by: Mathis Felardos <mathis@mistral.ai>\nCo-authored-by: Aviv Keshet <akeshet@scaledcognition.com>\nCo-authored-by: Roger Meier <r.meier@siemens.com>\nCo-authored-by: Robin <863579016@qq.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-redhat@users.noreply.github.com>\nCo-authored-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Yuchen Yan <50619811+yanyc428@users.noreply.github.com>\nCo-authored-by: Martin Hoyer <mhoyer@redhat.com>\nCo-authored-by: Jennifer Zhao <JenZhao@users.noreply.github.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: Szymon OÅ¼Ã³g <58388001+SzymonOzog@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Mcirino1 <57415822+Mcirino1@users.noreply.github.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 Fix performance when --generation-config is not None ( vllm-projecâ€¦ â€¦ be31e4d â€¦t#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 Fix performance when --generation-config is not None ( vllm-projecâ€¦ â€¦ b12de09 â€¦t#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:18", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, TTFT, TTFT | SERVING: vllm serve, Serving, Serving | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:52:18", "models": ["N/A"], "lm_eval_commands": null, "perf_command": "python benchmarks/benchmark_serving.py --model meta-llama/Llama-3.2-1B-Instruct --dataset-path ShareGPT_V3_unfiltered_cleaned_split.json", "commit_subject": "Fix performance when `--generation-config` is not `None` (#14223)", "commit_message": "Fix performance when `--generation-config` is not `None` (#14223)\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>", "commit_date": "2025-03-04T20:59:22+01:00", "files_changed": ["vllm/entrypoints/llm.py", "vllm/entrypoints/openai/serving_chat.py", "vllm/entrypoints/openai/serving_completion.py", "vllm/entrypoints/openai/serving_transcription.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 4, "only_test_files": 0, "only_non_test_files": 1, "num_files": 4, "num_hunks": 8, "num_edited_lines": 48, "num_non_test_edited_lines": 48, "commit_year": 2025}, "diff_text": "diff --git a/vllm/entrypoints/llm.py b/vllm/entrypoints/llm.py\nindex 122e2ed86..fc585ee9e 100644\n--- a/vllm/entrypoints/llm.py\n+++ b/vllm/entrypoints/llm.py\n@@ -244,6 +244,7 @@ class LLM:\n             engine_args, usage_context=UsageContext.LLM_CLASS)\n \n         self.request_counter = Counter()\n+        self.default_sampling_params: Union[dict[str, Any], None] = None\n \n     @staticmethod\n     def get_engine_class() -> type[LLMEngine]:\n@@ -268,10 +269,11 @@ class LLM:\n             tokenizer_group.tokenizer = get_cached_tokenizer(tokenizer)\n \n     def get_default_sampling_params(self) -> SamplingParams:\n-        diff_sampling_param = (\n-            self.llm_engine.model_config.get_diff_sampling_param())\n-        if diff_sampling_param:\n-            return SamplingParams.from_optional(**diff_sampling_param)\n+        if self.default_sampling_params is None:\n+            self.default_sampling_params = (\n+                self.llm_engine.model_config.get_diff_sampling_param())\n+        if self.default_sampling_params:\n+            return SamplingParams.from_optional(**self.default_sampling_params)\n         return SamplingParams()\n \n     @overload\ndiff --git a/vllm/entrypoints/openai/serving_chat.py b/vllm/entrypoints/openai/serving_chat.py\nindex 98e9ea0fc..f4aaee360 100644\n--- a/vllm/entrypoints/openai/serving_chat.py\n+++ b/vllm/entrypoints/openai/serving_chat.py\n@@ -105,10 +105,11 @@ class OpenAIServingChat(OpenAIServing):\n                                 \"been registered\") from e\n \n         self.enable_prompt_tokens_details = enable_prompt_tokens_details\n-        diff_sampling_param = self.model_config.get_diff_sampling_param()\n-        if diff_sampling_param:\n+        self.default_sampling_params = (\n+            self.model_config.get_diff_sampling_param())\n+        if self.default_sampling_params:\n             logger.info(\"Overwriting default chat sampling param with: %s\",\n-                        diff_sampling_param)\n+                        self.default_sampling_params)\n \n     async def create_chat_completion(\n         self,\n@@ -210,17 +211,14 @@ class OpenAIServingChat(OpenAIServing):\n                 sampling_params: Union[SamplingParams, BeamSearchParams]\n                 default_max_tokens = self.max_model_len - len(\n                     engine_prompt[\"prompt_token_ids\"])\n-                # Build default sampling params\n-                default_sampling_params = (\n-                    self.model_config.get_diff_sampling_param())\n                 if request.use_beam_search:\n                     sampling_params = request.to_beam_search_params(\n-                        default_max_tokens, default_sampling_params)\n+                        default_max_tokens, self.default_sampling_params)\n                 else:\n                     sampling_params = request.to_sampling_params(\n                         default_max_tokens,\n                         self.model_config.logits_processor_pattern,\n-                        default_sampling_params)\n+                        self.default_sampling_params)\n \n                 self._log_inputs(request_id,\n                                  request_prompts[i],\ndiff --git a/vllm/entrypoints/openai/serving_completion.py b/vllm/entrypoints/openai/serving_completion.py\nindex ed09af84f..b2ad28c0a 100644\n--- a/vllm/entrypoints/openai/serving_completion.py\n+++ b/vllm/entrypoints/openai/serving_completion.py\n@@ -51,11 +51,12 @@ class OpenAIServingCompletion(OpenAIServing):\n                          models=models,\n                          request_logger=request_logger,\n                          return_tokens_as_token_ids=return_tokens_as_token_ids)\n-        diff_sampling_param = self.model_config.get_diff_sampling_param()\n-        if diff_sampling_param:\n+        self.default_sampling_params = (\n+            self.model_config.get_diff_sampling_param())\n+        if self.default_sampling_params:\n             logger.info(\n                 \"Overwriting default completion sampling param with: %s\",\n-                diff_sampling_param)\n+                self.default_sampling_params)\n \n     async def create_completion(\n         self,\n@@ -119,17 +120,14 @@ class OpenAIServingCompletion(OpenAIServing):\n                 sampling_params: Union[SamplingParams, BeamSearchParams]\n                 default_max_tokens = self.max_model_len - len(\n                     engine_prompt[\"prompt_token_ids\"])\n-                # Build default sampling params\n-                default_sampling_params = (\n-                    self.model_config.get_diff_sampling_param())\n                 if request.use_beam_search:\n                     sampling_params = request.to_beam_search_params(\n-                        default_max_tokens, default_sampling_params)\n+                        default_max_tokens, self.default_sampling_params)\n                 else:\n                     sampling_params = request.to_sampling_params(\n                         default_max_tokens,\n                         self.model_config.logits_processor_pattern,\n-                        default_sampling_params)\n+                        self.default_sampling_params)\n \n                 request_id_item = f\"{request_id}-{i}\"\n \ndiff --git a/vllm/entrypoints/openai/serving_transcription.py b/vllm/entrypoints/openai/serving_transcription.py\nindex 77f016a5e..402a0bb7a 100644\n--- a/vllm/entrypoints/openai/serving_transcription.py\n+++ b/vllm/entrypoints/openai/serving_transcription.py\n@@ -161,11 +161,12 @@ class OpenAIServingTranscription(OpenAIServing):\n                          request_logger=request_logger,\n                          return_tokens_as_token_ids=return_tokens_as_token_ids)\n \n-        diff_sampling_param = self.model_config.get_diff_sampling_param()\n-        if diff_sampling_param:\n+        self.default_sampling_params = (\n+            self.model_config.get_diff_sampling_param())\n+        if self.default_sampling_params:\n             logger.info(\n                 \"Overwriting default completion sampling param with: %s\",\n-                diff_sampling_param)\n+                self.default_sampling_params)\n \n     async def _preprocess_transcription(\n         self,\n@@ -273,9 +274,8 @@ class OpenAIServingTranscription(OpenAIServing):\n         try:\n             # TODO(rob): subtract len of tokenized prompt.\n             default_max_tokens = self.model_config.max_model_len\n-            default_params = self.model_config.get_diff_sampling_param()\n             sampling_params = request.to_sampling_params(\n-                default_max_tokens, default_params)\n+                default_max_tokens, self.default_sampling_params)\n \n             self._log_inputs(\n                 request_id,", "apis": ["vLLM.LLM.get_default_sampling_params", "OpenAIServingChat.create_chat_completion", "OpenAIServingCompletion.create_completion", "OpenAIServingTranscription._preprocess_transcription"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_chat.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/openai/serving_completion.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies several non-test source files (llm.py, serving_chat.py, serving_completion.py, serving_transcription.py). It changes how default sampling parameters are handled by caching the result of get_diff_sampling_param() into an instance variable (default_sampling_params) rather than invoking it repeatedly. This refactoring is aimed at reducing redundant computations and thereby optimizing performance. The changes go beyond mere refactoring or comment updates, impacting the performance of core functions related to API calls on CPU without relying on GPU. Overall, the commit meets the performance/optimization criteria.", "llm_api_reason": "This commit introduces a caching optimization by adding a new instance variable called default_sampling_params that stores the result of self.model_config.get_diff_sampling_param(). Instead of calling the model configuration repeatedly, the methods now check if default_sampling_params is already set and reuse it. This change appears in the LLM class (in its get_default_sampling_params method) and in several OpenAIServing endpoint classes (namely, in create_chat_completion in OpenAIServingChat, create_completion in OpenAIServingCompletion, and in the transcription preprocessing in OpenAIServingTranscription), which all use the cached default_sampling_params for building sampling parameters. This improvement reduces redundant configuration lookups and should enhance performance when --generation-config is not None."}
{"commit_hash": "19d98e0c7db96713f0e2201649159431177a56e2", "pr_url": "https://github.com/vllm-project/vllm/pull/13625", "pr_date": "2025-03-03", "timeline_text": "Copy link Member mgoin commented Feb 20, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . I'm running into OOM issues at long sequence lengths with deepseek r1, so exploring options here (see o3-mini chat ). First I tried moving the silu+mul to be an inplace operation via a new kernel torch.ops._C.silu_and_mul_inplace(intermediate_cache1.view(-1, N)) , but it seems easier to reuse memory for cache1 and cache3 since there is absolutely no data dependency there Manual peak measurement shows 15% reduction in memory for fused_moe for 64k prefill Eval: vllm (pretrained=deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct,trust_remote_code=True), gen_kwargs: (None), limit: None, num_fewshot: 5, batch_size: auto\n|Tasks|Version|     Filter     |n-shot|  Metric   |   |Value |   |Stderr|\n|-----|------:|----------------|-----:|-----------|---|-----:|---|-----:|\n|gsm8k|      3|flexible-extract|     5|exact_match|â†‘  |0.7642|Â±  |0.0117|\n|     |       |strict-match    |     5|exact_match|â†‘  |0.7468|Â±  |0.0120| Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 simon-mo reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Optimize moe intermediate_cache allocation â€¦ 85baec6 Signed-off-by: mgoin <mgoin64@gmail.com> Copy link github-actions bot commented Feb 20, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Improvement â€¦ ab14d0e Signed-off-by: mgoin <mgoin64@gmail.com> mgoin marked this pull request as ready for review February 20, 2025 20:58 mgoin changed the title Optimize moe intermediate_cache usage [Kernel] Optimize moe intermediate_cache usage Feb 20, 2025 Merge branch 'main' into fused-moe-reuse-intermediate-cache d222413 mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Feb 25, 2025 mgoin requested review from LucasWilkinson and tlrmchlsmth February 25, 2025 17:05 Copy link Member Author mgoin commented Feb 25, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Manual peak measurement shows 15% reduction in memory for fused_moe for 64k prefill main: python moe_mem.py\nMemory usage: 3586 MB\nTime: 5.0750 seconds This PR: python moe_mem.py\nMemory usage: 3074 MB\nTime: 5.0809 seconds import torch import time from vllm . model_executor . layers . fused_moe import fused_moe num_tokens = 64 * 1024 experts = 8 hidden_size = 4096 intermediate_size = 8192 topk = 2 torch . manual_seed ( 0 ) x = torch . randn (( num_tokens , hidden_size ), device = \"cuda\" , dtype = torch . float16 ) / 32 w1 = torch . randn (( experts , intermediate_size * 2 , hidden_size ), device = \"cuda\" , dtype = torch . float16 ) / 32 w2 = torch . randn (( experts , hidden_size , intermediate_size ), device = \"cuda\" , dtype = torch . float16 ) / 32 gating_output = torch . randn (( num_tokens , experts ), device = \"cuda\" , dtype = torch . float16 ) # Run once to get peak memory usage start_memory_mb = torch . cuda . max_memory_allocated () // ( 1024 * 1024 ) _ = fused_moe ( x , w1 , w2 , gating_output , topk , True ) end_memory_mb = torch . cuda . max_memory_allocated () // ( 1024 * 1024 ) print ( f\"Memory usage: { end_memory_mb - start_memory_mb } MB\" ) # Benchmark performance start = time . perf_counter () for _ in range ( 100 ): x = fused_moe ( x , w1 , w2 , gating_output , topk , True ) elapsed = time . perf_counter () - start print ( f\"Time: { elapsed :.4f } seconds\" ) All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . simon-mo added this to DeepSeek V3/R1 Feb 25, 2025 github-project-automation bot moved this to Backlog in DeepSeek V3/R1 Feb 25, 2025 simon-mo moved this from Backlog to In review in DeepSeek V3/R1 Feb 25, 2025 hmellor moved this from In review to In progress in DeepSeek V3/R1 Feb 28, 2025 tlrmchlsmth approved these changes Mar 3, 2025 View reviewed changes Hide details View details tlrmchlsmth merged commit 19d98e0 into vllm-project : main Mar 3, 2025 60 checks passed Uh oh! There was an error while loading. Please reload this page . github-project-automation bot moved this from In progress to Done in DeepSeek V3/R1 Mar 3, 2025 mgoin deleted the fused-moe-reuse-intermediate-cache branch March 3, 2025 22:50 Alexei-V-Ivanov-AMD added a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Mar 11, 2025 Merging in the latest merge from vllm-project to ROCm ( #472 ) â€¦ a699a11 * Fix `head_dim` not existing in all model configs (Transformers backend) ( vllm-project#14141 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V0][Metrics] Remove unimplemented `vllm:tokens_total` ( vllm-project#14134 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V0][Metrics] Deprecate some KV/prefix cache metrics ( vllm-project#14136 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1] Simplify stats logging ( vllm-project#14082 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [WIP][[V1][Metrics] Implement max_num_generation_tokens,  request_params_n, and request_params_max_tokens metrics ( vllm-project#14055 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Allow shared_experts skip quantization for DeepSeekV2/V3 ( vllm-project#14100 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add GPTQModel ( vllm-project#14056 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* [v1] Add comments to the new ragged paged attention Pallas kernel ( vllm-project#14155 )\n\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\n\n* [Model] Add support for GraniteMoeShared models ( vllm-project#13313 )\n\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [core] moe fp8 block quant tuning support ( vllm-project#14068 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* [Misc] Remove lru_cache in NvmlCudaPlatform ( vllm-project#14156 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] Pass all driver env vars to ray workers unless excluded ( vllm-project#14099 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* Use math.prod instead of np.prod for trivial ops ( vllm-project#14142 )\n\n* Fix benchmark_moe.py tuning for CUDA devices ( vllm-project#14164 )\n\n* [platform] add debug logging during inferring the device type ( vllm-project#14195 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [sleep mode] error out with expandable_segments ( vllm-project#14189 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [doc] add \"Failed to infer device type\" to faq ( vllm-project#14200 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Restrict MacOS CPU detection ( vllm-project#14210 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][BugFix] Fix remaining sync engine client shutdown errors/hangs ( vllm-project#13869 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V0][Metrics] Deprecate some questionable request time metrics ( vllm-project#14135 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [V1][Molmo] Fix get_multimodal_embeddings() in molmo.py ( vllm-project#14161 )\n\n* add cutlass support for blackwell fp8 gemm ( vllm-project#13798 )\n\n* [TPU][Profiler] Support start_profile/stop_profile in TPU worker ( vllm-project#13988 )\n\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* Fix performance when `--generation-config` is not `None` ( vllm-project#14223 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] Do `prompt_logprobs` clamping for chat as well as completions ( vllm-project#14225 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Docs] Update Dockerfile dependency image ( vllm-project#14215 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [v1][Metrics] Add design doc ( vllm-project#12745 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [Security] Serialize using safetensors instead of pickle in Mooncake Pipe ( vllm-project#14228 )\n\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\n\n* Clean up unused padding_idx variables across many model definitions ( vllm-project#13240 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [ROCm] Disable a few more kernel tests that are broken on ROCm ( vllm-project#14145 )\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [V1][TPU] TPU multimodal model support for ragged attention ( vllm-project#14158 )\n\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\n\n* [misc] announce china meetup ( vllm-project#14248 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Moved numba from common requirements to cuda/rocm specific requirements ( vllm-project#14199 )\n\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\n\n* Disable GPTQ AllSpark kernels for CUDA Compiler < 12.0 ( vllm-project#14157 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Bugfix] Fix gptq_marlin for deepseek-v3 ( vllm-project#13750 )\n\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\n\n* [V1][Bugfix] Do not reset prefix caching metrics ( vllm-project#14235 )\n\n* [Model] New model support for Phi-4-multimodal-instruct ( vllm-project#14119 )\n\n* [V1] EP/TP MoE + DP Attention ( vllm-project#13931 )\n\n* [platforms] improve rocm debugging info ( vllm-project#14257 )\n\n* Temporarily disable test_awq_gemm_opcheck ( vllm-project#14251 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Frontend] Allow return_tokens_as_token_ids to be passed as a request param ( vllm-project#14066 )\n\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\n\n* [Misc][V1] Avoid using `envs.VLLM_USE_V1` in mm processing ( vllm-project#14256 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [Bugfix][V1] Fix allowed_token_ids for v1 Sampler ( vllm-project#14169 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Doc] Update nginx guide: remove privileged from vllm container run and add target GPU ID ( vllm-project#14217 )\n\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\n\n* [Doc] [3/N] Refer code examples for common cases in dev multimodal processor ( vllm-project#14278 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Small update for external_launcher backend docs ( vllm-project#14288 )\n\n* [V1][Frontend] Add Testing For V1 Runtime Parameters ( vllm-project#14159 )\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n* [LoRA] Remove linear hack outside transformers backend ( vllm-project#14177 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] Add Qwen2MoeForCausalLM moe tuning support  ( vllm-project#14276 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* prefix_caching.md: Fixed typo ( vllm-project#14293 )\n\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\n\n* [Bugfix] Fix broken vision language example ( vllm-project#14292 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Docs] Add Meta Slides ( vllm-project#14297 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [V1][Minor] Remove obsolete FIXME comment ( vllm-project#14304 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* Deprecate `best_of` Sampling Parameter in anticipation for vLLM V1 ( vllm-project#13997 )\n\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [V1][BugFix] Fix for mixed top_k batch ( vllm-project#14301 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\n\n* [misc] Add FlashMLA as a new option of VLLM_ATTENTION_BACKEND env ( vllm-project#14267 )\n\n* [V1][Easy] Add empty allowed_token_ids in the v1 sampler test ( vllm-project#14308 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* init\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Bugfix] Fix DeepSeek MTP crash when using TP1ModelRunner with CUDA graph due to shape mismatch ( vllm-project#14237 )\n\nSigned-off-by: pyc96 <pychen96@gmail.com>\n\n* [Bugfix] Remove num_tokens_across_dp ( vllm-project#14302 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [BugFix] Fix prefix caching V0 MLA ( vllm-project#14255 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\n\n* [CI/Build] Use spawn multiprocessing mode for V1 test pipeline ( vllm-project#14243 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Add benchmark for DeepGEMM and vLLM Block FP8 Dense GEMM ( vllm-project#13917 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Build] Add UV_HTTP_TIMEOUT to avoid timeout during installation ( vllm-project#13850 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [BugFix] MLA + V1, illegal memory access and accuracy issues ( vllm-project#14253 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [misc] Mention `ray list nodes` command to troubleshoot ray issues ( vllm-project#14318 )\n\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\n\n* [Bugfix][Structured Output] Support outlines engine with reasoning outputs for DeepSeek R1 ( vllm-project#14114 )\n\n* [V1] LoRA - Enable more V1 tests ( vllm-project#14315 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix][CI] ALiBi test case in xformers multi_query_kv_attention ( vllm-project#11301 )\n\n* [Hardware] Update the flash attn tag to support Blackwell ( vllm-project#14244 )\n\n* [Model] Update Paligemma multimodal processing with PromptUpdate  ( vllm-project#14015 )\n\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\n\n* [V1][VLM][Pixtral-HF] Support Pixtral-HF on V1 ( vllm-project#14275 )\n\nSigned-off-by: Linkun Chen <github@lkchen.net>\n\n* [Core] Optimizing cross-attention `QKVParallelLinear` computation ( vllm-project#12325 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\n\n* [Frontend][Docs] Transcription API streaming ( vllm-project#13301 )\n\nSigned-off-by: NickLucche <nlucches@redhat.com>\n\n* [Doc] Update reasoning with stream example to use OpenAI library ( vllm-project#14077 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Doc] Correct beam_search using in generative_models.md ( vllm-project#14363 )\n\n* [Kernel] [V1] Improved performance for V1 Triton (ROCm) backend  ( vllm-project#14152 )\n\n* [Bugfix][Core] fix abort_seq_group and memory leak when n>1 ( vllm-project#14326 )\n\nSigned-off-by: courage17340 <courage17340@163.com>\n\n* [Core] Don't use cache during multi-modal profiling ( vllm-project#14336 )\n\n* [Doc] Fix date typo in README.md ( vllm-project#14366 )\n\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\n\n* [RLHF] use worker_extension_cls for compatibility with V0 and V1 ( vllm-project#14185 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* Reinstate `best_of` for V0 ( vllm-project#14356 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Adding cpu inference with VXE ISA for s390x architecture ( vllm-project#12613 )\n\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\n\n* Add authors to license header. ( vllm-project#14371 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\n\n* Fix mla prefill context performance ( vllm-project#13897 )\n\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\n\n* [V1] Do not detokenize if sampling param detokenize is False ( vllm-project#14224 )\n\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Distributed] Add enable_expert_parallel arg ( vllm-project#14305 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [CI/Build] Use uv python for docker rather than ppa:deadsnakes/ppa ( vllm-project#13569 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [CI] Disable spawn when running V1 Test ( vllm-project#14345 )\n\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\n\n* [Kernel] Add needs_fixed_stride_order tag to most GEMMs ( vllm-project#14306 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bugfix] Fix use_direct_call condition in FusedMoE layer for  ( vllm-project#14382 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Bug] Fix Attention when ignored in by quant_method ( vllm-project#14313 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [V1][Bugfix] Standardize quantized kv cache rejection for attention backends ( vllm-project#14221 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Docs] Add nsight guide to profiling docs ( vllm-project#14298 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* cleanup boolean logic\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Hardware][TPU]Enable ragged paged attention kernel and resolve recompilation issue ( vllm-project#14310 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Doc] Fix a typo ( vllm-project#14385 )\n\n* [Bugfix] Correctly call `cudaProfilerStop` in benchmarks script ( vllm-project#14183 )\n\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\n\n* [Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [FP8] Refactor apply_fp8_linear and apply_fp8_linear_generic into an object ( vllm-project#14390 )\n\nSigned-off-by: luka <luka@neuralmagic.com>\n\n* [BugFix] Illegal Memory Access in the blockwise cutlass fp8 GEMMs ( vllm-project#14396 )\n\n* [Bugfix] Fix JambaForCausalLM LoRA  ( vllm-project#14370 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Build] Add nightly wheel fallback when latest commit wheel unavailable ( vllm-project#14358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* OpenVINO: added CPU-like conditions ( vllm-project#14338 )\n\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\n\n* [GH] Auto-apply multi-modality label to relevant PRs ( vllm-project#14402 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* correct wrong markdown syntax ( vllm-project#14414 )\n\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\n\n* [Bugfix] Further clean up LoRA test ( vllm-project#14422 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [Bugfix] Clean up multi-modal processors ( vllm-project#14417 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Misc] Set default value of seed to None ( vllm-project#14274 )\n\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\n\n* [BUGFIX] Skip tokenization support for throughput benchmark ( vllm-project#12712 )\n\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\n\n* Fix missing `kv_caches` and `attn_metadata` in `OpenVINOCausalLM` ( vllm-project#14271 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Use the optimized block sizes after tuning the kernel. ( vllm-project#14329 )\n\n* [V1][Core] Support for Structured Outputs ( vllm-project#12388 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [Doc] Update prefix_caching.md to match the example image ( vllm-project#14420 )\n\n* [Benchmarks] Make detokenization optional in benchmark scripts ( vllm-project#11697 )\n\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\n\n* comments\n\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\n\n* [Kernel] optimize performance of gptq marlin kernel when n is small ( vllm-project#14138 )\n\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\n\n* [Misc] Add Phi4-MM example ( vllm-project#14343 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [v1] torch.compile integration explanation ( vllm-project#14437 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Eagerly remove finished requests from the batch ( vllm-project#14388 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V1][Metrics] Fix traceback with preemptions+LoRA ( vllm-project#14220 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* [Bugfix] Fix torch_xla which can't handle None seed introduced in vllm-project#14274 ( vllm-project#14459 )\n\nSigned-off-by: Yarong Mu <ymu@google.com>\n\n* [V1] Prompt logprobs + APC compatibility; prompt logprobs reqs cannot fill APC ( vllm-project#13949 )\n\n* [Bugfix][V1] Handle MLA in kv_cache_interface ( vllm-project#14462 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Revert \"[Perf] Reduce MLA CPU overheads in V1 ( vllm-project#14384 )\" ( vllm-project#14471 )\n\n* [Bugfix][Disaggregated] Add a check in send_kv_caches_and_hidden_states and fix the reshape of the KVCache ( vllm-project#14369 )\n\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\n\n* [MISC][V1] Register process killing handler only in the main thread ( vllm-project#14380 )\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [core] add `extra_args` to `SamplingParams` ( vllm-project#13300 )\n\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\n\n* [CI/Build] refactor: set timezone of container to UTC ( vllm-project#12888 )\n\nSigned-off-by: Roger Meier <r.meier@siemens.com>\n\n* Default to `generation_config` from model ( vllm-project#12622 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Doc]add doc for Qwen models tool calling ( vllm-project#14478 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Doc] Added QwQ-32B to the supported models list in the reasoning outâ€¦ ( vllm-project#14479 )\n\nSigned-off-by: WangErXiao <863579016@qq.com>\n\n* [Bugfix] Make the deviceprofiler include LoRA memory. ( vllm-project#14469 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* Add training doc signposting to TRL ( vllm-project#14439 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Build/BugFix] Fix hopper 12.8 build ( vllm-project#14354 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Add RLHF document ( vllm-project#14482 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [CI/Build] Use a fixed seed to avoid flaky tests ( vllm-project#14480 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] TPU - Add tensor parallel support via Ray ( vllm-project#13618 )\n\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\n\n* [VLM] Add TP support for Phi-4-MM ( vllm-project#14453 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Misc] add `use_tqdm_on_load` to reduce logs ( vllm-project#14407 )\n\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\n\n* [V1][Core] Fix memory issue with logits & sampling ( vllm-project#13776 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [benchmarks] Add option to use unique jsonschema for each request ( vllm-project#14457 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Don't run ruff at all on 3rd party libs ( vllm-project#14493 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Move requirements into their own directory ( vllm-project#12547 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] DeepSeek Accuracy ( vllm-project#14476 )\n\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\n\n* [Bugfix] Fix profiling OOM and decouple encoder multimodal profiling ( vllm-project#14361 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* Update CODEOWNERS for structured output ( vllm-project#14496 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] Upgrade to Python 3.9 typing for additional directories ( vllm-project#14492 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [V1] Support bad_words in sampler ( vllm-project#13376 )\n\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* Revert \"[V1][Core] Fix memory issue with logits & sampling\" ( vllm-project#14504 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Attention] Default to FlashMLA backend for MLA ( vllm-project#14451 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [V1][TPU] Remove unnecessary padding for running on TPU. ( vllm-project#14467 )\n\n* [Feat] Support chunked prefill for LMCache connector ( vllm-project#14505 )\n\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\n\n* [Bugfix] Fix tqdm progress bar when SamplingParams.n > 1 ( vllm-project#12428 )\n\nSigned-off-by: Yuchen Yan <740987012@qq.com>\n\n* [Bugfix] Revert QKVCrossParallelLinear usage in Mllama to keep BNB quantization work ( vllm-project#14498 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [Hardware][TPU] Fix the recompiling issue in logits processor after warmup ( vllm-project#14510 )\n\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\n\n* [Misc] Ensure out-of-tree quantization method recognize by cli args ( vllm-project#14328 )\n\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\n\n* [Bugfix] Wrong requirements path - rocm ( vllm-project#14527 )\n\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\n\n* [Feature] Consolidate performance benchmark datasets ( vllm-project#14036 )\n\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\n\n* [Misc] Add log information for handle_process_request. ( vllm-project#14130 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Docs] Mention `model_impl` arg when explaining Transformers fallback ( vllm-project#14552 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Frontend] support image embeds ( vllm-project#13955 )\n\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\n\n* [Kernel] Add more dtype support for GGUF kernels ( vllm-project#14043 )\n\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\n\n* [Doc] Update PaliGemma note to a warning ( vllm-project#14565 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* V1 rocm support ( #469 )\n\n* Initial commit for V1 successfull compilation\n\n* Small improvement for linear\n\n* Small improvement for linear\n\n* making use of forward_cuda for all except ROPE in llama\n\n---------\n\nCo-authored-by: maleksan85 <maleksan@amd.com>\n\n* nightly_fixed_aiter_integration_final_20250305 README update ( #470 )\n\n* nightly_fixed_aiter_integration_final_20250305 README update (perf results only)\n\n* Update Docker Manifest git hash\n\n* Update Docker Manifest and added nightly_fixed_aiter_integration_final_20250305\n\n* some more updates\n\n* Update AITER section with example\n\n* Updated AITER command with larger batch size and model name\n\n* Fixing typo\n\n* Removed --max-model-len in AITER command\n\n* Updating AITER instructions\n\n* typo\n\n* Another typo\n\n* Whitespace\n\n* modifying whats new section\n\n* Another typo\n\n---------\n\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Xiongfei Wei <isaacwxf23@gmail.com>\nSigned-off-by: Travis Johnson <tsjohnso@us.ibm.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Rui Qiao <ruisearch42@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Siyuan Liu <lsiyuan@google.com>\nSigned-off-by: KuntaiDu <kuntai@uchicago.edu>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Sage Moore <sage@neuralmagic.com>\nSigned-off-by: Michael Goin <mgoin64@gmail.com>\nSigned-off-by: Nishidha Panpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: dangshunya <dangshunya@baichuan-inc.com>\nSigned-off-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Iacopo Poli <iacopo@lighton.ai>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Daivid Savernin-Frenk <daivid.frank@TurboNext.ai>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: vincent-4 <vincentzhongy+githubvincent4@gmail.com>\nSigned-off-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nSigned-off-by: pyc96 <pychen96@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: Lucas Wilkinson <lwilkins@redhat.com>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Kyle Huang <kylhuang@nvidia.com>\nSigned-off-by: Linkun Chen <github@lkchen.net>\nSigned-off-by: NickLucche <nlucches@redhat.com>\nSigned-off-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nSigned-off-by: liuyanyi <wolfsonliu@163.com>\nSigned-off-by: courage17340 <courage17340@163.com>\nSigned-off-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nSigned-off-by: Dilip Gowda Bhagavan <dilip.bhagavan@ibm.com>\nSigned-off-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nSigned-off-by: Thomas Parnell <tpa@zurich.ibm.com>\nSigned-off-by: ZhongYingMatrix <zhongyingmatrix@gmail.com>\nSigned-off-by: Himanshu Jaju <hj@mistral.ai>\nSigned-off-by: Chengji Yao <chengjiyao@google.com>\nSigned-off-by: luka <luka@neuralmagic.com>\nSigned-off-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nSigned-off-by: vincent-pli <justdoit.pli@gmail.com>\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nSigned-off-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Aaron Pham <contact@aarnphm.xyz>\nSigned-off-by: Jeremy Arnold <Jeremy.Arnold@amd.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Yarong Mu <ymu@google.com>\nSigned-off-by: Mathis Felardos <mathis@mistral.ai>\nSigned-off-by: Aviv Keshet <akeshet@scaledcognition.com>\nSigned-off-by: Roger Meier <r.meier@siemens.com>\nSigned-off-by: WangErXiao <863579016@qq.com>\nSigned-off-by: Alexander Matveev <amatveev@redhat.com>\nSigned-off-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nSigned-off-by: YaoJiayi <120040070@link.cuhk.edu.cn>\nSigned-off-by: Yuchen Yan <740987012@qq.com>\nSigned-off-by: Martin Hoyer <mhoyer@redhat.com>\nSigned-off-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nSigned-off-by: chaunceyjiang <chaunceyjiang@gmail.com>\nSigned-off-by: SzymonOzog <szymon.ozog@aleph-alpha.com>\nSigned-off-by: SzymonOzog <szymon.ozog@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nCo-authored-by: Qubitium-ModelCloud <qubitium@modelcloud.ai>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: iefgnoix <isaacwxf23@gmail.com>\nCo-authored-by: Travis Johnson <tsjohnso@us.ibm.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Zhanwen Chen <phil.zhanwen.chen@gmail.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: lkchen <github@lkchen.net>\nCo-authored-by: kushanam <42385577+kushanam@users.noreply.github.com>\nCo-authored-by: Siyuan Liu <lsiyuan@google.com>\nCo-authored-by: Kuntai Du <kuntai@uchicago.edu>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: rainkert <93575312+rainkert@users.noreply.github.com>\nCo-authored-by: dangshunya <dangshunya@baichuan-inc.com>\nCo-authored-by: Congcong Chen <congcongchen@microsoft.com>\nCo-authored-by: Benjamin Chislett <benjamin.chislett@centml.ai>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Iacopo Poli <iacopo@lighton.ai>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Zhe Zhang <zhz@apache.org>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: DaividFrank <49250948+DaividFrank@users.noreply.github.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Vincent <vincentzhongy+githubvincent4@gmail.com>\nCo-authored-by: Brayden Zhong <b8zhong@uwaterloo.ca>\nCo-authored-by: Ye Cao <caoye.cao@alibaba-inc.com>\nCo-authored-by: Serena <yangsijia.614@bytedance.com>\nCo-authored-by: pyc96 <pychen96@gmail.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Ying Zhong <zhongyingmatrix@gmail.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: Ce Gao <cegao@tensorchord.ai>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: Pavani Majety <pmajety@nvidia.com>\nCo-authored-by: kYLe <kylhuang@nvidia.com>\nCo-authored-by: NickLucche <nick@nlucches-4xa100.c.openshift-330514.internal>\nCo-authored-by: Yanyi Liu <wolfsonliu@163.com>\nCo-authored-by: Irina Yuryeva <76484191+upayuryeva@users.noreply.github.com>\nCo-authored-by: Thomas Parnell <tpa@zurich.ibm.com>\nCo-authored-by: courage17340 <courage17340@users.noreply.github.com>\nCo-authored-by: Jitse Klomp <jitse.klomp@conclusionxforce.nl>\nCo-authored-by: Dilip Gowda Bhagavan <110233170+dilipgb@users.noreply.github.com>\nCo-authored-by: Rishika Kedia <rishika.kedia@in.ibm.com>\nCo-authored-by: Burkhard Ringlein <ngl@zurich.ibm.com>\nCo-authored-by: Jan van Lunteren <jvl@zurich.ibm.com>\nCo-authored-by: Himanshu Jaju <hj@mistral.ai>\nCo-authored-by: Chengji Yao <chengjiyao@google.com>\nCo-authored-by: Daniel Li <dyli@google.com>\nCo-authored-by: Luka GovediÄ <ProExpertProg@users.noreply.github.com>\nCo-authored-by: Ilya Lavrenov <ilya.lavrenov@intel.com>\nCo-authored-by: Peng Li <justdoit.pli@gmail.com>\nCo-authored-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: root <root@banff-cyxtera-s73-5.ctr.dcgpu>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aaron Pham <contact@aarnphm.xyz>\nCo-authored-by: York-RDWang <103811994+York-RDWang@users.noreply.github.com>\nCo-authored-by: Jeremy Arnold <103538711+JArnoldAMD@users.noreply.github.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: yarongmu-google <150371854+yarongmu-google@users.noreply.github.com>\nCo-authored-by: afeldman-nm <156691304+afeldman-nm@users.noreply.github.com>\nCo-authored-by: Mathis Felardos <mathis@mistral.ai>\nCo-authored-by: Aviv Keshet <akeshet@scaledcognition.com>\nCo-authored-by: Roger Meier <r.meier@siemens.com>\nCo-authored-by: Robin <863579016@qq.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-redhat@users.noreply.github.com>\nCo-authored-by: 22quinn <33176974+22quinn@users.noreply.github.com>\nCo-authored-by: Roger Wang <ywang@roblox.com>\nCo-authored-by: Jiayi Yao <82156730+YaoJiayi@users.noreply.github.com>\nCo-authored-by: Yuchen Yan <50619811+yanyc428@users.noreply.github.com>\nCo-authored-by: Martin Hoyer <mhoyer@redhat.com>\nCo-authored-by: Jennifer Zhao <JenZhao@users.noreply.github.com>\nCo-authored-by: Jennifer Zhao <7443418+JenZhao@users.noreply.github.com>\nCo-authored-by: Chauncey <chaunceyjiang@gmail.com>\nCo-authored-by: Szymon OÅ¼Ã³g <58388001+SzymonOzog@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Mcirino1 <57415822+Mcirino1@users.noreply.github.com>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 ) â€¦ 553034e Signed-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Kernel] Optimize moe intermediate_cache usage ( vllm-project#13625 ) â€¦ a0341c1 Signed-off-by: mgoin <mgoin64@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:21", "has_lm_eval": true, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "LM_EVAL: gsm8k | PERF: throughput, Improvement, improvement | SERVING: Frontend, Frontend, Frontend | TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:52:21", "models": ["deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct", "deepseek-ai/DeepSeek-V3", "deepseek-ai/DeepSeek-R1"], "lm_eval_commands": null, "perf_command": "python moe_mem.py", "commit_subject": "[Kernel] Optimize moe intermediate_cache usage (#13625)", "commit_message": "[Kernel] Optimize moe intermediate_cache usage (#13625)\n\nSigned-off-by: mgoin <mgoin64@gmail.com>", "commit_date": "2025-03-03T16:29:53-05:00", "files_changed": ["vllm/model_executor/layers/fused_moe/fused_moe.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 1, "num_edited_lines": 17, "num_non_test_edited_lines": 17, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/fused_moe/fused_moe.py b/vllm/model_executor/layers/fused_moe/fused_moe.py\nindex 00260313e..5336b3c10 100644\n--- a/vllm/model_executor/layers/fused_moe/fused_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/fused_moe.py\n@@ -1240,15 +1240,20 @@ def fused_experts_impl(hidden_states: torch.Tensor,\n \n     config = get_config_func(M)\n \n-    intermediate_cache1 = torch.empty((M, top_k_num, N),\n-                                      device=hidden_states.device,\n-                                      dtype=hidden_states.dtype)\n+    # We can reuse the memory between these because by the time we need\n+    # cache3, we're done with cache1\n+    cache13 = torch.empty(M * top_k_num * max(N, w2.shape[1]),\n+                          device=hidden_states.device,\n+                          dtype=hidden_states.dtype)\n+    intermediate_cache1 = cache13[:M * top_k_num * N].view(\n+        (M, topk_ids.shape[1], N))\n+    intermediate_cache3 = cache13[:M * top_k_num * w2.shape[1]].view(\n+        (M, topk_ids.shape[1], w2.shape[1]))\n+\n+    # This needs separate memory since it's used concurrently with cache1\n     intermediate_cache2 = torch.empty((M * top_k_num, N // 2),\n                                       device=hidden_states.device,\n                                       dtype=hidden_states.dtype)\n-    intermediate_cache3 = torch.empty((M, top_k_num, w2.shape[1]),\n-                                      device=hidden_states.device,\n-                                      dtype=hidden_states.dtype)\n \n     if hidden_states.dtype == torch.bfloat16:\n         compute_type = tl.bfloat16", "apis": ["torch.ops.vllm.inplace_fused_experts", "torch.ops.vllm.outplace_fused_experts"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/fused_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a source file (fused_moe.py) in the core functionality (non-test file) where memory allocation for intermediate cache tensors is being optimized by reusing memory (combining cache1 and cache3 into a single memory allocation when possible). This change is non-trivial and directly targets performance (reducing memory allocation overhead) without merely being a cosmetic or refactoring change. The optimization applies to CPU-bound operations and is not specific to any GPU/TPU or hardware-specific environment. Therefore, the commit satisfies the conditions for being performance/optimization related.", "llm_api_reason": "The commit optimizes how temporary memory is allocated for the fused MoE kernel. Instead of separately creating two buffers for â€œintermediate_cache1â€ and â€œintermediate_cache3â€, a single contiguous memory region (â€œcache13â€) is allocated and then partitioned and reshaped to serve as both caches. This change occurs in the internal function fused_experts_impl within the fused MoE layer. Because this kernel is registered as custom torch ops â€“ namely â€œinplace_fused_expertsâ€ and â€œoutplace_fused_expertsâ€ â€“ any Python call that ends up dispatching to these custom ops (or to the wrapper function fused_experts) will now use the optimized memory reuse logic."}
{"commit_hash": "e206b5433109d298e53451015465b2bf8f03ef0a", "pr_url": "https://github.com/vllm-project/vllm/pull/13837", "pr_date": "2025-02-25", "timeline_text": "Copy link Contributor sethkimmel3 commented Feb 25, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . The deepcopy introduced in #11637 adds a lot of overhead when adding a large number of requests to an llm_engine . This adds a more efficient method of copying the XGrammarLogitsProcessor data structure to remove that overhead. cc: @mgoin @aarnphm Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link github-actions bot commented Feb 25, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the structured-output label Feb 25, 2025 aarnphm reviewed Feb 25, 2025 View reviewed changes vllm/model_executor/guided_decoding/xgrammar_decoding.py Outdated Comment on lines 362 to 364 if hasattr(self, 'token_bitmask') and self.token_bitmask is not None: new_processor.token_bitmask = xgr.allocate_token_bitmask( self.batch_size, self.config.vocab_size) Copy link Collaborator aarnphm Feb 25, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment should it be Suggested change if hasattr ( self , 'token_bitmask' ) and self . token_bitmask is not None : new_processor . token_bitmask = xgr . allocate_token_bitmask ( self . batch_size , self . config . vocab_size ) if hasattr ( self , 'token_bitmask' ) and self . token_bitmask is not None : new_processor . token_bitmask = self . token_bitmask Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions aarnphm approved these changes Feb 25, 2025 View reviewed changes Copy link Collaborator aarnphm left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment one tiny comment, if it passes the tests then LGTM. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator aarnphm commented Feb 25, 2025 @sethkimmel3 there are a few pre-commit problem can you fix this? thanks. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . sethkimmel3 added 5 commits February 25, 2025 10:43 clone test â€¦ 4f8265e Signed-off-by: Seth Kimmel <seth.kimmel3@gmail.com> replace deepcopy â€¦ fbe5acf Signed-off-by: Seth Kimmel <seth.kimmel3@gmail.com> ruff and small tweak â€¦ bf10cbc Signed-off-by: Seth Kimmel <seth.kimmel3@gmail.com> update â€¦ 2c1a699 Signed-off-by: Seth Kimmel <seth.kimmel3@gmail.com> lint â€¦ 11b4114 Signed-off-by: Seth Kimmel <seth.kimmel3@gmail.com> sethkimmel3 force-pushed the clone-test branch\n    from a19541b to 11b4114 Compare February 25, 2025 18:43 Copy link Collaborator aarnphm commented Feb 25, 2025 I cant update the title, but can you make it to [v0][Core] Use shared context to avoid copy overhead for offline engine otherwise I think this should be ready to bring out of draft All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . sethkimmel3 changed the title Replace xgrammar deepcopy [v0][Core] Use shared context to avoid copy overhead for offline engine Feb 25, 2025 sethkimmel3 marked this pull request as ready for review February 25, 2025 18:49 sethkimmel3 requested a review\n  from mgoin as a code owner February 25, 2025 18:49 Copy link Contributor Author sethkimmel3 commented Feb 25, 2025 Done and done @aarnphm ! All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin changed the title [v0][Core] Use shared context to avoid copy overhead for offline engine [v0][Core] Use xgrammar shared context to avoid copy overhead for offline engine Feb 25, 2025 mgoin approved these changes Feb 25, 2025 View reviewed changes mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Feb 25, 2025 Copy link Collaborator aarnphm commented Feb 25, 2025 Thanks. Once all PR pass we can merge this All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details DarkLight1337 merged commit e206b54 into vllm-project : main Feb 26, 2025 56 of 58 checks passed Uh oh! There was an error while loading. Please reload this page . Akshat-Tripathi pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Mar 3, 2025 [v0][Core] Use xgrammar shared context to avoid copy overhead for offâ€¦ â€¦ 77ca08e â€¦line engine ( vllm-project#13837 )\n\nSigned-off-by: Seth Kimmel <seth.kimmel3@gmail.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [v0][Core] Use xgrammar shared context to avoid copy overhead for offâ€¦ â€¦ c2d7cba â€¦line engine ( vllm-project#13837 )\n\nSigned-off-by: Seth Kimmel <seth.kimmel3@gmail.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [v0][Core] Use xgrammar shared context to avoid copy overhead for offâ€¦ â€¦ f4c2054 â€¦line engine ( vllm-project#13837 )\n\nSigned-off-by: Seth Kimmel <seth.kimmel3@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:25", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:52:25", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[v0][Core] Use xgrammar shared context to avoid copy overhead for offline engine (#13837)", "commit_message": "[v0][Core] Use xgrammar shared context to avoid copy overhead for offline engine (#13837)\n\nSigned-off-by: Seth Kimmel <seth.kimmel3@gmail.com>", "commit_date": "2025-02-26T14:58:24+08:00", "files_changed": ["vllm/model_executor/guided_decoding/xgrammar_decoding.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 26, "num_non_test_edited_lines": 26, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/guided_decoding/xgrammar_decoding.py b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\nindex 329b03a57..e6ba7f5ec 100644\n--- a/vllm/model_executor/guided_decoding/xgrammar_decoding.py\n+++ b/vllm/model_executor/guided_decoding/xgrammar_decoding.py\n@@ -3,7 +3,6 @@\n # noqa: UP007\n from __future__ import annotations\n \n-import copy\n import json\n import re\n from dataclasses import dataclass, field\n@@ -348,5 +347,26 @@ class XGrammarLogitsProcessor:\n         return scores\n \n     def clone(self) -> XGrammarLogitsProcessor:\n-        \"\"\"Deepcopy due to per-sequence state in the matchers\"\"\"\n-        return copy.deepcopy(self)\n+        \"\"\"Create a new instance with shared compiled grammar\n+          but separate state\"\"\"\n+        new_processor = XGrammarLogitsProcessor(self.config)\n+\n+        # Share the compiled grammar context (immutable after compilation)\n+        new_processor.ctx = self.ctx\n+\n+        # Create fresh matchers for the new sequence\n+        if self.ctx is not None:\n+            new_processor.matchers = [\n+                xgr.GrammarMatcher(self.ctx) for _ in range(self.batch_size)\n+            ]\n+\n+        # Create a new token bitmask with the same size\n+        if hasattr(self, 'token_bitmask') and self.token_bitmask is not None:\n+            new_processor.token_bitmask = self.token_bitmask\n+\n+        # Copy simple attributes\n+        new_processor.batch_size = self.batch_size\n+        # Reset prefilled state for new sequence\n+        new_processor.prefilled = False\n+\n+        return new_processor", "apis": ["vllm.model_executor.guided_decoding.xgrammar_decoding.XGrammarLogitsProcessor.clone"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/entrypoints/llm.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies a source code file (a non-test file) by replacing a deep copy operation with a more efficient instance creation that uses a shared compiled grammar context. This reduces copy overhead, which is a performance optimization. The change goes beyond refactoring or bug fixes, impacting the performance of the decoding process in a CPU-testable manner.", "llm_api_reason": "The commit refactors the clone() method in the XGrammarLogitsProcessor class so that instead of performing a full deep copy (and the overhead that comes with it), it now creates a new instance while sharing the compiled grammar context and reinitializing the sequence-specific state (matchers, prefilled flags, and token bitmask). This change optimizes cloning for offline engine inference without altering the external behavior of the processor."}
{"commit_hash": "6a417b8600d4d1e57698a91b71a38446e8fc5c45", "pr_url": "https://github.com/vllm-project/vllm/pull/13589", "pr_date": "2025-02-20", "timeline_text": "Copy link Contributor ajayvohra2005 commented Feb 20, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This fixes a Neuron specific performance issue. Without this fix, Neuron performance degrades quickly when number of concurrent requests >= max_num_seqs . Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions fix neuron performance issue 3aaf6a3 Copy link github-actions bot commented Feb 20, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator WoosukKwon commented Feb 20, 2025 cc @liangfu All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . liangfu approved these changes Feb 20, 2025 View reviewed changes Copy link Contributor liangfu left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment thanks for the fix Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details WoosukKwon merged commit 6a417b8 into vllm-project : main Feb 20, 2025 19 of 20 checks passed Uh oh! There was an error while loading. Please reload this page . Akshat-Tripathi pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Mar 3, 2025 fix neuron performance issue ( vllm-project#13589 ) 6b81301 lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 fix neuron performance issue ( vllm-project#13589 ) â€¦ 353aced Signed-off-by: Louis Ulmer <ulmerlouis@gmail.com> ckhordiasma mentioned this pull request Apr 17, 2025 [do not merge] pr test for nm changes into 2.20 red-hat-data-services/vllm#107 Closed shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 fix neuron performance issue ( vllm-project#13589 ) 500b058 liangfu mentioned this pull request May 14, 2025 Remove pre-emption logic for Neuron aws-neuron/upstreaming-to-vllm#17 Closed Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:28", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, test, CI", "analysis_extracted_at": "2025-09-07 17:52:28", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "fix neuron performance issue (#13589)", "commit_message": "fix neuron performance issue (#13589)", "commit_date": "2025-02-20T10:59:36-08:00", "files_changed": ["vllm/worker/neuron_worker.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 2, "num_edited_lines": 4, "num_non_test_edited_lines": 4, "commit_year": 2025}, "diff_text": "diff --git a/vllm/worker/neuron_worker.py b/vllm/worker/neuron_worker.py\nindex 5f0eb0019..95e7acd02 100644\n--- a/vllm/worker/neuron_worker.py\n+++ b/vllm/worker/neuron_worker.py\n@@ -76,7 +76,7 @@ class NeuronWorker(LoraNotSupportedWorkerBase, LocalOrDistributedWorkerBase):\n         # Set the number of GPU blocks to be the same as the maximum number of\n         # sequences that can be processed in a single batch. This is equivalent\n         # to schedule without PagedAttention.\n-        num_gpu_blocks = self.scheduler_config.max_num_seqs\n+        num_gpu_blocks = self.scheduler_config.max_num_seqs + 1\n \n         # Swap not yet supported with Neuron backend.\n         num_cpu_blocks = 0\n@@ -90,7 +90,7 @@ class NeuronWorker(LoraNotSupportedWorkerBase, LocalOrDistributedWorkerBase):\n \n         # Different values are not tested.\n         assert num_cpu_blocks == 0\n-        assert num_gpu_blocks == self.scheduler_config.max_num_seqs\n+        assert num_gpu_blocks == self.scheduler_config.max_num_seqs + 1\n \n         self.cache_config.num_gpu_blocks = num_gpu_blocks\n         self.cache_config.num_cpu_blocks = num_cpu_blocks", "apis": ["NeuronWorker.determine_num_available_blocks", "NeuronWorker.initialize_cache"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/neuron_worker.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/worker/neuron_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/platforms/neuron.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/examples/offline_inference/neuron.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/model_loader/neuron.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The patch modifies a non-test file (neuron_worker.py) where it changes the calculation of the number of GPU blocks by adding 1 to the maximum number of sequences. The commit message â€œfix neuron performance issueâ€ aligns with a performance-related change. The modification directly alters scheduling behavior for processing batches, which is likely to affect performance at runtime. There is a clear performance intention behind updating both the initialization and the assert statement checks. Therefore, the commit meets the conditions for being performance or optimization related.", "llm_api_reason": "The commit fixes a performance issue on the Neuron backend by adjusting the number of GPU KV cache blocks. Previously, the number was set equal to the maximum number of sequences, but now it is increased by 1. This change is reflected in both the determination of available blocks and the corresponding assertion in the cache initialization, which directly affects how NeuronWorker handles device memory and caching for inference."}
{"commit_hash": "0d243f2a54fbd1c56da8a571f0899c30b6aba5d9", "pr_url": "https://github.com/vllm-project/vllm/pull/13577", "pr_date": "2025-02-20", "timeline_text": "Copy link Contributor divakar-amd commented Feb 20, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Found better configs when comparing with rocm fork. The PR serves 2 purposes: Update with better config setting Maintain same configs b/w upstream and rocm fork Offline-latency numbers (sec) Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions update mixtral8x7B specific moe config bs perf â€¦ 44dd275 Signed-off-by: Divakar Verma <divakar.verma@amd.com> Copy link github-actions bot commented Feb 20, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . divakar-amd mentioned this pull request Feb 20, 2025 resolve configs diff for mixtral8x7B ROCm/vllm#437 Merged DarkLight1337 approved these changes Feb 20, 2025 View reviewed changes DarkLight1337 enabled auto-merge (squash) February 20, 2025 02:20 github-actions bot added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Feb 20, 2025 Hide details View details DarkLight1337 merged commit 0d243f2 into vllm-project : main Feb 20, 2025 61 checks passed Uh oh! There was an error while loading. Please reload this page . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Feb 20, 2025 [ROCm][MoE] mi300 mixtral8x7B perf for specific BS ( vllm-project#13577 ) â€¦ 1d993c1 Signed-off-by: Divakar Verma <divakar.verma@amd.com> Akshat-Tripathi pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Mar 3, 2025 [ROCm][MoE] mi300 mixtral8x7B perf for specific BS ( vllm-project#13577 ) â€¦ f684038 Signed-off-by: Divakar Verma <divakar.verma@amd.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [ROCm][MoE] mi300 mixtral8x7B perf for specific BS ( vllm-project#13577 ) â€¦ 2749bea Signed-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [ROCm][MoE] mi300 mixtral8x7B perf for specific BS ( vllm-project#13577 ) â€¦ 439c0ce Signed-off-by: Divakar Verma <divakar.verma@amd.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:30", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: latency | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:52:30", "models": ["mistralai/Mixtral-8x7B-Instruct-v0.1"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=mistralai/Mixtral-8x7B-Instruct-v0.1 --tasks gsm8k --batch_size auto"], "perf_command": "python benchmarks/benchmark_serving.py --model mistralai/Mixtral-8x7B-Instruct-v0.1", "commit_subject": "[ROCm][MoE] mi300 mixtral8x7B perf for specific BS (#13577)", "commit_message": "[ROCm][MoE] mi300 mixtral8x7B perf for specific BS (#13577)\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>", "commit_date": "2025-02-20T04:01:02Z", "files_changed": ["vllm/model_executor/layers/fused_moe/configs/E=8,N=14336,device_name=AMD_Instinct_MI300X.json", "vllm/model_executor/layers/fused_moe/configs/E=8,N=3584,device_name=AMD_Instinct_MI300X.json", "vllm/model_executor/layers/fused_moe/configs/E=8,N=7168,device_name=AMD_Instinct_MI300X.json"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 1, "num_files": 3, "num_hunks": 3, "num_edited_lines": 10, "num_non_test_edited_lines": 10, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/fused_moe/configs/E=8,N=14336,device_name=AMD_Instinct_MI300X.json b/vllm/model_executor/layers/fused_moe/configs/E=8,N=14336,device_name=AMD_Instinct_MI300X.json\nindex 66f9106bd..4bf775347 100644\n--- a/vllm/model_executor/layers/fused_moe/configs/E=8,N=14336,device_name=AMD_Instinct_MI300X.json\n+++ b/vllm/model_executor/layers/fused_moe/configs/E=8,N=14336,device_name=AMD_Instinct_MI300X.json\n@@ -45,8 +45,8 @@\n     },\n     \"16\": {\n         \"BLOCK_SIZE_M\": 16,\n-        \"BLOCK_SIZE_N\": 16,\n-        \"BLOCK_SIZE_K\": 256,\n+        \"BLOCK_SIZE_N\": 64,\n+        \"BLOCK_SIZE_K\": 64,\n         \"GROUP_SIZE_M\": 1,\n         \"num_warps\": 2,\n         \"num_stages\": 2,\ndiff --git a/vllm/model_executor/layers/fused_moe/configs/E=8,N=3584,device_name=AMD_Instinct_MI300X.json b/vllm/model_executor/layers/fused_moe/configs/E=8,N=3584,device_name=AMD_Instinct_MI300X.json\nindex ed5b655d8..5a3f415d5 100644\n--- a/vllm/model_executor/layers/fused_moe/configs/E=8,N=3584,device_name=AMD_Instinct_MI300X.json\n+++ b/vllm/model_executor/layers/fused_moe/configs/E=8,N=3584,device_name=AMD_Instinct_MI300X.json\n@@ -45,8 +45,8 @@\n     },\n     \"16\": {\n         \"BLOCK_SIZE_M\": 16,\n-        \"BLOCK_SIZE_N\": 32,\n-        \"BLOCK_SIZE_K\": 256,\n+        \"BLOCK_SIZE_N\": 64,\n+        \"BLOCK_SIZE_K\": 128,\n         \"GROUP_SIZE_M\": 1,\n         \"num_warps\": 2,\n         \"num_stages\": 2,\ndiff --git a/vllm/model_executor/layers/fused_moe/configs/E=8,N=7168,device_name=AMD_Instinct_MI300X.json b/vllm/model_executor/layers/fused_moe/configs/E=8,N=7168,device_name=AMD_Instinct_MI300X.json\nindex 822f04e33..8d7b78027 100644\n--- a/vllm/model_executor/layers/fused_moe/configs/E=8,N=7168,device_name=AMD_Instinct_MI300X.json\n+++ b/vllm/model_executor/layers/fused_moe/configs/E=8,N=7168,device_name=AMD_Instinct_MI300X.json\n@@ -128,7 +128,7 @@\n         \"num_warps\": 8,\n         \"num_stages\": 2,\n         \"waves_per_eu\": 0,\n-        \"matrix_instr_nonkdim\": 32,\n+        \"matrix_instr_nonkdim\": 16,\n         \"kpack\": 2\n     },\n     \"512\": {", "apis": ["vllm.fused_moe", "vllm.model_executor.layers.fused_moe.get_moe_configs", "vllm.model_executor.layers.fused_moe.invoke_fused_moe_kernel"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/rocm_aiter_fused_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/fused_moe.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/transformers_utils/config.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/models/config.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/config.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test configuration files, changing parameters like BLOCK_SIZE_N, BLOCK_SIZE_K, and matrix_instr_nonkdim in MoE layers. These changes adjust configuration values that directly influence the performance of the model executor on AMD hardware. The commit message and the parameter tuning indicate an intent to improve performance, rather than merely refactoring code, fixing bugs, or updating documentation. It directly targets performance optimization through effective parameter choices for specific hardware.", "llm_api_reason": "This commit only changes configuration JSON files for fused MoE kernels (found in the vllm/model_executor/layers/fused_moe/configs directory). These files contain tuning parameters (e.g. BLOCK_SIZE_N, BLOCK_SIZE_K, and matrix_instr_nonkdim) specifically adjusted for AMD MI300 models. Although no python code functions are directly modified, these configuration values affect the behavior of the fused MoE kernel when read and used by functions such as get_moe_configs, which in turn are used in fused_moe kernel invocations (for instance, via invoke_fused_moe_kernel and the topâ€level fused_moe API). Therefore, the affected highâ€level APIs are those that load and apply these configuration parameters for fused MoE execution."}
{"commit_hash": "4c822298981a8f7521492075ff72659985fc4c3f", "pr_url": "https://github.com/vllm-project/vllm/pull/13365", "pr_date": "2025-02-18", "timeline_text": "Copy link Collaborator WoosukKwon commented Feb 17, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . This PR optimizes the N-gram matching algorithm by JIT compiling it with Numba. I've observed 20-30x speedup with large batch sizes: For ShareGPT benchmark with 5K requests, the cumulative overhead reduces from 54.3 sec to 1.9 sec, which is ~2.5% of the entire running time. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸš€ 5 njhill, ywang96, LiuXiaoxuanPKU, michaelfeil, and mgoin reacted with rocket emoji All reactions ðŸš€ 5 reactions WoosukKwon added 9 commits February 15, 2025 12:54 [V1] Get input tokens from scheduler â€¦ 8406f11 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> fix â€¦ 0399f09 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into v1-scheduler-input 960964a fix â€¦ c54ff6c Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into v1-scheduler-input aa8ae69 comment â€¦ c833429 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> [V1][Spec decode] Move drafter to model runner â€¦ b42a16f Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into v1-spec-decode 5f13604 [V1][Spec Decode] Optimize N-gram matching with Numba â€¦ 490df6d Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Copy link github-actions bot commented Feb 17, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added ci/build v1 labels Feb 17, 2025 WoosukKwon added 4 commits February 17, 2025 11:18 Merge branch 'main' into v1-spec-decode 58e0856 Merge branch 'v1-spec-decode' into v1-spec-opt 85afbe6 Merge branch 'main' into v1-spec-opt 81456ab update â€¦ c632ad4 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> WoosukKwon marked this pull request as ready for review February 17, 2025 23:49 WoosukKwon requested review from robertgshaw2-redhat , njhill , ywang96 , comaniac and alexm-redhat as code owners February 17, 2025 23:49 WoosukKwon added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Feb 17, 2025 Copy link Collaborator Author WoosukKwon commented Feb 17, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . cc @LiuXiaoxuanPKU This PR is ready. Could you please take a look? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon added 4 commits February 17, 2025 15:54 minor â€¦ 524af01 Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Pin numba version â€¦ ca4458d Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Merge branch 'main' into v1-spec-opt 11cceb4 Initialize drafter only for last rank â€¦ 8de56ec Signed-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> LiuXiaoxuanPKU approved these changes Feb 18, 2025 View reviewed changes Copy link Collaborator LiuXiaoxuanPKU left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM, thanks! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Hide details View details WoosukKwon merged commit 4c82229 into main Feb 18, 2025 57 of 71 checks passed Uh oh! There was an error while loading. Please reload this page . WoosukKwon deleted the v1-spec-opt branch February 18, 2025 21:20 mgoin reviewed Feb 18, 2025 View reviewed changes requirements-common.txt @@ -1,6 +1,7 @@ psutil sentencepiece  # Required for LLaMA tokenizer. numpy < 2.0.0 numba == 0.60.0 # v0.61 doesn't support Python 3.9. Required for N-gram speculative decoding. Copy link Member mgoin Feb 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Shouldn't this be in requirements-cuda.txt rather than common? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author WoosukKwon Feb 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Oh I'm ok with either; I just thought it would be eventually used by others as well. Please feel free to submit a PR to move it to requirements-cuda.txt and probably requirements-rocm.txt . Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor michaelfeil commented Feb 19, 2025 Very excited about this! ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author WoosukKwon commented Feb 19, 2025 @michaelfeil Thanks! Happy to see you again :) We still have some headroom for performance: #13498 Please let us know if you are interested in working on this. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Feb 20, 2025 [V1][Spec Decode] Optimize N-gram matching with Numba ( vllm-project#1â€¦ â€¦ 0c8d213 â€¦3365 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Akshat-Tripathi pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Mar 3, 2025 [V1][Spec Decode] Optimize N-gram matching with Numba ( vllm-project#1â€¦ â€¦ 1104f29 â€¦3365 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [V1][Spec Decode] Optimize N-gram matching with Numba ( vllm-project#1â€¦ â€¦ 3b3b1db â€¦3365 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [V1][Spec Decode] Optimize N-gram matching with Numba ( vllm-project#1â€¦ â€¦ 0497603 â€¦3365 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:34", "has_lm_eval": false, "has_performance": true, "has_serving": false, "has_general_test": true, "test_details": "PERF: speedup | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:52:34", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1][Spec Decode] Optimize N-gram matching with Numba (#13365)", "commit_message": "[V1][Spec Decode] Optimize N-gram matching with Numba (#13365)\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>", "commit_date": "2025-02-18T13:19:58-08:00", "files_changed": ["requirements-common.txt", "vllm/v1/spec_decode/ngram_proposer.py", "vllm/v1/worker/gpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 1, "num_files": 3, "num_hunks": 5, "num_edited_lines": 127, "num_non_test_edited_lines": 127, "commit_year": 2025}, "diff_text": "diff --git a/requirements-common.txt b/requirements-common.txt\nindex b7c94cbdb..c52980bc7 100644\n--- a/requirements-common.txt\n+++ b/requirements-common.txt\n@@ -1,6 +1,7 @@\n psutil\n sentencepiece  # Required for LLaMA tokenizer.\n numpy < 2.0.0\n+numba == 0.60.0 # v0.61 doesn't support Python 3.9. Required for N-gram speculative decoding.\n requests >= 2.26.0\n tqdm\n blake3\ndiff --git a/vllm/v1/spec_decode/ngram_proposer.py b/vllm/v1/spec_decode/ngram_proposer.py\nindex 9b116e00a..33289d05d 100644\n--- a/vllm/v1/spec_decode/ngram_proposer.py\n+++ b/vllm/v1/spec_decode/ngram_proposer.py\n@@ -1,14 +1,12 @@\n # SPDX-License-Identifier: Apache-2.0\n-from typing import List, Optional\n+from typing import Optional\n \n import numpy as np\n+from numba import jit\n \n \n class NgramProposer:\n \n-    def __init__(self):\n-        pass\n-\n     def propose(\n         self,\n         context_token_ids: np.ndarray,\n@@ -21,7 +19,7 @@ class NgramProposer:\n         that match.\n         \n         Args:\n-            context_token_ids: List of token IDs representing the \n+            context_token_ids: Numpy array of token IDs representing the \n                                context sequence.\n             n: Length of the n-gram to match.\n             k: Number of tokens follow the match. If there are less \n@@ -41,66 +39,65 @@ class NgramProposer:\n               followed that pattern. Here we will return [4,2,3] because \n               we only have three tokens after the match.\n         \"\"\"\n-        # TODO: Use c++ to implement the _find_subarray_kmp to\n-        # improve the efficiency\n-        return self._find_subarray_kmp(context_token_ids, n, k)\n+        return _find_subarray_kmp(context_token_ids, n, k)\n \n-    @staticmethod\n-    def _kmp_lps_array(pattern: List[int]) -> List[int]:\n-        \"\"\"\n-        Build the lps (longest proper prefix which is also suffix) \n-        array for the pattern.\n-        \"\"\"\n-        lps = [0] * len(pattern)\n-        prev_lps = 0  # length of the previous longest prefix suffix\n-        i = 1\n \n-        while i < len(pattern):\n-            if pattern[i] == pattern[prev_lps]:\n-                prev_lps += 1\n-                lps[i] = prev_lps\n-                i += 1\n+@jit(nopython=True)\n+def _kmp_lps_array(pattern: np.ndarray) -> np.ndarray:\n+    \"\"\"\n+    Build the lps (longest proper prefix which is also suffix) \n+    array for the pattern.\n+    \"\"\"\n+    lps = np.zeros(len(pattern), dtype=np.int32)\n+    prev_lps = 0  # length of the previous longest prefix suffix\n+    i = 1\n+\n+    while i < len(pattern):\n+        if pattern[i] == pattern[prev_lps]:\n+            prev_lps += 1\n+            lps[i] = prev_lps\n+            i += 1\n+        else:\n+            if prev_lps != 0:\n+                prev_lps = lps[prev_lps - 1]\n             else:\n-                if prev_lps != 0:\n-                    prev_lps = lps[prev_lps - 1]\n-                else:\n-                    lps[i] = 0\n-                    i += 1\n+                lps[i] = 0\n+                i += 1\n+    return lps\n \n-        return lps\n \n-    @staticmethod\n-    def _find_subarray_kmp(\n-        context_token_ids: np.ndarray,\n-        n: int,\n-        k: int,\n-    ) -> Optional[np.ndarray]:\n-        context_len = context_token_ids.shape[0]\n-        assert n > 0\n+@jit(nopython=True)\n+def _find_subarray_kmp(\n+    context_token_ids: np.ndarray,\n+    n: int,\n+    k: int,\n+) -> Optional[np.ndarray]:\n+    context_len = context_token_ids.shape[0]\n+    assert n > 0\n \n-        pattern = context_token_ids[-n:]\n-        # Precompute lps array for Y\n-        lps = NgramProposer._kmp_lps_array(pattern)\n+    pattern = context_token_ids[-n:]\n+    # Precompute lps array for Y\n+    lps = _kmp_lps_array(pattern)\n \n-        i = 0\n-        j = 0\n-        # -n because the last n tokens are used as pattern\n-        while i < context_len - n:\n-            if context_token_ids[i] == pattern[j]:\n-                i += 1\n-                j += 1\n+    i = 0\n+    j = 0\n+    # -n because the last n tokens are used as pattern\n+    while i < context_len - n:\n+        if context_token_ids[i] == pattern[j]:\n+            i += 1\n+            j += 1\n \n-                # If we have matched the entire Y\n-                if j == n:\n-                    # Found pattern in context, gather the next K elements\n-                    return context_token_ids[i:i + k]\n+            # If we have matched the entire Y\n+            if j == n:\n+                # Found pattern in context, gather the next K elements\n+                return context_token_ids[i:i + k]\n+        else:\n+            # Mismatch\n+            if j != 0:\n+                # Use the lps array to avoid re-checking elements\n+                j = lps[j - 1]\n             else:\n-                # Mismatch\n-                if j != 0:\n-                    # Use the lps array to avoid re-checking elements\n-                    j = lps[j - 1]\n-                else:\n-                    i += 1\n+                i += 1\n \n-        # Y not found\n-        return None\n+    # Y not found\n+    return None\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 0ecc00acc..31fe095a9 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -120,11 +120,20 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         # Set up speculative decoding.\n         self.use_spec_decode = False\n         if self.speculative_config:\n+            self.use_spec_decode = True\n+\n             # TODO: find a better way to check if we are using ngram.\n             assert self.speculative_config.ngram_prompt_lookup_min, \\\n                     \"Currently, only ngram spec decode is supported in V1.\"\n-            self.drafter = NgramProposer()\n-            self.use_spec_decode = True\n+            if get_pp_group().is_last_rank:\n+                self.drafter = NgramProposer()\n+                # Trigger Numba JIT compilation for N-gram proposer.\n+                # This usually takes less than 1 second.\n+                self.drafter.propose(\n+                    np.zeros(1024, dtype=np.int32),\n+                    self.speculative_config.ngram_prompt_lookup_min,\n+                    self.speculative_config.num_speculative_tokens,\n+                )\n \n         # Request states.\n         self.requests: Dict[str, CachedRequestState] = {}", "apis": ["vllm.v1.spec_decode.ngram_proposer.NgramProposer.propose", "vllm.v1.worker.GPUModelRunner.__init__"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/ngram_proposer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_model_runner.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/engine/llm_engine.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/engine/llm_engine.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit introduces performance improvements to the N-gram matching functionality by applying numba's JIT compilation to critical internal functions (_kmp_lps_array and _find_subarray_kmp), which are used in the NgramProposer. It modifies source code files (vllm/v1/spec_decode/ngram_proposer.py and vllm/v1/worker/gpu_model_runner.py) and adjusts dependency requirements (requirements-common.txt) by specifying an appropriate numba version. These changes are aimed at speeding up execution performance on CPU, and they are integrated into the core logic rather than being limited to tests, bugfixes, simple refactoring, or documentation updates. Thus, this commit meets the conditions for a performance optimization commit.", "llm_api_reason": "This commit updates the common requirements (pinning numba to version 0.60.0) and refactors the N-gram speculative decoding implementation. In the vllm/v1/spec_decode/ngram_proposer.py module the formerly inline KMP helper methods are replaced with Numba-accelerated functions (_kmp_lps_array and _find_subarray_kmp) and the propose() method is modified to call the global jitâ€compiled functions. In addition, the GPUModelRunner initialization now triggers a dummy call to NgramProposer.propose() (thus pre-compiling the Numba code) when speculative decoding is enabled."}
{"commit_hash": "30172b4947c52890b808c6da3a6c7580f55cbb74", "pr_url": "https://github.com/vllm-project/vllm/pull/13244", "pr_date": "2025-02-18", "timeline_text": "Copy link Member njhill commented Feb 13, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Move the current SamplingMetadata object to a field in the persistent batch, updated only when the batch changes rather than constructed every step Keep input_batch.req_ids sized to the number of requests in the batch, so that anywhere that iterates over it doesn't need to slice (copy) the list or keep track of the separate request count. It is still updated in-place Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction njhill requested review from WoosukKwon , robertgshaw2-redhat , ywang96 , comaniac and alexm-redhat as code owners February 13, 2025 23:29 Copy link github-actions bot commented Feb 13, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the v1 label Feb 13, 2025 njhill commented Feb 13, 2025 View reviewed changes vllm/v1/worker/gpu_input_batch.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented Feb 14, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @njhill . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Feb 14, 2025 [V1] Optimize handling of sampling metadata and req_ids list â€¦ 7d6ee8f - Move SamplingMetadata to a field in the persistent batch, updated only when the batch changes rather than constructed every step\n- Keep input_batch.req_ids sized to the number of requests in the batch, so that anywhere that iterates over it doesn't need to slice (copy) the list or keep track of the separate request count. It is still updated in-place\n\nSigned-off-by: Nick Hill <nhill@redhat.com> njhill force-pushed the sampler-streamline branch\n    from 2bcf20f to 7d6ee8f Compare February 14, 2025 16:27 mergify bot removed\n  the needs-rebase label Feb 14, 2025 Copy link Member Author njhill commented Feb 14, 2025 @WoosukKwon this is the first step, I am working on follow-on simplification for the penalty parameters, etc. ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon self-assigned this Feb 14, 2025 njhill added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Feb 14, 2025 Copy link Member Author njhill commented Feb 14, 2025 @WoosukKwon apologies, I am looking into the test failure. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . don't mutate \"constant\" sampling metadata tensors â€¦ 37d1f98 Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Member Author njhill commented Feb 14, 2025 @WoosukKwon the test failure should be fixed now... the shared apply penalties code was doing in-place unsqueezes on the sampling penalty tensors - which I think is a bad thing to do but didn't cause a problem before because we were passing new slices every step. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link mergify bot commented Feb 14, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @njhill . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added\n  the needs-rebase label Feb 14, 2025 Merge remote-tracking branch 'origin/main' into sampler-streamline â€¦ f354b07 # Conflicts:\n#\tvllm/v1/worker/gpu_input_batch.py mergify bot removed\n  the needs-rebase label Feb 15, 2025 Copy link Collaborator WoosukKwon commented Feb 15, 2025 Hi @njhill , do you mind if we merge #12193 first and review this PR? I'd like to prioritize the spec decode PR as it already got rebased many many times. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member Author njhill commented Feb 15, 2025 @WoosukKwon that's fine with me. â¤ï¸ 1 WoosukKwon reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . njhill added 4 commits February 14, 2025 21:49 simplify sampling metadata â€¦ 602d3b6 Signed-off-by: Nick Hill <nhill@redhat.com> Merge remote-tracking branch 'refs/remotes/origin/main' into sampler-â€¦ â€¦ 80eae4e â€¦streamline\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n# Conflicts:\n#\ttests/v1/worker/test_gpu_input_batch.py\n#\tvllm/v1/sample/sampler.py group stop_token_ids with min_tokens â€¦ 57cd611 Signed-off-by: Nick Hill <nhill@redhat.com> test updates â€¦ c7e2bfd Signed-off-by: Nick Hill <nhill@redhat.com> Copy link mergify bot commented Feb 16, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @njhill . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . 5 hidden items Load moreâ€¦ mergify bot removed\n  the needs-rebase label Feb 18, 2025 Some more small list/tuple optimizations; fix linting â€¦ d246ce5 Signed-off-by: Nick Hill <nhill@redhat.com> njhill commented Feb 18, 2025 View reviewed changes vllm/v1/request.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/core/scheduler.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Member Author njhill commented Feb 18, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . @WoosukKwon I have now rebased. #13360 partially overlaps with this (e,g. I simplified some of the min_tokens handling in this one but have refactored completely in the other one based on the new abstraction). But I think it would be fine to get this in first and I can rebase the other one if you're ok with that. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Small adjustment â€¦ 5e216c7 Signed-off-by: Nick Hill <nhill@redhat.com> njhill commented Feb 18, 2025 View reviewed changes vllm/v1/worker/gpu_model_runner.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . njhill commented Feb 18, 2025 View reviewed changes vllm/v1/worker/gpu_input_batch.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator WoosukKwon commented Feb 18, 2025 @njhill I'm not sure it's worthwhile to change from [] to () . I did a microbenchmark: N = 1024 x = [] # List start = time . perf_counter () for i in range ( N ): x . append ([]) end = time . perf_counter () print ( f\"list: { ( end - start ) * 1000 :.3f } ms\" ) y = [] # Tuple start = time . perf_counter () for i in range ( N ): y . append (()) end = time . perf_counter () print ( f\"tuple: { ( end - start ) * 1000 :.3f } ms\" ) I find that adding 1024 (maximum number of requests in the batch) empty lists only takes 80-90 us. While using tuple reduces this time to 30-40 us, I think the 50 us gap (in the worst case) cannot justify the extra complexity here. When the batch size is 32, the gap becomes even smaller (7 us vs 2 us). WDYT? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Fix rejection sampler test â€¦ b2a43ba Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Member Author njhill commented Feb 18, 2025 @WoosukKwon I agree it's not worth any extra complexity. Just might as well use () where it doesn't otherwise make any difference to the code. Let me check and revert where such changes were made.. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator WoosukKwon commented Feb 18, 2025 @njhill I think changing List to Sequence itself is increasing complexity? After that, we need to consider whether it's a tuple or list. I'd prefer to keep using List and [] if the performance is the only concern. ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Revert change related to list vs tuple â€¦ 2fbc6e1 Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Member Author njhill commented Feb 18, 2025 @WoosukKwon sure, let me revert those too. I think mostly we don't need to consider the tuple/list difference because these are args or fields that would be considered read-only. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Revert List->Sequence changes â€¦ 1b68e03 Signed-off-by: Nick Hill <nhill@redhat.com> Copy link Member Author njhill commented Feb 18, 2025 @WoosukKwon I need to fix up some of the gpu_model_runner tests, but I'll wait for your first review to make sure you are good with the changes overall before spending time on that. â¤ï¸ 1 WoosukKwon reacted with heart emoji All reactions â¤ï¸ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . WoosukKwon reviewed Feb 18, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Amazing. Looks much cleaner! ðŸ˜„ Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions vllm/v1/worker/gpu_model_runner.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/core/scheduler.py Comment on lines +198 to +200 del request.spec_token_ids[num_scheduled_spec_tokens:] scheduled_spec_decode_tokens[request.request_id] = ( request.spec_token_ids [:num_scheduled_spec_tokens] ) request.spec_token_ids) Copy link Collaborator WoosukKwon Feb 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment What is this change for? Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Member Author njhill Feb 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It avoids creating a new list, just trims the existing one down to num_scheduled_spec_tokens , since any later spec token ids are essentially discarded anyhow. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 WoosukKwon reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Collaborator WoosukKwon Feb 18, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Got it! Maybe worth a comment. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 njhill reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction vllm/v1/sample/metadata.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/worker/gpu_input_batch.py Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/worker/gpu_input_batch.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/worker/gpu_input_batch.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . vllm/v1/worker/gpu_input_batch.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . njhill added 2 commits February 18, 2025 07:51 Address review comments â€¦ 28a17ae Signed-off-by: Nick Hill <nhill@redhat.com> Fix up gpu_model_runner tests â€¦ 9250721 Signed-off-by: Nick Hill <nhill@redhat.com> WoosukKwon approved these changes Feb 18, 2025 View reviewed changes Copy link Collaborator WoosukKwon left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM! Very nice simplification! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Add comment â€¦ ce3c3f4 Signed-off-by: Nick Hill <nhill@redhat.com> Hide details View details njhill merged commit 30172b4 into vllm-project : main Feb 18, 2025 44 checks passed Uh oh! There was an error while loading. Please reload this page . njhill deleted the sampler-streamline branch February 18, 2025 20:15 xjpang pushed a commit\n        to xjpang/vllm\n      that referenced\n      this pull request Feb 20, 2025 [V1] Optimize handling of sampling metadata and req_ids list ( vllm-prâ€¦ â€¦ d54a1e9 â€¦oject#13244 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com> Akshat-Tripathi pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Mar 3, 2025 [V1] Optimize handling of sampling metadata and req_ids list ( vllm-prâ€¦ â€¦ d9b7062 â€¦oject#13244 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com> lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [V1] Optimize handling of sampling metadata and req_ids list ( vllm-prâ€¦ â€¦ be846f4 â€¦oject#13244 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [V1] Optimize handling of sampling metadata and req_ids list ( vllm-prâ€¦ â€¦ ff9b783 â€¦oject#13244 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:38", "has_lm_eval": false, "has_performance": false, "has_serving": false, "has_general_test": true, "test_details": "TEST: test, test, test", "analysis_extracted_at": "2025-09-07 17:52:38", "models": ["N/A"], "lm_eval_commands": null, "perf_command": null, "commit_subject": "[V1] Optimize handling of sampling metadata and req_ids list (#13244)", "commit_message": "[V1] Optimize handling of sampling metadata and req_ids list (#13244)\n\nSigned-off-by: Nick Hill <nhill@redhat.com>", "commit_date": "2025-02-18T12:15:33-08:00", "files_changed": ["tests/v1/sample/test_rejection_sampler.py", "tests/v1/sample/test_sampler.py", "tests/v1/worker/test_gpu_input_batch.py", "tests/v1/worker/test_gpu_model_runner.py", "vllm/model_executor/layers/utils.py", "vllm/v1/core/scheduler.py", "vllm/v1/sample/metadata.py", "vllm/v1/sample/ops/penalties.py", "vllm/v1/sample/ops/topk_topp_sampler.py", "vllm/v1/sample/rejection_sampler.py", "vllm/v1/sample/sampler.py", "vllm/v1/utils.py", "vllm/v1/worker/gpu_input_batch.py", "vllm/v1/worker/gpu_model_runner.py", "vllm/v1/worker/tpu_model_runner.py"], "functions_changed": [], "stats": {"num_test_files": 4, "num_non_test_files": 11, "only_test_files": 0, "only_non_test_files": 0, "num_files": 15, "num_hunks": 74, "num_edited_lines": 553, "num_non_test_edited_lines": 420, "commit_year": 2025}, "diff_text": "diff --git a/tests/v1/sample/test_rejection_sampler.py b/tests/v1/sample/test_rejection_sampler.py\nindex 8bc33e841..3e810e525 100644\n--- a/tests/v1/sample/test_rejection_sampler.py\n+++ b/tests/v1/sample/test_rejection_sampler.py\n@@ -26,17 +26,13 @@ def create_logits_tensor(token_ids: List[int],\n def create_sampling_metadata(spec_tokens: List[List[int]]) -> SamplingMetadata:\n     batch_size = len(spec_tokens)\n     return SamplingMetadata(\n-        temperature=0.0,\n+        temperature=torch.tensor([]),\n         all_greedy=True,\n         all_random=False,\n-        rejection_sampling=True,\n         spec_token_ids=spec_tokens,\n         top_p=None,\n         top_k=None,\n-        no_top_p=False,\n-        no_top_k=False,\n         min_p=torch.empty(batch_size, ),\n-        no_min_p=True,\n         generators={},\n         max_num_logprobs=0,\n         no_penalties=False,\n@@ -45,8 +41,7 @@ def create_sampling_metadata(spec_tokens: List[List[int]]) -> SamplingMetadata:\n         presence_penalties=torch.tensor([]),\n         repetition_penalties=torch.tensor([]),\n         output_token_ids=[],\n-        min_tokens=[],\n-        stop_token_ids=[],\n+        min_tokens={},\n         logit_bias=[None] * batch_size,\n     )\n \ndiff --git a/tests/v1/sample/test_sampler.py b/tests/v1/sample/test_sampler.py\nindex a4bd651f8..3f6301c54 100644\n--- a/tests/v1/sample/test_sampler.py\n+++ b/tests/v1/sample/test_sampler.py\n@@ -77,25 +77,20 @@ def _create_default_sampling_metadata(\n         temperature=torch.full((batch_size, ), 0.0),\n         all_greedy=True,\n         all_random=False,\n-        rejection_sampling=False,\n-        top_p=torch.empty(batch_size, ),\n-        top_k=torch.empty(batch_size, ),\n-        no_top_p=True,\n-        no_top_k=True,\n-        min_p=torch.empty(batch_size, ),\n-        no_min_p=True,\n+        top_p=None,\n+        top_k=None,\n+        min_p=None,\n         generators={},\n         max_num_logprobs=0,\n         prompt_token_ids=_create_prompt_tokens_tensor(prompt_token_ids,\n                                                       vocab_size, device),\n         output_token_ids=output_token_ids,\n-        spec_token_ids=[],\n+        spec_token_ids=None,\n         frequency_penalties=_create_penalty_tensor(batch_size, 0.0, device),\n         presence_penalties=_create_penalty_tensor(batch_size, 0.0, device),\n         repetition_penalties=_create_penalty_tensor(batch_size, 1.0, device),\n         no_penalties=True,\n-        min_tokens=[],\n-        stop_token_ids=[],\n+        min_tokens={},\n         logit_bias=[None] * batch_size,\n     )\n     return fake_sampling_metadata\n@@ -104,10 +99,10 @@ def _create_default_sampling_metadata(\n def _generate_min_token_penalties_and_stop_tokens(\n     num_output_tokens: int, batch_size: int, vocab_size: int,\n     batch_indices_for_min_token_penalty: List[int]\n-) -> Tuple[List[int], List[Set[int]]]:\n+) -> Dict[int, Tuple[int, Set[int]]]:\n     \"\"\"\n-    Generates and returns a list of minimum token penalties (`min_tokens`)\n-    and a corresponding list of stop token IDs (`stop_token_ids`) for each\n+    Generates and returns a dict of minimum token penalties and\n+    corresponding stop token IDs (`min_tokens`, `stop_token_ids`) for each\n     batch.\n \n     If a batch index is included in `batch_indices_for_min_token_penalty`,\n@@ -115,22 +110,19 @@ def _generate_min_token_penalties_and_stop_tokens(\n     and a random set of stop token IDs is created. Otherwise, a lower\n     `min_tokens` value is assigned, and the stop token IDs set is empty.\n     \"\"\"\n-    stop_token_ids: List[Set[int]] = []\n-    min_tokens: List[int] = []\n+    min_tokens: Dict[int, Tuple[int, Set[int]]] = {}\n     for index in range(batch_size):\n         if index in batch_indices_for_min_token_penalty:\n-            min_tokens.append(\n+            min_tokens[index] = (\n                 np.random.randint(num_output_tokens + 1,\n-                                  2 * num_output_tokens))\n-            stop_token_ids.append(\n+                                  2 * num_output_tokens),\n                 set(\n                     np.random.randint(0, vocab_size - 1)\n                     for _ in range(np.random.randint(0, vocab_size))))\n-\n         else:\n-            min_tokens.append(np.random.randint(0, num_output_tokens))\n-            stop_token_ids.append(set())\n-    return (min_tokens, stop_token_ids)\n+            min_tokens[index] = (np.random.randint(0,\n+                                                   num_output_tokens), set())\n+    return min_tokens\n \n \n def _create_weighted_output_token_list(\n@@ -165,7 +157,7 @@ def _create_weighted_output_token_list(\n             output_token_ids_for_batch.extend(\n                 [token_id for _ in range(index + 1)])\n         output_token_ids.append(output_token_ids_for_batch)\n-    return (output_token_ids, sorted_token_ids_in_output)\n+    return output_token_ids, sorted_token_ids_in_output\n \n \n @pytest.mark.parametrize(\"device\", CUDA_DEVICES)\n@@ -182,17 +174,17 @@ def test_sampler_min_tokens_penalty(device: str, batch_size: int):\n         NUM_OUTPUT_TOKENS, batch_size, VOCAB_SIZE, torch.device(device))\n     batch_indices_for_min_token_penalty = np.random.randint(\n         0, batch_size - 1, size=np.random.randint(0, batch_size)).tolist()\n-    min_tokens, stop_token_ids = _generate_min_token_penalties_and_stop_tokens(\n+    min_tokens = _generate_min_token_penalties_and_stop_tokens(\n         NUM_OUTPUT_TOKENS, batch_size, VOCAB_SIZE,\n         batch_indices_for_min_token_penalty)\n     sampling_metadata.min_tokens = min_tokens\n-    sampling_metadata.stop_token_ids = stop_token_ids\n     sampler = Sampler()\n     logits = sampler.apply_penalties(fake_logits, sampling_metadata)\n     logits = logits.cpu()\n     for batch_idx in range(batch_size):\n         for token_id in range(VOCAB_SIZE):\n-            if token_id in stop_token_ids[batch_idx]:\n+            _, stop_token_ids = min_tokens.get(batch_idx, (0, set()))\n+            if token_id in stop_token_ids:\n                 assert logits[batch_idx][token_id] == -float(\"inf\")\n             else:\n                 assert logits[batch_idx][token_id] != -float(\"inf\")\ndiff --git a/tests/v1/worker/test_gpu_input_batch.py b/tests/v1/worker/test_gpu_input_batch.py\nindex c0ab356f5..cb3b3d21f 100644\n--- a/tests/v1/worker/test_gpu_input_batch.py\n+++ b/tests/v1/worker/test_gpu_input_batch.py\n@@ -1,6 +1,6 @@\n # SPDX-License-Identifier: Apache-2.0\n \n-from typing import Dict, List, Set, Tuple\n+from typing import Dict, List, Optional, Set, Tuple\n \n import numpy as np\n import pytest\n@@ -41,7 +41,7 @@ def _remove_requests(\n     for index in req_indices_to_remove:\n         input_batch.remove_request(reqs[index].req_id)\n         req_ids_to_remove.add(reqs[index].req_id)\n-    return (req_ids_to_remove, req_indices_to_remove_list)\n+    return req_ids_to_remove, req_indices_to_remove_list\n \n \n def _construct_expected_sampling_metadata(\n@@ -64,8 +64,7 @@ def _construct_expected_sampling_metadata(\n     top_p = [0.0 for _ in range(num_reqs)]\n     min_p = [0.0 for _ in range(num_reqs)]\n     temperature = [0.0 for _ in range(num_reqs)]\n-    stop_token_ids: List[Set[int]] = [set() for _ in range(num_reqs)]\n-    min_tokens = [0 for _ in range(num_reqs)]\n+    min_tokens = {}\n     logit_bias = [None] * num_reqs\n     for req in reqs:\n         if req.req_id not in req_ids_retained:\n@@ -83,22 +82,21 @@ def _construct_expected_sampling_metadata(\n         top_p[index_in_input_batch] = req.sampling_params.top_p\n         min_p[index_in_input_batch] = req.sampling_params.min_p\n         temperature[index_in_input_batch] = req.sampling_params.temperature\n-        stop_token_ids[\n-            index_in_input_batch] = req.sampling_params.all_stop_token_ids\n-        min_tokens[index_in_input_batch] = req.sampling_params.min_tokens\n+        min_tokens[index_in_input_batch] = (\n+            req.sampling_params.min_tokens,\n+            req.sampling_params.all_stop_token_ids)\n         logit_bias[index_in_input_batch] = req.sampling_params.logit_bias\n     return SamplingMetadata(\n         temperature=torch.tensor(temperature, dtype=torch.float,\n                                  device=device),\n         all_greedy=False,\n         all_random=True,\n-        rejection_sampling=False,\n-        top_p=torch.tensor(top_p, dtype=torch.float, device=device),\n-        top_k=torch.tensor(top_k, dtype=torch.int, device=device),\n-        no_top_p=all(x == 1.0 for x in top_p),\n-        no_top_k=all(x == 0 for x in top_k),\n-        min_p=torch.tensor(min_p, dtype=torch.float, device=device),\n-        no_min_p=all(x == 0.0 for x in min_p),\n+        top_p=None if all(x == 1.0 for x in top_p) else torch.tensor(\n+            top_p, dtype=torch.float, device=device),\n+        top_k=None if all(x == 0 for x in top_k) else torch.tensor(\n+            top_k, dtype=torch.int, device=device),\n+        min_p=None if all(x == 0.0 for x in min_p) else torch.tensor(\n+            min_p, dtype=torch.float, device=device),\n         generators={},\n         max_num_logprobs=0,\n         prompt_token_ids=make_tensor_with_pad(\n@@ -117,9 +115,8 @@ def _construct_expected_sampling_metadata(\n                                           dtype=torch.float,\n                                           device=device),\n         output_token_ids=output_token_ids,\n-        spec_token_ids=[],\n+        spec_token_ids=None,\n         min_tokens=min_tokens,\n-        stop_token_ids=stop_token_ids,\n         no_penalties=(all(x == 0 for x in presence_penalties)\n                       and all(x == 0 for x in frequency_penalties)\n                       and all(x == 1 for x in repetition_penalties)),\n@@ -206,8 +203,7 @@ def test_sampling_metadata_in_input_batch(device: str, batch_size: int):\n     input_batch.condense(req_indices_to_remove)\n \n     # Generate the sampling metadata\n-    sampling_metadata = input_batch.make_sampling_metadata(\n-        req_id_output_token_ids, req_id_to_spec_token_ids={}, skip_copy=False)\n+    sampling_metadata = input_batch._make_sampling_metadata()\n \n     # Create expected output.\n     expected_sampling_metadata = _construct_expected_sampling_metadata(\n@@ -216,13 +212,16 @@ def test_sampling_metadata_in_input_batch(device: str, batch_size: int):\n         input_batch.req_id_to_index,\n         device=torch.device(device))\n \n+    def same(t1: Optional[torch.Tensor], t2: Optional[torch.Tensor]) -> bool:\n+        return (t1 is None\n+                and t2 is None) or (t1 is not None and t2 is not None\n+                                    and torch.allclose(t1, t2))\n+\n     # Assert the actual and expected output.\n     assert torch.allclose(expected_sampling_metadata.temperature,\n                           sampling_metadata.temperature)\n-    assert torch.allclose(expected_sampling_metadata.top_p,\n-                          sampling_metadata.top_p)\n-    assert torch.allclose(expected_sampling_metadata.top_k,\n-                          sampling_metadata.top_k)\n+    assert same(expected_sampling_metadata.top_p, sampling_metadata.top_p)\n+    assert same(expected_sampling_metadata.top_k, sampling_metadata.top_k)\n     assert torch.allclose(\n         expected_sampling_metadata.frequency_penalties,\n         sampling_metadata.frequency_penalties,\n@@ -240,10 +239,6 @@ def test_sampling_metadata_in_input_batch(device: str, batch_size: int):\n     assert (expected_sampling_metadata.output_token_ids ==\n             sampling_metadata.output_token_ids)\n     assert expected_sampling_metadata.min_tokens == sampling_metadata.min_tokens\n-    assert expected_sampling_metadata.stop_token_ids == \\\n-           sampling_metadata.stop_token_ids\n     assert expected_sampling_metadata.no_penalties == \\\n            sampling_metadata.no_penalties\n-    assert expected_sampling_metadata.no_top_p == sampling_metadata.no_top_p\n-    assert expected_sampling_metadata.no_top_k == sampling_metadata.no_top_k\n     assert expected_sampling_metadata.logit_bias == sampling_metadata.logit_bias\ndiff --git a/tests/v1/worker/test_gpu_model_runner.py b/tests/v1/worker/test_gpu_model_runner.py\nindex c655b0fde..973efcbf8 100644\n--- a/tests/v1/worker/test_gpu_model_runner.py\n+++ b/tests/v1/worker/test_gpu_model_runner.py\n@@ -5,6 +5,7 @@ from vllm.config import CacheConfig, ModelConfig, SchedulerConfig, VllmConfig\n from vllm.sampling_params import SamplingParams\n from vllm.v1.core.scheduler_output import (CachedRequestData, NewRequestData,\n                                            SchedulerOutput)\n+from vllm.v1.sample.metadata import SamplingMetadata\n from vllm.v1.worker.gpu_model_runner import GPUModelRunner\n \n \n@@ -82,14 +83,21 @@ def _is_req_added(model_runner, req_id: str) -> bool:\n     return req_id in model_runner.requests\n \n \n+def _is_sampling_metadata_changed(model_runner,\n+                                  sampling_metadata_before: SamplingMetadata):\n+    return model_runner.input_batch.sampling_metadata is not (\n+        sampling_metadata_before)\n+\n+\n def test_update_states_new_request(model_runner):\n     req_id = \"req_0\"\n \n     # new req\n     scheduler_output = _schedule_new_request(req_id)\n \n-    batch_changed = model_runner._update_states(scheduler_output)\n-    assert batch_changed is True\n+    metadata_before = model_runner.input_batch.sampling_metadata\n+    model_runner._update_states(scheduler_output)\n+    assert _is_sampling_metadata_changed(model_runner, metadata_before)\n     assert _is_req_added(model_runner, req_id)\n     assert _is_req_scheduled(model_runner, req_id)\n \n@@ -117,8 +125,9 @@ def test_update_states_request_finished(model_runner):\n         free_encoder_input_ids=[],\n     )\n \n-    batch_changed = model_runner._update_states(scheduler_output)\n-    assert batch_changed is True\n+    metadata_before = model_runner.input_batch.sampling_metadata\n+    model_runner._update_states(scheduler_output)\n+    assert _is_sampling_metadata_changed(model_runner, metadata_before)\n     assert not _is_req_added(model_runner, req_id)\n     assert not _is_req_scheduled(model_runner, req_id)\n \n@@ -142,7 +151,7 @@ def test_update_states_request_resumed(model_runner):\n         scheduled_spec_decode_tokens={},\n         scheduled_encoder_inputs={},\n         num_common_prefix_blocks=0,\n-        finished_req_ids={},\n+        finished_req_ids=set(),\n         free_encoder_input_ids=[],\n     )\n \n@@ -171,8 +180,9 @@ def test_update_states_request_resumed(model_runner):\n         free_encoder_input_ids=[],\n     )\n \n-    batch_changed = model_runner._update_states(scheduler_output)\n-    assert batch_changed is True\n+    metadata_before = model_runner.input_batch.sampling_metadata\n+    model_runner._update_states(scheduler_output)\n+    assert _is_sampling_metadata_changed(model_runner, metadata_before)\n     assert _is_req_added(model_runner, req_id)\n     assert _is_req_scheduled(model_runner, req_id)\n \n@@ -200,8 +210,9 @@ def test_update_states_no_changes(model_runner):\n         free_encoder_input_ids=[],\n     )\n \n-    batch_changed = model_runner._update_states(scheduler_output)\n-    assert batch_changed is False\n+    metadata_before = model_runner.input_batch.sampling_metadata\n+    model_runner._update_states(scheduler_output)\n+    assert not _is_sampling_metadata_changed(model_runner, metadata_before)\n     assert _is_req_added(model_runner, req_id)\n     assert _is_req_scheduled(model_runner, req_id)\n \n@@ -233,8 +244,8 @@ def test_update_states_request_unscheduled(model_runner):\n         free_encoder_input_ids=[],\n     )\n \n-    batch_changed = model_runner._update_states(scheduler_output)\n-    assert batch_changed is True\n+    metadata_before = model_runner._update_states(scheduler_output)\n+    assert _is_sampling_metadata_changed(model_runner, metadata_before)\n \n     assert _is_req_added(model_runner, req_ids[0])\n     assert _is_req_scheduled(model_runner, req_ids[0])\ndiff --git a/vllm/model_executor/layers/utils.py b/vllm/model_executor/layers/utils.py\nindex dfe71028c..a9ef97391 100644\n--- a/vllm/model_executor/layers/utils.py\n+++ b/vllm/model_executor/layers/utils.py\n@@ -45,7 +45,7 @@ def apply_penalties(logits: torch.Tensor, prompt_tokens_tensor: torch.Tensor,\n                                                    vocab_size, num_seqs)\n     output_bin_counts, output_mask = get_token_bin_counts_and_mask(\n         output_tokens_tensor, vocab_size, num_seqs)\n-    repetition_penalties = repetition_penalties.unsqueeze_(dim=1).repeat(\n+    repetition_penalties = repetition_penalties.unsqueeze(dim=1).repeat(\n         1, vocab_size)\n     logits[logits > 0] /= torch.where(prompt_mask | output_mask,\n                                       repetition_penalties, 1.0)[logits > 0]\n@@ -53,6 +53,6 @@ def apply_penalties(logits: torch.Tensor, prompt_tokens_tensor: torch.Tensor,\n                                        repetition_penalties, 1.0)[logits <= 0]\n     # We follow the definition in OpenAI API.\n     # Refer to https://platform.openai.com/docs/api-reference/parameter-details\n-    logits -= frequency_penalties.unsqueeze_(dim=1) * output_bin_counts\n-    logits -= presence_penalties.unsqueeze_(dim=1) * output_mask\n+    logits -= frequency_penalties.unsqueeze(dim=1) * output_bin_counts\n+    logits -= presence_penalties.unsqueeze(dim=1) * output_mask\n     return logits\ndiff --git a/vllm/v1/core/scheduler.py b/vllm/v1/core/scheduler.py\nindex 8f1083425..535aa644c 100644\n--- a/vllm/v1/core/scheduler.py\n+++ b/vllm/v1/core/scheduler.py\n@@ -195,8 +195,10 @@ class Scheduler:\n                                              request.num_computed_tokens -\n                                              request.num_tokens)\n                 if num_scheduled_spec_tokens > 0:\n+                    # Trim spec_token_ids list to num_scheduled_spec_tokens.\n+                    del request.spec_token_ids[num_scheduled_spec_tokens:]\n                     scheduled_spec_decode_tokens[request.request_id] = (\n-                        request.spec_token_ids[:num_scheduled_spec_tokens])\n+                        request.spec_token_ids)\n \n             # Encoder-related.\n             if encoder_inputs_to_schedule:\n@@ -567,7 +569,7 @@ class Scheduler:\n                 outputs.append(\n                     EngineCoreOutput(\n                         request_id=req_id,\n-                        new_token_ids=new_token_ids or [],\n+                        new_token_ids=new_token_ids,\n                         finish_reason=request.get_finished_reason(),\n                         new_logprobs=new_logprobs,\n                         new_prompt_logprobs_tensors=prompt_logprobs_tensors,\ndiff --git a/vllm/v1/sample/metadata.py b/vllm/v1/sample/metadata.py\nindex ea64181c0..2184a1866 100644\n--- a/vllm/v1/sample/metadata.py\n+++ b/vllm/v1/sample/metadata.py\n@@ -1,7 +1,7 @@\n # SPDX-License-Identifier: Apache-2.0\n \n from dataclasses import dataclass\n-from typing import Dict, List, Optional, Set\n+from typing import Dict, List, Optional, Set, Tuple\n \n import torch\n \n@@ -12,15 +12,13 @@ class SamplingMetadata:\n     temperature: torch.Tensor\n     all_greedy: bool\n     all_random: bool\n-    rejection_sampling: bool\n-    spec_token_ids: List[List[int]]\n \n-    top_p: torch.Tensor\n-    top_k: torch.Tensor\n-    no_top_p: bool\n-    no_top_k: bool\n-    min_p: torch.Tensor\n-    no_min_p: bool\n+    # None when there are no speculated tokens.\n+    spec_token_ids: Optional[List[List[int]]]\n+\n+    top_p: Optional[torch.Tensor]\n+    top_k: Optional[torch.Tensor]\n+    min_p: Optional[torch.Tensor]\n \n     generators: Dict[int, torch.Generator]\n \n@@ -34,7 +32,8 @@ class SamplingMetadata:\n     repetition_penalties: torch.Tensor\n \n     output_token_ids: List[List[int]]\n-    min_tokens: List[int]\n-    stop_token_ids: List[Set[int]]\n+\n+    # req_index -> (min_tokens, stop_token_ids)\n+    min_tokens: Dict[int, Tuple[int, Set[int]]]\n \n     logit_bias: List[Optional[Dict[int, float]]]\ndiff --git a/vllm/v1/sample/ops/penalties.py b/vllm/v1/sample/ops/penalties.py\nindex ba368b44a..8d9f6529f 100644\n--- a/vllm/v1/sample/ops/penalties.py\n+++ b/vllm/v1/sample/ops/penalties.py\n@@ -1,6 +1,6 @@\n # SPDX-License-Identifier: Apache-2.0\n \n-from typing import List, Set, Tuple\n+from typing import Dict, List, Set, Tuple\n \n import torch\n \n@@ -8,18 +8,17 @@ from vllm.model_executor.layers.utils import apply_penalties\n from vllm.utils import is_pin_memory_available, make_tensor_with_pad\n \n \n-def apply_min_token_penalties(logits: torch.Tensor,\n-                              output_token_ids: List[List[int]],\n-                              stop_token_ids: List[Set[int]],\n-                              min_tokens: List[int]) -> None:\n+def apply_min_token_penalties(\n+        logits: torch.Tensor, output_token_ids: List[List[int]],\n+        min_tokens: Dict[int, Tuple[int, Set[int]]]) -> None:\n     \"\"\"\n     Applies minimum token penalty by setting the logits of the stop tokens\n     to -inf.\n     \"\"\"\n     min_tokens_logits_to_penalize: List[Tuple[int, int]] = []\n-    for index, min_token in enumerate(min_tokens):\n+    for index, (min_token, stop_token_ids) in min_tokens.items():\n         if len(output_token_ids[index]) < min_token:\n-            for stop_token_id in stop_token_ids[index]:\n+            for stop_token_id in stop_token_ids:\n                 min_tokens_logits_to_penalize.append((index, stop_token_id))\n     if min_tokens_logits_to_penalize:\n         logits[tuple(zip(*min_tokens_logits_to_penalize))] = -float(\"inf\")\ndiff --git a/vllm/v1/sample/ops/topk_topp_sampler.py b/vllm/v1/sample/ops/topk_topp_sampler.py\nindex 27431001e..78c88ad8b 100644\n--- a/vllm/v1/sample/ops/topk_topp_sampler.py\n+++ b/vllm/v1/sample/ops/topk_topp_sampler.py\n@@ -1,6 +1,6 @@\n # SPDX-License-Identifier: Apache-2.0\n \n-from typing import Dict\n+from typing import Dict, Optional\n \n import torch\n import torch.nn as nn\n@@ -55,13 +55,11 @@ class TopKTopPSampler(nn.Module):\n         self,\n         logits: torch.Tensor,\n         generators: Dict[int, torch.Generator],\n-        no_top_k: bool,\n-        k: torch.Tensor,\n-        no_top_p: bool,\n-        p: torch.Tensor,\n+        k: Optional[torch.Tensor],\n+        p: Optional[torch.Tensor],\n     ) -> torch.Tensor:\n         \"\"\"PyTorch-native implementation of top-k and top-p sampling.\"\"\"\n-        logits = apply_top_k_top_p(logits, no_top_k, k, no_top_p, p)\n+        logits = apply_top_k_top_p(logits, k, p)\n         probs = logits.softmax(dim=-1, dtype=torch.float32)\n         return random_sample(probs, generators)\n \n@@ -69,37 +67,33 @@ class TopKTopPSampler(nn.Module):\n         self,\n         logits: torch.Tensor,\n         generators: Dict[int, torch.Generator],\n-        no_top_k: bool,\n-        k: torch.Tensor,\n-        no_top_p: bool,\n-        p: torch.Tensor,\n+        k: Optional[torch.Tensor],\n+        p: Optional[torch.Tensor],\n     ) -> torch.Tensor:\n         \"\"\"More optimized implementation for top-k and top-p sampling.\"\"\"\n         probs = logits.softmax(dim=-1, dtype=torch.float32)\n-        if no_top_k and no_top_p:\n+        if k is None and p is None:\n             # We prefer `random_sample` over `flashinfer_sample` when sorting is\n             # not needed. This is because `random_sample` does not require\n             # CPU-GPU synchronization while `flashinfer_sample` does.\n             return random_sample(probs, generators)\n-        return flashinfer_sample(probs, no_top_k, k, no_top_p, p, generators)\n+        return flashinfer_sample(probs, k, p, generators)\n \n \n def apply_top_k_top_p(\n     logits: torch.Tensor,\n-    no_top_k: bool,\n-    k: torch.Tensor,\n-    no_top_p: bool,\n-    p: torch.Tensor,\n+    k: Optional[torch.Tensor],\n+    p: Optional[torch.Tensor],\n ) -> torch.Tensor:\n     \"\"\"Apply top-k and top-p masks to the logits.\n \n     This function sorts the logits tensor, which can be slow for large batches.\n     \"\"\"\n-    if no_top_k and no_top_p:\n+    if k is None and p is None:\n         return logits\n     logits_sort, logits_idx = logits.sort(dim=-1, descending=False)\n \n-    if not no_top_k:\n+    if k is not None:\n         # Apply top-k.\n         top_k_mask = logits_sort.size(1) - k.to(torch.long)\n         # Get all the top_k values.\n@@ -107,7 +101,7 @@ def apply_top_k_top_p(\n         top_k_mask = logits_sort < top_k_mask\n         logits_sort.masked_fill_(top_k_mask, -float(\"inf\"))\n \n-    if not no_top_p:\n+    if p is not None:\n         # Apply top-p.\n         probs_sort = logits_sort.softmax(dim=-1)\n         probs_sum = probs_sort.cumsum(dim=-1)\n@@ -147,10 +141,8 @@ def random_sample(\n \n def flashinfer_sample(\n     probs: torch.Tensor,\n-    no_top_k: bool,\n-    k: torch.Tensor,\n-    no_top_p: bool,\n-    p: torch.Tensor,\n+    k: Optional[torch.Tensor],\n+    p: Optional[torch.Tensor],\n     generators: Dict[int, torch.Generator],\n ) -> torch.Tensor:\n     \"\"\"Sample from the probabilities using FlashInfer.\n@@ -167,7 +159,7 @@ def flashinfer_sample(\n     does not. Call this function at the end of the forward pass to minimize\n     the synchronization overhead.\n     \"\"\"\n-    assert not (no_top_k and no_top_p)\n+    assert not (k is None and p is None)\n     max_top_k_round = 32\n     batch_size = probs.shape[0]\n     uniform_samples = torch.empty((max_top_k_round, batch_size),\n@@ -178,11 +170,11 @@ def flashinfer_sample(\n         for i, generator in generators.items():\n             uniform_samples[:, i].uniform_(generator=generator)\n \n-    if no_top_k:\n+    if k is None:\n         # Top-p only.\n         next_token_ids, success = flashinfer.sampling.top_p_sampling_from_probs(\n             probs, uniform_samples, p, deterministic=True)\n-    elif no_top_p:\n+    elif p is None:\n         # Top-k only.\n         next_token_ids, success = flashinfer.sampling.top_k_sampling_from_probs(\n             probs, uniform_samples, k, deterministic=True)\n@@ -194,9 +186,9 @@ def flashinfer_sample(\n \n     # NOTE: CPU-GPU synchronization happens here.\n     if not success.all():\n-        if not no_top_k:\n+        if k is not None:\n             probs = flashinfer.sampling.top_k_renorm_prob(probs, k)\n-        if not no_top_p:\n+        if p is not None:\n             probs = flashinfer.sampling.top_p_renorm_prob(probs, p)\n         next_token_ids = flashinfer.sampling.sampling_from_probs(\n             probs, uniform_samples[0], deterministic=True)\ndiff --git a/vllm/v1/sample/rejection_sampler.py b/vllm/v1/sample/rejection_sampler.py\nindex df1da8930..580ad4429 100644\n--- a/vllm/v1/sample/rejection_sampler.py\n+++ b/vllm/v1/sample/rejection_sampler.py\n@@ -68,6 +68,7 @@ class RejectionSampler(nn.Module):\n         # NOTE: The following input preparationg can be moved\n         # to the model runner with a persistent manner for better\n         # performance.\n+        assert sampling_metadata.spec_token_ids is not None\n         spec_token_ids = sampling_metadata.spec_token_ids\n         max_spec_len = max(len(s) for s in spec_token_ids)\n         batch_size = len(spec_token_ids)\n@@ -119,6 +120,7 @@ class RejectionSampler(nn.Module):\n         logits: torch.Tensor,\n         sampling_metadata: SamplingMetadata,\n     ) -> SamplerOutput:\n+        assert sampling_metadata.spec_token_ids is not None\n         spec_lens = [len(x) for x in sampling_metadata.spec_token_ids]\n         # Add 1 to include the 'bonus' token.\n         sample_lens = [x + 1 for x in spec_lens]\ndiff --git a/vllm/v1/sample/sampler.py b/vllm/v1/sample/sampler.py\nindex ec6374d12..8e2533eef 100644\n--- a/vllm/v1/sample/sampler.py\n+++ b/vllm/v1/sample/sampler.py\n@@ -26,7 +26,7 @@ class Sampler(nn.Module):\n         logits: torch.Tensor,\n         sampling_metadata: SamplingMetadata,\n     ) -> SamplerOutput:\n-        if sampling_metadata.rejection_sampling:\n+        if sampling_metadata.spec_token_ids:\n             if sampling_metadata.max_num_logprobs:\n                 raise NotImplementedError(\n                     \"Rejection sampling does not support logprobs.\")\n@@ -104,16 +104,14 @@ class Sampler(nn.Module):\n         logits = self.apply_temperature(logits, sampling_metadata.temperature)\n \n         # Apply min_p.\n-        if not sampling_metadata.no_min_p:\n+        if sampling_metadata.min_p is not None:\n             logits = self.apply_min_p(logits, sampling_metadata.min_p)\n \n         # Apply top_k and/or top_p.\n         random_sampled = self.topk_topp_sampler(\n             logits,\n             sampling_metadata.generators,\n-            sampling_metadata.no_top_k,\n             sampling_metadata.top_k,\n-            sampling_metadata.no_top_p,\n             sampling_metadata.top_p,\n         )\n \n@@ -179,9 +177,10 @@ class Sampler(nn.Module):\n         logits: torch.Tensor,\n         sampling_metadata: SamplingMetadata,\n     ) -> torch.Tensor:\n-        apply_min_token_penalties(logits, sampling_metadata.output_token_ids,\n-                                  sampling_metadata.stop_token_ids,\n-                                  sampling_metadata.min_tokens)\n+        if sampling_metadata.min_tokens:\n+            apply_min_token_penalties(logits,\n+                                      sampling_metadata.output_token_ids,\n+                                      sampling_metadata.min_tokens)\n         if not sampling_metadata.no_penalties:\n             assert sampling_metadata.prompt_token_ids is not None\n             logits = apply_all_penalties(\ndiff --git a/vllm/v1/utils.py b/vllm/v1/utils.py\nindex 5494542c1..5be465014 100644\n--- a/vllm/v1/utils.py\n+++ b/vllm/v1/utils.py\n@@ -188,3 +188,14 @@ def bind_kv_cache(\n     for layer_name, kv_cache in kv_caches.items():\n         # NOTE: Use list because of v0 PP virtual engine.\n         forward_context[layer_name].kv_cache = [kv_cache]\n+\n+\n+def copy_slice(from_tensor: torch.Tensor, to_tensor: torch.Tensor,\n+               length: int) -> None:\n+    \"\"\"\n+    Copy the first length elements of a tensor into another tensor in a\n+    non-blocking manner.\n+\n+    Used to copy pinned CPU tensor data to pre-allocated GPU tensors.\n+    \"\"\"\n+    to_tensor[:length].copy_(from_tensor[:length], non_blocking=True)\ndiff --git a/vllm/v1/worker/gpu_input_batch.py b/vllm/v1/worker/gpu_input_batch.py\nindex cb7411a44..ccafc325b 100644\n--- a/vllm/v1/worker/gpu_input_batch.py\n+++ b/vllm/v1/worker/gpu_input_batch.py\n@@ -1,9 +1,8 @@\n # SPDX-License-Identifier: Apache-2.0\n-\n # Datastructures defining an input batch\n \n from dataclasses import dataclass\n-from typing import TYPE_CHECKING, Dict, List, Optional, Set, Tuple\n+from typing import TYPE_CHECKING, Dict, List, Optional, Set, Tuple, cast\n \n import numpy as np\n import torch\n@@ -12,6 +11,7 @@ from vllm.lora.request import LoRARequest\n from vllm.multimodal import MultiModalKwargs\n from vllm.sampling_params import SamplingParams, SamplingType\n from vllm.v1.sample.metadata import SamplingMetadata\n+from vllm.v1.utils import copy_slice\n from vllm.v1.worker.block_table import BlockTable\n \n _SAMPLING_EPS = 1e-5\n@@ -63,7 +63,7 @@ class InputBatch:\n         self.pin_memory = pin_memory\n         self.vocab_size = vocab_size\n \n-        self.req_ids: List[Optional[str]] = [None] * max_num_reqs\n+        self._req_ids: List[Optional[str]] = []\n         self.req_id_to_index: Dict[str, int] = {}\n \n         # TODO(woosuk): This buffer could be too large if max_model_len is big.\n@@ -171,11 +171,8 @@ class InputBatch:\n                 self.repetition_penalties_cpu_tensor.numpy()\n         self.repetition_penalties_reqs: Set[str] = set()\n \n-        self.min_tokens: List[int] = [0] * max_num_reqs\n-        self.stop_token_ids: List[Set[int]] = [\n-            set() for _ in range(max_num_reqs)\n-        ]\n-        self.prompt_token_ids: Optional[torch.Tensor] = None\n+        # req_index -> (min_tokens, stop_token_ids)\n+        self.min_tokens: Dict[int, Tuple[int, Set[int]]] = {}\n \n         # lora related\n         self.request_lora_mapping = np.zeros((self.max_num_reqs, ),\n@@ -196,6 +193,17 @@ class InputBatch:\n         self.logit_bias: List[Optional[Dict[int,\n                                             float]]] = [None] * max_num_reqs\n \n+        self.req_output_token_ids: List[Optional[List[int]]] = []\n+\n+        # This is updated each time the batch constituents change.\n+        self.sampling_metadata = self._make_sampling_metadata()\n+\n+    @property\n+    def req_ids(self) -> List[str]:\n+        # None elements should only be present transiently\n+        # while performing state updates to the batch.\n+        return cast(List[str], self._req_ids)\n+\n     def add_request(\n         self,\n         request: \"CachedRequestState\",\n@@ -206,7 +214,13 @@ class InputBatch:\n         assert req_index < self.max_num_reqs\n \n         req_id = request.req_id\n-        self.req_ids[req_index] = req_id\n+        if req_index == len(self._req_ids):\n+            self._req_ids.append(req_id)\n+            self.req_output_token_ids.append(request.output_token_ids)\n+        else:\n+            self._req_ids[req_index] = req_id\n+            self.req_output_token_ids[req_index] = request.output_token_ids\n+\n         self.req_id_to_index[req_id] = req_index\n \n         # Copy the prompt token ids and output token ids.\n@@ -255,8 +269,9 @@ class InputBatch:\n             req_index] = sampling_params.repetition_penalty\n         if sampling_params.repetition_penalty != 1.0:\n             self.repetition_penalties_reqs.add(req_id)\n-        self.min_tokens[req_index] = sampling_params.min_tokens\n-        self.stop_token_ids[req_index] = sampling_params.all_stop_token_ids\n+        if sampling_params.min_tokens:\n+            self.min_tokens[req_index] = (sampling_params.min_tokens,\n+                                          sampling_params.all_stop_token_ids)\n \n         # NOTE(woosuk): self.generators should not include the requests that\n         # do not have their own generator.\n@@ -284,16 +299,20 @@ class InputBatch:\n             self.request_lora_mapping[req_index] = 0\n \n     def remove_request(self, req_id: str) -> Optional[int]:\n+        \"\"\"This method must always be followed by a call to condense().\"\"\"\n+\n         req_index = self.req_id_to_index.pop(req_id, None)\n         if req_index is None:\n             return None\n-        self.req_ids[req_index] = None\n+        self._req_ids[req_index] = None\n+        self.req_output_token_ids[req_index] = None\n \n         self.greedy_reqs.discard(req_id)\n         self.random_reqs.discard(req_id)\n         self.top_p_reqs.discard(req_id)\n         self.top_k_reqs.discard(req_id)\n         self.min_p_reqs.discard(req_id)\n+        self.min_tokens.pop(req_index, None)\n         self.frequency_penalties_reqs.discard(req_id)\n         self.presence_penalties_reqs.discard(req_id)\n         self.repetition_penalties_reqs.discard(req_id)\n@@ -313,33 +332,17 @@ class InputBatch:\n         self.logit_bias[req_index] = None\n         return req_index\n \n-    def clear(self) -> None:\n-        self.req_ids = [None] * self.max_num_reqs\n-        self.req_id_to_index.clear()\n-        self.greedy_reqs.clear()\n-        self.random_reqs.clear()\n-        self.top_p_reqs.clear()\n-        self.top_k_reqs.clear()\n-        self.min_p_reqs.clear()\n-        self.frequency_penalties_reqs.clear()\n-        self.presence_penalties_reqs.clear()\n-        self.repetition_penalties_reqs.clear()\n-        self.generators.clear()\n-        self.num_logprobs.clear()\n-        self.num_prompt_logprobs.clear()\n-        self.request_lora_mapping.fill(0)\n-        self.lora_id_to_lora_request.clear()\n-        self.lora_id_to_request_ids.clear()\n-        self.logit_bias = [None] * self.max_num_reqs\n-\n     def condense(self, empty_req_indices: List[int]) -> None:\n-        if self.num_reqs == 0:\n+        num_reqs = self.num_reqs\n+        if num_reqs == 0:\n             # The batched states are empty.\n+            self._req_ids.clear()\n+            self.req_output_token_ids.clear()\n             return\n \n         # NOTE(woosuk): This function assumes that the empty_req_indices\n         # is sorted in descending order.\n-        last_req_index = self.num_reqs + len(empty_req_indices) - 1\n+        last_req_index = num_reqs + len(empty_req_indices) - 1\n         while empty_req_indices:\n             # Find the largest non-empty index.\n             while last_req_index in empty_req_indices:\n@@ -351,10 +354,13 @@ class InputBatch:\n                 break\n \n             # Swap the states.\n-            req_id = self.req_ids[last_req_index]\n+            req_id = self._req_ids[last_req_index]\n+            output_token_ids = self.req_output_token_ids[last_req_index]\n             assert req_id is not None\n-            self.req_ids[empty_index] = req_id\n-            self.req_ids[last_req_index] = None\n+            self._req_ids[empty_index] = req_id\n+            self._req_ids[last_req_index] = None\n+            self.req_output_token_ids[empty_index] = output_token_ids\n+            self.req_output_token_ids[last_req_index] = None\n             self.req_id_to_index[req_id] = empty_index\n \n             num_tokens = self.num_tokens[last_req_index]\n@@ -379,13 +385,14 @@ class InputBatch:\n             self.repetition_penalties_cpu[\n                 empty_index] = self.repetition_penalties_cpu[last_req_index]\n             self.min_p_cpu[empty_index] = self.min_p_cpu[last_req_index]\n-            self.min_tokens[empty_index] = self.min_tokens[last_req_index]\n-            self.stop_token_ids[empty_index] = self.stop_token_ids[\n-                last_req_index]\n             generator = self.generators.pop(last_req_index, None)\n             if generator is not None:\n                 self.generators[empty_index] = generator\n \n+            min_token = self.min_tokens.pop(last_req_index, None)\n+            if min_token is not None:\n+                self.min_tokens[empty_index] = min_token\n+\n             self.request_lora_mapping[empty_index] = self.request_lora_mapping[\n                 last_req_index]\n \n@@ -394,87 +401,71 @@ class InputBatch:\n             # Decrement last_req_index since it is now empty.\n             last_req_index -= 1\n \n-    def make_sampling_metadata(\n-        self,\n-        req_id_output_token_ids: Dict[str, List[int]],\n-        req_id_to_spec_token_ids: Dict[str, List[int]],\n-        skip_copy: bool = False,\n-    ) -> SamplingMetadata:\n-        if not skip_copy:\n-            self.temperature[:self.num_reqs].copy_(\n-                self.temperature_cpu_tensor[:self.num_reqs], non_blocking=True)\n-            self.top_p[:self.num_reqs].copy_(\n-                self.top_p_cpu_tensor[:self.num_reqs], non_blocking=True)\n-            self.top_k[:self.num_reqs].copy_(\n-                self.top_k_cpu_tensor[:self.num_reqs], non_blocking=True)\n-            self.min_p[:self.num_reqs].copy_(\n-                self.min_p_cpu_tensor[:self.num_reqs], non_blocking=True)\n-            if not self.no_penalties:\n-                # Since syncing these tensors is expensive only copy them\n-                # if necessary i.e. if there are requests which require\n-                # penalties to be applied during sampling.\n-                self.frequency_penalties[:self.num_reqs].copy_(\n-                    self.frequency_penalties_cpu_tensor[:self.num_reqs],\n-                    non_blocking=True,\n-                )\n-                self.presence_penalties[:self.num_reqs].copy_(\n-                    self.presence_penalties_cpu_tensor[:self.num_reqs],\n-                    non_blocking=True,\n-                )\n-                self.repetition_penalties[:self.num_reqs].copy_(\n-                    self.repetition_penalties_cpu_tensor[:self.num_reqs],\n-                    non_blocking=True,\n-                )\n-                # The prompt tokens are used only for applying penalties during\n-                # the sampling process. Hence copy these tensors only when\n-                # there are requests which need penalties to be applied.\n-                self.prompt_token_ids = self._make_prompt_token_ids_tensor()\n-\n-        output_token_ids: List[List[int]] = []\n-        spec_token_ids: List[List[int]] = []\n-        rejection_sampling = False\n-        for req_id in self.req_ids[:self.num_reqs]:\n-            assert req_id is not None\n-            # Currently we create a tensor for output_token_ids from scratch\n-            # at each step. However, for the penalties computation what we\n-            # need is stats about the token ids present in the output. This\n-            # stats can be maintained incrementally instead of computing it\n-            # from scratch at each step.\n-            # TODO - Replace this with incremental update to output token\n-            # statistics.\n-            output_token_ids.append(req_id_output_token_ids[req_id])\n-            req_spec_token_ids = req_id_to_spec_token_ids.get(req_id, [])\n-            spec_token_ids.append(req_spec_token_ids)\n-            if req_spec_token_ids:\n-                # If any of the requests require speculative decoding, set the\n-                # flag to True.\n-                rejection_sampling = True\n+        # Trim lists to the batch size.\n+        del self._req_ids[self.num_reqs:]\n+        del self.req_output_token_ids[self.num_reqs:]\n+\n+    def refresh_sampling_metadata(self):\n+        self.sampling_metadata = self._make_sampling_metadata()\n+\n+    def _make_sampling_metadata(self) -> SamplingMetadata:\n+        num_reqs = self.num_reqs\n+        copy_slice(self.temperature_cpu_tensor, self.temperature, num_reqs)\n+        if not self.no_top_p:\n+            copy_slice(self.top_p_cpu_tensor, self.top_p, num_reqs)\n+        if not self.no_top_k:\n+            copy_slice(self.top_k_cpu_tensor, self.top_k, num_reqs)\n+        if not self.no_min_p:\n+            copy_slice(self.min_p_cpu_tensor, self.min_p, num_reqs)\n+\n+        if not self.no_penalties:\n+            # Since syncing these tensors is expensive only copy them\n+            # if necessary i.e. if there are requests which require\n+            # penalties to be applied during sampling.\n+            copy_slice(self.frequency_penalties_cpu_tensor,\n+                       self.frequency_penalties, num_reqs)\n+            copy_slice(self.presence_penalties_cpu_tensor,\n+                       self.presence_penalties, num_reqs)\n+            copy_slice(self.repetition_penalties_cpu_tensor,\n+                       self.repetition_penalties, num_reqs)\n+\n+            # The prompt tokens are used only for applying penalties during\n+            # the sampling process. Hence copy these tensors only when\n+            # there are requests which need penalties to be applied.\n+            prompt_token_ids = self._make_prompt_token_ids_tensor()\n+        else:\n+            prompt_token_ids = None\n \n         return SamplingMetadata(\n-            temperature=self.temperature[:self.num_reqs],\n+            temperature=self.temperature[:num_reqs],\n             all_greedy=self.all_greedy,\n             all_random=self.all_random,\n-            rejection_sampling=rejection_sampling,\n-            top_p=self.top_p[:self.num_reqs],\n-            top_k=self.top_k[:self.num_reqs],\n-            min_p=self.min_p[:self.num_reqs],\n-            no_min_p=self.no_min_p,\n-            no_top_p=self.no_top_p,\n-            no_top_k=self.no_top_k,\n+            top_p=None if self.no_top_p else self.top_p[:num_reqs],\n+            top_k=None if self.no_top_k else self.top_k[:num_reqs],\n+            min_p=None if self.no_min_p else self.min_p[:num_reqs],\n             generators=self.generators,\n             max_num_logprobs=self.max_num_logprobs,\n-            prompt_token_ids=self.prompt_token_ids,\n-            frequency_penalties=self.frequency_penalties[:self.num_reqs],\n-            presence_penalties=self.presence_penalties[:self.num_reqs],\n-            repetition_penalties=self.repetition_penalties[:self.num_reqs],\n-            output_token_ids=output_token_ids,\n-            spec_token_ids=spec_token_ids,\n-            min_tokens=self.min_tokens[:self.num_reqs],\n-            stop_token_ids=self.stop_token_ids[:self.num_reqs],\n+            prompt_token_ids=prompt_token_ids,\n+            frequency_penalties=self.frequency_penalties[:num_reqs],\n+            presence_penalties=self.presence_penalties[:num_reqs],\n+            repetition_penalties=self.repetition_penalties[:num_reqs],\n+            output_token_ids=cast(List[List[int]], self.req_output_token_ids),\n+            spec_token_ids=None,\n+            min_tokens=self.min_tokens,\n             no_penalties=self.no_penalties,\n-            logit_bias=self.logit_bias[:self.num_reqs],\n+            logit_bias=self.logit_bias[:num_reqs],\n         )\n \n+    def get_sampling_metadata(\n+        self,\n+        req_id_to_spec_token_ids: Dict[str, List[int]],\n+    ) -> SamplingMetadata:\n+        # Set the new spec token ids in the cached sampling metadata.\n+        self.sampling_metadata.spec_token_ids = [\n+            req_id_to_spec_token_ids.get(req_id, []) for req_id in self.req_ids\n+        ] if req_id_to_spec_token_ids else None\n+        return self.sampling_metadata\n+\n     def _make_prompt_token_ids_tensor(self) -> torch.Tensor:\n         max_prompt_len = self.num_prompt_tokens[:self.num_reqs].max()\n         prompt_token_ids_cpu_tensor = torch.empty(\ndiff --git a/vllm/v1/worker/gpu_model_runner.py b/vllm/v1/worker/gpu_model_runner.py\nindex 5754422cb..0ecc00acc 100644\n--- a/vllm/v1/worker/gpu_model_runner.py\n+++ b/vllm/v1/worker/gpu_model_runner.py\n@@ -31,7 +31,6 @@ from vllm.v1.engine.mm_input_cache import MMInputCacheClient\n from vllm.v1.kv_cache_interface import (FullAttentionSpec, KVCacheConfig,\n                                         KVCacheSpec)\n from vllm.v1.outputs import LogprobsTensors, ModelRunnerOutput\n-from vllm.v1.sample.metadata import SamplingMetadata\n from vllm.v1.sample.rejection_sampler import INVALID_TOKEN_ID\n from vllm.v1.spec_decode.ngram_proposer import NgramProposer\n from vllm.v1.utils import bind_kv_cache\n@@ -224,16 +223,15 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                                         pin_memory=self.pin_memory)\n         self.seq_lens_np = self.seq_lens_cpu.numpy()\n \n-    def _update_states(self, scheduler_output: \"SchedulerOutput\") -> bool:\n+    def _update_states(self, scheduler_output: \"SchedulerOutput\") -> None:\n         \"\"\"Update the cached states and the persistent batch with the scheduler\n         output.\n \n         The updated states are used by the `_prepare_inputs` function to create\n         the input GPU tensors for the model.\n \n-        Returns:\n-            True if there is a new/resumed/paused/finished request in the batch.\n-            If False, we can skip copying SamplingMetadata to the GPU.\n+        The SamplingMetadata is updated and copied to the GPU if there is a\n+        new/resumed/paused/finished request in the batch.\n         \"\"\"\n         # Remove finished requests from the cached states.\n         for req_id in scheduler_output.finished_req_ids:\n@@ -344,9 +342,12 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n             num_new_tokens = (num_computed_tokens +\n                               len(req_data.new_token_ids) -\n                               req_state.num_tokens)\n-            new_token_ids = (req_data.new_token_ids[-num_new_tokens:]\n-                             if num_new_tokens > 0 else [])\n-            req_state.output_token_ids.extend(new_token_ids)\n+            if num_new_tokens == 1:\n+                # Avoid slicing list in most common case.\n+                req_state.output_token_ids.append(req_data.new_token_ids[-1])\n+            elif num_new_tokens > 0:\n+                req_state.output_token_ids.extend(\n+                    req_data.new_token_ids[-num_new_tokens:])\n             # Update the block IDs.\n             if not req_data.resumed_from_preemption:\n                 # Append the new blocks to the existing block IDs.\n@@ -380,7 +381,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n             self.input_batch.num_tokens_no_spec[req_index] = end_token_index\n             # Add spec_token_ids to token_ids_cpu.\n             spec_token_ids = scheduler_output.scheduled_spec_decode_tokens.get(\n-                req_id, [])\n+                req_id, ())\n             if spec_token_ids:\n                 start_index = end_token_index\n                 end_token_index += len(spec_token_ids)\n@@ -410,7 +411,8 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         if removed_req_indices:\n             self.input_batch.condense(removed_req_indices)\n \n-        return batch_changed\n+        if batch_changed:\n+            self.input_batch.refresh_sampling_metadata()\n \n     def _prepare_inputs(\n         self,\n@@ -429,8 +431,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         # TODO: The Python loop can be slow. Optimize.\n         num_scheduled_tokens = np.empty(num_reqs, dtype=np.int32)\n         max_num_scheduled_tokens = 0\n-        for i, req_id in zip(range(num_reqs), self.input_batch.req_ids):\n-            assert req_id is not None\n+        for i, req_id in enumerate(self.input_batch.req_ids):\n             num_tokens = scheduler_output.num_scheduled_tokens[req_id]\n             num_scheduled_tokens[i] = num_tokens\n             max_num_scheduled_tokens = max(max_num_scheduled_tokens,\n@@ -669,10 +670,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n \n     def _calc_mrope_positions(self, scheduler_output: \"SchedulerOutput\"):\n         mrope_pos_ptr = 0\n-        num_reqs = self.input_batch.num_reqs\n-        for index, req_id in enumerate(self.input_batch.req_ids[:num_reqs]):\n-            assert req_id is not None\n-\n+        for index, req_id in enumerate(self.input_batch.req_ids):\n             req = self.requests[req_id]\n             assert req.mrope_positions is not None\n \n@@ -726,12 +724,11 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         self,\n         scheduler_output: \"SchedulerOutput\",\n         cu_num_tokens: np.ndarray,\n-    ) -> Tuple[torch.Tensor, torch.Tensor]:\n+    ) -> torch.Tensor:\n         # Get the number of spec decode tokens for each request.\n         num_reqs = self.input_batch.num_reqs\n         num_spec_decode_tokens = np.empty(num_reqs, dtype=np.int32)\n-        for i, req_id in zip(range(num_reqs), self.input_batch.req_ids):\n-            assert req_id is not None\n+        for i, req_id in enumerate(self.input_batch.req_ids):\n             num_spec_decode_tokens[i] = len(\n                 scheduler_output.scheduled_spec_decode_tokens.get(req_id, ()))\n \n@@ -769,22 +766,6 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         return torch.from_numpy(spec_decode_logits_indices).to(\n             self.device, non_blocking=True)\n \n-    def _prepare_sampling(\n-        self,\n-        batch_changed: bool,\n-        req_to_spec_token_ids: Dict[str, List[int]],\n-    ) -> SamplingMetadata:\n-        # Create the sampling metadata.\n-        req_id_output_token_ids: Dict[str, List[int]] = \\\n-            {req_id: req.output_token_ids \\\n-                for req_id, req in self.requests.items()}\n-\n-        sampling_metadata = self.input_batch.make_sampling_metadata(\n-            req_id_output_token_ids,\n-            req_to_spec_token_ids,\n-            skip_copy=not batch_changed)\n-        return sampling_metadata\n-\n     def _execute_encoder(self, scheduler_output: \"SchedulerOutput\"):\n         scheduled_encoder_inputs = scheduler_output.scheduled_encoder_inputs\n         if not scheduled_encoder_inputs:\n@@ -838,9 +819,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         scheduler_output: \"SchedulerOutput\",\n     ) -> List[torch.Tensor]:\n         encoder_outputs: List[torch.Tensor] = []\n-        num_reqs = self.input_batch.num_reqs\n-        for req_id in self.input_batch.req_ids[:num_reqs]:\n-            assert req_id is not None\n+        for req_id in self.input_batch.req_ids:\n             num_scheduled_tokens = scheduler_output.num_scheduled_tokens[\n                 req_id]\n             req_state = self.requests[req_id]\n@@ -882,7 +861,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         scheduler_output: \"SchedulerOutput\",\n         intermediate_tensors: Optional[IntermediateTensors] = None,\n     ) -> Union[ModelRunnerOutput, torch.Tensor]:\n-        batch_changed = self._update_states(scheduler_output)\n+        self._update_states(scheduler_output)\n \n         if self.is_multimodal_model:\n             # Run the multimodal encoder if any.\n@@ -964,8 +943,8 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         logits = self.model.compute_logits(sample_hidden_states, None)\n \n         # Sample the next token and get logprobs if needed.\n-        sampling_metadata = self._prepare_sampling(\n-            batch_changed, scheduler_output.scheduled_spec_decode_tokens)\n+        sampling_metadata = self.input_batch.get_sampling_metadata(\n+            scheduler_output.scheduled_spec_decode_tokens)\n         sampler_output = self.model.sample(\n             logits=logits,\n             sampling_metadata=sampling_metadata,\n@@ -973,14 +952,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n \n         # TODO(woosuk): The following loop can be slow since it iterates over\n         # the requests one by one. Optimize.\n-        num_reqs = self.input_batch.num_reqs\n-        req_ids: List[str] = []\n-        # Because `input_batch.req_ids` is a list of length `max_num_reqs`,\n-        # we need to stop at `num_reqs`.\n-        # FIXME(woosuk): This is hacky. Refactor.\n-        for i, req_id in zip(range(num_reqs), self.input_batch.req_ids):\n-            assert req_id is not None\n-            req_ids.append(req_id)\n+        for i, req_id in enumerate(self.input_batch.req_ids):\n             req_state = self.requests[req_id]\n             seq_len = (req_state.num_computed_tokens +\n                        scheduler_output.num_scheduled_tokens[req_id])\n@@ -1027,7 +999,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n                 valid_sampled_token_ids)\n \n         model_runner_output = ModelRunnerOutput(\n-            req_ids=req_ids,\n+            req_ids=self.input_batch.req_ids,\n             req_id_to_index=self.input_batch.req_id_to_index,\n             sampled_token_ids=valid_sampled_token_ids,\n             spec_token_ids=spec_token_ids,\n@@ -1041,19 +1013,18 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         sampled_token_ids: List[List[int]],\n     ) -> List[List[int]]:\n         # TODO(woosuk): Optimize.\n-        num_reqs = len(sampled_token_ids)\n         draft_token_ids: List[List[int]] = []\n-        for i in range(num_reqs):\n-            if len(sampled_token_ids[i]) == 0:\n+        for i, sampled_ids in enumerate(sampled_token_ids):\n+            num_sampled_ids = len(sampled_ids)\n+            if not num_sampled_ids:\n                 # Skip speculative decoding.\n                 draft_token_ids.append([])\n                 continue\n \n             # Add sampled_token_ids to token_ids_cpu.\n             start_idx = self.input_batch.num_tokens_no_spec[i]\n-            end_idx = start_idx + len(sampled_token_ids[i])\n-            self.input_batch.token_ids_cpu[\n-                i, start_idx:end_idx] = sampled_token_ids[i]\n+            end_idx = start_idx + num_sampled_ids\n+            self.input_batch.token_ids_cpu[i, start_idx:end_idx] = sampled_ids\n             drafter_output = self.drafter.propose(\n                 self.input_batch.token_ids_cpu[i, :end_idx],\n                 self.speculative_config.ngram_prompt_lookup_min,\n@@ -1204,7 +1175,7 @@ class GPUModelRunner(LoRAModelRunnerMixin):\n         # multiplying the list, to avoid Dynamo from treating them as\n         # tensor aliasing.\n         dummy_kv_caches = [\n-            torch.tensor([], dtype=torch.float32, device=self.device)\n+            torch.tensor((), dtype=torch.float32, device=self.device)\n             for _ in range(self.num_attn_layers)\n         ]\n \ndiff --git a/vllm/v1/worker/tpu_model_runner.py b/vllm/v1/worker/tpu_model_runner.py\nindex 4ee6853ba..e60268f04 100644\n--- a/vllm/v1/worker/tpu_model_runner.py\n+++ b/vllm/v1/worker/tpu_model_runner.py\n@@ -1048,8 +1048,6 @@ def swap_positions(b: InputBatch, id_1, id_2):\n \n     b.min_tokens[id_1], b.min_tokens[id_2] = b.min_tokens[id_2], b.min_tokens[\n         id_1]\n-    b.stop_token_ids[id_1], b.stop_token_ids[id_2] = b.stop_token_ids[\n-        id_2], b.stop_token_ids[id_1]\n \n     gen_1 = b.generators.pop(id_1, None)\n     gen_2 = b.generators.pop(id_2, None)", "apis": ["vllm.v1.sample.metadata.SamplingMetadata", "vllm.v1.sample.sampler.Sampler", "vllm.v1.worker.gpu_input_batch.InputBatch", "vllm.v1.worker.gpu_model_runner.GPUModelRunner"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/spec_decode/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/pool/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/metadata.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/sample/tpu/sampler.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/v1/worker/gpu_input_batch.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies several non-test source files (e.g., in vllm/v1/core, vllm/v1/worker, and others), and the changes are nontrivial. The modifications include handling of sampling metadata, optimizing how the req_ids list is managed, using nonâ€blocking tensor copy (via the new copy_slice function), reducing unnecessary list slicing, and overall attempts to lower overhead in critical paths such as CPU-GPU synchronization. Although the commit message simply uses â€œOptimizeâ€ in its title, the diff shows multiple performance-related improvements affecting core functions of the runtime. These changes are designed to improve the performance of high-level APIs, are testable on CPU, and are not merely refactoring for clarity. Therefore, this commit qualifies as performance optimization related.", "llm_api_reason": "The commit refactors the handling of sampling metadata and request identifiers. In the sampling metadata definition (in vllm/v1/sample/metadata.py), several fields have been changed â€“ for example, the rejection_sampling flag is removed, spec_token_ids is now optional, and top_p, top_k, and min_p are made optional. In addition, related tests in test_sampler and test_rejection_sampler were updated to construct SamplingMetadata accordingly. Meanwhile, the InputBatch class (in vllm/v1/worker/gpu_input_batch.py) has been updated to manage the req_ids list more robustly (switching to an internal list _req_ids and providing a property for req_ids), and to refresh and generate sampling metadata via methods like _make_sampling_metadata and get_sampling_metadata. Finally, GPUModelRunner (in vllm/v1/worker/gpu_model_runner.py) has been modified to use the new sampling metadata access method, ensuring that any changes in metadata due to added/removed requests are properly propagated. Overall, these changes optimize the metadata handling across the sampling and batching subsystems."}
{"commit_hash": "5e5c8e091eacc16672a0a8265eb5cb0ece85d24b", "pr_url": "https://github.com/vllm-project/vllm/pull/13236", "pr_date": "2025-02-14", "timeline_text": "Copy link Member mgoin commented Feb 13, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . For GPTQMarlin and AWQMarlin it seems the moe_wna16 kernel is faster for experts with dozens of experts, based on testing Qwen/Qwen1.5-MoE-A2.7B-Chat-GPTQ-Int4 (60 experts), TechxGenus/DeepSeek-Coder-V2-Lite-Instruct-AWQ (64 experts), and cognitivecomputations/DeepSeek-R1-AWQ (256 experts) cc @ElizaWszola @dsikka Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 Godofnothing reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Use moe_wna16 kernel by default for MoEs with many experts â€¦ bb27d51 Signed-off-by: mgoin <mgoin64@gmail.com> mgoin requested review from robertgshaw2-redhat and tlrmchlsmth as code owners February 13, 2025 20:03 Copy link github-actions bot commented Feb 13, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. ðŸ’¬ Join our developer Slack at https://slack.vllm.ai to discuss your PR in #pr-reviews, coordinate on features in #feat- channels, or join special interest groups in #sig- channels. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can either: Add ready label to the PR or enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Fixes â€¦ 4ac97e1 Signed-off-by: mgoin <mgoin64@gmail.com> Copy link Member Author mgoin commented Feb 13, 2025 @jinzhen-lin please see this PR. After this, I think we could remove moe_wna16 as a larger quant method and just use it as a kernel. What do you think? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Fix type issue â€¦ 3e07d17 Signed-off-by: mgoin <mgoin64@gmail.com> Copy link Contributor dsikka commented Feb 13, 2025 â€¢ edited Loading Uh oh! There was an error while loading. Please reload this page . Thanks for taking this on. Please run and/or update the weight_loading_large tests . I believe all the tests were skipped even when enabled when I last ran them last week so just something to potentially look out for. ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin added\n  the ready ONLY add when PR is ready to merge/full CI is needed label Feb 13, 2025 Fix weight-loading A100 test â€¦ c13deb5 Signed-off-by: mgoin <mgoin64@gmail.com> mgoin requested a review\n  from youkaichao as a code owner February 14, 2025 16:05 Copy link Member Author mgoin commented Feb 14, 2025 I fixed and ran the \"Weight Loading Multiple GPU Test - Large Models\", however it is failing due to unrelated compressedtensors dtype support issues. I think I can fix this by expanding the moe_wna16 method to compressedtensorsmoe, but will do in a followup All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . tlrmchlsmth approved these changes Feb 14, 2025 View reviewed changes Copy link Collaborator tlrmchlsmth left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Good to land. There is some circular import \"weirdness\" but it can wait for a future refactor along the lines of this RFC #8913 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction mgoin added\n  the force-merge label Feb 14, 2025 dsikka reviewed Feb 14, 2025 View reviewed changes tests/weight_loading/test_weight_loading.py @@ -12,7 +12,7 @@ \"robertgshaw2/zephyr-7b-beta-channelwise-gptq\") REVISION = os.environ.get(\"REVISION\", \"main\") QUANTIZATION = os.environ.get(\"QUANTIZATION\", \"gptq_marlin\") MIN_CAPABILITY = os.environ.get(\"MIN_CAPABILITY\", \" 89 \") MIN_CAPABILITY = os.environ.get(\"MIN_CAPABILITY\", \" 80 \") Copy link Contributor dsikka Feb 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment ah good catch Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions dsikka reviewed Feb 14, 2025 View reviewed changes vllm/model_executor/layers/quantization/gptq_marlin.py def __init__(self, weight_bits: int, group_size: int, desc_act: bool, is_sym: bool, lm_head_quantized: bool, dynamic: Dict[str, Dict[str, Union[int, bool]]], full_config: Dict[str, Any]) -> None: Copy link Contributor dsikka Feb 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment What is full_config? Can we add a comment Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Contributor dsikka Feb 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Oh just the config dict, I see Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 mgoin reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction Copy link Member Author mgoin Feb 14, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment It is just the original config saved from from_config so we can forward to MoeWNA16Config Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ðŸ‘ 1 dsikka reacted with thumbs up emoji All reactions ðŸ‘ 1 reaction mgoin added\n  the quantization label Feb 14, 2025 mgoin changed the title Use moe_wna16 kernel by default for MoEs with many experts [Quant][Perf] Use moe_wna16 kernel by default for MoEs with many experts Feb 14, 2025 Hide details View details simon-mo merged commit 5e5c8e0 into vllm-project : main Feb 14, 2025 35 of 37 checks passed Uh oh! There was an error while loading. Please reload this page . mgoin mentioned this pull request Feb 20, 2025 [Feature]: Add moe_wna16 kernel as a backend for CompressedTensorsWNA16MoEMethod #13575 Closed 1 task hongxiayang pushed a commit\n        to ROCm/vllm\n      that referenced\n      this pull request Feb 25, 2025 [MFM-2025-02-21] Merge main to llama fp8, DeepSeekV3 and PTPC-FP8 ( #445 ) â€¦ d7fefdf * [ROCM][AMD][TRITON] Halving warps number for fw_prefill to reduce spilling ( vllm-project#12713 )\n\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\n\n* Refactor `Linear` handling in `TransformersModel` ( vllm-project#12727 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [VLM] Add MLA with pure RoPE support for deepseek-vl2 models ( vllm-project#12729 )\n\n* [Misc] Bump the compressed-tensors version ( vllm-project#12736 )\n\n* [Model][Quant] Fix GLM, Fix fused module mappings for quantization ( vllm-project#12634 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\n\n* [Doc] Update PR Reminder with link to Developer Slack ( vllm-project#12748 )\n\n* [Bugfix] Fix OpenVINO model runner ( vllm-project#12750 )\n\n* [V1][Misc] Shorten `FinishReason` enum and use constant strings ( vllm-project#12760 )\n\n* [Doc] Remove performance warning for auto_awq.md ( vllm-project#12743 )\n\n* [Bugfix] Fix 'ModuleNotFoundError: No module named 'intel_extension_for_pytorch'' for --tensor-parallel-size more than 1  ( vllm-project#12546 )\n\n* [core][distributed] exact ray placement control ( vllm-project#12732 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* The code assumes WARP_SIZE to be equal to 32, which is not the case on ROCm ( #406 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* Merging PR vllm-project#12536 Merged via CLI script\n\n* [Hardware][Intel-Gaudi] Enable FusedSDPA support for Intel Gaudi (HPU)\n\n* Add: Support for Sparse24Bitmask Compressed Models\n\n* [VLM] Use shared field to pass token ids to model\n\n* [Docs] Drop duplicate [source] links\n\n* [VLM] Qwen2.5-VL\n\n* [VLM] Update compatibility with transformers 4.49\n\n* [ROCm][Kernel] Using the correct warp_size value\n\n* [Bugfix] Better FP8 supported defaults\n\n* [Misc][Easy] Remove the space from the file name\n\n* [Model] LoRA Support for Ultravox model ( vllm-project#11253 )\n\n* [Bugfix] Fix the test_ultravox.py's license ( vllm-project#12806 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* Improve `TransformersModel` UX ( vllm-project#12785 )\n\n* [Misc] Remove duplicated DeepSeek V2/V3 model definition ( vllm-project#12793 )\n\n* [Misc] Improve error message for incorrect pynvml ( vllm-project#12809 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Update w2 scale loading for GPTQMarlinMoE ( vllm-project#12757 )\n\n* [Docs] Add Google Cloud Slides ( vllm-project#12814 )\n\n* [Attention] Use FA3 for MLA on Hopper ( vllm-project#12807 )\n\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\n\n* [misc] Reduce number of config file requests to HuggingFace ( vllm-project#12797 )\n\nSigned-off-by: EC2 Default User <ec2-user@ip-172-31-20-117.us-west-2.compute.internal>\nSigned-off-by: <>\nCo-authored-by: EC2 Default User <ec2-user@ip-172-31-20-117.us-west-2.compute.internal>\n\n* Update README.md 20250205_aiter ( #407 )\n\n* Update README.md 20250205_aiter\n\n* whitespace\n\n* adding VLLM_USE_AITER=0 advice\n\n* [Misc] Remove unnecessary decode call ( vllm-project#12833 )\n\n* [Kernel] Make rotary_embedding ops more flexible with input shape ( vllm-project#12777 )\n\n* [torch.compile] PyTorch 2.6 and nightly compatibility ( vllm-project#12393 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] double quote cmake package in build.inc.md ( vllm-project#12840 )\n\n* [Bugfix] Fix unsupported FA version check for Turing GPU ( vllm-project#12828 )\n\n* [V1] LoRA Support ( vllm-project#10957 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* Add Bamba Model ( vllm-project#10909 )\n\nSigned-off-by: Yu Chin Fabian Lim <flim@sg.ibm.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [MISC] Check space in the file names in the pre commit checks ( vllm-project#12804 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [misc] Revert # 12833 ( vllm-project#12857 )\n\nSigned-off-by: <>\nCo-authored-by: EC2 Default User <ec2-user@ip-172-31-20-117.us-west-2.compute.internal>\n\n* [Bugfix] FA2 illegal memory access ( vllm-project#12848 )\n\n* Make vllm compatible with verl ( vllm-project#12824 )\n\nCo-authored-by: zhangshulai <zhangshulai@bytedance.com>\n\n* [Bugfix] Missing quant_config in deepseek embedding layer ( vllm-project#12836 )\n\n* Prevent unecessary requests to huggingface hub ( vllm-project#12837 )\n\n* [MISC][EASY] Break check file names into entry and args in the pre-commit hooks ( vllm-project#12880 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Misc] Remove unnecessary detokenization in multimodal processing ( vllm-project#12868 )\n\n* PR vllm-project#12718 ( vllm-project#12718 )\n\n* [V1] Logprobs and prompt logprobs support ( vllm-project#9880 )\n\nThis PR is adding support for sample logprobs & prompt logprobs to vLLM v1.\n\nNew behavior:\n\n- During model execution, model runner computes sample logprobs (if user-provided logprobs setting is not None) and prompt logprobs (if user-provided prompt_logprobs setting is not None). For both sample and prompt logprobs, the engine core returns 3 vectors: token ids, token logprob values, token ranks. Ranks reflect tokens' 1-indexed positions in the vocabulary vector after sorting the vocabulary by log probability in descending order.\n- In scheduler.update_from_output(), sample and prompt logprobs are incorporated into the EngineCoreOutput data structure which is transferred to the engine client. If multiprocessing is enabled, then sample and prompt logprobs will be (de)serialized when the EngineCoreOutput data structure is (de)serialized.\n- During output processing, the LogprobsProcessor transforms the triplet of token ids, token logprobs values, and token ranks into the OpenAI-compatible List[Dict[token id,Logprob]] format (for sample and prompt logprobs respectively.)\n- Each Logprob instance (whether sample- or prompt-) consists of a token's log-probability, rank, and detokenized string representation. Note that logprob detokenization is handled by the LogprobsProcessor not the detokenizer.\n\nSigned-off-by: Andrew Feldman <afeldman@neuralmagic.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\n\n\nCo-authored-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\n\n* [ROCm] [Feature] [Doc] [Dockerfile] [BugFix] Support Per-Token-Activation Per-Channel-Weight FP8 Quantization Inferencing ( vllm-project#12501 )\n\n* fix rocm get_device name for moe configs ( #359 )\n\n* fix rocm get_device name\n\nuse 'market_name'\nhard-code names for mi308 & mi300\n\n* use gfx and num_CU for device name\n\n* using market_name\n\n* rename MI325_OAM to MI325X\n\n* rm (duplicate) MI300X_OAM\n\n* rename mi308\n\n* [V1] LM Eval With Streaming Integration Tests ( vllm-project#11590 )\n\n* [Bugfix] Fix disagg hang caused by the prefill and decode communication issues ( vllm-project#12723 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [V1][Minor] Remove outdated comment ( vllm-project#12928 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1] Move KV block hashes from Request to KVCacheManager ( vllm-project#12922 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix] Fix Qwen2_5_VLForConditionalGeneration packed_modules_mapping ( vllm-project#12905 )\n\n* [Misc] Fix typo in the example file ( vllm-project#12896 )\n\nSigned-off-by: Zhao Ke <yingxiongraomingzk@gmail.com>\n\n* [Bugfix] Fix multi-round chat error when mistral tokenizer is used ( vllm-project#12859 )\n\nSigned-off-by: Zifei Tong <zifeitong@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\n\n* [bugfix] respect distributed_executor_backend in world_size=1 ( vllm-project#12934 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Add offline test for disaggregated prefill ( vllm-project#12418 )\n\n* [V1][Minor] Move cascade attn logic outside _prepare_inputs ( vllm-project#12943 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Build] Make pypi install work on CPU platform ( vllm-project#12874 )\n\n* [Hardware][Intel-Gaudi] Enable long-contexts + LoRA support for Intel Gaudi ( vllm-project#12812 )\n\nSigned-off-by: Sanju C Sudhakaran <scsudhakaran@habana.ai>\n\n* [misc]  Add LoRA to benchmark_serving ( vllm-project#12898 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Misc] Log time consumption on weight downloading ( vllm-project#12926 )\n\n* [CI] Resolve transformers-neuronx version conflict ( vllm-project#12925 )\n\n* [Doc] Correct HF repository for TeleChat2 models ( vllm-project#12949 )\n\n* [Misc] Add qwen2.5-vl BNB support ( vllm-project#12944 )\n\n* [CI/Build] Auto-fix Markdown files ( vllm-project#12941 )\n\n* [Bugfix] Remove unused seq_group_metadata_list from ModelInputForGPU ( vllm-project#12935 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [bugfix] fix early import of flash attention ( vllm-project#12959 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [VLM] Merged multi-modal processor for GLM4V ( vllm-project#12449 )\n\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\n\n* [V1][Minor] Remove outdated comment ( vllm-project#12968 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [RFC] [Mistral] FP8 format ( vllm-project#10130 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\n\n* [V1] Cache `uses_mrope` in GPUModelRunner ( vllm-project#12969 )\n\n* [core] port pynvml into vllm codebase ( vllm-project#12963 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [MISC] Always import version library first in the vllm package ( vllm-project#12979 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [core] improve error handling when wake up from sleep mode ( vllm-project#12981 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [core][rlhf] add colocate example for RLHF ( vllm-project#12984 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [V1] Use msgpack for core request serialization ( vllm-project#12918 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* Check if selected backend is None in get_attn_backend_cls() ( vllm-project#12975 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [core] fix sleep mode and pytorch checkpoint compatibility ( vllm-project#13001 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Doc] Add link to tool_choice tracking issue in tool_calling.md ( vllm-project#13003 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [misc] Add retries with exponential backoff for HF file existence check ( vllm-project#13008 )\n\n* [Bugfix] Clean up and fix multi-modal processors ( vllm-project#13012 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* Fix seed parameter behavior in vLLM ( vllm-project#13007 )\n\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\n\n* Fixing the output formatting ( #414 )\n\n* [Model] Ultravox Model: Support v0.5 Release ( vllm-project#12912 )\n\nSigned-off-by: Farzad Abdolhosseini <farzad@fixie.ai>\n\n* [misc] Fix setup.py condition to avoid AMD from being mistaken with CPU ( vllm-project#13022 )\n\nSigned-off-by: kevin <kevin@anyscale.com>\n\n* [V1][Minor] Move scheduler outputs to a separate file ( vllm-project#13062 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Docs] Annouce Meta Meetup ( vllm-project#13065 )\n\nSigned-off-by: simon-mo <simon.mo@hey.com>\n\n* [Bugfix] Support missing tool parameters in mistral tokenizer ( vllm-project#12884 )\n\nSigned-off-by: Florian Greinacher <florian.greinacher@siemens.com>\n\n* [Benchmark] Add BurstGPT to benchmark_serving ( vllm-project#13063 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\n\n* [Core] Don't do platform detection at import time ( vllm-project#12933 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [Misc] LoRA - Refactor Punica ops tests ( vllm-project#12970 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [Bugfix]: Reasoning output bug according to the chat template change ( vllm-project#13025 )\n\nSigned-off-by: Ce Gao <cegao@tensorchord.ai>\n\n* [V1][Metrics] Add GPU prefix cache hit rate % gauge ( vllm-project#12592 )\n\n* [executor] init `local_rank` as device index ( vllm-project#13027 )\n\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\n\n* [ROCm] Using a more precise memory profiling ( vllm-project#12624 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [Build] Fix cuda link target of cumem_allocator in CPU env ( vllm-project#12863 )\n\nSigned-off-by: YuhongGuo <yuhong.gyh@antgroup.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* [Platform] add pre_register_and_update function ( vllm-project#12432 )\n\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\n\n* [Bugfix] fix flaky test ( vllm-project#13089 )\n\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\n\n* [V1][Metrics] Add several request timing histograms ( vllm-project#12644 )\n\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\n\n* Set `torch_dtype` in `TransformersModel` ( vllm-project#13088 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Misc] Fix typo at comments at metrics.py ( vllm-project#13024 )\n\n* [Bugfix] Do not use resource module on Windows ( vllm-project#12858 ) ( vllm-project#13029 )\n\n* [BugFix] Pop instead of del CUDA_VISIBLE_DEVICES ( vllm-project#12962 )\n\nSigned-off-by: Hollow Man <hollowman@opensuse.org>\n\n* Fix initializing GGUF weights for ColumnParallelLinear when using tensor parallel > 1 ( vllm-project#13023 )\n\n* Add tuned moe config for qwen1.5_moe_A2.7B ( #398 )\n\n* Add tuned moe config for qwen1.5_moe_A2.7B\n\n* Add more sweep parameters on qwen2_moe\n\n* Add tp = 1,2,4,8 after applying PR12838\n\n* Rename config name by deleting \"_OAM\"\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\n\n* [CI/Build][Bugfix] Fix CPU backend default threads num ( vllm-project#13077 )\n\n* Removing non-existent parameter\n\n* [Doc] Improve OpenVINO installation doc ( vllm-project#13102 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Bugfix] Guided decoding falls back to outlines when fails to import xgrammar ( vllm-project#12976 )\n\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\n\n* [Misc] Move pre-commit suggestion back to the end ( vllm-project#13114 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [RFC][vllm-API] Support tokenizer registry for customized tokenizer in vLLM ( vllm-project#12518 )\n\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\n\n* [Model] IBM/NASA Prithvi Geospatial model  ( vllm-project#12830 )\n\n* [ci] Add more source file dependencies for some tests ( vllm-project#13123 )\n\nSigned-off-by: <>\nCo-authored-by: EC2 Default User <ec2-user@ip-172-31-20-117.us-west-2.compute.internal>\n\n* [Neuron][Kernel] Support Longer Sequences in NKI-based Flash PagedAttention and Improve Efficiency ( vllm-project#12921 )\n\nSigned-off-by: Lingfan Yu <lingfany@amazon.com>\n\n* Bump helm/kind-action from 1.10.0 to 1.12.0 ( vllm-project#11612 )\n\n* Bump actions/stale from 9.0.0 to 9.1.0 ( vllm-project#12462 )\n\n* Bump helm/chart-testing-action from 2.6.1 to 2.7.0 ( vllm-project#12463 )\n\n* Bump actions/setup-python from 5.3.0 to 5.4.0 ( vllm-project#12672 )\n\n* Further reduce the HTTP calls to huggingface.co ( vllm-project#13107 )\n\n* [Misc] AMD Build Improvements ( vllm-project#12923 )\n\n* [Bug] [V1] Try fetching stop_reason from EngineOutput before checking the request ( vllm-project#13108 )\n\n* [Bugfix] Fix num video tokens calculation for Qwen2-VL ( vllm-project#13148 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Frontend] Generate valid tool call IDs when using `tokenizer-mode=mistral` ( vllm-project#12332 )\n\n* [Misc] Delete unused LoRA modules ( vllm-project#13151 )\n\n* Introduce VLLM_CUDART_SO_PATH to allow users specify the .so path ( vllm-project#12998 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [CI/Build] Use mypy matcher for pre-commit CI job ( vllm-project#13162 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* Update Benchmark Profiling Scripts ( #417 )\n\n* Update profiling benchmarks\n\n* Fix linter errors\n\n---------\n\nCo-authored-by: AdrianAbeyta <Adrian.Abeyta@amd.com>\n\n* [CORE] [QUANT] Support for GPTQModel's `dynamic` quantization per module override/control ( vllm-project#7086 )\n\n* [Bugfix] Allow fallback to AWQ from AWQMarlin at per-layer granularity ( vllm-project#13119 )\n\n* DS V2V3 fix for same file\n\n* Lint\n\n* updating manfiest ( #416 )\n\n* [CI] Fix failing FP8 cpu offload test ( vllm-project#13170 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* Aiter base ( #419 )\n\n* Using upstream FA repo. Building aiter in the base docker image\n\n* Renaming the file to match upstream naming\n\n* [V1][Bugfix] Copy encoder input ids to fix set iteration issue during VLM abort ( vllm-project#13173 )\n\nSigned-off-by: andoorve <37849411+andoorve@users.noreply.github.com>\n\n* [CI/Build] Ignore ruff warning up007 ( vllm-project#13182 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [perf-benchmark] cleanup unused Docker images and volumes in H100 benchmark instance ( vllm-project#12706 )\n\n* [NVIDIA] Support nvfp4 quantization ( vllm-project#12784 )\n\n* [Bugfix][Example] Fix GCed profiling server for TPU ( vllm-project#12792 )\n\nSigned-off-by: mgoin <michael@neuralmagic.com>\n\n* [VLM] Implement merged multimodal processor for Mllama ( vllm-project#11427 )\n\n* Simplify logic of locating CUDART so file path ( vllm-project#13203 )\n\nSigned-off-by: Lu Fang <lufang@fb.com>\n\n* [Build] Automatically use the wheel of the base commit with Python-only build ( vllm-project#13178 )\n\n* [Bugfix] deepseek_r1_reasoning_parser put reason content in wrong field in certain edge case ( vllm-project#13097 )\n\n* [Frontend] Move CLI code into vllm.cmd package ( vllm-project#12971 )\n\n* Allow Unsloth Dynamic 4bit BnB quants to work ( vllm-project#12974 )\n\n* [CI/Build] Allow ruff to auto-fix some issues ( vllm-project#13180 )\n\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\n\n* [V1][core] Implement pipeline parallel on Ray ( vllm-project#12996 )\n\n* [VLM] Remove input processor from clip and siglip ( vllm-project#13165 )\n\n* [Frontend] Pass pre-created socket to uvicorn ( vllm-project#13113 )\n\n* [V1] Clarify input processing and multimodal feature caching logic ( vllm-project#13211 )\n\n* [VLM] Merged multi-modal processor for Molmo ( vllm-project#12966 )\n\n* [V1][Core] Add worker_base for v1 worker ( vllm-project#12816 )\n\nSigned-off-by: Aoyu <aoyuzhan@amazon.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Aoyu <aoyuzhan@amazon.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\n\n* [Misc] Qwen2.5-VL Optimization ( vllm-project#13155 )\n\n* [VLM] Separate text-only and vision variants of the same model architecture ( vllm-project#13157 )\n\n* [Bugfix] Missing Content Type returns 500 Internal Server Error ( vllm-project#13193 )\n\n* [Frontend] Add `/v1/audio/transcriptions` OpenAI API endpoint ( vllm-project#12909 )\n\n* Initial attempt to adjust codeowners to the ROCm fork ( #420 )\n\n* Applying weight padding to deepseek ( #421 )\n\n* Add label if pre-commit passes ( vllm-project#12527 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* [Model] DeepSeek Tunings ( #423 )\n\n* fused_moe config for DSv3 on MI300X updated\n\n* Add tuning script and post processing script\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* Add modification to fp8_utils for tuning\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* update tuning script and add the configs\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* slightly better tunings\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* benchmark_moe.py is updated to generate more accurate MoE configs and a specific MoE config for DSv3 is added\n\n* Bug in sgl_moe_align_block_size() is fixed by Greg\n\n* Generate fp8_w8a8 config for MI300XHF\n\n* tunings that don't give garbage output\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* More accurate tunings\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* More accurate tunings and reject inaccurate configs\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* add new tunings\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* rename tuning script and add benchmark script to use for optimizing blockwise quant\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* remove white space from file names\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* remove white space from file names\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* Remove some unnecessary changes\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* don't use space in file names\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* remove XHF tunings\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* remove OAM from file name\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* rmeove OAM from file names\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* yapf\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* update config name\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* remove benchmark_moe.py changes\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* remove is_contiguous\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* use more recent fp8_utils.py\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n* remove is_contiguous\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\n\n---------\n\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\n\n* Optimize moe_align_block_size for deepseek_v3 ( vllm-project#12850 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Kernel][Bugfix] Refactor and Fix CUTLASS 2:4 Sparse Kernels ( vllm-project#13198 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\n\n* Revert \"Add label if pre-commit passes\" ( vllm-project#13242 )\n\n* [ROCm] Avoid using the default stream on ROCm ( vllm-project#13238 )\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* [Kernel] Fix awq error when n is not divisable by 128 ( vllm-project#13227 )\n\n* [V1] Consolidate MM cache size to vllm.envs ( vllm-project#13239 )\n\n* [Bugfix/CI] Turn test_compressed_tensors_2of4_sparse back on ( vllm-project#13250 )\n\n* [Bugfix][CI] Inherit codespell settings from pyproject.toml in the pre-commit-config ( vllm-project#13237 )\n\n* [Bugfix] Offline example of disaggregated prefill ( vllm-project#13214 )\n\n* [Misc] Remove redundant statements in scheduler.py ( vllm-project#13229 )\n\n* Consolidate Llama model usage in tests ( vllm-project#13094 )\n\n* Expand MLA to support most types of quantization ( vllm-project#13181 )\n\n* [V1] LoRA - Enable Serving Usecase ( vllm-project#12883 )\n\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\n\n* [ROCm][V1] Add intial ROCm support to V1 ( vllm-project#12790 )\n\n* [Bugfix][V1] GPUModelRunner._update_states should return True when there is a finished request in batch ( vllm-project#13126 )\n\n* [WIP] TPU V1 Support Refactored ( vllm-project#13049 )\n\n* [Frontend] Optionally remove memory buffer used for uploading to URLs in run_batch ( vllm-project#12927 )\n\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\n\n* [Bugfix] Fix missing parentheses ( vllm-project#13263 )\n\n* [Misc] Log time consumption of sleep and wake-up ( vllm-project#13115 )\n\nSigned-off-by: Jun Duan <jun.duan.phd@outlook.com>\n\n* [VLM] Keep track of whether prompt replacements have been applied ( vllm-project#13215 )\n\n* [V1] Simplify GPUModelRunner._update_states check ( vllm-project#13265 )\n\n* Support logit_bias in v1 Sampler ( vllm-project#13079 )\n\n* [Core] choice-based structured output with xgrammar ( vllm-project#12632 )\n\n* [Hardware][Gaudi][Bugfix] Fix error for guided decoding ( vllm-project#12317 )\n\n* Removing bad config ( #425 )\n\n* The order in the file is important. One needs to be explicitly be added to each following path for their ownership to apply ( #427 )\n\n* [Quant][Perf] Use moe_wna16 kernel by default for MoEs with many experts ( vllm-project#13236 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\n\n* [Core] Reduce TTFT with concurrent partial prefills ( vllm-project#10235 )\n\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Prashant Gupta <prashantgupta@us.ibm.com>\nCo-authored-by: Prashant Gupta <prashantgupta@us.ibm.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\n\n* [V1][Core] min_p sampling support ( vllm-project#13191 )\n\nSigned-off-by: Aoyu <aoyuzhan@amazon.com>\nCo-authored-by: Aoyu <aoyuzhan@amazon.com>\n\n* [V1][CI] Fix failed v1-test because of min_p ( vllm-project#13316 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1][Sampler] Don't apply temp for greedy-only ( vllm-project#13311 )\n\nSigned-off-by: Nick Hill <nhill@redhat.com>\n\n* [V1][PP] Fix memory profiling in PP ( vllm-project#13315 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix][AMD] Update torch_bindings so that scaled_fp4_quant isn't build on ROCm ( vllm-project#13235 )\n\n* [Bugfix][Docs] Fix offline Whisper ( vllm-project#13274 )\n\n* [Bugfix] Massage MLA's usage of flash attn for RoCM ( vllm-project#13310 )\n\n* [BugFix] Don't scan entire cache dir when loading model ( vllm-project#13302 )\n\n* [Bugfix]Fix search start_index of stop_checker ( vllm-project#13280 )\n\n* [Bugfix] Fix qwen2.5-vl image processor ( vllm-project#13286 )\n\n* [V1][Metrics] Add iteration_tokens_total histogram from V0 ( vllm-project#13288 )\n\n* [AMD] [Model] DeepSeek tunings ( vllm-project#13199 )\n\n* [V1][PP] Run engine busy loop with batch queue ( vllm-project#13064 )\n\n* [ci/build] update flashinfer ( vllm-project#13323 )\n\n* [Doc] [2/N] Add Fuyu E2E example for multimodal processor ( vllm-project#13331 )\n\n* [V1][Spec Decode] Ngram Spec Decode  ( vllm-project#12193 )\n\nSigned-off-by: LiuXiaoxuanPKU <lilyliupku@gmail.com>\n\n* [Quant] Add `SupportsQuant` to phi3 and clip ( vllm-project#13104 )\n\n* [Bugfix] Pin xgrammar to 0.1.11 ( vllm-project#13338 )\n\n* avoid calling hf_list_repo_files for local model\n\nSigned-off-by: isotr0py <2037008807@qq.com>\n\n* annotation\n\nSigned-off-by: isotr0py <2037008807@qq.com>\n\n* [BugFix] Enhance test_pos_encoding to support execution on multi-devices ( vllm-project#13187 )\n\nSigned-off-by: wchen61 <wchen61@foxmail.com>\n\n* [V1] Update doc and examples for H2O-VL ( vllm-project#13349 )\n\nSigned-off-by: Roger Wang <ywang@roblox.com>\n\n* [ci] skip failed tests for flashinfer ( vllm-project#13352 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [platform] add base class for communicators ( vllm-project#13208 )\n\nSigned-off-by: youkaichao <youkaichao@gmail.com>\n\n* [Bugfix] Fix 2 Node and Spec Decode tests ( vllm-project#13341 )\n\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\n\n* [Docs] Change myenv to vllm. Update python_env_setup.inc.md ( vllm-project#13325 )\n\n* [V1][BugFix] Add __init__.py to v1/spec_decode/ ( vllm-project#13359 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1][PP] Cache Intermediate Tensors ( vllm-project#13353 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [Bugfix][Platform][CPU] Fix cuda platform detection on CPU backend edge case ( vllm-project#13358 )\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* [V1][BugFix] Clean up rejection sampler & Fix warning msg ( vllm-project#13362 )\n\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\n\n* [V1][Misc] Avoid unnecessary log output ( vllm-project#13289 )\n\n* [Feature][Spec Decode] Simplify the use of Eagle Spec Decode ( vllm-project#12304 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* Fix spelling error in index.md ( vllm-project#13369 )\n\n* Run v1 benchmark and integrate with PyTorch OSS benchmark database ( vllm-project#13068 )\n\nSigned-off-by: Huy Do <huydhn@gmail.com>\n\n* [MISC] tiny fixes ( vllm-project#13378 )\n\n* [VLM] Check required fields before initializing field config in `DictEmbeddingItems` ( vllm-project#13380 )\n\n* [Model] Support Mamba2 (Codestral Mamba) ( vllm-project#9292 )\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Yu Chin Fabian Lim <flim@sg.ibm.com>\n\n* [Bugfix] fix xpu communicator ( vllm-project#13368 )\n\nSigned-off-by: yan ma <yan.ma@intel.com>\n\n* [Bugfix] Fix VLLM_USE_MODELSCOPE issue ( vllm-project#13384 )\n\n* Updating PR template to point people to the upstream repo. Updating codeowners ( #431 )\n\n* Enabling the ROCm-vLLM CI on MI250 machines ( #432 )\n\n* Enabling ROCm CI on MI250 machines:\n- correct build target\n- correct queue\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n---------\n\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\n\n* Optimization for quantized gemm skinny sizes ( #411 )\n\n* Optimization for quantized gemm skinny sizes\n\n* lint fix\n\n* Add support for bf16/fp16\n\n* code cleanup\n\n* code cleanup\n\n* lint fix2\n\n* cleanup\n\n* Moved the logic into tuned gemm to preserve API compatibility\n\n---------\n\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* Restricting FP8 wvSplitk to MI300x ( #439 )\n\n* Remove mi300a ( #440 )\n\n* Removing gfx940 and gfx941 targets. These have been deprecated in favor of gfx942 for MI300X\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* Remove from custom kernels as well\n\n---------\n\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\n\n* resolve diff for mixtral8x7B configs ( #437 )\n\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\n\n* Torch version bump to fix tunable ops ( #442 )\n\n* Advance torch commit to be past pytorch/pytorch#144942 to fix tunable ops\n\n* Make sure to use the submodule commit compatible with the main aiter commit\n\n* bugfix: remove unused  argument passed to the forward pass of ReplicatedLinear layer\n\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\n\n---------\n\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Kyle Sayers <kylesayrs@gmail.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nSigned-off-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nSigned-off-by: Lu Fang <lufang@fb.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: EC2 Default User <ec2-user@ip-172-31-20-117.us-west-2.compute.internal>\nSigned-off-by: <>\nSigned-off-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nSigned-off-by: Yu Chin Fabian Lim <flim@sg.ibm.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Zhao Ke <yingxiongraomingzk@gmail.com>\nSigned-off-by: Zifei Tong <zifeitong@gmail.com>\nSigned-off-by: Sanju C Sudhakaran <scsudhakaran@habana.ai>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Nick Hill <nhill@redhat.com>\nSigned-off-by: Yuan Tang <terrytangyuan@gmail.com>\nSigned-off-by: DarkLight1337 <tlleungac@connect.ust.hk>\nSigned-off-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nSigned-off-by: Farzad Abdolhosseini <farzad@fixie.ai>\nSigned-off-by: kevin <kevin@anyscale.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Florian Greinacher <florian.greinacher@siemens.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: Ce Gao <cegao@tensorchord.ai>\nSigned-off-by: Mengqing Cao <cmq0113@163.com>\nSigned-off-by: YuhongGuo <yuhong.gyh@antgroup.com>\nSigned-off-by: wangxiyuan <wangxiyuan1007@gmail.com>\nSigned-off-by: Mark McLoughlin <markmc@redhat.com>\nSigned-off-by: Hollow Man <hollowman@opensuse.org>\nSigned-off-by: Keyun Tong <tongkeyun@gmail.com>\nSigned-off-by: Lingfan Yu <lingfany@amazon.com>\nSigned-off-by: andoorve <37849411+andoorve@users.noreply.github.com>\nSigned-off-by: Aoyu <aoyuzhan@amazon.com>\nSigned-off-by: Randall Smith <Randall.Smith@amd.com>\nSigned-off-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nSigned-off-by: Jun Duan <jun.duan.phd@outlook.com>\nSigned-off-by: Joe Runde <Joseph.Runde@ibm.com>\nSigned-off-by: Prashant Gupta <prashantgupta@us.ibm.com>\nSigned-off-by: LiuXiaoxuanPKU <lilyliupku@gmail.com>\nSigned-off-by: isotr0py <2037008807@qq.com>\nSigned-off-by: wchen61 <wchen61@foxmail.com>\nSigned-off-by: Roger Wang <ywang@roblox.com>\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Huy Do <huydhn@gmail.com>\nSigned-off-by: yan ma <yan.ma@intel.com>\nSigned-off-by: Alexei V. Ivanov <alexei.ivanov@amd.com>\nSigned-off-by: Divakar Verma <divakar.verma@amd.com>\nSigned-off-by: vllmellm <vllm.ellm@embeddedllm.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Isotr0py <mozf@mail2.sysu.edu.cn>\nCo-authored-by: Dipika Sikka <dipikasikka1@gmail.com>\nCo-authored-by: Kyle Sayers <kylesayrs@gmail.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: Nick Hill <nickhill@us.ibm.com>\nCo-authored-by: Akash kaothalkar <61960177+Akashcodes732@users.noreply.github.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Gregory Shtrasberg <156009573+gshtras@users.noreply.github.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Sanju C Sudhakaran <scsudhakaran@habana.ai>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Cyrus Leung <tlleungac@connect.ust.hk>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Lu Fang <30275821+houseroad@users.noreply.github.com>\nCo-authored-by: Sumit Vij <sumitvij11+github@gmail.com>\nCo-authored-by: Simon Mo <simon.mo@hey.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: EC2 Default User <ec2-user@ip-172-31-20-117.us-west-2.compute.internal>\nCo-authored-by: arakowsk-amd <182798202+arakowsk-amd@users.noreply.github.com>\nCo-authored-by: Jitse Klomp <jitse@jitseklomp.nl>\nCo-authored-by: Varun Sundar Rabindranath <varunsundar08@gmail.com>\nCo-authored-by: Varun Sundar Rabindranath <varun@neuralmagic.com>\nCo-authored-by: Yu Chin Fabian Lim <fabianlim@users.noreply.github.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: ZSL98 <36250440+ZSL98@users.noreply.github.com>\nCo-authored-by: zhangshulai <zhangshulai@bytedance.com>\nCo-authored-by: Szymon OÅ¼Ã³g <58388001+SzymonOzog@users.noreply.github.com>\nCo-authored-by: Maximilien de Bayser <mbayser@br.ibm.com>\nCo-authored-by: Amit Garg <mitgarg17495@gmail.com>\nCo-authored-by: afeldman-nm <156691304+afeldman-nm@users.noreply.github.com>\nCo-authored-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nCo-authored-by: Nick Hill <nhill@redhat.com>\nCo-authored-by: Divakar Verma <137818590+divakar-amd@users.noreply.github.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Ke Zhao <yingxiongraomingzk@gmail.com>\nCo-authored-by: zifeitong <zifeitong@gmail.com>\nCo-authored-by: Cyrus Leung <cyrus.tl.leung@gmail.com>\nCo-authored-by: Shaoting <shaotingf@uchicago.edu>\nCo-authored-by: wangxiyuan <wangxiyuan1007@gmail.com>\nCo-authored-by: Jun Duan <jun.duan.phd@outlook.com>\nCo-authored-by: Liangfu Chen <liangfc@amazon.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: Patrick von Platen <patrick.v.platen@gmail.com>\nCo-authored-by: mgoin <mgoin64@gmail.com>\nCo-authored-by: Yuan Tang <terrytangyuan@gmail.com>\nCo-authored-by: à®®à®©à¯‹à®œà¯à®•à¯à®®à®¾à®°à¯ à®ªà®´à®©à®¿à®šà¯à®šà®¾à®®à®¿ <smartmanoj42857@gmail.com>\nCo-authored-by: Farzad Abdolhosseini <farzad.abdolhosseini@gmail.com>\nCo-authored-by: Gregory Shtrasberg <Gregory.Shtrasberg@amd.com>\nCo-authored-by: Florian Greinacher <florian.greinacher@siemens.com>\nCo-authored-by: Ce Gao <cegao@tensorchord.ai>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Mengqing Cao <cmq0113@163.com>\nCo-authored-by: Yuhong Guo <yuhong.gyh@antgroup.com>\nCo-authored-by: Mark McLoughlin <markmc@redhat.com>\nCo-authored-by: Jewon Lee <105219284+je1lee@users.noreply.github.com>\nCo-authored-by: MoonRide303 <130458190+MoonRide303@users.noreply.github.com>\nCo-authored-by: â„ð• ð•ð•ð• ð•¨ ð•„ð•’ð•Ÿ <hollowman@opensuse.org>\nCo-authored-by: sky0530 <weiching0530@gmail.com>\nCo-authored-by: Li, Jiang <jiang1.li@intel.com>\nCo-authored-by: Keyun Tong <tongkeyun@gmail.com>\nCo-authored-by: Christian Pinto <chrpinto@gmail.com>\nCo-authored-by: Lingfan Yu <lingfany@amazon.com>\nCo-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>\nCo-authored-by: Shiyan Deng <842974287@qq.com>\nCo-authored-by: bnellnm <49004751+bnellnm@users.noreply.github.com>\nCo-authored-by: Rafael Vasquez <rafvasq21@gmail.com>\nCo-authored-by: Adrian Abeyta <adabeyta@amd.com>\nCo-authored-by: AdrianAbeyta <Adrian.Abeyta@amd.com>\nCo-authored-by: Qubitium-ModelCloud <qubitium@modelcloud.ai>\nCo-authored-by: Yida Wu <yida.wu@amd.com>\nCo-authored-by: Murali Andoorveedu <37849411+andoorve@users.noreply.github.com>\nCo-authored-by: Kaixi Hou <kaixih@nvidia.com>\nCo-authored-by: LikeSundayLikeRain <monsoon1013@gmail.com>\nCo-authored-by: Daniel Han <danielhanchen@gmail.com>\nCo-authored-by: Rui Qiao <161574667+ruisearch42@users.noreply.github.com>\nCo-authored-by: Aoyu <aoyuzhang1989@gmail.com>\nCo-authored-by: Aoyu <aoyuzhan@amazon.com>\nCo-authored-by: ç‡ƒ <wulipc@163.com>\nCo-authored-by: Vaibhav Jain <vajain@redhat.com>\nCo-authored-by: NicolÃ² Lucchesi <nlucches@redhat.com>\nCo-authored-by: rasmith <Randall.Smith@amd.com>\nCo-authored-by: qli88 <qiang.li2@amd.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: XiaobingZhang <xiaobingzhangupc@gmail.com>\nCo-authored-by: Wang Ran (æ±ªç„¶) <wrran@outlook.com>\nCo-authored-by: Sage Moore <sage@neuralmagic.com>\nCo-authored-by: Kero Liang <kerorek@outlook.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-redhat@users.noreply.github.com>\nCo-authored-by: Pooya Davoodi <pooya.davoodi@parasail.io>\nCo-authored-by: Xu Song <xusong.vip@gmail.com>\nCo-authored-by: Yu-Zhou <yu.zhou@intel.com>\nCo-authored-by: Joe Runde <Joseph.Runde@ibm.com>\nCo-authored-by: Prashant Gupta <prashantgupta@us.ibm.com>\nCo-authored-by: Lily Liu <lilyliupku@gmail.com>\nCo-authored-by: isotr0py <2037008807@qq.com>\nCo-authored-by: wchen61 <wchen61@foxmail.com>\nCo-authored-by: å‡Œ <i@ioioi.cn>\nCo-authored-by: yankooo <948162199@qq.com>\nCo-authored-by: Huy Do <huydhn@gmail.com>\nCo-authored-by: Yu Chin Fabian Lim <flim@sg.ibm.com>\nCo-authored-by: Yan Ma <yan.ma@intel.com>\nCo-authored-by: r.4ntix <antix.blue@gmail.com>\nCo-authored-by: Alexei-V-Ivanov-AMD <156011006+Alexei-V-Ivanov-AMD@users.noreply.github.com>\nCo-authored-by: Hashem Hashemi <159079214+amd-hhashemi@users.noreply.github.com>\nCo-authored-by: vllmellm <vllm.ellm@embeddedllm.com> mgoin mentioned this pull request Apr 5, 2025 [Kernel] Use moe_wna16 kernel for compressed tensors wna16 moe models #16038 Merged lulmer pushed a commit\n        to lulmer/vllm\n      that referenced\n      this pull request Apr 7, 2025 [Quant][Perf] Use moe_wna16 kernel by default for MoEs with many expeâ€¦ â€¦ ce61da9 â€¦rts ( vllm-project#13236 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com>\nSigned-off-by: Louis Ulmer <ulmerlouis@gmail.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 [Quant][Perf] Use moe_wna16 kernel by default for MoEs with many expeâ€¦ â€¦ 4abde6f â€¦rts ( vllm-project#13236 )\n\nSigned-off-by: mgoin <mgoin64@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:42", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: TTFT, benchmark_serving, benchmark_serving | SERVING: Serving, Frontend, Frontend | TEST: test, test, Test", "analysis_extracted_at": "2025-09-07 17:52:42", "models": ["mistralai/Mistral-7B-Instruct-v0.3", "Qwen/Qwen2.5-7B-Instruct"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=mistralai/Mistral-7B-Instruct-v0.3,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100", "lm_eval --model vllm --model_args pretrained=Qwen/Qwen2.5-7B-Instruct,dtype=float16 --tasks hellaswag,arc_challenge --batch_size auto --limit 100"], "perf_command": "python benchmarks/benchmark_serving.py --model mistralai/Mistral-7B-Instruct-v0.3 --dtype float16 --num-prompts 300 --seed 0", "commit_subject": "[Quant][Perf] Use moe_wna16 kernel by default for MoEs with many experts (#13236)", "commit_message": "[Quant][Perf] Use moe_wna16 kernel by default for MoEs with many experts (#13236)\n\nSigned-off-by: mgoin <mgoin64@gmail.com>", "commit_date": "2025-02-14T12:53:42-08:00", "files_changed": ["tests/weight_loading/test_weight_loading.py", "vllm/model_executor/layers/quantization/awq_marlin.py", "vllm/model_executor/layers/quantization/gptq_marlin.py", "vllm/model_executor/layers/quantization/moe_wna16.py"], "functions_changed": [], "stats": {"num_test_files": 1, "num_non_test_files": 3, "only_test_files": 0, "only_non_test_files": 0, "num_files": 4, "num_hunks": 12, "num_edited_lines": 65, "num_non_test_edited_lines": 63, "commit_year": 2025}, "diff_text": "diff --git a/tests/weight_loading/test_weight_loading.py b/tests/weight_loading/test_weight_loading.py\nindex e456bfab8..9d6b25da7 100644\n--- a/tests/weight_loading/test_weight_loading.py\n+++ b/tests/weight_loading/test_weight_loading.py\n@@ -12,7 +12,7 @@ MODEL_NAME = os.environ.get(\"MODEL_NAME\",\n                             \"robertgshaw2/zephyr-7b-beta-channelwise-gptq\")\n REVISION = os.environ.get(\"REVISION\", \"main\")\n QUANTIZATION = os.environ.get(\"QUANTIZATION\", \"gptq_marlin\")\n-MIN_CAPABILITY = os.environ.get(\"MIN_CAPABILITY\", \"89\")\n+MIN_CAPABILITY = os.environ.get(\"MIN_CAPABILITY\", \"80\")\n \n \n @pytest.mark.skipif(\ndiff --git a/vllm/model_executor/layers/quantization/awq_marlin.py b/vllm/model_executor/layers/quantization/awq_marlin.py\nindex a43b2e597..de4009d7d 100644\n--- a/vllm/model_executor/layers/quantization/awq_marlin.py\n+++ b/vllm/model_executor/layers/quantization/awq_marlin.py\n@@ -17,6 +17,7 @@ from vllm.model_executor.layers.quantization.awq import (AWQConfig,\n                                                          is_layer_skipped_awq)\n from vllm.model_executor.layers.quantization.base_config import (\n     QuantizationConfig, QuantizeMethodBase)\n+from vllm.model_executor.layers.quantization.moe_wna16 import MoeWNA16Config\n from vllm.model_executor.layers.quantization.utils import replace_parameter\n from vllm.model_executor.layers.quantization.utils.marlin_utils import (\n     apply_awq_marlin_linear, awq_to_marlin_zero_points, check_marlin_supported,\n@@ -134,7 +135,12 @@ class AWQMarlinConfig(QuantizationConfig):\n                     self.full_config).get_quant_method(layer, prefix)\n             return AWQMarlinLinearMethod(self)\n         elif isinstance(layer, FusedMoE):\n-            return AWQMoEMethod(self)\n+            if layer.num_experts > 32:\n+                # For MoEs with many experts the moe_wna16 kernel is faster\n+                return MoeWNA16Config.from_config(\n+                    self.full_config).get_quant_method(layer, prefix)\n+            else:\n+                return AWQMoEMethod(self)\n         return None\n \n     @classmethod\ndiff --git a/vllm/model_executor/layers/quantization/gptq_marlin.py b/vllm/model_executor/layers/quantization/gptq_marlin.py\nindex 0a9d86b00..f421dbd2c 100644\n--- a/vllm/model_executor/layers/quantization/gptq_marlin.py\n+++ b/vllm/model_executor/layers/quantization/gptq_marlin.py\n@@ -10,20 +10,18 @@ from vllm.logger import init_logger\n from vllm.model_executor.layers.fused_moe.layer import (\n     FusedMoE, FusedMoEMethodBase, FusedMoeWeightScaleSupported)\n from vllm.model_executor.layers.linear import (LinearMethodBase,\n-                                               UnquantizedLinearMethod,\n                                                set_weight_attrs)\n from vllm.model_executor.layers.quantization.base_config import (\n-    QuantizationConfig)\n+    QuantizationConfig, QuantizeMethodBase)\n from vllm.model_executor.layers.quantization.kernels.mixed_precision import (\n     MPLinearLayerConfig, choose_mp_linear_kernel)\n+from vllm.model_executor.layers.quantization.moe_wna16 import MoeWNA16Config\n from vllm.model_executor.layers.quantization.utils import replace_parameter\n from vllm.model_executor.layers.quantization.utils.gptq_utils import (\n     get_linear_quant_method)\n from vllm.model_executor.layers.quantization.utils.marlin_utils import (\n     check_marlin_supported, marlin_moe_permute_scales,\n     marlin_repeat_scales_on_all_ranks, verify_marlin_supported)\n-from vllm.model_executor.layers.vocab_parallel_embedding import (\n-    UnquantizedEmbeddingMethod)\n from vllm.model_executor.parameter import (ChannelQuantScaleParameter,\n                                            GroupQuantScaleParameter,\n                                            PackedColumnParameter,\n@@ -44,15 +42,10 @@ class GPTQMarlinConfig(QuantizationConfig):\n         (8, True): scalar_types.uint8b128,\n     }\n \n-    def __init__(\n-        self,\n-        weight_bits: int,\n-        group_size: int,\n-        desc_act: bool,\n-        is_sym: bool,\n-        lm_head_quantized: bool,\n-        dynamic: Dict[str, Dict[str, Union[int, bool]]],\n-    ) -> None:\n+    def __init__(self, weight_bits: int, group_size: int, desc_act: bool,\n+                 is_sym: bool, lm_head_quantized: bool,\n+                 dynamic: Dict[str, Dict[str, Union[int, bool]]],\n+                 full_config: Dict[str, Any]) -> None:\n         if desc_act and group_size == -1:\n             # In this case, act_order == True is the same as act_order == False\n             # (since we have only one group per output channel)\n@@ -90,6 +83,7 @@ class GPTQMarlinConfig(QuantizationConfig):\n         self.group_size = group_size\n         self.desc_act = desc_act\n         self.lm_head_quantized = lm_head_quantized\n+        self.full_config = full_config\n \n         if (weight_bits, is_sym) not in self.TYPE_MAP:\n             raise ValueError(\"Unsupported quantization config: \"\n@@ -132,7 +126,7 @@ class GPTQMarlinConfig(QuantizationConfig):\n         lm_head_quantized = cls.get_from_keys_or(config, [\"lm_head\"],\n                                                  default=False)\n         return cls(weight_bits, group_size, desc_act, is_sym,\n-                   lm_head_quantized, dynamic)\n+                   lm_head_quantized, dynamic, config)\n \n     @classmethod\n     def override_quantization_method(cls, hf_quant_cfg,\n@@ -155,12 +149,15 @@ class GPTQMarlinConfig(QuantizationConfig):\n                         \" faster inference\")\n         return None\n \n-    def get_quant_method(\n-        self, layer: torch.nn.Module, prefix: str\n-    ) -> Optional[Union[\"GPTQMarlinLinearMethod\", \"GPTQMarlinMoEMethod\",\n-                        UnquantizedLinearMethod, UnquantizedEmbeddingMethod]]:\n+    def get_quant_method(self, layer: torch.nn.Module,\n+                         prefix: str) -> Optional[\"QuantizeMethodBase\"]:\n         if isinstance(layer, FusedMoE):\n-            return GPTQMarlinMoEMethod(self)\n+            if layer.num_experts > 32:\n+                # For MoEs with many experts the moe_wna16 kernel is faster\n+                return MoeWNA16Config.from_config(\n+                    self.full_config).get_quant_method(layer, prefix)\n+            else:\n+                return GPTQMarlinMoEMethod(self)\n         return get_linear_quant_method(self, layer, prefix,\n                                        GPTQMarlinLinearMethod)\n \ndiff --git a/vllm/model_executor/layers/quantization/moe_wna16.py b/vllm/model_executor/layers/quantization/moe_wna16.py\nindex b9460e7d7..30eb04698 100644\n--- a/vllm/model_executor/layers/quantization/moe_wna16.py\n+++ b/vllm/model_executor/layers/quantization/moe_wna16.py\n@@ -9,13 +9,8 @@ from vllm.model_executor.layers.fused_moe.layer import (\n     FusedMoE, FusedMoEMethodBase, FusedMoeWeightScaleSupported)\n from vllm.model_executor.layers.linear import (LinearBase,\n                                                UnquantizedLinearMethod)\n-from vllm.model_executor.layers.quantization.awq import AWQConfig\n-from vllm.model_executor.layers.quantization.awq_marlin import AWQMarlinConfig\n from vllm.model_executor.layers.quantization.base_config import (\n     QuantizationConfig, QuantizeMethodBase)\n-from vllm.model_executor.layers.quantization.gptq import GPTQConfig\n-from vllm.model_executor.layers.quantization.gptq_marlin import (\n-    GPTQMarlinConfig)\n from vllm.model_executor.layers.quantization.utils.marlin_utils import (\n     check_marlin_supports_layer)\n from vllm.model_executor.utils import set_weight_attrs\n@@ -37,6 +32,12 @@ class MoeWNA16Config(QuantizationConfig):\n         self.linear_quant_method = linear_quant_method\n         self.full_config = full_config\n         self.use_marlin = False\n+        # Avoid circular import\n+        from vllm.model_executor.layers.quantization.awq import AWQConfig\n+        from vllm.model_executor.layers.quantization.awq_marlin import (\n+            AWQMarlinConfig)\n+        from vllm.model_executor.layers.quantization.gptq_marlin import (\n+            GPTQMarlinConfig)\n         if self.linear_quant_method == \"gptq\":\n             self.use_marlin = GPTQMarlinConfig.is_gptq_marlin_compatible(\n                 full_config)\n@@ -115,6 +116,8 @@ class MoeWNA16Config(QuantizationConfig):\n         capability_tuple = current_platform.get_device_capability()\n         device_capability = (-1 if capability_tuple is None else\n                              capability_tuple.to_int())\n+        # Avoid circular import\n+        from vllm.model_executor.layers.quantization.awq import AWQConfig\n         awq_min_capability = AWQConfig.get_min_capability()\n \n         gptq_compatible = quant_method == \"gptq\" and \\\n@@ -129,6 +132,13 @@ class MoeWNA16Config(QuantizationConfig):\n         if is_layer_skipped_quant(prefix, self.modules_to_not_convert):\n             return UnquantizedLinearMethod()\n         elif isinstance(layer, LinearBase):\n+            # Avoid circular import\n+            from vllm.model_executor.layers.quantization.awq import AWQConfig\n+            from vllm.model_executor.layers.quantization.awq_marlin import (\n+                AWQMarlinConfig)\n+            from vllm.model_executor.layers.quantization.gptq import GPTQConfig\n+            from vllm.model_executor.layers.quantization.gptq_marlin import (\n+                GPTQMarlinConfig)\n             if self.linear_quant_method == \"gptq\":\n                 if self.use_marlin:\n                     return GPTQMarlinConfig.from_config(", "apis": ["vllm.model_executor.layers.quantization.awq_marlin.AWQMarlinConfig.get_quant_method", "vllm.model_executor.layers.quantization.gptq_marlin.GPTQMarlinConfig.get_quant_method", "vllm.model_executor.layers.quantization.moe_wna16.MoeWNA16Config.get_quant_method"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/awq_marlin.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/gptq_marlin.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/moe_wna16.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The commit modifies non-test source files (e.g., quantization modules in awq_marlin.py, gptq_marlin.py, and moe_wna16.py) and introduces a branch that uses an optimized moe_wna16 kernel for MoEs with many experts. The intent is clearly to select a faster kernel when a layer has more than 32 experts, which will improve inference performance on CPU. This change is a performance optimization rather than a simple refactoring, bug fix, or documentation update. Although one file in tests was also modified, the significant changes are in non-test production code and are performance-related.", "llm_api_reason": "This commit adjusts the quantization method selection for MoE layers by adding a check on the number of experts. In both AWQMarlinConfig and GPTQMarlinConfig, if a FusedMoE layer has more than 32 experts, the quantization method is now switched to use the moe_wna16 kernel (via MoeWNA16Config.from_config(...)). Additionally, the default minimum GPU capability used in tests was relaxed from 89 to 80. These changes affect the public get_quant_method APIs in the AWQ and GPTQ marlin modules, as well as the MoeWNA16Configâ€™s method invoked via those paths.\n\n[APIS] vllm.model_executor.layers.quantization.awq_marlin.AWQMarlinConfig.get_quant_method, vllm.model_executor.layers.quantization.gptq_marlin.GPTQMarlinConfig.get_quant_method, vllm.model_executor.layers.quantization.moe_wna16.MoeWNA16Config.get_quant_method [APIS]"}
{"commit_hash": "b9986454fe8ba80e2a109d069397b6b59aae658b", "pr_url": "https://github.com/vllm-project/vllm/pull/12570", "pr_date": null, "timeline_text": "Copy link Contributor srikanthsrnvs commented Jan 30, 2025 â€¢ edited by github-actions bot Loading Uh oh! There was an error while loading. Please reload this page . Fix to AWQ quant loading of the new R1 model The new optimized MoE kernels for a large number of experts moe_wn16 uses AWQ quant which requires the attention layers to be in 16bit The current merge has broken this, and the get_quant_method must return None for it to work correctly again Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions srikanthsrnvs requested review from mgoin , robertgshaw2-redhat and tlrmchlsmth as code owners January 30, 2025 04:43 Copy link github-actions bot commented Jan 30, 2025 ðŸ‘‹ Hi! Thank you for contributing to the vLLM project. Just a reminder: PRs would not trigger full CI run by default. Instead, it would only run fastcheck CI which starts running only a small and essential subset of CI tests to quickly catch errors. You can run other CI tests on top of those by going to your fastcheck build on Buildkite UI (linked in the PR checks section) and unblock them. If you do not have permission to unblock, ping simon-mo or khluu to add you in our Buildkite org. Once the PR is approved and ready to go, your PR reviewer(s) can run CI to test the changes comprehensively before merging. To run CI, PR reviewers can do one of these: Add ready label to the PR Enable auto-merge. ðŸš€ All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mgoin approved these changes Jan 31, 2025 View reviewed changes Copy link Member mgoin left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Thank you, makes sense! Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions mgoin added quantization ready ONLY add when PR is ready to merge/full CI is needed labels Jan 31, 2025 srikanthsrnvs and others added 23 commits February 3, 2025 03:14 Fix for attention layers to remain unquantized during moe_wn16 quant â€¦ â€¦ 483b60c â€¦method\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> Set ?device={device} when changing tab in installation guides ( vllmâ€¦ â€¦ 915fdce â€¦-project#12560 )\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Misc] fix typo: add missing space in lora adapter error message ( vllâ€¦ â€¦ d689505 â€¦m-project#12564 )\n\nSigned-off-by: Beim <beim2015@outlook.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Kernel] Triton Configs for Fp8 Block Quantization ( vllm-project#11589 ) â€¦ 689bd19 Signed-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [CPU][PPC] Updated torch, torchvision, torchaudio dependencies ( vllm-â€¦ â€¦ f7a4e12 â€¦project#12555 )\n\nSigned-off-by: npanpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [V1][Log] Add max request concurrency log to V1 ( vllm-project#12569 ) â€¦ 95b49be Signed-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Kernel] Update cutlass_scaled_mm to support 2d group (blockwise) sâ€¦ â€¦ b0d7288 â€¦caling ( vllm-project#11868 )\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [ROCm][AMD][Model] llama 3.2 support upstreaming ( vllm-project#12421 ) â€¦ 9813962 Signed-off-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Attention] MLA decode optimizations ( vllm-project#12528 ) â€¦ 897c8c2 Signed-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Bugfix] Gracefully handle huggingface hub http error ( vllm-project#1â€¦ â€¦ c4795ce â€¦2571 )\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> Format â€¦ a5e6700 Signed-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> Add favicon to docs ( vllm-project#12611 ) â€¦ 1ce860b Signed-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [BugFix] Fix Torch.Compile For DeepSeek ( vllm-project#12594 ) â€¦ bc9d831 Co-authored-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Git] Automatically sign-off commits ( vllm-project#12595 ) â€¦ 22b918d It's very annoying when I forgot to add `-s` in `git commit` to\nsign-off, because I then need to `git rebase HEAD~1 --signoff` and `git\npush -f` to fix the DCO. This PR adds a hook to sign off commits\nautomatically when `-s` is missing to solve this problem. The only\nchange from the user side is now users have to install 2 hooks, so\ninstead of just\n\n```\npre-commit install\n```\n\nNow we need to\n\n```\npre-commit install --hook-type pre-commit --hook-type commit-msg\n```\n\nNote that even if users still only install the pre-commit hook, they\nwon't get any error in `git commit`. Just the sign-off hook won't run.\n\ncc @hmellor @youkaichao ---------\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Docs][V1] Prefix caching design ( vllm-project#12598 ) â€¦ 00df0e4 - Create v1 design document section in docs.\n- Add prefix caching design doc. @WoosukKwon @ywang96 ---------\n\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [v1][Bugfix] Add extra_keys to block_hash for prefix caching ( vllm-prâ€¦ â€¦ 44fa70d â€¦oject#12603 )\n\nThis pr adds extra key to block hash, to generate different hash value\nfor two blocks with the same token string but different extra_keys in\ntheir parent blocks. For example, it can generate different hash value\nfor the second block of the following two requests:\n```python\nrequest1 = make_request(\n        request_id=0,\n        prompt_token_ids=[_ for _ in range(6)],\n        mm_positions=[{\n            \"offset\": 0,\n            \"length\": 3\n        }, {\n            \"offset\": 3,\n            \"length\": 3\n        }],\n        mm_hashes=[\"hash1\", \"hash2\"],\n    )\n    request2 = make_request(\n        request_id=1,\n        prompt_token_ids=[_ for _ in range(6)],\n        mm_positions=[{\n            \"offset\": 0,\n            \"length\": 3\n        }, {\n            \"offset\": 3,\n            \"length\": 3\n        }],\n        mm_hashes=[\"hash3\", \"hash2\"],\n    )\n```\n\n---------\n\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [release] Add input step to ask for Release version ( vllm-project#12631 ) â€¦ fdd86fb Instead of having to create a new build with release version put in as\nenv var.\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Bugfix] Revert MoE Triton Config Default ( vllm-project#12629 ) â€¦ c4a7c26 SUMMARY:\n* previous PR for pulling in block configs also changed defaults\n( https://github.com/vllm-project/vllm/pull/11589/files ) for FP8\n* this broke L4 MoE since there was not enough SHM for the default\nconfiguration\n* this reverts the non-block example to the default\n\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Kernel][Quantization] Integrate block-quantized CUTLASS kernels for â€¦ â€¦ e7c98c6 â€¦DeepSeekV3 ( vllm-project#12587 )\n\nIntegrates the block-quantized kernels introduced in vllm-project#11868 for use in linear\nlayers.\n\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Feature] Fix guided decoding blocking bitmask memcpy ( vllm-project#1â€¦ â€¦ d27e55d â€¦2563 )\n\n**[Guided decoding performance optimization]** Sending the guided\ndecoding bitmask in xgrammar to the GPU\n(`self.token_bitmask.to(scores.device)`) is a blocking operation that\nprevents the CPU from pre-launching the sampler kernels. The CPU waits\nuntil decode is complete, then copies the bitmask over. This PR changes\nthe operation to async via setting `non-blocking=True`.\n\n(Current) The CPU is blocked on a `cudaStreamSynchronize` and only\npre-empts the sampling kernels after bitmask application. Below is the\nNsys profile for one decode phase from Llama 3.1 8B.\n\n![image]( https://github.com/user-attachments/assets/8997eae1-b822-4f52-beb8-ef19a7c6b824 )\n\nWith the optimization, this is no longer the case:\n\n![image]( https://github.com/user-attachments/assets/6d5ea83f-f169-4f98-a8c1-41c719b3e1e7 )\n\n---------\n\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Doc] Improve installation signposting ( vllm-project#12575 ) â€¦ bece70b - Make device tab names more explicit\n- Add comprehensive list of devices to https://docs.vllm.ai/en/latest/getting_started/installation/index.html - Add `attention` blocks to the intro of all devices that don't have\npre-built wheels/images\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [Doc] int4 w4a16 example ( vllm-project#12585 ) â€¦ 6b7e433 Based on a request by @mgoin , with @kylesayrs we have added an example\ndoc for int4 w4a16 quantization, following the pre-existing int8 w8a8\nquantization example and the example available in\n[`llm-compressor`]( https://github.com/vllm-project/llm-compressor/blob/main/examples/quantization_w4a16/llama3_example.py )\n\nFIX #n/a (no issue created) @kylesayrs and I have discussed a couple additional improvements for the\nquantization docs. We will revisit at a later date, possibly including:\n- A section for \"choosing the correct quantization scheme/ compression\ntechnique\"\n- Additional vision or audio calibration datasets\n\n---------\n\nSigned-off-by: Brian Dellabetta <bdellabe@redhat.com>\nCo-authored-by: Michael Goin <michael@neuralmagic.com>\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> [V1] Bugfix: Validate Model Input Length ( vllm-project#12600 ) â€¦ fd9060b SUMMARY:\n* avoid crashing the engine when we get an input longer than\nmax_model_len FIX vllm-project#12567 (*link existing issues this PR will resolve*)\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai> 18 hidden items Load moreâ€¦ srikanthsrnvs requested review from LiuXiaoxuanPKU , KuntaiDu , DarkLight1337 , ywang96 and zhuohan123 as code owners February 3, 2025 03:15 mergify bot added documentation Improvements or additions to documentation ci/build frontend structured-output speculative-decoding labels Feb 3, 2025 Copy link mergify bot commented Feb 3, 2025 This pull request has merge conflicts that must be resolved before it can be merged. Please rebase the PR, @srikanthsrnvs . https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . mergify bot added v1 needs-rebase labels Feb 3, 2025 Merge branch 'main' into fix-moe-wna16-attention 8b5a0ea mergify bot removed\n  the needs-rebase label Feb 3, 2025 unused imports 9d09ec0 DarkLight1337 enabled auto-merge (squash) February 3, 2025 05:11 Copy link Contributor Author srikanthsrnvs commented Feb 3, 2025 Anyone know why the Docker image building fails? All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Member DarkLight1337 commented Feb 3, 2025 Not sure. It's also a problem on main so it's not related to this PR. We will force-merge if necessary. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . youkaichao disabled auto-merge February 3, 2025 05:46 Hide details View details youkaichao merged commit b998645 into vllm-project : main Feb 3, 2025 24 of 38 checks passed Uh oh! There was an error while loading. Please reload this page . sahelib25 pushed a commit\n        to krai/vllm\n      that referenced\n      this pull request Feb 3, 2025 Fix for attention layers to remain unquantized during moe_wn16 quant ( vâ€¦ â€¦ 576c903 â€¦llm-project#12570 )\n\nFix to AWQ quant loading of the new R1 model\n\nThe new optimized MoE kernels for a large number of experts `moe_wn16`\nuses AWQ quant which requires the attention layers to be in 16bit\n\nThe current merge has broken this, and the `get_quant_method` must\nreturn None for it to work correctly again\n\n---------\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Beim <beim2015@outlook.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: npanpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai>\nSigned-off-by: Brian Dellabetta <bdellabe@redhat.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Vicente Herrera <vicenteherrera@vicenteherrera.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Shawn Du <shawnd200@outlook.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Beim <805908499@qq.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Ryan Nguyen <96593302+xpbowler@users.noreply.github.com>\nCo-authored-by: Brian Dellabetta <brian-dellabetta@users.noreply.github.com>\nCo-authored-by: fade_away <1028552010@qq.com>\nCo-authored-by: weilong.yu <weilong.yu@shopee.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Eldar Kurtic <eldarkurtic314@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Vicente Herrera <vicenteherrera@vicenteherrera.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Shawn Du <shawnd200@outlook.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com> shreyankg pushed a commit\n        to shreyankg/vllm\n      that referenced\n      this pull request May 3, 2025 Fix for attention layers to remain unquantized during moe_wn16 quant ( vâ€¦ â€¦ e145287 â€¦llm-project#12570 )\n\nFix to AWQ quant loading of the new R1 model\n\nThe new optimized MoE kernels for a large number of experts `moe_wn16`\nuses AWQ quant which requires the attention layers to be in 16bit\n\nThe current merge has broken this, and the `get_quant_method` must\nreturn None for it to work correctly again\n\n---------\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Beim <beim2015@outlook.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: npanpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai>\nSigned-off-by: Brian Dellabetta <bdellabe@redhat.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Vicente Herrera <vicenteherrera@vicenteherrera.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Shawn Du <shawnd200@outlook.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Beim <805908499@qq.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Ryan Nguyen <96593302+xpbowler@users.noreply.github.com>\nCo-authored-by: Brian Dellabetta <brian-dellabetta@users.noreply.github.com>\nCo-authored-by: fade_away <1028552010@qq.com>\nCo-authored-by: weilong.yu <weilong.yu@shopee.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Eldar Kurtic <eldarkurtic314@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Vicente Herrera <vicenteherrera@vicenteherrera.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Shawn Du <shawnd200@outlook.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment", "timeline_extracted_at": "2025-09-07 17:52:46", "has_lm_eval": false, "has_performance": true, "has_serving": true, "has_general_test": true, "test_details": "PERF: optimization, optimization, profile | SERVING: frontend | TEST: test, CI, CI", "analysis_extracted_at": "2025-09-07 17:52:46", "models": ["deepseek-ai/DeepSeek-R1"], "lm_eval_commands": ["lm_eval --model vllm --model_args pretrained=deepseek-ai/DeepSeek-R1 --tasks gsm8k --batch_size 1"], "perf_command": "python benchmarks/benchmark_serving.py --model deepseek-ai/DeepSeek-R1 --dataset-name sharegpt --num-prompts 100", "commit_subject": "Fix for attention layers to remain unquantized during moe_wn16 quant (#12570)", "commit_message": "Fix for attention layers to remain unquantized during moe_wn16 quant (#12570)\n\nFix to AWQ quant loading of the new R1 model\n\nThe new optimized MoE kernels for a large number of experts `moe_wn16`\nuses AWQ quant which requires the attention layers to be in 16bit\n\nThe current merge has broken this, and the `get_quant_method` must\nreturn None for it to work correctly again\n\n---------\n\nSigned-off-by: Srikanth Srinivas <srikanth@astrum.ai>\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nSigned-off-by: Beim <beim2015@outlook.com>\nSigned-off-by: rshaw@neuralmagic.com <rshaw@neuralmagic.com>\nSigned-off-by: mgoin <michael@neuralmagic.com>\nSigned-off-by: npanpaliya <nishidha.panpaliya@partner.ibm.com>\nSigned-off-by: Aleksandr Malyshev <maleksan@amd.com>\nSigned-off-by: Lucas Wilkinson <lwilkinson@neuralmagic.com>\nSigned-off-by: simon-mo <xmo@berkeley.edu>\nSigned-off-by: Cody Yu <hao.yu.cody@gmail.com>\nSigned-off-by: Chen Zhang <zhangch99@outlook.com>\nSigned-off-by: Tyler Michael Smith <tyler@neuralmagic.com>\nSigned-off-by: Ryan N <ryan.nguyen@centml.ai>\nSigned-off-by: Brian Dellabetta <bdellabe@redhat.com>\nSigned-off-by: Jee Jee Li <pandaleefree@gmail.com>\nSigned-off-by: Rahul Tuli <rahul@neuralmagic.com>\nSigned-off-by: Russell Bryant <rbryant@redhat.com>\nSigned-off-by: simon-mo <simon.mo@hey.com>\nSigned-off-by: Vicente Herrera <vicenteherrera@vicenteherrera.com>\nSigned-off-by: Jinzhen Lin <linjinzhen@hotmail.com>\nSigned-off-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nSigned-off-by: Shawn Du <shawnd200@outlook.com>\nSigned-off-by: Kunshang Ji <kunshang.ji@intel.com>\nSigned-off-by: youkaichao <youkaichao@gmail.com>\nCo-authored-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\nCo-authored-by: Beim <805908499@qq.com>\nCo-authored-by: Robert Shaw <114415538+robertgshaw2-redhat@users.noreply.github.com>\nCo-authored-by: mgoin <michael@neuralmagic.com>\nCo-authored-by: simon-mo <xmo@berkeley.edu>\nCo-authored-by: Nishidha <nishidha.panpaliya@partner.ibm.com>\nCo-authored-by: Lucas Wilkinson <LucasWilkinson@users.noreply.github.com>\nCo-authored-by: Aleksandr Malyshev <164964928+maleksan85@users.noreply.github.com>\nCo-authored-by: Aleksandr Malyshev <maleksan@amd.com>\nCo-authored-by: Woosuk Kwon <woosuk.kwon@berkeley.edu>\nCo-authored-by: simon-mo <simon.mo@hey.com>\nCo-authored-by: Michael Goin <mgoin64@gmail.com>\nCo-authored-by: Zhuohan Li <zhuohan123@gmail.com>\nCo-authored-by: Tyler Michael Smith <tysmith@redhat.com>\nCo-authored-by: Alexander Matveev <59768536+alexm-neuralmagic@users.noreply.github.com>\nCo-authored-by: Roger Wang <136131678+ywang96@users.noreply.github.com>\nCo-authored-by: Cody Yu <hao.yu.cody@gmail.com>\nCo-authored-by: Chen Zhang <zhangch99@outlook.com>\nCo-authored-by: Kevin H. Luu <kevin@anyscale.com>\nCo-authored-by: Tyler Michael Smith <tyler@neuralmagic.com>\nCo-authored-by: Ryan Nguyen <96593302+xpbowler@users.noreply.github.com>\nCo-authored-by: Brian Dellabetta <brian-dellabetta@users.noreply.github.com>\nCo-authored-by: fade_away <1028552010@qq.com>\nCo-authored-by: weilong.yu <weilong.yu@shopee.com>\nCo-authored-by: Jee Jee Li <pandaleefree@gmail.com>\nCo-authored-by: Eldar Kurtic <eldarkurtic314@gmail.com>\nCo-authored-by: Rahul Tuli <rahul@neuralmagic.com>\nCo-authored-by: Russell Bryant <rbryant@redhat.com>\nCo-authored-by: Vicente Herrera <vicenteherrera@vicenteherrera.com>\nCo-authored-by: Jinzhen Lin <linjinzhen@hotmail.com>\nCo-authored-by: Shawn Du <shawnd200@outlook.com>\nCo-authored-by: Kunshang Ji <kunshang.ji@intel.com>\nCo-authored-by: youkaichao <youkaichao@gmail.com>", "commit_date": "2025-02-03T13:46:19+08:00", "files_changed": ["vllm/model_executor/layers/quantization/moe_wna16.py"], "functions_changed": [], "stats": {"num_test_files": 0, "num_non_test_files": 1, "only_test_files": 0, "only_non_test_files": 1, "num_files": 1, "num_hunks": 3, "num_edited_lines": 10, "num_non_test_edited_lines": 10, "commit_year": 2025}, "diff_text": "diff --git a/vllm/model_executor/layers/quantization/moe_wna16.py b/vllm/model_executor/layers/quantization/moe_wna16.py\nindex 1ae765a22..56fa597e2 100644\n--- a/vllm/model_executor/layers/quantization/moe_wna16.py\n+++ b/vllm/model_executor/layers/quantization/moe_wna16.py\n@@ -7,7 +7,8 @@ import torch\n from vllm.distributed import get_tensor_model_parallel_rank, get_tp_group\n from vllm.model_executor.layers.fused_moe.layer import (\n     FusedMoE, FusedMoEMethodBase, FusedMoeWeightScaleSupported)\n-from vllm.model_executor.layers.linear import UnquantizedLinearMethod\n+from vllm.model_executor.layers.linear import (LinearBase,\n+                                               UnquantizedLinearMethod)\n from vllm.model_executor.layers.quantization.awq import AWQConfig\n from vllm.model_executor.layers.quantization.awq_marlin import AWQMarlinConfig\n from vllm.model_executor.layers.quantization.base_config import (\n@@ -125,9 +126,7 @@ class MoeWNA16Config(QuantizationConfig):\n                          prefix: str) -> Optional[\"QuantizeMethodBase\"]:\n         if is_layer_skipped_quant(prefix, self.modules_to_not_convert):\n             return UnquantizedLinearMethod()\n-        elif isinstance(layer, FusedMoE):\n-            return MoeWNA16Method(self)\n-        else:\n+        elif isinstance(layer, LinearBase):\n             if self.linear_quant_method == \"gptq\":\n                 if self.use_marlin:\n                     return GPTQMarlinConfig.from_config(\n@@ -144,6 +143,9 @@ class MoeWNA16Config(QuantizationConfig):\n                         self.full_config).get_quant_method(layer, prefix)\n             else:\n                 raise ValueError(\"moe_wna16 only support gptq and awq.\")\n+        elif isinstance(layer, FusedMoE):\n+            return MoeWNA16Method(self)\n+        return None\n \n \n def is_layer_skipped_quant(prefix: str, modules_to_not_convert: List[str]):", "apis": ["vllm.model_executor.layers.quantization.moe_wna16.MoeWNA16Config.get_quant_method"], "affected_paths": ["/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/quantization/moe_wna16.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/linear.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/attention/layer.py", "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm/vllm/model_executor/layers/fused_moe/layer.py"], "repo_path": "/Users/fortuna/buckets/gso_bucket/analysis/repos/vllm", "llm_reason": "The patch modifies a source code file (not a test or documentation file) in a non-trivial way by changing the logic in the quantization configuration. Although the commit message describes a â€œFix for attention layersâ€ it explains that this change is needed so that the new optimized MoE kernels can function correctly. This indicates that the fix is directly tied to performance optimizationâ€”ensuring that attention layers are not inadvertently quantized and thus can run in highly optimized 16-bit mode for large expert models. The change helps to restore the intended performance behavior by aligning the quantization logic with the performance requirements of the optimized kernels. Therefore, it qualifies as a performance/optimization-related commit.", "llm_api_reason": "The commit reorders the type checks in the get_quant_method function of the MoeWNA16 quantization configuration. Its behavior now first handles layers derived from LinearBase (applying GPTQ/AWQ quantization as appropriate), then â€“ if the layer is a FusedMoE â€“ returns the MoeWNA16Method, and finally returns None for other layer types (thereby leaving attention layers unquantized). This change fixes the AWQ quant loading for the new R1 model by ensuring that unsupported layers (such as attention) remain in 16â€bit mode rather than being quantized."}
