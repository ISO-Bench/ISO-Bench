{
  "commit_hash": "31589e177e2df6014607293fb4603cfd63297b67",
  "pr_url": "https://github.com/sgl-project/sglang/pull/6668",
  "pr_date": "2025-05-28",
  "timeline_text": "Copy link Collaborator fzyzcjy commented May 27, 2025 \u2022 edited Loading Uh oh! There was an error while loading. Please reload this page . Motivation extend #6175 to TBO need to wait a bit, I will test it num_gpu=16\nmaster_ip=${ARG_MASTER_IP}\nPYTHONUNBUFFERED=1 SGLANG_TORCH_PROFILER_DIR=/host_home/temp_sglang_server2local python3 -m sglang.launch_server --model-path /dev/shm/DeepSeek-V3-0324 --trust-remote-code --dist-init-addr ${master_ip}:5757 --nnodes 2 --node-rank ${MY_NODE_RANK} --tp-size ${num_gpu} --dp-size ${num_gpu} --enable-dp-attention --chunked-prefill-size $((${num_gpu}*128)) --max-running-requests $((${num_gpu}*2048)) --context-length 4096 --disable-radix-cache --enable-deepep-moe --deepep-mode low_latency --cuda-graph-bs 128 --enable-two-batch-overlap --moe-dense-tp-size 1 --enable-dp-lm-head --decode-log-interval 1\n\npython3 -m sglang.bench_serving --backend sglang --host localhost --port 30000 --model /dev/shm/DeepSeek-V3-0324 --dataset-name random --random-range-ratio 1 --warmup-requests 0 --num-prompt 3 --random-input-len 1000 --random-output-len 1000 --max-concurrency 1 gsm8k: 93.3 before pr speed: 5.5 after pr speed: 28.5 Modifications Checklist Format your code according to the Code Formatting with Pre-Commit . Add unit tests as outlined in the Running Unit Tests . Update documentation / docstrings / example tutorials as needed, according to Writing Documentation . Provide throughput / latency benchmark results and accuracy evaluation results as needed, according to Benchmark and Profiling and Accuracy Results . For reviewers: If you haven't made any contributions to this PR and are only assisting with merging the main branch, please remove yourself as a co-author when merging the PR. Please feel free to join our Slack channel at https://slack.sglang.ai to discuss your PR. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions fzyzcjy added 30 commits May 27, 2025 19:17 more 4e8f93d more 86e1736 more 0dc0b6f more 180909e more 0e5e6ef more 7dc2c38 more 171e76d fmt d0ae6ea more ec9c1b1 more b1c34f5 more 2fad15c more 0021673 more 91e64b2 more 086fced more 20f5fe8 more 81f8658 more 3f21146 more c336dbe more a884462 more 3433cf4 more 7b9fdfd more b96e538 more d3ccef8 more 3bbfce8 more f09e892 more a922bf9 more 31767ba more 8225f4b more 0bee404 more 492062b 23 hidden items Load more\u2026 fzyzcjy added 10 commits May 27, 2025 20:38 more 6268da7 more acbed64 more 7e85afe more 9964c08 Revert \"more\" \u2026 c138e14 This reverts commit 9964c08 . more 933aee6 more cfbd755 more 3a0f1c6 more 8fa970b fmt 0f90f35 fzyzcjy requested review from HaiShaw , ch-wan and BBuf as code owners May 27, 2025 12:43 fzyzcjy and others added 8 commits May 27, 2025 20:45 more 9a17949 ci 919e863 Merge branch 'main' into feat/tbo_padding f6664d3 Merge branch 'main' into feat/tbo_padding f4df233 Merge branch 'main' into feat/tbo_padding 64ceb3a more \u2026 789a621 (cherry picked from commit b78a269 ) Merge branch 'feat/tbo_padding' of https://github.com/fzyzcjy/sglang \u2026 \u2026 2a9c8ad \u2026into feat/tbo_padding Merge branch 'main' into feat/tbo_padding 607a6e7 ch-wan approved these changes May 28, 2025 View reviewed changes ch-wan approved these changes May 28, 2025 View reviewed changes Copy link Collaborator ch-wan left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment LGTM Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Merge branch 'main' into feat/tbo_padding 846e532 Hide details View details zhyncs merged commit 31589e1 into sgl-project : main May 28, 2025 1 of 41 checks passed Uh oh! There was an error while loading. Please reload this page . ChangyiYang pushed a commit\n        to ChangyiYang/sglang-changyi\n      that referenced\n      this pull request May 29, 2025 Speed up when having padding tokens two-batch overlap ( sgl-project#6668 ) \u2026 93ef744 Co-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com> Layssy pushed a commit\n        to Layssy/sglang-iaas\n      that referenced\n      this pull request Jun 9, 2025 Speed up when having padding tokens two-batch overlap ( sgl-project#6668 ) \u2026 7b6ba63 Co-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com> xwu-intel pushed a commit\n        to xwu-intel/sglang\n      that referenced\n      this pull request Jun 17, 2025 Speed up when having padding tokens two-batch overlap ( sgl-project#6668 ) \u2026 fc4c35a Co-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com> walker-ai pushed a commit\n        to walker-ai/sglang\n      that referenced\n      this pull request Jul 8, 2025 PullRequest: 52 sgl_20250610_sync_tag047 \u2026 a19e2e2 Merge branch 'sgl_20250610_sync_tag047 of git@code.alipay.com:Theta/SGLang.git into main https://code.alipay.com/Theta/SGLang/pull_requests/52 Reviewed-by: \u5251\u5ddd <jianchuan.gys@antgroup.com>\n\n\n* [Bugfix] Fix slice operation when chunk size mismatch ( sgl-project#6697 )\n* [Bugfix] Fix ChatCompletion endpoint of mini_lb when stream is set ( sgl-project#6703 )\n* [CI] Fix setup of disaggregation with different tp ( sgl-project#6706 )\n* [PD] Remove Unnecessary Exception Handling for FastQueue.get() ( sgl-project#6712 )\n* Fuse routed_scaling_factor in DeepSeek ( sgl-project#6710 )\n* Overlap two kernels in DeepSeek with communication ( sgl-project#6711 )\n* Minor refactor two-batch overlap ( sgl-project#6682 )\n* Speed up when having padding tokens two-batch overlap ( sgl-project#6668 )\n* [Feature] Support Flashinfer fp8 blockwise GEMM kernel on Blackwell ( sgl-project#6479 )\n* Fix LoRA bench ( sgl-project#6719 )\n* temp\n* Fix PP for Qwen3 MoE ( sgl-project#6709 )\n* [feat] triton kernel for get_last_loc ( sgl-project#6676 )\n* [fix] more mem for draft_extend cuda_graph ( sgl-project#6726 )\n* [PD] bug fix:  Update status if nixl receiver send a a dummy req. ( sgl-project#6720 )\n* Tune memory arguments on B200 ( sgl-project#6718 )\n* Add DeepSeek-R1-0528 function call chat template ( sgl-project#6725 )\n* refactor(tool call): Fix BaseFormatDetector tool_index issue and refactor `parse_streaming_increment` ( sgl-project#6715 )\n* Add draft extend CUDA graph for Triton backend ( sgl-project#6705 )\n* refactor apply_w8a8_block_fp8_linear in fp ( sgl-project#6545 )\n* [PD] Support completion endpoint ( sgl-project#6729 )\n* PD Rust LB (PO2) ( sgl-project#6437 )\n* Super tiny enable sole usage of expert distribution metrics and update doc ( sgl-project#6680 )\n* Support picking variants\u00a0of EPLB algorithms ( sgl-project#6728 )\n* Support tuning DeepEP configs ( sgl-project#6742 )\n* [test] add ut and bm for get_last_loc ( sgl-project#6746 )\n* Fix mem_fraction_static for AMD CI ( sgl-project#6748 )\n* [fix][RL] Fix DeepSeekV3ForCausalLM.post_load_weights for multiple update weight ( sgl-project#6265 )\n* Improve EPLB logical to physical dispatch map ( sgl-project#6727 )\n* Update DeepSeek-R1-0528 function call chat template ( sgl-project#6765 )\n* [PD] Optimize time out logic and add env var doc for mooncake ( sgl-project#6761 )\n* Fix aiohttp 'Chunk too big' in bench_serving ( sgl-project#6737 )\n* Support sliding window in triton backend ( sgl-project#6509 )\n* Fix shared experts fusion error ( sgl-project#6289 )\n* Fix one bug in the grouped-gemm triton kernel ( sgl-project#6772 )\n* update llama4 chat template and pythonic parser ( sgl-project#6679 )\n* feat(tool call): Enhance Llama32Detector for improved JSON parsing in non-stream ( sgl-project#6784 )\n* Support token-level quantization for EP MoE ( sgl-project#6782 )\n* Temporarily lower mmlu threshold for triton sliding window backend ( sgl-project#6785 )\n* ci: relax test_function_call_required ( sgl-project#6786 )\n* Add intel_amx backend for Radix Attention for CPU ( sgl-project#6408 )\n* Fix incorrect LoRA weight loading for fused gate_up_proj ( sgl-project#6734 )\n* fix(PD-disaggregation): Can not get local ip ( sgl-project#6792 )\n* [FIX] mmmu bench serving result display error ( sgl-project#6525 ) ( sgl-project#6791 )\n* Bump torch to 2.7.0 ( sgl-project#6788 )\n* chore: bump sgl-kernel v0.1.5 ( sgl-project#6794 )\n* Improve profiler and integrate profiler in bench_one_batch_server ( sgl-project#6787 )\n* chore: upgrade sgl-kernel v0.1.5 ( sgl-project#6795 )\n* [Minor] Always append newline after image token when parsing chat message ( sgl-project#6797 )\n* Update CI tests for Llama4 models ( sgl-project#6421 )\n* [Feat] Enable PDL automatically on Hopper architecture ( sgl-project#5981 )\n* chore: update blackwell docker ( sgl-project#6800 )\n* misc: cache is_hopper_arch ( sgl-project#6799 )\n* Remove contiguous before Flashinfer groupwise fp8 gemm ( sgl-project#6804 )\n* Correctly abort the failed grammar requests & Improve the handling of abort ( sgl-project#6803 )\n* [EP] Add cuda kernel for moe_ep_pre_reorder ( sgl-project#6699 )\n* Add draft extend CUDA graph for flashinfer backend  ( sgl-project#6805 )\n* Refactor CustomOp to avoid confusing bugs ( sgl-project#5382 )\n* Tiny log prefill time ( sgl-project#6780 )\n* Tiny fix EPLB assertion about rebalancing period and recorder window size ( sgl-project#6813 )\n* Add simple utility to dump tensors for debugging ( sgl-project#6815 )\n* Fix profiles do not have consistent names ( sgl-project#6811 )\n* Speed up rebalancing when using non-static dispatch algorithms ( sgl-project#6812 )\n* [1/2] Add Kernel support for Cutlass based Fused FP4 MoE ( sgl-project#6093 )\n* [Router] Fix k8s Service Discovery ( sgl-project#6766 )\n* Add CPU optimized kernels for topk and rope fusions  ( sgl-project#6456 )\n* fix new_page_count_next_decode ( sgl-project#6671 )\n* Fix wrong weight reference in dynamic EPLB ( sgl-project#6818 )\n* Minor add metrics to expert location updater ( sgl-project#6816 )\n* [Refactor] Rename `n_share_experts_fusion` as `num_fused_shared_experts` ( sgl-project#6735 )\n* [FEAT] Add transformers backend support  ( sgl-project#5929 )\n* [fix] recover auto-dispatch for rmsnorm and rope ( sgl-project#6745 )\n* fix ep_moe_reorder kernel bugs ( sgl-project#6858 )\n* [Refactor] Multimodal data processing for VLM ( sgl-project#6659 )\n* Decoder-only Scoring API ( sgl-project#6460 )\n* feat: add dp-rank to KV events ( sgl-project#6852 )\n* Set `num_fused_shared_experts` as `num_shared_experts` when shared_experts fusion is not disabled ( sgl-project#6736 )\n* Fix one missing arg in DeepEP ( sgl-project#6878 )\n* Support LoRA in TestOpenAIVisionServer and fix fused kv_proj loading bug. ( sgl-project#6861 )\n* support 1 shot allreduce  in 1-node and 2-node using mscclpp ( sgl-project#6277 )\n* Fix Qwen3MoE missing token padding optimization ( sgl-project#6820 )\n* Tiny update error hints ( sgl-project#6846 )\n* Support layerwise rebalancing experts ( sgl-project#6851 )\n* Tiny allow profiler API to auto create directory ( sgl-project#6865 )\n* Support Blackwell DeepEP docker images ( sgl-project#6868 )\n* [EP] Add cuda kernel for moe_ep_post_reorder ( sgl-project#6837 )\n* [theta]merge 0605\n* oai: fix openAI client error with single request via batch api ( sgl-project#6170 )\n* [PD] Fix potential perf spike caused by tracker gc and optimize doc ( sgl-project#6764 )\n* Use deepgemm instead of triton for fused_qkv_a_proj_with_mqa ( sgl-project#6890 )\n* [CUTLASS-FP4-MOE]  Introduce CutlassMoEParams class for easy initialization of Cutlass Grouped Gems Metadata ( sgl-project#6887 )\n* bugfix(OAI): Fix image_data processing for jinja chat templates ( sgl-project#6877 )\n* [CPU] enable CI for PRs, add Dockerfile and auto build task ( sgl-project#6458 )\n* AITER backend extension and workload optimizations ( sgl-project#6838 )\n* [theta]merge\n* [theta]merge\n* [Feature] Support Flashinfer fmha on Blackwell ( sgl-project#6930 )\n* Fix a bug in abort & Improve docstrings for abort ( sgl-project#6931 )\n* Tiny support customize DeepEP max dispatch tokens per rank ( sgl-project#6934 )\n* Sync the changes on cuda graph runners ( sgl-project#6932 )\n* [PD] Optimize transfer queue forward logic for dummy rank ( sgl-project#6922 )\n* [Refactor] image data process in bench_serving ( sgl-project#6879 )\n* [fix] logical_to_all_physical_map index 256 is out of bounds in EP parallel. ( sgl-project#6767 )\n* Add triton fused moe kernel config for E=257 on B200 ( sgl-project#6939 )\n* [sgl-kernel] update deepgemm ( sgl-project#6942 )\n* chore: bump sgl-kernel v0.1.6 ( sgl-project#6943 )\n* Minor compile fused topk ( sgl-project#6944 )\n* [Bugfix] pipeline parallelism and Eagle Qwen2 ( sgl-project#6910 )\n* Tiny re-introduce profile id logging ( sgl-project#6912 )\n* Add triton version as a fused_moe_triton config search key to avoid performace decrease in different Triton version ( sgl-project#5955 )\n* reduce torch.zeros overhead in moe align block size kernel ( sgl-project#6369 )\n* chore: upgrade sgl-kernel v0.1.6 ( sgl-project#6945 )\n* add fbgemm moe grouped gemm kernel benchmark ( sgl-project#6924 )\n* [Docker] Add docker file for SGL Router ( sgl-project#6915 )\n* Disabling mixed chunked prefill when eagle is enabled ( sgl-project#6874 )\n* Add canary for EPLB rebalancing ( sgl-project#6895 )\n* Refactor global_server_args_dict ( sgl-project#6866 )\n* Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\n* Update server timeout time in AMD CI. ( sgl-project#6953 )\n* [misc] add is_cpu() ( sgl-project#6950 )\n* Add H20 fused MoE kernel tuning configs for DeepSeek-R1/V3 ( sgl-project#6885 )\n* Add a CUDA kernel for fusing mapping and weighted sum for MoE. ( sgl-project#6916 )\n* chore: bump sgl-kernel v0.1.6.post1 ( sgl-project#6955 )\n* chore: upgrade sgl-kernel v0.1.6.post1 ( sgl-project#6957 )\n* [DeepseekR1-FP4] Add Support for nvidia/DeepSeekR1-FP4 model ( sgl-project#6853 )\n* Revert \"Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\" ( sgl-project#6968 )\n* [AMD] Add more tests to per-commit-amd ( sgl-project#6926 )\n* chore: bump sgl-kernel v0.1.7 ( sgl-project#6963 )\n* Slightly improve the sampler to skip unnecessary steps ( sgl-project#6956 )\n* rebase h20 fused_moe config ( sgl-project#6966 )\n* Fix CI and triton moe Configs ( sgl-project#6974 )\n* Remove unnecessary kernels of num_token_non_padded ( sgl-project#6965 )\n* Extend cuda graph capture bs for B200 ( sgl-project#6937 )\n* Fuse routed scaling factor in deepseek ( sgl-project#6970 )\n* Sync cuda graph runners ( sgl-project#6976 )\n* Fix draft extend ut stability with flush cache ( sgl-project#6979 )\n* Fix triton sliding window test case ( sgl-project#6981 )\n* Fix expert distribution dumping causes OOM ( sgl-project#6967 )\n* Minor remove one kernel for DeepSeek ( sgl-project#6977 )\n* [perf][sgl-kernel] extend cutlass_mla_decode to support num_head < 128 ( sgl-project#6929 )\n* Enable more unit tests for AMD CI. ( sgl-project#6983 )\n* Use torch.compile to fuse flash attention decode metadata preparation ( sgl-project#6973 )\n* Eliminate stream sync to speed up LoRA batch init  ( sgl-project#6960 )\n* support qwen3 emebedding ( sgl-project#6990 )\n* Fix torch profiler bugs for bench_offline_throughput.py ( sgl-project#6557 )\n* chore: upgrade flashinfer v0.2.6.post1 jit ( sgl-project#6958 )\n* cleanup tmp dir ( sgl-project#7007 )\n* chore: update pr test xeon ( sgl-project#7008 )\n* Fix cutlass MLA gets almost zero accuracy ( sgl-project#6998 )\n* Update amd nightly models CI. ( sgl-project#6992 )\n* feat: add direct routing strategy to DP worker ( sgl-project#6884 )\n* Fallback to lower triton version for unfound fused moe configs ( sgl-project#7013 )\n* Fix torchvision version for Blackwell ( sgl-project#7015 )\n* Simplify prepare_extend_after_decode ( sgl-project#6987 )\n* Migrate to assertEqual ( sgl-project#6741 )\n* Fix torch version in blackwell dockerfile ( sgl-project#7017 )\n* chore: update pr test xeon ( sgl-project#7018 )\n* Update default settings for blackwell ( sgl-project#7023 )\n* Support both approximate and exact expert distribution collection ( sgl-project#6964 )\n* Add decode req pool ( sgl-project#6980 )\n* [theta]merge 0610\n* [theta]merge 0610\n* [CI] Add CI workflow for sgl-router docker build ( sgl-project#7027 )\n* Fix fused_moe triton configs ( sgl-project#7029 )\n* CPU: map changes from developing branch in sgl-kernel ( sgl-project#6833 )\n* chore: bump v0.4.7 ( sgl-project#7038 )\n* Update README.md ( sgl-project#7040 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 18:57:12",
  "has_lm_eval": true,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "LM_EVAL | PERF | SERVING | TEST",
  "analysis_extracted_at": null,
  "models": [
    "deepseek-ai/DeepSeek-V3"
  ],
  "lm_eval_commands": [
    "lm_eval --model sglang --model_args pretrained=/dev/shm/DeepSeek-V3-0324 --tasks gsm8k --batch_size 8"
  ],
  "perf_command": "python3 -m sglang.bench_serving --backend sglang --host localhost --port 30000 --model /dev/shm/DeepSeek-V3-0324 --dataset-name random --random-range-ratio 1 --warmup-requests 0 --num-prompt 3 --random-input-len 1000 --random-output-len 1000 --max-concurrency 1",
  "commit_subject": "Speed up when having padding tokens two-batch overlap (#6668)",
  "commit_message": "Speed up when having padding tokens two-batch overlap (#6668)\n\nCo-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com>",
  "commit_date": "2025-05-28T16:00:58-07:00",
  "files_changed": [
    "python/sglang/srt/models/deepseek_v2.py",
    "python/sglang/srt/two_batch_overlap.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2025,
    "num_edited_lines": 83,
    "num_files": 2,
    "num_hunks": 12,
    "num_non_test_edited_lines": 83,
    "num_non_test_files": 2,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/models/deepseek_v2.py b/python/sglang/srt/models/deepseek_v2.py\nindex 29f18f0ef..b4fc4d7a7 100644\n--- a/python/sglang/srt/models/deepseek_v2.py\n+++ b/python/sglang/srt/models/deepseek_v2.py\n@@ -454,6 +454,7 @@ class DeepseekV2MoE(nn.Module):\n                 num_expert_group=self.num_expert_group,\n                 correction_bias=self.correction_bias,\n                 routed_scaling_factor=self.routed_scaling_factor,\n+                num_token_non_padded=state.forward_batch.num_token_non_padded,\n                 expert_location_dispatch_info=ExpertLocationDispatchInfo.init_new(\n                     layer_id=self.layer_id,\n                 ),\ndiff --git a/python/sglang/srt/two_batch_overlap.py b/python/sglang/srt/two_batch_overlap.py\nindex 6b0241f40..b417de7ce 100644\n--- a/python/sglang/srt/two_batch_overlap.py\n+++ b/python/sglang/srt/two_batch_overlap.py\n@@ -110,7 +110,7 @@ def compute_split_indices_for_cuda_graph_replay(\n \n class TboCudaGraphRunnerPlugin:\n     def __init__(self):\n-        pass  # TODO add logic here\n+        self._tbo_children_num_token_non_padded = torch.zeros((2,), dtype=torch.int32)\n \n     def capture_one_batch_size(self, batch: ForwardBatch, num_tokens: int):\n         if not global_server_args_dict[\"enable_two_batch_overlap\"]:\n@@ -124,7 +124,14 @@ class TboCudaGraphRunnerPlugin:\n         # For simplicity, when two_batch_overlap is enabled, we only capture CUDA Graph for tbo=true\n         assert batch.tbo_split_seq_index is not None, f\"{num_tokens=}\"\n \n-        TboForwardBatchPreparer.prepare(batch)\n+        self._tbo_children_num_token_non_padded[...] = (\n+            TboForwardBatchPreparer.compute_tbo_children_num_token_non_padded(batch)\n+        )\n+\n+        TboForwardBatchPreparer.prepare_raw(\n+            batch,\n+            tbo_children_num_token_non_padded=self._tbo_children_num_token_non_padded,\n+        )\n \n     def replay_prepare(\n         self, forward_mode: ForwardMode, bs: int, num_token_non_padded: int\n@@ -132,7 +139,20 @@ class TboCudaGraphRunnerPlugin:\n         if not global_server_args_dict[\"enable_two_batch_overlap\"]:\n             return\n \n-        pass  # TODO add logic here\n+        tbo_split_seq_index, tbo_split_token_index = (\n+            compute_split_indices_for_cuda_graph_replay(\n+                forward_mode=forward_mode,\n+                # TODO support bs!=num_tokens\n+                cuda_graph_num_tokens=bs,\n+            )\n+        )\n+\n+        self._tbo_children_num_token_non_padded[...] = (\n+            TboForwardBatchPreparer.compute_tbo_children_num_token_non_padded_raw(\n+                tbo_split_token_index=tbo_split_token_index,\n+                num_token_non_padded=num_token_non_padded,\n+            )\n+        )\n \n \n class TboDPAttentionPreparer:\n@@ -207,16 +227,23 @@ class TboDPAttentionPreparer:\n class TboForwardBatchPreparer:\n     @classmethod\n     def prepare(cls, batch: ForwardBatch):\n-        from sglang.srt.layers.attention.tbo_backend import TboAttnBackend\n-\n         if batch.tbo_split_seq_index is None:\n             return\n \n-        tbo_split_token_index = compute_split_token_index(\n-            split_seq_index=batch.tbo_split_seq_index,\n-            forward_mode=batch.forward_mode,\n-            extend_seq_lens=batch.extend_seq_lens_cpu,\n+        tbo_children_num_token_non_padded = (\n+            cls.compute_tbo_children_num_token_non_padded(batch)\n         )\n+        cls.prepare_raw(\n+            batch, tbo_children_num_token_non_padded=tbo_children_num_token_non_padded\n+        )\n+\n+    @classmethod\n+    def prepare_raw(\n+        cls, batch: ForwardBatch, tbo_children_num_token_non_padded: torch.Tensor\n+    ):\n+        from sglang.srt.layers.attention.tbo_backend import TboAttnBackend\n+\n+        tbo_split_token_index = cls._compute_split_token_index(batch)\n \n         if _tbo_debug:\n             logger.info(\n@@ -229,6 +256,10 @@ class TboForwardBatchPreparer:\n         assert isinstance(batch.attn_backend, TboAttnBackend)\n         attn_backend_child_a, attn_backend_child_b = batch.attn_backend.children\n \n+        [out_num_token_non_padded_a, out_num_token_non_padded_b] = (\n+            tbo_children_num_token_non_padded\n+        )\n+\n         child_a = cls.filter_batch(\n             batch,\n             start_token_index=0,\n@@ -236,6 +267,7 @@ class TboForwardBatchPreparer:\n             start_seq_index=0,\n             end_seq_index=batch.tbo_split_seq_index,\n             output_attn_backend=attn_backend_child_a,\n+            out_num_token_non_padded=out_num_token_non_padded_a,\n         )\n         child_b = cls.filter_batch(\n             batch,\n@@ -244,6 +276,7 @@ class TboForwardBatchPreparer:\n             start_seq_index=batch.tbo_split_seq_index,\n             end_seq_index=batch.batch_size,\n             output_attn_backend=attn_backend_child_b,\n+            out_num_token_non_padded=out_num_token_non_padded_b,\n         )\n \n         assert batch.tbo_children is None\n@@ -259,9 +292,8 @@ class TboForwardBatchPreparer:\n         start_seq_index: int,\n         end_seq_index: int,\n         output_attn_backend: AttentionBackend,\n+        out_num_token_non_padded: torch.Tensor,\n     ):\n-        from sglang.srt.managers.schedule_batch import global_server_args_dict\n-\n         num_tokens = batch.input_ids.shape[0]\n         num_seqs = batch.batch_size\n \n@@ -342,6 +374,7 @@ class TboForwardBatchPreparer:\n                 ),\n                 extend_num_tokens=extend_num_tokens,\n                 attn_backend=output_attn_backend,\n+                num_token_non_padded=out_num_token_non_padded,\n                 tbo_split_seq_index=None,\n                 tbo_parent_token_range=(start_token_index, end_token_index),\n                 tbo_children=None,\n@@ -357,7 +390,6 @@ class TboForwardBatchPreparer:\n                 top_p_normalized_logprobs=False,\n                 top_p=None,\n                 mm_inputs=None,\n-                num_token_non_padded=None,\n             )\n         )\n \n@@ -372,6 +404,32 @@ class TboForwardBatchPreparer:\n \n         return ForwardBatch(**output_dict)\n \n+    @classmethod\n+    def compute_tbo_children_num_token_non_padded(cls, batch: ForwardBatch):\n+        return cls.compute_tbo_children_num_token_non_padded_raw(\n+            tbo_split_token_index=cls._compute_split_token_index(batch),\n+            num_token_non_padded=len(batch.input_ids),\n+        )\n+\n+    @classmethod\n+    def compute_tbo_children_num_token_non_padded_raw(\n+        cls, tbo_split_token_index: int, num_token_non_padded: int\n+    ):\n+        # TODO we may make padding on both sub-batches to make it slightly more balanced\n+        value_a = min(tbo_split_token_index, num_token_non_padded)\n+        value_b = max(0, num_token_non_padded - tbo_split_token_index)\n+        return torch.tensor([value_a, value_b], dtype=torch.int32).to(\n+            device=global_server_args_dict[\"device\"], non_blocking=True\n+        )\n+\n+    @classmethod\n+    def _compute_split_token_index(cls, batch: ForwardBatch):\n+        return compute_split_token_index(\n+            split_seq_index=batch.tbo_split_seq_index,\n+            forward_mode=batch.forward_mode,\n+            extend_seq_lens=batch.extend_seq_lens_cpu,\n+        )\n+\n \n def _compute_extend_num_tokens(input_ids, forward_mode: ForwardMode):\n     if forward_mode.is_extend():",
  "apis": [
    "DeepseekV2ForCausalLM",
    "TboCudaGraphRunnerPlugin",
    "TboForwardBatchPreparer"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/models/deepseek_v2.py",
    "/path/to/repos/sglang/python/sglang/srt/two_batch_overlap.py",
    "/path/to/repos/sglang/python/sglang/api.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies two non-test source files (deepseek_v2.py and two_batch_overlap.py) with non-trivial changes in several functions and method calls that affect how token counts are computed and used in the two-batch overlap logic. The commit message \"Speed up when having padding tokens two-batch overlap\" indicates that the changes are made to improve performance. The modifications adjust the architecture related to batch preparation and dispatch, which are internal APIs likely impacting overall CPU performance. These changes are not merely refactoring or documentation fixes but performance optimizations tested without reliance on GPUs.",
  "llm_api_reason": "The commit adds a new parameter \u201cnum_token_non_padded\u201d to the call in the DeepseekV2MoE module (in deepseek_v2.py) to improve efficiency when processing padded tokens. In addition, it introduces nontrivial changes in the two\u2010batch overlap workflow in two_batch_overlap.py \u2013 initializing and propagating a tensor holding the per\u2010batch token counts and updating the functions that split and merge batches for CUDA graph replay. These changes optimize runtime speed when padding tokens occur in overlapping batches."
}