{
  "commit_hash": "df7f61ee7d235936e6663f07813d7c03c4ec1603",
  "pr_url": "https://github.com/sgl-project/sglang/pull/6812",
  "pr_date": "2025-06-02",
  "timeline_text": "Copy link Collaborator fzyzcjy commented Jun 2, 2025 Motivation Modifications Checklist Format your code according to the Code Formatting with Pre-Commit . Add unit tests as outlined in the Running Unit Tests . Update documentation / docstrings / example tutorials as needed, according to Writing Documentation . Provide throughput / latency benchmark results and accuracy evaluation results as needed, according to Benchmark and Profiling and Accuracy Results . For reviewers: If you haven't made any contributions to this PR and are only assisting with merging the main branch, please remove yourself as a co-author when merging the PR. Please feel free to join our Slack channel at https://slack.sglang.ai to discuss your PR. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions cherry pick 7f37d63 fzyzcjy requested review from merrymercy , Ying1123 , hnyls2002 and xiezhq-hermann as code owners June 2, 2025 13:15 gemini-code-assist bot reviewed Jun 2, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Hello @fzyzcjy , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! Summary of Changes Hello! Gemini or gemini-code-assist here, providing a summary of this pull request. This PR aims to improve performance, specifically the rebalancing process, when using non-static expert dispatch algorithms. It achieves this by making the logical_to_rank_dispatch_physical_map optional and only computing and storing it when the 'static' dispatch algorithm is configured. This avoids unnecessary computation and memory usage for algorithms like 'random' dispatch where this map is not needed. Highlights Performance Optimization : The core goal is to speed up rebalancing by avoiding unnecessary work when using non-static dispatch algorithms. Conditional Data Storage : The logical_to_rank_dispatch_physical_map is now conditionally computed and stored only if the dispatch algorithm is 'static'. For other algorithms, it is set to None . Optional Fields : Related fields ( logical_to_rank_dispatch_physical_map and partial_logical_to_rank_dispatch_physical_map ) have been updated to be Optional[torch.Tensor] to reflect that they may not always be present. Refactored Initialization and Update : The initialization ( _init_raw , init_by_mapping , init_by_eplb , init_new ) and update logic have been adjusted to correctly handle the new optional nature of these fields. Changelog python/sglang/srt/managers/expert_location.py Made logical_to_rank_dispatch_physical_map an optional torch.Tensor . Removed assertions related to the shape of logical_to_rank_dispatch_physical_map in __post_init__ . Added server_args parameter to _init_raw , init_by_mapping , and init_by_eplb methods. Modified _init_raw to compute logical_to_rank_dispatch_physical_map only if server_args.ep_dispatch_algorithm is 'static', otherwise sets it to None . Updated the update method to handle the optional logical_to_rank_dispatch_physical_map , ensuring both source and destination are either None or not None before attempting to copy. python/sglang/srt/managers/expert_location_dispatch.py Made partial_logical_to_rank_dispatch_physical_map an optional torch.Tensor . Updated the init_new method to conditionally assign the value to partial_logical_to_rank_dispatch_physical_map based on whether the source logical_to_rank_dispatch_physical_map is None . Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with \ud83d\udc4d and \ud83d\udc4e on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Data can be optional, Like a tensor conditional. If not static, it's gone, Performance moves on, Making code less emotional. Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . \u21a9 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jun 2, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request aims to speed up rebalancing when non-static dispatch algorithms are used by making the logical_to_rank_dispatch_physical_map optional and only computing it when the dispatch algorithm is 'static'. The changes are well-targeted and logically implement this optimization. The introduction of Optional for logical_to_rank_dispatch_physical_map is handled consistently across ExpertLocationMetadata and ExpertLocationDispatchInfo , including updates to initialization, assertions, and the update method. Overall, the code quality is good, and the changes are clear. I have one point for clarification regarding an assertion in the update method. It would also be beneficial to fill out the PR description (Motivation, Modifications) and the checklist to provide more context for reviewers and for future reference. Summary of Findings PR Description and Checklist : The pull request description (Motivation, Modifications) and the checklist are currently empty. Filling these out would provide valuable context for reviewers and for future documentation. Merge Readiness The changes in this PR appear to be well-implemented for the stated goal of speeding up rebalancing with non-static dispatch algorithms. There is one medium-severity point for clarification regarding an assertion in the update method. Once that is clarified, and assuming the author addresses the checklist and PR description, the PR should be in good shape. As an AI reviewer, I am not authorized to approve pull requests; please ensure further review and approval from team members before merging. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions python/sglang/srt/managers/expert_location.py dst = getattr(self, field) dst[...] = getattr(other, field) assert (src is not None) == (dst is not None) Copy link Contributor gemini-code-assist bot Jun 2, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment The assertion (src is not None) == (dst is not None) ensures that self and other have the same optional status for the field being updated (e.g., logical_to_rank_dispatch_physical_map ). This implies they were likely configured with the same ep_dispatch_algorithm . Could you clarify if it's an expected invariant that the update method is only called between ExpertLocationMetadata instances that have a consistent configuration regarding the presence of this map? If there are scenarios where self and other might have different configurations (e.g., one static, one dynamic), this assertion would prevent the update. Understanding the intended state transitions here would be helpful. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions zhyncs approved these changes Jun 2, 2025 View reviewed changes Hide details View details zhyncs merged commit df7f61e into sgl-project : main Jun 2, 2025 38 of 41 checks passed Uh oh! There was an error while loading. Please reload this page . Layssy pushed a commit\n        to Layssy/sglang-iaas\n      that referenced\n      this pull request Jun 9, 2025 Speed up rebalancing when using non-static dispatch algorithms ( sgl-p\u2026 \u2026 ad85424 \u2026roject#6812 ) xwu-intel pushed a commit\n        to xwu-intel/sglang\n      that referenced\n      this pull request Jun 17, 2025 Speed up rebalancing when using non-static dispatch algorithms ( sgl-p\u2026 \u2026 5f115c5 \u2026roject#6812 ) walker-ai pushed a commit\n        to walker-ai/sglang\n      that referenced\n      this pull request Jul 8, 2025 PullRequest: 52 sgl_20250610_sync_tag047 \u2026 a19e2e2 Merge branch 'sgl_20250610_sync_tag047 of git@code.alipay.com:Theta/SGLang.git into main https://code.alipay.com/Theta/SGLang/pull_requests/52 Reviewed-by: \u5251\u5ddd <jianchuan.gys@antgroup.com>\n\n\n* [Bugfix] Fix slice operation when chunk size mismatch ( sgl-project#6697 )\n* [Bugfix] Fix ChatCompletion endpoint of mini_lb when stream is set ( sgl-project#6703 )\n* [CI] Fix setup of disaggregation with different tp ( sgl-project#6706 )\n* [PD] Remove Unnecessary Exception Handling for FastQueue.get() ( sgl-project#6712 )\n* Fuse routed_scaling_factor in DeepSeek ( sgl-project#6710 )\n* Overlap two kernels in DeepSeek with communication ( sgl-project#6711 )\n* Minor refactor two-batch overlap ( sgl-project#6682 )\n* Speed up when having padding tokens two-batch overlap ( sgl-project#6668 )\n* [Feature] Support Flashinfer fp8 blockwise GEMM kernel on Blackwell ( sgl-project#6479 )\n* Fix LoRA bench ( sgl-project#6719 )\n* temp\n* Fix PP for Qwen3 MoE ( sgl-project#6709 )\n* [feat] triton kernel for get_last_loc ( sgl-project#6676 )\n* [fix] more mem for draft_extend cuda_graph ( sgl-project#6726 )\n* [PD] bug fix:  Update status if nixl receiver send a a dummy req. ( sgl-project#6720 )\n* Tune memory arguments on B200 ( sgl-project#6718 )\n* Add DeepSeek-R1-0528 function call chat template ( sgl-project#6725 )\n* refactor(tool call): Fix BaseFormatDetector tool_index issue and refactor `parse_streaming_increment` ( sgl-project#6715 )\n* Add draft extend CUDA graph for Triton backend ( sgl-project#6705 )\n* refactor apply_w8a8_block_fp8_linear in fp ( sgl-project#6545 )\n* [PD] Support completion endpoint ( sgl-project#6729 )\n* PD Rust LB (PO2) ( sgl-project#6437 )\n* Super tiny enable sole usage of expert distribution metrics and update doc ( sgl-project#6680 )\n* Support picking variants\u00a0of EPLB algorithms ( sgl-project#6728 )\n* Support tuning DeepEP configs ( sgl-project#6742 )\n* [test] add ut and bm for get_last_loc ( sgl-project#6746 )\n* Fix mem_fraction_static for AMD CI ( sgl-project#6748 )\n* [fix][RL] Fix DeepSeekV3ForCausalLM.post_load_weights for multiple update weight ( sgl-project#6265 )\n* Improve EPLB logical to physical dispatch map ( sgl-project#6727 )\n* Update DeepSeek-R1-0528 function call chat template ( sgl-project#6765 )\n* [PD] Optimize time out logic and add env var doc for mooncake ( sgl-project#6761 )\n* Fix aiohttp 'Chunk too big' in bench_serving ( sgl-project#6737 )\n* Support sliding window in triton backend ( sgl-project#6509 )\n* Fix shared experts fusion error ( sgl-project#6289 )\n* Fix one bug in the grouped-gemm triton kernel ( sgl-project#6772 )\n* update llama4 chat template and pythonic parser ( sgl-project#6679 )\n* feat(tool call): Enhance Llama32Detector for improved JSON parsing in non-stream ( sgl-project#6784 )\n* Support token-level quantization for EP MoE ( sgl-project#6782 )\n* Temporarily lower mmlu threshold for triton sliding window backend ( sgl-project#6785 )\n* ci: relax test_function_call_required ( sgl-project#6786 )\n* Add intel_amx backend for Radix Attention for CPU ( sgl-project#6408 )\n* Fix incorrect LoRA weight loading for fused gate_up_proj ( sgl-project#6734 )\n* fix(PD-disaggregation): Can not get local ip ( sgl-project#6792 )\n* [FIX] mmmu bench serving result display error ( sgl-project#6525 ) ( sgl-project#6791 )\n* Bump torch to 2.7.0 ( sgl-project#6788 )\n* chore: bump sgl-kernel v0.1.5 ( sgl-project#6794 )\n* Improve profiler and integrate profiler in bench_one_batch_server ( sgl-project#6787 )\n* chore: upgrade sgl-kernel v0.1.5 ( sgl-project#6795 )\n* [Minor] Always append newline after image token when parsing chat message ( sgl-project#6797 )\n* Update CI tests for Llama4 models ( sgl-project#6421 )\n* [Feat] Enable PDL automatically on Hopper architecture ( sgl-project#5981 )\n* chore: update blackwell docker ( sgl-project#6800 )\n* misc: cache is_hopper_arch ( sgl-project#6799 )\n* Remove contiguous before Flashinfer groupwise fp8 gemm ( sgl-project#6804 )\n* Correctly abort the failed grammar requests & Improve the handling of abort ( sgl-project#6803 )\n* [EP] Add cuda kernel for moe_ep_pre_reorder ( sgl-project#6699 )\n* Add draft extend CUDA graph for flashinfer backend  ( sgl-project#6805 )\n* Refactor CustomOp to avoid confusing bugs ( sgl-project#5382 )\n* Tiny log prefill time ( sgl-project#6780 )\n* Tiny fix EPLB assertion about rebalancing period and recorder window size ( sgl-project#6813 )\n* Add simple utility to dump tensors for debugging ( sgl-project#6815 )\n* Fix profiles do not have consistent names ( sgl-project#6811 )\n* Speed up rebalancing when using non-static dispatch algorithms ( sgl-project#6812 )\n* [1/2] Add Kernel support for Cutlass based Fused FP4 MoE ( sgl-project#6093 )\n* [Router] Fix k8s Service Discovery ( sgl-project#6766 )\n* Add CPU optimized kernels for topk and rope fusions  ( sgl-project#6456 )\n* fix new_page_count_next_decode ( sgl-project#6671 )\n* Fix wrong weight reference in dynamic EPLB ( sgl-project#6818 )\n* Minor add metrics to expert location updater ( sgl-project#6816 )\n* [Refactor] Rename `n_share_experts_fusion` as `num_fused_shared_experts` ( sgl-project#6735 )\n* [FEAT] Add transformers backend support  ( sgl-project#5929 )\n* [fix] recover auto-dispatch for rmsnorm and rope ( sgl-project#6745 )\n* fix ep_moe_reorder kernel bugs ( sgl-project#6858 )\n* [Refactor] Multimodal data processing for VLM ( sgl-project#6659 )\n* Decoder-only Scoring API ( sgl-project#6460 )\n* feat: add dp-rank to KV events ( sgl-project#6852 )\n* Set `num_fused_shared_experts` as `num_shared_experts` when shared_experts fusion is not disabled ( sgl-project#6736 )\n* Fix one missing arg in DeepEP ( sgl-project#6878 )\n* Support LoRA in TestOpenAIVisionServer and fix fused kv_proj loading bug. ( sgl-project#6861 )\n* support 1 shot allreduce  in 1-node and 2-node using mscclpp ( sgl-project#6277 )\n* Fix Qwen3MoE missing token padding optimization ( sgl-project#6820 )\n* Tiny update error hints ( sgl-project#6846 )\n* Support layerwise rebalancing experts ( sgl-project#6851 )\n* Tiny allow profiler API to auto create directory ( sgl-project#6865 )\n* Support Blackwell DeepEP docker images ( sgl-project#6868 )\n* [EP] Add cuda kernel for moe_ep_post_reorder ( sgl-project#6837 )\n* [theta]merge 0605\n* oai: fix openAI client error with single request via batch api ( sgl-project#6170 )\n* [PD] Fix potential perf spike caused by tracker gc and optimize doc ( sgl-project#6764 )\n* Use deepgemm instead of triton for fused_qkv_a_proj_with_mqa ( sgl-project#6890 )\n* [CUTLASS-FP4-MOE]  Introduce CutlassMoEParams class for easy initialization of Cutlass Grouped Gems Metadata ( sgl-project#6887 )\n* bugfix(OAI): Fix image_data processing for jinja chat templates ( sgl-project#6877 )\n* [CPU] enable CI for PRs, add Dockerfile and auto build task ( sgl-project#6458 )\n* AITER backend extension and workload optimizations ( sgl-project#6838 )\n* [theta]merge\n* [theta]merge\n* [Feature] Support Flashinfer fmha on Blackwell ( sgl-project#6930 )\n* Fix a bug in abort & Improve docstrings for abort ( sgl-project#6931 )\n* Tiny support customize DeepEP max dispatch tokens per rank ( sgl-project#6934 )\n* Sync the changes on cuda graph runners ( sgl-project#6932 )\n* [PD] Optimize transfer queue forward logic for dummy rank ( sgl-project#6922 )\n* [Refactor] image data process in bench_serving ( sgl-project#6879 )\n* [fix] logical_to_all_physical_map index 256 is out of bounds in EP parallel. ( sgl-project#6767 )\n* Add triton fused moe kernel config for E=257 on B200 ( sgl-project#6939 )\n* [sgl-kernel] update deepgemm ( sgl-project#6942 )\n* chore: bump sgl-kernel v0.1.6 ( sgl-project#6943 )\n* Minor compile fused topk ( sgl-project#6944 )\n* [Bugfix] pipeline parallelism and Eagle Qwen2 ( sgl-project#6910 )\n* Tiny re-introduce profile id logging ( sgl-project#6912 )\n* Add triton version as a fused_moe_triton config search key to avoid performace decrease in different Triton version ( sgl-project#5955 )\n* reduce torch.zeros overhead in moe align block size kernel ( sgl-project#6369 )\n* chore: upgrade sgl-kernel v0.1.6 ( sgl-project#6945 )\n* add fbgemm moe grouped gemm kernel benchmark ( sgl-project#6924 )\n* [Docker] Add docker file for SGL Router ( sgl-project#6915 )\n* Disabling mixed chunked prefill when eagle is enabled ( sgl-project#6874 )\n* Add canary for EPLB rebalancing ( sgl-project#6895 )\n* Refactor global_server_args_dict ( sgl-project#6866 )\n* Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\n* Update server timeout time in AMD CI. ( sgl-project#6953 )\n* [misc] add is_cpu() ( sgl-project#6950 )\n* Add H20 fused MoE kernel tuning configs for DeepSeek-R1/V3 ( sgl-project#6885 )\n* Add a CUDA kernel for fusing mapping and weighted sum for MoE. ( sgl-project#6916 )\n* chore: bump sgl-kernel v0.1.6.post1 ( sgl-project#6955 )\n* chore: upgrade sgl-kernel v0.1.6.post1 ( sgl-project#6957 )\n* [DeepseekR1-FP4] Add Support for nvidia/DeepSeekR1-FP4 model ( sgl-project#6853 )\n* Revert \"Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\" ( sgl-project#6968 )\n* [AMD] Add more tests to per-commit-amd ( sgl-project#6926 )\n* chore: bump sgl-kernel v0.1.7 ( sgl-project#6963 )\n* Slightly improve the sampler to skip unnecessary steps ( sgl-project#6956 )\n* rebase h20 fused_moe config ( sgl-project#6966 )\n* Fix CI and triton moe Configs ( sgl-project#6974 )\n* Remove unnecessary kernels of num_token_non_padded ( sgl-project#6965 )\n* Extend cuda graph capture bs for B200 ( sgl-project#6937 )\n* Fuse routed scaling factor in deepseek ( sgl-project#6970 )\n* Sync cuda graph runners ( sgl-project#6976 )\n* Fix draft extend ut stability with flush cache ( sgl-project#6979 )\n* Fix triton sliding window test case ( sgl-project#6981 )\n* Fix expert distribution dumping causes OOM ( sgl-project#6967 )\n* Minor remove one kernel for DeepSeek ( sgl-project#6977 )\n* [perf][sgl-kernel] extend cutlass_mla_decode to support num_head < 128 ( sgl-project#6929 )\n* Enable more unit tests for AMD CI. ( sgl-project#6983 )\n* Use torch.compile to fuse flash attention decode metadata preparation ( sgl-project#6973 )\n* Eliminate stream sync to speed up LoRA batch init  ( sgl-project#6960 )\n* support qwen3 emebedding ( sgl-project#6990 )\n* Fix torch profiler bugs for bench_offline_throughput.py ( sgl-project#6557 )\n* chore: upgrade flashinfer v0.2.6.post1 jit ( sgl-project#6958 )\n* cleanup tmp dir ( sgl-project#7007 )\n* chore: update pr test xeon ( sgl-project#7008 )\n* Fix cutlass MLA gets almost zero accuracy ( sgl-project#6998 )\n* Update amd nightly models CI. ( sgl-project#6992 )\n* feat: add direct routing strategy to DP worker ( sgl-project#6884 )\n* Fallback to lower triton version for unfound fused moe configs ( sgl-project#7013 )\n* Fix torchvision version for Blackwell ( sgl-project#7015 )\n* Simplify prepare_extend_after_decode ( sgl-project#6987 )\n* Migrate to assertEqual ( sgl-project#6741 )\n* Fix torch version in blackwell dockerfile ( sgl-project#7017 )\n* chore: update pr test xeon ( sgl-project#7018 )\n* Update default settings for blackwell ( sgl-project#7023 )\n* Support both approximate and exact expert distribution collection ( sgl-project#6964 )\n* Add decode req pool ( sgl-project#6980 )\n* [theta]merge 0610\n* [theta]merge 0610\n* [CI] Add CI workflow for sgl-router docker build ( sgl-project#7027 )\n* Fix fused_moe triton configs ( sgl-project#7029 )\n* CPU: map changes from developing branch in sgl-kernel ( sgl-project#6833 )\n* chore: bump v0.4.7 ( sgl-project#7038 )\n* Update README.md ( sgl-project#7040 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 18:57:05",
  "has_lm_eval": true,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "LM_EVAL | PERF | SERVING | TEST",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Speed up rebalancing when using non-static dispatch algorithms (#6812)",
  "commit_message": "Speed up rebalancing when using non-static dispatch algorithms (#6812)",
  "commit_date": "2025-06-02T11:18:17-07:00",
  "files_changed": [
    "python/sglang/srt/managers/expert_location.py",
    "python/sglang/srt/managers/expert_location_dispatch.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2025,
    "num_edited_lines": 47,
    "num_files": 2,
    "num_hunks": 9,
    "num_non_test_edited_lines": 47,
    "num_non_test_files": 2,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/managers/expert_location.py b/python/sglang/srt/managers/expert_location.py\nindex 615e0a440..ea4c67a54 100644\n--- a/python/sglang/srt/managers/expert_location.py\n+++ b/python/sglang/srt/managers/expert_location.py\n@@ -35,7 +35,8 @@ class ExpertLocationMetadata:\n     physical_to_logical_map: torch.Tensor  # (layers, num_physical_experts)\n     logical_to_all_physical_map: torch.Tensor  # (layers, num_logical_experts, X)\n     logical_to_all_physical_map_num_valid: torch.Tensor  # (layers, num_logical_experts)\n-    logical_to_rank_dispatch_physical_map: torch.Tensor  # (layers, num_logical_experts)\n+    # (layers, num_logical_experts)\n+    logical_to_rank_dispatch_physical_map: Optional[torch.Tensor]\n \n     # -------------------------------- properties ------------------------------------\n \n@@ -70,11 +71,8 @@ class ExpertLocationMetadata:\n         num_layers_2, num_logical_experts_1 = (\n             self.logical_to_all_physical_map_num_valid.shape\n         )\n-        num_layers_3, num_logical_experts_2 = (\n-            self.logical_to_rank_dispatch_physical_map.shape\n-        )\n-        assert num_layers_0 == num_layers_1 == num_layers_2 == num_layers_3\n-        assert num_logical_experts_0 == num_logical_experts_1 == num_logical_experts_2\n+        assert num_layers_0 == num_layers_1 == num_layers_2\n+        assert num_logical_experts_0 == num_logical_experts_1\n         assert num_physical_experts_0 == num_physical_experts_1\n \n     # -------------------------------- construction ------------------------------------\n@@ -117,6 +115,7 @@ class ExpertLocationMetadata:\n         )\n \n         return ExpertLocationMetadata._init_raw(\n+            server_args=server_args,\n             ep_size=common[\"ep_size\"],\n             physical_to_logical_map=physical_to_logical_map,\n             logical_to_all_physical_map=logical_to_all_physical_map,\n@@ -154,6 +153,7 @@ class ExpertLocationMetadata:\n         )\n \n         return ExpertLocationMetadata._init_raw(\n+            server_args=server_args,\n             ep_size=common[\"ep_size\"],\n             physical_to_logical_map=physical_to_logical_map.to(server_args.device),\n             logical_to_all_physical_map=logical_to_all_physical_map.to(\n@@ -184,6 +184,7 @@ class ExpertLocationMetadata:\n \n     @staticmethod\n     def _init_raw(\n+        server_args: ServerArgs,\n         ep_size: int,\n         physical_to_logical_map: torch.Tensor,\n         logical_to_all_physical_map: torch.Tensor,\n@@ -204,12 +205,16 @@ class ExpertLocationMetadata:\n             physical_to_logical_map=physical_to_logical_map,\n             logical_to_all_physical_map=logical_to_all_physical_map_padded,\n             logical_to_all_physical_map_num_valid=logical_to_all_physical_map_num_valid,\n-            logical_to_rank_dispatch_physical_map=compute_logical_to_rank_dispatch_physical_map(\n-                logical_to_all_physical_map=logical_to_all_physical_map,\n-                num_gpus=ep_size,\n-                num_physical_experts=num_physical_experts,\n-                # TODO improve when we have real EP rank\n-                ep_rank=torch.distributed.get_rank() % ep_size,\n+            logical_to_rank_dispatch_physical_map=(\n+                compute_logical_to_rank_dispatch_physical_map(\n+                    logical_to_all_physical_map=logical_to_all_physical_map,\n+                    num_gpus=ep_size,\n+                    num_physical_experts=num_physical_experts,\n+                    # TODO improve when we have real EP rank\n+                    ep_rank=torch.distributed.get_rank() % ep_size,\n+                )\n+                if server_args.ep_dispatch_algorithm == \"static\"\n+                else None\n             ),\n         )\n \n@@ -230,8 +235,11 @@ class ExpertLocationMetadata:\n             \"logical_to_all_physical_map_num_valid\",\n             \"logical_to_rank_dispatch_physical_map\",\n         ]:\n+            src = getattr(other, field)\n             dst = getattr(self, field)\n-            dst[...] = getattr(other, field)\n+            assert (src is not None) == (dst is not None)\n+            if dst is not None:\n+                dst[...] = src\n \n     # -------------------------------- usage ------------------------------------\n \ndiff --git a/python/sglang/srt/managers/expert_location_dispatch.py b/python/sglang/srt/managers/expert_location_dispatch.py\nindex 6880b01a2..547dd4e72 100644\n--- a/python/sglang/srt/managers/expert_location_dispatch.py\n+++ b/python/sglang/srt/managers/expert_location_dispatch.py\n@@ -25,7 +25,7 @@ from sglang.srt.managers.schedule_batch import global_server_args_dict\n class ExpertLocationDispatchInfo:\n     ep_dispatch_algorithm: Literal[\"static\", \"random\"]\n     # (num_logical_experts,)\n-    partial_logical_to_rank_dispatch_physical_map: torch.Tensor\n+    partial_logical_to_rank_dispatch_physical_map: Optional[torch.Tensor]\n     # (num_logical_experts, X)\n     partial_logical_to_all_physical_map: torch.Tensor\n     # (num_logical_experts,)\n@@ -42,9 +42,14 @@ class ExpertLocationDispatchInfo:\n \n         return cls(\n             ep_dispatch_algorithm=ep_dispatch_algorithm,\n-            partial_logical_to_rank_dispatch_physical_map=expert_location_metadata.logical_to_rank_dispatch_physical_map[\n-                layer_id, :\n-            ],\n+            partial_logical_to_rank_dispatch_physical_map=(\n+                expert_location_metadata.logical_to_rank_dispatch_physical_map[\n+                    layer_id, :\n+                ]\n+                if expert_location_metadata.logical_to_rank_dispatch_physical_map\n+                is not None\n+                else None\n+            ),\n             partial_logical_to_all_physical_map=expert_location_metadata.logical_to_all_physical_map[\n                 layer_id, :\n             ],",
  "apis": [
    "sglang.srt.managers.expert_location.ExpertLocationMetadata",
    "sglang.srt.managers.expert_location_dispatch.ExpertLocationDispatchInfo"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/eplb/expert_location.py",
    "/path/to/repos/sglang/python/sglang/srt/eplb/expert_location_dispatch.py",
    "/path/to/repos/sglang/python/sglang/api.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies source code files (non-test files) by adding a conditional to avoid unnecessary computation when a non-static dispatch algorithm is used, which speeds up the rebalancing process. The improvements target the performance of the rebalancing operation within the expert dispatch functionality. Despite the commit message simply stating \"Speed up rebalancing,\" the code changes directly affect computations in high-level APIs, improving the efficiency on CPU without involving any GPU-specific logic. Overall, the commit meets the criteria for a performance or optimization-related change.",
  "llm_api_reason": "This commit updates the ExpertLocationMetadata and ExpertLocationDispatchInfo classes to handle a case where the rank dispatch mapping may be absent. Specifically, it changes the type of logical_to_rank_dispatch_physical_map (and its related partial version) from a required torch.Tensor to an Optional[torch.Tensor]. In addition, it adds server_args as a parameter when invoking _init_raw, and updates the update() method to carefully check for None before overwriting fields. These changes ensure that non\u2010static dispatch algorithms are correctly handled (by setting the mapping to None) and improve performance during expert rebalancing."
}