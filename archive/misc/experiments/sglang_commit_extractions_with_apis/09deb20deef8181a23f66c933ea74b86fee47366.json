{
  "commit_hash": "09deb20deef8181a23f66c933ea74b86fee47366",
  "pr_url": "https://github.com/sgl-project/sglang/pull/420",
  "pr_date": "2024-05-11",
  "timeline_text": "Copy link Contributor merrymercy commented May 11, 2024 No description provided. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions optimize the memory usage of logits processor c2f0ac2 merrymercy merged commit 09deb20 into main May 11, 2024 merrymercy deleted the opt_logits_processor branch May 11, 2024 23:56 timethink pushed a commit\n        to timethink/sglang\n      that referenced\n      this pull request Mar 9, 2025 Optimize the memory usage of logits processor ( sgl-project#420 ) 9ecc438 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 19:01:02",
  "has_lm_eval": false,
  "has_performance": false,
  "has_serving": false,
  "has_general_test": false,
  "test_details": "NONE",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Optimize the memory usage of logits processor (#420)",
  "commit_message": "Optimize the memory usage of logits processor (#420)",
  "commit_date": "2024-05-11T16:56:42-07:00",
  "files_changed": [
    "python/sglang/srt/layers/logits_processor.py",
    "python/sglang/srt/managers/router/model_rpc.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2024,
    "num_edited_lines": 6,
    "num_files": 2,
    "num_hunks": 2,
    "num_non_test_edited_lines": 6,
    "num_non_test_files": 2,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/layers/logits_processor.py b/python/sglang/srt/layers/logits_processor.py\nindex f95c30786..668cd3390 100644\n--- a/python/sglang/srt/layers/logits_processor.py\n+++ b/python/sglang/srt/layers/logits_processor.py\n@@ -98,7 +98,9 @@ class LogitsProcessor(nn.Module):\n                     all_logits = tensor_model_parallel_all_gather(all_logits)\n                 all_logits = all_logits[:, : self.config.vocab_size]\n \n-            all_logprobs = torch.log(torch.softmax(all_logits.float(), dim=-1) + 1e-6)\n+            all_logprobs = all_logits.float()\n+            all_logits = None\n+            all_logprobs[:] = torch.nn.functional.log_softmax(all_logprobs, dim=-1)\n \n             prefill_top_logprobs, decode_top_logprobs = self._get_top_logprobs(\n                 all_logprobs, input_metadata\ndiff --git a/python/sglang/srt/managers/router/model_rpc.py b/python/sglang/srt/managers/router/model_rpc.py\nindex f283635c3..55bd9e80c 100644\n--- a/python/sglang/srt/managers/router/model_rpc.py\n+++ b/python/sglang/srt/managers/router/model_rpc.py\n@@ -589,7 +589,7 @@ class ModelRpcServer:\n                     + len(req.output_ids)\n                     - req.prompt_tokens,\n                     \"completion_tokens_wo_jump_forward\": req.completion_tokens_wo_jump_forward,\n-                    \"finish_reason\": req.finish_reason,\n+                    \"finish_reason\": str(req.finish_reason),\n                     \"hit_stop_str\": req.hit_stop_str,\n                 }\n                 if req.return_logprob:",
  "apis": [
    "sglang.srt.layers.logits_processor.LogitsProcessor.forward",
    "sglang.srt.managers.router.ModelRpcServer"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/layers/logits_processor.py",
    "/path/to/repos/sglang/python/sglang/api.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies non-test source code (specifically in the logits processor and a model RPC file) with non-trivial changes to how the logits and their logarithms are computed. The changes focus on optimizing memory usage by eliminating an unnecessary intermediary tensor (by setting all_logits to None and performing an in-place log_softmax operation), which is a performance-related improvement. Although the commit message mentions \"Optimize the memory usage of logits processor\", the modifications reflect performance optimization rather than just superficial renaming or refactoring. The changes are testable on CPU and affect a top-level API used for logits processing.",
  "llm_api_reason": "The commit optimizes memory usage in the logits processor by avoiding an additional tensor allocation. Instead of computing log\u2010softmax via torch.log(torch.softmax(\u2026)), the code now reuses the same tensor (casting to float, then replacing its contents with the log_softmax results) and frees the original tensor reference. In addition, the commit explicitly converts the finish_reason field to a string in the RPC response of the model router. These changes affect the forward method of the LogitsProcessor (which computes logits and log\u2010probabilities) and the method in ModelRpcServer that returns/completes the RPC response, ensuring the finish_reason is always a string."
}