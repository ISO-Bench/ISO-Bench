{
  "commit_hash": "880221bd3b3e56a4bc2268fe9a9f77f426accf6c",
  "pr_url": "https://github.com/sgl-project/sglang/pull/7968",
  "pr_date": "2025-07-12",
  "timeline_text": "Copy link Collaborator fzyzcjy commented Jul 12, 2025 \u2022 edited Loading Uh oh! There was an error while loading. Please reload this page . cc @ShangmingCai Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Revert \"[PD Disaggregation] replace transfer with batch transfer for \u2026 \u2026 44a9234 \u2026better performance ( sgl-project#7236 )\n\n\"\n\nThis reverts commit 2ed68d7 . fzyzcjy requested review from hnyls2002 and ByronHsu as code owners July 12, 2025 01:18 gemini-code-assist bot reviewed Jul 12, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @fzyzcjy , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request reverts a previous change ( #7236 ) that aimed to improve performance by replacing individual data transfers with a batch transfer mechanism for KV cache synchronization in the disaggregation module. The revert suggests that the intended performance benefits were not realized or that the batch transfer approach introduced unforeseen issues, restoring the previous, more granular transfer method. Highlights Revert of Performance Optimization : This pull request undoes the changes introduced in PR #7236 , which had attempted to optimize KV cache synchronization by switching from individual transfer_sync calls to a single batch_transfer_sync operation. Restoration of Individual Transfers : Specifically, within the process_layer function of send_kvcache in python/sglang/srt/disaggregation/mooncake/conn.py , the code has been reverted to perform individual transfer_sync calls in a loop, rather than collecting all transfer details for a single batch_transfer_sync operation. Reintroduction of Per-Transfer Error Checking : The reverted code also reintroduces immediate error checking ( if status != 0: return status ) after each individual transfer_sync call, which was implicitly handled differently by the batch transfer. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with \ud83d\udc4d and \ud83d\udc4e on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . \u21a9 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jul 12, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request reverts the use of batch_transfer_sync back to transfer_sync in the send_kvcache function, likely to fix a correctness or stability issue. The review identifies that batch_transfer_sync is still used in two other functions within the same file ( send_kvcache_slice and send_aux ). It is recommended to revert these usages as well to maintain consistency and prevent potential issues, assuming the batched transfer method is the root cause of the problem. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions python/sglang/srt/disaggregation/mooncake/conn.py Comment on lines 269 to +280 def process_layer(src_ptr: int, dst_ptr: int, item_len: int) -> int: src_addr_list = [] dst_addr_list = [] length_list = [] for prefill_index, decode_index in zip(prefill_kv_blocks, dst_kv_blocks): src_addr = src_ptr + int(prefill_index[0]) * item_len dst_addr = dst_ptr + int(decode_index[0]) * item_len length = item_len * len(prefill_index) src_addr_list.append(src_addr) dst_addr_list.append(dst_addr) length_list.append(length) return self.engine.batch_transfer_sync( mooncake_session_id, src_addr_list, dst_addr_list, length_list ) status = self.engine.transfer_sync( mooncake_session_id, src_addr, dst_addr, length ) if status != 0: return status return 0 Copy link Contributor gemini-code-assist bot Jul 12, 2025 There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment This revert from batch_transfer_sync to transfer_sync seems to address a potential issue with the batched transfer. However, batch_transfer_sync is still being used in other parts of this file, specifically in send_kvcache_slice (line 436) and send_aux (line 476). If batch_transfer_sync is indeed problematic, its continued use in other functions poses a risk to correctness and stability. To ensure consistency, these other usages should also be reverted to their non-batched counterparts. For example, send_aux could be changed to: def send_aux ( self , mooncake_session_id : str , prefill_aux_index : int , dst_aux_ptrs : list [ int ], dst_aux_index : int ,\n): prefill_aux_ptrs = self . kv_args . aux_data_ptrs prefill_aux_item_lens = self . kv_args . aux_item_lens for i , dst_aux_ptr in enumerate ( dst_aux_ptrs ): length = prefill_aux_item_lens [ i ] src_addr = prefill_aux_ptrs [ i ] + length * prefill_aux_index dst_addr = dst_aux_ptrs [ i ] + length * dst_aux_index status = self . engine . transfer_sync ( mooncake_session_id , src_addr , dst_addr , length ) if status != 0 : return status return 0 Please consider reverting all usages of batch_transfer_sync in this file. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions zhyncs assigned ishandhanani and ShangmingCai Jul 12, 2025 zhyncs added bug Something isn't working high priority labels Jul 12, 2025 Copy link Member zhyncs commented Jul 12, 2025 @fzyzcjy @ShangmingCai do we need to use the older version of transfer engine All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author fzyzcjy commented Jul 12, 2025 I test using latest mooncake and it works All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . fzyzcjy mentioned this pull request Jul 12, 2025 [Roadmap] Blackwell Support and Optimizations #7227 Open 7 tasks Hide details View details zhyncs merged commit 880221b into sgl-project : main Jul 12, 2025 50 of 56 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator ShangmingCai commented Jul 12, 2025 @zhyncs No need, we only need to fix batch_transfer_sync with nvlink transport, then I will release a new package and bring this change back. The older transfer_sync is functioning well. \ud83d\udc4d 2 zhyncs and Swipe4057 reacted with thumbs up emoji \ud83d\ude04 1 fzyzcjy reacted with laugh emoji All reactions \ud83d\udc4d 2 reactions \ud83d\ude04 1 reaction Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . ZhengWG pushed a commit\n        to ZhengWG/sglang\n      that referenced\n      this pull request Jul 16, 2025 Revert \"[PD Disaggregation] replace transfer with batch transfer for \u2026 \u2026 b2d555d \u2026better performance ( sgl-project#7236 )\" ( sgl-project#7968 ) chenxijun1029 pushed a commit\n        to chenxijun1029/sglang\n      that referenced\n      this pull request Jul 17, 2025 Revert \"[PD Disaggregation] replace transfer with batch transfer for \u2026 \u2026 d8e434a \u2026better performance ( sgl-project#7236 )\" ( sgl-project#7968 ) DiweiSun pushed a commit\n        to DiweiSun/sglang\n      that referenced\n      this pull request Jul 18, 2025 Revert \"[PD Disaggregation] replace transfer with batch transfer for \u2026 \u2026 05fec4c \u2026better performance ( sgl-project#7236 )\" ( sgl-project#7968 ) shuaills pushed a commit\n        to shuaills/sglang\n      that referenced\n      this pull request Jul 21, 2025 Revert \"[PD Disaggregation] replace transfer with batch transfer for \u2026 \u2026 49ae622 \u2026better performance ( sgl-project#7236 )\" ( sgl-project#7968 ) fzyzcjy added a commit\n        to fzyzcjy/sglang\n      that referenced\n      this pull request Jul 22, 2025 Revert \"Revert \"[PD Disaggregation] replace transfer with batch trans\u2026 \u2026 f2e60f6 \u2026fer for better performance ( sgl-project#7236 )\" ( sgl-project#7968 )\"\n\nThis reverts commit 880221b . Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 18:56:13",
  "has_lm_eval": false,
  "has_performance": true,
  "has_serving": false,
  "has_general_test": true,
  "test_details": "PERF | TEST",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Revert \"[PD Disaggregation] replace transfer with batch transfer for better performance (#7236)\" (#7968)",
  "commit_message": "Revert \"[PD Disaggregation] replace transfer with batch transfer for better performance (#7236)\" (#7968)",
  "commit_date": "2025-07-11T19:03:01-07:00",
  "files_changed": [
    "python/sglang/srt/disaggregation/mooncake/conn.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2025,
    "num_edited_lines": 16,
    "num_files": 1,
    "num_hunks": 1,
    "num_non_test_edited_lines": 16,
    "num_non_test_files": 1,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/disaggregation/mooncake/conn.py b/python/sglang/srt/disaggregation/mooncake/conn.py\nindex db30d8c0d..d7bd308f1 100644\n--- a/python/sglang/srt/disaggregation/mooncake/conn.py\n+++ b/python/sglang/srt/disaggregation/mooncake/conn.py\n@@ -270,19 +270,17 @@ class MooncakeKVManager(BaseKVManager):\n \n         # Worker function for processing a single layer\n         def process_layer(src_ptr: int, dst_ptr: int, item_len: int) -> int:\n-            src_addr_list = []\n-            dst_addr_list = []\n-            length_list = []\n             for prefill_index, decode_index in zip(prefill_kv_blocks, dst_kv_blocks):\n                 src_addr = src_ptr + int(prefill_index[0]) * item_len\n                 dst_addr = dst_ptr + int(decode_index[0]) * item_len\n                 length = item_len * len(prefill_index)\n-                src_addr_list.append(src_addr)\n-                dst_addr_list.append(dst_addr)\n-                length_list.append(length)\n-            return self.engine.batch_transfer_sync(\n-                mooncake_session_id, src_addr_list, dst_addr_list, length_list\n-            )\n+\n+                status = self.engine.transfer_sync(\n+                    mooncake_session_id, src_addr, dst_addr, length\n+                )\n+                if status != 0:\n+                    return status\n+            return 0\n \n         futures = [\n             executor.submit(",
  "apis": [
    "MooncakeKVManager.send_kvcache"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/nixl/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/mooncake/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/ascend/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/common/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/fake/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/base/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/mooncake/transfer_engine.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/ascend/transfer_engine.py",
    "/path/to/repos/sglang/python/sglang/api.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies a source file (non-test file) and undoes a previous change which replaced multiple individual synchronous transfers with a batch transfer designed for performance improvement. Although the commit message merely indicates a revert, the underlying change is performance-related because it removes a performance optimization (batching) in favor of sequential transfers. The modifications affect core data transfer functionality on the CPU and are not just simple refactoring or documentation fixes. Despite reverting a previously performance-enhancing change, the commit is inherently performance-related.",
  "llm_api_reason": "The commit reverts a recent change where the transfer engine was using a batch-transfer method (batch_transfer_sync) to send key-value cache slices. The logic now iterates over each block and calls transfer_sync individually, effectively reverting the performance optimization. This change affects the send_kvcache method implemented in the MooncakeKVManager class."
}