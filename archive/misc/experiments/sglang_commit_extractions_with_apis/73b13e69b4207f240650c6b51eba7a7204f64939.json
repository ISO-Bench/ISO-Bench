{
  "commit_hash": "73b13e69b4207f240650c6b51eba7a7204f64939",
  "pr_url": "https://github.com/sgl-project/sglang/pull/7285",
  "pr_date": "2025-06-20",
  "timeline_text": "Copy link Collaborator ch-wan commented Jun 17, 2025 Motivation This PR saves one function call for all_gather_into_tensor when preparing idle batches for speculative decoding. Modifications Checklist Format your code according to the Code Formatting with Pre-Commit . Add unit tests as outlined in the Running Unit Tests . Update documentation / docstrings / example tutorials as needed, according to Writing Documentation . Provide throughput / latency benchmark results and accuracy evaluation results as needed, according to Benchmark and Profiling and Accuracy Results . For reviewers: If you haven't made any contributions to this PR and are only assisting with merging the main branch, please remove yourself as a co-author when merging the PR. Please feel free to join our Slack channel at https://slack.sglang.ai to discuss your PR. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions optimize dp scheduling for speculative decoding bfde20b ch-wan requested review from merrymercy , Ying1123 , hnyls2002 and xiezhq-hermann as code owners June 17, 2025 19:55 gemini-code-assist bot reviewed Jun 17, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Summary of Changes Hello @ch-wan , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! This pull request focuses on optimizing the distributed attention (DP attention) scheduling mechanism within the speculative decoding pipeline. By refactoring how new batches are coordinated, it reduces an unnecessary collective communication operation, leading to improved performance and a more streamlined batch preparation process. Highlights Performance Optimization : Eliminated one all_gather_into_tensor function call during speculative decoding's DP attention batch preparation, which streamlines the process and improves efficiency. Code Refactoring : The coordinate_spec_dp_attn_batch function has been removed. Its essential logic, along with a new need_dp_attn_preparation flag, has been integrated directly into the get_next_batch_to_run method for clearer control flow and reduced overhead. Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with \ud83d\udc4d and \ud83d\udc4e on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . \u21a9 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed Jun 17, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request successfully optimizes DP attention scheduling for speculative decoding by removing a redundant all_gather_into_tensor call. The logic has been refactored to leverage the existing all_gather within prepare_dp_attn_batch_raw , effectively coordinating prefill/idle batches in the speculative decoding path. The changes appear correct and maintain clarity, improving efficiency and maintainability. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions ch-wan assigned ch-wan and unassigned ch-wan Jun 19, 2025 Merge commit '8609e637a961dd0bd17bbf7f8f81b34cb2f7863a' into dev/opti\u2026 \u2026 0aaa6cd \u2026m-dp-scheduling zhyncs approved these changes Jun 20, 2025 View reviewed changes Hide details View details zhyncs merged commit 73b13e6 into main Jun 20, 2025 2 of 47 checks passed Uh oh! There was an error while loading. Please reload this page . zhyncs deleted the dev/optim-dp-scheduling branch June 20, 2025 22:06 whybeyoung pushed a commit\n        to whybeyoung/sglang\n      that referenced\n      this pull request Jun 24, 2025 Optimize DP attn scheduling for speculative decoding ( sgl-project#7285 ) 273961e yilian49 pushed a commit\n        to yilian49/sglang\n      that referenced\n      this pull request Jun 24, 2025 Optimize DP attn scheduling for speculative decoding ( sgl-project#7285 ) 1bd4c85 chenxijun1029 pushed a commit\n        to chenxijun1029/sglang\n      that referenced\n      this pull request Jul 17, 2025 Optimize DP attn scheduling for speculative decoding ( sgl-project#7285 ) d27c12c pi314ever pushed a commit\n        to pi314ever/sglang\n      that referenced\n      this pull request Jul 17, 2025 Merge 0 4 9 to master next ( sgl-project#80 ) \u2026 8f20122 * Use seq_len_fill_value in the cuda graph runners ( sgl-project#7233 )\n\n* support custom weight loader for model runner ( sgl-project#7122 )\n\nCo-authored-by: kavioyu <kavioyu@tencent.com>\n\n* Fix AMD speculative decoding ( sgl-project#7252 )\n\n* [Refactor] OAI Server components ( sgl-project#7167 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\n\n* OAI Server Skeleton & Core Utility Endpoints ( sgl-project#7179 )\n\n* [amd] Opt dsv3 moe ( sgl-project#7160 )\n\nCo-authored-by: wunhuang <wunhuang@amd.com>\n\n* update ci node for xeon ( sgl-project#7265 )\n\n* feat: mtp support dp-attention ( sgl-project#6081 )\n\nCo-authored-by: austindeng <austindeng@tencent.com>\nCo-authored-by: tianqilin.99 <tianqilin.99@bytedance.com>\nCo-authored-by: Qiaolin Yu <liin1211@outlook.com>\nCo-authored-by: ch-wan <cwan39@gatech.edu>\n\n* support qwen2 running on ascend npu device ( sgl-project#7022 )\n\nCo-authored-by: \u5201\u83b9\u715c <diaoyingyu1@hisilicon.com>\n\n* Fix Deepseek R1 0528 FP4 tensor name mismatch issue during weights loading. ( sgl-project#7164 )\n\n* bugfix(tool call ebnf): Fix EBNF generation for optional function parameters ( sgl-project#7283 )\n\n* Fix AWQ Dequant and Weight Loading of deepseek v2 ( sgl-project#6842 )\n\n* fix: resolve b200 dsv3 mtp issue ( sgl-project#7286 )\n\n* ci: Fix test_ebnf_generate_all_optional_function_params ( sgl-project#7288 )\n\n* fix: only enable flash_attn test on sm80 sm90 ( sgl-project#7289 )\n\n* [PD] Support get local ip from NIC for PD disaggregation ( sgl-project#7237 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [PD] Add custom memory pool option to support Mooncake PD with NVLink  ( sgl-project#7264 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* Upstreaming hicache bug fixes ( sgl-project#7267 )\n\n* Update python API of activation, topk, norm and rope and remove vllm dependency ( sgl-project#6614 )\n\nCo-authored-by: Wu, Chunyuan <chunyuan.wu@intel.com>\nCo-authored-by: jianan-gu <jianan.gu@intel.com>\nCo-authored-by: sdp <sdp@gnr799219.jf.intel.com>\n\n* Fix hicache benchmark script bug - some sampled input_request is [] ( sgl-project#7300 )\n\n* chore: change logs from`INFO` to `DEBUG` for dp and add force quit for tokenizer manager ( sgl-project#7251 )\n\n* update invalid link in doc ( sgl-project#7297 )\n\n* Fix mini_lb for PD with long output: limit chunk size of decode response ( sgl-project#7301 )\n\nSigned-off-by: ch-tiger1 <xyz@ch-tech.ip-ddns.com>\nCo-authored-by: ch-tiger1 <xyz@ch-tech.ip-ddns.com>\n\n* Fix profiler error when there are idle passes ( sgl-project#7003 )\n\n* [pd] optimize dockerfile for  pd disaggregation ( sgl-project#7319 )\n\nCo-authored-by: zhyncs <me@zhyncs.com>\n\n* Merge PDLB (Prefill-Decode Load Balancer) into SGLang Router ( sgl-project#7096 )\n\n* Add more refactored openai test & in CI ( sgl-project#7284 )\n\n* fix: resolve blackwell deepep image issue ( sgl-project#7331 )\n\n* add seed in CPU UTs to avoid flaky failure ( sgl-project#7333 )\n\n* Multi-Stage Awake: Support Resume and Pause KV Cache and Weights separately ( sgl-project#7099 )\n\n* Reintroduce tiny fix sampler error when prob is not contiguous ( sgl-project#7354 )\n\n* [Refactor] Clean up radix cache related API ( sgl-project#7303 )\n\nCo-authored-by: Zhiqiang Xie <xiezhq@stanford.edu>\n\n* Put `_normalize_rid` before other normalization in `io_struct` ( sgl-project#7363 )\n\n* [PD] Transfer hidden states for mtp when disaggregation ( sgl-project#7242 )\n\n* [Bugfix][PD] Set conclude state before clear when failure happens ( sgl-project#7362 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* docs: update installation ( sgl-project#7366 )\n\n* [Docker] optimize dockerfile  remove deepep and blackwell merge it to\u2026 ( sgl-project#7343 )\n\nCo-authored-by: Yineng Zhang <me@zhyncs.com>\n\n* Clean unused import for mimo mtp model ( sgl-project#7370 )\n\n* [Bugfix]Fix hang bug using dp attention with HiRadixCache ( sgl-project#7159 )\n\nSigned-off-by: huanglong <huanglong@linux.alibaba.com>\n\n* [Doc] add embedding rerank doc ( sgl-project#7364 )\n\n* Fix judgment condition for enabling Deepseek V3/R1 shared expert fusion optimization ( sgl-project#7371 )\n\n* Feat/refactor embedding server ( sgl-project#7322 )\n\n* Purge VerlEngine ( sgl-project#7326 )\n\nSigned-off-by: Ata Fatahi <immrata@gmail.com>\n\n* support return logprobs for pipeline ( sgl-project#7356 )\n\nCo-authored-by: Zhang Kaihong <zhangkaihong.zkh@alibaba-inc.com>\n\n* [PD] Optimize custom mem pool usage and bump mooncake version ( sgl-project#7393 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* Support THUDM/GLM-4-0414 (GLM-Z1) Glm4ForCausalLM architecture. ( sgl-project#5485 )\n\n* Refine OpenAI serving entrypoint to remove batch requests ( sgl-project#7372 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\nCo-authored-by: Chang Su <csu272@usc.edu>\n\n* [Feature] Comprehensive Hybrid Parallelism Support ( sgl-project#6389 )\n\n* [DeepSeekNextN] fix: residual of head norm can be None ( sgl-project#7398 )\n\n* [OAI refactor] Add rerank and score serving ( sgl-project#7399 )\n\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\n\n* [OAI Server Refactor] [ChatCompletions & Completions] Implement UsageInfo Processor ( sgl-project#7360 )\n\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\n\n* Fix All-Gather under world size one ( sgl-project#7219 )\n\n* Optimize DP attn scheduling for speculative decoding ( sgl-project#7285 )\n\n* Update usage_processor.py ( sgl-project#7402 )\n\n* Fix 7285 Merge Conflicts ( sgl-project#7403 )\n\n* chore: upgrade mooncake-transfer-engine 0.3.4 ( sgl-project#7401 )\n\n* [OAI Server Refactor] [ChatCompletions & Completions] Support Return Hidden State ( sgl-project#7329 )\n\nSigned-off-by: keru <rukeyang@gmail.com>\n\n* Remove batches api in docs & example ( sgl-project#7400 )\n\n* [BugFix]: fix EmbeddingReqInput single input error ( sgl-project#7396 )\n\n* [BugFix]fix qwen25 invoke function call streaming responses with curly braces as the starting indicator ( sgl-project#7394 )\n\n* fix overlap pagecount ( sgl-project#6984 )\n\nCo-authored-by: Zhiqiang Xie <xiezhq@stanford.edu>\n\n* fix: Fix CI test_function_call_parser.py ( sgl-project#7425 )\n\n* Fix CPU offloading for MLA memory pool ( sgl-project#7409 )\n\n* [fix] PD disaggregation when enable mtp and tp!=dp ( sgl-project#7420 )\n\n* feat(oai refactor): Replace `openai_api` with `entrypoints/openai`  ( sgl-project#7351 )\n\nCo-authored-by: Jin Pan <jpan236@wisc.edu>\n\n* Refactor LoRAManager and LoRAMemoryPool state management logic for dynamic LoRA loading support ( sgl-project#7412 )\n\n* refactor(test): reorganize OpenAI test file structure ( sgl-project#7408 )\n\n* [minor] simplify the `TokenToKVPoolAllocator` ( sgl-project#7414 )\n\n* Tiny add logging for GC  ( sgl-project#7406 )\n\n* FlashInfer NVFP4 MoE with EP & 2-stream shared expert ( sgl-project#7327 )\n\nCo-authored-by: JieXin Liang <Alcanderian@users.noreply.github.com>\nCo-authored-by: alcanderian <alcanderian@gmail.com>\n\n* Remove copy after bmm ( sgl-project#7441 )\n\n* Fix torch compile run ( sgl-project#7391 )\n\nCo-authored-by: wunhuang <wunhuang@amd.com>\nCo-authored-by: Sai Enduri <saimanas.enduri@amd.com>\n\n* [misc] Add PD service discovery support in router ( sgl-project#7361 )\n\n* add fused moe config for qwen3 in triton3.3.1 ( sgl-project#7445 )\n\n* Fix CUDA Graph Check under Deepep with DP FFN ( sgl-project#7451 )\n\n* Update hyperparameter_tuning.md ( sgl-project#7454 )\n\n* feat: integrate deepgemm into EPMoE ( sgl-project#6821 )\n\nCo-authored-by: tianqilin.99 <tianqilin.99@bytedance.com>\nCo-authored-by: TianQiLin666666 <1834987979@qq.com>\nCo-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com>\n\n* Solve docker build failed in the virtual machine ( sgl-project#7290 )\n\nCo-authored-by: wunhuang <wunhuang@amd.com>\nCo-authored-by: Sai Enduri <saimanas.enduri@amd.com>\nCo-authored-by: HAI <hixiao@gmail.com>\n\n* Fix a bug in BatchTokenIDOut & Misc style and dependency updates ( sgl-project#7457 )\n\n* [CI] Upgrade mooncake to 0.3.4.post1 to fix 8 gpu tests ( sgl-project#7472 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* Fix prefill OOM due to wrong token calculation when page > 1  ( sgl-project#7397 )\n\n* feat(func_call): Add more check in `BaseFormatDetector.parse_streaming_increment` ( sgl-project#7479 )\n\n* Fix dtype for idle input in spec decoding ( sgl-project#7456 )\n\n* update mooncake in dockerfile ( sgl-project#7480 )\n\n* kvcache io kernels and test case ( sgl-project#7382 )\n\n* [perf] slightly imporve DeepSeek-R1-FP4 TP8 ( sgl-project#7481 )\n\n* Quick fix for DeepGemm requant to also cover MTP. ( sgl-project#7378 )\n\n* Support weight loading without mmap ( sgl-project#7469 )\n\n* ci: Revert openai_server related tests in AMD suites ( sgl-project#7449 )\n\n* Perormance: Enable cuda graph for dp idle batch ( sgl-project#7269 )\n\nCo-authored-by: austindeng <austindeng@tencent.com>\nCo-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com>\nCo-authored-by: ch-wan <cwan39@gatech.edu>\n\n* bugfix: Prevent global mutation of conv.stop_str across requests ( sgl-project#7347 )\n\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\n\n* Fix RequestValidationError response format ( sgl-project#7487 )\n\n* Fix MTP with Deepseek R1 Fp4 ( sgl-project#7376 )\n\n* chore: bump sgl-kernel v0.2.0 ( sgl-project#7490 )\n\n* chore: bump v0.4.8 ( sgl-project#7493 )\n\n* [AMD] add aiter fused moe in DeepEP path ( sgl-project#7268 )\n\n* enable aiter_biased_grouped_topk kernel ( sgl-project#7423 )\n\n* [PD Disaggregation] replace transfer with batch transfer for better performance ( sgl-project#7236 )\n\n* Remove cumsum_buffer initilization ( sgl-project#7439 )\n\n* [benchmark] fbgemm benchmark support bandwidth report and support fbgemm_cutlass_gmm ( sgl-project#7422 )\n\n* Support multi-thread model weight loading ( sgl-project#7277 )\n\n* [PD] NIXL: Register kv args in advance and cleanup finished requests ( sgl-project#6717 )\n\n* fix: Add `--model` as an alias for `--model-path` in server_args ( sgl-project#7505 )\n\n* misc: Improvement to serving_chat.py and add more ut ( sgl-project#7489 )\n\n* Fuse sorted_token_ids padding to moe_align_block_size kernel ( sgl-project#7437 )\n\n* [OAI] patch origin request_id logic ( sgl-project#7508 )\n\n* [PD][Spec] Fix hidden state transfer for spec decode ( sgl-project#7516 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* EPLB support for MTP ( sgl-project#7510 )\n\n* clean duplicate code ( sgl-project#7512 )\n\n* [ci] add router benchmark script and CI ( sgl-project#7498 )\n\n* fix: force synchronization between TP workers when update_weights ( sgl-project#6626 )\n\nCo-authored-by: dangkai.dk <dangkai.dk@alibaba-inc.com>\n\n* [CPU] [BF16] Call fused_experts_cpu, weight_packed_linear and bmm_cpu kernel in DeepSeek model ( sgl-project#6641 )\n\nCo-authored-by: Thien Tran <gau.nernst@yahoo.com.sg>\n\n* [CI] Upgrade mooncake to v0.3.4.post2 to fix potential slice failed bug ( sgl-project#7522 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* npu fused op ( sgl-project#7386 )\n\nCo-authored-by: Li Junwen <lijunwen13@hisilicon.com>\n\n* feat: send kvmetrics from sglang scheduler ( sgl-project#6721 )\n\n* [PD] Add different TP sizes support for no-MLA models ( sgl-project#6793 )\n\nCo-authored-by: shangmingc <csmthu@gmail.com>\nCo-authored-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* enable aiter fp8 blockscale quant ( sgl-project#7520 )\n\n* take aiter get_rope back ( sgl-project#7521 )\n\n* Fix typo of flash_cache ( sgl-project#7513 )\n\n* feat: add return hidden_states at async generation ( sgl-project#7507 )\n\n* minor: 'role' must be system/assistant/tool, but case insensitive for now ( sgl-project#7499 )\n\n* Fix FP8 KV Cache Support in FA3 Backend ( sgl-project#7148 )\n\n* Fix gathered_buffer issues in tbo ( sgl-project#7531 )\n\n* [PD] Raise error for incompatible mooncake version and some minor fixes ( sgl-project#7527 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* [CMake] Fix sgl-kernel CMakeLists for Blackwell ( sgl-project#7543 )\n\n* Add Tencent HunYuanMoEV1 model support ( sgl-project#7549 )\n\n* Update seed in CPU UTs to avoid flaky failure with single test ( sgl-project#7544 )\n\n* chore: improve ci bug reporting ( sgl-project#7542 )\n\n* chore: remove vlm unnecessary import ( sgl-project#7541 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\nCo-authored-by: yhyang201 <yhyang201@gmail.com>\nCo-authored-by: Mick <mickjagger19@icloud.com>\n\n* chore: bump v0.4.8.post1 ( sgl-project#7559 )\n\n* [PD][NIXL] Set is_sorted=False to fix NIXL_ERR_NOT_FOUND ( sgl-project#7330 )\n\n* [Fix] incorrect assert in EPLB ( sgl-project#7575 )\n\n* Updates Gemma3n MLP layer to adapt latest transformers version ( sgl-project#7573 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\n\n* Fix MTP error when enabling two-batch overlap  ( sgl-project#7569 )\n\n* Add e2e test for multi instance multi stage memory release/resume occupuation ( sgl-project#7208 )\n\nSigned-off-by: Ata Fatahi <immrata@gmail.com>\n\n* [CI] Add CI Testing for Prefill-Decode Disaggregation with Router ( sgl-project#7540 )\n\n* Updates transformers and timm dependencies ( sgl-project#7577 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\n\n* feat: support compatibility between MTP and two-batch-overlap ( sgl-project#7225 )\n\nCo-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com>\n\n* Move multimodal processors into a separate folder ( sgl-project#7581 )\n\n* Fix broken CI TestVILAServer ( sgl-project#7610 )\n\n* [router] add centralized configuration module for sgl-router ( sgl-project#7588 )\n\n* Fix: Minicpm ( sgl-project#7612 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\n\n* Hybrid kv cache for LLaMA4 ( sgl-project#6563 )\n\nCo-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com>\nCo-authored-by: tarinkk <rt572@physics.rutger.edu>\nCo-authored-by: tarinkk <rt572@rutgers.physics.edu>\nCo-authored-by: Hanming Lu <69857889+hanming-lu@users.noreply.github.com>\n\n* [CPU] add optimizations for INT8 and FP8 DeepSeek ( sgl-project#6769 )\n\nCo-authored-by: Zheng, Beilei <beilei.zheng@intel.com>\n\n* Tiny add logs for expert location updater ( sgl-project#7308 )\n\n* Fix flakiness in LoRA batch test. ( sgl-project#7552 )\n\n* [BUG] fix local_rank in initialize_dp_attention ( sgl-project#7584 )\n\n* Support dynamic LoRA loading / unloading in engine/server API ( sgl-project#7446 )\n\n* [PD] Respect sampling_params.max_new_tokens when PD disaggregation is activated ( sgl-project#7598 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* fix unit tests ( sgl-project#7618 )\n\n* Let ep_scatter support arbitrary strides / ue8m0 format ( sgl-project#7309 )\n\n* Let EP prefill support new DeepGEMM ( sgl-project#7310 )\n\n* docs: add gb200 nvl72 and a16z grant ( sgl-project#7620 )\n\n* oai: Adds support for OpenAI chat completions API in bench_serving ( sgl-project#7036 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\nCo-authored-by: yhyang201 <47235274+yhyang201@users.noreply.github.com>\nCo-authored-by: Mick <mickjagger19@icloud.com>\n\n* [bugfix] Remove PR comment posting from Rust benchmark workflow ( sgl-project#7625 )\n\n* [Minor] clean up multimodal processor and tokenizer manager ( sgl-project#7624 )\n\n* Add dsv3 fused a gemm to sgl-kernel ( sgl-project#7630 )\n\n* Add @mickqian as the CODEOWNERS of multimodal ( sgl-project#7636 )\n\n* Fix stream reasoning parser and Adds Kimi reasoning parser  ( sgl-project#7432 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\n\n* Fix sgl-router startup crash ( sgl-project#7619 )\n\n* [bugfix] fix runtime dropping panic in editable ( sgl-project#7628 )\n\n* Move files related to EPLB ( sgl-project#7580 )\n\n* [misc] reduce weird rope_scaling_factor warning ( sgl-project#7176 )\n\n* [AMD] Add unit-test-sgl-kernel-amd to AMD CI ( sgl-project#7539 )\n\n* Update CODEOWNERS ( sgl-project#7640 )\n\n* [EAGLE] remove a wrong adjustment for page_size > 1 & topk > 1 in server_args.py ( sgl-project#7643 )\n\n* [CPU] add c++ kernel to bind CPU cores and memory node ( sgl-project#7524 )\n\n* Improve streaming, log_level, memory report, weight loading, and benchmark script ( sgl-project#7632 )\n\nCo-authored-by: Kan Wu <wukanustc@gmail.com>\n\n* Add dsv3 router gemm kernel ( sgl-project#7627 )\n\n* chore: upgrade flashinfer v0.2.7 jit ( sgl-project#7663 )\n\n* [doc] update lws doc for pd ( sgl-project#7318 )\n\n* Fix: sync prepare_fp8_layer_for_marlin with latest vllm changes ( sgl-project#7648 )\n\n* Add small requirements for benchmark/parse_result tools ( sgl-project#7671 )\n\n* [CPU] remove process_group from inputs of shm_allreduce and shm_allgather ( sgl-project#7486 )\n\n* chore: bump sgl-kernel v0.2.1 ( sgl-project#7675 )\n\n* support llama4 eagle3  ( sgl-project#6985 )\n\nCo-authored-by: shuaills <shishuaiuoe@gmail.com>\nCo-authored-by: Shenggui Li <somerlee.9@gmail.com>\nCo-authored-by: Yingyi Huang <yingyihuang2000@outlook.com>\nCo-authored-by: yizhang2077 <1109276519@qq.com>\n\n* Refactor mm processors and Enable mixed modality processing ( sgl-project#7629 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\n\n* upgrade sgl kernel to 0.2.1 for main ( sgl-project#7676 )\n\n* add description for llama4 eagle3 ( sgl-project#7688 )\n\n* fix(model loader): use safe_open to prevent file handle leaks. ( sgl-project#7684 )\n\n* chore: upgrade flashinfer v0.2.7.post1 ( sgl-project#7698 )\n\n* Improve error handling for requests with unloaded LoRA path(s) ( sgl-project#7642 )\n\n* Apply dsv3_fused_a_gemm kernel ( sgl-project#7635 )\n\n* Fix GPTQMarlinMoE ( sgl-project#7697 )\n\n* [1/n] apply wna16marlin kernel in moe weight only quantization ( sgl-project#7683 )\n\nCo-authored-by: \u665f\u6d77 <huangtingwei.htw@antgroup.com>\nCo-authored-by: yych0745 <1398089567@qq.com>\nCo-authored-by: HandH1998 <1335248067@qq.com>\nCo-authored-by: \u5f0b\u4e91 <yiyun.wyt@antgroup.com>\nCo-authored-by: walker-ai <2398833647@qq.com>\n\n* Apply dsv3 router gemm kernel for deepseek-r1 fp4 ( sgl-project#7677 )\n\n* [AMD] Temporarily disable test_no_overlap_scheduler and test_vision_chunked_prefill ( sgl-project#7717 )\n\n* [RL] add --skip-warmup ( sgl-project#7416 )\n\n* [RL] support update_weights_from_distributed with different group and multiple weights ( sgl-project#7292 )\n\n* [router] add --log-level to sgl-router ( sgl-project#6512 )\n\n* [b200] support trt-llm allreduce fuse rms_norm_add kernel ( sgl-project#7621 )\n\n* [CPU] Bind threads and numa node for each TP rank ( sgl-project#6549 )\n\nCo-authored-by: srinarayan-srikanthan <srinarayan.srikanthan@intel.com>\n\n* Support non-contiguous query input for extend/decode attention ( sgl-project#7462 )\n\n* Support updating weights at once by stopping all requests ( sgl-project#6698 )\n\nSigned-off-by: Tianyu Zhou <albert.zty@antgroup.com>\nCo-authored-by: Zilin Zhu <zhuzilinallen@gmail.com>\n\n* Fix num_tokens_pre_allocated in disaggregation log ( sgl-project#7714 )\n\n* [CPU] [sgl-kernel] set dispatch key of initialize to CatchAll ( sgl-project#7734 )\n\n* [CPU] fix all_reduce and all_gather ( sgl-project#6770 )\n\nCo-authored-by: blzheng <beilei.zheng@intel.com>\n\n* fix awq and dsv3 fused gemm compatible ( sgl-project#7735 )\n\n* [CI][Router] Fix bench_one_batch_server for pd router test ( sgl-project#7731 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\n\n* Add CUTLASS FP8 Blockscale MoE kernel for Hopper architecture ( sgl-project#7278 )\n\nCo-authored-by: HydraQYH <QYH820@Outlook.com>\nCo-authored-by: TianQiLin666666 <1834987979@qq.com>\n\n* fix dsv3 fused proj check  ( sgl-project#7738 )\n\n* Ascend attention backend(PA&MLA) ( sgl-project#7722 )\n\nCo-authored-by: Maksim <makcum888e@mail.ru>\nCo-authored-by: VDV1985 <vladdv85@mail.ru>\n\n* [fix] fix dsv3_router_gemm filter ( sgl-project#7750 )\n\n* [CPU] refine CPU integration code ( sgl-project#7647 )\n\n* [CPU] support the case where num_attention_heads or intermediate_size is not divisible by the TP size ( sgl-project#6771 )\n\n* support qwen3 dense model dp attention ( sgl-project#7681 )\n\n* [optimize] add two stream norm for qwen3 ( sgl-project#7740 )\n\nCo-authored-by: ispobock <ispobaoke@gmail.com>\n\n* feat: use D2D instead of H2H in pp ( sgl-project#7673 )\n\nCo-authored-by: alpha-baby <fujianhao1997@qq.com>\n\n* [Bug] add flashinfer bool check for fusedmoe in Qwen moe models ( sgl-project#7723 )\n\n* [fix] put cpu in the first priority in get_device() ( sgl-project#7752 )\n\n* [optimize] fuse renormalize into moe_topk_softmax ( sgl-project#7744 )\n\nCo-authored-by: ispobock <ispobaoke@gmail.com>\n\n* chore: bump sgl-kernel 0.2.2 ( sgl-project#7755 )\n\n* fix CI: update native api ipynb ( sgl-project#7754 )\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\n\n* fuse renormal into moe topk softmax kernel python code ( sgl-project#7751 )\n\nCo-authored-by: ispobock <ispobaoke@gmail.com>\nCo-authored-by: zhyncs <me@zhyncs.com>\n\n* Remove type conversion and fix id map in topk ( sgl-project#7759 )\n\n* Add V2-lite model test ( sgl-project#7390 )\n\nCo-authored-by: DiweiSun <105627594+DiweiSun@users.noreply.github.com>\n\n* refactor llama4 dp attention logic ( sgl-project#7729 )\n\n* fix(docs): fix the broken link in `docs/references/production_metrics.md` ( sgl-project#7741 )\n\nSigned-off-by: rudeigerc <rudeigerc@gmail.com>\n\n* [fix] update bench_speculative.py for compatibility ( sgl-project#7764 )\n\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\n\n* Move mem_fraction_static adjustment for multimodal models to `server_args.py` & Fix session control & Other cleanups ( sgl-project#7748 )\n\n* [RL] Add --nccl-port to prevent port conflict ( sgl-project#7418 )\n\n* [RL] add pause and continue generation for async rl training ( sgl-project#7419 )\n\n* [Fix] Alloc return type error ( sgl-project#7778 )\n\nSigned-off-by: Capronir <839972205@qq.com>\n\n* [feat] Support EAGLE3 for Qwen ( sgl-project#7745 )\n\nCo-authored-by: \u7eac\u676d <ximing.wxm@antgroup.com>\nCo-authored-by: zyksir <zyksir@outlook.com>\n\n* saving hidden_states.clone() ( sgl-project#7705 )\n\n* [1/n]: add cutlass W4A8 moe kernel for hopper architecture ( sgl-project#7772 )\n\nSigned-off-by: yangsijia.614 <yangsijia.614@bytedance.com>\nCo-authored-by: yicwang <yichen.wang@bytedance.com>\n\n* add model: qwen2-audio ( sgl-project#7596 )\n\n* Optimize Hopper CUTLASS FP8 Blockwise Grouped GEMM Kernel in Small K Scenario ( sgl-project#7782 )\n\n* Embedding parallel by attn_tp ( sgl-project#7623 )\n\n* fix: fix apply_shuffle_mul_sum ( sgl-project#7444 )\n\n* chore: bump sgl-kernel v0.2.3 ( sgl-project#7784 )\n\n* fix: use nvidia-nccl-cu12 2.27.5 ( sgl-project#7787 )\n\n* DP Attention with Auto DeepEP Dispatch ( sgl-project#7222 )\n\n* chore: upgrade sgl-kernel v0.2.3 ( sgl-project#7786 )\n\n* Fix incorrect spec_num_draft_tokens in draft_extend ( sgl-project#7757 )\n\n* [fix] fix misusing of is_cuda ( sgl-project#7790 )\n\n* Add treemask mode to build_eagle_tree & release sgl-kernel 0.2.3 ( sgl-project#7756 )\n\nCo-authored-by: Pranjal Shankhdhar <pranjal.ssh@gmail.com>\n\n* chore: bump sgl-kernel v0.2.4 ( sgl-project#7800 )\n\n* ci: fix port args ( sgl-project#7792 )\n\n* Fix CI test OOM issue. ( sgl-project#7799 )\n\n* chore: upgrade sgl-kernel v0.2.4 ( sgl-project#7801 )\n\n* chore: bump v0.4.9 ( sgl-project#7802 )\n\n* fix merge conflict issue\n\n* fix hpu attention nonetyep issue\n\n* fix alignment\n\n* fix alignment2\n\n* Ci failure fixes\n\n* fix attention-backend choices\n\n---------\n\nSigned-off-by: Xinyuan Tong <justinning0323@outlook.com>\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>\nSigned-off-by: ch-tiger1 <xyz@ch-tech.ip-ddns.com>\nSigned-off-by: huanglong <huanglong@linux.alibaba.com>\nSigned-off-by: Ata Fatahi <immrata@gmail.com>\nSigned-off-by: keru <rukeyang@gmail.com>\nSigned-off-by: Tianyu Zhou <albert.zty@antgroup.com>\nSigned-off-by: rudeigerc <rudeigerc@gmail.com>\nSigned-off-by: Kay Yan <kay.yan@daocloud.io>\nSigned-off-by: Capronir <839972205@qq.com>\nSigned-off-by: yangsijia.614 <yangsijia.614@bytedance.com>\nSigned-off-by: Mohit Sinha <msinha@habana.ai>\nCo-authored-by: Lianmin Zheng <lianminzheng@gmail.com>\nCo-authored-by: KavioYu <67678385+yukavio@users.noreply.github.com>\nCo-authored-by: kavioyu <kavioyu@tencent.com>\nCo-authored-by: Xinyuan Tong <115166877+JustinTong0323@users.noreply.github.com>\nCo-authored-by: yhyang201 <47235274+yhyang201@users.noreply.github.com>\nCo-authored-by: kk <43161300+kkHuang-amd@users.noreply.github.com>\nCo-authored-by: wunhuang <wunhuang@amd.com>\nCo-authored-by: DiweiSun <105627594+DiweiSun@users.noreply.github.com>\nCo-authored-by: u4lr451 <u4lr451@gmail.com>\nCo-authored-by: austindeng <austindeng@tencent.com>\nCo-authored-by: tianqilin.99 <tianqilin.99@bytedance.com>\nCo-authored-by: Qiaolin Yu <liin1211@outlook.com>\nCo-authored-by: ch-wan <cwan39@gatech.edu>\nCo-authored-by: Yijie Zhu <762412795@qq.com>\nCo-authored-by: \u5201\u83b9\u715c <diaoyingyu1@hisilicon.com>\nCo-authored-by: Charles Chen <pychen96@gmail.com>\nCo-authored-by: Chang Su <chang.s.su@oracle.com>\nCo-authored-by: AniZpZ <zhuangsen.zp@antgroup.com>\nCo-authored-by: Yineng Zhang <me@zhyncs.com>\nCo-authored-by: shangmingc <caishangming@linux.alibaba.com>\nCo-authored-by: Zhiqiang Xie <xiezhq@stanford.edu>\nCo-authored-by: YanbingJiang <yanbing.jiang@intel.com>\nCo-authored-by: Wu, Chunyuan <chunyuan.wu@intel.com>\nCo-authored-by: jianan-gu <jianan.gu@intel.com>\nCo-authored-by: sdp <sdp@gnr799219.jf.intel.com>\nCo-authored-by: Binyao Jiang <byjiang1996@gmail.com>\nCo-authored-by: ishandhanani <82981111+ishandhanani@users.noreply.github.com>\nCo-authored-by: linzhuo <15313137931lz@gmail.com>\nCo-authored-by: ch-tiger1 <tiger@ch-tech.ip-ddns.com>\nCo-authored-by: ch-tiger1 <xyz@ch-tech.ip-ddns.com>\nCo-authored-by: fzyzcjy <5236035+fzyzcjy@users.noreply.github.com>\nCo-authored-by: ybyang <10629930+whybeyoung@users.noreply.github.com>\nCo-authored-by: Simo Lin <linsimo.mark@gmail.com>\nCo-authored-by: Jinn <47354855+jhinpan@users.noreply.github.com>\nCo-authored-by: Stefan He <hebiaobuaa@gmail.com>\nCo-authored-by: DarkSharpness <76582120+DarkSharpness@users.noreply.github.com>\nCo-authored-by: Atream <80757050+Atream@users.noreply.github.com>\nCo-authored-by: Li Hui <lambert80.ios@gmail.com>\nCo-authored-by: Huang Long <121648372+LLLL114@users.noreply.github.com>\nCo-authored-by: woodx <124784234+woodx9@users.noreply.github.com>\nCo-authored-by: Ata Fatahi <immrata@gmail.com>\nCo-authored-by: strgrb <zhangkaihong.zkh@antgroup.com>\nCo-authored-by: Zhang Kaihong <zhangkaihong.zkh@alibaba-inc.com>\nCo-authored-by: Wenbo Yang <solrex@users.noreply.github.com>\nCo-authored-by: Chang Su <csu272@usc.edu>\nCo-authored-by: Cheng Wan <54331508+ch-wan@users.noreply.github.com>\nCo-authored-by: Keyang Ru <rukeyang@gmail.com>\nCo-authored-by: ehuaa <ehuamail@163.com>\nCo-authored-by: pansicheng <sicheng.pan.chn@gmail.com>\nCo-authored-by: Liangsheng Yin <hnyls2002@gmail.com>\nCo-authored-by: Jin Pan <jpan236@wisc.edu>\nCo-authored-by: Lifu Huang <lifu.hlf@gmail.com>\nCo-authored-by: Trevor Morris <tmorris@nvidia.com>\nCo-authored-by: JieXin Liang <Alcanderian@users.noreply.github.com>\nCo-authored-by: alcanderian <alcanderian@gmail.com>\nCo-authored-by: Ke Bao <ISPObaoke@163.com>\nCo-authored-by: Sai Enduri <saimanas.enduri@amd.com>\nCo-authored-by: Yi Zhang <1109276519@qq.com>\nCo-authored-by: xutizhou <xutingz@nvidia.com>\nCo-authored-by: TianQiLin666666 <1834987979@qq.com>\nCo-authored-by: HAI <hixiao@gmail.com>\nCo-authored-by: Yuhong Guo <guoyuhong1985@outlook.com>\nCo-authored-by: huangtingwei <141888744+huangtingwei9988@users.noreply.github.com>\nCo-authored-by: Alex Sun <alex.s@amd.com>\nCo-authored-by: valarLip <103567126+valarLip@users.noreply.github.com>\nCo-authored-by: Francis <38564764+ssssnow@users.noreply.github.com>\nCo-authored-by: Xiaoyu Zhang <35585791+BBuf@users.noreply.github.com>\nCo-authored-by: xianzhiT <xianzhitang@tencent.com>\nCo-authored-by: yilian49 <43861414+yilian49@users.noreply.github.com>\nCo-authored-by: DangKai <dangkai4u@outlook.com>\nCo-authored-by: dangkai.dk <dangkai.dk@alibaba-inc.com>\nCo-authored-by: Thien Tran <gau.nernst@yahoo.com.sg>\nCo-authored-by: ll819214 <18801269230@163.com>\nCo-authored-by: Li Junwen <lijunwen13@hisilicon.com>\nCo-authored-by: zixuanzhang226 <zixuanzhang@bytedance.com>\nCo-authored-by: Hongbo Xu <1320612015@qq.com>\nCo-authored-by: shangmingc <csmthu@gmail.com>\nCo-authored-by: eigen <52445717+yyihuang@users.noreply.github.com>\nCo-authored-by: mlmz <54172054+minleminzui@users.noreply.github.com>\nCo-authored-by: Ruihang Lai <ruihangl@cs.cmu.edu>\nCo-authored-by: Meng, Peng <pengmeng@tencent.com>\nCo-authored-by: Mick <mickjagger19@icloud.com>\nCo-authored-by: yhyang201 <yhyang201@gmail.com>\nCo-authored-by: tarinkk <129432511+tarinkk@users.noreply.github.com>\nCo-authored-by: tarinkk <rt572@physics.rutger.edu>\nCo-authored-by: tarinkk <rt572@rutgers.physics.edu>\nCo-authored-by: Hanming Lu <69857889+hanming-lu@users.noreply.github.com>\nCo-authored-by: Zheng, Beilei <beilei.zheng@intel.com>\nCo-authored-by: Sheng Qi <shengqi2018@pku.edu.cn>\nCo-authored-by: finetune <82650881+finetunej@users.noreply.github.com>\nCo-authored-by: Hubert Lu <55214931+hubertlu-tw@users.noreply.github.com>\nCo-authored-by: Kan Wu <wukanustc@gmail.com>\nCo-authored-by: Baizhou Zhang <sobereddiezhang@gmail.com>\nCo-authored-by: narutolhy <582909902@qq.com>\nCo-authored-by: lukec <118525388+sleepcoo@users.noreply.github.com>\nCo-authored-by: shuaills <shishuaiuoe@gmail.com>\nCo-authored-by: Shenggui Li <somerlee.9@gmail.com>\nCo-authored-by: Yingyi Huang <yingyihuang2000@outlook.com>\nCo-authored-by: Simon_CQK <cqk0100@gmail.com>\nCo-authored-by: Kyungmin Lee <30465912+lkm2835@users.noreply.github.com>\nCo-authored-by: \u665f\u6d77 <huangtingwei.htw@antgroup.com>\nCo-authored-by: yych0745 <1398089567@qq.com>\nCo-authored-by: HandH1998 <1335248067@qq.com>\nCo-authored-by: \u5f0b\u4e91 <yiyun.wyt@antgroup.com>\nCo-authored-by: walker-ai <2398833647@qq.com>\nCo-authored-by: Zilin Zhu <zhuzilinallen@gmail.com>\nCo-authored-by: srinarayan-srikanthan <srinarayan.srikanthan@intel.com>\nCo-authored-by: Albert <albert.zty@antgroup.com>\nCo-authored-by: Ziming Huang <1520787127@qq.com>\nCo-authored-by: ayrnb <70835312+ayrnb@users.noreply.github.com>\nCo-authored-by: HydraQYH <QYH820@Outlook.com>\nCo-authored-by: ronnie_zheng <zl19940307@163.com>\nCo-authored-by: Maksim <makcum888e@mail.ru>\nCo-authored-by: VDV1985 <vladdv85@mail.ru>\nCo-authored-by: ispobock <ispobaoke@gmail.com>\nCo-authored-by: TianyuZhang1214 <tianyuzhang1214@163.com>\nCo-authored-by: alpha-baby <fujianhao1997@qq.com>\nCo-authored-by: Yuchen Cheng <rudeigerc@gmail.com>\nCo-authored-by: Kay Yan <kay.yan@daocloud.io>\nCo-authored-by: Caproni <40862361+Capronir@users.noreply.github.com>\nCo-authored-by: Ximingwang-09 <72070413+Ximingwang-09@users.noreply.github.com>\nCo-authored-by: \u7eac\u676d <ximing.wxm@antgroup.com>\nCo-authored-by: zyksir <zyksir@outlook.com>\nCo-authored-by: SijiaYang <yangsijia.614@bytedance.com>\nCo-authored-by: yicwang <yichen.wang@bytedance.com>\nCo-authored-by: Leng Yue <lengyue@lengyue.me>\nCo-authored-by: Qi Yuhang <45795032+HydraQYH@users.noreply.github.com>\nCo-authored-by: Gang Chen <13298548+MoonBall@users.noreply.github.com>\nCo-authored-by: Pranjal Shankhdhar <pranjal.ssh@gmail.com>\nCo-authored-by: jay <jthakur@habana.ai> Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 18:56:27",
  "has_lm_eval": false,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "PERF | SERVING | TEST",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Optimize DP attn scheduling for speculative decoding (#7285)",
  "commit_message": "Optimize DP attn scheduling for speculative decoding (#7285)",
  "commit_date": "2025-06-20T15:06:41-07:00",
  "files_changed": [
    "python/sglang/srt/managers/scheduler.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2025,
    "num_edited_lines": 44,
    "num_files": 1,
    "num_hunks": 3,
    "num_non_test_edited_lines": 44,
    "num_non_test_files": 1,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/managers/scheduler.py b/python/sglang/srt/managers/scheduler.py\nindex 8253a303b..14ed362cf 100644\n--- a/python/sglang/srt/managers/scheduler.py\n+++ b/python/sglang/srt/managers/scheduler.py\n@@ -1399,29 +1399,6 @@ class Scheduler(\n             self.metrics_collector.log_stats(self.stats)\n         self._publish_kv_events()\n \n-    def coordinate_spec_dp_attn_batch(self, new_batch: Optional[ScheduleBatch]):\n-        \"\"\"Coordinate the DP attention batch.\"\"\"\n-\n-        local_info = torch.tensor(\n-            [\n-                (new_batch is not None),\n-            ],\n-            dtype=torch.int64,\n-        )\n-        global_info = torch.empty(\n-            (self.server_args.dp_size, self.attn_tp_size, 1),\n-            dtype=torch.int64,\n-        )\n-        torch.distributed.all_gather_into_tensor(\n-            global_info.flatten(),\n-            local_info,\n-            group=self.tp_cpu_group,\n-        )\n-        any_new_batch = any(\n-            global_info[:, 0, 0].tolist()\n-        )  # Any DP worker has forward batch\n-        return any_new_batch\n-\n     def get_next_batch_to_run(self) -> Optional[ScheduleBatch]:\n         # Merge the prefill batch into the running batch\n         chunked_req_to_exclude = set()\n@@ -1456,13 +1433,15 @@ class Scheduler(\n \n         new_batch = self.get_new_batch_prefill()\n \n-        # TODO(ch-wan): minor refactor is needed here to improve readability\n-        any_new_batch = (\n-            self.server_args.enable_dp_attention\n-            and not self.spec_algorithm.is_none()\n-            and self.coordinate_spec_dp_attn_batch(new_batch)\n-        )\n-        if new_batch is not None or any_new_batch:\n+        need_dp_attn_preparation = require_mlp_sync(self.server_args)\n+\n+        if need_dp_attn_preparation and not self.spec_algorithm.is_none():\n+            # In speculative decoding, prefill batches and decode batches cannot be processed in the same DP attention group.\n+            # We prepare idle batches in advance to skip preparing decode batches when there are prefill batches in the group.\n+            new_batch, _ = self.prepare_dp_attn_batch(new_batch)\n+            need_dp_attn_preparation = new_batch is None\n+\n+        if new_batch is not None:\n             # Run prefill first if possible\n             ret = new_batch\n         else:\n@@ -1473,8 +1452,9 @@ class Scheduler(\n             else:\n                 ret = None\n \n-        if require_mlp_sync(self.server_args):\n-            ret, _ = self.prepare_mlp_sync_batch(ret)\n+        # Handle DP attention\n+        if need_dp_attn_preparation:\n+            ret, _ = self.prepare_dp_attn_batch(ret)\n \n         return ret",
  "apis": [
    "sglang.srt.managers.scheduler.Scheduler.get_next_batch_to_run",
    "sglang.srt.managers.scheduler.Scheduler.coordinate_spec_dp_attn_batch",
    "sglang.srt.managers.scheduler.Scheduler.prepare_dp_attn_batch"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/managers/scheduler.py",
    "/path/to/repos/sglang/python/sglang/api.py",
    "/path/to/repos/sglang/examples/runtime/engine/fastapi_engine_inference.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies a core scheduler file (a non-test file) and changes the internal logic for handling DP attention scheduling during speculative decoding. The implementation is non-trivial (a whole method is removed and replaced with new logic to prepare batches), and it is clearly aimed at optimizing the performance (reducing unnecessary work by pre-preparing idle batches and avoiding processing decode batches when prefill batches are available). Although the commit message mentions \"Optimize DP attn scheduling\", the changes affect the performance of a key scheduling API on CPU, and the alterations are directly intended to improve runtime efficiency rather than just refactoring or fixing bugs. Hence, this commit meets the criteria for a performance optimization change.",
  "llm_api_reason": "This commit removes an internal method (coordinate_spec_dp_attn_batch) and modifies the way that the scheduler decides on the next batch. Instead of calling the removed coordination method to check for DP attention batches, the updated get_next_batch_to_run now first checks whether DP attention preparation is required (using require_mlp_sync) and then calls prepare_dp_attn_batch to adjust the batch appropriately. This change optimizes DP attention scheduling in speculative decoding scenarios, which affects how the scheduler\u2019s next batch is chosen and processed."
}