{
  "commit_hash": "9183c23eca51bf76159e81dfd6edf5770796c2d8",
  "pr_url": "https://github.com/sgl-project/sglang/pull/2695",
  "pr_date": "2025-01-02",
  "timeline_text": "Copy link Collaborator fzyzcjy commented Jan 1, 2025 \u2022 edited Loading Uh oh! There was an error while loading. Please reload this page . Motivation Speed up by avoiding tensor serialization and deserialization. Since it was only used for tests before and never released, the old one was OK, and the new one with API breaking changes seems OK. Modifications Checklist Format your code according to the Contributor Guide . Add unit tests as outlined in the Contributor Guide . Update documentation as needed, including docstrings or example tutorials. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions fzyzcjy added 10 commits January 1, 2025 20:53 fix name 8f4abe0 minor cf79096 more 8ee5ccd more 7c63870 more 713a693 more e27022e more f38a322 more 6b941fb more 7b92554 more 80cd850 fzyzcjy requested review from merrymercy , Ying1123 , zhyncs and ispobock as code owners January 1, 2025 13:25 fzyzcjy force-pushed the feat/improve_update_weights branch\n    from 2752d62 to 80cd850 Compare January 1, 2025 13:27 fzyzcjy requested review from hnyls2002 and ByronHsu as code owners January 1, 2025 13:27 fzyzcjy added 7 commits January 1, 2025 21:29 more 6e2d75f more 2b06a3c more 1b43489 more 576bcc1 more 916c147 more dbffc28 fmt 613d409 fzyzcjy mentioned this pull request Jan 1, 2025 Support RLOO/GRPO/REINFORCE? volcengine/verl#68 Closed Copy link Collaborator Author fzyzcjy commented Jan 1, 2025 CI looks green now All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . merrymercy requested changes Jan 2, 2025 View reviewed changes test/srt/test_update_weights_from_tensor.py Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . fzyzcjy and others added 3 commits January 2, 2025 09:54 more 60cc8ba Merge branch 'main' into feat/improve_update_weights 3e8d6d7 rm 80de3eb fzyzcjy added 3 commits January 2, 2025 10:11 Revert \"Merge branch 'main' into feat/improve_update_weights\" \u2026 fb3a8a8 This reverts commit 3e8d6d7 , reversing\nchanges made to 60cc8ba . Revert \"Revert \"Merge branch 'main' into feat/improve_update_weights\"\" \u2026 5867d7a This reverts commit fb3a8a8 . bump ci to check flaky 8f8c9c1 Copy link Collaborator Author fzyzcjy commented Jan 2, 2025 Hmm, quick question firstly: is it possible this is flakyness? Commit 5867d7a fails accuracy-test-2, while 8f8c9c1 (same logic) fails accuracy-test-1. And the failures does not seem to be super related to the current PR at first glance. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Hide details View details merrymercy merged commit 9183c23 into sgl-project : main Jan 2, 2025 14 of 15 checks passed Uh oh! There was an error while loading. Please reload this page . Copy link Contributor merrymercy commented Jan 2, 2025 @fzyzcjy Yes, some these are flaky. All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . Copy link Collaborator Author fzyzcjy commented Jan 2, 2025 I see All reactions Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . XiaotongJiang pushed a commit\n        to XiaotongJiang/sglang\n      that referenced\n      this pull request Jan 3, 2025 Speed up update_weights_from_tensor ( sgl-project#2695 ) 470cb36 fzyzcjy mentioned this pull request Feb 24, 2025 [Bug] update_weights_from_tensor raise EOFError when TP>1 #3726 Closed 5 tasks timethink pushed a commit\n        to timethink/sglang\n      that referenced\n      this pull request Mar 9, 2025 Speed up update_weights_from_tensor ( sgl-project#2695 ) a0a5e89 chaokunyang reviewed Jun 29, 2025 View reviewed changes python/sglang/srt/managers/tp_worker.py @@ -197,7 +197,7 @@ def update_weights_from_distributed( def update_weights_from_tensor(self, recv_req: UpdateWeightsFromTensorReqInput): success, message = self.model_runner.update_weights_from_tensor( recv_req.name, recv_req. tensor MultiprocessingSerializer.deserialize( recv_req. serialized_named_tensors) Copy link chaokunyang Jun 29, 2025 \u2022 edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment @fzyzcjy Will this work for inter-node cases? For example, if tp_size is greater than 8 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Copy link Collaborator Author fzyzcjy Jun 29, 2025 \u2022 edited Loading Uh oh! There was an error while loading. Please reload this page . There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Yes as long as your tensors are from correct devices Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 18:59:50",
  "has_lm_eval": false,
  "has_performance": false,
  "has_serving": false,
  "has_general_test": true,
  "test_details": "TEST",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Speed up `update_weights_from_tensor` (#2695)",
  "commit_message": "Speed up `update_weights_from_tensor` (#2695)",
  "commit_date": "2025-01-02T02:05:19-08:00",
  "files_changed": [
    "python/sglang/srt/managers/io_struct.py",
    "python/sglang/srt/managers/tp_worker.py",
    "python/sglang/srt/model_executor/model_runner.py",
    "python/sglang/srt/server.py",
    "python/sglang/srt/utils.py",
    "test/srt/test_update_weights_from_tensor.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2025,
    "num_edited_lines": 73,
    "num_files": 6,
    "num_hunks": 15,
    "num_non_test_edited_lines": 73,
    "num_non_test_files": 6,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/managers/io_struct.py b/python/sglang/srt/managers/io_struct.py\nindex 13eb233bd..1aae28b00 100644\n--- a/python/sglang/srt/managers/io_struct.py\n+++ b/python/sglang/srt/managers/io_struct.py\n@@ -426,8 +426,7 @@ class UpdateWeightsFromDistributedReqOutput:\n \n @dataclass\n class UpdateWeightsFromTensorReqInput:\n-    name: str\n-    tensor: torch.Tensor\n+    serialized_named_tensors: bytes  # indeed Dict[str, torch.Tensor]\n \n \n @dataclass\ndiff --git a/python/sglang/srt/managers/tp_worker.py b/python/sglang/srt/managers/tp_worker.py\nindex c8e14a746..6168441d1 100644\n--- a/python/sglang/srt/managers/tp_worker.py\n+++ b/python/sglang/srt/managers/tp_worker.py\n@@ -30,7 +30,7 @@ from sglang.srt.managers.schedule_batch import ModelWorkerBatch, global_server_a\n from sglang.srt.model_executor.forward_batch_info import ForwardBatch\n from sglang.srt.model_executor.model_runner import ModelRunner\n from sglang.srt.server_args import ServerArgs\n-from sglang.srt.utils import broadcast_pyobj, set_random_seed\n+from sglang.srt.utils import MultiprocessingSerializer, broadcast_pyobj, set_random_seed\n \n logger = logging.getLogger(__name__)\n \n@@ -197,7 +197,7 @@ class TpModelWorker:\n \n     def update_weights_from_tensor(self, recv_req: UpdateWeightsFromTensorReqInput):\n         success, message = self.model_runner.update_weights_from_tensor(\n-            recv_req.name, recv_req.tensor\n+            MultiprocessingSerializer.deserialize(recv_req.serialized_named_tensors)\n         )\n         return success, message\n \ndiff --git a/python/sglang/srt/model_executor/model_runner.py b/python/sglang/srt/model_executor/model_runner.py\nindex 786f654de..53b48ce78 100644\n--- a/python/sglang/srt/model_executor/model_runner.py\n+++ b/python/sglang/srt/model_executor/model_runner.py\n@@ -17,7 +17,7 @@ import gc\n import json\n import logging\n import time\n-from typing import Optional\n+from typing import List, Optional, Tuple\n \n import torch\n import torch.distributed as dist\n@@ -428,9 +428,9 @@ class ModelRunner:\n             logger.error(error_msg)\n             return False, error_msg\n \n-    def update_weights_from_tensor(self, name, tensor: torch.Tensor):\n-        self.model.load_weights([(name, tensor)])\n-        return True, \"Success\"  # TODO error handling\n+    def update_weights_from_tensor(self, named_tensors: List[Tuple[str, torch.Tensor]]):\n+        self.model.load_weights(named_tensors)\n+        return True, \"Success\"\n \n     def get_weights_by_name(\n         self, name: str, truncate_size: int = 100\ndiff --git a/python/sglang/srt/server.py b/python/sglang/srt/server.py\nindex d95ce5931..35216bddb 100644\n--- a/python/sglang/srt/server.py\n+++ b/python/sglang/srt/server.py\n@@ -27,7 +27,9 @@ import signal\n import threading\n import time\n from http import HTTPStatus\n-from typing import AsyncIterator, Dict, List, Optional, Union\n+from typing import AsyncIterator, Dict, List, Optional, Tuple, Union\n+\n+import torch\n \n # Fix a bug of Python threading\n setattr(threading, \"_register_atexit\", lambda *args, **kwargs: None)\n@@ -78,6 +80,7 @@ from sglang.srt.openai_api.adapter import (\n from sglang.srt.openai_api.protocol import ModelCard, ModelList\n from sglang.srt.server_args import PortArgs, ServerArgs\n from sglang.srt.utils import (\n+    MultiprocessingSerializer,\n     add_api_key_middleware,\n     add_prometheus_middleware,\n     assert_pkg_version,\n@@ -874,9 +877,11 @@ class Engine:\n             tokenizer_manager.update_weights_from_distributed(obj, None)\n         )\n \n-    def update_weights_from_tensor(self, name, tensor):\n+    def update_weights_from_tensor(self, named_tensors: List[Tuple[str, torch.Tensor]]):\n         \"\"\"Update weights from distributed source.\"\"\"\n-        obj = UpdateWeightsFromTensorReqInput(name=name, tensor=tensor)\n+        obj = UpdateWeightsFromTensorReqInput(\n+            serialized_named_tensors=MultiprocessingSerializer.serialize(named_tensors)\n+        )\n         loop = asyncio.get_event_loop()\n         return loop.run_until_complete(\n             tokenizer_manager.update_weights_from_tensor(obj, None)\ndiff --git a/python/sglang/srt/utils.py b/python/sglang/srt/utils.py\nindex 7c3efa9a2..8ee9d205c 100644\n--- a/python/sglang/srt/utils.py\n+++ b/python/sglang/srt/utils.py\n@@ -15,6 +15,7 @@\n \n import base64\n import dataclasses\n+import io\n import ipaddress\n import itertools\n import json\n@@ -34,6 +35,7 @@ import warnings\n from functools import lru_cache\n from importlib.metadata import PackageNotFoundError, version\n from io import BytesIO\n+from multiprocessing.reduction import ForkingPickler\n from typing import Any, Callable, Dict, List, Optional, Protocol, Tuple, Union\n \n import numpy as np\n@@ -60,7 +62,6 @@ from triton.runtime.cache import (\n \n logger = logging.getLogger(__name__)\n \n-\n show_time_cost = False\n time_infos = {}\n \n@@ -1206,7 +1207,6 @@ def _cuda_device_count_stateless(cuda_visible_devices: Optional[str] = None) ->\n     # https://github.com/pytorch/pytorch/blob/\n     # c1cd946818442aca8c7f812b16d187ce1586c3bc/\n     # torch/cuda/__init__.py#L831C1-L831C17\n-    import torch.cuda\n     import torch.version\n \n     if not torch.cuda._is_compiled():\n@@ -1335,3 +1335,16 @@ def parse_tool_response(text, tools, **kwargs):\n         for call_info in call_info_list\n     ]\n     return text, call_info_list\n+\n+\n+class MultiprocessingSerializer:\n+    @staticmethod\n+    def serialize(obj):\n+        buf = io.BytesIO()\n+        ForkingPickler(buf).dump(obj)\n+        buf.seek(0)\n+        return buf.read()\n+\n+    @staticmethod\n+    def deserialize(data):\n+        return ForkingPickler.loads(data)\ndiff --git a/test/srt/test_update_weights_from_tensor.py b/test/srt/test_update_weights_from_tensor.py\nindex 7cca98a0f..f38f76c5d 100644\n--- a/test/srt/test_update_weights_from_tensor.py\n+++ b/test/srt/test_update_weights_from_tensor.py\n@@ -1,3 +1,4 @@\n+import time\n import unittest\n \n import torch\n@@ -6,27 +7,32 @@ import sglang as sgl\n from sglang.test.test_utils import DEFAULT_SMALL_MODEL_NAME_FOR_TEST\n \n \n-class TestReleaseGPUOccupation(unittest.TestCase):\n-    def test_release_and_resume_occupation(self):\n+class TestUpdateWeightsFromTensor(unittest.TestCase):\n+    def test_update_weights_from_tensor(self):\n         engine = sgl.Engine(model_path=DEFAULT_SMALL_MODEL_NAME_FOR_TEST)\n \n-        param_name = \"model.layers.2.self_attn.k_proj.weight\"\n+        param_names = [f\"model.layers.{i}.mlp.up_proj.weight\" for i in range(6, 16)]\n \n-        def _check_param(expect_values):\n-            actual_values = torch.tensor(engine.get_weights_by_name(param_name))[0, :5]\n-            assert torch.allclose(\n-                actual_values, torch.tensor(expect_values), atol=0.001\n-            ), f\"{actual_values=}\"\n+        _check_param(engine, param_names[0], [0.0087, -0.0214, -0.0004, 0.0039, 0.0110])\n \n-        _check_param([0.0571, -0.0114, 0.0444, 0.0215, -0.0149])\n+        new_tensor = torch.full((16384, 2048), 1.5)\n \n-        new_tensor = torch.full((3072, 2048), 1.5)\n-        engine.update_weights_from_tensor(param_name, new_tensor)\n+        time_start = time.time()\n+        engine.update_weights_from_tensor([(x, new_tensor) for x in param_names])\n+        print(f\"Time delta: {time.time() - time_start:.03f}\")\n \n-        _check_param([1.5] * 5)\n+        for param_name in param_names[:3]:\n+            _check_param(engine, param_name, [1.5] * 5)\n \n         engine.shutdown()\n \n \n+def _check_param(engine, param_name, expect_values):\n+    actual_values = torch.tensor(engine.get_weights_by_name(param_name))[0, :5]\n+    assert torch.allclose(\n+        actual_values, torch.tensor(expect_values), atol=0.002\n+    ), f\"{actual_values=}\"\n+\n+\n if __name__ == \"__main__\":\n     unittest.main()",
  "apis": [
    "TpModelWorker.update_weights_from_tensor",
    "ModelRunner.update_weights_from_tensor",
    "Engine.update_weights_from_tensor"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/managers/tp_worker.py",
    "/path/to/repos/sglang/python/sglang/srt/model_executor/model_runner.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies multiple non-test source code files by changing how tensors are serialized and deserialized for the update_weights_from_tensor API. The change replaces a direct tensor transfer with a serialized bytes object approach, potentially reducing overhead and speeding up the process. Although the commit message explicitly mentions speed improvements, the modifications involve deep changes in data handling (i.e., replacing direct tensor passing with a custom serialization strategy) that can improve communication performance internally without involving GPU-specific code. The changes are non-trivial, impact performance for a high-level API, and are not merely refactoring or bug fixes. Therefore, the commit satisfies the conditions for a performance optimization change.",
  "llm_api_reason": "The commit refactors the update_weights_from_tensor API. It changes the input structure from separate name and tensor fields to a single serialized field (serialized_named_tensors) and adjusts the deserialization process using MultiprocessingSerializer. This change propagates through the request object (in io_struct.py), the corresponding handler in TpModelWorker, the ModelRunner\u2019s update_weights_from_tensor method, and the Engine API that packages the request. Overall, the commit speeds up weight updating by optimizing tensor serialization/deserialization."
}