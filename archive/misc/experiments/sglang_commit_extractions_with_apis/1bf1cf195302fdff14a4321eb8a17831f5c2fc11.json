{
  "commit_hash": "1bf1cf195302fdff14a4321eb8a17831f5c2fc11",
  "pr_url": "https://github.com/sgl-project/sglang/pull/375",
  "pr_date": "2024-04-21",
  "timeline_text": "Copy link Collaborator hnyls2002 commented Apr 21, 2024 \u2022 edited Loading Uh oh! There was an error while loading. Please reload this page . 67be11c this commit fixed the race condition when copying ProgramState or StreamExceutor , but it brings overhead when the number of forked branches is 1. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions fix 93a2019 hnyls2002 changed the title Reduce Reduce overhead when fork(1) Apr 21, 2024 format df7bc84 hnyls2002 merged commit 1bf1cf1 into main Apr 21, 2024 hnyls2002 deleted the fix-copy-fork branch April 21, 2024 09:25 qeternity added a commit\n        to qeternity/sglang\n      that referenced\n      this pull request May 6, 2024 Revert \"Reduce overhead when fork(1) ( sgl-project#375 )\" \u2026 39fc85b This reverts commit 1bf1cf1 . hnyls2002 mentioned this pull request May 7, 2024 Fix sync() when fork(1) #412 Merged timethink pushed a commit\n        to timethink/sglang\n      that referenced\n      this pull request Mar 9, 2025 Reduce overhead when fork(1) ( sgl-project#375 ) 74d44f2 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 19:01:08",
  "has_lm_eval": false,
  "has_performance": true,
  "has_serving": false,
  "has_general_test": false,
  "test_details": "PERF",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Reduce overhead when `fork(1)` (#375)",
  "commit_message": "Reduce overhead when `fork(1)` (#375)",
  "commit_date": "2024-04-21T17:25:14+08:00",
  "files_changed": [
    "python/sglang/lang/interpreter.py",
    "python/sglang/srt/managers/router/radix_cache.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2024,
    "num_edited_lines": 27,
    "num_files": 2,
    "num_hunks": 3,
    "num_non_test_edited_lines": 27,
    "num_non_test_files": 2,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/lang/interpreter.py b/python/sglang/lang/interpreter.py\nindex 00691ca50..ef3d9fb1f 100644\n--- a/python/sglang/lang/interpreter.py\n+++ b/python/sglang/lang/interpreter.py\n@@ -256,9 +256,15 @@ class StreamExecutor:\n         ret = self.meta_info.get(name, None)\n         return ret\n \n-    def fork(self, number: int, position_ids_offset: Optional[List[int]] = None):\n-        self.submit(SglCommitLazy())\n-        self.sync()\n+    def fork(\n+        self,\n+        number: int,\n+        position_ids_offset: Optional[List[int]] = None,\n+        copy: bool = False,\n+    ):\n+        if number > 1 or copy:\n+            self.submit(SglCommitLazy())\n+            self.sync()\n \n         number = int(number)\n \n@@ -641,15 +647,20 @@ class ProgramState:\n         yield\n         self.stream_executor.submit(SglVarScopeEnd(name))\n \n-    def fork(self, number: int = 1, position_ids_offset: Optional[List[int]] = None):\n-        stream_executors = self.stream_executor.fork(number, position_ids_offset)\n+    def fork(\n+        self,\n+        number: int = 1,\n+        position_ids_offset: Optional[List[int]] = None,\n+        copy: bool = False,\n+    ):\n+        stream_executors = self.stream_executor.fork(number, position_ids_offset, copy)\n         states = [ProgramState(x) for x in stream_executors]\n         state_group = ProgramStateGroup(states, self)\n         return state_group\n \n     @contextmanager\n     def copy(self, position_ids_offset: Optional[List[int]] = None):\n-        state_group = self.fork(1, position_ids_offset)\n+        state_group = self.fork(1, position_ids_offset, True)\n         try:\n             yield state_group[0]\n         finally:\ndiff --git a/python/sglang/srt/managers/router/radix_cache.py b/python/sglang/srt/managers/router/radix_cache.py\nindex 7bb8a4b2a..c7bd9cb6b 100644\n--- a/python/sglang/srt/managers/router/radix_cache.py\n+++ b/python/sglang/srt/managers/router/radix_cache.py\n@@ -179,7 +179,9 @@ class RadixCache:\n \n     def _print_helper(self, node, indent):\n         for _, child in node.children.items():\n-            print(\" \" * indent, len(child.key), child.key[:10], f\"r={child.ref_counter}\")\n+            print(\n+                \" \" * indent, len(child.key), child.key[:10], f\"r={child.ref_counter}\"\n+            )\n             self._print_helper(child, indent=indent + 2)\n \n     def _delete_leaf(self, node):",
  "apis": [
    "sglang.lang.interpreter.StreamExecutor.fork",
    "sglang.lang.interpreter.ProgramState.fork",
    "sglang.lang.interpreter.ProgramState.copy"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/lang/interpreter.py",
    "/path/to/repos/sglang/python/sglang/api.py",
    "/path/to/repos/sglang/python/sglang/srt/mem_cache/radix_cache.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies two non-test source files (python/sglang/lang/interpreter.py and python/sglang/srt/managers/router/radix_cache.py). In the interpreter and ProgramState fork methods, a new boolean \"copy\" flag is added and the conditional logic is updated to avoid unnecessary synchronization when the fork count is 1 (i.e., reducing overhead for this common case). This change specifically targets reducing runtime overhead and is performance oriented. The radix_cache.py changes are trivial formatting changes and do not concern performance, but the interpreter changes satisfy the requirement for a performance optimization by affecting a high-level API on a CPU. Hence, the commit meets the criteria for performance or optimization related changes.",
  "llm_api_reason": "The commit modifies the forking behavior to reduce overhead when forking with a count of one by adding an optional \u201ccopy\u201d flag. In the StreamExecutor class, the fork method signature now accepts an additional boolean parameter (copy). Similarly, the ProgramState.fork and its related copy method now pass this flag. These changes affect the high-level APIs used to fork or duplicate program states, while the radix cache change is a minor formatting update in an internal helper."
}