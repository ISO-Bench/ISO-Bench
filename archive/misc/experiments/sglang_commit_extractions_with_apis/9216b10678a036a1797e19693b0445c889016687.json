{
  "commit_hash": "9216b10678a036a1797e19693b0445c889016687",
  "pr_url": "https://github.com/sgl-project/sglang/pull/394",
  "pr_date": "2024-04-25",
  "timeline_text": "Copy link Collaborator hnyls2002 commented Apr 25, 2024 Why this PR? Before this PR, llm_judge benchmark with parallel=64 , latency=90.094 , cache_hit_rate = 24% After this PR, llm_judge benchmark with parallel=64 , latency=53.705s , cache_hit_rate = 74% What does this PR do? When the priority of the waiting queue is fixed, e.g. LPM (Longest Prefix Match), the SRT should only accept a prefix of the waiting queue. This is because we don't want the requests with lower priority to come into the prefill phase which will lead to the eviction of the previously cached prefix. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions fix: only accept a prefix of waiting queue 3c15fb9 hnyls2002 merged commit 9216b10 into main Apr 25, 2024 hnyls2002 deleted the fix-schedule branch April 25, 2024 09:29 timethink pushed a commit\n        to timethink/sglang\n      that referenced\n      this pull request Mar 9, 2025 Improve performance when running with full parallel ( sgl-project#394 ) b2617f1 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 19:01:05",
  "has_lm_eval": false,
  "has_performance": true,
  "has_serving": false,
  "has_general_test": false,
  "test_details": "PERF",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Improve performance when running with full parallel (#394)",
  "commit_message": "Improve performance when running with full parallel (#394)",
  "commit_date": "2024-04-25T17:29:07+08:00",
  "files_changed": [
    "python/sglang/srt/managers/router/model_rpc.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2024,
    "num_edited_lines": 4,
    "num_files": 1,
    "num_hunks": 2,
    "num_non_test_edited_lines": 4,
    "num_non_test_files": 1,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/managers/router/model_rpc.py b/python/sglang/srt/managers/router/model_rpc.py\nindex 883bb12f9..0ca46c854 100644\n--- a/python/sglang/srt/managers/router/model_rpc.py\n+++ b/python/sglang/srt/managers/router/model_rpc.py\n@@ -348,6 +348,7 @@ class ModelRpcServer:\n                     # Undo the insertion\n                     delta = self.tree_cache.dec_ref_counter(req.last_node)\n                     available_size += delta\n+                    break\n                 else:\n                     # Add this request to the running batch\n                     self.token_to_kv_pool.add_refs(req.prefix_indices)\n@@ -356,7 +357,8 @@ class ModelRpcServer:\n                         req.extend_input_len + req.max_new_tokens()\n                     )\n                     new_batch_input_tokens += req.extend_input_len\n-\n+            else:\n+                break\n         if len(can_run_list) == 0:\n             return None",
  "apis": [
    "sglang.srt.managers.router.Router"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/api.py",
    "/path/to/repos/sglang/sgl-router/py_src/sglang_router/router.py",
    "/path/to/repos/sglang/python/sglang/srt/layers/moe/router.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies a non-test file (python/sglang/srt/managers/router/model_rpc.py) and introduces a change in the control flow by adding an early break in the loop. The commit message \"Improve performance when running with full parallel\" indicates that the change was made to enhance performance, specifically in a common CPU scenario, and it affects the performance of a top-level functionality. The changes are non-trivial as they alter the behavior of request handling by breaking out of the loop under certain conditions, which is performance-relevant. Despite the commit message referencing performance explicitly, the changes align with performance optimization (and not just an optimization of a function named \"optimize\"). Therefore, the commit satisfies the conditions for a performance/optimization change.",
  "llm_api_reason": "The commit adds break statements inside the batch processing loop in ModelRpcServer (located in sglang/srt/managers/router/model_rpc.py) to improve performance under full parallel execution. Although ModelRpcServer itself is an internal part of the router manager, its change directly benefits the overall routing functionality exposed via the public and high-level router API. Thus, the performance improvement is felt through the public sglang.srt.managers.router.Router API."
}