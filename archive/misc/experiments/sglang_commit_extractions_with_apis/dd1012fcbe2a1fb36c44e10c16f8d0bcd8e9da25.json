{
  "commit_hash": "dd1012fcbe2a1fb36c44e10c16f8d0bcd8e9da25",
  "pr_url": "https://github.com/sgl-project/sglang/pull/6764",
  "pr_date": null,
  "timeline_text": "Copy link Collaborator ShangmingCai commented May 30, 2025 Motivation Use a set for the tracker instead of a list. Please check if this helps. @fzyzcjy Checklist Format your code according to the Code Formatting with Pre-Commit . Add unit tests as outlined in the Running Unit Tests . Update documentation / docstrings / example tutorials as needed, according to Writing Documentation . Provide throughput / latency benchmark results and accuracy evaluation results as needed, according to Benchmark and Profiling and Accuracy Results . For reviewers: If you haven't made any contributions to this PR and are only assisting with merging the main branch, please remove yourself as a co-author when merging the PR. Please feel free to join our Slack channel at https://slack.sglang.ai to discuss your PR. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [PD] Fix potential perf spike caused by tracker gc \u2026 a70d5fb Signed-off-by: Shangming Cai <caishangming@linux.alibaba.com> ShangmingCai requested review from hnyls2002 and ByronHsu as code owners May 30, 2025 06:51 gemini-code-assist bot reviewed May 30, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Hello @ShangmingCai , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! Summary of Changes Hello! Gemini here, providing a summary of this pull request. The primary goal of this PR, as indicated by the title and description, is to address a potential performance spike that might be caused by garbage collection related to a specific tracker. The proposed solution is to change the underlying data structure used for the addr_to_rooms_tracker from a Python list to a Python set. This modification is expected to improve the performance of operations involving this tracker, particularly lookups and removals. Highlights Data Structure Change : The core change involves replacing the defaultdict(list) used for self.addr_to_rooms_tracker with a defaultdict(set) . Performance Optimization : Switching from a list to a set is intended to mitigate potential performance issues, likely due to the more efficient average time complexity of set operations (O(1) for membership testing, add, and discard) compared to list operations (O(n) for membership testing and removal by value). Tracker Operation Updates : The code interacting with the tracker has been updated to use the appropriate set methods ( .add() instead of .append() , .discard() instead of .remove() ) and to handle iteration safely by copying the set before iterating in the cleanup logic. Changelog python/sglang/srt/disaggregation/mooncake/conn.py Changed the initialization of self.addr_to_rooms_tracker in ConnectionPool.__init__ from defaultdict(list) to defaultdict(set) (L194). Modified the heartbeat_checker method to iterate over a copy of the addr_to_rooms_tracker set and use the .discard() method for removing items, adapting the cleanup logic for the set data structure (L507-L515). Updated the BootstrapClient.__init__ method to use the .add() method instead of .append() when adding a room to the addr_to_rooms_tracker set (L882). Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with \ud83d\udc4d and \ud83d\udc4e on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . List becomes a set, Faster lookups, no more spikes, Code runs smooth and fast. Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . \u21a9 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot reviewed May 30, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request effectively addresses a potential performance bottleneck by changing addr_to_rooms_tracker from a defaultdict(list) to a defaultdict(set) . This is a solid improvement, as set operations for adding, removing, and checking membership are generally more performant (O(1) average) than their list counterparts (O(N) for removal/check). Key positive aspects of this change: Performance Enhancement : The switch to set should reduce the time complexity of managing tracked rooms, especially if the number of rooms per address can be large. Robustness : The use of current_rooms.copy() before iteration in heartbeat_checker correctly avoids RuntimeError from modifying a collection while iterating over it. Safe Removal : Changing list.remove() to set.discard() is a good defensive measure, as discard() does not raise an error if the item is not found, which can be beneficial in concurrent environments or if state changes unexpectedly. To further strengthen this PR, consider the following: Benchmarking : While the algorithmic benefit is clear, if the \"perf spike\" was significant or difficult to reproduce, adding a small benchmark or profiling result demonstrating the improvement could be valuable for confirmation. PR Checklist : Please consider filling out the checklist in the PR description, particularly regarding testing and documentation, if applicable, even for smaller changes. Overall, the code changes are clear, correct, and well-targeted to the problem described. Nice work! Summary of Findings Performance Improvement : The change from defaultdict(list) to defaultdict(set) for addr_to_rooms_tracker is a well-justified optimization. This will improve the performance of adding, removing, and checking for the existence of rooms in the tracker, especially for remove operations which go from O(N) to O(1) on average. Code Robustness : The use of .copy() when iterating over addr_to_rooms_tracker in the heartbeat_checker function and the switch from remove() to discard() for set elements are good practices that enhance the robustness of the code against potential runtime errors. Clarity : The updated comment in heartbeat_checker from \"Remove KVPoll.Success requests from the map\" to \"Remove KVPoll.Success requests from the tracker\" accurately reflects the nature of the data structure. Merge Readiness The changes in this pull request are well-implemented and address the stated performance concern effectively. From a code correctness and improvement perspective, this PR looks good to merge. While I am not authorized to approve pull requests, I would recommend considering the addition of benchmarks if the performance issue was critical or hard to reproduce, and completing the PR checklist. Other reviewers should perform a final check before merging. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions ShangmingCai added 2 commits May 30, 2025 17:05 Merge branch 'main' into fix_tracker_gc 721c189 fix doc \u2026 f6a7d8a Signed-off-by: Shangming Cai <caishangming@linux.alibaba.com> ShangmingCai requested a review\n  from zhaochenyang20 as a code owner May 30, 2025 09:22 ShangmingCai changed the title [PD] Fix potential perf spike caused by tracker gc [PD] Fix potential perf spike caused by tracker gc and optimize doc May 30, 2025 Merge branch 'main' into fix_tracker_gc 6f00742 ShangmingCai enabled auto-merge (squash) June 3, 2025 12:29 ByronHsu approved these changes Jun 5, 2025 View reviewed changes zhyncs disabled auto-merge June 5, 2025 17:55 Hide details View details zhyncs merged commit dd1012f into sgl-project : main Jun 5, 2025 103 of 115 checks passed Uh oh! There was an error while loading. Please reload this page . jianan-gu pushed a commit\n        to jianan-gu/sglang\n      that referenced\n      this pull request Jun 12, 2025 [PD] Fix potential perf spike caused by tracker gc and optimize doc ( s\u2026 \u2026 71e84cd \u2026gl-project#6764 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com> xwu-intel pushed a commit\n        to xwu-intel/sglang\n      that referenced\n      this pull request Jun 17, 2025 [PD] Fix potential perf spike caused by tracker gc and optimize doc ( s\u2026 \u2026 438062c \u2026gl-project#6764 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com> walker-ai pushed a commit\n        to walker-ai/sglang\n      that referenced\n      this pull request Jul 8, 2025 PullRequest: 52 sgl_20250610_sync_tag047 \u2026 a19e2e2 Merge branch 'sgl_20250610_sync_tag047 of git@code.alipay.com:Theta/SGLang.git into main https://code.alipay.com/Theta/SGLang/pull_requests/52 Reviewed-by: \u5251\u5ddd <jianchuan.gys@antgroup.com>\n\n\n* [Bugfix] Fix slice operation when chunk size mismatch ( sgl-project#6697 )\n* [Bugfix] Fix ChatCompletion endpoint of mini_lb when stream is set ( sgl-project#6703 )\n* [CI] Fix setup of disaggregation with different tp ( sgl-project#6706 )\n* [PD] Remove Unnecessary Exception Handling for FastQueue.get() ( sgl-project#6712 )\n* Fuse routed_scaling_factor in DeepSeek ( sgl-project#6710 )\n* Overlap two kernels in DeepSeek with communication ( sgl-project#6711 )\n* Minor refactor two-batch overlap ( sgl-project#6682 )\n* Speed up when having padding tokens two-batch overlap ( sgl-project#6668 )\n* [Feature] Support Flashinfer fp8 blockwise GEMM kernel on Blackwell ( sgl-project#6479 )\n* Fix LoRA bench ( sgl-project#6719 )\n* temp\n* Fix PP for Qwen3 MoE ( sgl-project#6709 )\n* [feat] triton kernel for get_last_loc ( sgl-project#6676 )\n* [fix] more mem for draft_extend cuda_graph ( sgl-project#6726 )\n* [PD] bug fix:  Update status if nixl receiver send a a dummy req. ( sgl-project#6720 )\n* Tune memory arguments on B200 ( sgl-project#6718 )\n* Add DeepSeek-R1-0528 function call chat template ( sgl-project#6725 )\n* refactor(tool call): Fix BaseFormatDetector tool_index issue and refactor `parse_streaming_increment` ( sgl-project#6715 )\n* Add draft extend CUDA graph for Triton backend ( sgl-project#6705 )\n* refactor apply_w8a8_block_fp8_linear in fp ( sgl-project#6545 )\n* [PD] Support completion endpoint ( sgl-project#6729 )\n* PD Rust LB (PO2) ( sgl-project#6437 )\n* Super tiny enable sole usage of expert distribution metrics and update doc ( sgl-project#6680 )\n* Support picking variants\u00a0of EPLB algorithms ( sgl-project#6728 )\n* Support tuning DeepEP configs ( sgl-project#6742 )\n* [test] add ut and bm for get_last_loc ( sgl-project#6746 )\n* Fix mem_fraction_static for AMD CI ( sgl-project#6748 )\n* [fix][RL] Fix DeepSeekV3ForCausalLM.post_load_weights for multiple update weight ( sgl-project#6265 )\n* Improve EPLB logical to physical dispatch map ( sgl-project#6727 )\n* Update DeepSeek-R1-0528 function call chat template ( sgl-project#6765 )\n* [PD] Optimize time out logic and add env var doc for mooncake ( sgl-project#6761 )\n* Fix aiohttp 'Chunk too big' in bench_serving ( sgl-project#6737 )\n* Support sliding window in triton backend ( sgl-project#6509 )\n* Fix shared experts fusion error ( sgl-project#6289 )\n* Fix one bug in the grouped-gemm triton kernel ( sgl-project#6772 )\n* update llama4 chat template and pythonic parser ( sgl-project#6679 )\n* feat(tool call): Enhance Llama32Detector for improved JSON parsing in non-stream ( sgl-project#6784 )\n* Support token-level quantization for EP MoE ( sgl-project#6782 )\n* Temporarily lower mmlu threshold for triton sliding window backend ( sgl-project#6785 )\n* ci: relax test_function_call_required ( sgl-project#6786 )\n* Add intel_amx backend for Radix Attention for CPU ( sgl-project#6408 )\n* Fix incorrect LoRA weight loading for fused gate_up_proj ( sgl-project#6734 )\n* fix(PD-disaggregation): Can not get local ip ( sgl-project#6792 )\n* [FIX] mmmu bench serving result display error ( sgl-project#6525 ) ( sgl-project#6791 )\n* Bump torch to 2.7.0 ( sgl-project#6788 )\n* chore: bump sgl-kernel v0.1.5 ( sgl-project#6794 )\n* Improve profiler and integrate profiler in bench_one_batch_server ( sgl-project#6787 )\n* chore: upgrade sgl-kernel v0.1.5 ( sgl-project#6795 )\n* [Minor] Always append newline after image token when parsing chat message ( sgl-project#6797 )\n* Update CI tests for Llama4 models ( sgl-project#6421 )\n* [Feat] Enable PDL automatically on Hopper architecture ( sgl-project#5981 )\n* chore: update blackwell docker ( sgl-project#6800 )\n* misc: cache is_hopper_arch ( sgl-project#6799 )\n* Remove contiguous before Flashinfer groupwise fp8 gemm ( sgl-project#6804 )\n* Correctly abort the failed grammar requests & Improve the handling of abort ( sgl-project#6803 )\n* [EP] Add cuda kernel for moe_ep_pre_reorder ( sgl-project#6699 )\n* Add draft extend CUDA graph for flashinfer backend  ( sgl-project#6805 )\n* Refactor CustomOp to avoid confusing bugs ( sgl-project#5382 )\n* Tiny log prefill time ( sgl-project#6780 )\n* Tiny fix EPLB assertion about rebalancing period and recorder window size ( sgl-project#6813 )\n* Add simple utility to dump tensors for debugging ( sgl-project#6815 )\n* Fix profiles do not have consistent names ( sgl-project#6811 )\n* Speed up rebalancing when using non-static dispatch algorithms ( sgl-project#6812 )\n* [1/2] Add Kernel support for Cutlass based Fused FP4 MoE ( sgl-project#6093 )\n* [Router] Fix k8s Service Discovery ( sgl-project#6766 )\n* Add CPU optimized kernels for topk and rope fusions  ( sgl-project#6456 )\n* fix new_page_count_next_decode ( sgl-project#6671 )\n* Fix wrong weight reference in dynamic EPLB ( sgl-project#6818 )\n* Minor add metrics to expert location updater ( sgl-project#6816 )\n* [Refactor] Rename `n_share_experts_fusion` as `num_fused_shared_experts` ( sgl-project#6735 )\n* [FEAT] Add transformers backend support  ( sgl-project#5929 )\n* [fix] recover auto-dispatch for rmsnorm and rope ( sgl-project#6745 )\n* fix ep_moe_reorder kernel bugs ( sgl-project#6858 )\n* [Refactor] Multimodal data processing for VLM ( sgl-project#6659 )\n* Decoder-only Scoring API ( sgl-project#6460 )\n* feat: add dp-rank to KV events ( sgl-project#6852 )\n* Set `num_fused_shared_experts` as `num_shared_experts` when shared_experts fusion is not disabled ( sgl-project#6736 )\n* Fix one missing arg in DeepEP ( sgl-project#6878 )\n* Support LoRA in TestOpenAIVisionServer and fix fused kv_proj loading bug. ( sgl-project#6861 )\n* support 1 shot allreduce  in 1-node and 2-node using mscclpp ( sgl-project#6277 )\n* Fix Qwen3MoE missing token padding optimization ( sgl-project#6820 )\n* Tiny update error hints ( sgl-project#6846 )\n* Support layerwise rebalancing experts ( sgl-project#6851 )\n* Tiny allow profiler API to auto create directory ( sgl-project#6865 )\n* Support Blackwell DeepEP docker images ( sgl-project#6868 )\n* [EP] Add cuda kernel for moe_ep_post_reorder ( sgl-project#6837 )\n* [theta]merge 0605\n* oai: fix openAI client error with single request via batch api ( sgl-project#6170 )\n* [PD] Fix potential perf spike caused by tracker gc and optimize doc ( sgl-project#6764 )\n* Use deepgemm instead of triton for fused_qkv_a_proj_with_mqa ( sgl-project#6890 )\n* [CUTLASS-FP4-MOE]  Introduce CutlassMoEParams class for easy initialization of Cutlass Grouped Gems Metadata ( sgl-project#6887 )\n* bugfix(OAI): Fix image_data processing for jinja chat templates ( sgl-project#6877 )\n* [CPU] enable CI for PRs, add Dockerfile and auto build task ( sgl-project#6458 )\n* AITER backend extension and workload optimizations ( sgl-project#6838 )\n* [theta]merge\n* [theta]merge\n* [Feature] Support Flashinfer fmha on Blackwell ( sgl-project#6930 )\n* Fix a bug in abort & Improve docstrings for abort ( sgl-project#6931 )\n* Tiny support customize DeepEP max dispatch tokens per rank ( sgl-project#6934 )\n* Sync the changes on cuda graph runners ( sgl-project#6932 )\n* [PD] Optimize transfer queue forward logic for dummy rank ( sgl-project#6922 )\n* [Refactor] image data process in bench_serving ( sgl-project#6879 )\n* [fix] logical_to_all_physical_map index 256 is out of bounds in EP parallel. ( sgl-project#6767 )\n* Add triton fused moe kernel config for E=257 on B200 ( sgl-project#6939 )\n* [sgl-kernel] update deepgemm ( sgl-project#6942 )\n* chore: bump sgl-kernel v0.1.6 ( sgl-project#6943 )\n* Minor compile fused topk ( sgl-project#6944 )\n* [Bugfix] pipeline parallelism and Eagle Qwen2 ( sgl-project#6910 )\n* Tiny re-introduce profile id logging ( sgl-project#6912 )\n* Add triton version as a fused_moe_triton config search key to avoid performace decrease in different Triton version ( sgl-project#5955 )\n* reduce torch.zeros overhead in moe align block size kernel ( sgl-project#6369 )\n* chore: upgrade sgl-kernel v0.1.6 ( sgl-project#6945 )\n* add fbgemm moe grouped gemm kernel benchmark ( sgl-project#6924 )\n* [Docker] Add docker file for SGL Router ( sgl-project#6915 )\n* Disabling mixed chunked prefill when eagle is enabled ( sgl-project#6874 )\n* Add canary for EPLB rebalancing ( sgl-project#6895 )\n* Refactor global_server_args_dict ( sgl-project#6866 )\n* Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\n* Update server timeout time in AMD CI. ( sgl-project#6953 )\n* [misc] add is_cpu() ( sgl-project#6950 )\n* Add H20 fused MoE kernel tuning configs for DeepSeek-R1/V3 ( sgl-project#6885 )\n* Add a CUDA kernel for fusing mapping and weighted sum for MoE. ( sgl-project#6916 )\n* chore: bump sgl-kernel v0.1.6.post1 ( sgl-project#6955 )\n* chore: upgrade sgl-kernel v0.1.6.post1 ( sgl-project#6957 )\n* [DeepseekR1-FP4] Add Support for nvidia/DeepSeekR1-FP4 model ( sgl-project#6853 )\n* Revert \"Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\" ( sgl-project#6968 )\n* [AMD] Add more tests to per-commit-amd ( sgl-project#6926 )\n* chore: bump sgl-kernel v0.1.7 ( sgl-project#6963 )\n* Slightly improve the sampler to skip unnecessary steps ( sgl-project#6956 )\n* rebase h20 fused_moe config ( sgl-project#6966 )\n* Fix CI and triton moe Configs ( sgl-project#6974 )\n* Remove unnecessary kernels of num_token_non_padded ( sgl-project#6965 )\n* Extend cuda graph capture bs for B200 ( sgl-project#6937 )\n* Fuse routed scaling factor in deepseek ( sgl-project#6970 )\n* Sync cuda graph runners ( sgl-project#6976 )\n* Fix draft extend ut stability with flush cache ( sgl-project#6979 )\n* Fix triton sliding window test case ( sgl-project#6981 )\n* Fix expert distribution dumping causes OOM ( sgl-project#6967 )\n* Minor remove one kernel for DeepSeek ( sgl-project#6977 )\n* [perf][sgl-kernel] extend cutlass_mla_decode to support num_head < 128 ( sgl-project#6929 )\n* Enable more unit tests for AMD CI. ( sgl-project#6983 )\n* Use torch.compile to fuse flash attention decode metadata preparation ( sgl-project#6973 )\n* Eliminate stream sync to speed up LoRA batch init  ( sgl-project#6960 )\n* support qwen3 emebedding ( sgl-project#6990 )\n* Fix torch profiler bugs for bench_offline_throughput.py ( sgl-project#6557 )\n* chore: upgrade flashinfer v0.2.6.post1 jit ( sgl-project#6958 )\n* cleanup tmp dir ( sgl-project#7007 )\n* chore: update pr test xeon ( sgl-project#7008 )\n* Fix cutlass MLA gets almost zero accuracy ( sgl-project#6998 )\n* Update amd nightly models CI. ( sgl-project#6992 )\n* feat: add direct routing strategy to DP worker ( sgl-project#6884 )\n* Fallback to lower triton version for unfound fused moe configs ( sgl-project#7013 )\n* Fix torchvision version for Blackwell ( sgl-project#7015 )\n* Simplify prepare_extend_after_decode ( sgl-project#6987 )\n* Migrate to assertEqual ( sgl-project#6741 )\n* Fix torch version in blackwell dockerfile ( sgl-project#7017 )\n* chore: update pr test xeon ( sgl-project#7018 )\n* Update default settings for blackwell ( sgl-project#7023 )\n* Support both approximate and exact expert distribution collection ( sgl-project#6964 )\n* Add decode req pool ( sgl-project#6980 )\n* [theta]merge 0610\n* [theta]merge 0610\n* [CI] Add CI workflow for sgl-router docker build ( sgl-project#7027 )\n* Fix fused_moe triton configs ( sgl-project#7029 )\n* CPU: map changes from developing branch in sgl-kernel ( sgl-project#6833 )\n* chore: bump v0.4.7 ( sgl-project#7038 )\n* Update README.md ( sgl-project#7040 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 18:56:57",
  "has_lm_eval": true,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "LM_EVAL | PERF | SERVING | TEST",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "[PD] Fix potential perf spike caused by tracker gc and optimize doc (#6764)",
  "commit_message": "[PD] Fix potential perf spike caused by tracker gc and optimize doc (#6764)\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>",
  "commit_date": "2025-06-05T10:56:02-07:00",
  "files_changed": [
    "docs/backend/pd_disaggregation.md",
    "python/sglang/srt/disaggregation/mooncake/conn.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2025,
    "num_edited_lines": 20,
    "num_files": 2,
    "num_hunks": 4,
    "num_non_test_edited_lines": 20,
    "num_non_test_files": 2,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/docs/backend/pd_disaggregation.md b/docs/backend/pd_disaggregation.md\nindex 9dbc2705d..833f0b3f9 100644\n--- a/docs/backend/pd_disaggregation.md\n+++ b/docs/backend/pd_disaggregation.md\n@@ -54,8 +54,8 @@ PD Disaggregation with Mooncake supports the following environment variables for\n #### Prefill Server Configuration\n | Variable | Description | Default |\n |:--------:|:-----------:|:--------:\n-| **`SGLANG_DISAGGREGATION_THREAD_POOL_SIZE`** | Controls the total number of worker threads for KV transfer operations per TP rank | A dynamic value calculated by `int(0.75 * os.cpu_count()) // 8)`, which is limited to be larger than 4 and less than 12 to ensure efficiency and prevent thread race conditions |\n-| **`SGLANG_DISAGGREGATION_QUEUE_SIZE`** | Sets the maximum pending tasks in the parallel transfer queue | `4` |\n+| **`SGLANG_DISAGGREGATION_THREAD_POOL_SIZE`** | Controls the total number of worker threads for KVCache transfer operations per TP rank | A dynamic value calculated by `int(0.75 * os.cpu_count()) // 8)`, which is limited to be larger than 4 and less than 12 to ensure efficiency and prevent thread race conditions |\n+| **`SGLANG_DISAGGREGATION_QUEUE_SIZE`** | Sets the number of parallel transfer queues. KVCache transfer requests from multiple decode instances will be sharded into these queues so that they can share the threads and the transfer bandwidth at the same time. If it is set to `1`, then we transfer requests one by one according to fcfs strategy | `4` |\n | **`SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT`** | Timeout (seconds) for receiving destination KV indices during request initialization | `30` |\n \n #### Decode Server Configuration\ndiff --git a/python/sglang/srt/disaggregation/mooncake/conn.py b/python/sglang/srt/disaggregation/mooncake/conn.py\nindex 940a25d74..824f76709 100644\n--- a/python/sglang/srt/disaggregation/mooncake/conn.py\n+++ b/python/sglang/srt/disaggregation/mooncake/conn.py\n@@ -191,7 +191,7 @@ class MooncakeKVManager(BaseKVManager):\n             self.heartbeat_failures = {}\n             self.session_pool = defaultdict(requests.Session)\n             self.session_pool_lock = threading.Lock()\n-            self.addr_to_rooms_tracker = defaultdict(list)\n+            self.addr_to_rooms_tracker = defaultdict(set)\n             self.connection_lock = threading.Lock()\n             # Heartbeat interval should be at least 2 seconds\n             self.heartbeat_interval = max(\n@@ -504,12 +504,14 @@ class MooncakeKVManager(BaseKVManager):\n                         if response.status_code == 200:\n                             self.heartbeat_failures[bootstrap_addr] = 0\n \n-                            for bootstrap_room in self.addr_to_rooms_tracker[\n+                            current_rooms = self.addr_to_rooms_tracker[\n                                 bootstrap_addr\n-                            ]:\n-                                # Remove KVPoll.Success requests from the map\n+                            ].copy()\n+\n+                            for bootstrap_room in current_rooms:\n+                                # Remove KVPoll.Success requests from the tracker\n                                 if bootstrap_room not in self.request_status:\n-                                    self.addr_to_rooms_tracker[bootstrap_addr].remove(\n+                                    self.addr_to_rooms_tracker[bootstrap_addr].discard(\n                                         bootstrap_room\n                                     )\n                         else:\n@@ -879,9 +881,7 @@ class MooncakeKVReceiver(BaseKVReceiver):\n             self.bootstrap_infos = self.kv_mgr.connection_pool[bootstrap_key]\n \n         assert len(self.bootstrap_infos) > 0\n-        self.kv_mgr.addr_to_rooms_tracker[self.bootstrap_addr].append(\n-            self.bootstrap_room\n-        )\n+        self.kv_mgr.addr_to_rooms_tracker[self.bootstrap_addr].add(self.bootstrap_room)\n         self.kv_mgr.update_status(self.bootstrap_room, KVPoll.WaitingForInput)\n \n     def _get_bootstrap_info_from_server(self, engine_rank, target_dp_group):",
  "apis": [
    "MooncakeKVManager",
    "MooncakeKVReceiver"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/nixl/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/mooncake/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/ascend/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/common/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/fake/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/base/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/mooncake/transfer_engine.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/ascend/transfer_engine.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies a source code file (python/sglang/srt/disaggregation/mooncake/conn.py), changing how tracker data is maintained by replacing a list with a set and using discard instead of remove. This is not merely a documentation update\u2014the change modifies internal data structure handling which is intended to prevent potential performance spikes due to tracker garbage collection. The commit message also hints at performance optimization. The changes impact a core component that handles connections and heartbeat responses in a CPU-relevant context. Therefore, it satisfies the conditions for a performance optimization change.",
  "llm_api_reason": "The commit updates the PD Disaggregation documentation to clarify the meaning of the environment variables and changes the internal tracking mechanism in the Mooncake disaggregation module. In particular, it converts the tracker structure from a list to a set in MooncakeKVManager (using set.discard instead of list.remove) and adjusts MooncakeKVReceiver to use set.add rather than list.append. These changes optimize the tracker garbage collection and reduce potential performance spikes during KV cache transfers. The modifications affect the internal Python APIs that handle disaggregation transfers in the Mooncake backend."
}