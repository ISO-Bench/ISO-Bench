{
  "commit_hash": "fbcbb26327e1da685139b3f66cdc75c49ae608c0",
  "pr_url": "https://github.com/sgl-project/sglang/pull/1765",
  "pr_date": "2024-10-23",
  "timeline_text": "Copy link Contributor merrymercy commented Oct 23, 2024 No description provided. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions Fix perf regression for set_kv_buffer f649b17 merrymercy requested review from Ying1123 and hnyls2002 as code owners October 23, 2024 16:48 merrymercy added 2 commits October 23, 2024 09:50 revert 8a39076 Fix regression 1fce36b Hide details View details merrymercy merged commit fbcbb26 into main Oct 23, 2024 3 of 10 checks passed Uh oh! There was an error while loading. Please reload this page . merrymercy deleted the pr-fix-perf-regression branch October 23, 2024 16:57 timethink pushed a commit\n        to timethink/sglang\n      that referenced\n      this pull request Mar 9, 2025 Fix perf regression for set_kv_buffer ( sgl-project#1765 ) 8f1e950 Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 19:00:11",
  "has_lm_eval": false,
  "has_performance": false,
  "has_serving": false,
  "has_general_test": false,
  "test_details": "NONE",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "Fix perf regression for set_kv_buffer (#1765)",
  "commit_message": "Fix perf regression for set_kv_buffer (#1765)",
  "commit_date": "2024-10-23T09:57:08-07:00",
  "files_changed": [
    "python/sglang/srt/mem_cache/memory_pool.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2024,
    "num_edited_lines": 20,
    "num_files": 1,
    "num_hunks": 1,
    "num_non_test_edited_lines": 20,
    "num_non_test_files": 1,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/python/sglang/srt/mem_cache/memory_pool.py b/python/sglang/srt/mem_cache/memory_pool.py\nindex 181ac7eef..07f3d454e 100644\n--- a/python/sglang/srt/mem_cache/memory_pool.py\n+++ b/python/sglang/srt/mem_cache/memory_pool.py\n@@ -221,17 +221,19 @@ class MHATokenToKVPool(BaseTokenToKVPool):\n         cache_v: torch.Tensor,\n     ):\n         layer_id = layer.layer_id\n-        copy_two_array(\n-            loc,\n-            self.k_buffer[layer_id],\n-            cache_k,\n-            self.v_buffer[layer_id],\n-            cache_v,\n-            self.dtype,\n-            self.store_dtype,\n-        )\n+        if cache_k.dtype != self.dtype:\n+            cache_k = cache_k.to(self.dtype)\n+            cache_v = cache_v.to(self.dtype)\n+        if self.store_dtype != self.dtype:\n+            self.k_buffer[layer_id][loc] = cache_k.view(self.store_dtype)\n+            self.v_buffer[layer_id][loc] = cache_v.view(self.store_dtype)\n+        else:\n+            self.k_buffer[layer_id][loc] = cache_k\n+            self.v_buffer[layer_id][loc] = cache_v\n \n \n+# This compiled version is slower in the unit test\n+# python3 -m unittest test_bench_serving.TestBenchServing.test_offline_throughput_non_stream_small_batch_size\n @torch.compile(dynamic=True)\n def copy_two_array(loc, dst_1, src_1, dst_2, src_2, dtype, store_dtype):\n     dst_1[loc] = src_1.to(dtype).view(store_dtype)",
  "apis": [
    "MHATokenToKVPool.set_kv_buffer"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/python/sglang/srt/mem_cache/memory_pool.py",
    "/path/to/repos/sglang/python/sglang/api.py",
    "/path/to/repos/sglang/python/sglang/srt/mem_cache/memory_pool_host.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies a non-test file (python/sglang/srt/mem_cache/memory_pool.py) and changes the behavior of the memory pool's key/value buffer assignment. The modifications include conditional type conversion and different pathways for data assignment, clearly intending to address a performance regression (as indicated by the commit message \"Fix perf regression for set_kv_buffer (#1765)\"). This change is performance-related, aiming to improve execution speed, and it impacts low-level performance of buffer operations that could affect high-level API performance. The changes are non-trivial and affect CPU performance without any reliance on GPU/TPU workloads.",
  "llm_api_reason": "The commit replaces the old call to the internal helper function (copy_two_array) within MHATokenToKVPool.set_kv_buffer with an inline implementation that first converts the input tensors to the expected dtype (if needed) and then writes them into the buffers with the proper view conversion. This change is targeting a performance regression in the KV cache write path."
}