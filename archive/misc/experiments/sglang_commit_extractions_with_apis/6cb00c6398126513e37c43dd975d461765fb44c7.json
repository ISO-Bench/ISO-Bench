{
  "commit_hash": "6cb00c6398126513e37c43dd975d461765fb44c7",
  "pr_url": "https://github.com/sgl-project/sglang/pull/6761",
  "pr_date": "2025-05-30",
  "timeline_text": "Copy link Collaborator ShangmingCai commented May 30, 2025 Motivation Move the init time logic of KVSender from __init__ to init to optimize timeout logic. Add docs for current env vars Modifications Checklist Format your code according to the Code Formatting with Pre-Commit . Add unit tests as outlined in the Running Unit Tests . Update documentation / docstrings / example tutorials as needed, according to Writing Documentation . Provide throughput / latency benchmark results and accuracy evaluation results as needed, according to Benchmark and Profiling and Accuracy Results . For reviewers: If you haven't made any contributions to this PR and are only assisting with merging the main branch, please remove yourself as a co-author when merging the PR. Please feel free to join our Slack channel at https://slack.sglang.ai to discuss your PR. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions [PD] Optimize time out logic and add env var doc for mooncake \u2026 de7de54 Signed-off-by: Shangming Cai <caishangming@linux.alibaba.com> ShangmingCai requested review from hnyls2002 , ByronHsu and zhaochenyang20 as code owners May 30, 2025 05:05 gemini-code-assist bot reviewed May 30, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Hello @ShangmingCai , I'm Gemini Code Assist 1 ! I'm currently reviewing this pull request and will post my feedback shortly. In the meantime, here's a summary to help you and other reviewers quickly get up to speed! Summary of Changes Hello! Gemini here, providing a summary of this pull request. This PR addresses two main areas related to the Mooncake disaggregation mode: optimizing the timeout logic for KV transfer bootstrapping and adding documentation for relevant environment variables. The timeout optimization involves moving the timestamp initialization for tracking bootstrap duration from the __init__ method to the init method of the KVSender class. This ensures that the timeout period correctly starts only after the initialization process begins, rather than when the object is merely created. Additionally, the PR introduces a new section in the documentation detailing environment variables that allow for fine-grained control over Prefill and Decode server configurations in the Mooncake setup. Highlights Environment Variable Documentation : New documentation has been added for environment variables specific to the Mooncake PD Disaggregation setup. This includes variables for configuring thread pool size, queue size, bootstrap timeout, heartbeat interval, and maximum heartbeat failures for both Prefill and Decode servers. Changelog docs/backend/pd_disaggregation.md Added a new 'Advanced Configuration' section under 'PD Disaggregation with Mooncake'. Included tables listing environment variables for 'Prefill Server Configuration' and 'Decode Server Configuration', detailing their purpose and default values. python/sglang/srt/disaggregation/mooncake/conn.py Moved the initialization of self.init_time from the __init__ method (line 680 before) to the init method (line 688 after) in the KVSender class. Initialized self.init_time to None in the __init__ method (line 681 after). Added a check if self.init_time is not None: before calculating the elapsed time and checking for timeout in the poll method (line 717 after). Using Gemini Code Assist The full guide for Gemini Code Assist can be found on our documentation page , here are some quick tips. Invoking Gemini You can request assistance from Gemini at any point in your pull request via creating an issue comment (i.e. comment on the pull request page) using either /gemini <command> or @gemini-code-assist <command> . Below is a summary of the supported commands. Feature Command Description Code Review /gemini review Performs a code review for the current pull request in its current state. Pull Request Summary /gemini summary Provides a summary of the current pull request in its current state. Comment @gemini-code-assist Responds in comments when explicitly tagged, both in issue comments and review comments. Help /gemini help Displays a list of available commands. Customization To customize Gemini Code Assist for GitHub experience, repository maintainers can create a configuration file and/or provide a custom code review style guide (such as PEP-8 for Python) by creating and adding files to a .gemini/ folder in the base of the repository. Detailed instructions can be found here . Limitations & Feedback Gemini Code Assist is currently in preview and may make mistakes. Please leave feedback on any instances where its feedback is incorrect or counter productive. You can react with \ud83d\udc4d and \ud83d\udc4e on @gemini-code-assist comments to provide feedback. You can also get AI-powered code generation, chat, as well as code reviews directly in the IDE at no cost with the Gemini Code Assist IDE Extension . Timeouts can be tricky, Start the clock when work begins, Docs show the knobs. Footnotes Review the Privacy Notices , Generative AI Prohibited Use Policy , Terms of Service , and learn how to configure Gemini Code Assist in GitHub here . Gemini can make mistakes, so double check it and use code with caution . \u21a9 Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions gemini-code-assist bot suggested changes May 30, 2025 View reviewed changes Copy link Contributor gemini-code-assist bot left a comment There was a problem hiding this comment. Choose a reason for hiding this comment The reason will be displayed to describe this comment to others. Learn more . Choose a reason Spam Abuse Off Topic Outdated Duplicate Resolved Hide comment Code Review This pull request optimizes the timeout logic for KVSender and adds documentation for environment variables related to Mooncake PD Disaggregation. The code changes for the timeout logic are well-structured, and the documentation additions are helpful. A minor discrepancy was identified in the documented default value for an environment variable compared to its implementation in the code. Summary of Findings Documentation Accuracy : The default value for the SGLANG_DISAGGREGATION_THREAD_POOL_SIZE environment variable in the documentation does not fully match the calculation logic (including min/max clamping) found in the codebase. A review comment was added to highlight this discrepancy. Merge Readiness The pull request makes good progress in optimizing timeout logic and improving documentation. However, a medium-severity issue regarding the accuracy of a documented default value for an environment variable should be addressed before merging. Once the documentation is updated to accurately reflect the code's behavior, this PR should be in good shape. I am unable to directly approve pull requests, so please ensure other necessary reviews and approvals are obtained. Sorry, something went wrong. Uh oh! There was an error while loading. Please reload this page . All reactions docs/backend/pd_disaggregation.md Outdated Show resolved Hide resolved Uh oh! There was an error while loading. Please reload this page . update doc \u2026 4cf26f4 Signed-off-by: Shangming Cai <caishangming@linux.alibaba.com> zhyncs approved these changes May 30, 2025 View reviewed changes Hide details View details zhyncs merged commit 6cb00c6 into sgl-project : main May 30, 2025 48 of 57 checks passed Uh oh! There was an error while loading. Please reload this page . Layssy pushed a commit\n        to Layssy/sglang-iaas\n      that referenced\n      this pull request Jun 9, 2025 [PD] Optimize time out logic and add env var doc for mooncake ( sgl-pr\u2026 \u2026 36392d9 \u2026oject#6761 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com> xwu-intel pushed a commit\n        to xwu-intel/sglang\n      that referenced\n      this pull request Jun 17, 2025 [PD] Optimize time out logic and add env var doc for mooncake ( sgl-pr\u2026 \u2026 6709042 \u2026oject#6761 )\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com> walker-ai pushed a commit\n        to walker-ai/sglang\n      that referenced\n      this pull request Jul 8, 2025 PullRequest: 52 sgl_20250610_sync_tag047 \u2026 a19e2e2 Merge branch 'sgl_20250610_sync_tag047 of git@code.alipay.com:Theta/SGLang.git into main https://code.alipay.com/Theta/SGLang/pull_requests/52 Reviewed-by: \u5251\u5ddd <jianchuan.gys@antgroup.com>\n\n\n* [Bugfix] Fix slice operation when chunk size mismatch ( sgl-project#6697 )\n* [Bugfix] Fix ChatCompletion endpoint of mini_lb when stream is set ( sgl-project#6703 )\n* [CI] Fix setup of disaggregation with different tp ( sgl-project#6706 )\n* [PD] Remove Unnecessary Exception Handling for FastQueue.get() ( sgl-project#6712 )\n* Fuse routed_scaling_factor in DeepSeek ( sgl-project#6710 )\n* Overlap two kernels in DeepSeek with communication ( sgl-project#6711 )\n* Minor refactor two-batch overlap ( sgl-project#6682 )\n* Speed up when having padding tokens two-batch overlap ( sgl-project#6668 )\n* [Feature] Support Flashinfer fp8 blockwise GEMM kernel on Blackwell ( sgl-project#6479 )\n* Fix LoRA bench ( sgl-project#6719 )\n* temp\n* Fix PP for Qwen3 MoE ( sgl-project#6709 )\n* [feat] triton kernel for get_last_loc ( sgl-project#6676 )\n* [fix] more mem for draft_extend cuda_graph ( sgl-project#6726 )\n* [PD] bug fix:  Update status if nixl receiver send a a dummy req. ( sgl-project#6720 )\n* Tune memory arguments on B200 ( sgl-project#6718 )\n* Add DeepSeek-R1-0528 function call chat template ( sgl-project#6725 )\n* refactor(tool call): Fix BaseFormatDetector tool_index issue and refactor `parse_streaming_increment` ( sgl-project#6715 )\n* Add draft extend CUDA graph for Triton backend ( sgl-project#6705 )\n* refactor apply_w8a8_block_fp8_linear in fp ( sgl-project#6545 )\n* [PD] Support completion endpoint ( sgl-project#6729 )\n* PD Rust LB (PO2) ( sgl-project#6437 )\n* Super tiny enable sole usage of expert distribution metrics and update doc ( sgl-project#6680 )\n* Support picking variants\u00a0of EPLB algorithms ( sgl-project#6728 )\n* Support tuning DeepEP configs ( sgl-project#6742 )\n* [test] add ut and bm for get_last_loc ( sgl-project#6746 )\n* Fix mem_fraction_static for AMD CI ( sgl-project#6748 )\n* [fix][RL] Fix DeepSeekV3ForCausalLM.post_load_weights for multiple update weight ( sgl-project#6265 )\n* Improve EPLB logical to physical dispatch map ( sgl-project#6727 )\n* Update DeepSeek-R1-0528 function call chat template ( sgl-project#6765 )\n* [PD] Optimize time out logic and add env var doc for mooncake ( sgl-project#6761 )\n* Fix aiohttp 'Chunk too big' in bench_serving ( sgl-project#6737 )\n* Support sliding window in triton backend ( sgl-project#6509 )\n* Fix shared experts fusion error ( sgl-project#6289 )\n* Fix one bug in the grouped-gemm triton kernel ( sgl-project#6772 )\n* update llama4 chat template and pythonic parser ( sgl-project#6679 )\n* feat(tool call): Enhance Llama32Detector for improved JSON parsing in non-stream ( sgl-project#6784 )\n* Support token-level quantization for EP MoE ( sgl-project#6782 )\n* Temporarily lower mmlu threshold for triton sliding window backend ( sgl-project#6785 )\n* ci: relax test_function_call_required ( sgl-project#6786 )\n* Add intel_amx backend for Radix Attention for CPU ( sgl-project#6408 )\n* Fix incorrect LoRA weight loading for fused gate_up_proj ( sgl-project#6734 )\n* fix(PD-disaggregation): Can not get local ip ( sgl-project#6792 )\n* [FIX] mmmu bench serving result display error ( sgl-project#6525 ) ( sgl-project#6791 )\n* Bump torch to 2.7.0 ( sgl-project#6788 )\n* chore: bump sgl-kernel v0.1.5 ( sgl-project#6794 )\n* Improve profiler and integrate profiler in bench_one_batch_server ( sgl-project#6787 )\n* chore: upgrade sgl-kernel v0.1.5 ( sgl-project#6795 )\n* [Minor] Always append newline after image token when parsing chat message ( sgl-project#6797 )\n* Update CI tests for Llama4 models ( sgl-project#6421 )\n* [Feat] Enable PDL automatically on Hopper architecture ( sgl-project#5981 )\n* chore: update blackwell docker ( sgl-project#6800 )\n* misc: cache is_hopper_arch ( sgl-project#6799 )\n* Remove contiguous before Flashinfer groupwise fp8 gemm ( sgl-project#6804 )\n* Correctly abort the failed grammar requests & Improve the handling of abort ( sgl-project#6803 )\n* [EP] Add cuda kernel for moe_ep_pre_reorder ( sgl-project#6699 )\n* Add draft extend CUDA graph for flashinfer backend  ( sgl-project#6805 )\n* Refactor CustomOp to avoid confusing bugs ( sgl-project#5382 )\n* Tiny log prefill time ( sgl-project#6780 )\n* Tiny fix EPLB assertion about rebalancing period and recorder window size ( sgl-project#6813 )\n* Add simple utility to dump tensors for debugging ( sgl-project#6815 )\n* Fix profiles do not have consistent names ( sgl-project#6811 )\n* Speed up rebalancing when using non-static dispatch algorithms ( sgl-project#6812 )\n* [1/2] Add Kernel support for Cutlass based Fused FP4 MoE ( sgl-project#6093 )\n* [Router] Fix k8s Service Discovery ( sgl-project#6766 )\n* Add CPU optimized kernels for topk and rope fusions  ( sgl-project#6456 )\n* fix new_page_count_next_decode ( sgl-project#6671 )\n* Fix wrong weight reference in dynamic EPLB ( sgl-project#6818 )\n* Minor add metrics to expert location updater ( sgl-project#6816 )\n* [Refactor] Rename `n_share_experts_fusion` as `num_fused_shared_experts` ( sgl-project#6735 )\n* [FEAT] Add transformers backend support  ( sgl-project#5929 )\n* [fix] recover auto-dispatch for rmsnorm and rope ( sgl-project#6745 )\n* fix ep_moe_reorder kernel bugs ( sgl-project#6858 )\n* [Refactor] Multimodal data processing for VLM ( sgl-project#6659 )\n* Decoder-only Scoring API ( sgl-project#6460 )\n* feat: add dp-rank to KV events ( sgl-project#6852 )\n* Set `num_fused_shared_experts` as `num_shared_experts` when shared_experts fusion is not disabled ( sgl-project#6736 )\n* Fix one missing arg in DeepEP ( sgl-project#6878 )\n* Support LoRA in TestOpenAIVisionServer and fix fused kv_proj loading bug. ( sgl-project#6861 )\n* support 1 shot allreduce  in 1-node and 2-node using mscclpp ( sgl-project#6277 )\n* Fix Qwen3MoE missing token padding optimization ( sgl-project#6820 )\n* Tiny update error hints ( sgl-project#6846 )\n* Support layerwise rebalancing experts ( sgl-project#6851 )\n* Tiny allow profiler API to auto create directory ( sgl-project#6865 )\n* Support Blackwell DeepEP docker images ( sgl-project#6868 )\n* [EP] Add cuda kernel for moe_ep_post_reorder ( sgl-project#6837 )\n* [theta]merge 0605\n* oai: fix openAI client error with single request via batch api ( sgl-project#6170 )\n* [PD] Fix potential perf spike caused by tracker gc and optimize doc ( sgl-project#6764 )\n* Use deepgemm instead of triton for fused_qkv_a_proj_with_mqa ( sgl-project#6890 )\n* [CUTLASS-FP4-MOE]  Introduce CutlassMoEParams class for easy initialization of Cutlass Grouped Gems Metadata ( sgl-project#6887 )\n* bugfix(OAI): Fix image_data processing for jinja chat templates ( sgl-project#6877 )\n* [CPU] enable CI for PRs, add Dockerfile and auto build task ( sgl-project#6458 )\n* AITER backend extension and workload optimizations ( sgl-project#6838 )\n* [theta]merge\n* [theta]merge\n* [Feature] Support Flashinfer fmha on Blackwell ( sgl-project#6930 )\n* Fix a bug in abort & Improve docstrings for abort ( sgl-project#6931 )\n* Tiny support customize DeepEP max dispatch tokens per rank ( sgl-project#6934 )\n* Sync the changes on cuda graph runners ( sgl-project#6932 )\n* [PD] Optimize transfer queue forward logic for dummy rank ( sgl-project#6922 )\n* [Refactor] image data process in bench_serving ( sgl-project#6879 )\n* [fix] logical_to_all_physical_map index 256 is out of bounds in EP parallel. ( sgl-project#6767 )\n* Add triton fused moe kernel config for E=257 on B200 ( sgl-project#6939 )\n* [sgl-kernel] update deepgemm ( sgl-project#6942 )\n* chore: bump sgl-kernel v0.1.6 ( sgl-project#6943 )\n* Minor compile fused topk ( sgl-project#6944 )\n* [Bugfix] pipeline parallelism and Eagle Qwen2 ( sgl-project#6910 )\n* Tiny re-introduce profile id logging ( sgl-project#6912 )\n* Add triton version as a fused_moe_triton config search key to avoid performace decrease in different Triton version ( sgl-project#5955 )\n* reduce torch.zeros overhead in moe align block size kernel ( sgl-project#6369 )\n* chore: upgrade sgl-kernel v0.1.6 ( sgl-project#6945 )\n* add fbgemm moe grouped gemm kernel benchmark ( sgl-project#6924 )\n* [Docker] Add docker file for SGL Router ( sgl-project#6915 )\n* Disabling mixed chunked prefill when eagle is enabled ( sgl-project#6874 )\n* Add canary for EPLB rebalancing ( sgl-project#6895 )\n* Refactor global_server_args_dict ( sgl-project#6866 )\n* Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\n* Update server timeout time in AMD CI. ( sgl-project#6953 )\n* [misc] add is_cpu() ( sgl-project#6950 )\n* Add H20 fused MoE kernel tuning configs for DeepSeek-R1/V3 ( sgl-project#6885 )\n* Add a CUDA kernel for fusing mapping and weighted sum for MoE. ( sgl-project#6916 )\n* chore: bump sgl-kernel v0.1.6.post1 ( sgl-project#6955 )\n* chore: upgrade sgl-kernel v0.1.6.post1 ( sgl-project#6957 )\n* [DeepseekR1-FP4] Add Support for nvidia/DeepSeekR1-FP4 model ( sgl-project#6853 )\n* Revert \"Fuse routed scaling factor in topk_reduce kernel ( sgl-project#6220 )\" ( sgl-project#6968 )\n* [AMD] Add more tests to per-commit-amd ( sgl-project#6926 )\n* chore: bump sgl-kernel v0.1.7 ( sgl-project#6963 )\n* Slightly improve the sampler to skip unnecessary steps ( sgl-project#6956 )\n* rebase h20 fused_moe config ( sgl-project#6966 )\n* Fix CI and triton moe Configs ( sgl-project#6974 )\n* Remove unnecessary kernels of num_token_non_padded ( sgl-project#6965 )\n* Extend cuda graph capture bs for B200 ( sgl-project#6937 )\n* Fuse routed scaling factor in deepseek ( sgl-project#6970 )\n* Sync cuda graph runners ( sgl-project#6976 )\n* Fix draft extend ut stability with flush cache ( sgl-project#6979 )\n* Fix triton sliding window test case ( sgl-project#6981 )\n* Fix expert distribution dumping causes OOM ( sgl-project#6967 )\n* Minor remove one kernel for DeepSeek ( sgl-project#6977 )\n* [perf][sgl-kernel] extend cutlass_mla_decode to support num_head < 128 ( sgl-project#6929 )\n* Enable more unit tests for AMD CI. ( sgl-project#6983 )\n* Use torch.compile to fuse flash attention decode metadata preparation ( sgl-project#6973 )\n* Eliminate stream sync to speed up LoRA batch init  ( sgl-project#6960 )\n* support qwen3 emebedding ( sgl-project#6990 )\n* Fix torch profiler bugs for bench_offline_throughput.py ( sgl-project#6557 )\n* chore: upgrade flashinfer v0.2.6.post1 jit ( sgl-project#6958 )\n* cleanup tmp dir ( sgl-project#7007 )\n* chore: update pr test xeon ( sgl-project#7008 )\n* Fix cutlass MLA gets almost zero accuracy ( sgl-project#6998 )\n* Update amd nightly models CI. ( sgl-project#6992 )\n* feat: add direct routing strategy to DP worker ( sgl-project#6884 )\n* Fallback to lower triton version for unfound fused moe configs ( sgl-project#7013 )\n* Fix torchvision version for Blackwell ( sgl-project#7015 )\n* Simplify prepare_extend_after_decode ( sgl-project#6987 )\n* Migrate to assertEqual ( sgl-project#6741 )\n* Fix torch version in blackwell dockerfile ( sgl-project#7017 )\n* chore: update pr test xeon ( sgl-project#7018 )\n* Update default settings for blackwell ( sgl-project#7023 )\n* Support both approximate and exact expert distribution collection ( sgl-project#6964 )\n* Add decode req pool ( sgl-project#6980 )\n* [theta]merge 0610\n* [theta]merge 0610\n* [CI] Add CI workflow for sgl-router docker build ( sgl-project#7027 )\n* Fix fused_moe triton configs ( sgl-project#7029 )\n* CPU: map changes from developing branch in sgl-kernel ( sgl-project#6833 )\n* chore: bump v0.4.7 ( sgl-project#7038 )\n* Update README.md ( sgl-project#7040 ) Sign up for free to join this conversation on GitHub .\n    Already have an account? Sign in to comment",
  "timeline_extracted_at": "2025-09-11 18:57:08",
  "has_lm_eval": true,
  "has_performance": true,
  "has_serving": true,
  "has_general_test": true,
  "test_details": "LM_EVAL | PERF | SERVING | TEST",
  "analysis_extracted_at": null,
  "models": [
    "N/A"
  ],
  "lm_eval_commands": null,
  "perf_command": null,
  "commit_subject": "[PD] Optimize time out logic and add env var doc for mooncake (#6761)",
  "commit_message": "[PD] Optimize time out logic and add env var doc for mooncake (#6761)\n\nSigned-off-by: Shangming Cai <caishangming@linux.alibaba.com>",
  "commit_date": "2025-05-30T00:45:02-07:00",
  "files_changed": [
    "docs/backend/pd_disaggregation.md",
    "python/sglang/srt/disaggregation/mooncake/conn.py"
  ],
  "functions_changed": [],
  "stats": {
    "commit_year": 2025,
    "num_edited_lines": 39,
    "num_files": 2,
    "num_hunks": 3,
    "num_non_test_edited_lines": 39,
    "num_non_test_files": 2,
    "num_test_files": 0,
    "only_non_test_files": 1,
    "only_test_files": 0
  },
  "diff_text": "diff --git a/docs/backend/pd_disaggregation.md b/docs/backend/pd_disaggregation.md\nindex e77164372..9dbc2705d 100644\n--- a/docs/backend/pd_disaggregation.md\n+++ b/docs/backend/pd_disaggregation.md\n@@ -47,6 +47,23 @@ $ python -m sglang.launch_server --model-path deepseek-ai/DeepSeek-V3-0324 --dis\n # decode 1\n $ python -m sglang.launch_server --model-path deepseek-ai/DeepSeek-V3-0324 --disaggregation-ib-device ${device_name} --disaggregation-mode decode --host ${local_ip} --port 30001 --trust-remote-code --dist-init-addr ${decode_master_ip}:5000 --nnodes 2 --node-rank 1 --tp-size 16 --dp-size 8 --enable-dp-attention --enable-deepep-moe --deepep-mode low_latency --mem-fraction-static 0.8 --max-running-requests 128\n ```\n+### Advanced Configuration\n+\n+PD Disaggregation with Mooncake supports the following environment variables for fine-grained control over system behavior.\n+\n+#### Prefill Server Configuration\n+| Variable | Description | Default |\n+|:--------:|:-----------:|:--------:\n+| **`SGLANG_DISAGGREGATION_THREAD_POOL_SIZE`** | Controls the total number of worker threads for KV transfer operations per TP rank | A dynamic value calculated by `int(0.75 * os.cpu_count()) // 8)`, which is limited to be larger than 4 and less than 12 to ensure efficiency and prevent thread race conditions |\n+| **`SGLANG_DISAGGREGATION_QUEUE_SIZE`** | Sets the maximum pending tasks in the parallel transfer queue | `4` |\n+| **`SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT`** | Timeout (seconds) for receiving destination KV indices during request initialization | `30` |\n+\n+#### Decode Server Configuration\n+| Variable | Description | Default |\n+|:--------:|:-----------:|:--------:\n+| **`SGLANG_DISAGGREGATION_HEARTBEAT_INTERVAL`** | Interval (seconds) between health checks to prefill bootstrap servers | `5.0` |\n+| **`SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE`** | Consecutive heartbeat failures before marking prefill server offline | `2` |\n+\n \n ## NIXL\n ### Requirements\ndiff --git a/python/sglang/srt/disaggregation/mooncake/conn.py b/python/sglang/srt/disaggregation/mooncake/conn.py\nindex 4c3faeeb6..940a25d74 100644\n--- a/python/sglang/srt/disaggregation/mooncake/conn.py\n+++ b/python/sglang/srt/disaggregation/mooncake/conn.py\n@@ -677,14 +677,15 @@ class MooncakeKVSender(BaseKVSender):\n         self.kv_mgr.update_status(bootstrap_room, KVPoll.Bootstrapping)\n         self.aux_index = None\n         self.bootstrap_server_url = bootstrap_addr\n-        self.init_time = time.time()\n         self.conclude_state = None\n+        self.init_time = None\n         # inner state\n         self.curr_idx = 0\n \n     def init(self, num_kv_indices: int, aux_index: Optional[int] = None):\n         self.num_kv_indices = num_kv_indices\n         self.aux_index = aux_index\n+        self.init_time = time.time()\n \n     def send(\n         self,\n@@ -713,15 +714,16 @@ class MooncakeKVSender(BaseKVSender):\n             if status in (KVPoll.Success, KVPoll.Failed):\n                 self.conclude_state = status\n             elif status == KVPoll.Bootstrapping:\n-                now = time.time()\n-                elapsed = now - self.init_time\n-                if elapsed >= self.kv_mgr.bootstrap_time_out:\n-                    self.kv_mgr.record_failure(\n-                        self.bootstrap_room,\n-                        f\"Request {self.bootstrap_room} timed out after {elapsed:.1f}s in KVPoll.Bootstrapping\",\n-                    )\n-                    self.conclude_state = KVPoll.Failed\n-                    return KVPoll.Failed\n+                if self.init_time is not None:\n+                    now = time.time()\n+                    elapsed = now - self.init_time\n+                    if elapsed >= self.kv_mgr.bootstrap_time_out:\n+                        self.kv_mgr.record_failure(\n+                            self.bootstrap_room,\n+                            f\"Request {self.bootstrap_room} timed out after {elapsed:.1f}s in KVPoll.Bootstrapping\",\n+                        )\n+                        self.conclude_state = KVPoll.Failed\n+                        return KVPoll.Failed\n \n             return status\n         else:",
  "apis": [
    "MooncakeKVSender.init",
    "MooncakeKVSender.poll"
  ],
  "affected_paths": [
    "/path/to/repos/sglang/benchmark/lora/launch_server.py",
    "/path/to/repos/sglang/python/sglang/launch_server.py",
    "/path/to/repos/sglang/sgl-router/py_src/sglang_router/launch_server.py",
    "/path/to/repos/sglang/python/sglang/api.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/nixl/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/mooncake/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/ascend/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/common/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/fake/conn.py",
    "/path/to/repos/sglang/python/sglang/srt/disaggregation/base/conn.py"
  ],
  "repo_path": "/path/to/repos/sglang",
  "llm_reason": "The commit modifies a source code file (sglang/srt/disaggregation/mooncake/conn.py) rather than a test or documentation file. It changes the timeout logic in the disaggregation module by ensuring that the time measurement is only performed when the initialization time is valid, which can affect the performance of the disaggregation operation. While there is also a documentation addition in the markdown file for configuration variables, the core logic change in the source code aims to improve system behavior under time-sensitive conditions, which can have performance implications (e.g., reducing unnecessary or premature failures in distributed operations). Although the commit message says \"Optimize time out logic\", the modifications are not just a trivial refactor or a mere bug fix but a considered change to improve the performance characteristics of a high-level API, and it is testable on CPU. Therefore, it satisfies the conditions for being performance/optimization related.",
  "llm_api_reason": "The commit touches two parts. The first part adds additional documentation in the PD Disaggregation markdown file, introducing several new environment variable configurations for fine\u2010grained control of the disaggregation behavior on Mooncake. The second part adjusts the timeout logic in the MooncakeKVSender class (in the mooncake disaggregation module) by deferring initialization of the init_time until the init() method is called and adding a check in the poll() method to ensure init_time is not None before computing elapsed time. Thus, the affected APIs are the methods in MooncakeKVSender\u2014specifically the init() and poll() APIs."
}