{"instance_id": "/home/ubuntu/OmniPerf-Bench/sglan__repo-8f3173d", "model_patch": "diff --git a/python/sglang/srt/disaggregation/mooncake/conn.py b/python/sglang/srt/disaggregation/mooncake/conn.py\nindex db30d8c..b312405 100644\n--- a/python/sglang/srt/disaggregation/mooncake/conn.py\n+++ b/python/sglang/srt/disaggregation/mooncake/conn.py\n@@ -114,8 +114,8 @@ class KVArgsRegisterInfo:\n             endpoint=msg[1].decode(\"ascii\"),\n             dst_port=int(msg[2].decode(\"ascii\")),\n             mooncake_session_id=msg[3].decode(\"ascii\"),\n-            dst_kv_ptrs=list(struct.unpack(f\"{len(msg[4])//8}Q\", msg[4])),\n-            dst_aux_ptrs=list(struct.unpack(f\"{len(msg[5])//8}Q\", msg[5])),\n+            dst_kv_ptrs=struct.unpack(f\"{len(msg[4])//8}Q\", msg[4]),\n+            dst_aux_ptrs=struct.unpack(f\"{len(msg[5])//8}Q\", msg[5]),\n             dst_tp_rank=int(msg[6].decode(\"ascii\")),\n             dst_tp_size=int(msg[7].decode(\"ascii\")),\n             dst_kv_item_len=int(msg[8].decode(\"ascii\")),\n@@ -270,16 +270,17 @@ class MooncakeKVManager(BaseKVManager):\n \n         # Worker function for processing a single layer\n         def process_layer(src_ptr: int, dst_ptr: int, item_len: int) -> int:\n-            src_addr_list = []\n-            dst_addr_list = []\n-            length_list = []\n-            for prefill_index, decode_index in zip(prefill_kv_blocks, dst_kv_blocks):\n+            num_blocks = len(prefill_kv_blocks)\n+            src_addr_list = [0] * num_blocks\n+            dst_addr_list = [0] * num_blocks\n+            length_list = [0] * num_blocks\n+            for idx, (prefill_index, decode_index) in enumerate(zip(prefill_kv_blocks, dst_kv_blocks)):\n                 src_addr = src_ptr + int(prefill_index[0]) * item_len\n                 dst_addr = dst_ptr + int(decode_index[0]) * item_len\n                 length = item_len * len(prefill_index)\n-                src_addr_list.append(src_addr)\n-                dst_addr_list.append(dst_addr)\n-                length_list.append(length)\n+                src_addr_list[idx] = src_addr\n+                dst_addr_list[idx] = dst_addr\n+                length_list[idx] = length\n             return self.engine.batch_transfer_sync(\n                 mooncake_session_id, src_addr_list, dst_addr_list, length_list\n             )\n@@ -348,7 +349,7 @@ class MooncakeKVManager(BaseKVManager):\n             num_heads_to_send = heads_per_decode_rank\n             dst_head_offset = 0\n \n-        layer_transfer_params = []\n+        layer_transfer_params = [None] * num_layers\n         for layer_id in range(num_layers):\n             item_len_of_prefill_rank_page = self.kv_args.kv_item_lens[layer_id]\n \n@@ -375,16 +376,14 @@ class MooncakeKVManager(BaseKVManager):\n                     f\"target page size ({item_len_of_decode_rank_page})\"\n                 )\n                 return -1\n-            layer_transfer_params.append(\n-                (\n-                    self.kv_args.kv_data_ptrs[layer_id],\n-                    dst_kv_ptrs[layer_id],\n-                    item_len_of_prefill_rank_page,\n-                    item_len_of_decode_rank_page,\n-                    src_slice_offset,\n-                    dst_slice_offset,\n-                    slice_lens_per_page,\n-                )\n+            layer_transfer_params[layer_id] = (\n+                self.kv_args.kv_data_ptrs[layer_id],\n+                dst_kv_ptrs[layer_id],\n+                item_len_of_prefill_rank_page,\n+                item_len_of_decode_rank_page,\n+                src_slice_offset,\n+                dst_slice_offset,\n+                slice_lens_per_page,\n             )\n \n         def process_layer_tp_aware(layer_params):\n@@ -397,14 +396,18 @@ class MooncakeKVManager(BaseKVManager):\n                 dst_offset,\n                 slice_lens_per_page,\n             ) = layer_params\n-            src_addr_list = []\n-            dst_addr_list = []\n-            length_list = []\n \n             # Calculate strides for a single token slot\n             bytes_per_token_on_prefill = src_item_len // page_size\n             bytes_per_token_on_decode = dst_item_len // page_size\n \n+            # Pre-allocate lists for better performance\n+            total_transfers = len(prefill_kv_indices) * page_size\n+            src_addr_list = [0] * total_transfers\n+            dst_addr_list = [0] * total_transfers\n+            length_list = [slice_lens_per_page] * total_transfers\n+\n+            transfer_idx = 0\n             for i in range(len(prefill_kv_indices)):\n                 prefill_page_idx = int(prefill_kv_indices[i])\n                 decode_page_idx = int(dst_kv_indices[i])\n@@ -429,9 +432,9 @@ class MooncakeKVManager(BaseKVManager):\n                     src_slice_addr = src_token_slot_start_addr + src_offset\n                     dst_slice_addr = dst_token_slot_start_addr + dst_offset\n \n-                    src_addr_list.append(src_slice_addr)\n-                    dst_addr_list.append(dst_slice_addr)\n-                    length_list.append(slice_lens_per_page)\n+                    src_addr_list[transfer_idx] = src_slice_addr\n+                    dst_addr_list[transfer_idx] = dst_slice_addr\n+                    transfer_idx += 1\n \n                     logger.debug(\n                         f\"SYNC: sid={mooncake_session_id}, \"\n@@ -466,18 +469,19 @@ class MooncakeKVManager(BaseKVManager):\n         dst_aux_ptrs: list[int],\n         dst_aux_index: int,\n     ):\n-        src_addr_list = []\n-        dst_addr_list = []\n-        length_list = []\n         prefill_aux_ptrs = self.kv_args.aux_data_ptrs\n         prefill_aux_item_lens = self.kv_args.aux_item_lens\n+        num_aux = len(dst_aux_ptrs)\n+        src_addr_list = [0] * num_aux\n+        dst_addr_list = [0] * num_aux\n+        length_list = [0] * num_aux\n         for i, dst_aux_ptr in enumerate(dst_aux_ptrs):\n             length = prefill_aux_item_lens[i]\n             src_addr = prefill_aux_ptrs[i] + length * prefill_aux_index\n             dst_addr = dst_aux_ptrs[i] + length * dst_aux_index\n-            src_addr_list.append(src_addr)\n-            dst_addr_list.append(dst_addr)\n-            length_list.append(length)\n+            src_addr_list[i] = src_addr\n+            dst_addr_list[i] = dst_addr\n+            length_list[i] = length\n         return self.engine.batch_transfer_sync(\n             mooncake_session_id, src_addr_list, dst_addr_list, length_list\n         )\n@@ -722,9 +726,9 @@ class MooncakeKVManager(BaseKVManager):\n                         if response.status_code == 200:\n                             self.heartbeat_failures[bootstrap_addr] = 0\n \n-                            current_rooms = self.addr_to_rooms_tracker[\n+                            current_rooms = list(self.addr_to_rooms_tracker[\n                                 bootstrap_addr\n-                            ].copy()\n+                            ])\n \n                             for bootstrap_room in current_rooms:\n                                 # Remove KVPoll.Success requests from the tracker\n@@ -1181,17 +1185,17 @@ class MooncakeKVReceiver(BaseKVReceiver):\n                 f\"{bootstrap_info['rank_ip']}:{bootstrap_info['rank_port']}\"\n             )\n             packed_kv_data_ptrs = b\"\".join(\n-                struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.kv_data_ptrs\n+                [struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.kv_data_ptrs]\n             )\n             packed_aux_data_ptrs = b\"\".join(\n-                struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.aux_data_ptrs\n+                [struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.aux_data_ptrs]\n             )\n             tp_rank = self.kv_mgr.kv_args.engine_rank\n             tp_size = self.kv_mgr.tp_size // self.kv_mgr.dp_size\n             kv_item_len = self.kv_mgr.kv_args.kv_item_lens[0]\n-            dst_tp_rank = str(tp_rank).encode(\"ascii\")\n-            dst_tp_size = str(tp_size).encode(\"ascii\")\n-            dst_kv_item_len = str(kv_item_len).encode(\"ascii\")\n+            dst_tp_rank = f\"{tp_rank}\".encode(\"ascii\")\n+            dst_tp_size = f\"{tp_size}\".encode(\"ascii\")\n+            dst_kv_item_len = f\"{kv_item_len}\".encode(\"ascii\")\n \n             sock, lock = self._connect(\"tcp://\" + self.prefill_server_url)\n             with lock:\n", "model_name_or_path": "gpt-5-2025-08-07"}
