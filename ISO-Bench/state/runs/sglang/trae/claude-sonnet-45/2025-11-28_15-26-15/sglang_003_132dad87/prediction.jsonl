{"instance_id": "/home/ubuntu/OmniPerf-Bench/sglan__repo-60fdad7", "model_patch": "diff --git a/python/sglang/srt/disaggregation/mooncake/conn.py b/python/sglang/srt/disaggregation/mooncake/conn.py\nindex 824f76709..4174db78d 100644\n--- a/python/sglang/srt/disaggregation/mooncake/conn.py\n+++ b/python/sglang/srt/disaggregation/mooncake/conn.py\n@@ -44,6 +44,8 @@ from sglang.srt.utils import (\n \n logger = logging.getLogger(__name__)\n \n+_EMPTY_INT64 = np.empty(0, dtype=np.int64)\n+\n \n class KVTransferError(Exception):\n     def __init__(self, bootstrap_room: int, failure_reason: str):\n@@ -81,7 +83,7 @@ class TransferInfo:\n     def from_zmq(cls, msg: List[bytes]):\n         if msg[4] == b\"\" and msg[5] == b\"\":\n             is_dummy = True\n-            dst_kv_indices = np.array([], dtype=np.int64)\n+            dst_kv_indices = _EMPTY_INT64\n             dst_aux_index = None\n         else:\n             dst_kv_indices = np.frombuffer(msg[4], dtype=np.int64)\n@@ -116,8 +118,8 @@ class KVArgsRegisterInfo:\n             endpoint=msg[1].decode(\"ascii\"),\n             dst_port=int(msg[2].decode(\"ascii\")),\n             mooncake_session_id=msg[3].decode(\"ascii\"),\n-            dst_kv_ptrs=list(struct.unpack(f\"{len(msg[4])//8}Q\", msg[4])),\n-            dst_aux_ptrs=list(struct.unpack(f\"{len(msg[5])//8}Q\", msg[5])),\n+            dst_kv_ptrs=np.frombuffer(msg[4], dtype=np.uint64).tolist(),\n+            dst_aux_ptrs=np.frombuffer(msg[5], dtype=np.uint64).tolist(),\n         )\n \n \n@@ -326,7 +328,8 @@ class MooncakeKVManager(BaseKVManager):\n                     if kv_chunk.room in self.transfer_infos\n                     else []\n                 )\n-                polls = []\n+                success_count = 0\n+                all_success = True\n                 dst_ranks_infos = []\n                 for req in reqs_to_be_processed:\n                     if not req.is_dummy:\n@@ -398,14 +401,17 @@ class MooncakeKVManager(BaseKVManager):\n                                 ].dst_aux_ptrs,\n                                 req.dst_aux_index,\n                             )\n-                            polls.append(True if ret == 0 else False)\n+                            if ret == 0:\n+                                success_count += 1\n+                            else:\n+                                all_success = False\n                             dst_ranks_infos.append(\n                                 (req.endpoint, req.dst_port, req.room)\n                             )\n \n                             # Only sync status when all the dst ranks have received the kvcache\n-                            if len(polls) == req.required_dst_info_num:\n-                                status = KVPoll.Success if all(polls) else KVPoll.Failed\n+                            if success_count == req.required_dst_info_num:\n+                                status = KVPoll.Success if all_success else KVPoll.Failed\n                                 self.update_status(req.room, status)\n                                 for endpoint, dst_port, room in dst_ranks_infos:\n                                     self.sync_status_to_decode_endpoint(\n@@ -565,7 +571,13 @@ class MooncakeKVManager(BaseKVManager):\n         # NOTE(shangming): sharding according to the dst_infos to make sure\n         # requests with the same dst_sessions will be added into the same\n         # queue, which enables early abort with failed sessions.\n-        dst_infos = self.transfer_infos[bootstrap_room].keys()\n+        if bootstrap_room not in self.transfer_infos:\n+            # This means that the current rank is a dummy rank for this request,\n+            # and it has already been marked as success, so there is no need to\n+            # add further chunks into the transfer queue.\n+            return\n+\n+        dst_infos = self.transfer_infos[bootstrap_room]\n         session_port_sum = sum(int(session.split(\":\")[1]) for session in dst_infos)\n         shard_idx = session_port_sum % len(self.transfer_queues)\n \n@@ -578,7 +590,6 @@ class MooncakeKVManager(BaseKVManager):\n                 prefill_aux_index=aux_index,\n             )\n         )\n-        self.update_status(bootstrap_room, KVPoll.WaitingForInput)\n \n     def check_status(self, bootstrap_room: int):\n         return self.request_status[bootstrap_room]\n", "model_name_or_path": "gpt-5-2025-08-07"}
