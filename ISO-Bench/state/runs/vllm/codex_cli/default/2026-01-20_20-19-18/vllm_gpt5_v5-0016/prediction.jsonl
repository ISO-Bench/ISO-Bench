{"instance_id": "/root/OmniPerf-Bench/vllm__repo-90f1e55", "model_patch": "diff --git a/csrc/moe/moe_permute_unpermute_op.cu b/csrc/moe/moe_permute_unpermute_op.cu\nindex 13aecd8..3c8810c 100644\n--- a/csrc/moe/moe_permute_unpermute_op.cu\n+++ b/csrc/moe/moe_permute_unpermute_op.cu\n@@ -197,24 +197,28 @@ void shuffle_rows(const torch::Tensor& input_tensor,\n   int64_t const num_src_rows = input_tensor.size(0);\n   int64_t const num_cols = input_tensor.size(1);\n \n-  if (num_cols % (128 / sizeof(input_tensor.scalar_type()) / 8)) {\n-    // use slow kernel if num_cols can't be aligned to 128 bits\n-    MOE_DISPATCH(input_tensor.scalar_type(), [&] {\n-      shuffleInputRowsKernelSlow<scalar_t><<<blocks, threads, 0, stream>>>(\n+  // Launch a vectorized kernel when each row length is a multiple of 128 bits.\n+  // Compute alignment using the element size of the dispatch type to avoid\n+  // selecting the slow path unnecessarily.\n+  MOE_DISPATCH(input_tensor.scalar_type(), [&] {\n+    constexpr int64_t kBitsPerVec = 128;\n+    constexpr int64_t kBitsPerByte = 8;\n+    const int64_t elems_per_vec = kBitsPerVec / (sizeof(scalar_t) * kBitsPerByte);\n+    const bool use_vectorized = (num_cols % elems_per_vec) == 0;\n+    if (use_vectorized) {\n+      shuffleInputRowsKernel<scalar_t><<<blocks, threads, 0, stream>>>(\n           reinterpret_cast<scalar_t*>(input_tensor.data_ptr()),\n           dst2src_map.data_ptr<int32_t>(),\n           reinterpret_cast<scalar_t*>(output_tensor.data_ptr()), num_src_rows,\n           num_dest_rows, num_cols);\n-    });\n-  } else {\n-    MOE_DISPATCH(input_tensor.scalar_type(), [&] {\n-      shuffleInputRowsKernel<scalar_t><<<blocks, threads, 0, stream>>>(\n+    } else {\n+      shuffleInputRowsKernelSlow<scalar_t><<<blocks, threads, 0, stream>>>(\n           reinterpret_cast<scalar_t*>(input_tensor.data_ptr()),\n           dst2src_map.data_ptr<int32_t>(),\n           reinterpret_cast<scalar_t*>(output_tensor.data_ptr()), num_src_rows,\n           num_dest_rows, num_cols);\n-    });\n-  }\n+    }\n+  });\n }\n \n #else\n", "model_name_or_path": "gpt-5-2025-08-07"}
