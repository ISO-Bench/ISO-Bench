I've uploaded a python code repository in the directory /root/OmniPerf-Bench/perf-agents-bench/.work/worktrees/vllm_core/vllm_gpt5_v5-0005.
Consider the following test script showing an example usage of the repository:

<test_script>
import torch
import time
from vllm.core.block.prefix_caching_block import PrefixCachingBlockAllocator

# Benchmark prefix caching block allocation with common prefixes
block_size = 16
num_blocks = 256
num_sequences = 8
common_prefix_blocks = 4

# Create allocator
allocator = PrefixCachingBlockAllocator(num_blocks=num_blocks, block_size=block_size)

# Common token IDs for shared prefix
common_token_ids = list(range(block_size * common_prefix_blocks))

# Time the allocation and marking operation
start = time.time()

# Allocate blocks for multiple sequences with common prefixes
for seq_idx in range(num_sequences):
    prev_block = None
    for block_idx in range(common_prefix_blocks):
        start_idx = block_idx * block_size
        end_idx = start_idx + block_size
        token_ids = common_token_ids[start_idx:end_idx]
        
        block = allocator.allocate_immutable_block(
            prev_block=prev_block,
            token_ids=token_ids
        )
        prev_block = block

# Mark blocks as computed (this is the optimized operation)
allocator.mark_blocks_as_computed([])

duration = time.time() - start
print(f"Duration: {duration:.4f} seconds")
print(f"Cache hit rate: {allocator.get_prefix_cache_hit_rate():.3f}")

</test_script>

Can you help me implement the necessary changes to the repository so that the runtime of the <test_script> is optimized?

Basic guidelines:
1. Your task is to make changes to non-test files in the /root/OmniPerf-Bench/perf-agents-bench/.work/worktrees/vllm_core/vllm_gpt5_v5-0005 directory to improve the performance of the <test_script>.
2. Make changes while ensuring the repository is functionally equivalent to the original.
3. Do not overoptimize for just the specific inputs in <test_script>. Make general performance improvements for the usage scenario shown.
4. You may need to rebuild the repo for your changes to take effect before testing. Some rebuilds may take time to run, so be patient with running them.

Follow these steps to improve performance:
1. As a first step, explore the repository structure and understand the target files.
2. Create a script ONLY inside /root/OmniPerf-Bench/perf-agents-bench/.work/worktrees/vllm_core/vllm_gpt5_v5-0005/.bench_scratch (e.g., /root/OmniPerf-Bench/perf-agents-bench/.work/worktrees/vllm_core/vllm_gpt5_v5-0005/.bench_scratch/test_opt.py) to reproduce and time the example, then execute it with python <filename.py> from the repo root.
3. Profile and identify performance bottlenecks in the target files.
4. Edit the source code of the repository to improve performance.
5. Rebuild and rerun your script to confirm that performance has improved.

Common optimization strategies to consider:
- Reduce unnecessary memory allocations
- Avoid redundant computations
- Optimize data structures and algorithms
- Improve cache locality
- Reduce synchronization overhead
- Use more efficient library calls where available

Target files to optimize:
- benchmarks/benchmark_latency.py
- tests/conftest.py
- tests/core/block/test_block_table.py

IMPORTANT: You MUST make actual code changes to at least one file.
The task will fail if no files are modified.

## Constraints
- No public API breakage
- All TestPack checks must pass

## Target Files (ONLY modify these)
- `benchmarks/benchmark_latency.py`
- `tests/conftest.py`
- `tests/core/block/test_block_table.py`
- `tests/core/block/test_cpu_gpu_block_allocator.py`
- `tests/core/block/test_naive_block.py`
- `tests/core/block/test_prefix_caching_block.py`
- `tests/spec_decode/test_batch_expansion.py`
- `vllm/core/block/block_table.py`
- `vllm/core/block/common.py`
- `vllm/core/block/cpu_gpu_block_allocator.py`
- `vllm/core/block/interfaces.py`
- `vllm/core/block/naive_block.py`
- `vllm/core/block/prefix_caching_block.py`
- `vllm/core/block_manager_v2.py`
- `vllm/engine/llm_engine.py`
- `vllm/entrypoints/openai/serving_completion.py`
- `vllm/model_executor/sampling_metadata.py`
- `vllm/outputs.py`
- `vllm/sequence.py`

## Files Modified (statistics)
The following files were changed in the reference optimization:
```
benchmarks/benchmark_latency.py                  |   4 +
 tests/conftest.py                                |   2 +-
 tests/core/block/test_block_table.py             |   5 +-
 tests/core/block/test_cpu_gpu_block_allocator.py |  24 +-
 tests/core/block/test_naive_block.py             |   6 +-
 tests/core/block/test_prefix_caching_block.py    | 106 ++--
 tests/spec_decode/test_batch_expansion.py        |   8 +-
 vllm/core/block/block_table.py                   |  85 ++-
 vllm/core/block/common.py                        | 198 +++++--
 vllm/core/block/cpu_gpu_block_allocator.py       |  84 ++-
 vllm/core/block/interfaces.py                    |  56 +-
 vllm/core/block/naive_block.py                   | 216 ++++---
 vllm/core/block/prefix_caching_block.py          | 693 ++++++++++++++++-------
 vllm/core/block_manager_v2.py                    | 150 +++--
 vllm/engine/llm_engine.py                        |   5 +-
 vllm/entrypoints/openai/serving_completion.py    |   2 +-
 vllm/model_executor/sampling_metadata.py         |   4 +-
 vllm/outputs.py                                  |   4 +-
 vllm/sequence.py                                 |  69 ++-
 19 files changed, 1189 insertions(+), 532 deletions(-)
```

## TASK COMPLETION COMMAND:
When you have made optimizations:
```bash
git add -A
git reset -q .bench_scratch || true
git commit -m 'Optimize MoE align sum kernels performance'
git diff $(git merge-base HEAD origin/HEAD || git rev-parse HEAD~1) -- . ':(exclude).bench_scratch' > /root/OmniPerf-Bench/perf-agents-bench/.work/worktrees/vllm_core/vllm_gpt5_v5-0005/model_patch.diff || true
finish
```

START IMPLEMENTING IMMEDIATELY. NO MORE ANALYSIS.
