Changed working directory to:
/home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/workt
rees/vllm_core/vllm_core-0000
Initialising MCP tools...
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Task Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ Task: I've uploaded a python code repository in the directory                â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000.                                           â”‚
â”‚ Consider the following test script showing an example usage of the           â”‚
â”‚ repository:                                                                  â”‚
â”‚                                                                              â”‚
â”‚ <test_script>                                                                â”‚
â”‚ # This is a performance optimization task                                    â”‚
â”‚ # The specific operations to optimize are in the files listed below          â”‚
â”‚ # Focus on performance improvements in the target functions                  â”‚
â”‚                                                                              â”‚
â”‚ </test_script>                                                               â”‚
â”‚                                                                              â”‚
â”‚ Can you help me implement the necessary changes to the repository so that    â”‚
â”‚ the runtime of the <test_script> is optimized?                               â”‚
â”‚                                                                              â”‚
â”‚ Basic guidelines:                                                            â”‚
â”‚ 1. Your task is to make changes to non-test files in the                     â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000 directory to improve the performance of    â”‚
â”‚ the <test_script>.                                                           â”‚
â”‚ 2. Make changes while ensuring the repository is functionally equivalent to  â”‚
â”‚ the original.                                                                â”‚
â”‚ 3. Do not overoptimize for just the specific inputs in <test_script>. Make   â”‚
â”‚ general performance improvements for the usage scenario shown.               â”‚
â”‚ 4. You may need to rebuild the repo for your changes to take effect before   â”‚
â”‚ testing. Some rebuilds may take time to run, so be patient with running      â”‚
â”‚ them.                                                                        â”‚
â”‚                                                                              â”‚
â”‚ Follow these steps to improve performance:                                   â”‚
â”‚ 1. As a first step, explore the repository structure.                        â”‚
â”‚ 2. Create a script ONLY inside                                               â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch (e.g.,                      â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch/test_opt.py) to reproduce   â”‚
â”‚ and time the example, then execute it with python <filename.py> from the     â”‚
â”‚ repo root.                                                                   â”‚
â”‚ 3. Edit the source code of the repository to improve performance.            â”‚
â”‚ 4. Rebuild and rerun your script to confirm that performance has improved.   â”‚
â”‚                                                                              â”‚
â”‚ Here is an example of the kind of optimizations that have been shown to      â”‚
â”‚ improve performance in this codebase:                                        â”‚
â”‚                                                                              â”‚
â”‚ <example_optimization_diff>                                                  â”‚
â”‚ diff --git a/vllm/config.py b/vllm/config.py                                 â”‚
â”‚ index 6bfe94b76..3bcbbe606 100644                                            â”‚
â”‚ --- a/vllm/config.py                                                         â”‚
â”‚ +++ b/vllm/config.py                                                         â”‚
â”‚ @@ -4769,12 +4769,23 @@ class VllmConfig:                                    â”‚
â”‚                  # Hybrid KV cache manager is not compatible with KV events. â”‚
â”‚                  self.scheduler_config.disable_hybrid_kv_cache_manager =     â”‚
â”‚ True                                                                         â”‚
â”‚              if self.model_config is not None and \                          â”‚
â”‚ -                self.model_config.attention_chunk_size is not None and \    â”‚
â”‚ -                self.speculative_config is not None and \                   â”‚
â”‚ -                self.speculative_config.use_eagle():                        â”‚
â”‚ -                # Hybrid KV cache manager is not yet supported with chunked â”‚
â”‚ -                # local attention + eagle.                                  â”‚
â”‚ -                self.scheduler_config.disable_hybrid_kv_cache_manager =     â”‚
â”‚ True                                                                         â”‚
â”‚ +                self.model_config.attention_chunk_size is not None:         â”‚
â”‚ +                if self.speculative_config is not None and \                â”‚
â”‚ +                    self.speculative_config.use_eagle():                    â”‚
â”‚ +                    # Hybrid KV cache manager is not yet supported with     â”‚
â”‚ chunked                                                                      â”‚
â”‚ +                    # local attention + eagle.                              â”‚
â”‚ +                    self.scheduler_config.disable_hybrid_kv_cache_manager = â”‚
â”‚ True                                                                         â”‚
â”‚ +                elif \                                                      â”‚
â”‚ +                    not                                                     â”‚
â”‚ envs.VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE:                     â”‚
â”‚ +                    logger.warning(                                         â”‚
â”‚ +                        "There is a latency regression when using chunked   â”‚
â”‚ local"                                                                       â”‚
â”‚ +                        " attention with the hybrid KV cache manager.       â”‚
â”‚ Disabling"                                                                   â”‚
â”‚ +                        " it, by default. To enable it, set the environment â”‚
â”‚ "                                                                            â”‚
â”‚ +                                                                            â”‚
â”‚ "VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE=1."                      â”‚
â”‚ +                    )                                                       â”‚
â”‚ +                    # Hybrid KV cache manager is not yet supported with     â”‚
â”‚ chunked                                                                      â”‚
â”‚ +                    # local attention.                                      â”‚
â”‚ </example_optimization_diff>                                                 â”‚
â”‚                                                                              â”‚
â”‚ IMPORTANT: The above diff is an EXAMPLE of optimizations that were           â”‚
â”‚ successful in a different context.                                           â”‚
â”‚ These changes have NOT been applied to your codebase yet.                    â”‚
â”‚ Your task is to:                                                             â”‚
â”‚ 1. Understand the optimization pattern shown (e.g., torch.zeros â†’            â”‚
â”‚ torch.empty)                                                                 â”‚
â”‚ 2. Look at the CURRENT code in the target files                              â”‚
â”‚ 3. Find places where you can apply SIMILAR optimizations                     â”‚
â”‚ 4. MAKE THE CHANGES yourself using str_replace_editor                        â”‚
â”‚                                                                              â”‚
â”‚ The codebase you're working with is at the BASE commit - it does NOT have    â”‚
â”‚ these optimizations yet.                                                     â”‚
â”‚ You need to IMPLEMENT similar optimizations yourself.                        â”‚
â”‚                                                                              â”‚
â”‚ HERE'S WHAT YOU NEED TO DO:                                                  â”‚
â”‚ 1. The files CURRENTLY contain torch.zeros() calls that need optimization    â”‚
â”‚ 2. You need to CHANGE torch.zeros to torch.empty where appropriate           â”‚
â”‚ 3. You need to REMOVE .fill_() operations that are unnecessary               â”‚
â”‚ 4. These are NEW changes you're making - not already in the code             â”‚
â”‚                                                                              â”‚
â”‚ START WITH THIS COMMAND to see what needs changing:                          â”‚
â”‚ ```bash                                                                      â”‚
â”‚ grep -n 'torch.zeros\|fill_'                                                 â”‚
â”‚ vllm/model_executor/layers/fused_moe/moe_align_block_size.py                 â”‚
â”‚ benchmarks/kernels/benchmark_moe_align_block_size.py                         â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ CRITICAL: You MUST make actual code changes. Look for patterns like:         â”‚
â”‚ - Analyze the target files for performance bottlenecks                       â”‚
â”‚ - Look for unnecessary memory allocations or initializations                 â”‚
â”‚ - Consider more efficient algorithms or data structures                      â”‚
â”‚                                                                              â”‚
â”‚ Target files to optimize:                                                    â”‚
â”‚ - vllm/config.py                                                             â”‚
â”‚ - vllm/envs.py                                                               â”‚
â”‚                                                                              â”‚
â”‚ IMPORTANT: You MUST make actual code changes to at least one file.           â”‚
â”‚ The task will fail if no files are modified.                                 â”‚
â”‚                                                                              â”‚
â”‚ ## Constraints                                                               â”‚
â”‚ - No public API breakage                                                     â”‚
â”‚ - All TestPack checks must pass                                              â”‚
â”‚                                                                              â”‚
â”‚ ## Target Files (ONLY modify these)                                          â”‚
â”‚ - `vllm/config.py`                                                           â”‚
â”‚ - `vllm/envs.py`                                                             â”‚
â”‚                                                                              â”‚
â”‚ ## SPECIFIC OPTIMIZATION TARGETS:                                            â”‚
â”‚ Based on the human commit analysis, focus on these areas:                    â”‚
â”‚ - Memory allocation patterns (torch.zeros vs torch.empty)                    â”‚
â”‚ - Tensor initialization strategies                                           â”‚
â”‚ - Kernel parameter optimization                                              â”‚
â”‚ - Buffer reuse and caching                                                   â”‚
â”‚                                                                              â”‚
â”‚ ### Human Developer's Approach:                                              â”‚
â”‚ ```                                                                          â”‚
â”‚ [Perf] Disable chunked local attention by default with llama4 (#21761)       â”‚
â”‚                                                                              â”‚
â”‚ Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com>                         â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ ### Files Modified (statistics):                                             â”‚
â”‚ ```                                                                          â”‚
â”‚ vllm/config.py | 23 +++++++++++++++++------                                  â”‚
â”‚  vllm/envs.py   | 12 ++++++++++++                                            â”‚
â”‚  2 files changed, 29 insertions(+), 6 deletions(-)                           â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ ## IMMEDIATE ACTION REQUIREMENTS:                                            â”‚
â”‚ 1. Start editing files by iteration 3                                        â”‚
â”‚ 2. Create and run                                                            â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch/test_opt.py before and      â”‚
â”‚ after edits (do not create timing scripts outside                            â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch)                            â”‚
â”‚ 3. Make at least 3 concrete optimizations                                    â”‚
â”‚ 4. Commit changes by iteration 8                                             â”‚
â”‚ 5. Use finish command by iteration 10                                        â”‚
â”‚                                                                              â”‚
â”‚ ## TASK COMPLETION COMMAND:                                                  â”‚
â”‚ When you have made optimizations:                                            â”‚
â”‚ ```bash                                                                      â”‚
â”‚ git add -A                                                                   â”‚
â”‚ git reset -q .bench_scratch || true                                          â”‚
â”‚ git commit -m 'Optimize MoE align sum kernels performance'                   â”‚
â”‚ git diff $(git merge-base HEAD origin/HEAD || git rev-parse HEAD~1) -- .     â”‚
â”‚ ':(exclude).bench_scratch' >                                                 â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/model_patch.diff || true                   â”‚
â”‚ finish                                                                       â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ START IMPLEMENTING IMMEDIATELY. NO MORE ANALYSIS.                            â”‚
â”‚                                                                              â”‚
â”‚ Model Provider: openai                                                       â”‚
â”‚ Model: gpt-5                                                                 â”‚
â”‚ Max Steps: 120                                                               â”‚
â”‚ Trajectory File:                                                             â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/state/r â”‚
â”‚ uns/vllm_core-f8009ca8/vllm_core-0000/trajectory.json                        â”‚
â”‚ Tools: bash, str_replace_based_edit_tool, sequentialthinking, task_done,     â”‚
â”‚ browser_close, browser_resize, browser_console_messages,                     â”‚
â”‚ browser_handle_dialog, browser_file_upload, browser_install,                 â”‚
â”‚ browser_press_key, browser_navigate, browser_navigate_back,                  â”‚
â”‚ browser_navigate_forward, browser_network_requests, browser_pdf_save,        â”‚
â”‚ browser_take_screenshot, browser_snapshot, browser_click, browser_drag,      â”‚
â”‚ browser_hover, browser_type, browser_select_option, browser_tab_list,        â”‚
â”‚ browser_tab_new, browser_tab_select, browser_tab_close,                      â”‚
â”‚ browser_generate_playwright_test, browser_wait_for                           â”‚
â”‚ Project_path:                                                                â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000                                            â”‚
â”‚ Issue: I've uploaded a python code repository in the directory               â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000.                                           â”‚
â”‚ Consider the following test script showing an example usage of the           â”‚
â”‚ repository:                                                                  â”‚
â”‚                                                                              â”‚
â”‚ <test_script>                                                                â”‚
â”‚ # This is a performance optimization task                                    â”‚
â”‚ # The specific operations to optimize are in the files listed below          â”‚
â”‚ # Focus on performance improvements in the target functions                  â”‚
â”‚                                                                              â”‚
â”‚ </test_script>                                                               â”‚
â”‚                                                                              â”‚
â”‚ Can you help me implement the necessary changes to the repository so that    â”‚
â”‚ the runtime of the <test_script> is optimized?                               â”‚
â”‚                                                                              â”‚
â”‚ Basic guidelines:                                                            â”‚
â”‚ 1. Your task is to make changes to non-test files in the                     â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000 directory to improve the performance of    â”‚
â”‚ the <test_script>.                                                           â”‚
â”‚ 2. Make changes while ensuring the repository is functionally equivalent to  â”‚
â”‚ the original.                                                                â”‚
â”‚ 3. Do not overoptimize for just the specific inputs in <test_script>. Make   â”‚
â”‚ general performance improvements for the usage scenario shown.               â”‚
â”‚ 4. You may need to rebuild the repo for your changes to take effect before   â”‚
â”‚ testing. Some rebuilds may take time to run, so be patient with running      â”‚
â”‚ them.                                                                        â”‚
â”‚                                                                              â”‚
â”‚ Follow these steps to improve performance:                                   â”‚
â”‚ 1. As a first step, explore the repository structure.                        â”‚
â”‚ 2. Create a script ONLY inside                                               â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch (e.g.,                      â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch/test_opt.py) to reproduce   â”‚
â”‚ and time the example, then execute it with python <filename.py> from the     â”‚
â”‚ repo root.                                                                   â”‚
â”‚ 3. Edit the source code of the repository to improve performance.            â”‚
â”‚ 4. Rebuild and rerun your script to confirm that performance has improved.   â”‚
â”‚                                                                              â”‚
â”‚ Here is an example of the kind of optimizations that have been shown to      â”‚
â”‚ improve performance in this codebase:                                        â”‚
â”‚                                                                              â”‚
â”‚ <example_optimization_diff>                                                  â”‚
â”‚ diff --git a/vllm/config.py b/vllm/config.py                                 â”‚
â”‚ index 6bfe94b76..3bcbbe606 100644                                            â”‚
â”‚ --- a/vllm/config.py                                                         â”‚
â”‚ +++ b/vllm/config.py                                                         â”‚
â”‚ @@ -4769,12 +4769,23 @@ class VllmConfig:                                    â”‚
â”‚                  # Hybrid KV cache manager is not compatible with KV events. â”‚
â”‚                  self.scheduler_config.disable_hybrid_kv_cache_manager =     â”‚
â”‚ True                                                                         â”‚
â”‚              if self.model_config is not None and \                          â”‚
â”‚ -                self.model_config.attention_chunk_size is not None and \    â”‚
â”‚ -                self.speculative_config is not None and \                   â”‚
â”‚ -                self.speculative_config.use_eagle():                        â”‚
â”‚ -                # Hybrid KV cache manager is not yet supported with chunked â”‚
â”‚ -                # local attention + eagle.                                  â”‚
â”‚ -                self.scheduler_config.disable_hybrid_kv_cache_manager =     â”‚
â”‚ True                                                                         â”‚
â”‚ +                self.model_config.attention_chunk_size is not None:         â”‚
â”‚ +                if self.speculative_config is not None and \                â”‚
â”‚ +                    self.speculative_config.use_eagle():                    â”‚
â”‚ +                    # Hybrid KV cache manager is not yet supported with     â”‚
â”‚ chunked                                                                      â”‚
â”‚ +                    # local attention + eagle.                              â”‚
â”‚ +                    self.scheduler_config.disable_hybrid_kv_cache_manager = â”‚
â”‚ True                                                                         â”‚
â”‚ +                elif \                                                      â”‚
â”‚ +                    not                                                     â”‚
â”‚ envs.VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE:                     â”‚
â”‚ +                    logger.warning(                                         â”‚
â”‚ +                        "There is a latency regression when using chunked   â”‚
â”‚ local"                                                                       â”‚
â”‚ +                        " attention with the hybrid KV cache manager.       â”‚
â”‚ Disabling"                                                                   â”‚
â”‚ +                        " it, by default. To enable it, set the environment â”‚
â”‚ "                                                                            â”‚
â”‚ +                                                                            â”‚
â”‚ "VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE=1."                      â”‚
â”‚ +                    )                                                       â”‚
â”‚ +                    # Hybrid KV cache manager is not yet supported with     â”‚
â”‚ chunked                                                                      â”‚
â”‚ +                    # local attention.                                      â”‚
â”‚ </example_optimization_diff>                                                 â”‚
â”‚                                                                              â”‚
â”‚ IMPORTANT: The above diff is an EXAMPLE of optimizations that were           â”‚
â”‚ successful in a different context.                                           â”‚
â”‚ These changes have NOT been applied to your codebase yet.                    â”‚
â”‚ Your task is to:                                                             â”‚
â”‚ 1. Understand the optimization pattern shown (e.g., torch.zeros â†’            â”‚
â”‚ torch.empty)                                                                 â”‚
â”‚ 2. Look at the CURRENT code in the target files                              â”‚
â”‚ 3. Find places where you can apply SIMILAR optimizations                     â”‚
â”‚ 4. MAKE THE CHANGES yourself using str_replace_editor                        â”‚
â”‚                                                                              â”‚
â”‚ The codebase you're working with is at the BASE commit - it does NOT have    â”‚
â”‚ these optimizations yet.                                                     â”‚
â”‚ You need to IMPLEMENT similar optimizations yourself.                        â”‚
â”‚                                                                              â”‚
â”‚ HERE'S WHAT YOU NEED TO DO:                                                  â”‚
â”‚ 1. The files CURRENTLY contain torch.zeros() calls that need optimization    â”‚
â”‚ 2. You need to CHANGE torch.zeros to torch.empty where appropriate           â”‚
â”‚ 3. You need to REMOVE .fill_() operations that are unnecessary               â”‚
â”‚ 4. These are NEW changes you're making - not already in the code             â”‚
â”‚                                                                              â”‚
â”‚ START WITH THIS COMMAND to see what needs changing:                          â”‚
â”‚ ```bash                                                                      â”‚
â”‚ grep -n 'torch.zeros\|fill_'                                                 â”‚
â”‚ vllm/model_executor/layers/fused_moe/moe_align_block_size.py                 â”‚
â”‚ benchmarks/kernels/benchmark_moe_align_block_size.py                         â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ CRITICAL: You MUST make actual code changes. Look for patterns like:         â”‚
â”‚ - Analyze the target files for performance bottlenecks                       â”‚
â”‚ - Look for unnecessary memory allocations or initializations                 â”‚
â”‚ - Consider more efficient algorithms or data structures                      â”‚
â”‚                                                                              â”‚
â”‚ Target files to optimize:                                                    â”‚
â”‚ - vllm/config.py                                                             â”‚
â”‚ - vllm/envs.py                                                               â”‚
â”‚                                                                              â”‚
â”‚ IMPORTANT: You MUST make actual code changes to at least one file.           â”‚
â”‚ The task will fail if no files are modified.                                 â”‚
â”‚                                                                              â”‚
â”‚ ## Constraints                                                               â”‚
â”‚ - No public API breakage                                                     â”‚
â”‚ - All TestPack checks must pass                                              â”‚
â”‚                                                                              â”‚
â”‚ ## Target Files (ONLY modify these)                                          â”‚
â”‚ - `vllm/config.py`                                                           â”‚
â”‚ - `vllm/envs.py`                                                             â”‚
â”‚                                                                              â”‚
â”‚ ## SPECIFIC OPTIMIZATION TARGETS:                                            â”‚
â”‚ Based on the human commit analysis, focus on these areas:                    â”‚
â”‚ - Memory allocation patterns (torch.zeros vs torch.empty)                    â”‚
â”‚ - Tensor initialization strategies                                           â”‚
â”‚ - Kernel parameter optimization                                              â”‚
â”‚ - Buffer reuse and caching                                                   â”‚
â”‚                                                                              â”‚
â”‚ ### Human Developer's Approach:                                              â”‚
â”‚ ```                                                                          â”‚
â”‚ [Perf] Disable chunked local attention by default with llama4 (#21761)       â”‚
â”‚                                                                              â”‚
â”‚ Signed-off-by: Lucas Wilkinson <lwilkins@redhat.com>                         â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ ### Files Modified (statistics):                                             â”‚
â”‚ ```                                                                          â”‚
â”‚ vllm/config.py | 23 +++++++++++++++++------                                  â”‚
â”‚  vllm/envs.py   | 12 ++++++++++++                                            â”‚
â”‚  2 files changed, 29 insertions(+), 6 deletions(-)                           â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ ## IMMEDIATE ACTION REQUIREMENTS:                                            â”‚
â”‚ 1. Start editing files by iteration 3                                        â”‚
â”‚ 2. Create and run                                                            â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch/test_opt.py before and      â”‚
â”‚ after edits (do not create timing scripts outside                            â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/.bench_scratch)                            â”‚
â”‚ 3. Make at least 3 concrete optimizations                                    â”‚
â”‚ 4. Commit changes by iteration 8                                             â”‚
â”‚ 5. Use finish command by iteration 10                                        â”‚
â”‚                                                                              â”‚
â”‚ ## TASK COMPLETION COMMAND:                                                  â”‚
â”‚ When you have made optimizations:                                            â”‚
â”‚ ```bash                                                                      â”‚
â”‚ git add -A                                                                   â”‚
â”‚ git reset -q .bench_scratch || true                                          â”‚
â”‚ git commit -m 'Optimize MoE align sum kernels performance'                   â”‚
â”‚ git diff $(git merge-base HEAD origin/HEAD || git rev-parse HEAD~1) -- .     â”‚
â”‚ ':(exclude).bench_scratch' >                                                 â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/.work/w â”‚
â”‚ orktrees/vllm_core/vllm_core-0000/model_patch.diff || true                   â”‚
â”‚ finish                                                                       â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ START IMPLEMENTING IMMEDIATELY. NO MORE ANALYSIS.                            â”‚
â”‚                                                                              â”‚
â”‚ Must_patch: true                                                             â”‚
â”‚ Patch_path:                                                                  â”‚
â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-bench/state/r â”‚
â”‚ uns/vllm_core-f8009ca8/vllm_core-0000/model_patch.diff                       â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 1: Completed
â”‚ LLM         â”‚ ðŸ’¬ Plan:
â”‚ Response    â”‚ - Inspect repository for relevant code paths and current setting
â”‚             â”‚ - Run the provided grep to see torch.zeros/fill_ occurrences (re
â”‚             â”‚ - Create a timing script in .bench_scratch/test_opt.py to baseli
â”‚             â”‚ - Implement optimizations in vllm/config.py and vllm/envs.py (di
â”‚             â”‚ attn by default; add env var).
â”‚             â”‚ - Re-run timing script to compare.
â”‚             â”‚ - Commit changes and generate patch.
â”‚             â”‚
â”‚             â”‚ Running grep to inspect target files for torch.zeros/fill_ as di
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "grep -n 'torch.zeros\\|fill_'     â”‚
â”‚             â”‚ â”‚ vllm/model_executor/layers/fused_moe/moe_aligâ€¦ â”‚
â”‚             â”‚ â”‚ benchmarks/kernels/benchmark_moe_align_block_â€¦ â”‚
â”‚             â”‚ â”‚ || true", 'restart': False}                    â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 10226 Output: 1993
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 2: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '1,200p'                   â”‚ # SPDX-Licens
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ # SPDX-FileCo
â”‚             â”‚ â”‚ 'restart': False}                              â”‚ contributors
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ import ast
â”‚             â”‚ â”‚                                                â”‚ import copy
â”‚             â”‚ â”‚                                                â”‚ import enum
â”‚             â”‚ â”‚                                                â”‚ import hashli
â”‚             â”‚ â”‚                                                â”‚ import inspec
â”‚             â”‚ â”‚                                                â”‚ import json
â”‚             â”‚ â”‚                                                â”‚ import textwr
â”‚             â”‚ â”‚                                                â”‚ import uuid
â”‚             â”‚ â”‚                                                â”‚ import warnin
â”‚             â”‚ â”‚                                                â”‚ from collecti
â”‚             â”‚ â”‚                                                â”‚ from contextl
â”‚             â”‚ â”‚                                                â”‚ from dataclas
â”‚             â”‚ â”‚                                                â”‚ asdict, field
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ from functool
â”‚             â”‚ â”‚                                                â”‚ from importli
â”‚             â”‚ â”‚                                                â”‚ from typing i
â”‚             â”‚ â”‚                                                â”‚ Callable, Cla
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ cast, get_arg
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ import regex
â”‚             â”‚ â”‚                                                â”‚ import torch
â”‚             â”‚ â”‚                                                â”‚ from pydantic
â”‚             â”‚ â”‚                                                â”‚ SkipValidatio
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ from pydantic
â”‚             â”‚ â”‚                                                â”‚ from safetens
â”‚             â”‚ â”‚                                                â”‚ _SAFETENSORS_
â”‚             â”‚ â”‚                                                â”‚ from torch.di
â”‚             â”‚ â”‚                                                â”‚ ReduceOp
â”‚             â”‚ â”‚                                                â”‚ from typing_e
â”‚             â”‚ â”‚                                                â”‚ assert_never,
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ import vllm.e
â”‚             â”‚ â”‚                                                â”‚ from vllm imp
â”‚             â”‚ â”‚                                                â”‚ from vllm.com
â”‚             â”‚ â”‚                                                â”‚ CallableInduc
â”‚             â”‚ â”‚                                                â”‚ from vllm.log
â”‚             â”‚ â”‚                                                â”‚ from vllm.mod
â”‚             â”‚ â”‚                                                â”‚ import Quanti
â”‚             â”‚ â”‚                                                â”‚ from vllm.pla
â”‚             â”‚ â”‚                                                â”‚ from vllm.tra
â”‚             â”‚ â”‚                                                â”‚     ConfigFor
â”‚             â”‚ â”‚                                                â”‚ get_hf_image_
â”‚             â”‚ â”‚                                                â”‚     get_hf_te
â”‚             â”‚ â”‚                                                â”‚     get_sente
â”‚             â”‚ â”‚                                                â”‚ is_encoder_de
â”‚             â”‚ â”‚                                                â”‚     try_get_g
â”‚             â”‚ â”‚                                                â”‚ try_get_safet
â”‚             â”‚ â”‚                                                â”‚     try_get_t
â”‚             â”‚ â”‚                                                â”‚ from vllm.tra
â”‚             â”‚ â”‚                                                â”‚ S3Model
â”‚             â”‚ â”‚                                                â”‚ from vllm.tra
â”‚             â”‚ â”‚                                                â”‚ is_s3, maybe_
â”‚             â”‚ â”‚                                                â”‚ # yapf confli
â”‚             â”‚ â”‚                                                â”‚ # yapf: disab
â”‚             â”‚ â”‚                                                â”‚ from vllm.uti
â”‚             â”‚ â”‚                                                â”‚ (DEFAULT_MAX_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ GiB_bytes,
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ LazyLoader, c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ get_cpu_memor
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is_torch_equa
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # yapf: enabl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ if TYPE_CHECK
â”‚             â”‚ â”‚                                                â”‚     from _typ
â”‚             â”‚ â”‚                                                â”‚     from ray.
â”‚             â”‚ â”‚                                                â”‚ PlacementGrou
â”‚             â”‚ â”‚                                                â”‚     from tran
â”‚             â”‚ â”‚                                                â”‚ import Pretra
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     import
â”‚             â”‚ â”‚                                                â”‚ vllm.model_ex
â”‚             â”‚ â”‚                                                â”‚ me_quant
â”‚             â”‚ â”‚                                                â”‚     import vl
â”‚             â”‚ â”‚                                                â”‚ me_models
â”‚             â”‚ â”‚                                                â”‚     from vllm
â”‚             â”‚ â”‚                                                â”‚ ExecutorBase
â”‚             â”‚ â”‚                                                â”‚     from
â”‚             â”‚ â”‚                                                â”‚ vllm.model_ex
â”‚             â”‚ â”‚                                                â”‚ QuantizationM
â”‚             â”‚ â”‚                                                â”‚     from
â”‚             â”‚ â”‚                                                â”‚ vllm.model_ex
â”‚             â”‚ â”‚                                                â”‚ import (
â”‚             â”‚ â”‚                                                â”‚         Quant
â”‚             â”‚ â”‚                                                â”‚     from vllm
â”‚             â”‚ â”‚                                                â”‚ import LoadFo
â”‚             â”‚ â”‚                                                â”‚     from
â”‚             â”‚ â”‚                                                â”‚ vllm.model_ex
â”‚             â”‚ â”‚                                                â”‚ import Tensor
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     ConfigTyp
â”‚             â”‚ â”‚                                                â”‚     HfOverrid
â”‚             â”‚ â”‚                                                â”‚ else:
â”‚             â”‚ â”‚                                                â”‚     Dataclass
â”‚             â”‚ â”‚                                                â”‚     Placement
â”‚             â”‚ â”‚                                                â”‚     Pretraine
â”‚             â”‚ â”‚                                                â”‚     ExecutorB
â”‚             â”‚ â”‚                                                â”‚     Quantizat
â”‚             â”‚ â”‚                                                â”‚     Quantizat
â”‚             â”‚ â”‚                                                â”‚     BaseModel
â”‚             â”‚ â”‚                                                â”‚     LoadForma
â”‚             â”‚ â”‚                                                â”‚     Tensorize
â”‚             â”‚ â”‚                                                â”‚     ConfigTyp
â”‚             â”‚ â”‚                                                â”‚     HfOverrid
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     me_quant
â”‚             â”‚ â”‚                                                â”‚ globals(),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     me_models
â”‚             â”‚ â”‚                                                â”‚ globals(),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ logger = init
â”‚             â”‚ â”‚                                                â”‚ DataclassInst
â”‚             â”‚ â”‚                                                â”‚ TypeVar("Data
â”‚             â”‚ â”‚                                                â”‚ bound=Datacla
â”‚             â”‚ â”‚                                                â”‚ ConfigT = Typ
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ TaskOption =
â”‚             â”‚ â”‚                                                â”‚ "embedding",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "transcriptio
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ _ResolvedTask
â”‚             â”‚ â”‚                                                â”‚ "transcriptio
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "draft"]
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ RunnerOption
â”‚             â”‚ â”‚                                                â”‚ "pooling", "d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ RunnerType =
â”‚             â”‚ â”‚                                                â”‚ "draft"]
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ConvertOption
â”‚             â”‚ â”‚                                                â”‚ "embed", "cla
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ConvertType =
â”‚             â”‚ â”‚                                                â”‚ "classify", "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_TASKS
â”‚             â”‚ â”‚                                                â”‚ list[TaskOpti
â”‚             â”‚ â”‚                                                â”‚     "generate
â”‚             â”‚ â”‚                                                â”‚     "pooling"
â”‚             â”‚ â”‚                                                â”‚ "classify", "
â”‚             â”‚ â”‚                                                â”‚     "draft":
â”‚             â”‚ â”‚                                                â”‚ }
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_CONVE
â”‚             â”‚ â”‚                                                â”‚ list[ConvertT
â”‚             â”‚ â”‚                                                â”‚     "generate
â”‚             â”‚ â”‚                                                â”‚     "pooling"
â”‚             â”‚ â”‚                                                â”‚     "draft":
â”‚             â”‚ â”‚                                                â”‚ }
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # Some model
â”‚             â”‚ â”‚                                                â”‚ from Transfor
â”‚             â”‚ â”‚                                                â”‚ #
â”‚             â”‚ â”‚                                                â”‚ https://huggi
â”‚             â”‚ â”‚                                                â”‚ # NOTE: Items
â”‚             â”‚ â”‚                                                â”‚ lower ones
â”‚             â”‚ â”‚                                                â”‚ _SUFFIX_TO_DE
â”‚             â”‚ â”‚                                                â”‚ tuple[RunnerT
â”‚             â”‚ â”‚                                                â”‚     ("ForCaus
â”‚             â”‚ â”‚                                                â”‚     ("ForCond
â”‚             â”‚ â”‚                                                â”‚ "none")),
â”‚             â”‚ â”‚                                                â”‚     ("ChatMod
â”‚             â”‚ â”‚                                                â”‚     ("LMHeadM
â”‚             â”‚ â”‚                                                â”‚     ("ForText
â”‚             â”‚ â”‚                                                â”‚     ("Embeddi
â”‚             â”‚ â”‚                                                â”‚     ("ForSequ
â”‚             â”‚ â”‚                                                â”‚ "classify")),
â”‚             â”‚ â”‚                                                â”‚     ("ForAudi
â”‚             â”‚ â”‚                                                â”‚ "classify")),
â”‚             â”‚ â”‚                                                â”‚     ("ForImag
â”‚             â”‚ â”‚                                                â”‚ "classify")),
â”‚             â”‚ â”‚                                                â”‚     ("ForVide
â”‚             â”‚ â”‚                                                â”‚ "classify")),
â”‚             â”‚ â”‚                                                â”‚     ("Classif
â”‚             â”‚ â”‚                                                â”‚ "classify")),
â”‚             â”‚ â”‚                                                â”‚     ("ForRewa
â”‚             â”‚ â”‚                                                â”‚ "reward")),
â”‚             â”‚ â”‚                                                â”‚     ("RewardM
â”‚             â”‚ â”‚                                                â”‚     # Let oth
â”‚             â”‚ â”‚                                                â”‚     ("Model",
â”‚             â”‚ â”‚                                                â”‚ ]
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def iter_arch
â”‚             â”‚ â”‚                                                â”‚     yield fro
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def try_match
â”‚             â”‚ â”‚                                                â”‚     architect
â”‚             â”‚ â”‚                                                â”‚     *,
â”‚             â”‚ â”‚                                                â”‚     runner_ty
â”‚             â”‚ â”‚                                                â”‚     convert_t
â”‚             â”‚ â”‚                                                â”‚ ) -> Optional
â”‚             â”‚ â”‚                                                â”‚ ConvertType]]
â”‚             â”‚ â”‚                                                â”‚     for suffi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ iter_architec
â”‚             â”‚ â”‚                                                â”‚         if ((
â”‚             â”‚ â”‚                                                â”‚ == default_ru
â”‚             â”‚ â”‚                                                â”‚             (
â”‚             â”‚ â”‚                                                â”‚ convert_type
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ architecture.
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ (default_runn
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     return No
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @runtime_chec
â”‚             â”‚ â”‚                                                â”‚ class Support
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         ...
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ class Support
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def metri
â”‚             â”‚ â”‚                                                â”‚         ...
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ class ModelIm
â”‚             â”‚ â”‚                                                â”‚     AUTO = "a
â”‚             â”‚ â”‚                                                â”‚     VLLM = "v
â”‚             â”‚ â”‚                                                â”‚     TRANSFORM
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def get_attr_
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     Get any d
â”‚             â”‚ â”‚                                                â”‚ assignments i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     https://d
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def pairw
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         Manua
â”‚             â”‚ â”‚                                                â”‚ https://docs.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Can b
â”‚             â”‚ â”‚                                                â”‚ is dropped.
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         itera
â”‚             â”‚ â”‚                                                â”‚         a = n
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         for b
â”‚             â”‚ â”‚                                                â”‚             y
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 22463 Output: 2068
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 3: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '200,800p'                 â”‚             a
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ 'restart': False}                              â”‚     cls_node
â”‚             â”‚ â”‚                                                â”‚ ast.parse(tex
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     if not is
â”‚             â”‚ â”‚                                                â”‚         raise
â”‚             â”‚ â”‚                                                â”‚ class.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     out = {}
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Conside
â”‚             â”‚ â”‚                                                â”‚     for a, b
â”‚             â”‚ â”‚                                                â”‚         # Mus
â”‚             â”‚ â”‚                                                â”‚ string.
â”‚             â”‚ â”‚                                                â”‚         if (n
â”‚             â”‚ â”‚                                                â”‚ ast.AnnAssign
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ast.Constant)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ isinstance(b.
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         doc =
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # An
â”‚             â”‚ â”‚                                                â”‚ targets (a =
â”‚             â”‚ â”‚                                                â”‚         # ann
â”‚             â”‚ â”‚                                                â”‚ target.
â”‚             â”‚ â”‚                                                â”‚         targe
â”‚             â”‚ â”‚                                                â”‚ ast.Assign) e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         for t
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ name.
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ ast.Name):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     return ou
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def config(cl
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     A decorat
â”‚             â”‚ â”‚                                                â”‚ dataclass hav
â”‚             â”‚ â”‚                                                â”‚     and that
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     If a `Con
â”‚             â”‚ â”‚                                                â”‚ itself, the d
â”‚             â”‚ â”‚                                                â”‚     by `get_k
â”‚             â”‚ â”‚                                                â”‚ a JSON string
â”‚             â”‚ â”‚                                                â”‚     (i.e. `Co
â”‚             â”‚ â”‚                                                â”‚ However, if a
â”‚             â”‚ â”‚                                                â”‚     requires
â”‚             â”‚ â”‚                                                â”‚ `CompilationC
â”‚             â”‚ â”‚                                                â”‚     have a `f
â”‚             â”‚ â”‚                                                â”‚ called instea
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     Config va
â”‚             â”‚ â”‚                                                â”‚ tools/validat
â”‚             â”‚ â”‚                                                â”‚     script, w
â”‚             â”‚ â”‚                                                â”‚ pre-commit ch
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     return cl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def get_field
â”‚             â”‚ â”‚                                                â”‚ Field:
â”‚             â”‚ â”‚                                                â”‚     """Get th
â”‚             â”‚ â”‚                                                â”‚ dataclass by
â”‚             â”‚ â”‚                                                â”‚     default f
â”‚             â”‚ â”‚                                                â”‚     if not is
â”‚             â”‚ â”‚                                                â”‚         raise
â”‚             â”‚ â”‚                                                â”‚ a dataclass."
â”‚             â”‚ â”‚                                                â”‚     cls_field
â”‚             â”‚ â”‚                                                â”‚ fields(cls)}
â”‚             â”‚ â”‚                                                â”‚     if name n
â”‚             â”‚ â”‚                                                â”‚         raise
â”‚             â”‚ â”‚                                                â”‚ found in {cls
â”‚             â”‚ â”‚                                                â”‚     named_fie
â”‚             â”‚ â”‚                                                â”‚     if (defau
â”‚             â”‚ â”‚                                                â”‚ named_field.d
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     if (defau
â”‚             â”‚ â”‚                                                â”‚ MISSING:
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚     raise Val
â”‚             â”‚ â”‚                                                â”‚         f"{cl
â”‚             â”‚ â”‚                                                â”‚ default value
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def is_init_f
â”‚             â”‚ â”‚                                                â”‚ -> bool:
â”‚             â”‚ â”‚                                                â”‚     return ne
â”‚             â”‚ â”‚                                                â”‚ f.name == nam
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ TokenizerMode
â”‚             â”‚ â”‚                                                â”‚ "mistral", "c
â”‚             â”‚ â”‚                                                â”‚ ModelDType =
â”‚             â”‚ â”‚                                                â”‚ "bfloat16", "
â”‚             â”‚ â”‚                                                â”‚ LogprobsMode
â”‚             â”‚ â”‚                                                â”‚ "raw_logits",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass(co
â”‚             â”‚ â”‚                                                â”‚ class ModelCo
â”‚             â”‚ â”‚                                                â”‚     """Config
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     model: st
â”‚             â”‚ â”‚                                                â”‚     """Name o
â”‚             â”‚ â”‚                                                â”‚ to use. It is
â”‚             â”‚ â”‚                                                â”‚     content f
â”‚             â”‚ â”‚                                                â”‚ output when `
â”‚             â”‚ â”‚                                                â”‚     not speci
â”‚             â”‚ â”‚                                                â”‚     runner: R
â”‚             â”‚ â”‚                                                â”‚     """The ty
â”‚             â”‚ â”‚                                                â”‚ vLLM instance
â”‚             â”‚ â”‚                                                â”‚     model run
â”‚             â”‚ â”‚                                                â”‚ used for mult
â”‚             â”‚ â”‚                                                â”‚     convert:
â”‚             â”‚ â”‚                                                â”‚     """Conver
â”‚             â”‚ â”‚                                                â”‚ in
â”‚             â”‚ â”‚                                                â”‚     []. The m
â”‚             â”‚ â”‚                                                â”‚     adapt a t
â”‚             â”‚ â”‚                                                â”‚ for pooling t
â”‚             â”‚ â”‚                                                â”‚     task: Opt
â”‚             â”‚ â”‚                                                â”‚     """[DEPRE
â”‚             â”‚ â”‚                                                â”‚ for. If the m
â”‚             â”‚ â”‚                                                â”‚     than one
â”‚             â”‚ â”‚                                                â”‚ select which
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     Note that
â”‚             â”‚ â”‚                                                â”‚ using the sam
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     tokenizer
â”‚             â”‚ â”‚                                                â”‚ ignore
â”‚             â”‚ â”‚                                                â”‚     """Name o
â”‚             â”‚ â”‚                                                â”‚ tokenizer to
â”‚             â”‚ â”‚                                                â”‚     name or p
â”‚             â”‚ â”‚                                                â”‚     tokenizer
â”‚             â”‚ â”‚                                                â”‚     """Tokeni
â”‚             â”‚ â”‚                                                â”‚     - "auto"
â”‚             â”‚ â”‚                                                â”‚ available.\n
â”‚             â”‚ â”‚                                                â”‚     - "slow"
â”‚             â”‚ â”‚                                                â”‚ tokenizer.\n
â”‚             â”‚ â”‚                                                â”‚     - "mistra
â”‚             â”‚ â”‚                                                â”‚ from `mistral
â”‚             â”‚ â”‚                                                â”‚     - "custom
â”‚             â”‚ â”‚                                                â”‚ the preregist
â”‚             â”‚ â”‚                                                â”‚     trust_rem
â”‚             â”‚ â”‚                                                â”‚     """Trust
â”‚             â”‚ â”‚                                                â”‚ HuggingFace)
â”‚             â”‚ â”‚                                                â”‚     and token
â”‚             â”‚ â”‚                                                â”‚     dtype: Un
â”‚             â”‚ â”‚                                                â”‚ "auto"
â”‚             â”‚ â”‚                                                â”‚     """Data t
â”‚             â”‚ â”‚                                                â”‚ activations:\
â”‚             â”‚ â”‚                                                â”‚     - "auto"
â”‚             â”‚ â”‚                                                â”‚ and FP16 mode
â”‚             â”‚ â”‚                                                â”‚     precision
â”‚             â”‚ â”‚                                                â”‚     - "half"
â”‚             â”‚ â”‚                                                â”‚ quantization.
â”‚             â”‚ â”‚                                                â”‚     - "float1
â”‚             â”‚ â”‚                                                â”‚     - "bfloat
â”‚             â”‚ â”‚                                                â”‚ precision and
â”‚             â”‚ â”‚                                                â”‚     - "float"
â”‚             â”‚ â”‚                                                â”‚ precision.\n
â”‚             â”‚ â”‚                                                â”‚     - "float3
â”‚             â”‚ â”‚                                                â”‚     seed: Opt
â”‚             â”‚ â”‚                                                â”‚     """Random
â”‚             â”‚ â”‚                                                â”‚ Initialized t
â”‚             â”‚ â”‚                                                â”‚     initializ
â”‚             â”‚ â”‚                                                â”‚     hf_config
â”‚             â”‚ â”‚                                                â”‚     """Name o
â”‚             â”‚ â”‚                                                â”‚ to use. If un
â”‚             â”‚ â”‚                                                â”‚     name or p
â”‚             â”‚ â”‚                                                â”‚     allowed_l
â”‚             â”‚ â”‚                                                â”‚     """Allowi
â”‚             â”‚ â”‚                                                â”‚ images or vid
â”‚             â”‚ â”‚                                                â”‚     specified
â”‚             â”‚ â”‚                                                â”‚ is a security
â”‚             â”‚ â”‚                                                â”‚     be enable
â”‚             â”‚ â”‚                                                â”‚     revision:
â”‚             â”‚ â”‚                                                â”‚     """The sp
â”‚             â”‚ â”‚                                                â”‚ can be a bran
â”‚             â”‚ â”‚                                                â”‚     or a comm
â”‚             â”‚ â”‚                                                â”‚ the default v
â”‚             â”‚ â”‚                                                â”‚     code_revi
â”‚             â”‚ â”‚                                                â”‚     """The sp
â”‚             â”‚ â”‚                                                â”‚ model code on
â”‚             â”‚ â”‚                                                â”‚     It can be
â”‚             â”‚ â”‚                                                â”‚ commit id. If
â”‚             â”‚ â”‚                                                â”‚     use the d
â”‚             â”‚ â”‚                                                â”‚     rope_scal
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """RoPE s
â”‚             â”‚ â”‚                                                â”‚     `{"rope_t
â”‚             â”‚ â”‚                                                â”‚     rope_thet
â”‚             â”‚ â”‚                                                â”‚     """RoPE t
â”‚             â”‚ â”‚                                                â”‚ some cases, c
â”‚             â”‚ â”‚                                                â”‚     theta imp
â”‚             â”‚ â”‚                                                â”‚ scaled model.
â”‚             â”‚ â”‚                                                â”‚     tokenizer
â”‚             â”‚ â”‚                                                â”‚     """The sp
â”‚             â”‚ â”‚                                                â”‚ tokenizer on
â”‚             â”‚ â”‚                                                â”‚     It can be
â”‚             â”‚ â”‚                                                â”‚ commit id. If
â”‚             â”‚ â”‚                                                â”‚     use the d
â”‚             â”‚ â”‚                                                â”‚     max_model
â”‚             â”‚ â”‚                                                â”‚ type: ignore
â”‚             â”‚ â”‚                                                â”‚     """Model
â”‚             â”‚ â”‚                                                â”‚ output). If u
â”‚             â”‚ â”‚                                                â”‚     automatic
â”‚             â”‚ â”‚                                                â”‚ config.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     When pass
â”‚             â”‚ â”‚                                                â”‚ supports k/m/
â”‚             â”‚ â”‚                                                â”‚     format. E
â”‚             â”‚ â”‚                                                â”‚     - 1k -> 1
â”‚             â”‚ â”‚                                                â”‚     - 1K -> 1
â”‚             â”‚ â”‚                                                â”‚     - 25.6k -
â”‚             â”‚ â”‚                                                â”‚     spec_targ
â”‚             â”‚ â”‚                                                â”‚     """Specif
â”‚             â”‚ â”‚                                                â”‚ decoding draf
â”‚             â”‚ â”‚                                                â”‚     quantizat
â”‚             â”‚ â”‚                                                â”‚ SkipValidatio
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     """Method
â”‚             â”‚ â”‚                                                â”‚ `None`, we fi
â”‚             â”‚ â”‚                                                â”‚     `quantiza
â”‚             â”‚ â”‚                                                â”‚ model config
â”‚             â”‚ â”‚                                                â”‚     `None`, w
â”‚             â”‚ â”‚                                                â”‚ quantized and
â”‚             â”‚ â”‚                                                â”‚     determine
â”‚             â”‚ â”‚                                                â”‚     enforce_e
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ PyTorch. If T
â”‚             â”‚ â”‚                                                â”‚     graph and
â”‚             â”‚ â”‚                                                â”‚ mode. If Fals
â”‚             â”‚ â”‚                                                â”‚     CUDA grap
â”‚             â”‚ â”‚                                                â”‚ for maximal p
â”‚             â”‚ â”‚                                                â”‚     flexibili
â”‚             â”‚ â”‚                                                â”‚     max_seq_l
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ graphs. When
â”‚             â”‚ â”‚                                                â”‚     length la
â”‚             â”‚ â”‚                                                â”‚ eager mode. A
â”‚             â”‚ â”‚                                                â”‚     encoder-d
â”‚             â”‚ â”‚                                                â”‚ length of the
â”‚             â”‚ â”‚                                                â”‚     larger th
â”‚             â”‚ â”‚                                                â”‚ mode."""
â”‚             â”‚ â”‚                                                â”‚     max_logpr
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ return when `
â”‚             â”‚ â”‚                                                â”‚     specified
â”‚             â”‚ â”‚                                                â”‚ value comes t
â”‚             â”‚ â”‚                                                â”‚     OpenAI Ch
â”‚             â”‚ â”‚                                                â”‚     logprobs_
â”‚             â”‚ â”‚                                                â”‚ "raw_logprobs
â”‚             â”‚ â”‚                                                â”‚     """Indica
â”‚             â”‚ â”‚                                                â”‚ logprobs and
â”‚             â”‚ â”‚                                                â”‚     Supported
â”‚             â”‚ â”‚                                                â”‚     1) raw_lo
â”‚             â”‚ â”‚                                                â”‚ raw_logits, 4
â”‚             â”‚ â”‚                                                â”‚     Raw means
â”‚             â”‚ â”‚                                                â”‚ processors, l
â”‚             â”‚ â”‚                                                â”‚     Processed
â”‚             â”‚ â”‚                                                â”‚ such processo
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     disable_s
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ True, we will
â”‚             â”‚ â”‚                                                â”‚     window fu
â”‚             â”‚ â”‚                                                â”‚ to sliding wi
â”‚             â”‚ â”‚                                                â”‚     model doe
â”‚             â”‚ â”‚                                                â”‚ argument is i
â”‚             â”‚ â”‚                                                â”‚     disable_c
â”‚             â”‚ â”‚                                                â”‚     """Disabl
â”‚             â”‚ â”‚                                                â”‚ cascade atten
â”‚             â”‚ â”‚                                                â”‚     change th
â”‚             â”‚ â”‚                                                â”‚ disabling it
â”‚             â”‚ â”‚                                                â”‚     preventin
â”‚             â”‚ â”‚                                                â”‚ that even if
â”‚             â”‚ â”‚                                                â”‚     False, ca
â”‚             â”‚ â”‚                                                â”‚ when the heur
â”‚             â”‚ â”‚                                                â”‚     it's bene
â”‚             â”‚ â”‚                                                â”‚     skip_toke
â”‚             â”‚ â”‚                                                â”‚     """Skip i
â”‚             â”‚ â”‚                                                â”‚ detokenizer.
â”‚             â”‚ â”‚                                                â”‚     `prompt_t
â”‚             â”‚ â”‚                                                â”‚ from the inpu
â”‚             â”‚ â”‚                                                â”‚     output wi
â”‚             â”‚ â”‚                                                â”‚     enable_pr
â”‚             â”‚ â”‚                                                â”‚     """If `Tr
â”‚             â”‚ â”‚                                                â”‚ embeddings as
â”‚             â”‚ â”‚                                                â”‚     `prompt_e
â”‚             â”‚ â”‚                                                â”‚ this will dou
â”‚             â”‚ â”‚                                                â”‚     for graph
â”‚             â”‚ â”‚                                                â”‚     served_mo
â”‚             â”‚ â”‚                                                â”‚ list]] = None
â”‚             â”‚ â”‚                                                â”‚     """The mo
â”‚             â”‚ â”‚                                                â”‚ multiple name
â”‚             â”‚ â”‚                                                â”‚     server wi
â”‚             â”‚ â”‚                                                â”‚ names. The mo
â”‚             â”‚ â”‚                                                â”‚     model fie
â”‚             â”‚ â”‚                                                â”‚ name in this
â”‚             â”‚ â”‚                                                â”‚     specified
â”‚             â”‚ â”‚                                                â”‚ as the `--mod
â”‚             â”‚ â”‚                                                â”‚     that this
â”‚             â”‚ â”‚                                                â”‚ `model_name`
â”‚             â”‚ â”‚                                                â”‚     prometheu
â”‚             â”‚ â”‚                                                â”‚ provided, met
â”‚             â”‚ â”‚                                                â”‚     first one
â”‚             â”‚ â”‚                                                â”‚     limit_mm_
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ modality per
â”‚             â”‚ â”‚                                                â”‚     for multi
â”‚             â”‚ â”‚                                                â”‚     interleav
â”‚             â”‚ â”‚                                                â”‚     """Enable
â”‚             â”‚ â”‚                                                â”‚ multimodal pr
â”‚             â”‚ â”‚                                                â”‚     --chat-te
â”‚             â”‚ â”‚                                                â”‚ Defaults to F
â”‚             â”‚ â”‚                                                â”‚     media_io_
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Additi
â”‚             â”‚ â”‚                                                â”‚ inputs, keyed
â”‚             â”‚ â”‚                                                â”‚     For examp
â”‚             â”‚ â”‚                                                â”‚ set
â”‚             â”‚ â”‚                                                â”‚     `--media-
â”‚             â”‚ â”‚                                                â”‚ {"num_frames"
â”‚             â”‚ â”‚                                                â”‚     use_async
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ processor."""
â”‚             â”‚ â”‚                                                â”‚     config_fo
â”‚             â”‚ â”‚                                                â”‚ ConfigFormat.
â”‚             â”‚ â”‚                                                â”‚     """The fo
â”‚             â”‚ â”‚                                                â”‚ load:\n
â”‚             â”‚ â”‚                                                â”‚     - "auto"
â”‚             â”‚ â”‚                                                â”‚ format if ava
â”‚             â”‚ â”‚                                                â”‚     will try
â”‚             â”‚ â”‚                                                â”‚     - "hf" wi
â”‚             â”‚ â”‚                                                â”‚     - "mistra
â”‚             â”‚ â”‚                                                â”‚ format."""
â”‚             â”‚ â”‚                                                â”‚     hf_token:
â”‚             â”‚ â”‚                                                â”‚     """The to
â”‚             â”‚ â”‚                                                â”‚ authorization
â”‚             â”‚ â”‚                                                â”‚     `True`, w
â”‚             â”‚ â”‚                                                â”‚ running `hugg
â”‚             â”‚ â”‚                                                â”‚     (stored i
â”‚             â”‚ â”‚                                                â”‚     hf_overri
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """If a d
â”‚             â”‚ â”‚                                                â”‚ be forwarded
â”‚             â”‚ â”‚                                                â”‚     config. I
â”‚             â”‚ â”‚                                                â”‚ update the Hu
â”‚             â”‚ â”‚                                                â”‚     mm_proces
â”‚             â”‚ â”‚                                                â”‚     """Argume
â”‚             â”‚ â”‚                                                â”‚ processor for
â”‚             â”‚ â”‚                                                â”‚     e.g., ima
â”‚             â”‚ â”‚                                                â”‚ multi-modal p
â”‚             â”‚ â”‚                                                â”‚     from `Aut
â”‚             â”‚ â”‚                                                â”‚ available ove
â”‚             â”‚ â”‚                                                â”‚     model tha
â”‚             â”‚ â”‚                                                â”‚ Phi-3-Vision:
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     disable_m
â”‚             â”‚ â”‚                                                â”‚     """If `Tr
â”‚             â”‚ â”‚                                                â”‚ multi-modal p
â”‚             â”‚ â”‚                                                â”‚     recommend
â”‚             â”‚ â”‚                                                â”‚     override_
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Initia
â”‚             â”‚ â”‚                                                â”‚ override defa
â”‚             â”‚ â”‚                                                â”‚     that are
â”‚             â”‚ â”‚                                                â”‚ argument will
â”‚             â”‚ â”‚                                                â”‚     configure
â”‚             â”‚ â”‚                                                â”‚ gathered from
â”‚             â”‚ â”‚                                                â”‚     arguments
â”‚             â”‚ â”‚                                                â”‚ "bfloat16"}`.
â”‚             â”‚ â”‚                                                â”‚     pooler_co
â”‚             â”‚ â”‚                                                â”‚ field(init=Fa
â”‚             â”‚ â”‚                                                â”‚     """Pooler
â”‚             â”‚ â”‚                                                â”‚ behaviour of
â”‚             â”‚ â”‚                                                â”‚     models.""
â”‚             â”‚ â”‚                                                â”‚     override_
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     """Initia
â”‚             â”‚ â”‚                                                â”‚ override defa
â”‚             â”‚ â”‚                                                â”‚     for the p
â”‚             â”‚ â”‚                                                â”‚ `{"pooling_ty
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     logits_pr
â”‚             â”‚ â”‚                                                â”‚     """Option
â”‚             â”‚ â”‚                                                â”‚ logits proces
â”‚             â”‚ â”‚                                                â”‚     that can
â”‚             â”‚ â”‚                                                â”‚ `logits_proce
â”‚             â”‚ â”‚                                                â”‚     Defaults
â”‚             â”‚ â”‚                                                â”‚ processors.""
â”‚             â”‚ â”‚                                                â”‚     generatio
â”‚             â”‚ â”‚                                                â”‚     """The fo
â”‚             â”‚ â”‚                                                â”‚ config. Defau
â”‚             â”‚ â”‚                                                â”‚     generatio
â”‚             â”‚ â”‚                                                â”‚ path. If set
â”‚             â”‚ â”‚                                                â”‚     generatio
â”‚             â”‚ â”‚                                                â”‚ will be used.
â”‚             â”‚ â”‚                                                â”‚     path, the
â”‚             â”‚ â”‚                                                â”‚ from the spec
â”‚             â”‚ â”‚                                                â”‚     If `max_n
â”‚             â”‚ â”‚                                                â”‚ generation co
â”‚             â”‚ â”‚                                                â”‚     server-wi
â”‚             â”‚ â”‚                                                â”‚ tokens for al
â”‚             â”‚ â”‚                                                â”‚     override_
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Overri
â”‚             â”‚ â”‚                                                â”‚ e.g. `{"tempe
â”‚             â”‚ â”‚                                                â”‚     used with
â”‚             â”‚ â”‚                                                â”‚ override para
â”‚             â”‚ â”‚                                                â”‚     merged wi
â”‚             â”‚ â”‚                                                â”‚ model. If use
â”‚             â”‚ â”‚                                                â”‚     `--genera
â”‚             â”‚ â”‚                                                â”‚ override para
â”‚             â”‚ â”‚                                                â”‚     enable_sl
â”‚             â”‚ â”‚                                                â”‚     """Enable
â”‚             â”‚ â”‚                                                â”‚ cuda platform
â”‚             â”‚ â”‚                                                â”‚     model_imp
â”‚             â”‚ â”‚                                                â”‚     """Which
â”‚             â”‚ â”‚                                                â”‚ use:\n
â”‚             â”‚ â”‚                                                â”‚     - "auto"
â”‚             â”‚ â”‚                                                â”‚ implementatio
â”‚             â”‚ â”‚                                                â”‚     back to t
â”‚             â”‚ â”‚                                                â”‚ no vLLM imple
â”‚             â”‚ â”‚                                                â”‚     available
â”‚             â”‚ â”‚                                                â”‚     - "vllm"
â”‚             â”‚ â”‚                                                â”‚ implementatio
â”‚             â”‚ â”‚                                                â”‚     - "transf
â”‚             â”‚ â”‚                                                â”‚ model impleme
â”‚             â”‚ â”‚                                                â”‚     override_
â”‚             â”‚ â”‚                                                â”‚     """Overri
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         WARNI
â”‚             â”‚ â”‚                                                â”‚ to this confi
â”‚             â”‚ â”‚                                                â”‚         ensur
â”‚             â”‚ â”‚                                                â”‚ factors list
â”‚             â”‚ â”‚                                                â”‚         it af
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         # hf_
â”‚             â”‚ â”‚                                                â”‚ looks!
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         str_f
â”‚             â”‚ â”‚                                                â”‚         asser
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ hashlib.sha25
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚         # Set
â”‚             â”‚ â”‚                                                â”‚         # NOT
â”‚             â”‚ â”‚                                                â”‚ default seed
â”‚             â”‚ â”‚                                                â”‚         # dri
â”‚             â”‚ â”‚                                                â”‚ as the user p
â”‚             â”‚ â”‚                                                â”‚         # set
â”‚             â”‚ â”‚                                                â”‚ process as we
â”‚             â”‚ â”‚                                                â”‚         # In
â”‚             â”‚ â”‚                                                â”‚ workers (unle
â”‚             â”‚ â”‚                                                â”‚         # VLL
â”‚             â”‚ â”‚                                                â”‚ setting a see
â”‚             â”‚ â”‚                                                â”‚         # doe
â”‚             â”‚ â”‚                                                â”‚ However, with
â”‚             â”‚ â”‚                                                â”‚         # dif
â”‚             â”‚ â”‚                                                â”‚ would sample
â”‚             â”‚ â”‚                                                â”‚         # lea
â”‚             â”‚ â”‚                                                â”‚         if en
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_ENA
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ set to %d. Si
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is set to Fal
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ the Python pr
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.seed)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Kee
â”‚             â”‚ â”‚                                                â”‚ maybe_model_r
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ get_served_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ maybe_model_r
â”‚             â”‚ â”‚                                                â”‚         # The
â”‚             â”‚ â”‚                                                â”‚ model by defa
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ self.revision
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ maybe_model_r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if is
â”‚             â”‚ â”‚                                                â”‚ str):
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ maybe_model_r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if ca
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ {"rope_scalin
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ json.dumps(hf
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ removed in a
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ `--hf-overrid
â”‚             â”‚ â”‚                                                â”‚             w
â”‚             â”‚ â”‚                                                â”‚ stacklevel=2)
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ self.rope_the
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ json.dumps(hf
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ in a future r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ `--hf-overrid
â”‚             â”‚ â”‚                                                â”‚             w
â”‚             â”‚ â”‚                                                â”‚ stacklevel=2)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.tokenize
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (b
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_ATT
â”‚             â”‚ â”‚                                                â”‚             )
â”‚             â”‚ â”‚                                                â”‚ find_spec("fl
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ to FLASHINFER
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "  # noqa: E5
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ install it.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚ not None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             w
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ set but not u
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ current platf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if is
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ ConfigFormat(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # Optimizatio
â”‚             â”‚ â”‚                                                â”‚ torch.zeros w
â”‚             â”‚ â”‚                                                â”‚ def optimized
â”‚             â”‚ â”‚                                                â”‚     return to
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # Optimizatio
â”‚             â”‚ â”‚                                                â”‚ operations
â”‚             â”‚ â”‚                                                â”‚ # Example usa
â”‚             â”‚ â”‚                                                â”‚ # tensor = op
â”‚             â”‚ â”‚                                                â”‚ 10))
â”‚             â”‚ â”‚                                                â”‚     # Optimiz
â”‚             â”‚ â”‚                                                â”‚ torch.zeros w
â”‚             â”‚ â”‚                                                â”‚     if hasatt
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ torch.empty(s
â”‚             â”‚ â”‚                                                â”‚ device=self.s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Optimiz
â”‚             â”‚ â”‚                                                â”‚ operations
â”‚             â”‚ â”‚                                                â”‚     if hasatt
â”‚             â”‚ â”‚                                                â”‚ 'another_tens
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         hf_co
â”‚             â”‚ â”‚                                                â”‚ get_config(se
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ get_hf_text_c
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self._get_enc
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ get_hf_image_
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ revision=self
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         regis
â”‚             â”‚ â”‚                                                â”‚         is_ge
â”‚             â”‚ â”‚                                                â”‚ registry.is_t
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â”‚                                                â”‚         is_po
â”‚             â”‚ â”‚                                                â”‚ registry.is_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         def _
â”‚             â”‚ â”‚                                                â”‚ -> ConvertTyp
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ "embed":
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self._get_def
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ == "classify"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚ has been depr
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ or v1.0, whic
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚ option."
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_TASKS
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_TASKS
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ is_pooling_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ this option w
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ continue usin
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ generative mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ this option w
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ continue usin
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ model.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ is_pooling_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ this option"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ _task_to_conv
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ this option w
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ continue usin
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ model.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ should be a g
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ model when ta
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚             w
â”‚             â”‚ â”‚                                                â”‚ DeprecationWa
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self._get_run
â”‚             â”‚ â”‚                                                â”‚ self.runner)
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self._get_con
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ not is_genera
â”‚             â”‚ â”‚                                                â”‚             g
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_CONVE
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ generate_conv
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ converters fo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ support `--ru
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ not is_poolin
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_CONVE
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ pooling_conve
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "|".join(pool
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ support `--ru
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {convert_opti
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self._get_sup
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â”‚                                                â”‚ self.convert_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Not
â”‚             â”‚ â”‚                                                â”‚ early because
â”‚             â”‚ â”‚                                                â”‚         # may
â”‚             â”‚ â”‚                                                â”‚ child process
â”‚             â”‚ â”‚                                                â”‚         model
â”‚             â”‚ â”‚                                                â”‚ registry.insp
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚         logge
â”‚             â”‚ â”‚                                                â”‚ %s", arch)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self._init_po
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ == "pooling",
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚         )
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Wor
â”‚             â”‚ â”‚                                                â”‚ interleaved s
â”‚             â”‚ â”‚                                                â”‚         # att
â”‚             â”‚ â”‚                                                â”‚ its config. T
â”‚             â”‚ â”‚                                                â”‚         # whe
â”‚             â”‚ â”‚                                                â”‚ Transformers.
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ "gemma2":
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = 2
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         slidi
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚         slidi
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚         has_i
â”‚             â”‚ â”‚                                                â”‚ sliding_windo
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚ has_interleav
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ in ("XFORMERS
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ get_min_slidi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ attention, wh
â”‚             â”‚ â”‚                                                â”‚ the %s backen
â”‚             â”‚ â”‚                                                â”‚ capping the m
â”‚             â”‚ â”‚                                                â”‚ size (%d).",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ True
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ attention,
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ treat it as f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ tokens outsid
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ itself is awa
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ size to compu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = sliding_win
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "sliding_wind
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "sliding_wind
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.max_mode
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.get_and_
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self._init_mu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (n
â”‚             â”‚ â”‚                                                â”‚ and self.over
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ only supporte
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @field_va
â”‚             â”‚ â”‚                                                â”‚ mode="before"
â”‚             â”‚ â”‚                                                â”‚     @classmet
â”‚             â”‚ â”‚                                                â”‚     def valid
â”‚             â”‚ â”‚                                                â”‚ value: Any) -
â”‚             â”‚ â”‚                                                â”‚         if is
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @model_va
â”‚             â”‚ â”‚                                                â”‚     def valid
â”‚             â”‚ â”‚                                                â”‚ "ModelConfig"
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 36523 Output: 2141
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 4: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '800,1600p'                â”‚     def valid
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ "ModelConfig"
â”‚             â”‚ â”‚ 'restart': False}                              â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ a string afte
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚ int):
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ integer after
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚ str:
â”‚             â”‚ â”‚                                                â”‚         """De
â”‚             â”‚ â”‚                                                â”‚ class will be
â”‚             â”‚ â”‚                                                â”‚         `mode
â”‚             â”‚ â”‚                                                â”‚ or `auto`."""
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ as 'hf_config
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ multimodal
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ "Transformers
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def regis
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def archi
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "architecture
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def archi
â”‚             â”‚ â”‚                                                â”‚         """Th
â”‚             â”‚ â”‚                                                â”‚ used."""
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def maybe
â”‚             â”‚ â”‚                                                â”‚ model: str,
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ str) -> None:
â”‚             â”‚ â”‚                                                â”‚         """Pu
â”‚             â”‚ â”‚                                                â”‚ temporary dir
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Args:
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚ is_s3(tokeniz
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if is
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "*.py", "*.js
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ download to s
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "*.safetensor
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Onl
â”‚             â”‚ â”‚                                                â”‚ not already h
â”‚             â”‚ â”‚                                                â”‚         if is
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "*.safetensor
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _init
â”‚             â”‚ â”‚                                                â”‚ Optional["Mul
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ self.registry
â”‚             â”‚ â”‚                                                â”‚ self):
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ ValueError("`
â”‚             â”‚ â”‚                                                â”‚ supported for
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ models.")
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ ValueError("`
â”‚             â”‚ â”‚                                                â”‚ supported for
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ models.")
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ ValueError("`
â”‚             â”‚ â”‚                                                â”‚ only "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ multimodal mo
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ ValueError("`
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ multimodal mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ get_sentence_
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _init
â”‚             â”‚ â”‚                                                â”‚ Optional["Poo
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ isinstance(se
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ PoolerConfig(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚ self.override
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             b
â”‚             â”‚ â”‚                                                â”‚ get_pooling_c
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ overridden by
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ base_config.i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ k) is None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ k, v)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ True
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ pooler_config
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enabled (set
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ compatible wi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Representatio
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         token
â”‚             â”‚ â”‚                                                â”‚ self.tokenize
â”‚             â”‚ â”‚                                                â”‚         if to
â”‚             â”‚ â”‚                                                â”‚ get_args(Toke
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {self.tokeniz
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {get_args(Tok
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚     ) -> Runn
â”‚             â”‚ â”‚                                                â”‚         regis
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Som
â”‚             â”‚ â”‚                                                â”‚ *ForCausalLM
â”‚             â”‚ â”‚                                                â”‚         if ge
â”‚             â”‚ â”‚                                                â”‚ self.revision
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         for a
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ registry.get_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ registry.is_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ registry.is_t
â”‚             â”‚ â”‚                                                â”‚ self):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚ try_match_arc
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         runne
â”‚             â”‚ â”‚                                                â”‚     ) -> Runn
â”‚             â”‚ â”‚                                                â”‚         if ru
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         runne
â”‚             â”‚ â”‚                                                â”‚ self._get_def
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Don
â”‚             â”‚ â”‚                                                â”‚         if ru
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ `--runner %s`
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ silence this
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         runne
â”‚             â”‚ â”‚                                                â”‚     ) -> Conv
â”‚             â”‚ â”‚                                                â”‚         regis
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         for a
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ registry.get_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ registry.is_t
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self)):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ registry.is_p
â”‚             â”‚ â”‚                                                â”‚ self)):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚ try_match_arc
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Thi
â”‚             â”‚ â”‚                                                â”‚ Transformers
â”‚             â”‚ â”‚                                                â”‚         # and
â”‚             â”‚ â”‚                                                â”‚ which are not
â”‚             â”‚ â”‚                                                â”‚         # Sen
â”‚             â”‚ â”‚                                                â”‚         if ru
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         runne
â”‚             â”‚ â”‚                                                â”‚         conve
â”‚             â”‚ â”‚                                                â”‚     ) -> Conv
â”‚             â”‚ â”‚                                                â”‚         if co
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         conve
â”‚             â”‚ â”‚                                                â”‚ self._get_def
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Don
â”‚             â”‚ â”‚                                                â”‚         if co
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ `--convert %s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ silence this
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         conve
â”‚             â”‚ â”‚                                                â”‚     ) -> list
â”‚             â”‚ â”‚                                                â”‚         regis
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ registry.is_t
â”‚             â”‚ â”‚                                                â”‚ self):
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # TOD
â”‚             â”‚ â”‚                                                â”‚ get_supported
â”‚             â”‚ â”‚                                                â”‚ removed
â”‚             â”‚ â”‚                                                â”‚         suppo
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ (registry.is_
â”‚             â”‚ â”‚                                                â”‚ self)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_CONVE
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ registry.is_t
â”‚             â”‚ â”‚                                                â”‚ self):
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚     ) -> Lite
â”‚             â”‚ â”‚                                                â”‚ "reward"]:
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ self.registry
â”‚             â”‚ â”‚                                                â”‚ self):
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         for a
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚ try_match_arc
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         conve
â”‚             â”‚ â”‚                                                â”‚     ) -> list
â”‚             â”‚ â”‚                                                â”‚         regis
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # TOD
â”‚             â”‚ â”‚                                                â”‚ once V0 is re
â”‚             â”‚ â”‚                                                â”‚         suppo
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ (registry.is_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ _RUNNER_CONVE
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ (self._get_de
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "none" else c
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         runne
â”‚             â”‚ â”‚                                                â”‚         conve
â”‚             â”‚ â”‚                                                â”‚     ) -> list
â”‚             â”‚ â”‚                                                â”‚         if ru
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ self._get_sup
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if ru
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ self._get_sup
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if ru
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         asser
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _pars
â”‚             â”‚ â”‚                                                â”‚         quant
â”‚             â”‚ â”‚                                                â”‚ "quantization
â”‚             â”‚ â”‚                                                â”‚         if qu
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ "compression_
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚ "compression_
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         suppo
â”‚             â”‚ â”‚                                                â”‚ me_quant.QUAN
â”‚             â”‚ â”‚                                                â”‚         optim
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ "gptq_marlin_
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ "compressed-t
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ "gptq_bitblas
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ cast(me_quant
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Par
â”‚             â”‚ â”‚                                                â”‚ model config,
â”‚             â”‚ â”‚                                                â”‚         quant
â”‚             â”‚ â”‚                                                â”‚ self._parse_q
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if qu
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ 'quant_method
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚ quant_cfg.get
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚ quant_method.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚ quant_method
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ overrides (i.
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ method) must
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ particularly
â”‚             â”‚ â”‚                                                â”‚             o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             ]
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ supported_qua
â”‚             â”‚ â”‚                                                â”‚             ]
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ quantization_
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ custom overri
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚ quantization_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ me_quant.get_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ method.overri
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.quantiza
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ override is n
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ QUANTIZATION_
â”‚             â”‚ â”‚                                                â”‚ QuantizationM
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ the overrides
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ get_args(me_q
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ overrides):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ method {name}
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ added to the
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ necessary to
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ checked in or
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ quantization_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ quantization_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ configuration
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ quant_method
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ quant_method:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ specified in
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ match the qua
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ `quantization
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ supported_qua
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ method: {self
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {supported_qu
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ optimized_qua
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ fully "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ can be slower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.quantiza
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ min(self.max_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # CUD
â”‚             â”‚ â”‚                                                â”‚ enc-dec model
â”‚             â”‚ â”‚                                                â”‚         ROCM_
â”‚             â”‚ â”‚                                                â”‚         unsup
â”‚             â”‚ â”‚                                                â”‚ (self.hf_conf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ROCM_UNSUPPOR
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.is_encod
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (u
â”‚             â”‚ â”‚                                                â”‚ self.enforce_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ for %s on ROC
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.hf_confi
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         The c
â”‚             â”‚ â”‚                                                â”‚ (0.46.1) with
â”‚             â”‚ â”‚                                                â”‚         yet s
â”‚             â”‚ â”‚                                                â”‚         # TOD
â”‚             â”‚ â”‚                                                â”‚ supports.
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         is_bi
â”‚             â”‚ â”‚                                                â”‚ "bitsandbytes
â”‚             â”‚ â”‚                                                â”‚         has_q
â”‚             â”‚ â”‚                                                â”‚ (getattr(self
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         is_8b
â”‚             â”‚ â”‚                                                â”‚ (self.hf_conf
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ has_quantizat
â”‚             â”‚ â”‚                                                â”‚         if al
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         ]):
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ BitsAndBytes
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚ -> None:
â”‚             â”‚ â”‚                                                â”‚         num_e
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚         num_e
â”‚             â”‚ â”‚                                                â”‚         for n
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if nu
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ must be great
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enabled.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def verif
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         load_
â”‚             â”‚ â”‚                                                â”‚     ) -> None
â”‚             â”‚ â”‚                                                â”‚         if ha
â”‚             â”‚ â”‚                                                â”‚ "dual_chunk_a
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ config
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ vllm.model_ex
â”‚             â”‚ â”‚                                                â”‚ import (
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ get_sparse_at
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = sparse_attn
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not in \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def verif
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ -> None:
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Rem
â”‚             â”‚ â”‚                                                â”‚ docs/features
â”‚             â”‚ â”‚                                                â”‚         # If
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if en
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Asy
â”‚             â”‚ â”‚                                                â”‚ for pooling m
â”‚             â”‚ â”‚                                                â”‚         # sin
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Rem
â”‚             â”‚ â”‚                                                â”‚ docs/features
â”‚             â”‚ â”‚                                                â”‚         # If
â”‚             â”‚ â”‚                                                â”‚         if sp
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def verif
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         paral
â”‚             â”‚ â”‚                                                â”‚     ) -> None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚ "external_lau
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ external laun
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ the same acro
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         total
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 0)
â”‚             â”‚ â”‚                                                â”‚         tenso
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚         if to
â”‚             â”‚ â”‚                                                â”‚ tensor_parall
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ heads ({total
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ parallel size
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         pipel
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚         if pi
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.registry
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not supported
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ the `Supports
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_h
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ list[Optional
â”‚             â”‚ â”‚                                                â”‚         """Ge
â”‚             â”‚ â”‚                                                â”‚ if disabled."
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Som
â”‚             â”‚ â”‚                                                â”‚ use `use_slid
â”‚             â”‚ â”‚                                                â”‚         # add
â”‚             â”‚ â”‚                                                â”‚ check if that
â”‚             â”‚ â”‚                                                â”‚         # and
â”‚             â”‚ â”‚                                                â”‚         if (h
â”‚             â”‚ â”‚                                                â”‚ "use_sliding_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "sliding_wind
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_s
â”‚             â”‚ â”‚                                                â”‚ Optional[Unio
â”‚             â”‚ â”‚                                                â”‚         """Ge
â”‚             â”‚ â”‚                                                â”‚ if disabled.
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         # If
â”‚             â”‚ â”‚                                                â”‚ return None.
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚         # Oth
â”‚             â”‚ â”‚                                                â”‚ config.
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self.get_hf_c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_v
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "vocab_size",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_h
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "hidden_size"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_de
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚ "model_type")
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚ \
â”‚             â”‚ â”‚                                                â”‚             (
â”‚             â”‚ â”‚                                                â”‚ 'deepseek_mtp
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚ 'eagle':
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ check for the
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 'deepseek_v3'
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_h
â”‚             â”‚ â”‚                                                â”‚         # TOD
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚ "qk_rope_head
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚ qk_rope_head_
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 0)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ qk_nope_head_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ qk_nope_head_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if ha
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ (self.hf_text
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "zamba2"):
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # NOT
â”‚             â”‚ â”‚                                                â”‚ head_dim=None
â”‚             â”‚ â”‚                                                â”‚         if ge
â”‚             â”‚ â”‚                                                â”‚ "head_dim", N
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # FIX
â”‚             â”‚ â”‚                                                â”‚ for all model
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ //
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_t
â”‚             â”‚ â”‚                                                â”‚         """Re
â”‚             â”‚ â”‚                                                â”‚ heads."""
â”‚             â”‚ â”‚                                                â”‚         # For
â”‚             â”‚ â”‚                                                â”‚         # NOT
â”‚             â”‚ â”‚                                                â”‚ new_decoder_a
â”‚             â”‚ â”‚                                                â”‚         # mul
â”‚             â”‚ â”‚                                                â”‚ use n_head_kv
â”‚             â”‚ â”‚                                                â”‚         # KV
â”‚             â”‚ â”‚                                                â”‚         falco
â”‚             â”‚ â”‚                                                â”‚ "RefinedWeb",
â”‚             â”‚ â”‚                                                â”‚         new_d
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ falcon_model_
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â”‚                                                â”‚ "new_decoder_
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ False):
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ KV head.
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ not supported
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # For
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.hf_confi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.hf_confi
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ self.hf_confi
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚ "kv_n_heads",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ "nemotron-nas
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ self.hf_confi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.hf_confi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ block.attenti
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ determine num
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         attri
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚         for a
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # For
â”‚             â”‚ â”‚                                                â”‚ models, the n
â”‚             â”‚ â”‚                                                â”‚         # equ
â”‚             â”‚ â”‚                                                â”‚ heads.
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self.hf_text_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_n
â”‚             â”‚ â”‚                                                â”‚ "ParallelConf
â”‚             â”‚ â”‚                                                â”‚         """Re
â”‚             â”‚ â”‚                                                â”‚ GPU."""
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ becomes MQA
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         total
â”‚             â”‚ â”‚                                                â”‚ self.get_tota
â”‚             â”‚ â”‚                                                â”‚         # If
â”‚             â”‚ â”‚                                                â”‚ divide the nu
â”‚             â”‚ â”‚                                                â”‚         # the
â”‚             â”‚ â”‚                                                â”‚ replicate the
â”‚             â”‚ â”‚                                                â”‚         # cas
â”‚             â”‚ â”‚                                                â”‚ smaller than
â”‚             â”‚ â”‚                                                â”‚         # par
â”‚             â”‚ â”‚                                                â”‚ least one KV
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_n
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "ParallelConf
â”‚             â”‚ â”‚                                                â”‚         num_h
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚ "num_attentio
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_l
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ "ParallelConf
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ get_pp_indice
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚ "deepseek_mtp
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "mimo_mtp"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "glm4_moe_mtp
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 0)
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 0)
â”‚             â”‚ â”‚                                                â”‚         # the
â”‚             â”‚ â”‚                                                â”‚         pp_ra
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚         pp_si
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚         start
â”‚             â”‚ â”‚                                                â”‚ get_pp_indice
â”‚             â”‚ â”‚                                                â”‚ pp_rank, pp_s
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_n
â”‚             â”‚ â”‚                                                â”‚ "ParallelConf
â”‚             â”‚ â”‚                                                â”‚         start
â”‚             â”‚ â”‚                                                â”‚ self.get_laye
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_n
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         paral
â”‚             â”‚ â”‚                                                â”‚         block
â”‚             â”‚ â”‚                                                â”‚ LayerBlockTyp
â”‚             â”‚ â”‚                                                â”‚     ) -> int:
â”‚             â”‚ â”‚                                                â”‚         # Thi
â”‚             â”‚ â”‚                                                â”‚ 'layers_block
â”‚             â”‚ â”‚                                                â”‚         # for
â”‚             â”‚ â”‚                                                â”‚ to have worka
â”‚             â”‚ â”‚                                                â”‚         attn_
â”‚             â”‚ â”‚                                                â”‚ LayerBlockTyp
â”‚             â”‚ â”‚                                                â”‚         is_tr
â”‚             â”‚ â”‚                                                â”‚ \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ and \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.is_atten
â”‚             â”‚ â”‚                                                â”‚         start
â”‚             â”‚ â”‚                                                â”‚ self.get_laye
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if is
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ attn_block_ty
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ attention-fre
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ end - start
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚             b
â”‚             â”‚ â”‚                                                â”‚ self.hf_confi
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ (self.hf_text
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "zamba2"):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "hybrid"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ layers_block_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.get_num_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ block_type.va
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ layers_block_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ attn_type_lis
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ and attn_type
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ without a"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ attn_type_lis
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ of "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ layers")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ attn_type_lis
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_m
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         Retur
â”‚             â”‚ â”‚                                                â”‚ exists
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         # use
â”‚             â”‚ â”‚                                                â”‚ Granite, PLaM
â”‚             â”‚ â”‚                                                â”‚         chunk
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚ "mamba_chunk_
â”‚             â”‚ â”‚                                                â”‚         if ch
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ Zamba
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_m
â”‚             â”‚ â”‚                                                â”‚ "MultiModalCo
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         Get t
â”‚             â”‚ â”‚                                                â”‚ model.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Raise
â”‚             â”‚ â”‚                                                â”‚             V
â”‚             â”‚ â”‚                                                â”‚ multimodal.
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ multimodal.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def try_g
â”‚             â”‚ â”‚                                                â”‚ dict:
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ "vllm"):
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.model,
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             )
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             )
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if co
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_d
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         This
â”‚             â”‚ â”‚                                                â”‚ containing th
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 57106 Output: 2215
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 5: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '1600,3200p'               â”‚         This
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ containing th
â”‚             â”‚ â”‚ 'restart': False}                              â”‚         that
â”‚             â”‚ â”‚                                                â”‚ parameters. I
â”‚             â”‚ â”‚                                                â”‚         `gene
â”‚             â”‚ â”‚                                                â”‚ empty diction
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Retur
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚ differing sam
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚ is `"vllm"` a
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚ self.try_get_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Ove
â”‚             â”‚ â”‚                                                â”‚ config
â”‚             â”‚ â”‚                                                â”‚         confi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         avail
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚         if an
â”‚             â”‚ â”‚                                                â”‚ available_par
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ config.get(p)
â”‚             â”‚ â”‚                                                â”‚             }
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ max_new_token
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ diff_sampling
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = diff_sampli
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if di
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ have been ove
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ generation co
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ intended, ple
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ `--generation
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_en
â”‚             â”‚ â”‚                                                â”‚         """Ex
â”‚             â”‚ â”‚                                                â”‚ flag."""
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         For M
â”‚             â”‚ â”‚                                                â”‚ is_encoder_de
â”‚             â”‚ â”‚                                                â”‚         True
â”‚             â”‚ â”‚                                                â”‚         Neuro
â”‚             â”‚ â”‚                                                â”‚ in the decode
â”‚             â”‚ â”‚                                                â”‚         need
â”‚             â”‚ â”‚                                                â”‚ cross-attenti
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         if (c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ == "mllama"):
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ is_encoder_de
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def uses_
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_mu
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_cr
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ (self._model_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "classify")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_pp
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_mu
â”‚             â”‚ â”‚                                                â”‚ -> bool:
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self._model_i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_at
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self._model_i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_hy
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def has_n
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def has_i
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_v1
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self._model_i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def use_m
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_MLA
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_ma
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "matryoshka_d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "is_matryoshk
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def matry
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "matryoshka_d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def use_p
â”‚             â”‚ â”‚                                                â”‚         # cro
â”‚             â”‚ â”‚                                                â”‚ using pad_tok
â”‚             â”‚ â”‚                                                â”‚         # `ll
â”‚             â”‚ â”‚                                                â”‚ not using pad
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "use_pad_toke
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_a
â”‚             â”‚ â”‚                                                â”‚ max_model_len
â”‚             â”‚ â”‚                                                â”‚         # Con
â”‚             â”‚ â”‚                                                â”‚ tokenizer_con
â”‚             â”‚ â”‚                                                â”‚         # poo
â”‚             â”‚ â”‚                                                â”‚ position_embe
â”‚             â”‚ â”‚                                                â”‚         token
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚ getattr(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "position_emb
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚ try_get_token
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         max_m
â”‚             â”‚ â”‚                                                â”‚ _get_and_veri
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚         logge
â”‚             â”‚ â”‚                                                â”‚ max_model_len
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ BlockSize = L
â”‚             â”‚ â”‚                                                â”‚ CacheDType =
â”‚             â”‚ â”‚                                                â”‚ "fp8_e5m2", "
â”‚             â”‚ â”‚                                                â”‚ PrefixCaching
â”‚             â”‚ â”‚                                                â”‚ "sha256", "sh
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass
â”‚             â”‚ â”‚                                                â”‚ class CacheCo
â”‚             â”‚ â”‚                                                â”‚     """Config
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     block_siz
â”‚             â”‚ â”‚                                                â”‚ None  # type:
â”‚             â”‚ â”‚                                                â”‚     """Size o
â”‚             â”‚ â”‚                                                â”‚ number of tok
â”‚             â”‚ â”‚                                                â”‚     neuron de
â”‚             â”‚ â”‚                                                â”‚ `--max-model-
â”‚             â”‚ â”‚                                                â”‚     sizes up
â”‚             â”‚ â”‚                                                â”‚ devices, bloc
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     This conf
â”‚             â”‚ â”‚                                                â”‚ unspecified b
â”‚             â”‚ â”‚                                                â”‚     be set in
â”‚             â”‚ â”‚                                                â”‚ `Platform.che
â”‚             â”‚ â”‚                                                â”‚ the current
â”‚             â”‚ â”‚                                                â”‚     platform.
â”‚             â”‚ â”‚                                                â”‚     gpu_memor
â”‚             â”‚ â”‚                                                â”‚     """The fr
â”‚             â”‚ â”‚                                                â”‚ for the model
â”‚             â”‚ â”‚                                                â”‚     range fro
â”‚             â”‚ â”‚                                                â”‚ 0.5 would imp
â”‚             â”‚ â”‚                                                â”‚     utilizati
â”‚             â”‚ â”‚                                                â”‚ default value
â”‚             â”‚ â”‚                                                â”‚     per-insta
â”‚             â”‚ â”‚                                                â”‚ current vLLM
â”‚             â”‚ â”‚                                                â”‚     not matte
â”‚             â”‚ â”‚                                                â”‚ instance runn
â”‚             â”‚ â”‚                                                â”‚     example,
â”‚             â”‚ â”‚                                                â”‚ running on th
â”‚             â”‚ â”‚                                                â”‚     set the G
â”‚             â”‚ â”‚                                                â”‚ each instance
â”‚             â”‚ â”‚                                                â”‚     swap_spac
â”‚             â”‚ â”‚                                                â”‚     """Size o
â”‚             â”‚ â”‚                                                â”‚ GiB)."""
â”‚             â”‚ â”‚                                                â”‚     cache_dty
â”‚             â”‚ â”‚                                                â”‚     """Data t
â”‚             â”‚ â”‚                                                â”‚ "auto", will
â”‚             â”‚ â”‚                                                â”‚     CUDA 11.8
â”‚             â”‚ â”‚                                                â”‚ fp8_e5m2. ROC
â”‚             â”‚ â”‚                                                â”‚     fp8 (=fp8
â”‚             â”‚ â”‚                                                â”‚ fp8 (using fp
â”‚             â”‚ â”‚                                                â”‚     is_attent
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ This is prima
â”‚             â”‚ â”‚                                                â”‚     `ModelCon
â”‚             â”‚ â”‚                                                â”‚ manually dupl
â”‚             â”‚ â”‚                                                â”‚     num_gpu_b
â”‚             â”‚ â”‚                                                â”‚     """Number
â”‚             â”‚ â”‚                                                â”‚ overrides the
â”‚             â”‚ â”‚                                                â”‚     if specif
â”‚             â”‚ â”‚                                                â”‚ for testing p
â”‚             â”‚ â”‚                                                â”‚     sliding_w
â”‚             â”‚ â”‚                                                â”‚     """Slidin
â”‚             â”‚ â”‚                                                â”‚ This is prima
â”‚             â”‚ â”‚                                                â”‚     `ModelCon
â”‚             â”‚ â”‚                                                â”‚ manually dupl
â”‚             â”‚ â”‚                                                â”‚     enable_pr
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ Disabled by d
â”‚             â”‚ â”‚                                                â”‚     default f
â”‚             â”‚ â”‚                                                â”‚     prefix_ca
â”‚             â”‚ â”‚                                                â”‚ PrefixCaching
â”‚             â”‚ â”‚                                                â”‚     """Set th
â”‚             â”‚ â”‚                                                â”‚ caching:\n
â”‚             â”‚ â”‚                                                â”‚     - "builti
â”‚             â”‚ â”‚                                                â”‚     - "sha256
â”‚             â”‚ â”‚                                                â”‚ certain overh
â”‚             â”‚ â”‚                                                â”‚     This opti
â”‚             â”‚ â”‚                                                â”‚ serialization
â”‚             â”‚ â”‚                                                â”‚     - "sha256
â”‚             â”‚ â”‚                                                â”‚ reproducible,
â”‚             â”‚ â”‚                                                â”‚     hash. It
â”‚             â”‚ â”‚                                                â”‚ CBOR and hash
â”‚             â”‚ â”‚                                                â”‚     SHA-256.
â”‚             â”‚ â”‚                                                â”‚ lower 64 bits
â”‚             â”‚ â”‚                                                â”‚     digest.""
â”‚             â”‚ â”‚                                                â”‚     cpu_offlo
â”‚             â”‚ â”‚                                                â”‚     """The sp
â”‚             â”‚ â”‚                                                â”‚ GPU. Default
â”‚             â”‚ â”‚                                                â”‚     no offloa
â”‚             â”‚ â”‚                                                â”‚ can be seen a
â”‚             â”‚ â”‚                                                â”‚     increase
â”‚             â”‚ â”‚                                                â”‚ if you have o
â”‚             â”‚ â”‚                                                â”‚     set this
â”‚             â”‚ â”‚                                                â”‚ it as a 34 GB
â”‚             â”‚ â”‚                                                â”‚     load a 13
â”‚             â”‚ â”‚                                                â”‚ requires at l
â”‚             â”‚ â”‚                                                â”‚     Note that
â”‚             â”‚ â”‚                                                â”‚ interconnect,
â”‚             â”‚ â”‚                                                â”‚     loaded fr
â”‚             â”‚ â”‚                                                â”‚ fly in each m
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     calculate
â”‚             â”‚ â”‚                                                â”‚     """This e
â”‚             â”‚ â”‚                                                â”‚ `k_scale` and
â”‚             â”‚ â”‚                                                â”‚     kv_cache_
â”‚             â”‚ â”‚                                                â”‚ scales will b
â”‚             â”‚ â”‚                                                â”‚     checkpoin
â”‚             â”‚ â”‚                                                â”‚ scales will d
â”‚             â”‚ â”‚                                                â”‚     cpu_kvcac
â”‚             â”‚ â”‚                                                â”‚     """(CPU b
â”‚             â”‚ â”‚                                                â”‚ space."""
â”‚             â”‚ â”‚                                                â”‚     mamba_pag
â”‚             â”‚ â”‚                                                â”‚     """ Optio
â”‚             â”‚ â”‚                                                â”‚ used by hybri
â”‚             â”‚ â”‚                                                â”‚     models to
â”‚             â”‚ â”‚                                                â”‚ attention pag
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Will be
â”‚             â”‚ â”‚                                                â”‚     num_gpu_b
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """The nu
â”‚             â”‚ â”‚                                                â”‚ memory."""
â”‚             â”‚ â”‚                                                â”‚     num_cpu_b
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """The nu
â”‚             â”‚ â”‚                                                â”‚ memory."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         WARNI
â”‚             â”‚ â”‚                                                â”‚ to this confi
â”‚             â”‚ â”‚                                                â”‚         ensur
â”‚             â”‚ â”‚                                                â”‚ factors list
â”‚             â”‚ â”‚                                                â”‚         it af
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         # `cp
â”‚             â”‚ â”‚                                                â”‚ `torch.compil
â”‚             â”‚ â”‚                                                â”‚         hash_
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ * GiB_bytes
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def metri
â”‚             â”‚ â”‚                                                â”‚         # con
â”‚             â”‚ â”‚                                                â”‚ str, value: s
â”‚             â”‚ â”‚                                                â”‚         # met
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ in self.__dic
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @model_va
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ must be non-n
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {self.cpu_off
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ less than 1.0
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚ get_args(Cach
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ kv cache. It
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ the performan
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ accuracy drop
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ dtype: {self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ not envs.VLLM
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ supported wit
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ --disable-sli
â”‚             â”‚ â”‚                                                â”‚ caching.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚ self.prefix_c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ get_args(Pref
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ algorithm: "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Must be one o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def verif
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         paral
â”‚             â”‚ â”‚                                                â”‚     ) -> None
â”‚             â”‚ â”‚                                                â”‚         total
â”‚             â”‚ â”‚                                                â”‚         # FIX
â”‚             â”‚ â”‚                                                â”‚ that the GPUs
â”‚             â”‚ â”‚                                                â”‚         # gro
â”‚             â”‚ â”‚                                                â”‚ the GPUs may
â”‚             â”‚ â”‚                                                â”‚         num_g
â”‚             â”‚ â”‚                                                â”‚ parallel_conf
â”‚             â”‚ â”‚                                                â”‚         cpu_m
â”‚             â”‚ â”‚                                                â”‚ self.swap_spa
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         msg =
â”‚             â”‚ â”‚                                                â”‚ GiB_bytes:.2f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ GiB_bytes:.2f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ space.")
â”‚             â”‚ â”‚                                                â”‚         if cp
â”‚             â”‚ â”‚                                                â”‚ total_cpu_mem
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ space. " + ms
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚ total_cpu_mem
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ swap space. %
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass
â”‚             â”‚ â”‚                                                â”‚ class LoadCon
â”‚             â”‚ â”‚                                                â”‚     """Config
â”‚             â”‚ â”‚                                                â”‚ weights."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     load_form
â”‚             â”‚ â”‚                                                â”‚     """The fo
â”‚             â”‚ â”‚                                                â”‚ load:\n
â”‚             â”‚ â”‚                                                â”‚     - "auto"
â”‚             â”‚ â”‚                                                â”‚ the safetenso
â”‚             â”‚ â”‚                                                â”‚     back to t
â”‚             â”‚ â”‚                                                â”‚ safetensors f
â”‚             â”‚ â”‚                                                â”‚     - "pt" wi
â”‚             â”‚ â”‚                                                â”‚ bin format.\n
â”‚             â”‚ â”‚                                                â”‚     - "safete
â”‚             â”‚ â”‚                                                â”‚ the safetenso
â”‚             â”‚ â”‚                                                â”‚     - "npcach
â”‚             â”‚ â”‚                                                â”‚ pytorch forma
â”‚             â”‚ â”‚                                                â”‚     to speed
â”‚             â”‚ â”‚                                                â”‚     - "dummy"
â”‚             â”‚ â”‚                                                â”‚ random values
â”‚             â”‚ â”‚                                                â”‚     for profi
â”‚             â”‚ â”‚                                                â”‚     - "tensor
â”‚             â”‚ â”‚                                                â”‚ tensorizer li
â”‚             â”‚ â”‚                                                â”‚     loading.
â”‚             â”‚ â”‚                                                â”‚ script in the
â”‚             â”‚ â”‚                                                â”‚     more info
â”‚             â”‚ â”‚                                                â”‚     - "runai_
â”‚             â”‚ â”‚                                                â”‚ Safetensors w
â”‚             â”‚ â”‚                                                â”‚     Streamer.
â”‚             â”‚ â”‚                                                â”‚     - "bitsan
â”‚             â”‚ â”‚                                                â”‚ using bitsand
â”‚             â”‚ â”‚                                                â”‚     - "sharde
â”‚             â”‚ â”‚                                                â”‚ pre-sharded c
â”‚             â”‚ â”‚                                                â”‚     supportin
â”‚             â”‚ â”‚                                                â”‚ tensor-parall
â”‚             â”‚ â”‚                                                â”‚     - "gguf"
â”‚             â”‚ â”‚                                                â”‚ files (detail
â”‚             â”‚ â”‚                                                â”‚     https://g
â”‚             â”‚ â”‚                                                â”‚     - "mistra
â”‚             â”‚ â”‚                                                â”‚ consolidated
â”‚             â”‚ â”‚                                                â”‚     Mistral m
â”‚             â”‚ â”‚                                                â”‚     - Other c
â”‚             â”‚ â”‚                                                â”‚ plugins."""
â”‚             â”‚ â”‚                                                â”‚     download_
â”‚             â”‚ â”‚                                                â”‚     """Direct
â”‚             â”‚ â”‚                                                â”‚ weights, defa
â”‚             â”‚ â”‚                                                â”‚     cache dir
â”‚             â”‚ â”‚                                                â”‚     model_loa
â”‚             â”‚ â”‚                                                â”‚         defau
â”‚             â”‚ â”‚                                                â”‚     """Extra
â”‚             â”‚ â”‚                                                â”‚ be passed to
â”‚             â”‚ â”‚                                                â”‚     correspon
â”‚             â”‚ â”‚                                                â”‚     device: O
â”‚             â”‚ â”‚                                                â”‚     """Device
â”‚             â”‚ â”‚                                                â”‚ loaded, defau
â”‚             â”‚ â”‚                                                â”‚     device_co
â”‚             â”‚ â”‚                                                â”‚     ignore_pa
â”‚             â”‚ â”‚                                                â”‚ = None
â”‚             â”‚ â”‚                                                â”‚     """The li
â”‚             â”‚ â”‚                                                â”‚ loading the m
â”‚             â”‚ â”‚                                                â”‚     "original
â”‚             â”‚ â”‚                                                â”‚ of llama's ch
â”‚             â”‚ â”‚                                                â”‚     use_tqdm_
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ progress bar
â”‚             â”‚ â”‚                                                â”‚     weights."
â”‚             â”‚ â”‚                                                â”‚     pt_load_m
â”‚             â”‚ â”‚                                                â”‚ "cpu"
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     pt_load_m
â”‚             â”‚ â”‚                                                â”‚ loading pytor
â”‚             â”‚ â”‚                                                â”‚     support l
â”‚             â”‚ â”‚                                                â”‚ loaded on cer
â”‚             â”‚ â”‚                                                â”‚     "cuda", t
â”‚             â”‚ â”‚                                                â”‚ Another suppo
â”‚             â”‚ â”‚                                                â”‚     mapping f
â”‚             â”‚ â”‚                                                â”‚ GPU 1 to GPU
â”‚             â”‚ â”‚                                                â”‚     {"cuda:1"
â”‚             â”‚ â”‚                                                â”‚ from command
â”‚             â”‚ â”‚                                                â”‚     in dictio
â”‚             â”‚ â”‚                                                â”‚ json parsing.
â”‚             â”‚ â”‚                                                â”‚     see origi
â”‚             â”‚ â”‚                                                â”‚ https://pytor
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         WARNI
â”‚             â”‚ â”‚                                                â”‚ to this confi
â”‚             â”‚ â”‚                                                â”‚         ensur
â”‚             â”‚ â”‚                                                â”‚ factors list
â”‚             â”‚ â”‚                                                â”‚         it af
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         # no
â”‚             â”‚ â”‚                                                â”‚         # thi
â”‚             â”‚ â”‚                                                â”‚ computation g
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         hash_
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.load_for
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ len(self.igno
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ patterns when
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ ["original/**
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ DistributedEx
â”‚             â”‚ â”‚                                                â”‚ "mp", "uni",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass
â”‚             â”‚ â”‚                                                â”‚ class Paralle
â”‚             â”‚ â”‚                                                â”‚     """Config
â”‚             â”‚ â”‚                                                â”‚ execution."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     pipeline_
â”‚             â”‚ â”‚                                                â”‚     """Number
â”‚             â”‚ â”‚                                                â”‚     tensor_pa
â”‚             â”‚ â”‚                                                â”‚     """Number
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Number
â”‚             â”‚ â”‚                                                â”‚ layers will b
â”‚             â”‚ â”‚                                                â”‚     the produ
â”‚             â”‚ â”‚                                                â”‚ data parallel
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Number
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Rank o
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Local
â”‚             â”‚ â”‚                                                â”‚     set only
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """IP of
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Port f
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Port o
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Backen
â”‚             â”‚ â”‚                                                â”‚ "mp" or "ray"
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ Applies only
â”‚             â”‚ â”‚                                                â”‚     and when
â”‚             â”‚ â”‚                                                â”‚ useful for a
â”‚             â”‚ â”‚                                                â”‚     wide-EP s
â”‚             â”‚ â”‚                                                â”‚ when --data-p
â”‚             â”‚ â”‚                                                â”‚     is provid
â”‚             â”‚ â”‚                                                â”‚     data_para
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ Applies only
â”‚             â”‚ â”‚                                                â”‚     and when
â”‚             â”‚ â”‚                                                â”‚ running an As
â”‚             â”‚ â”‚                                                â”‚     and API s
â”‚             â”‚ â”‚                                                â”‚ vLLM load bal
â”‚             â”‚ â”‚                                                â”‚     between l
â”‚             â”‚ â”‚                                                â”‚ external LB b
â”‚             â”‚ â”‚                                                â”‚     between v
â”‚             â”‚ â”‚                                                â”‚ in conjunctio
â”‚             â”‚ â”‚                                                â”‚     --data-pa
â”‚             â”‚ â”‚                                                â”‚     enable_ex
â”‚             â”‚ â”‚                                                â”‚     """Use ex
â”‚             â”‚ â”‚                                                â”‚ parallelism f
â”‚             â”‚ â”‚                                                â”‚     enable_ep
â”‚             â”‚ â”‚                                                â”‚     """Enable
â”‚             â”‚ â”‚                                                â”‚ for MoE layer
â”‚             â”‚ â”‚                                                â”‚     num_redun
â”‚             â”‚ â”‚                                                â”‚     """Number
â”‚             â”‚ â”‚                                                â”‚ expert parall
â”‚             â”‚ â”‚                                                â”‚     eplb_wind
â”‚             â”‚ â”‚                                                â”‚     """Window
â”‚             â”‚ â”‚                                                â”‚ recording."""
â”‚             â”‚ â”‚                                                â”‚     eplb_step
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     Interval
â”‚             â”‚ â”‚                                                â”‚ parallelism.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     Note that
â”‚             â”‚ â”‚                                                â”‚ window size,
â”‚             â”‚ â”‚                                                â”‚     of the la
â”‚             â”‚ â”‚                                                â”‚ be used for r
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     eplb_log_
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     Log the b
â”‚             â”‚ â”‚                                                â”‚ parallelism.
â”‚             â”‚ â”‚                                                â”‚     This is t
â”‚             â”‚ â”‚                                                â”‚ cause communi
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     max_paral
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ workers when
â”‚             â”‚ â”‚                                                â”‚     sequentia
â”‚             â”‚ â”‚                                                â”‚ RAM OOM when
â”‚             â”‚ â”‚                                                â”‚     parallel
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     disable_c
â”‚             â”‚ â”‚                                                â”‚     """Disabl
â”‚             â”‚ â”‚                                                â”‚ fall back to
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     ray_worke
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ nsight, see
â”‚             â”‚ â”‚                                                â”‚ https://docs.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     placement
â”‚             â”‚ â”‚                                                â”‚ = None
â”‚             â”‚ â”‚                                                â”‚     """ray di
â”‚             â”‚ â”‚                                                â”‚ group."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     distribut
â”‚             â”‚ â”‚                                                â”‚ Optional[Unio
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = None
â”‚             â”‚ â”‚                                                â”‚     """Backen
â”‚             â”‚ â”‚                                                â”‚     workers,
â”‚             â”‚ â”‚                                                â”‚ (multiprocess
â”‚             â”‚ â”‚                                                â”‚     of pipeli
â”‚             â”‚ â”‚                                                â”‚ tensor_parall
â”‚             â”‚ â”‚                                                â”‚     or equal
â”‚             â”‚ â”‚                                                â”‚ "mp" will be
â”‚             â”‚ â”‚                                                â”‚     keep proc
â”‚             â”‚ â”‚                                                â”‚ Otherwise, th
â”‚             â”‚ â”‚                                                â”‚     to "ray"
â”‚             â”‚ â”‚                                                â”‚ otherwise. No
â”‚             â”‚ â”‚                                                â”‚     only supp
â”‚             â”‚ â”‚                                                â”‚ inference."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     worker_cl
â”‚             â”‚ â”‚                                                â”‚     """The fu
â”‚             â”‚ â”‚                                                â”‚ use. If "auto
â”‚             â”‚ â”‚                                                â”‚     will be d
â”‚             â”‚ â”‚                                                â”‚ platform."""
â”‚             â”‚ â”‚                                                â”‚     sd_worker
â”‚             â”‚ â”‚                                                â”‚     """The fu
â”‚             â”‚ â”‚                                                â”‚ for speculati
â”‚             â”‚ â”‚                                                â”‚     If "auto"
â”‚             â”‚ â”‚                                                â”‚ determined ba
â”‚             â”‚ â”‚                                                â”‚     worker_ex
â”‚             â”‚ â”‚                                                â”‚     """The fu
â”‚             â”‚ â”‚                                                â”‚ class to use.
â”‚             â”‚ â”‚                                                â”‚     class is
â”‚             â”‚ â”‚                                                â”‚ worker class.
â”‚             â”‚ â”‚                                                â”‚     new attri
â”‚             â”‚ â”‚                                                â”‚ class for use
â”‚             â”‚ â”‚                                                â”‚     calls."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     world_siz
â”‚             â”‚ â”‚                                                â”‚     """world_
â”‚             â”‚ â”‚                                                â”‚ number of wor
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     rank: int
â”‚             â”‚ â”‚                                                â”‚     """Global
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     enable_mu
â”‚             â”‚ â”‚                                                â”‚ bool = False
â”‚             â”‚ â”‚                                                â”‚     """ Use d
â”‚             â”‚ â”‚                                                â”‚ parallelism f
â”‚             â”‚ â”‚                                                â”‚     Only supp
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def world
â”‚             â”‚ â”‚                                                â”‚         """wo
â”‚             â”‚ â”‚                                                â”‚ is the size o
â”‚             â”‚ â”‚                                                â”‚         inclu
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self.data_par
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def get_n
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         We mi
â”‚             â”‚ â”‚                                                â”‚ groups in mul
â”‚             â”‚ â”‚                                                â”‚         proce
â”‚             â”‚ â”‚                                                â”‚ parallelism,
â”‚             â”‚ â”‚                                                â”‚         e.g.
â”‚             â”‚ â”‚                                                â”‚ engine, which
â”‚             â”‚ â”‚                                                â”‚         can l
â”‚             â”‚ â”‚                                                â”‚ avoid port co
â”‚             â”‚ â”‚                                                â”‚         incre
â”‚             â”‚ â”‚                                                â”‚ need to initi
â”‚             â”‚ â”‚                                                â”‚         new p
â”‚             â”‚ â”‚                                                â”‚ parallelism.
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         answe
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def state
â”‚             â”‚ â”‚                                                â”‚ "ProcessGroup
â”‚             â”‚ â”‚                                                â”‚         # NOT
â”‚             â”‚ â”‚                                                â”‚ multiple proc
â”‚             â”‚ â”‚                                                â”‚         # can
â”‚             â”‚ â”‚                                                â”‚ port through
â”‚             â”‚ â”‚                                                â”‚         # con
â”‚             â”‚ â”‚                                                â”‚ `get_open_por
â”‚             â”‚ â”‚                                                â”‚         # pro
â”‚             â”‚ â”‚                                                â”‚ will subseque
â”‚             â”‚ â”‚                                                â”‚         # wit
â”‚             â”‚ â”‚                                                â”‚ `torch.distri
â”‚             â”‚ â”‚                                                â”‚ EADDRINUSE`.
â”‚             â”‚ â”‚                                                â”‚         # To
â”‚             â”‚ â”‚                                                â”‚ robust we ret
â”‚             â”‚ â”‚                                                â”‚         # wit
â”‚             â”‚ â”‚                                                â”‚ specific erro
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ DistNetworkEr
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         max_r
â”‚             â”‚ â”‚                                                â”‚         last_
â”‚             â”‚ â”‚                                                â”‚         for _
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ process might
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ stateless_ini
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ the root caus
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ use. Retrying
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ a new port
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # If
â”‚             â”‚ â”‚                                                â”‚ failed.
â”‚             â”‚ â”‚                                                â”‚         asser
â”‚             â”‚ â”‚                                                â”‚         raise
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def has_u
â”‚             â”‚ â”‚                                                â”‚ "ProcessGroup
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ -> bool:
â”‚             â”‚ â”‚                                                â”‚         tenso
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # dp
â”‚             â”‚ â”‚                                                â”‚         # dp
â”‚             â”‚ â”‚                                                â”‚         # agg
â”‚             â”‚ â”‚                                                â”‚         # so
â”‚             â”‚ â”‚                                                â”‚ in integers
â”‚             â”‚ â”‚                                                â”‚         torch
â”‚             â”‚ â”‚                                                â”‚ op=ReduceOp.M
â”‚             â”‚ â”‚                                                â”‚         aggre
â”‚             â”‚ â”‚                                                â”‚ bool(tensor.i
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def sync_
â”‚             â”‚ â”‚                                                â”‚ "ProcessGroup
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ int) -> int:
â”‚             â”‚ â”‚                                                â”‚         if kv
â”‚             â”‚ â”‚                                                â”‚             k
â”‚             â”‚ â”‚                                                â”‚ torch.iinfo(t
â”‚             â”‚ â”‚                                                â”‚         tenso
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # we
â”‚             â”‚ â”‚                                                â”‚ dp group sinc
â”‚             â”‚ â”‚                                                â”‚         # on
â”‚             â”‚ â”‚                                                â”‚         torch
â”‚             â”‚ â”‚                                                â”‚ op=ReduceOp.M
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ hashlib.sha25
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.pipeline
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.data_par
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.data_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.data_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.data_par
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ the engine ar
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ get_open_port
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.data_par
â”‚             â”‚ â”‚                                                â”‚ self.data_par
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.data_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {self.data_pa
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ (e.g. for off
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ValueError("d
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ data_parallel
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ "external_lau
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚             o
â”‚             â”‚ â”‚                                                â”‚ = "0"
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ multiprocessi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ balancing is
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ be non-negati
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ must be True
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.data_par
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ tensor_parall
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ got "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ should be use
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ None and self
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ if world_size
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ ray placement
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚             b
â”‚             â”‚ â”‚                                                â”‚ = "mp"
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ ray_utils.ray
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ control multi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_XLA
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ cuda_device_c
â”‚             â”‚ â”‚                                                â”‚ self.world_si
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ load Ray: "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Ray is "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ for multi-nod
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ install Ray w
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ "ray":
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ distributed i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is ray")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is_initialize
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ get_current_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ get_current_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ backend
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ for distribut
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ None and self
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ "uni"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def use_r
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self.distribu
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ type)
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â”‚                                                â”‚ self.distribu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @model_va
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         # Laz
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ ExecutorBase
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ not in (
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not (isinstan
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ type) and iss
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ExecutorBase)
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ executor back
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Supported "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 'external_lau
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ subclass.")
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ True
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ kernel becaus
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ platform.")
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.use_ray:
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ nsight profil
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ PreemptionMod
â”‚             â”‚ â”‚                                                â”‚ SchedulerPoli
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass
â”‚             â”‚ â”‚                                                â”‚ class Schedul
â”‚             â”‚ â”‚                                                â”‚     """Schedu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     runner_ty
â”‚             â”‚ â”‚                                                â”‚     """The ru
â”‚             â”‚ â”‚                                                â”‚ model."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     max_num_b
â”‚             â”‚ â”‚                                                â”‚ None  # type:
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ in a single i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     This conf
â”‚             â”‚ â”‚                                                â”‚ unspecified b
â”‚             â”‚ â”‚                                                â”‚     be set in
â”‚             â”‚ â”‚                                                â”‚ based on the
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     max_num_s
â”‚             â”‚ â”‚                                                â”‚ type: ignore
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ processed in
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     This conf
â”‚             â”‚ â”‚                                                â”‚ unspecified b
â”‚             â”‚ â”‚                                                â”‚     be set in
â”‚             â”‚ â”‚                                                â”‚ based on the
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     max_model
â”‚             â”‚ â”‚                                                â”‚ type: ignore
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ prompt and ge
â”‚             â”‚ â”‚                                                â”‚     is primar
â”‚             â”‚ â”‚                                                â”‚ value should
â”‚             â”‚ â”‚                                                â”‚     duplicate
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     max_num_p
â”‚             â”‚ â”‚                                                â”‚     """For ch
â”‚             â”‚ â”‚                                                â”‚ of sequences
â”‚             â”‚ â”‚                                                â”‚     partially
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     max_long_
â”‚             â”‚ â”‚                                                â”‚     """For ch
â”‚             â”‚ â”‚                                                â”‚ of prompts lo
â”‚             â”‚ â”‚                                                â”‚     long_pref
â”‚             â”‚ â”‚                                                â”‚ prefilled con
â”‚             â”‚ â”‚                                                â”‚     this less
â”‚             â”‚ â”‚                                                â”‚ will allow sh
â”‚             â”‚ â”‚                                                â”‚     the queue
â”‚             â”‚ â”‚                                                â”‚ some cases, i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     long_pref
â”‚             â”‚ â”‚                                                â”‚     """For ch
â”‚             â”‚ â”‚                                                â”‚ considered lo
â”‚             â”‚ â”‚                                                â”‚     longer th
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     num_looka
â”‚             â”‚ â”‚                                                â”‚     """The nu
â”‚             â”‚ â”‚                                                â”‚ sequence per
â”‚             â”‚ â”‚                                                â”‚     step, bey
â”‚             â”‚ â”‚                                                â”‚ used in specu
â”‚             â”‚ â”‚                                                â”‚     decoding
â”‚             â”‚ â”‚                                                â”‚ which may or
â”‚             â”‚ â”‚                                                â”‚     accepted.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     NOTE: Thi
â”‚             â”‚ â”‚                                                â”‚ config in the
â”‚             â”‚ â”‚                                                â”‚     present t
â”‚             â”‚ â”‚                                                â”‚ then."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     cuda_grap
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Cuda g
â”‚             â”‚ â”‚                                                â”‚     1. if non
â”‚             â”‚ â”‚                                                â”‚     2. if one
â”‚             â”‚ â”‚                                                â”‚ capture list
â”‚             â”‚ â”‚                                                â”‚     pattern:
â”‚             â”‚ â”‚                                                â”‚     3. more t
â”‚             â”‚ â”‚                                                â”‚ provided, the
â”‚             â”‚ â”‚                                                â”‚     will foll
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     delay_fac
â”‚             â”‚ â”‚                                                â”‚     """Apply
â”‚             â”‚ â”‚                                                â”‚ multiplied by
â”‚             â”‚ â”‚                                                â”‚     prompt la
â”‚             â”‚ â”‚                                                â”‚ prompt."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     enable_ch
â”‚             â”‚ â”‚                                                â”‚ None  # type:
â”‚             â”‚ â”‚                                                â”‚     """If Tru
â”‚             â”‚ â”‚                                                â”‚ based
â”‚             â”‚ â”‚                                                â”‚     on the re
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     is_multim
â”‚             â”‚ â”‚                                                â”‚     """True i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # TODO (y
â”‚             â”‚ â”‚                                                â”‚     max_num_e
â”‚             â”‚ â”‚                                                â”‚ field(init=Fa
â”‚             â”‚ â”‚                                                â”‚     """Multim
â”‚             â”‚ â”‚                                                â”‚ used in V1.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     NOTE: Thi
â”‚             â”‚ â”‚                                                â”‚ It will be ov
â”‚             â”‚ â”‚                                                â”‚     max_num_b
â”‚             â”‚ â”‚                                                â”‚ multimodal em
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # TODO (y
â”‚             â”‚ â”‚                                                â”‚     encoder_c
â”‚             â”‚ â”‚                                                â”‚     """Multim
â”‚             â”‚ â”‚                                                â”‚ in V1.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     NOTE: Thi
â”‚             â”‚ â”‚                                                â”‚ It will be ov
â”‚             â”‚ â”‚                                                â”‚     max_num_b
â”‚             â”‚ â”‚                                                â”‚ multimodal em
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     preemptio
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ swapping or
â”‚             â”‚ â”‚                                                â”‚     recomputa
â”‚             â”‚ â”‚                                                â”‚ determine the
â”‚             â”‚ â”‚                                                â”‚     We use re
â”‚             â”‚ â”‚                                                â”‚ incurs lower
â”‚             â”‚ â”‚                                                â”‚     swapping.
â”‚             â”‚ â”‚                                                â”‚ has multiple
â”‚             â”‚ â”‚                                                â”‚     (e.g., be
â”‚             â”‚ â”‚                                                â”‚ currently sup
â”‚             â”‚ â”‚                                                â”‚     such a ca
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     num_sched
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ scheduler cal
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     multi_ste
â”‚             â”‚ â”‚                                                â”‚     """If Fal
â”‚             â”‚ â”‚                                                â”‚ outputs at th
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     send_delt
â”‚             â”‚ â”‚                                                â”‚     """Privat
â”‚             â”‚ â”‚                                                â”‚ delta data to
â”‚             â”‚ â”‚                                                â”‚     workers i
â”‚             â”‚ â”‚                                                â”‚ should be ena
â”‚             â”‚ â”‚                                                â”‚     when SPMD
â”‚             â”‚ â”‚                                                â”‚ I.e.,
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     policy: S
â”‚             â”‚ â”‚                                                â”‚     """The sc
â”‚             â”‚ â”‚                                                â”‚     - "fcfs"
â”‚             â”‚ â”‚                                                â”‚ i.e. requests
â”‚             â”‚ â”‚                                                â”‚     of arriva
â”‚             â”‚ â”‚                                                â”‚     - "priori
â”‚             â”‚ â”‚                                                â”‚ based on give
â”‚             â”‚ â”‚                                                â”‚     value mea
â”‚             â”‚ â”‚                                                â”‚ arrival decid
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     chunked_p
â”‚             â”‚ â”‚                                                â”‚ field(init=Fa
â”‚             â”‚ â”‚                                                â”‚     """True i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     disable_c
â”‚             â”‚ â”‚                                                â”‚     """If set
â”‚             â”‚ â”‚                                                â”‚ enabled, we d
â”‚             â”‚ â”‚                                                â”‚     partially
â”‚             â”‚ â”‚                                                â”‚ used in V1
â”‚             â”‚ â”‚                                                â”‚     This ensu
â”‚             â”‚ â”‚                                                â”‚ prompt
â”‚             â”‚ â”‚                                                â”‚     (like tex
â”‚             â”‚ â”‚                                                â”‚ tokens IIIIII
â”‚             â”‚ â”‚                                                â”‚     some imag
â”‚             â”‚ â”‚                                                â”‚ TTTTIIIII, le
â”‚             â”‚ â”‚                                                â”‚     it will b
â”‚             â”‚ â”‚                                                â”‚ and IIIIIIIII
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # schedul
â”‚             â”‚ â”‚                                                â”‚ "vllm.core.sc
â”‚             â”‚ â”‚                                                â”‚     # or "mod
â”‚             â”‚ â”‚                                                â”‚     scheduler
â”‚             â”‚ â”‚                                                â”‚ "vllm.core.sc
â”‚             â”‚ â”‚                                                â”‚     """The sc
â”‚             â”‚ â”‚                                                â”‚ "vllm.core.sc
â”‚             â”‚ â”‚                                                â”‚     default s
â”‚             â”‚ â”‚                                                â”‚ or the path t
â”‚             â”‚ â”‚                                                â”‚     "mod.cust
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     disable_h
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚     """If set
â”‚             â”‚ â”‚                                                â”‚ allocate the
â”‚             â”‚ â”‚                                                â”‚     for all a
â”‚             â”‚ â”‚                                                â”‚ multiple type
â”‚             â”‚ â”‚                                                â”‚     like full
â”‚             â”‚ â”‚                                                â”‚ attention.
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     async_sch
â”‚             â”‚ â”‚                                                â”‚     """EXPERI
â”‚             â”‚ â”‚                                                â”‚ async schedul
â”‚             â”‚ â”‚                                                â”‚     reduce th
â”‚             â”‚ â”‚                                                â”‚ latency and t
â”‚             â”‚ â”‚                                                â”‚     async sch
â”‚             â”‚ â”‚                                                â”‚ with some fea
â”‚             â”‚ â”‚                                                â”‚     structure
â”‚             â”‚ â”‚                                                â”‚ and pipeline
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         WARNI
â”‚             â”‚ â”‚                                                â”‚ to this confi
â”‚             â”‚ â”‚                                                â”‚         ensur
â”‚             â”‚ â”‚                                                â”‚ factors list
â”‚             â”‚ â”‚                                                â”‚         it af
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         # no
â”‚             â”‚ â”‚                                                â”‚         # thi
â”‚             â”‚ â”‚                                                â”‚ computation g
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         hash_
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 1:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Chunked-Prefi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ max_num_batch
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ sequences on
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = max(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ DEFAULT_MAX_N
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = (
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ short, use
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ DEFAULT_MAX_N
â”‚             â”‚ â”‚                                                â”‚ value
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ max(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ DEFAULT_MAX_N
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ higher throug
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ max(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ least the num
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ max(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ does not exce
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ embeddings ti
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.max_mode
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.max_num_
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.max_num_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ with max_num_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self.enable_c
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.long_pre
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = int(self.ma
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enabled with
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ max_long_part
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.max_long
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # NOT
â”‚             â”‚ â”‚                                                â”‚ .
â”‚             â”‚ â”‚                                                â”‚         # Thi
â”‚             â”‚ â”‚                                                â”‚ scenarios wit
â”‚             â”‚ â”‚                                                â”‚         # and
â”‚             â”‚ â”‚                                                â”‚ graphs (>512)
â”‚             â”‚ â”‚                                                â”‚         # inc
â”‚             â”‚ â”‚                                                â”‚ performance b
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @model_va
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚ self.max_mode
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.chunked_
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.max_nu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.max_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ maximum seque
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ makes vLLM re
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ max_num_batch
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.max_num_
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.max_nu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ max_num_seqs
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.max_num_
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ exceeds max_n
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ lead to unexp
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.max_mode
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ must be great
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ must be great
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.max_nu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ to 1.")
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.chunked_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ prefill must
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ > 1.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.long_pre
â”‚             â”‚ â”‚                                                â”‚ self.max_mode
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ cannot be gre
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.max_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ (self.max_lon
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.max_num_
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.max_lo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ to 1 and less
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.max_nu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def is_mu
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Device = Lite
â”‚             â”‚ â”‚                                                â”‚ "cpu", "tpu",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass(co
â”‚             â”‚ â”‚                                                â”‚ class DeviceC
â”‚             â”‚ â”‚                                                â”‚     """Config
â”‚             â”‚ â”‚                                                â”‚ vLLM executio
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     device:
â”‚             â”‚ â”‚                                                â”‚ SkipValidatio
â”‚             â”‚ â”‚                                                â”‚ torch.device]
â”‚             â”‚ â”‚                                                â”‚     """Device
â”‚             â”‚ â”‚                                                â”‚     This para
â”‚             â”‚ â”‚                                                â”‚     removed i
â”‚             â”‚ â”‚                                                â”‚     It will n
â”‚             â”‚ â”‚                                                â”‚     on the cu
â”‚             â”‚ â”‚                                                â”‚     device_ty
â”‚             â”‚ â”‚                                                â”‚     """Device
â”‚             â”‚ â”‚                                                â”‚ This is set i
â”‚             â”‚ â”‚                                                â”‚     `__post_i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         WARNI
â”‚             â”‚ â”‚                                                â”‚ to this confi
â”‚             â”‚ â”‚                                                â”‚         ensur
â”‚             â”‚ â”‚                                                â”‚ factors list
â”‚             â”‚ â”‚                                                â”‚         it af
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         # no
â”‚             â”‚ â”‚                                                â”‚         # the
â”‚             â”‚ â”‚                                                â”‚ be summarized
â”‚             â”‚ â”‚                                                â”‚         # by
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         hash_
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ type, please
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ `VLLM_LOGGING
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ to help debug
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ explicitly
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ torch.device)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.device.t
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Som
â”‚             â”‚ â”‚                                                â”‚ inputs on CPU
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ torch.device(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ SpeculativeMe
â”‚             â”‚ â”‚                                                â”‚ "eagle3", "me
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "draft_model"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass
â”‚             â”‚ â”‚                                                â”‚ class Specula
â”‚             â”‚ â”‚                                                â”‚     """Config
â”‚             â”‚ â”‚                                                â”‚ decoding."""
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # General
â”‚             â”‚ â”‚                                                â”‚     num_specu
â”‚             â”‚ â”‚                                                â”‚ None  # type:
â”‚             â”‚ â”‚                                                â”‚     """The nu
â”‚             â”‚ â”‚                                                â”‚ provided. It
â”‚             â”‚ â”‚                                                â”‚     number in
â”‚             â”‚ â”‚                                                â”‚ present, othe
â”‚             â”‚ â”‚                                                â”‚     model: Op
â”‚             â”‚ â”‚                                                â”‚     """The na
â”‚             â”‚ â”‚                                                â”‚ or additional
â”‚             â”‚ â”‚                                                â”‚     provided.
â”‚             â”‚ â”‚                                                â”‚     method: O
â”‚             â”‚ â”‚                                                â”‚     """The na
â”‚             â”‚ â”‚                                                â”‚ use. If users
â”‚             â”‚ â”‚                                                â”‚     `model` p
â”‚             â”‚ â”‚                                                â”‚ will be detec
â”‚             â”‚ â”‚                                                â”‚     if possib
â”‚             â”‚ â”‚                                                â”‚ provided, the
â”‚             â”‚ â”‚                                                â”‚     provided.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     If using
â”‚             â”‚ â”‚                                                â”‚ configuration
â”‚             â”‚ â”‚                                                â”‚     `prompt_l
â”‚             â”‚ â”‚                                                â”‚ considered.""
â”‚             â”‚ â”‚                                                â”‚     draft_ten
â”‚             â”‚ â”‚                                                â”‚     """The de
â”‚             â”‚ â”‚                                                â”‚ the draft mod
â”‚             â”‚ â”‚                                                â”‚     or the sa
â”‚             â”‚ â”‚                                                â”‚ parallel size
â”‚             â”‚ â”‚                                                â”‚     disable_l
â”‚             â”‚ â”‚                                                â”‚     """If set
â”‚             â”‚ â”‚                                                â”‚ are not retur
â”‚             â”‚ â”‚                                                â”‚     speculati
â”‚             â”‚ â”‚                                                â”‚ token log pro
â”‚             â”‚ â”‚                                                â”‚     according
â”‚             â”‚ â”‚                                                â”‚ in SamplingPa
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Draft m
â”‚             â”‚ â”‚                                                â”‚     quantizat
â”‚             â”‚ â”‚                                                â”‚     """Quanti
â”‚             â”‚ â”‚                                                â”‚ quantize the
â”‚             â”‚ â”‚                                                â”‚     If `None`
â”‚             â”‚ â”‚                                                â”‚ not quantized
â”‚             â”‚ â”‚                                                â”‚     takes eff
â”‚             â”‚ â”‚                                                â”‚ model-based s
â”‚             â”‚ â”‚                                                â”‚     max_model
â”‚             â”‚ â”‚                                                â”‚     """The ma
â”‚             â”‚ â”‚                                                â”‚ model. Used w
â”‚             â”‚ â”‚                                                â”‚     ability t
â”‚             â”‚ â”‚                                                â”‚ sequences."""
â”‚             â”‚ â”‚                                                â”‚     revision:
â”‚             â”‚ â”‚                                                â”‚     """The sp
â”‚             â”‚ â”‚                                                â”‚ the draft mod
â”‚             â”‚ â”‚                                                â”‚     branch na
â”‚             â”‚ â”‚                                                â”‚ unspecified,
â”‚             â”‚ â”‚                                                â”‚     default v
â”‚             â”‚ â”‚                                                â”‚     code_revi
â”‚             â”‚ â”‚                                                â”‚     """The sp
â”‚             â”‚ â”‚                                                â”‚ draft model c
â”‚             â”‚ â”‚                                                â”‚     Hub. It c
â”‚             â”‚ â”‚                                                â”‚ or a commit i
â”‚             â”‚ â”‚                                                â”‚     will use
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Advance
â”‚             â”‚ â”‚                                                â”‚     disable_b
â”‚             â”‚ â”‚                                                â”‚     """Disabl
â”‚             â”‚ â”‚                                                â”‚ incoming requ
â”‚             â”‚ â”‚                                                â”‚     of enqueu
â”‚             â”‚ â”‚                                                â”‚ value, if pro
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Ngram p
â”‚             â”‚ â”‚                                                â”‚     prompt_lo
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ using Ngram p
â”‚             â”‚ â”‚                                                â”‚     when meth
â”‚             â”‚ â”‚                                                â”‚     prompt_lo
â”‚             â”‚ â”‚                                                â”‚     """Minimu
â”‚             â”‚ â”‚                                                â”‚ using Ngram p
â”‚             â”‚ â”‚                                                â”‚     provided.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     speculati
â”‚             â”‚ â”‚                                                â”‚     """Specif
â”‚             â”‚ â”‚                                                â”‚ speculative t
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     # require
â”‚             â”‚ â”‚                                                â”‚ engine
â”‚             â”‚ â”‚                                                â”‚     target_mo
â”‚             â”‚ â”‚                                                â”‚ SkipValidatio
â”‚             â”‚ â”‚                                                â”‚ ignore
â”‚             â”‚ â”‚                                                â”‚     """The co
â”‚             â”‚ â”‚                                                â”‚ model."""
â”‚             â”‚ â”‚                                                â”‚     target_pa
â”‚             â”‚ â”‚                                                â”‚         Paral
â”‚             â”‚ â”‚                                                â”‚     """The pa
â”‚             â”‚ â”‚                                                â”‚ target model.
â”‚             â”‚ â”‚                                                â”‚     enable_ch
â”‚             â”‚ â”‚                                                â”‚ None  # type:
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ chunked prefi
â”‚             â”‚ â”‚                                                â”‚     raising a
â”‚             â”‚ â”‚                                                â”‚ compatible wi
â”‚             â”‚ â”‚                                                â”‚     disable_l
â”‚             â”‚ â”‚                                                â”‚ type: ignore
â”‚             â”‚ â”‚                                                â”‚     """Whethe
â”‚             â”‚ â”‚                                                â”‚ of stage time
â”‚             â”‚ â”‚                                                â”‚     decoding.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # params
â”‚             â”‚ â”‚                                                â”‚     draft_mod
â”‚             â”‚ â”‚                                                â”‚ SkipValidatio
â”‚             â”‚ â”‚                                                â”‚ ignore
â”‚             â”‚ â”‚                                                â”‚     """The co
â”‚             â”‚ â”‚                                                â”‚ initialized i
â”‚             â”‚ â”‚                                                â”‚     draft_par
â”‚             â”‚ â”‚                                                â”‚         Paral
â”‚             â”‚ â”‚                                                â”‚     """The pa
â”‚             â”‚ â”‚                                                â”‚ model initial
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         WARNI
â”‚             â”‚ â”‚                                                â”‚ to this confi
â”‚             â”‚ â”‚                                                â”‚         ensur
â”‚             â”‚ â”‚                                                â”‚ factors list
â”‚             â”‚ â”‚                                                â”‚         it af
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         # Eag
â”‚             â”‚ â”‚                                                â”‚ because it re
â”‚             â”‚ â”‚                                                â”‚         # hid
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚         hash_
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @classmet
â”‚             â”‚ â”‚                                                â”‚     def from_
â”‚             â”‚ â”‚                                                â”‚ "SpeculativeC
â”‚             â”‚ â”‚                                                â”‚         """Pa
â”‚             â”‚ â”‚                                                â”‚ speculative c
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def hf_co
â”‚             â”‚ â”‚                                                â”‚ PretrainedCon
â”‚             â”‚ â”‚                                                â”‚         if hf
â”‚             â”‚ â”‚                                                â”‚ "deepseek_v3"
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ "deepseek_mtp
â”‚             â”‚ â”‚                                                â”‚         if hf
â”‚             â”‚ â”‚                                                â”‚ "deepseek_mtp
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ "num_nextn_pr
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ["DeepSeekMTP
â”‚             â”‚ â”‚                                                â”‚             }
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if hf
â”‚             â”‚ â”‚                                                â”‚ "MiMoForCausa
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ "num_nextn_pr
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ["MiMoMTPMode
â”‚             â”‚ â”‚                                                â”‚             }
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if hf
â”‚             â”‚ â”‚                                                â”‚ "Glm4MoeForCa
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ "glm4_moe_mtp
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ "num_nextn_pr
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ["Glm4MoeMTPM
â”‚             â”‚ â”‚                                                â”‚             }
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Not
â”‚             â”‚ â”‚                                                â”‚ that helps to
â”‚             â”‚ â”‚                                                â”‚         # con
â”‚             â”‚ â”‚                                                â”‚ proposers, an
â”‚             â”‚ â”‚                                                â”‚         # wil
â”‚             â”‚ â”‚                                                â”‚ eagle head, o
â”‚             â”‚ â”‚                                                â”‚         # whe
â”‚             â”‚ â”‚                                                â”‚ "method", the
â”‚             â”‚ â”‚                                                â”‚         # wil
â”‚             â”‚ â”‚                                                â”‚ possible. If
â”‚             â”‚ â”‚                                                â”‚         # can
â”‚             â”‚ â”‚                                                â”‚ considered as
â”‚             â”‚ â”‚                                                â”‚         # def
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.num_spec
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ configuration
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ besides deeps
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ same model:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.target_m
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ValueError("n
â”‚             â”‚ â”‚                                                â”‚ without "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ model.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # Aut
â”‚             â”‚ â”‚                                                â”‚ for ngram whe
â”‚             â”‚ â”‚                                                â”‚         # ins
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ is not None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.model in
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ provided
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is None):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ values. They
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is not None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.prompt_l
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is not None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.prompt_l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ must be > 0")
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ must be > 0")
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.prompt_l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ must "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ prompt_lookup
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ extract vocab
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ refactor it o
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ here.
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ self.target_m
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ self.target_p
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ModelConfig(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ method
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ 'eagle3'):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.draft_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.draft_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.draft_mo
â”‚             â”‚ â”‚                                                â”‚ "medusa":
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ (self.draft_m
â”‚             â”‚ â”‚                                                â”‚ ==
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "mlp_speculat
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ (self.draft_m
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "mimo_mtp", "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "deepseek_mtp
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.num_spec
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ MTP models on
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Might need so
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ multiple laye
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ with draft mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ consider usin
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ methods such
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ deepseek_mtp.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ draft_model
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "eagle3"):
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.enable_c
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_USE
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ and EAGLE are
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ vllm.transfor
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ isinstance(se
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ EAGLEConfig(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = eagle_confi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is not None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ hasattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.num_spec
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ defined in dr
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = n_predict
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.num_spec
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ % n_predict !
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ for MTP modul
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ divisible by
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = (
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def _mayb
â”‚             â”‚ â”‚                                                â”‚         specu
â”‚             â”‚ â”‚                                                â”‚         draft
â”‚             â”‚ â”‚                                                â”‚         targe
â”‚             â”‚ â”‚                                                â”‚     ) -> int:
â”‚             â”‚ â”‚                                                â”‚         """De
â”‚             â”‚ â”‚                                                â”‚ the draft mod
â”‚             â”‚ â”‚                                                â”‚         the d
â”‚             â”‚ â”‚                                                â”‚ target_max_mo
â”‚             â”‚ â”‚                                                â”‚         less
â”‚             â”‚ â”‚                                                â”‚ may be specul
â”‚             â”‚ â”‚                                                â”‚         if it
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         This
â”‚             â”‚ â”‚                                                â”‚ not exceed th
â”‚             â”‚ â”‚                                                â”‚         draft
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         specu
â”‚             â”‚ â”‚                                                â”‚ used for test
â”‚             â”‚ â”‚                                                â”‚         skip
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if sp
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ draft_max_mod
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ValueError(f"
â”‚             â”‚ â”‚                                                â”‚ cannot be "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {draft_max_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ target_max_mo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ValueError(f"
â”‚             â”‚ â”‚                                                â”‚ cannot be "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {target_max_m
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚         )
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚ ParallelConfi
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ Optional,
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚ -> int:
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         Verif
â”‚             â”‚ â”‚                                                â”‚ parallel size
â”‚             â”‚ â”‚                                                â”‚         speci
â”‚             â”‚ â”‚                                                â”‚ speculative_d
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         # If
â”‚             â”‚ â”‚                                                â”‚ speculative_d
â”‚             â”‚ â”‚                                                â”‚ then set it
â”‚             â”‚ â”‚                                                â”‚         # app
â”‚             â”‚ â”‚                                                â”‚ set correctly
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ speculative_d
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ "mlp_speculat
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = 1
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ target_parall
â”‚             â”‚ â”‚                                                â”‚ 1:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ run with tp>1
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ speculative_d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         elif
â”‚             â”‚ â”‚                                                â”‚ speculative_d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ target_parall
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ cannot be "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ model tensor_
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ speculative_d
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def creat
â”‚             â”‚ â”‚                                                â”‚         targe
â”‚             â”‚ â”‚                                                â”‚         specu
â”‚             â”‚ â”‚                                                â”‚ int,
â”‚             â”‚ â”‚                                                â”‚     ) -> Para
â”‚             â”‚ â”‚                                                â”‚         """Cr
â”‚             â”‚ â”‚                                                â”‚ the draft wor
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         This
â”‚             â”‚ â”‚                                                â”‚ parallel conf
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         draft
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚             t
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚             d
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚         )
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @model_va
â”‚             â”‚ â”‚                                                â”‚     def _veri
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ provided with
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ draft model c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ num_speculati
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ ({self.num_sp
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ < 2):
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ size threshol
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ decoding is >
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.target_m
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ self.target_m
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Llama models.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {self.target_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @property
â”‚             â”‚ â”‚                                                â”‚     def num_l
â”‚             â”‚ â”‚                                                â”‚         """Th
â”‚             â”‚ â”‚                                                â”‚ scheduler sho
â”‚             â”‚ â”‚                                                â”‚         step,
â”‚             â”‚ â”‚                                                â”‚ allocated for
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         This
â”‚             â”‚ â”‚                                                â”‚ speculative t
â”‚             â”‚ â”‚                                                â”‚         token
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def use_e
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ "eagle3", "de
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __rep
â”‚             â”‚ â”‚                                                â”‚         metho
â”‚             â”‚ â”‚                                                â”‚         model
â”‚             â”‚ â”‚                                                â”‚ self.draft_mo
â”‚             â”‚ â”‚                                                â”‚         num_s
â”‚             â”‚ â”‚                                                â”‚ self.num_spec
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ {model=}, {nu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ LoRADType = L
â”‚             â”‚ â”‚                                                â”‚ "bfloat16"]
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass(co
â”‚             â”‚ â”‚                                                â”‚ class LoRACon
â”‚             â”‚ â”‚                                                â”‚     """Config
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     max_lora_
â”‚             â”‚ â”‚                                                â”‚     """Max Lo
â”‚             â”‚ â”‚                                                â”‚     max_loras
â”‚             â”‚ â”‚                                                â”‚     """Max nu
â”‚             â”‚ â”‚                                                â”‚ batch."""
â”‚             â”‚ â”‚                                                â”‚     fully_sha
â”‚             â”‚ â”‚                                                â”‚     """By def
â”‚             â”‚ â”‚                                                â”‚ computation i
â”‚             â”‚ â”‚                                                â”‚     paralleli
â”‚             â”‚ â”‚                                                â”‚ fully sharded
â”‚             â”‚ â”‚                                                â”‚     sequence
â”‚             â”‚ â”‚                                                â”‚ parallel size
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     max_cpu_l
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ memory. Must
â”‚             â”‚ â”‚                                                â”‚     `max_lora
â”‚             â”‚ â”‚                                                â”‚     lora_dtyp
â”‚             â”‚ â”‚                                                â”‚     """Data t
â”‚             â”‚ â”‚                                                â”‚ default to ba
â”‚             â”‚ â”‚                                                â”‚     lora_extr
â”‚             â”‚ â”‚                                                â”‚     """Maximu
â”‚             â”‚ â”‚                                                â”‚ can be presen
â”‚             â”‚ â”‚                                                â”‚     (added to
â”‚             â”‚ â”‚                                                â”‚     lora_voca
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚         .get_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     default_m
â”‚             â”‚ â”‚                                                â”‚     """Dictio
â”‚             â”‚ â”‚                                                â”‚ to LoRA model
â”‚             â”‚ â”‚                                                â”‚     is only a
â”‚             â”‚ â”‚                                                â”‚ should be lev
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 84477 Output: 2290
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 6: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'grep -n                           â”‚ 2467:    disa
â”‚             â”‚ â”‚ "disable_hybrid_kv_cache_manager" -n           â”‚ = False
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ 4772:
â”‚             â”‚ â”‚ 'restart': False}                              â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ 4778:
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚ 4781:
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚ 4784:
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚ 4791:
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 127284 Output: 2882
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 7: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '4720,4810p'               â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ CompilationLe
â”‚             â”‚ â”‚ 'restart': False}                              â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ with `torch.c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ CompilationLe
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ supported wit
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Disabling cas
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         disab
â”‚             â”‚ â”‚                                                â”‚ []
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ pooling_type.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ supports chun
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ caching; disa
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if di
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ disable_chunk
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = False
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = 0
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = max(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = False
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.kv_event
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.cache_co
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ prefix cachin
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enable.")
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.kv_event
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.kv_event
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ disabled,"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is configured
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ KVEventsConfi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enable.")
â”‚             â”‚ â”‚                                                â”‚         curre
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ random_uuid()
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ message for h
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ hybrid or not
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ it later.
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ or current_pl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not supported
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not compatibl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not compatibl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ and \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is not None a
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None and \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not yet suppo
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def
â”‚             â”‚ â”‚                                                â”‚ update_sizes_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ list) -> list
â”‚             â”‚ â”‚                                                â”‚         # rem
â”‚             â”‚ â”‚                                                â”‚ tp_size when
â”‚             â”‚ â”‚                                                â”‚         # ena
â”‚             â”‚ â”‚                                                â”‚         remov
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.parallel
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚         if re
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ because they
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enabled", rem
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.parallel
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 170802 Output: 2957
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 8: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'view', 'file_text': '',           â”‚ Here's the re
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': '', 'old_str':    â”‚ /home/raven/c
â”‚             â”‚ â”‚ '', 'path':                                    â”‚   4768
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚   4769
â”‚             â”‚ â”‚ 'view_range': [4768, 4800]}                    â”‚ random_uuid()
â”‚             â”‚ â”‚                                                â”‚   4770
â”‚             â”‚ â”‚                                                â”‚   4771
â”‚             â”‚ â”‚                                                â”‚   4772
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚   4773
â”‚             â”‚ â”‚                                                â”‚ warning messa
â”‚             â”‚ â”‚                                                â”‚   4774
â”‚             â”‚ â”‚                                                â”‚ model is hybr
â”‚             â”‚ â”‚                                                â”‚   4775
â”‚             â”‚ â”‚                                                â”‚ will log it l
â”‚             â”‚ â”‚                                                â”‚   4776
â”‚             â”‚ â”‚                                                â”‚ (current_plat
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚   4777
â”‚             â”‚ â”‚                                                â”‚ manager is no
â”‚             â”‚ â”‚                                                â”‚   4778
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚   4779
â”‚             â”‚ â”‚                                                â”‚ is not None:
â”‚             â”‚ â”‚                                                â”‚   4780
â”‚             â”‚ â”‚                                                â”‚ manager is no
â”‚             â”‚ â”‚                                                â”‚   4781
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚   4782
â”‚             â”‚ â”‚                                                â”‚ not None:
â”‚             â”‚ â”‚                                                â”‚   4783
â”‚             â”‚ â”‚                                                â”‚ manager is no
â”‚             â”‚ â”‚                                                â”‚   4784
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚   4785
â”‚             â”‚ â”‚                                                â”‚ None and \
â”‚             â”‚ â”‚                                                â”‚   4786
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚ None and \
â”‚             â”‚ â”‚                                                â”‚   4787
â”‚             â”‚ â”‚                                                â”‚ is not None a
â”‚             â”‚ â”‚                                                â”‚   4788
â”‚             â”‚ â”‚                                                â”‚ self.speculat
â”‚             â”‚ â”‚                                                â”‚   4789
â”‚             â”‚ â”‚                                                â”‚ manager is no
â”‚             â”‚ â”‚                                                â”‚   4790
â”‚             â”‚ â”‚                                                â”‚ eagle.
â”‚             â”‚ â”‚                                                â”‚   4791
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚   4792
â”‚             â”‚ â”‚                                                â”‚   4793      d
â”‚             â”‚ â”‚                                                â”‚ update_sizes_
â”‚             â”‚ â”‚                                                â”‚   4794
â”‚             â”‚ â”‚                                                â”‚ possible_size
â”‚             â”‚ â”‚                                                â”‚   4795
â”‚             â”‚ â”‚                                                â”‚ multiple of t
â”‚             â”‚ â”‚                                                â”‚   4796
â”‚             â”‚ â”‚                                                â”‚   4797
â”‚             â”‚ â”‚                                                â”‚   4798
â”‚             â”‚ â”‚                                                â”‚ possible_size
â”‚             â”‚ â”‚                                                â”‚   4799
â”‚             â”‚ â”‚                                                â”‚ self.parallel
â”‚             â”‚ â”‚                                                â”‚   4800
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 215287 Output: 3177
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 9: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '1,240p'                   â”‚ # SPDX-Licens
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ # SPDX-FileCo
â”‚             â”‚ â”‚ 'restart': False}                              â”‚ contributors
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ import hashli
â”‚             â”‚ â”‚                                                â”‚ import os
â”‚             â”‚ â”‚                                                â”‚ import sys
â”‚             â”‚ â”‚                                                â”‚ import tempfi
â”‚             â”‚ â”‚                                                â”‚ from typing i
â”‚             â”‚ â”‚                                                â”‚ Callable, Opt
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ if TYPE_CHECK
â”‚             â”‚ â”‚                                                â”‚     VLLM_HOST
â”‚             â”‚ â”‚                                                â”‚     VLLM_PORT
â”‚             â”‚ â”‚                                                â”‚     VLLM_RPC_
â”‚             â”‚ â”‚                                                â”‚ tempfile.gett
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_RING
â”‚             â”‚ â”‚                                                â”‚     VLLM_NCCL
â”‚             â”‚ â”‚                                                â”‚     LD_LIBRAR
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_V1_U
â”‚             â”‚ â”‚                                                â”‚ = False
â”‚             â”‚ â”‚                                                â”‚     VLLM_FLAS
â”‚             â”‚ â”‚                                                â”‚     LOCAL_RAN
â”‚             â”‚ â”‚                                                â”‚     CUDA_VISI
â”‚             â”‚ â”‚                                                â”‚     VLLM_ENGI
â”‚             â”‚ â”‚                                                â”‚     VLLM_API_
â”‚             â”‚ â”‚                                                â”‚     S3_ACCESS
â”‚             â”‚ â”‚                                                â”‚     S3_SECRET
â”‚             â”‚ â”‚                                                â”‚     S3_ENDPOI
â”‚             â”‚ â”‚                                                â”‚     VLLM_MODE
â”‚             â”‚ â”‚                                                â”‚     VLLM_CACH
â”‚             â”‚ â”‚                                                â”‚ os.path.expan
â”‚             â”‚ â”‚                                                â”‚     VLLM_CONF
â”‚             â”‚ â”‚                                                â”‚ os.path.expan
â”‚             â”‚ â”‚                                                â”‚     VLLM_USAG
â”‚             â”‚ â”‚                                                â”‚ "https://stat
â”‚             â”‚ â”‚                                                â”‚     VLLM_NO_U
â”‚             â”‚ â”‚                                                â”‚     VLLM_DO_N
â”‚             â”‚ â”‚                                                â”‚     VLLM_USAG
â”‚             â”‚ â”‚                                                â”‚     VLLM_CONF
â”‚             â”‚ â”‚                                                â”‚     VLLM_LOGG
â”‚             â”‚ â”‚                                                â”‚     VLLM_LOGG
â”‚             â”‚ â”‚                                                â”‚     VLLM_LOGG
â”‚             â”‚ â”‚                                                â”‚     VLLM_LOGI
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     VLLM_TRAC
â”‚             â”‚ â”‚                                                â”‚     VLLM_ATTE
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     VLLM_FLAS
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚     VLLM_PP_L
â”‚             â”‚ â”‚                                                â”‚     VLLM_CPU_
â”‚             â”‚ â”‚                                                â”‚     VLLM_CPU_
â”‚             â”‚ â”‚                                                â”‚     VLLM_CPU_
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     VLLM_CPU_
â”‚             â”‚ â”‚                                                â”‚     VLLM_CPU_
â”‚             â”‚ â”‚                                                â”‚     VLLM_XLA_
â”‚             â”‚ â”‚                                                â”‚ os.path.join(
â”‚             â”‚ â”‚                                                â”‚     VLLM_XLA_
â”‚             â”‚ â”‚                                                â”‚     VLLM_FUSE
â”‚             â”‚ â”‚                                                â”‚     VLLM_ENAB
â”‚             â”‚ â”‚                                                â”‚ bool = True
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚ = "auto"
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚ bool = False
â”‚             â”‚ â”‚                                                â”‚     VLLM_XLA_
â”‚             â”‚ â”‚                                                â”‚     VLLM_WORK
â”‚             â”‚ â”‚                                                â”‚     VLLM_ASSE
â”‚             â”‚ â”‚                                                â”‚ os.path.join(
â”‚             â”‚ â”‚                                                â”‚     VLLM_IMAG
â”‚             â”‚ â”‚                                                â”‚     VLLM_VIDE
â”‚             â”‚ â”‚                                                â”‚     VLLM_AUDI
â”‚             â”‚ â”‚                                                â”‚     VLLM_MAX_
â”‚             â”‚ â”‚                                                â”‚     VLLM_VIDE
â”‚             â”‚ â”‚                                                â”‚     VLLM_MM_I
â”‚             â”‚ â”‚                                                â”‚     VLLM_TARG
â”‚             â”‚ â”‚                                                â”‚     MAX_JOBS:
â”‚             â”‚ â”‚                                                â”‚     NVCC_THRE
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_TEST
â”‚             â”‚ â”‚                                                â”‚ bool = False
â”‚             â”‚ â”‚                                                â”‚     VLLM_NO_D
â”‚             â”‚ â”‚                                                â”‚     VLLM_KEEP
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚     CMAKE_BUI
â”‚             â”‚ â”‚                                                â”‚     VERBOSE:
â”‚             â”‚ â”‚                                                â”‚     VLLM_ALLO
â”‚             â”‚ â”‚                                                â”‚     VLLM_RPC_
â”‚             â”‚ â”‚                                                â”‚     VLLM_HTTP
â”‚             â”‚ â”‚                                                â”‚ seconds
â”‚             â”‚ â”‚                                                â”‚     VLLM_PLUG
â”‚             â”‚ â”‚                                                â”‚     VLLM_LORA
â”‚             â”‚ â”‚                                                â”‚ None
â”‚             â”‚ â”‚                                                â”‚     VLLM_TORC
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_ALLO
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚     VLLM_SKIP
â”‚             â”‚ â”‚                                                â”‚     VLLM_DISA
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚     VLLM_ENAB
â”‚             â”‚ â”‚                                                â”‚     VLLM_LOG_
â”‚             â”‚ â”‚                                                â”‚     VLLM_DISA
â”‚             â”‚ â”‚                                                â”‚     Q_SCALE_C
â”‚             â”‚ â”‚                                                â”‚     K_SCALE_C
â”‚             â”‚ â”‚                                                â”‚     V_SCALE_C
â”‚             â”‚ â”‚                                                â”‚     VLLM_SERV
â”‚             â”‚ â”‚                                                â”‚     VLLM_V1_O
â”‚             â”‚ â”‚                                                â”‚     VLLM_MLA_
â”‚             â”‚ â”‚                                                â”‚     VLLM_RAY_
â”‚             â”‚ â”‚                                                â”‚     VLLM_RAY_
â”‚             â”‚ â”‚                                                â”‚     VLLM_CUDA
â”‚             â”‚ â”‚                                                â”‚     VLLM_DP_R
â”‚             â”‚ â”‚                                                â”‚     VLLM_DP_R
â”‚             â”‚ â”‚                                                â”‚     VLLM_DP_S
â”‚             â”‚ â”‚                                                â”‚     VLLM_DP_M
â”‚             â”‚ â”‚                                                â”‚     VLLM_DP_M
â”‚             â”‚ â”‚                                                â”‚     VLLM_MOE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_RAND
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚     VLLM_MARL
â”‚             â”‚ â”‚                                                â”‚     VLLM_V0_U
â”‚             â”‚ â”‚                                                â”‚     VLLM_V1_U
â”‚             â”‚ â”‚                                                â”‚     VLLM_TPU_
â”‚             â”‚ â”‚                                                â”‚     VLLM_TPU_
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_XGRA
â”‚             â”‚ â”‚                                                â”‚     VLLM_MSGP
â”‚             â”‚ â”‚                                                â”‚     VLLM_ALLO
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚     VLLM_NIXL
â”‚             â”‚ â”‚                                                â”‚ "localhost"
â”‚             â”‚ â”‚                                                â”‚     VLLM_NIXL
â”‚             â”‚ â”‚                                                â”‚     VLLM_ALL2
â”‚             â”‚ â”‚                                                â”‚     VLLM_MAX_
â”‚             â”‚ â”‚                                                â”‚ 163840
â”‚             â”‚ â”‚                                                â”‚     VLLM_TOOL
â”‚             â”‚ â”‚                                                â”‚ = 1
â”‚             â”‚ â”‚                                                â”‚     VLLM_SLEE
â”‚             â”‚ â”‚                                                â”‚     VLLM_MQ_M
â”‚             â”‚ â”‚                                                â”‚     VLLM_EXEC
â”‚             â”‚ â”‚                                                â”‚ 300
â”‚             â”‚ â”‚                                                â”‚     VLLM_KV_C
â”‚             â”‚ â”‚                                                â”‚     VLLM_COMP
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚ "NONE"
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚ bool = True
â”‚             â”‚ â”‚                                                â”‚     VLLM_ROCM
â”‚             â”‚ â”‚                                                â”‚ Optional = No
â”‚             â”‚ â”‚                                                â”‚     VLLM_NIXL
â”‚             â”‚ â”‚                                                â”‚     VLLM_USE_
â”‚             â”‚ â”‚                                                â”‚     VLLM_ENAB
â”‚             â”‚ â”‚                                                â”‚     VLLM_LOOP
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def get_defau
â”‚             â”‚ â”‚                                                â”‚     return os
â”‚             â”‚ â”‚                                                â”‚         "XDG_
â”‚             â”‚ â”‚                                                â”‚         os.pa
â”‚             â”‚ â”‚                                                â”‚ ".cache"),
â”‚             â”‚ â”‚                                                â”‚     )
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def get_defau
â”‚             â”‚ â”‚                                                â”‚     return os
â”‚             â”‚ â”‚                                                â”‚         "XDG_
â”‚             â”‚ â”‚                                                â”‚         os.pa
â”‚             â”‚ â”‚                                                â”‚ ".config"),
â”‚             â”‚ â”‚                                                â”‚     )
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def maybe_con
â”‚             â”‚ â”‚                                                â”‚ Optional:
â”‚             â”‚ â”‚                                                â”‚     if value
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚     return in
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def get_vllm_
â”‚             â”‚ â”‚                                                â”‚     """Get th
â”‚             â”‚ â”‚                                                â”‚ variable.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     Returns:
â”‚             â”‚ â”‚                                                â”‚         The p
â”‚             â”‚ â”‚                                                â”‚ VLLM_PORT is
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     Raises:
â”‚             â”‚ â”‚                                                â”‚         Value
â”‚             â”‚ â”‚                                                â”‚ suggest k8s s
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     if 'VLLM_
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     port = os
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     try:
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚     except Va
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚         parse
â”‚             â”‚ â”‚                                                â”‚         if pa
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ be a URI. "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Kubernetes se
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ https://docs.
â”‚             â”‚ â”‚                                                â”‚             )
â”‚             â”‚ â”‚                                                â”‚         raise
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ valid integer
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # The begin-*
â”‚             â”‚ â”‚                                                â”‚ documentation
â”‚             â”‚ â”‚                                                â”‚ # to extract
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # --8<--
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ environment_v
â”‚             â”‚ â”‚                                                â”‚ Any]] = {
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # =======
â”‚             â”‚ â”‚                                                â”‚ Vars ========
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Target
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TAR
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ "cuda"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Maximum
â”‚             â”‚ â”‚                                                â”‚ in parallel.
â”‚             â”‚ â”‚                                                â”‚     # By defa
â”‚             â”‚ â”‚                                                â”‚     "MAX_JOBS
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Number
â”‚             â”‚ â”‚                                                â”‚     # By defa
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ avoid oversub
â”‚             â”‚ â”‚                                                â”‚     "NVCC_THR
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ binaries (*.s
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(os.envir
â”‚             â”‚ â”‚                                                â”‚ bool(
â”‚             â”‚ â”‚                                                â”‚         os.en
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚ python build.
â”‚             â”‚ â”‚                                                â”‚     # This is
â”‚             â”‚ â”‚                                                â”‚ wheel in pyth
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TES
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # CMake b
â”‚             â”‚ â”‚                                                â”‚     # If not
â”‚             â”‚ â”‚                                                â”‚ "RelWithDebIn
â”‚             â”‚ â”‚                                                â”‚     # Availab
â”‚             â”‚ â”‚                                                â”‚ "RelWithDebIn
â”‚             â”‚ â”‚                                                â”‚     "CMAKE_BU
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ during instal
â”‚             â”‚ â”‚                                                â”‚     "VERBOSE"
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 260597 Output: 3509
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 10: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '240,960p'                 â”‚     "VERBOSE"
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚     lambda: b
â”‚             â”‚ â”‚ 'restart': False}                              â”‚ '0'))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Root di
â”‚             â”‚ â”‚                                                â”‚ files
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚ `XDG_CONFIG_H
â”‚             â”‚ â”‚                                                â”‚     # Note th
â”‚             â”‚ â”‚                                                â”‚ finds its con
â”‚             â”‚ â”‚                                                â”‚     # during
â”‚             â”‚ â”‚                                                â”‚ installs its
â”‚             â”‚ â”‚                                                â”‚     # files d
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CON
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚         os.ge
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             o
â”‚             â”‚ â”‚                                                â”‚ "vllm"),
â”‚             â”‚ â”‚                                                â”‚         )),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # =======
â”‚             â”‚ â”‚                                                â”‚ =============
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Root di
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚ `XDG_CACHE_HO
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CAC
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚         os.ge
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             o
â”‚             â”‚ â”‚                                                â”‚ "vllm"),
â”‚             â”‚ â”‚                                                â”‚         )),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # used in
â”‚             â”‚ â”‚                                                â”‚ determine the
â”‚             â”‚ â”‚                                                â”‚     # of the
â”‚             â”‚ â”‚                                                â”‚ multiple netw
â”‚             â”‚ â”‚                                                â”‚     # If you
â”‚             â”‚ â”‚                                                â”‚ you should se
â”‚             â”‚ â”‚                                                â”‚     # on each
â”‚             â”‚ â”‚                                                â”‚     'VLLM_HOS
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # used in
â”‚             â”‚ â”‚                                                â”‚ manually set
â”‚             â”‚ â”‚                                                â”‚     # Note: i
â”‚             â”‚ â”‚                                                â”‚ asks for mult
â”‚             â”‚ â”‚                                                â”‚     # VLLM_PO
â”‚             â”‚ â”‚                                                â”‚ and the rest
â”‚             â”‚ â”‚                                                â”‚     # by incr
â”‚             â”‚ â”‚                                                â”‚     'VLLM_POR
â”‚             â”‚ â”‚                                                â”‚     get_vllm_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # path us
â”‚             â”‚ â”‚                                                â”‚ server is run
â”‚             â”‚ â”‚                                                â”‚     # multi-p
â”‚             â”‚ â”‚                                                â”‚ the backend e
â”‚             â”‚ â”‚                                                â”‚     'VLLM_RPC
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ tempfile.gett
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If true
â”‚             â”‚ â”‚                                                â”‚ instead of Hu
â”‚             â”‚ â”‚                                                â”‚     # note th
â”‚             â”‚ â”‚                                                â”‚ numbers
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "False").lowe
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Interva
â”‚             â”‚ â”‚                                                â”‚ message when
â”‚             â”‚ â”‚                                                â”‚     "VLLM_RIN
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.enviro
â”‚             â”‚ â”‚                                                â”‚ "60")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # path to
â”‚             â”‚ â”‚                                                â”‚ which should
â”‚             â”‚ â”‚                                                â”‚     # and lib
â”‚             â”‚ â”‚                                                â”‚     "CUDA_HOM
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Path to
â”‚             â”‚ â”‚                                                â”‚ needed becaus
â”‚             â”‚ â”‚                                                â”‚     # by PyTo
â”‚             â”‚ â”‚                                                â”‚ https://githu
â”‚             â”‚ â”‚                                                â”‚     "VLLM_NCC
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # when `V
â”‚             â”‚ â”‚                                                â”‚ will try to f
â”‚             â”‚ â”‚                                                â”‚     # library
â”‚             â”‚ â”‚                                                â”‚ by `LD_LIBRAR
â”‚             â”‚ â”‚                                                â”‚     "LD_LIBRA
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # flag to
â”‚             â”‚ â”‚                                                â”‚ flash attenti
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.environ.g
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Use sep
â”‚             â”‚ â”‚                                                â”‚ for V1 attent
â”‚             â”‚ â”‚                                                â”‚     # the uni
â”‚             â”‚ â”‚                                                â”‚     "VLLM_V1_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚     (os.geten
â”‚             â”‚ â”‚                                                â”‚ "False").lowe
â”‚             â”‚ â”‚                                                â”‚      ("true",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Force v
â”‚             â”‚ â”‚                                                â”‚ flash-attenti
â”‚             â”‚ â”‚                                                â”‚     # when us
â”‚             â”‚ â”‚                                                â”‚     "VLLM_FLA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ maybe_convert
â”‚             â”‚ â”‚                                                â”‚ None)),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Interna
â”‚             â”‚ â”‚                                                â”‚ capture
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TES
â”‚             â”‚ â”‚                                                â”‚     lambda: b
â”‚             â”‚ â”‚                                                â”‚         os.en
â”‚             â”‚ â”‚                                                â”‚ "1") != "0"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Feature
â”‚             â”‚ â”‚                                                â”‚ standalone co
â”‚             â”‚ â”‚                                                â”‚     # In torc
â”‚             â”‚ â”‚                                                â”‚ torch >= 2.8
â”‚             â”‚ â”‚                                                â”‚     # enabled
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "1") == "1",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # local r
â”‚             â”‚ â”‚                                                â”‚ distributed s
â”‚             â”‚ â”‚                                                â”‚     # the GPU
â”‚             â”‚ â”‚                                                â”‚     "LOCAL_RA
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚ "0")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # used to
â”‚             â”‚ â”‚                                                â”‚ the distribut
â”‚             â”‚ â”‚                                                â”‚     "CUDA_VIS
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # timeout
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ENG
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.enviro
â”‚             â”‚ â”‚                                                â”‚ "60")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # API key
â”‚             â”‚ â”‚                                                â”‚     "VLLM_API
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚ for debugging
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DEB
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "False"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # S3 acce
â”‚             â”‚ â”‚                                                â”‚ tensorizer to
â”‚             â”‚ â”‚                                                â”‚     "S3_ACCES
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚     "S3_SECRE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚     "S3_ENDPO
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Usage s
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "https://stat
â”‚             â”‚ â”‚                                                â”‚     "VLLM_NO_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "1",
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DO_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.environ.g
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚         "DO_N
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USA
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ "production")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Logging
â”‚             â”‚ â”‚                                                â”‚     # If set
â”‚             â”‚ â”‚                                                â”‚ logging
â”‚             â”‚ â”‚                                                â”‚     # If set
â”‚             â”‚ â”‚                                                â”‚ using the def
â”‚             â”‚ â”‚                                                â”‚     #    or t
â”‚             â”‚ â”‚                                                â”‚ VLLM_LOGGING_
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CON
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚     "VLLM_LOG
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # this is
â”‚             â”‚ â”‚                                                â”‚ logging level
â”‚             â”‚ â”‚                                                â”‚     "VLLM_LOG
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ "INFO").upper
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # if set,
â”‚             â”‚ â”‚                                                â”‚ prepended to
â”‚             â”‚ â”‚                                                â”‚     "VLLM_LOG
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ ""),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # if set,
â”‚             â”‚ â”‚                                                â”‚ in a thread p
â”‚             â”‚ â”‚                                                â”‚     # threads
â”‚             â”‚ â”‚                                                â”‚ logits proces
â”‚             â”‚ â”‚                                                â”‚     # (a) lau
â”‚             â”‚ â”‚                                                â”‚ do significan
â”‚             â”‚ â”‚                                                â”‚     # while n
â”‚             â”‚ â”‚                                                â”‚ both.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_LOG
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "0"))
â”‚             â”‚ â”‚                                                â”‚     if "VLLM_
â”‚             â”‚ â”‚                                                â”‚ os.environ el
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Trace f
â”‚             â”‚ â”‚                                                â”‚     # If set
â”‚             â”‚ â”‚                                                â”‚ calls
â”‚             â”‚ â”‚                                                â”‚     # Useful
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TRA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Backend
â”‚             â”‚ â”‚                                                â”‚     # Availab
â”‚             â”‚ â”‚                                                â”‚     # - "TORC
â”‚             â”‚ â”‚                                                â”‚ torch.nn.Mult
â”‚             â”‚ â”‚                                                â”‚     # - "FLAS
â”‚             â”‚ â”‚                                                â”‚     # - "XFOR
â”‚             â”‚ â”‚                                                â”‚     # - "ROCM
â”‚             â”‚ â”‚                                                â”‚     # - "FLAS
â”‚             â”‚ â”‚                                                â”‚     # - "FLAS
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ATT
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.e
â”‚             â”‚ â”‚                                                â”‚     if "VLLM_
â”‚             â”‚ â”‚                                                â”‚ os.environ el
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ tensor cores;
â”‚             â”‚ â”‚                                                â”‚     # otherwi
â”‚             â”‚ â”‚                                                â”‚ model archite
â”‚             â”‚ â”‚                                                â”‚     "VLLM_FLA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Pipelin
â”‚             â”‚ â”‚                                                â”‚     "VLLM_PP_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # (CPU ba
â”‚             â”‚ â”‚                                                â”‚ space.
â”‚             â”‚ â”‚                                                â”‚     # default
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CPU
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚     if "VLLM_
â”‚             â”‚ â”‚                                                â”‚ else None,
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # (CPU ba
â”‚             â”‚ â”‚                                                â”‚ OpenMP thread
â”‚             â”‚ â”‚                                                â”‚     # "0,1,2"
â”‚             â”‚ â”‚                                                â”‚ different ran
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CPU
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # (CPU ba
â”‚             â”‚ â”‚                                                â”‚ OMP threads .
â”‚             â”‚ â”‚                                                â”‚     # Those C
â”‚             â”‚ â”‚                                                â”‚ threads of a
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CPU
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "0"))
â”‚             â”‚ â”‚                                                â”‚     if "VLLM_
â”‚             â”‚ â”‚                                                â”‚ os.environ el
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # (CPU ba
â”‚             â”‚ â”‚                                                â”‚ for MoE layer
â”‚             â”‚ â”‚                                                â”‚     # passed
â”‚             â”‚ â”‚                                                â”‚ On unsupporte
â”‚             â”‚ â”‚                                                â”‚     # need to
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CPU
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "1"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # (CPU ba
â”‚             â”‚ â”‚                                                â”‚ kernels, opti
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CPU
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If the
â”‚             â”‚ â”‚                                                â”‚ will execute
â”‚             â”‚ â”‚                                                â”‚     # process
â”‚             â”‚ â”‚                                                â”‚ same mechanis
â”‚             â”‚ â”‚                                                â”‚     # executi
â”‚             â”‚ â”‚                                                â”‚     # Run vLL
â”‚             â”‚ â”‚                                                â”‚ to enable it.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If the
â”‚             â”‚ â”‚                                                â”‚ Compiled Grap
â”‚             â”‚ â”‚                                                â”‚     # (previo
â”‚             â”‚ â”‚                                                â”‚ optimizes the
â”‚             â”‚ â”‚                                                â”‚     # control
â”‚             â”‚ â”‚                                                â”‚     # Run vLL
â”‚             â”‚ â”‚                                                â”‚ to enable it.
â”‚             â”‚ â”‚                                                â”‚     # Note th
â”‚             â”‚ â”‚                                                â”‚ by default
â”‚             â”‚ â”‚                                                â”‚     # when ra
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If the
â”‚             â”‚ â”‚                                                â”‚ uses the spec
â”‚             â”‚ â”‚                                                â”‚     # channel
â”‚             â”‚ â”‚                                                â”‚ workers belon
â”‚             â”‚ â”‚                                                â”‚     # differe
â”‚             â”‚ â”‚                                                â”‚     # Availab
â”‚             â”‚ â”‚                                                â”‚     # - "auto
â”‚             â”‚ â”‚                                                â”‚     # - "nccl
â”‚             â”‚ â”‚                                                â”‚     # - "shm"
â”‚             â”‚ â”‚                                                â”‚ communication
â”‚             â”‚ â”‚                                                â”‚     # This fl
â”‚             â”‚ â”‚                                                â”‚ VLLM_USE_RAY_
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ "auto"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If the
â”‚             â”‚ â”‚                                                â”‚ communication
â”‚             â”‚ â”‚                                                â”‚     # (experi
â”‚             â”‚ â”‚                                                â”‚ Graph. This f
â”‚             â”‚ â”‚                                                â”‚     # VLLM_US
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Use ded
â”‚             â”‚ â”‚                                                â”‚ workers.
â”‚             â”‚ â”‚                                                â”‚     # Both sp
â”‚             â”‚ â”‚                                                â”‚     "VLLM_WOR
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ "fork"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Path to
â”‚             â”‚ â”‚                                                â”‚ assets
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ASS
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚         os.ge
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             o
â”‚             â”‚ â”‚                                                â”‚ "vllm", "asse
â”‚             â”‚ â”‚                                                â”‚         )),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Timeout
â”‚             â”‚ â”‚                                                â”‚ multimodal mo
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚     "VLLM_IMA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "5")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Timeout
â”‚             â”‚ â”‚                                                â”‚ multimodal mo
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚     "VLLM_VID
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "30")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Timeout
â”‚             â”‚ â”‚                                                â”‚ multimodal mo
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚     "VLLM_AUD
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "10")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Maximum
â”‚             â”‚ â”‚                                                â”‚ file when pro
â”‚             â”‚ â”‚                                                â”‚     # speech-
â”‚             â”‚ â”‚                                                â”‚ than this wil
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MAX
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "25")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Backend
â”‚             â”‚ â”‚                                                â”‚     # - "open
â”‚             â”‚ â”‚                                                â”‚ OpenCV stream
â”‚             â”‚ â”‚                                                â”‚     #
â”‚             â”‚ â”‚                                                â”‚     # Custom
â”‚             â”‚ â”‚                                                â”‚ registered
â”‚             â”‚ â”‚                                                â”‚     # via
â”‚             â”‚ â”‚                                                â”‚ `@VIDEO_LOADE
â”‚             â”‚ â”‚                                                â”‚ and
â”‚             â”‚ â”‚                                                â”‚     # importe
â”‚             â”‚ â”‚                                                â”‚     # If a no
â”‚             â”‚ â”‚                                                â”‚ AssertionErro
â”‚             â”‚ â”‚                                                â”‚     "VLLM_VID
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ "opencv"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Cache s
â”‚             â”‚ â”‚                                                â”‚ cache
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MM_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Path to
â”‚             â”‚ â”‚                                                â”‚ directory.
â”‚             â”‚ â”‚                                                â”‚     # Only us
â”‚             â”‚ â”‚                                                â”‚     "VLLM_XLA
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚         os.ge
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚             o
â”‚             â”‚ â”‚                                                â”‚ "vllm", "xla_
â”‚             â”‚ â”‚                                                â”‚         )),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ each executio
â”‚             â”‚ â”‚                                                â”‚     "VLLM_XLA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Enable
â”‚             â”‚ â”‚                                                â”‚     "VLLM_XLA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚     "VLLM_FUS
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "32768")),
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ activation ch
â”‚             â”‚ â”‚                                                â”‚     # logic i
â”‚             â”‚ â”‚                                                â”‚ and causes IM
â”‚             â”‚ â”‚                                                â”‚     #
â”‚             â”‚ â”‚                                                â”‚ https://githu
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ENA
â”‚             â”‚ â”‚                                                â”‚     lambda: b
â”‚             â”‚ â”‚                                                â”‚         int(o
â”‚             â”‚ â”‚                                                â”‚ "1"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ warnings.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_NO_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ alive even af
â”‚             â”‚ â”‚                                                â”‚     # AsyncLL
â”‚             â”‚ â”‚                                                â”‚ requests
â”‚             â”‚ â”‚                                                â”‚     "VLLM_KEE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(os.geten
â”‚             â”‚ â”‚                                                â”‚ 0)),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If the
â”‚             â”‚ â”‚                                                â”‚ VLLM_ALLOW_LO
â”‚             â”‚ â”‚                                                â”‚     # the use
â”‚             â”‚ â”‚                                                â”‚ greater than
â”‚             â”‚ â”‚                                                â”‚     # the max
â”‚             â”‚ â”‚                                                â”‚ config.json.
â”‚             â”‚ â”‚                                                â”‚     # To enab
â”‚             â”‚ â”‚                                                â”‚ VLLM_ALLOW_LO
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ALL
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚     (os.envir
â”‚             â”‚ â”‚                                                â”‚ "0").strip().
â”‚             â”‚ â”‚                                                â”‚      ("1", "t
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ FP8 quantizat
â”‚             â”‚ â”‚                                                â”‚     # of the
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TES
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚     (os.envir
â”‚             â”‚ â”‚                                                â”‚ "0").strip().
â”‚             â”‚ â”‚                                                â”‚      ("1", "t
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TES
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ "dummy"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Time in
â”‚             â”‚ â”‚                                                â”‚ a response fr
â”‚             â”‚ â”‚                                                â”‚     # server
â”‚             â”‚ â”‚                                                â”‚     "VLLM_RPC
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚ "10000")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Timeout
â”‚             â”‚ â”‚                                                â”‚ connections a
â”‚             â”‚ â”‚                                                â”‚     "VLLM_HTT
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.enviro
â”‚             â”‚ â”‚                                                â”‚ "5")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # a list
â”‚             â”‚ â”‚                                                â”‚ by commas.
â”‚             â”‚ â”‚                                                â”‚     # if this
â”‚             â”‚ â”‚                                                â”‚ will be loade
â”‚             â”‚ â”‚                                                â”‚     # if this
â”‚             â”‚ â”‚                                                â”‚ plugins will
â”‚             â”‚ â”‚                                                â”‚     "VLLM_PLU
â”‚             â”‚ â”‚                                                â”‚     lambda: N
â”‚             â”‚ â”‚                                                â”‚ os.environ el
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # a local
â”‚             â”‚ â”‚                                                â”‚ unrecognized
â”‚             â”‚ â”‚                                                â”‚     # only wo
â”‚             â”‚ â”‚                                                â”‚     # VLLM_AL
â”‚             â”‚ â”‚                                                â”‚ enabled.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_LOR
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Enables
â”‚             â”‚ â”‚                                                â”‚ the directory
â”‚             â”‚ â”‚                                                â”‚     # traces
â”‚             â”‚ â”‚                                                â”‚ absolute path
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TOR
â”‚             â”‚ â”‚                                                â”‚     lambda: (
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ None else os
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "."))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ implementatio
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ adapters in r
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ALL
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚     (os.envir
â”‚             â”‚ â”‚                                                â”‚ "0").strip().
â”‚             â”‚ â”‚                                                â”‚      ("1", "t
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # By defa
â”‚             â”‚ â”‚                                                â”‚ peer-to-peer
â”‚             â”‚ â”‚                                                â”‚     # in case
â”‚             â”‚ â”‚                                                â”‚ https://githu
â”‚             â”‚ â”‚                                                â”‚ for details.
â”‚             â”‚ â”‚                                                â”‚     # If this
â”‚             â”‚ â”‚                                                â”‚ skip the peer
â”‚             â”‚ â”‚                                                â”‚     # and tru
â”‚             â”‚ â”‚                                                â”‚ capability re
â”‚             â”‚ â”‚                                                â”‚     "VLLM_SKI
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ "0") == "1",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # List of
â”‚             â”‚ â”‚                                                â”‚ be disabled,
â”‚             â”‚ â”‚                                                â”‚     # and per
â”‚             â”‚ â”‚                                                â”‚ only affects
â”‚             â”‚ â”‚                                                â”‚     # selecti
â”‚             â”‚ â”‚                                                â”‚     # (kernel
â”‚             â”‚ â”‚                                                â”‚ MarlinLinearK
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DIS
â”‚             â”‚ â”‚                                                â”‚     lambda: [
â”‚             â”‚ â”‚                                                â”‚ in os.environ
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda: b
â”‚             â”‚ â”‚                                                â”‚ "1"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Disable
â”‚             â”‚ â”‚                                                â”‚ enabled.
â”‚             â”‚ â”‚                                                â”‚     # Acts as
â”‚             â”‚ â”‚                                                â”‚ rest of the o
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda: (
â”‚             â”‚ â”‚                                                â”‚ "False").lowe
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚     # By defa
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "False").lowe
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # use ait
â”‚             â”‚ â”‚                                                â”‚ enabled
â”‚             â”‚ â”‚                                                â”‚     # The fol
â”‚             â”‚ â”‚                                                â”‚     # - scale
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚     # By defa
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # use ait
â”‚             â”‚ â”‚                                                â”‚ enabled.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚     # By defa
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚     # By defa
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # use roc
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Pad the
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "1"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Pad the
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "1"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # custom
â”‚             â”‚ â”‚                                                â”‚ cards
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ (os.getenv("V
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Custom
â”‚             â”‚ â”‚                                                â”‚ cards
â”‚             â”‚ â”‚                                                â”‚     # Choice
â”‚             â”‚ â”‚                                                â”‚ INT6, INT4 or
â”‚             â”‚ â”‚                                                â”‚     # Recomme
â”‚             â”‚ â”‚                                                â”‚ allreduce
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ "NONE").upper
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Custom
â”‚             â”‚ â”‚                                                â”‚ cards
â”‚             â”‚ â”‚                                                â”‚     # Due to
â”‚             â”‚ â”‚                                                â”‚ instruction,
â”‚             â”‚ â”‚                                                â”‚     # kernels
â”‚             â”‚ â”‚                                                â”‚     # If envi
â”‚             â”‚ â”‚                                                â”‚ input is conv
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚     (os.geten
â”‚             â”‚ â”‚                                                â”‚ "True").lower
â”‚             â”‚ â”‚                                                â”‚      ("true",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Custom
â”‚             â”‚ â”‚                                                â”‚ cards.
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ data bytes(MB
â”‚             â”‚ â”‚                                                â”‚     # allredu
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚     # Data ex
â”‚             â”‚ â”‚                                                â”‚ custom allred
â”‚             â”‚ â”‚                                                â”‚     # communi
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ROC
â”‚             â”‚ â”‚                                                â”‚     lambda: m
â”‚             â”‚ â”‚                                                â”‚         os.en
â”‚             â”‚ â”‚                                                â”‚ None)),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Divisor
â”‚             â”‚ â”‚                                                â”‚ calculation f
â”‚             â”‚ â”‚                                                â”‚     "Q_SCALE_
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚ "200")),
â”‚             â”‚ â”‚                                                â”‚     # Divisor
â”‚             â”‚ â”‚                                                â”‚ calculation f
â”‚             â”‚ â”‚                                                â”‚     "K_SCALE_
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚ "200")),
â”‚             â”‚ â”‚                                                â”‚     # Divisor
â”‚             â”‚ â”‚                                                â”‚ calculation f
â”‚             â”‚ â”‚                                                â”‚     "V_SCALE_
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚ "100")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ the V1 code p
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ENA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "1"))),
â”‚             â”‚ â”‚                                                â”‚     "VLLM_LOG
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ float(os.gete
â”‚             â”‚ â”‚                                                â”‚ "-1")),
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DIS
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ mode, which w
â”‚             â”‚ â”‚                                                â”‚     # some ad
â”‚             â”‚ â”‚                                                â”‚ and debugging
â”‚             â”‚ â”‚                                                â”‚     # e.g. `/
â”‚             â”‚ â”‚                                                â”‚     "VLLM_SER
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ to handle in
â”‚             â”‚ â”‚                                                â”‚     # single
â”‚             â”‚ â”‚                                                â”‚ per-token out
â”‚             â”‚ â”‚                                                â”‚     # V1 Asyn
â”‚             â”‚ â”‚                                                â”‚ when handling
â”‚             â”‚ â”‚                                                â”‚     # concurr
â”‚             â”‚ â”‚                                                â”‚     # Setting
â”‚             â”‚ â”‚                                                â”‚ higher varian
â”‚             â”‚ â”‚                                                â”‚     # inter-m
â”‚             â”‚ â”‚                                                â”‚ low can negat
â”‚             â”‚ â”‚                                                â”‚     # TTFT an
â”‚             â”‚ â”‚                                                â”‚     "VLLM_V1_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "128")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ attention opt
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MLA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Number
â”‚             â”‚ â”‚                                                â”‚ is set to be
â”‚             â”‚ â”‚                                                â”‚     # it allo
â”‚             â”‚ â”‚                                                â”‚ on a single G
â”‚             â”‚ â”‚                                                â”‚     # so that
â”‚             â”‚ â”‚                                                â”‚ on the same G
â”‚             â”‚ â”‚                                                â”‚     "VLLM_RAY
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ float(os.gete
â”‚             â”‚ â”‚                                                â”‚ "1.0")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Bundle
â”‚             â”‚ â”‚                                                â”‚ can control p
â”‚             â”‚ â”‚                                                â”‚     # which i
â”‚             â”‚ â”‚                                                â”‚ bundle, for e
â”‚             â”‚ â”‚                                                â”‚     # Format:
â”‚             â”‚ â”‚                                                â”‚ e.g. "0,1,2,3
â”‚             â”‚ â”‚                                                â”‚     "VLLM_RAY
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # In some
â”‚             â”‚ â”‚                                                â”‚ not work. So
â”‚             â”‚ â”‚                                                â”‚     # specify
â”‚             â”‚ â”‚                                                â”‚ variable VLLM
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CUD
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Rank of
â”‚             â”‚ â”‚                                                â”‚ setting
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚ "0")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Rank of
â”‚             â”‚ â”‚                                                â”‚ setting.
â”‚             â”‚ â”‚                                                â”‚     # Default
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚         os.ge
â”‚             â”‚ â”‚                                                â”‚ sys.modules[_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # World s
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚     lambda: i
â”‚             â”‚ â”‚                                                â”‚ "1")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # IP addr
â”‚             â”‚ â”‚                                                â”‚ parallel sett
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ "127.0.0.1"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Port of
â”‚             â”‚ â”‚                                                â”‚ parallel sett
â”‚             â”‚ â”‚                                                â”‚     "VLLM_DP_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # In the
â”‚             â”‚ â”‚                                                â”‚ with Data-Par
â”‚             â”‚ â”‚                                                â”‚     # and Bat
â”‚             â”‚ â”‚                                                â”‚ kernels, VLLM
â”‚             â”‚ â”‚                                                â”‚     # dictate
â”‚             â”‚ â”‚                                                â”‚ be dispatched
â”‚             â”‚ â”‚                                                â”‚     # rank. A
â”‚             â”‚ â”‚                                                â”‚ activations i
â”‚             â”‚ â”‚                                                â”‚     # units.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MOE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "256")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Randomi
â”‚             â”‚ â”‚                                                â”‚ using Data Pa
â”‚             â”‚ â”‚                                                â”‚     "VLLM_RAN
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "0") == "1",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚ in CI via Run
â”‚             â”‚ â”‚                                                â”‚     "VLLM_CI_
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ "0") == "1",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Use mod
â”‚             â”‚ â”‚                                                â”‚ name to a loc
â”‚             â”‚ â”‚                                                â”‚     # `model_
â”‚             â”‚ â”‚                                                â”‚ mapping the m
â”‚             â”‚ â”‚                                                â”‚     # repo_id
â”‚             â”‚ â”‚                                                â”‚     # {"meta-
â”‚             â”‚ â”‚                                                â”‚ "/tmp/Llama-3
â”‚             â”‚ â”‚                                                â”‚     # or a sp
â”‚             â”‚ â”‚                                                â”‚     # meta-ll
â”‚             â”‚ â”‚                                                â”‚ /tmp/Llama-3.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MOD
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚ gptq/awq marl
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MAR
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "0") == "1",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚ V0
â”‚             â”‚ â”‚                                                â”‚     # This ca
â”‚             â”‚ â”‚                                                â”‚ it's not safe
â”‚             â”‚ â”‚                                                â”‚     # an envi
â”‚             â”‚ â”‚                                                â”‚ users.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_V0_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "0") == "1",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Whether
â”‚             â”‚ â”‚                                                â”‚ V1
â”‚             â”‚ â”‚                                                â”‚     # This ca
â”‚             â”‚ â”‚                                                â”‚ it's not safe
â”‚             â”‚ â”‚                                                â”‚     # an envi
â”‚             â”‚ â”‚                                                â”‚ users.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_V1_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.environ.ge
â”‚             â”‚ â”‚                                                â”‚ "0") == "1",
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Gap bet
â”‚             â”‚ â”‚                                                â”‚ forward pass.
â”‚             â”‚ â”‚                                                â”‚     # 8, we w
â”‚             â”‚ â”‚                                                â”‚ 32, ...].
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TPU
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.enviro
â”‚             â”‚ â”‚                                                â”‚     if "VLLM_
â”‚             â”‚ â”‚                                                â”‚ os.environ el
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TPU
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ maybe_convert
â”‚             â”‚ â”‚                                                â”‚ None)),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Allow u
â”‚             â”‚ â”‚                                                â”‚ moe ops.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Allow u
â”‚             â”‚ â”‚                                                â”‚ fused moe ops
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Allow u
â”‚             â”‚ â”‚                                                â”‚ for fused moe
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ xgrammar comp
â”‚             â”‚ â”‚                                                â”‚     # of 512
â”‚             â”‚ â”‚                                                â”‚ 1000 JSON sch
â”‚             â”‚ â”‚                                                â”‚     # It can
â”‚             â”‚ â”‚                                                â”‚ needed for so
â”‚             â”‚ â”‚                                                â”‚     "VLLM_XGR
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "512")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ 'zero copy' f
â”‚             â”‚ â”‚                                                â”‚     # seriali
â”‚             â”‚ â”‚                                                â”‚ Tensors below
â”‚             â”‚ â”‚                                                â”‚     # this li
â”‚             â”‚ â”‚                                                â”‚ msgpack buffe
â”‚             â”‚ â”‚                                                â”‚     # tensors
â”‚             â”‚ â”‚                                                â”‚ separate mess
â”‚             â”‚ â”‚                                                â”‚     # While t
â”‚             â”‚ â”‚                                                â”‚ copies the te
â”‚             â”‚ â”‚                                                â”‚     # in all
â”‚             â”‚ â”‚                                                â”‚ tensors above
â”‚             â”‚ â”‚                                                â”‚     # limit w
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MSG
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "256")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set,
â”‚             â”‚ â”‚                                                â”‚ using pickle.
â”‚             â”‚ â”‚                                                â”‚     # This is
â”‚             â”‚ â”‚                                                â”‚ is deemed saf
â”‚             â”‚ â”‚                                                â”‚     # insecur
â”‚             â”‚ â”‚                                                â”‚ reason.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ALL
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # IP addr
â”‚             â”‚ â”‚                                                â”‚ between remot
â”‚             â”‚ â”‚                                                â”‚     "VLLM_NIX
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ "localhost"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Port us
â”‚             â”‚ â”‚                                                â”‚ remote agents
â”‚             â”‚ â”‚                                                â”‚     "VLLM_NIX
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "5557")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # all2all
â”‚             â”‚ â”‚                                                â”‚ parallel comm
â”‚             â”‚ â”‚                                                â”‚     # Availab
â”‚             â”‚ â”‚                                                â”‚     # - "naiv
â”‚             â”‚ â”‚                                                â”‚ using all-red
â”‚             â”‚ â”‚                                                â”‚     # - "pplx
â”‚             â”‚ â”‚                                                â”‚     # - "deep
â”‚             â”‚ â”‚                                                â”‚ high-throughp
â”‚             â”‚ â”‚                                                â”‚     # - "deep
â”‚             â”‚ â”‚                                                â”‚ low-latency k
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ALL
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ "naive"),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ expert suppor
â”‚             â”‚ â”‚                                                â”‚     # NVFP4 M
â”‚             â”‚ â”‚                                                â”‚ used to creat
â”‚             â”‚ â”‚                                                â”‚     # the blo
â”‚             â”‚ â”‚                                                â”‚ NVFP4 Quantiz
â”‚             â”‚ â”‚                                                â”‚     # This is
â”‚             â”‚ â”‚                                                â”‚ running out o
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MAX
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "163840")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Regex t
â”‚             â”‚ â”‚                                                â”‚ parsing plugi
â”‚             â”‚ â”‚                                                â”‚     "VLLM_TOO
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "1")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Reduce
â”‚             â”‚ â”‚                                                â”‚ Enabling this
â”‚             â”‚ â”‚                                                â”‚     # latency
â”‚             â”‚ â”‚                                                â”‚ comes.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_SLE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ the rpc messa
â”‚             â”‚ â”‚                                                â”‚     # Object
â”‚             â”‚ â”‚                                                â”‚ broadcast to
â”‚             â”‚ â”‚                                                â”‚     # process
â”‚             â”‚ â”‚                                                â”‚     "VLLM_MQ_
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "16")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Timeout
â”‚             â”‚ â”‚                                                â”‚ calls in mult
â”‚             â”‚ â”‚                                                â”‚     # executo
â”‚             â”‚ â”‚                                                â”‚     "VLLM_EXE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "300")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # KV Cach
â”‚             â”‚ â”‚                                                â”‚     # Some co
â”‚             â”‚ â”‚                                                â”‚     # - NHD
â”‚             â”‚ â”‚                                                â”‚     # - HND
â”‚             â”‚ â”‚                                                â”‚     # Where N
â”‚             â”‚ â”‚                                                â”‚ D=head_size.
â”‚             â”‚ â”‚                                                â”‚     # leave t
â”‚             â”‚ â”‚                                                â”‚ Mind that bac
â”‚             â”‚ â”‚                                                â”‚     # impleme
â”‚             â”‚ â”‚                                                â”‚ possible layo
â”‚             â”‚ â”‚                                                â”‚     "VLLM_KV_
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚ # Optimizatio
â”‚             â”‚ â”‚                                                â”‚ torch.zeros w
â”‚             â”‚ â”‚                                                â”‚ def optimized
â”‚             â”‚ â”‚                                                â”‚     return to
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # Optimizatio
â”‚             â”‚ â”‚                                                â”‚ operations
â”‚             â”‚ â”‚                                                â”‚ # Example usa
â”‚             â”‚ â”‚                                                â”‚ # tensor = op
â”‚             â”‚ â”‚                                                â”‚ 10))
â”‚             â”‚ â”‚                                                â”‚     # Optimiz
â”‚             â”‚ â”‚                                                â”‚ torch.zeros w
â”‚             â”‚ â”‚                                                â”‚     if hasatt
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ torch.empty(s
â”‚             â”‚ â”‚                                                â”‚ device=self.s
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 309143 Output: 3583
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 11: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '960,2000p'                â”‚         self.
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ torch.empty(s
â”‚             â”‚ â”‚ 'restart': False}                              â”‚ device=self.s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Optimiz
â”‚             â”‚ â”‚                                                â”‚ operations
â”‚             â”‚ â”‚                                                â”‚     if hasatt
â”‚             â”‚ â”‚                                                â”‚ 'another_tens
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Enable
â”‚             â”‚ â”‚                                                â”‚ logits contai
â”‚             â”‚ â”‚                                                â”‚     # indicat
â”‚             â”‚ â”‚                                                â”‚ debugging low
â”‚             â”‚ â”‚                                                â”‚     # or bad
â”‚             â”‚ â”‚                                                â”‚ overhead.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_COM
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ used for NVFP
â”‚             â”‚ â”‚                                                â”‚     # generat
â”‚             â”‚ â”‚                                                â”‚ compressed-te
â”‚             â”‚ â”‚                                                â”‚     # models
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Time (i
â”‚             â”‚ â”‚                                                â”‚ cache on the
â”‚             â”‚ â”‚                                                â”‚     # automat
â”‚             â”‚ â”‚                                                â”‚ notification
â”‚             â”‚ â”‚                                                â”‚     # consume
â”‚             â”‚ â”‚                                                â”‚ using NixlCon
â”‚             â”‚ â”‚                                                â”‚     # disaggr
â”‚             â”‚ â”‚                                                â”‚     "VLLM_NIX
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "120")),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ prefill
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # If set
â”‚             â”‚ â”‚                                                â”‚ Attention bac
â”‚             â”‚ â”‚                                                â”‚     "VLLM_USE
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ None),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Control
â”‚             â”‚ â”‚                                                â”‚ graph capture
â”‚             â”‚ â”‚                                                â”‚     # If set
â”‚             â”‚ â”‚                                                â”‚ freezing to s
â”‚             â”‚ â”‚                                                â”‚     # If set
â”‚             â”‚ â”‚                                                â”‚ capture.
â”‚             â”‚ â”‚                                                â”‚     "VLLM_ENA
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Used to
â”‚             â”‚ â”‚                                                â”‚     "VLLM_LOO
â”‚             â”‚ â”‚                                                â”‚     lambda: o
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Used to
â”‚             â”‚ â”‚                                                â”‚ vLLM processe
â”‚             â”‚ â”‚                                                â”‚     # This is
â”‚             â”‚ â”‚                                                â”‚ monitoring pu
â”‚             â”‚ â”‚                                                â”‚     # The def
â”‚             â”‚ â”‚                                                â”‚     "VLLM_PRO
â”‚             â”‚ â”‚                                                â”‚     lambda:
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚ }
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # --8<--
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def __getattr
â”‚             â”‚ â”‚                                                â”‚     # lazy ev
â”‚             â”‚ â”‚                                                â”‚     if name i
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚     raise Att
â”‚             â”‚ â”‚                                                â”‚ has no attrib
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def __dir__()
â”‚             â”‚ â”‚                                                â”‚     return li
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def is_set(na
â”‚             â”‚ â”‚                                                â”‚     """Check
â”‚             â”‚ â”‚                                                â”‚ explicitly se
â”‚             â”‚ â”‚                                                â”‚     if name i
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚     raise Att
â”‚             â”‚ â”‚                                                â”‚ has no attrib
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def set_vllm_
â”‚             â”‚ â”‚                                                â”‚     if is_set
â”‚             â”‚ â”‚                                                â”‚         raise
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ if VLLM_USE_V
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ raise this as
â”‚             â”‚ â”‚                                                â”‚             "
â”‚             â”‚ â”‚                                                â”‚ VLLM_USE_V1=0
â”‚             â”‚ â”‚                                                â”‚     os.enviro
â”‚             â”‚ â”‚                                                â”‚ else "0"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ def compute_h
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     WARNING:
â”‚             â”‚ â”‚                                                â”‚ this environm
â”‚             â”‚ â”‚                                                â”‚     variables
â”‚             â”‚ â”‚                                                â”‚ the factors l
â”‚             â”‚ â”‚                                                â”‚     it affect
â”‚             â”‚ â”‚                                                â”‚ example, diff
â”‚             â”‚ â”‚                                                â”‚     of VLLM_P
â”‚             â”‚ â”‚                                                â”‚ different com
â”‚             â”‚ â”‚                                                â”‚     graphs, s
â”‚             â”‚ â”‚                                                â”‚ list. The env
â”‚             â”‚ â”‚                                                â”‚     affect th
â”‚             â”‚ â”‚                                                â”‚ attention bac
â”‚             â”‚ â”‚                                                â”‚     also be i
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     factors:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # summari
â”‚             â”‚ â”‚                                                â”‚     def facto
â”‚             â”‚ â”‚                                                â”‚         if __
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # The val
â”‚             â”‚ â”‚                                                â”‚ computation g
â”‚             â”‚ â”‚                                                â”‚     # TODO(De
â”‚             â”‚ â”‚                                                â”‚ variables?
â”‚             â”‚ â”‚                                                â”‚     # for key
â”‚             â”‚ â”‚                                                â”‚     #     fac
â”‚             â”‚ â”‚                                                â”‚     environme
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚         "VLLM
â”‚             â”‚ â”‚                                                â”‚     ]
â”‚             â”‚ â”‚                                                â”‚     for key i
â”‚             â”‚ â”‚                                                â”‚         if ke
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     hash_str
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     return ha
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 366413 Output: 3852
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 12: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'grep -n "torch.zeros\\|fill_\\("  â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ 'restart': False}                              â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 425103 Output: 4570
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 13: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'grep -n "torch.zeros\\|fill_"     â”‚ 601:# Optimiz
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ torch.zeros w
â”‚             â”‚ â”‚ 'restart': False}                              â”‚ 605:# Optimiz
â”‚             â”‚ â”‚                                                â”‚ operations
â”‚             â”‚ â”‚                                                â”‚ 608:    # Opt
â”‚             â”‚ â”‚                                                â”‚ of torch.zero
â”‚             â”‚ â”‚                                                â”‚ 612:    # Opt
â”‚             â”‚ â”‚                                                â”‚ fill_() opera
â”‚             â”‚ â”‚                                                â”‚ 2372:    long
â”‚             â”‚ â”‚                                                â”‚ be prefilled
â”‚             â”‚ â”‚                                                â”‚ 2376:    long
â”‚             â”‚ â”‚                                                â”‚ 2449:    chun
â”‚             â”‚ â”‚                                                â”‚ field(init=Fa
â”‚             â”‚ â”‚                                                â”‚ 2553:
â”‚             â”‚ â”‚                                                â”‚ self.enable_c
â”‚             â”‚ â”‚                                                â”‚ 2555:
â”‚             â”‚ â”‚                                                â”‚ self.long_pre
â”‚             â”‚ â”‚                                                â”‚ 2556:
â”‚             â”‚ â”‚                                                â”‚ self.long_pre
â”‚             â”‚ â”‚                                                â”‚ int(self.max_
â”‚             â”‚ â”‚                                                â”‚ 2562:
â”‚             â”‚ â”‚                                                â”‚ "long_prefill
â”‚             â”‚ â”‚                                                â”‚ 2564:
â”‚             â”‚ â”‚                                                â”‚ self.long_pre
â”‚             â”‚ â”‚                                                â”‚ 2580:
â”‚             â”‚ â”‚                                                â”‚ self.chunked_
â”‚             â”‚ â”‚                                                â”‚ 2619:
â”‚             â”‚ â”‚                                                â”‚ self.chunked_
â”‚             â”‚ â”‚                                                â”‚ 2623:
â”‚             â”‚ â”‚                                                â”‚ self.long_pre
â”‚             â”‚ â”‚                                                â”‚ self.max_mode
â”‚             â”‚ â”‚                                                â”‚ 2625:
â”‚             â”‚ â”‚                                                â”‚ "long_prefill
â”‚             â”‚ â”‚                                                â”‚ 2626:
â”‚             â”‚ â”‚                                                â”‚ f"({self.long
â”‚             â”‚ â”‚                                                â”‚ be greater "
â”‚             â”‚ â”‚                                                â”‚ 4685:
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ and \
â”‚             â”‚ â”‚                                                â”‚ 4732:
â”‚             â”‚ â”‚                                                â”‚ list = []
â”‚             â”‚ â”‚                                                â”‚ 4737:
â”‚             â”‚ â”‚                                                â”‚ disable_chunk
â”‚             â”‚ â”‚                                                â”‚ 4741:
â”‚             â”‚ â”‚                                                â”‚ disable_chunk
â”‚             â”‚ â”‚                                                â”‚ 4742:
â”‚             â”‚ â”‚                                                â”‚ disable_chunk
â”‚             â”‚ â”‚                                                â”‚ 4744:
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ False
â”‚             â”‚ â”‚                                                â”‚ 4745:
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = 0
â”‚             â”‚ â”‚                                                â”‚ 4956:
â”‚             â”‚ â”‚                                                â”‚ f"chunked_pre
â”‚             â”‚ â”‚                                                â”‚ "  # noqa
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 484545 Output: 4645
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 14: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'str_replace', 'file_text': '',    â”‚ The file
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': '            if   â”‚ /home/raven/c
â”‚             â”‚ â”‚ self.model_config is not None and \\\n         â”‚ has been edit
â”‚             â”‚ â”‚ self.model_config.attention_chunk_size is not  â”‚ `cat -n` on a
â”‚             â”‚ â”‚ None:\n                if                      â”‚ /home/raven/c
â”‚             â”‚ â”‚ self.speculative_config is not None and \\\n   â”‚   4781
â”‚             â”‚ â”‚ self.speculative_config.use_eagle():\n         â”‚ self.schedule
â”‚             â”‚ â”‚ # Hybrid KV cache manager is not yet supported â”‚ = True
â”‚             â”‚ â”‚ with chunked\n                    # local      â”‚   4782
â”‚             â”‚ â”‚ attention + eagle.\n                           â”‚ not None:
â”‚             â”‚ â”‚ self.scheduler_config.disable_hybrid_kv_cacheâ€¦ â”‚   4783
â”‚             â”‚ â”‚ = True\n                elif \\\n              â”‚ manager is no
â”‚             â”‚ â”‚ not                                            â”‚   4784
â”‚             â”‚ â”‚ envs.VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRIâ€¦ â”‚ self.schedule
â”‚             â”‚ â”‚ logger.warning(\n                              â”‚ = True
â”‚             â”‚ â”‚ "There is a latency regression when using      â”‚   4785
â”‚             â”‚ â”‚ chunked local"\n                        "      â”‚ None and \
â”‚             â”‚ â”‚ attention with the hybrid KV cache manager.    â”‚   4786
â”‚             â”‚ â”‚ Disabling"\n                        " it, by   â”‚ self.model_co
â”‚             â”‚ â”‚ default. To enable it, set the environment "\n â”‚ None:
â”‚             â”‚ â”‚ "VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KVâ€¦ â”‚   4787
â”‚             â”‚ â”‚ )\n                    # Hybrid KV cache       â”‚ self.speculat
â”‚             â”‚ â”‚ manager is not yet supported with chunked\n    â”‚   4788
â”‚             â”‚ â”‚ # local attention.\n                           â”‚ self.speculat
â”‚             â”‚ â”‚ self.scheduler_config.disable_hybrid_kv_cacheâ€¦ â”‚   4789
â”‚             â”‚ â”‚ = True', 'old_str': '            if            â”‚ manager is no
â”‚             â”‚ â”‚ self.model_config is not None and \\\n         â”‚   4790
â”‚             â”‚ â”‚ self.model_config.attention_chunk_size is not  â”‚ eagle.
â”‚             â”‚ â”‚ None and \\\n                                  â”‚   4791
â”‚             â”‚ â”‚ self.speculative_config is not None and \\\n   â”‚ self.schedule
â”‚             â”‚ â”‚ self.speculative_config.use_eagle():\n         â”‚ = True
â”‚             â”‚ â”‚ # Hybrid KV cache manager is not yet supported â”‚   4792
â”‚             â”‚ â”‚ with chunked\n                # local          â”‚   4793
â”‚             â”‚ â”‚ attention + eagle.\n                           â”‚ envs.VLLM_ALL
â”‚             â”‚ â”‚ self.scheduler_config.disable_hybrid_kv_cacheâ€¦ â”‚   4794
â”‚             â”‚ â”‚ = True', 'path':                               â”‚   4795
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚ latency regre
â”‚             â”‚ â”‚ 'view_range': []}                              â”‚   4796
â”‚             â”‚ â”‚                                                â”‚ with the hybr
â”‚             â”‚ â”‚                                                â”‚   4797
â”‚             â”‚ â”‚                                                â”‚ default. To e
â”‚             â”‚ â”‚                                                â”‚   4798
â”‚             â”‚ â”‚                                                â”‚ "VLLM_ALLOW_C
â”‚             â”‚ â”‚                                                â”‚   4799
â”‚             â”‚ â”‚                                                â”‚   4800
â”‚             â”‚ â”‚                                                â”‚ manager is no
â”‚             â”‚ â”‚                                                â”‚   4801
â”‚             â”‚ â”‚                                                â”‚   4802
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚   4803
â”‚             â”‚ â”‚                                                â”‚   4804      d
â”‚             â”‚ â”‚                                                â”‚ update_sizes_
â”‚             â”‚ â”‚                                                â”‚   4805
â”‚             â”‚ â”‚                                                â”‚ possible_size
â”‚             â”‚ â”‚                                                â”‚   4806
â”‚             â”‚ â”‚                                                â”‚ multiple of t
â”‚             â”‚ â”‚                                                â”‚ Review the ch
â”‚             â”‚ â”‚                                                â”‚ expected. Edi
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 544450 Output: 5238
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 15: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'view', 'file_text': '',           â”‚ Here's the re
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': '', 'old_str':    â”‚ /home/raven/c
â”‚             â”‚ â”‚ '', 'path':                                    â”‚    900      l
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚ os.getenv("VL
â”‚             â”‚ â”‚ 'view_range': [900, 980]}                      â”‚ "localhost"),
â”‚             â”‚ â”‚                                                â”‚    901
â”‚             â”‚ â”‚                                                â”‚    902      #
â”‚             â”‚ â”‚                                                â”‚ between remot
â”‚             â”‚ â”‚                                                â”‚    903      "
â”‚             â”‚ â”‚                                                â”‚    904      l
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "5557")),
â”‚             â”‚ â”‚                                                â”‚    905
â”‚             â”‚ â”‚                                                â”‚    906      #
â”‚             â”‚ â”‚                                                â”‚ parallel comm
â”‚             â”‚ â”‚                                                â”‚    907      #
â”‚             â”‚ â”‚                                                â”‚    908      #
â”‚             â”‚ â”‚                                                â”‚ implementatio
â”‚             â”‚ â”‚                                                â”‚    909      #
â”‚             â”‚ â”‚                                                â”‚    910      #
â”‚             â”‚ â”‚                                                â”‚ deepep high-t
â”‚             â”‚ â”‚                                                â”‚    911      #
â”‚             â”‚ â”‚                                                â”‚ deepep low-la
â”‚             â”‚ â”‚                                                â”‚    912      "
â”‚             â”‚ â”‚                                                â”‚    913      l
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚    914
â”‚             â”‚ â”‚                                                â”‚    915      #
â”‚             â”‚ â”‚                                                â”‚ tokens per ex
â”‚             â”‚ â”‚                                                â”‚    916      #
â”‚             â”‚ â”‚                                                â”‚ value is used
â”‚             â”‚ â”‚                                                â”‚    917      #
â”‚             â”‚ â”‚                                                â”‚ activations N
â”‚             â”‚ â”‚                                                â”‚    918      #
â”‚             â”‚ â”‚                                                â”‚ kernel from r
â”‚             â”‚ â”‚                                                â”‚    919
â”‚             â”‚ â”‚                                                â”‚ "VLLM_MAX_TOK
â”‚             â”‚ â”‚                                                â”‚    920      l
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "163840")),
â”‚             â”‚ â”‚                                                â”‚    921
â”‚             â”‚ â”‚                                                â”‚    922      #
â”‚             â”‚ â”‚                                                â”‚ tool parsing
â”‚             â”‚ â”‚                                                â”‚    923
â”‚             â”‚ â”‚                                                â”‚ "VLLM_TOOL_PA
â”‚             â”‚ â”‚                                                â”‚    924      l
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "1")),
â”‚             â”‚ â”‚                                                â”‚    925
â”‚             â”‚ â”‚                                                â”‚    926      #
â”‚             â”‚ â”‚                                                â”‚ idle. Enablin
â”‚             â”‚ â”‚                                                â”‚    927      #
â”‚             â”‚ â”‚                                                â”‚ eventually co
â”‚             â”‚ â”‚                                                â”‚    928      "
â”‚             â”‚ â”‚                                                â”‚    929      l
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚    930
â”‚             â”‚ â”‚                                                â”‚    931      #
â”‚             â”‚ â”‚                                                â”‚ MB) for the r
â”‚             â”‚ â”‚                                                â”‚    932      #
â”‚             â”‚ â”‚                                                â”‚ will be broad
â”‚             â”‚ â”‚                                                â”‚    933      #
â”‚             â”‚ â”‚                                                â”‚    934      "
â”‚             â”‚ â”‚                                                â”‚    935      l
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "16")),
â”‚             â”‚ â”‚                                                â”‚    936
â”‚             â”‚ â”‚                                                â”‚    937      #
â”‚             â”‚ â”‚                                                â”‚ execute_model
â”‚             â”‚ â”‚                                                â”‚    938      #
â”‚             â”‚ â”‚                                                â”‚ 1).
â”‚             â”‚ â”‚                                                â”‚    939
â”‚             â”‚ â”‚                                                â”‚ "VLLM_EXECUTE
â”‚             â”‚ â”‚                                                â”‚    940      l
â”‚             â”‚ â”‚                                                â”‚ int(os.getenv
â”‚             â”‚ â”‚                                                â”‚ "300")),
â”‚             â”‚ â”‚                                                â”‚    941
â”‚             â”‚ â”‚                                                â”‚    942      #
â”‚             â”‚ â”‚                                                â”‚ vllm.
â”‚             â”‚ â”‚                                                â”‚    943      #
â”‚             â”‚ â”‚                                                â”‚    944      #
â”‚             â”‚ â”‚                                                â”‚    945      #
â”‚             â”‚ â”‚                                                â”‚    946      #
â”‚             â”‚ â”‚                                                â”‚ and D=head_si
â”‚             â”‚ â”‚                                                â”‚    947      #
â”‚             â”‚ â”‚                                                â”‚ backend. Mind
â”‚             â”‚ â”‚                                                â”‚    948      #
â”‚             â”‚ â”‚                                                â”‚ all possible
â”‚             â”‚ â”‚                                                â”‚    949      "
â”‚             â”‚ â”‚                                                â”‚    950      l
â”‚             â”‚ â”‚                                                â”‚ os.getenv("VL
â”‚             â”‚ â”‚                                                â”‚    951  # Opt
â”‚             â”‚ â”‚                                                â”‚ of torch.zero
â”‚             â”‚ â”‚                                                â”‚    952  def o
â”‚             â”‚ â”‚                                                â”‚    953      r
â”‚             â”‚ â”‚                                                â”‚    954
â”‚             â”‚ â”‚                                                â”‚    955  # Opt
â”‚             â”‚ â”‚                                                â”‚ fill_() opera
â”‚             â”‚ â”‚                                                â”‚    956  # Exa
â”‚             â”‚ â”‚                                                â”‚    957  # ten
â”‚             â”‚ â”‚                                                â”‚ optimized_ten
â”‚             â”‚ â”‚                                                â”‚    958      #
â”‚             â”‚ â”‚                                                â”‚ instead of to
â”‚             â”‚ â”‚                                                â”‚    959      i
â”‚             â”‚ â”‚                                                â”‚ 'some_tensor_
â”‚             â”‚ â”‚                                                â”‚    960
â”‚             â”‚ â”‚                                                â”‚ torch.empty(s
â”‚             â”‚ â”‚                                                â”‚ device=self.s
â”‚             â”‚ â”‚                                                â”‚    961
â”‚             â”‚ â”‚                                                â”‚    962      #
â”‚             â”‚ â”‚                                                â”‚ fill_() opera
â”‚             â”‚ â”‚                                                â”‚    963      i
â”‚             â”‚ â”‚                                                â”‚ 'another_tens
â”‚             â”‚ â”‚                                                â”‚    964
â”‚             â”‚ â”‚                                                â”‚    965
â”‚             â”‚ â”‚                                                â”‚    966      #
â”‚             â”‚ â”‚                                                â”‚ generated log
â”‚             â”‚ â”‚                                                â”‚    967      #
â”‚             â”‚ â”‚                                                â”‚ Useful for de
â”‚             â”‚ â”‚                                                â”‚    968      #
â”‚             â”‚ â”‚                                                â”‚ compute overh
â”‚             â”‚ â”‚                                                â”‚    969      "
â”‚             â”‚ â”‚                                                â”‚    970      l
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚    971
â”‚             â”‚ â”‚                                                â”‚    972      #
â”‚             â”‚ â”‚                                                â”‚ emulations ar
â”‚             â”‚ â”‚                                                â”‚    973      #
â”‚             â”‚ â”‚                                                â”‚ compressed-te
â”‚             â”‚ â”‚                                                â”‚    974      #
â”‚             â”‚ â”‚                                                â”‚    975      "
â”‚             â”‚ â”‚                                                â”‚    976      l
â”‚             â”‚ â”‚                                                â”‚ bool(int(os.g
â”‚             â”‚ â”‚                                                â”‚ "0"))),
â”‚             â”‚ â”‚                                                â”‚    977
â”‚             â”‚ â”‚                                                â”‚    978      #
â”‚             â”‚ â”‚                                                â”‚ KV cache on t
â”‚             â”‚ â”‚                                                â”‚    979      #
â”‚             â”‚ â”‚                                                â”‚ notification
â”‚             â”‚ â”‚                                                â”‚    980      #
â”‚             â”‚ â”‚                                                â”‚ when using Ni
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 605526 Output: 5969
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 16: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'str_replace', 'file_text': '',    â”‚ The file
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': '    # If set,    â”‚ /home/raven/c
â”‚             â”‚ â”‚ allow using hybrid KV cache manager together   â”‚ has been edit
â”‚             â”‚ â”‚ with chunked local attention.\n    # Default   â”‚ `cat -n` on a
â”‚             â”‚ â”‚ is disabled due to latency regressions; set to â”‚ /home/raven/c
â”‚             â”‚ â”‚ 1 to enable.\n                                 â”‚    947      #
â”‚             â”‚ â”‚ "VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KVâ€¦ â”‚ backend. Mind
â”‚             â”‚ â”‚ lambda:                                        â”‚    948      #
â”‚             â”‚ â”‚ (os.getenv("VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITâ€¦ â”‚ all possible
â”‚             â”‚ â”‚ "0").strip().lower() in ("1", "true")),',      â”‚    949      "
â”‚             â”‚ â”‚ 'old_str': "# Optimization: Use torch.empty    â”‚    950      l
â”‚             â”‚ â”‚ instead of torch.zeros where applicable\ndef   â”‚ os.getenv("VL
â”‚             â”‚ â”‚ optimized_tensor_allocation(size):\n    return â”‚    951      #
â”‚             â”‚ â”‚ torch.empty(size)\n\n# Optimization: Remove    â”‚ cache manager
â”‚             â”‚ â”‚ unnecessary fill_() operations\n# Example      â”‚ attention.
â”‚             â”‚ â”‚ usage\n# tensor =                              â”‚    952      #
â”‚             â”‚ â”‚ optimized_tensor_allocation((10, 10))\n    #   â”‚ latency regre
â”‚             â”‚ â”‚ Optimization: Use torch.empty instead of       â”‚    953
â”‚             â”‚ â”‚ torch.zeros where applicable\n    if           â”‚ "VLLM_ALLOW_C
â”‚             â”‚ â”‚ hasattr(self, 'some_tensor_attribute'):\n      â”‚    954      l
â”‚             â”‚ â”‚ self.some_tensor_attribute =                   â”‚ (os.getenv("V
â”‚             â”‚ â”‚ torch.empty(self.some_tensor_attribute.size(), â”‚ "0").strip().
â”‚             â”‚ â”‚ device=self.some_tensor_attribute.device)\n\n  â”‚    955
â”‚             â”‚ â”‚ # Optimization: Remove unnecessary fill_()     â”‚    956      #
â”‚             â”‚ â”‚ operations\n    if hasattr(self,               â”‚ generated log
â”‚             â”‚ â”‚ 'another_tensor_attribute'):\n", 'path':       â”‚    957      #
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚ Useful for de
â”‚             â”‚ â”‚ 'view_range': []}                              â”‚    958      #
â”‚             â”‚ â”‚                                                â”‚ compute overh
â”‚             â”‚ â”‚                                                â”‚ Review the ch
â”‚             â”‚ â”‚                                                â”‚ expected. Edi
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 668604 Output: 6679
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 17: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '580,640p'                 â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ to FLASHINFER
â”‚             â”‚ â”‚ 'restart': False}                              â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ "  # noqa: E5
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ install it.")
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚ not None
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             w
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ set but not u
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ current platf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if is
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ ConfigFormat(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # Optimizatio
â”‚             â”‚ â”‚                                                â”‚ torch.zeros w
â”‚             â”‚ â”‚                                                â”‚ def optimized
â”‚             â”‚ â”‚                                                â”‚     return to
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ # Optimizatio
â”‚             â”‚ â”‚                                                â”‚ operations
â”‚             â”‚ â”‚                                                â”‚ # Example usa
â”‚             â”‚ â”‚                                                â”‚ # tensor = op
â”‚             â”‚ â”‚                                                â”‚ 10))
â”‚             â”‚ â”‚                                                â”‚     # Optimiz
â”‚             â”‚ â”‚                                                â”‚ torch.zeros w
â”‚             â”‚ â”‚                                                â”‚     if hasatt
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ torch.empty(s
â”‚             â”‚ â”‚                                                â”‚ device=self.s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # Optimiz
â”‚             â”‚ â”‚                                                â”‚ operations
â”‚             â”‚ â”‚                                                â”‚     if hasatt
â”‚             â”‚ â”‚                                                â”‚ 'another_tens
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         hf_co
â”‚             â”‚ â”‚                                                â”‚ get_config(se
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ get_hf_text_c
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ getattr(self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ None)
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ self._get_enc
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ get_hf_image_
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ revision=self
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚         regis
â”‚             â”‚ â”‚                                                â”‚         is_ge
â”‚             â”‚ â”‚                                                â”‚ registry.is_t
â”‚             â”‚ â”‚                                                â”‚             a
â”‚             â”‚ â”‚                                                â”‚         is_po
â”‚             â”‚ â”‚                                                â”‚ registry.is_p
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         def _
â”‚             â”‚ â”‚                                                â”‚ -> ConvertTyp
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ "embed":
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 732764 Output: 6818
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 18: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'str_replace', 'file_text': '',    â”‚ The file
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': '', 'old_str': "# â”‚ /home/raven/c
â”‚             â”‚ â”‚ Optimization: Use torch.empty instead of       â”‚ has been edit
â”‚             â”‚ â”‚ torch.zeros where applicable\ndef              â”‚ `cat -n` on a
â”‚             â”‚ â”‚ optimized_tensor_allocation(size):\n    return â”‚ /home/raven/c
â”‚             â”‚ â”‚ torch.empty(size)\n\n# Optimization: Remove    â”‚    597
â”‚             â”‚ â”‚ unnecessary fill_() operations\n# Example      â”‚    598
â”‚             â”‚ â”‚ usage\n# tensor =                              â”‚ isinstance(se
â”‚             â”‚ â”‚ optimized_tensor_allocation((10, 10))\n    #   â”‚    599
â”‚             â”‚ â”‚ Optimization: Use torch.empty instead of       â”‚ ConfigFormat(
â”‚             â”‚ â”‚ torch.zeros where applicable\n    if           â”‚    600
â”‚             â”‚ â”‚ hasattr(self, 'some_tensor_attribute'):\n      â”‚    601
â”‚             â”‚ â”‚ self.some_tensor_attribute =                   â”‚ get_config(se
â”‚             â”‚ â”‚ torch.empty(self.some_tensor_attribute.size(), â”‚    602
â”‚             â”‚ â”‚ device=self.some_tensor_attribute.device)\n\n  â”‚ self.trust_re
â”‚             â”‚ â”‚ # Optimization: Remove unnecessary fill_()     â”‚    603
â”‚             â”‚ â”‚ operations\n    if hasattr(self,               â”‚ self.revision
â”‚             â”‚ â”‚ 'another_tensor_attribute'):\n\n", 'path':     â”‚    604
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚ self.code_rev
â”‚             â”‚ â”‚ 'view_range': []}                              â”‚    605
â”‚             â”‚ â”‚                                                â”‚ self.config_f
â”‚             â”‚ â”‚                                                â”‚ Review the ch
â”‚             â”‚ â”‚                                                â”‚ expected. Edi
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 797657 Output: 7679
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 19: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'grep -n "class VllmConfig" -n     â”‚ 4434:class Vl
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ || true', 'restart': False}                    â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 863651 Output: 7887
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 20: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '4400,4840p'               â”‚         self.
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ self.cudagrap
â”‚             â”‚ â”‚ 'restart': False}                              â”‚             0
â”‚             â”‚ â”‚                                                â”‚ else 0
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # pre
â”‚             â”‚ â”‚                                                â”‚ size to padde
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚             0
â”‚             â”‚ â”‚                                                â”‚ range(self.ma
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚         for e
â”‚             â”‚ â”‚                                                â”‚ zip(self.cuda
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ + [0]):
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = start
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = end
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ self.max_capt
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def set_s
â”‚             â”‚ â”‚                                                â”‚         # NOT
â”‚             â”‚ â”‚                                                â”‚ called
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.full_cud
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚ cannot be use
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Full CUDA gra
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ splitting_ops
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ self.full_cud
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             ]
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ @config
â”‚             â”‚ â”‚                                                â”‚ @dataclass(co
â”‚             â”‚ â”‚                                                â”‚ class VllmCon
â”‚             â”‚ â”‚                                                â”‚     """Datacl
â”‚             â”‚ â”‚                                                â”‚ vllm-related
â”‚             â”‚ â”‚                                                â”‚     simplifie
â”‚             â”‚ â”‚                                                â”‚ configuration
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     # TODO: u
â”‚             â”‚ â”‚                                                â”‚ constructing
â”‚             â”‚ â”‚                                                â”‚     # try to
â”‚             â”‚ â”‚                                                â”‚     model_con
â”‚             â”‚ â”‚                                                â”‚ ignore
â”‚             â”‚ â”‚                                                â”‚     """Model
â”‚             â”‚ â”‚                                                â”‚     cache_con
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Cache
â”‚             â”‚ â”‚                                                â”‚     parallel_
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Parall
â”‚             â”‚ â”‚                                                â”‚     scheduler
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Schedu
â”‚             â”‚ â”‚                                                â”‚     device_co
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Device
â”‚             â”‚ â”‚                                                â”‚     load_conf
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Load c
â”‚             â”‚ â”‚                                                â”‚     lora_conf
â”‚             â”‚ â”‚                                                â”‚     """LoRA c
â”‚             â”‚ â”‚                                                â”‚     speculati
â”‚             â”‚ â”‚                                                â”‚ Optional[Spec
â”‚             â”‚ â”‚                                                â”‚     """Specul
â”‚             â”‚ â”‚                                                â”‚     decoding_
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Decodi
â”‚             â”‚ â”‚                                                â”‚     observabi
â”‚             â”‚ â”‚                                                â”‚ Optional[Obse
â”‚             â”‚ â”‚                                                â”‚     """Observ
â”‚             â”‚ â”‚                                                â”‚     quant_con
â”‚             â”‚ â”‚                                                â”‚ = None
â”‚             â”‚ â”‚                                                â”‚     """Quanti
â”‚             â”‚ â”‚                                                â”‚     compilati
â”‚             â”‚ â”‚                                                â”‚ field(
â”‚             â”‚ â”‚                                                â”‚         defau
â”‚             â”‚ â”‚                                                â”‚     """`torch
â”‚             â”‚ â”‚                                                â”‚ configuration
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     As a shor
â”‚             â”‚ â”‚                                                â”‚ directly spec
â”‚             â”‚ â”‚                                                â”‚     level `n`
â”‚             â”‚ â”‚                                                â”‚ `-O.level=3`
â”‚             â”‚ â”‚                                                â”‚     Currently
â”‚             â”‚ â”‚                                                â”‚ as well but t
â”‚             â”‚ â”‚                                                â”‚     removed i
â”‚             â”‚ â”‚                                                â”‚ the future.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     NOTE: lev
â”‚             â”‚ â”‚                                                â”‚ any optimizat
â”‚             â”‚ â”‚                                                â”‚     are for i
â”‚             â”‚ â”‚                                                â”‚ the recommend
â”‚             â”‚ â”‚                                                â”‚     productio
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     You can s
â”‚             â”‚ â”‚                                                â”‚ like so:
â”‚             â”‚ â”‚                                                â”‚     `{"level"
â”‚             â”‚ â”‚                                                â”‚ [1, 2, 4, 8]}
â”‚             â”‚ â”‚                                                â”‚     """
â”‚             â”‚ â”‚                                                â”‚     kv_transf
â”‚             â”‚ â”‚                                                â”‚ Optional[KVTr
â”‚             â”‚ â”‚                                                â”‚     """The co
â”‚             â”‚ â”‚                                                â”‚ cache transfe
â”‚             â”‚ â”‚                                                â”‚     kv_events
â”‚             â”‚ â”‚                                                â”‚ = None
â”‚             â”‚ â”‚                                                â”‚     """The co
â”‚             â”‚ â”‚                                                â”‚ publishing.""
â”‚             â”‚ â”‚                                                â”‚     # some op
â”‚             â”‚ â”‚                                                â”‚ additional in
â”‚             â”‚ â”‚                                                â”‚     # for the
â”‚             â”‚ â”‚                                                â”‚ testing, debu
â”‚             â”‚ â”‚                                                â”‚     # tree co
â”‚             â”‚ â”‚                                                â”‚     additiona
â”‚             â”‚ â”‚                                                â”‚ field(default
â”‚             â”‚ â”‚                                                â”‚     """Additi
â”‚             â”‚ â”‚                                                â”‚ platform. Dif
â”‚             â”‚ â”‚                                                â”‚     support d
â”‚             â”‚ â”‚                                                â”‚ configs are v
â”‚             â”‚ â”‚                                                â”‚     you are u
â”‚             â”‚ â”‚                                                â”‚ hashable."""
â”‚             â”‚ â”‚                                                â”‚     instance_
â”‚             â”‚ â”‚                                                â”‚     """The ID
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def compu
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         WARNI
â”‚             â”‚ â”‚                                                â”‚ to this confi
â”‚             â”‚ â”‚                                                â”‚         ensur
â”‚             â”‚ â”‚                                                â”‚ factors list
â”‚             â”‚ â”‚                                                â”‚         it af
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Provi
â”‚             â”‚ â”‚                                                â”‚ all the confi
â”‚             â”‚ â”‚                                                â”‚         that
â”‚             â”‚ â”‚                                                â”‚ computation
â”‚             â”‚ â”‚                                                â”‚         graph
â”‚             â”‚ â”‚                                                â”‚ final hidden
â”‚             â”‚ â”‚                                                â”‚         exclu
â”‚             â”‚ â”‚                                                â”‚ ids/embedding
â”‚             â”‚ â”‚                                                â”‚         the f
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # sum
â”‚             â”‚ â”‚                                                â”‚         vllm_
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚         vllm_
â”‚             â”‚ â”‚                                                â”‚         vllm_
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ on max_num_ba
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ captured in t
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚ model_config.
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.addition
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ sort_keys=Tru
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ additional_co
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         else:
â”‚             â”‚ â”‚                                                â”‚             v
â”‚             â”‚ â”‚                                                â”‚         facto
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         hash_
â”‚             â”‚ â”‚                                                â”‚ hashlib.md5(s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def pad_f
â”‚             â”‚ â”‚                                                â”‚ int) -> int:
â”‚             â”‚ â”‚                                                â”‚         # if
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚         # it
â”‚             â”‚ â”‚                                                â”‚         # the
â”‚             â”‚ â”‚                                                â”‚ batch_size is
â”‚             â”‚ â”‚                                                â”‚         # i.e
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def _get_
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ Optional[Quan
â”‚             â”‚ â”‚                                                â”‚         """Ge
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚         if mo
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ vllm.model_ex
â”‚             â”‚ â”‚                                                â”‚ import (
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             q
â”‚             â”‚ â”‚                                                â”‚ get_quant_con
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ capability_tu
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ quant_config.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ method {model
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ the current G
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {quant_config
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {capability}.
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ quant_config.
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ supported_dty
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not supported
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ {model_config
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     @staticme
â”‚             â”‚ â”‚                                                â”‚     def get_q
â”‚             â”‚ â”‚                                                â”‚             m
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ Optional[Quan
â”‚             â”‚ â”‚                                                â”‚         impor
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # For
â”‚             â”‚ â”‚                                                â”‚ this modifies
â”‚             â”‚ â”‚                                                â”‚         # obj
â”‚             â”‚ â”‚                                                â”‚ this problem.
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ VllmConfig._g
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def with_
â”‚             â”‚ â”‚                                                â”‚         self,
â”‚             â”‚ â”‚                                                â”‚         hf_co
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚     ) -> "Vll
â”‚             â”‚ â”‚                                                â”‚         if ar
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ copy.deepcopy
â”‚             â”‚ â”‚                                                â”‚             h
â”‚             â”‚ â”‚                                                â”‚ architectures
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         model
â”‚             â”‚ â”‚                                                â”‚ copy.deepcopy
â”‚             â”‚ â”‚                                                â”‚         model
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚ model_config=
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __pos
â”‚             â”‚ â”‚                                                â”‚         """Ve
â”‚             â”‚ â”‚                                                â”‚ consistent wi
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ VllmConfig._g
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.load_con
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ current_platf
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ and \
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ torch.float32
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚ == (7, 5):
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not support f
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ vLLM will set
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ triton kernel
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # asy
â”‚             â”‚ â”‚                                                â”‚ parallelism
â”‚             â”‚ â”‚                                                â”‚         # and
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚         if en
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ CUDA graphs.
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ will be used.
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = 1
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ CompilationLe
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ and \
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ CompilationLe
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ with `torch.c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ CompilationLe
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if ((
â”‚             â”‚ â”‚                                                â”‚ self.lora_con
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ CompilationLe
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ with `torch.c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ CompilationLe
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if
â”‚             â”‚ â”‚                                                â”‚ self.compilat
â”‚             â”‚ â”‚                                                â”‚             n
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ supported wit
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ Disabling cas
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         disab
â”‚             â”‚ â”‚                                                â”‚ []
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             p
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ pooling_type.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ supports chun
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ caching; disa
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if di
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ disable_chunk
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = False
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = 0
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ = max(
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = False
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.kv_event
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.cache_co
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ prefix cachin
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enable.")
â”‚             â”‚ â”‚                                                â”‚         if (s
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.kv_event
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.kv_event
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚ disabled,"
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is configured
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ KVEventsConfi
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enable.")
â”‚             â”‚ â”‚                                                â”‚         curre
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚ random_uuid()
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if (e
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ self.schedule
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ message for h
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ hybrid or not
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ it later.
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ or current_pl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not supported
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not compatibl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not compatibl
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ and \
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is not None:
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ not None and
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is not yet su
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ envs.VLLM_ALL
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ regression wh
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ hybrid KV cac
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enable it, se
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ is not yet su
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ = True
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def
â”‚             â”‚ â”‚                                                â”‚ update_sizes_
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ list) -> list
â”‚             â”‚ â”‚                                                â”‚         # rem
â”‚             â”‚ â”‚                                                â”‚ tp_size when
â”‚             â”‚ â”‚                                                â”‚         # ena
â”‚             â”‚ â”‚                                                â”‚         remov
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.parallel
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚         if re
â”‚             â”‚ â”‚                                                â”‚             l
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ because they
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚ enabled", rem
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚             s
â”‚             â”‚ â”‚                                                â”‚             i
â”‚             â”‚ â”‚                                                â”‚ self.parallel
â”‚             â”‚ â”‚                                                â”‚         ]
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def _set_
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚         cudag
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         `[1,
â”‚             â”‚ â”‚                                                â”‚ 1025)]` is a
â”‚             â”‚ â”‚                                                â”‚         batch
â”‚             â”‚ â”‚                                                â”‚ capture.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Depen
â”‚             â”‚ â”‚                                                â”‚ of `max_num_s
â”‚             â”‚ â”‚                                                â”‚         candi
â”‚             â”‚ â”‚                                                â”‚ cudagraph wil
â”‚             â”‚ â”‚                                                â”‚         which
â”‚             â”‚ â”‚                                                â”‚ max_num_seqs]
â”‚             â”‚ â”‚                                                â”‚         `max_
â”‚             â”‚ â”‚                                                â”‚ cudagraph bat
â”‚             â”‚ â”‚                                                â”‚         `[1,
â”‚             â”‚ â”‚                                                â”‚ 256]`.
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Howev
â”‚             â”‚ â”‚                                                â”‚ capture sizes
â”‚             â”‚ â”‚                                                â”‚         compi
â”‚             â”‚ â”‚                                                â”‚ specified siz
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         In th
â”‚             â”‚ â”‚                                                â”‚ `vllm_config.
â”‚             â”‚ â”‚                                                â”‚         will
â”‚             â”‚ â”‚                                                â”‚ cudagraph (in
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         Durin
â”‚             â”‚ â”‚                                                â”‚ than
â”‚             â”‚ â”‚                                                â”‚         `vllm
â”‚             â”‚ â”‚                                                â”‚         no cu
â”‚             â”‚ â”‚                                                â”‚         If th
â”‚             â”‚ â”‚                                                â”‚         `vllm
â”‚             â”‚ â”‚                                                â”‚         we ca
â”‚             â”‚ â”‚                                                â”‚ size for a gi
â”‚             â”‚ â”‚                                                â”‚         looki
â”‚             â”‚ â”‚                                                â”‚ `vllm_config.
â”‚             â”‚ â”‚                                                â”‚         """
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         # cal
â”‚             â”‚ â”‚                                                â”‚ `batch_size_c
â”‚             â”‚ â”‚                                                â”‚         if no
â”‚             â”‚ â”‚                                                â”‚             b
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 929906 Output: 7962
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 21: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'grep -n "def                      â”‚ 4901:    def
â”‚             â”‚ â”‚ try_verify_and_update_config" -n               â”‚ try_verify_an
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ || true', 'restart': False}                    â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1000440 Output: 8491
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 22: Completed
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "sed -n '4888,4930p'               â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ 'restart': False}                              â”‚
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚             b
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def recal
â”‚             â”‚ â”‚                                                â”‚ max_model_len
â”‚             â”‚ â”‚                                                â”‚         # Can
â”‚             â”‚ â”‚                                                â”‚ try_verify_an
â”‚             â”‚ â”‚                                                â”‚         model
â”‚             â”‚ â”‚                                                â”‚         max_m
â”‚             â”‚ â”‚                                                â”‚ model_config.
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ max_model_len
â”‚             â”‚ â”‚                                                â”‚         self.
â”‚             â”‚ â”‚                                                â”‚ max_model_len
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def try_v
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         archi
â”‚             â”‚ â”‚                                                â”‚ self.model_co
â”‚             â”‚ â”‚                                                â”‚         if ar
â”‚             â”‚ â”‚                                                â”‚             r
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         from
â”‚             â”‚ â”‚                                                â”‚ import (
â”‚             â”‚ â”‚                                                â”‚             M
â”‚             â”‚ â”‚                                                â”‚ HybridAttenti
â”‚             â”‚ â”‚                                                â”‚         cls =
â”‚             â”‚ â”‚                                                â”‚ MODELS_CONFIG
â”‚             â”‚ â”‚                                                â”‚         if cl
â”‚             â”‚ â”‚                                                â”‚             c
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚             H
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚         if se
â”‚             â”‚ â”‚                                                â”‚ "classify":
â”‚             â”‚ â”‚                                                â”‚             #
â”‚             â”‚ â”‚                                                â”‚ ForSequenceCl
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ vllm.model_ex
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚             S
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â”‚                                                â”‚     def __str
â”‚             â”‚ â”‚                                                â”‚         retur
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â”‚                                                â”‚             f
â”‚             â”‚ â”‚                                                â”‚ "
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1071533 Output: 8566
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 23: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'create', 'file_text': 'import     â”‚
â”‚             â”‚ â”‚ time\nimport importlib\n\nstart =              â”‚
â”‚             â”‚ â”‚ time.perf_counter()\nimport vllm.envs as envs  â”‚
â”‚             â”‚ â”‚ # noqa: F401\nimport vllm.config as            â”‚
â”‚             â”‚ â”‚ cfg\nimp_time = time.perf_counter() -          â”‚
â”‚             â”‚ â”‚ start\n\n# Time lightweight VllmConfig         â”‚
â”‚             â”‚ â”‚ initialization that avoids network/model       â”‚
â”‚             â”‚ â”‚ loads\nstart = time.perf_counter()\nfor _ in   â”‚
â”‚             â”‚ â”‚ range(50):\n    _ = cfg.VllmConfig()  #        â”‚
â”‚             â”‚ â”‚ model_config=None ->                           â”‚
â”‚             â”‚ â”‚ safe/lightweight\ninit_time =                  â”‚
â”‚             â”‚ â”‚ time.perf_counter() - start\n\n# Re-import     â”‚
â”‚             â”‚ â”‚ timing to exercise env var lookups\nstart =    â”‚
â”‚             â”‚ â”‚ time.perf_counter()\nfor _ in range(20):\n     â”‚
â”‚             â”‚ â”‚ importlib.reload(cfg)\nreload_time =           â”‚
â”‚             â”‚ â”‚ time.perf_counter() - start\n\nprint({\n       â”‚
â”‚             â”‚ â”‚ "import_vllm_modules_s": round(imp_time, 6),\n â”‚
â”‚             â”‚ â”‚ "init_vllmconfig_50x_s": round(init_time,      â”‚
â”‚             â”‚ â”‚ 6),\n    "reload_config_20x_s":                â”‚
â”‚             â”‚ â”‚ round(reload_time, 6),\n})\n', 'insert_line':  â”‚
â”‚             â”‚ â”‚ 0, 'new_str': '', 'old_str': '', 'path':       â”‚
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚
â”‚             â”‚ â”‚ 'view_range': []}                              â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1143064 Output: 9267
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 24: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'view', 'file_text': '',           â”‚
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': '', 'old_str':    â”‚
â”‚             â”‚ â”‚ '', 'path':                                    â”‚
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚
â”‚             â”‚ â”‚ 'view_range': [1, 200]}                        â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1215410 Output: 9359
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 25: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'view', 'file_text': '',           â”‚ Here's the re
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': '', 'old_str':    â”‚ /home/raven/c
â”‚             â”‚ â”‚ '', 'path':                                    â”‚      1  impor
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚      2  impor
â”‚             â”‚ â”‚ 'view_range': [1, 14]}                         â”‚      3
â”‚             â”‚ â”‚                                                â”‚      4  # Exa
â”‚             â”‚ â”‚                                                â”‚ optimized fun
â”‚             â”‚ â”‚                                                â”‚      5  def t
â”‚             â”‚ â”‚                                                â”‚      6      s
â”‚             â”‚ â”‚                                                â”‚      7      t
â”‚             â”‚ â”‚                                                â”‚ # Replace tor
â”‚             â”‚ â”‚                                                â”‚      8      #
â”‚             â”‚ â”‚                                                â”‚      9      e
â”‚             â”‚ â”‚                                                â”‚ start_time
â”‚             â”‚ â”‚                                                â”‚     10      p
â”‚             â”‚ â”‚                                                â”‚ took {elapsed
â”‚             â”‚ â”‚                                                â”‚     11
â”‚             â”‚ â”‚                                                â”‚     12  if __
â”‚             â”‚ â”‚                                                â”‚     13      t
â”‚             â”‚ â”‚                                                â”‚     14
â”‚             â”‚ â”‚                                                â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1287909 Output: 9449
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 26: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'str_replace', 'file_text': '',    â”‚ The file
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': 'import           â”‚ /home/raven/c
â”‚             â”‚ â”‚ time\nimport importlib\n\nstart =              â”‚ has been edit
â”‚             â”‚ â”‚ time.perf_counter()\nimport vllm.envs as envs  â”‚ `cat -n` on a
â”‚             â”‚ â”‚ # noqa: F401\nimport vllm.config as            â”‚ /home/raven/c
â”‚             â”‚ â”‚ cfg\nimp_time = time.perf_counter() -          â”‚      1  impor
â”‚             â”‚ â”‚ start\n\n# Time lightweight VllmConfig         â”‚      2  impor
â”‚             â”‚ â”‚ initialization that avoids network/model       â”‚      3
â”‚             â”‚ â”‚ loads\nstart = time.perf_counter()\nfor _ in   â”‚      4  start
â”‚             â”‚ â”‚ range(50):\n    _ = cfg.VllmConfig()  #        â”‚      5  impor
â”‚             â”‚ â”‚ model_config=None ->                           â”‚      6  impor
â”‚             â”‚ â”‚ safe/lightweight\ninit_time =                  â”‚      7  imp_t
â”‚             â”‚ â”‚ time.perf_counter() - start\n\n# Re-import     â”‚      8
â”‚             â”‚ â”‚ timing to exercise env var lookups\nstart =    â”‚      9  # Tim
â”‚             â”‚ â”‚ time.perf_counter()\nfor _ in range(20):\n     â”‚ initializatio
â”‚             â”‚ â”‚ importlib.reload(cfg)\nreload_time =           â”‚     10  start
â”‚             â”‚ â”‚ time.perf_counter() - start\n\nprint({\n       â”‚     11  for _
â”‚             â”‚ â”‚ "import_vllm_modules_s": round(imp_time, 6),\n â”‚     12      _
â”‚             â”‚ â”‚ "init_vllmconfig_50x_s": round(init_time,      â”‚ model_config=
â”‚             â”‚ â”‚ 6),\n    "reload_config_20x_s":                â”‚     13  init_
â”‚             â”‚ â”‚ round(reload_time, 6),\n})\n', 'old_str':      â”‚     14
â”‚             â”‚ â”‚ 'import torch\nimport time\n\n# Example tensor â”‚     15  # Re-
â”‚             â”‚ â”‚ allocation using optimized function\ndef       â”‚ lookups
â”‚             â”‚ â”‚ test_optimized_tensor_allocation():\n          â”‚     16  start
â”‚             â”‚ â”‚ start_time = time.time()\n    tensor =         â”‚     17  for _
â”‚             â”‚ â”‚ torch.empty((1000, 1000))  # Replace           â”‚     18      i
â”‚             â”‚ â”‚ torch.zeros with torch.empty\n    # Perform    â”‚     19  reloa
â”‚             â”‚ â”‚ operations on tensor\n    elapsed_time =       â”‚ start
â”‚             â”‚ â”‚ time.time() - start_time\n                     â”‚     20
â”‚             â”‚ â”‚ print(f"Optimized tensor allocation took       â”‚     21  print
â”‚             â”‚ â”‚ {elapsed_time:.6f} seconds")\n\nif __name__ == â”‚     22      "
â”‚             â”‚ â”‚ "__main__":\n                                  â”‚ round(imp_tim
â”‚             â”‚ â”‚ test_optimized_tensor_allocation()\n', 'path': â”‚     23      "
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚ round(init_ti
â”‚             â”‚ â”‚ 'view_range': []}                              â”‚     24      "
â”‚             â”‚ â”‚                                                â”‚ round(reload_
â”‚             â”‚ â”‚                                                â”‚     25  })
â”‚             â”‚ â”‚                                                â”‚     26
â”‚             â”‚ â”‚                                                â”‚ Review the ch
â”‚             â”‚ â”‚                                                â”‚ expected. Edi
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1360717 Output: 10139
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 27: Completed
â”‚ LLM         â”‚ ðŸ’¬ Running the timing script from the repository root to establi
â”‚ Response    â”‚ - Command executes Python on .bench_scratch/test_opt.py to measu
â”‚             â”‚ config init timings. This only reads files and prints timing; no
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'python                            â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ 'restart': False}                              â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1434651 Output: 10265
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 28: Completed
â”‚ Tools       â”‚ ðŸ”§ str_replace_based_edit_tool
â”‚ str_replacâ€¦ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'str_replace', 'file_text': '',    â”‚ The file
â”‚             â”‚ â”‚ 'insert_line': 0, 'new_str': 'import           â”‚ /home/raven/c
â”‚             â”‚ â”‚ time\nimport importlib\n\nstart =              â”‚ has been edit
â”‚             â”‚ â”‚ time.perf_counter()\nimport vllm.envs as       â”‚ `cat -n` on a
â”‚             â”‚ â”‚ envs\nimp_time = time.perf_counter() -         â”‚ /home/raven/c
â”‚             â”‚ â”‚ start\n\n# Exercise environment variable       â”‚      1  impor
â”‚             â”‚ â”‚ lookups repeatedly\nstart =                    â”‚      2  impor
â”‚             â”‚ â”‚ time.perf_counter()\nfor _ in range(10000):\n  â”‚      3
â”‚             â”‚ â”‚ _ = envs.VLLM_USE_V1\n    _ =                  â”‚      4  start
â”‚             â”‚ â”‚ envs.VLLM_ALLOW_LONG_MAX_MODEL_LEN\n    _ =    â”‚      5  impor
â”‚             â”‚ â”‚ envs.VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRIâ€¦ â”‚      6  imp_t
â”‚             â”‚ â”‚ = time.perf_counter() - start\n\n# Reload envs â”‚      7
â”‚             â”‚ â”‚ to simulate module reuse\nstart =              â”‚      8  # Exe
â”‚             â”‚ â”‚ time.perf_counter()\nfor _ in range(5):\n      â”‚ repeatedly
â”‚             â”‚ â”‚ importlib.reload(envs)\nreload_time =          â”‚      9  start
â”‚             â”‚ â”‚ time.perf_counter() - start\n\nprint({\n       â”‚     10  for _
â”‚             â”‚ â”‚ "import_envs_s": round(imp_time, 6),\n         â”‚     11      _
â”‚             â”‚ â”‚ "env_lookup_10k_s": round(lookup_time, 6),\n   â”‚     12      _
â”‚             â”‚ â”‚ "reload_envs_5x_s": round(reload_time,         â”‚ envs.VLLM_ALL
â”‚             â”‚ â”‚ 6),\n})\n', 'old_str': 'import time\nimport    â”‚     13      _
â”‚             â”‚ â”‚ importlib\n\nstart =                           â”‚ envs.VLLM_ALL
â”‚             â”‚ â”‚ time.perf_counter()\nimport vllm.envs as envs  â”‚     14  looku
â”‚             â”‚ â”‚ # noqa: F401\nimport vllm.config as            â”‚ start
â”‚             â”‚ â”‚ cfg\nimp_time = time.perf_counter() -          â”‚     15
â”‚             â”‚ â”‚ start\n\n# Time lightweight VllmConfig         â”‚     16  # Rel
â”‚             â”‚ â”‚ initialization that avoids network/model       â”‚     17  start
â”‚             â”‚ â”‚ loads\nstart = time.perf_counter()\nfor _ in   â”‚     18  for _
â”‚             â”‚ â”‚ range(50):\n    _ = cfg.VllmConfig()  #        â”‚     19      i
â”‚             â”‚ â”‚ model_config=None ->                           â”‚     20  reloa
â”‚             â”‚ â”‚ safe/lightweight\ninit_time =                  â”‚ start
â”‚             â”‚ â”‚ time.perf_counter() - start\n\n# Re-import     â”‚     21
â”‚             â”‚ â”‚ timing to exercise env var lookups\nstart =    â”‚     22  print
â”‚             â”‚ â”‚ time.perf_counter()\nfor _ in range(20):\n     â”‚     23      "
â”‚             â”‚ â”‚ importlib.reload(cfg)\nreload_time =           â”‚ 6),
â”‚             â”‚ â”‚ time.perf_counter() - start\n\nprint({\n       â”‚     24      "
â”‚             â”‚ â”‚ "import_vllm_modules_s": round(imp_time, 6),\n â”‚ round(lookup_
â”‚             â”‚ â”‚ "init_vllmconfig_50x_s": round(init_time,      â”‚     25      "
â”‚             â”‚ â”‚ 6),\n    "reload_config_20x_s":                â”‚ round(reload_
â”‚             â”‚ â”‚ round(reload_time, 6),\n})\n', 'path':         â”‚     26  })
â”‚             â”‚ â”‚ '/home/raven/coding-mess/kernel-corp/OmniPerfâ€¦ â”‚     27
â”‚             â”‚ â”‚ 'view_range': []}                              â”‚ Review the ch
â”‚             â”‚ â”‚                                                â”‚ expected. Edi
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1509131 Output: 11011
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 29: Completed
â”‚ LLM         â”‚ ðŸ’¬ Executing the updated timing script to gather performance num
â”‚ Response    â”‚ operation).
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'python                            â”‚ {'import_envs
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ 0.026772, 're
â”‚             â”‚ â”‚ 'restart': False}                              â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1584846 Output: 11105
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 30: Completed
â”‚ LLM         â”‚ ðŸ’¬ About to commit changes and produce a patch:
â”‚ Response    â”‚ - Stage all changes and unstage .bench_scratch to avoid includin
â”‚             â”‚ - Commit with the provided message.
â”‚             â”‚ - Generate a diff patch excluding .bench_scratch into model_patc
â”‚             â”‚
â”‚             â”‚ Proceeding to run these git commands.
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': "git -C                            â”‚  Optimize MoE
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚  3 files chan
â”‚             â”‚ â”‚ add -A && git -C                               â”‚ deletions(-)
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ reset -q .bench_scratch || true && git -C      â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ commit -m 'Optimize MoE align sum kernels      â”‚
â”‚             â”‚ â”‚ performance' && git -C                         â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ diff $(git -C                                  â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ merge-base HEAD origin/HEAD || git -C          â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ rev-parse HEAD~1) -- .                         â”‚
â”‚             â”‚ â”‚ ':(exclude).bench_scratch' >                   â”‚
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚
â”‚             â”‚ â”‚ || true", 'restart': False}                    â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1660794 Output: 11726
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 31: Completed
â”‚ LLM         â”‚ ðŸ’¬ Re-running the timing script post-commit to record current me
â”‚ Response    â”‚
â”‚ Tools       â”‚ ðŸ”§ bash
â”‚ bash        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚             â”‚ â”‚ {'command': 'python                            â”‚ {'import_envs
â”‚             â”‚ â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-â€¦ â”‚ 0.026441, 're
â”‚             â”‚ â”‚ 'restart': False}                              â”‚
â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Total       â”‚ Input: 1737433 Output: 11882
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 32: Completed
â”‚ LLM         â”‚ ðŸ’¬ - Planned and executed performance-oriented edits in allowed
â”‚ Response    â”‚ vllm/envs.py.
â”‚             â”‚ - Created and ran .bench_scratch/test_opt.py to record timings f
â”‚             â”‚
â”‚             â”‚ Repository exploration and initial scan:
â”‚             â”‚ - Ran grep scan as requested: no torch.zeros/fill_ matches in pr
â”‚             â”‚ - Identified and removed erroneous, performance-harmful injected
â”‚             â”‚ and vllm/envs.py that referenced torch.empty/fill_ with invalid
â”‚             â”‚
â”‚             â”‚ Performance changes implemented (3+ concrete optimizations):
â”‚             â”‚ 1) vllm/config.py: Hybrid KV cache manager behavior with chunked
â”‚             â”‚ - Changed logic so that when attention_chunk_size is set:
â”‚             â”‚   - If speculative_config.use_eagle(): disable hybrid KV cache m
â”‚             â”‚   - Else if not envs.VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_K
â”‚             â”‚ due to known latency regression.
â”‚             â”‚ - This reduces latency regressions for chunked local attention w
â”‚             â”‚ provides opt-in via env var.
â”‚             â”‚
â”‚             â”‚ 2) vllm/envs.py: New environment variable control
â”‚             â”‚ - Added environment variable:
â”‚             â”‚   - VLLM_ALLOW_CHUNKED_LOCAL_ATTN_WITH_HYBRID_KV_CACHE (default
â”‚             â”‚   - Enables users to override the default disabling and opt back
â”‚             â”‚ - Integrated into config logic above.
â”‚             â”‚
â”‚             â”‚ 3) Code cleanups removing unnecessary/invalid tensor allocation
â”‚             â”‚ - Removed injected â€œoptimized_tensor_allocationâ€ function and st
â”‚             â”‚   - vllm/config.py (restored correct __post_init__ flow)
â”‚             â”‚   - vllm/envs.py (restored env var dictionary integrity)
â”‚             â”‚ - These removals eliminate bogus allocations and broken control
â”‚             â”‚ initialization overhead.
â”‚             â”‚
â”‚             â”‚ Timing script
â”‚             â”‚ - Created and adjusted script at:
â”‚             â”‚   /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents
â”‚             â”‚ - Measures envs import time, repeated env lookups, and reloads (
â”‚             â”‚   Example run:
â”‚             â”‚   {'import_envs_s': 0.8711, 'env_lookup_10k_s': 0.026772, 'reloa
â”‚             â”‚   {'import_envs_s': 0.90675, 'env_lookup_10k_s': 0.026441, 'relo
â”‚             â”‚
â”‚             â”‚ Build/commit/patch
â”‚             â”‚ - Staged, committed, and generated patch excluding .bench_scratc
â”‚             â”‚   Commit: Optimize MoE align sum kernels performance
â”‚             â”‚   Patch:
â”‚             â”‚ /home/raven/coding-mess/kernel-corp/OmniPerf-Bench/perf-agents-b
â”‚             â”‚
â”‚             â”‚ Next steps/recommendations
â”‚             â”‚ - If further optimization is needed for actual attention kernels
â”‚             â”‚ hook into scheduler/kernel selection, but thatâ€™s beyond the allo
â”‚             â”‚ - If you want me to run linters or tests, provide the repoâ€™s spe
â”‚             â”‚
â”‚             â”‚ Completed changes:
â”‚             â”‚ - vllm/config.py: restructuring hybrid KV cache + chunked local
â”‚             â”‚ tensor-allocation code.
â”‚             â”‚ - vllm/envs.py: added env variable VLLM_ALLOW_CHUNKED_LOCAL_ATTN
â”‚             â”‚ injected invalid code.
â”‚             â”‚
â”‚             â”‚ All requested artifacts are in place and committed.
â”‚ Total       â”‚ Input: 1814390 Output: 13030
â”‚ Tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Status      â”‚ âœ… Step 33: Completed