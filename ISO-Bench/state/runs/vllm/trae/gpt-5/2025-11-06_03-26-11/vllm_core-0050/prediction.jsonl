{"instance_id": "vllm-project__vllm-8c1e77f", "model_patch": "diff --git a/vllm/v1/attention/backends/flash_attn.py b/vllm/v1/attention/backends/flash_attn.py\nindex 5f8535eaa..8596dc719 100644\n--- a/vllm/v1/attention/backends/flash_attn.py\n+++ b/vllm/v1/attention/backends/flash_attn.py\n@@ -135,6 +135,11 @@ class FlashAttentionImpl(AttentionImpl):\n         assert k_scale == 1.0 and v_scale == 1.0, (\n             \"key/v_scale is not supported in FlashAttention.\")\n \n+        # Reshape the query, key, and value tensors outside the custom op to reduce CPU overhead.\n+        query = query.view(-1, self.num_heads, self.head_size)\n+        key = key.view(-1, self.num_kv_heads, self.head_size)\n+        value = value.view(-1, self.num_kv_heads, self.head_size)\n+\n         output = torch.empty_like(query)\n         torch.ops.vllm.unified_v1_flash_attention(\n             output,\n@@ -153,7 +158,7 @@ class FlashAttentionImpl(AttentionImpl):\n             self.alibi_slopes,\n             self.logits_soft_cap,\n         )\n-        return output\n+        return output.view(-1, self.num_heads * self.head_size)\n \n \n def unified_v1_flash_attention(\n@@ -184,10 +189,6 @@ def unified_v1_flash_attention(\n     attn_metadata: FlashAttentionMetadata = current_metadata\n     num_actual_tokens = attn_metadata.num_actual_tokens\n \n-    # Reshape the query, key, and value tensors.\n-    query = query.view(-1, num_heads, head_size)\n-    key = key.view(-1, num_kv_heads, head_size)\n-    value = value.view(-1, num_kv_heads, head_size)\n \n     # Reshape the input keys and values and store them in the cache.\n     key_cache = kv_cache[0]\n@@ -218,11 +219,8 @@ def unified_v1_flash_attention(\n         block_table=attn_metadata.block_table,\n         softcap=logits_soft_cap,\n     )\n-    attn_output = attn_output.view(num_actual_tokens, -1)\n-    # TODO(woosuk): Optimize this.\n     output[:num_actual_tokens].copy_(attn_output)\n \n-\n def unified_v1_flash_attention_fake(\n     output: torch.Tensor,\n     query: torch.Tensor,\n", "model_name_or_path": "gpt-5-2025-08-07"}
