{"instance_id": "/home/ubuntu/OmniPerf-Bench/vllm__repo-20478c4", "model_patch": "diff --git a/vllm/core/block_manager.py b/vllm/core/block_manager.py\nindex 8b089a5..35b7325 100644\n--- a/vllm/core/block_manager.py\n+++ b/vllm/core/block_manager.py\n@@ -74,10 +74,11 @@ class BlockAllocator:\n             block.ref_count += 1\n             assert block.block_hash == block_hash\n             return block\n-        if block_hash not in self.cached_blocks:\n-            self.cached_blocks[block_hash] = self.allocate_block(\n-                block_hash, num_hashed_tokens)\n-        block = self.cached_blocks[block_hash]\n+        # Use get() to avoid double dictionary lookup\n+        block = self.cached_blocks.get(block_hash)\n+        if block is None:\n+            block = self.allocate_block(block_hash, num_hashed_tokens)\n+            self.cached_blocks[block_hash] = block\n         assert block.block_hash == block_hash\n         block.ref_count += 1\n         return block\n@@ -108,7 +109,8 @@ class BlockAllocator:\n             assert not self.contains_block(block_hash)\n             old_hash = block.block_hash\n             block.block_hash = block_hash\n-            del self.cached_blocks[old_hash]\n+            # Use pop to avoid double lookup\n+            self.cached_blocks.pop(old_hash)\n             self.cached_blocks[block_hash] = block\n \n \n@@ -349,8 +351,8 @@ class BlockSpaceManager:\n             block_table = self.block_tables[seq.seq_id]\n \n             for cpu_block in block_table:\n-                if cpu_block in mapping:\n-                    gpu_block = mapping[cpu_block]\n+                gpu_block = mapping.get(cpu_block)\n+                if gpu_block is not None:\n                     gpu_block.ref_count += 1\n                 else:\n                     gpu_block = self.gpu_allocator.allocate(\n@@ -379,8 +381,8 @@ class BlockSpaceManager:\n             block_table = self.block_tables[seq.seq_id]\n \n             for gpu_block in block_table:\n-                if gpu_block in mapping:\n-                    cpu_block = mapping[gpu_block]\n+                cpu_block = mapping.get(gpu_block)\n+                if cpu_block is not None:\n                     cpu_block.ref_count += 1\n                 else:\n                     cpu_block = self.cpu_allocator.allocate(\ndiff --git a/vllm/core/evictor.py b/vllm/core/evictor.py\nindex 1d81f5a..e2b6adb 100644\n--- a/vllm/core/evictor.py\n+++ b/vllm/core/evictor.py\n@@ -66,35 +66,21 @@ class LRUEvictor(Evictor):\n \n     # TODO: The performance of this evict function can be optimized further.\n     def evict(self) -> PhysicalTokenBlock:\n-        free_blocks: List[PhysicalTokenBlock] = list(self.free_table.values())\n-        if len(free_blocks) == 0:\n+        if len(self.free_table) == 0:\n             raise ValueError(\"No usable cache memory left\")\n \n-        # Find lowest timestamp\n-        lowest_timestamp = free_blocks[0].last_accessed\n-        for block in free_blocks:\n-            if block.last_accessed < lowest_timestamp:\n-                lowest_timestamp = block.last_accessed\n-\n-        # Find all blocks with the lowest timestamp\n-        least_recent: List[PhysicalTokenBlock] = []\n-        for block in free_blocks:\n-            if block.last_accessed == lowest_timestamp:\n-                least_recent.append(block)\n-\n-        # Find highest prefix count per block\n-        highest_num_hashed_tokens = 0\n-        for block in least_recent:\n-            if block.num_hashed_tokens > highest_num_hashed_tokens:\n-                highest_num_hashed_tokens = block.num_hashed_tokens\n-\n+        # Single-pass optimization: find block with lowest timestamp and highest num_hashed_tokens\n         evicted_block: Optional[PhysicalTokenBlock] = None\n-\n-        # Find the first block with the lowest timestamp\n-        for block in least_recent:\n-            if block.num_hashed_tokens == highest_num_hashed_tokens:\n+        lowest_timestamp = float('inf')\n+        highest_num_hashed_tokens = -1\n+        \n+        for block in self.free_table.values():\n+            if (block.last_accessed < lowest_timestamp or \n+                (block.last_accessed == lowest_timestamp and \n+                 block.num_hashed_tokens > highest_num_hashed_tokens)):\n                 evicted_block = block\n-                break\n+                lowest_timestamp = block.last_accessed\n+                highest_num_hashed_tokens = block.num_hashed_tokens\n \n         assert evicted_block is not None\n \n", "model_name_or_path": "gpt-5-2025-08-07"}
