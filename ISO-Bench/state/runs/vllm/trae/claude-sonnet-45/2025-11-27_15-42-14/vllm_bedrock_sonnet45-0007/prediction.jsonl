{"instance_id": "/home/ubuntu/OmniPerf-Bench/vllm__repo-a6d795d", "model_patch": "diff --git a/vllm/attention/ops/triton_unified_attention.py b/vllm/attention/ops/triton_unified_attention.py\nindex c65f09523..9a1855aea 100644\n--- a/vllm/attention/ops/triton_unified_attention.py\n+++ b/vllm/attention/ops/triton_unified_attention.py\n@@ -145,7 +145,19 @@ def kernel_unified_attention_2d(\n                               mask=query_mask_1,\n                               other=0.0)\n \n-    num_blocks = cdiv_fn(seq_len, BLOCK_SIZE)\n+    # compute the length of the longest sequence prefix spanned by any\n+    # query token in the current q_block (q_block_local_idx)\n+    max_seq_prefix_len = context_len + q_block_local_idx * BLOCK_Q + (\n+        BLOCK_M - 1) // num_queries_per_kv + 1\n+\n+    # adjust for potential padding in the last q_block by considering the\n+    # actual sequence length\n+    max_seq_prefix_len = tl.minimum(max_seq_prefix_len, seq_len)\n+\n+    # calculate the number of tiles (blocks) that need to be processed to\n+    # cover the longest sequence prefix (due to causal masking, blocks beyond\n+    # this prefix can be skipped)\n+    num_blocks = cdiv_fn(max_seq_prefix_len, BLOCK_SIZE)\n \n     # iterate through tiles\n     for j in range(0, num_blocks):\n@@ -362,7 +374,19 @@ def kernel_unified_attention_3d(\n                               mask=query_mask_1,\n                               other=0.0)\n \n-    num_blocks = cdiv_fn(seq_len, BLOCK_SIZE)\n+    # compute the length of the longest sequence prefix spanned by any\n+    # query token in the current q_block (q_block_local_idx)\n+    max_seq_prefix_len = context_len + q_block_local_idx * BLOCK_Q + (\n+        BLOCK_M - 1) // num_queries_per_kv + 1\n+\n+    # adjust for potential padding in the last q_block by considering the\n+    # actual sequence length\n+    max_seq_prefix_len = tl.minimum(max_seq_prefix_len, seq_len)\n+\n+    # calculate the number of tiles (blocks) that need to be processed to\n+    # cover the longest sequence prefix (due to causal masking, blocks beyond\n+    # this prefix can be skipped)\n+    num_blocks = cdiv_fn(max_seq_prefix_len, BLOCK_SIZE)\n \n     # iterate through tiles within current segment\n     for j in range(\n", "model_name_or_path": "gpt-5-2025-08-07"}
