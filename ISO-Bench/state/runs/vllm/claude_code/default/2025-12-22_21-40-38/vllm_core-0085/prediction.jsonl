{"instance_id": "vllm-project__vllm-90f1e55", "model_patch": "diff --git a/csrc/moe/moe_permute_unpermute_op.cu b/csrc/moe/moe_permute_unpermute_op.cu\nindex 13aecd800..e827d9b11 100644\n--- a/csrc/moe/moe_permute_unpermute_op.cu\n+++ b/csrc/moe/moe_permute_unpermute_op.cu\n@@ -49,7 +49,7 @@ void moe_permute(\n   auto permuted_experts_id = torch::empty_like(topk_ids);\n   auto dst_row_id2src_row_id_map = torch::empty_like(src_row_id2dst_row_id_map);\n   auto align_expert_first_token_offset =\n-      torch::zeros_like(expert_first_token_offset);\n+      torch::empty_like(expert_first_token_offset);\n \n   CubKeyValueSorter sorter{};\n   int64_t* valid_num_ptr = nullptr;\ndiff --git a/vllm/model_executor/layers/fused_moe/cutlass_moe.py b/vllm/model_executor/layers/fused_moe/cutlass_moe.py\nindex ff49d7bb7..44006f3fa 100644\n--- a/vllm/model_executor/layers/fused_moe/cutlass_moe.py\n+++ b/vllm/model_executor/layers/fused_moe/cutlass_moe.py\n@@ -136,11 +136,10 @@ def run_cutlass_moe_fp8(\n                                      dtype=torch.int32,\n                                      device=device)\n \n-        # With expert_map each Rank processes only a subset of experts. As\n-        # a result not all of a_map and c2 tensors are filled. We fill it\n-        # zeros for correctness.\n+        # With expert_map each Rank processes only a subset of experts.\n+        # The a_map tensor will be populated by get_cutlass_moe_mm_data.\n         if expert_map is not None:\n-            a_map = torch.zeros((local_topk_ids.numel()),\n+            a_map = torch.empty((local_topk_ids.numel()),\n                                 dtype=torch.int32,\n                                 device=device)\n         else:\n@@ -170,12 +169,6 @@ def run_cutlass_moe_fp8(\n         c2 = _resize_cache(workspace2, (M * topk, N))\n         c3 = _resize_cache(workspace13, (M * topk, K))\n \n-    if not per_act_token and (expert_map is not None or use_batched_format):\n-        # this is necessary to avoid imprecise scale calculation caused by\n-        # random data in the unused workspace. The workspace is unused when\n-        # this rank handles only partial tokens, or when it is batched .\n-        c1.fill_(0)\n-\n     ops.cutlass_moe_mm(c1, a1q, w1, a1q_scale, w1_scale, expert_offsets,\n                        problem_sizes1, ab_strides1, ab_strides1, c_strides1,\n                        per_act_token, per_out_ch)\n@@ -185,9 +178,6 @@ def run_cutlass_moe_fp8(\n     a2q, a2q_scale = ops.scaled_fp8_quant(\n         c2, a2_scale, use_per_token_if_dynamic=per_act_token)\n \n-    if expert_map is not None:\n-        c3.fill_(0)\n-\n     ops.cutlass_moe_mm(c3, a2q, w2, a2q_scale, w2_scale, expert_offsets,\n                        problem_sizes2, ab_strides2, ab_strides2, c_strides2,\n                        per_act_token, per_out_ch)\n", "model_name_or_path": "gpt-5-2025-08-07"}
