{"instance_id": "/home/ubuntu/OmniPerf-Bench/sglan__repo-60fdad7", "model_patch": "diff --git a/python/sglang/srt/disaggregation/mooncake/conn.py b/python/sglang/srt/disaggregation/mooncake/conn.py\nindex 824f767..896bfce 100644\n--- a/python/sglang/srt/disaggregation/mooncake/conn.py\n+++ b/python/sglang/srt/disaggregation/mooncake/conn.py\n@@ -81,7 +81,7 @@ class TransferInfo:\n     def from_zmq(cls, msg: List[bytes]):\n         if msg[4] == b\"\" and msg[5] == b\"\":\n             is_dummy = True\n-            dst_kv_indices = np.array([], dtype=np.int64)\n+            dst_kv_indices = np.empty(0, dtype=np.int64)\n             dst_aux_index = None\n         else:\n             dst_kv_indices = np.frombuffer(msg[4], dtype=np.int64)\n@@ -130,8 +130,10 @@ class MooncakeKVManager(BaseKVManager):\n         is_mla_backend: Optional[bool] = False,\n     ):\n         self.kv_args = args\n+        # Cache local IP to avoid repeated calls\n+        self.local_ip = get_local_ip_by_remote()\n         self.engine = MooncakeTransferEngine(\n-            hostname=get_local_ip_by_remote(),\n+            hostname=self.local_ip,\n             gpu_id=self.kv_args.gpu_id,\n             ib_device=self.kv_args.ib_device,\n         )\n@@ -188,7 +190,7 @@ class MooncakeKVManager(BaseKVManager):\n                 \"SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT\", 30\n             )\n         elif self.disaggregation_mode == DisaggregationMode.DECODE:\n-            self.heartbeat_failures = {}\n+            self.heartbeat_failures = defaultdict(int)\n             self.session_pool = defaultdict(requests.Session)\n             self.session_pool_lock = threading.Lock()\n             self.addr_to_rooms_tracker = defaultdict(set)\n@@ -244,15 +246,7 @@ class MooncakeKVManager(BaseKVManager):\n         )\n \n         num_layers = len(self.kv_args.kv_data_ptrs)\n-        layers_params = [\n-            (\n-                self.kv_args.kv_data_ptrs[layer_id],\n-                dst_kv_ptrs[layer_id],\n-                self.kv_args.kv_item_lens[layer_id],\n-            )\n-            for layer_id in range(num_layers)\n-        ]\n-\n+        \n         # Worker function for processing a single layer\n         def process_layer(src_ptr: int, dst_ptr: int, item_len: int) -> int:\n             for prefill_index, decode_index in zip(prefill_kv_blocks, dst_kv_blocks):\n@@ -270,11 +264,11 @@ class MooncakeKVManager(BaseKVManager):\n         futures = [\n             executor.submit(\n                 process_layer,\n-                src_ptr,\n-                dst_ptr,\n-                item_len,\n+                self.kv_args.kv_data_ptrs[layer_id],\n+                dst_kv_ptrs[layer_id],\n+                self.kv_args.kv_item_lens[layer_id],\n             )\n-            for (src_ptr, dst_ptr, item_len) in layers_params\n+            for layer_id in range(num_layers)\n         ]\n \n         for future in concurrent.futures.as_completed(futures):\n@@ -307,8 +301,9 @@ class MooncakeKVManager(BaseKVManager):\n         self, remote: str, dst_port: int, room: int, status: int\n     ):\n         if \":\" in remote:\n-            remote = remote.split(\":\")[0]\n-        self._connect(\"tcp://\" + remote + \":\" + str(dst_port)).send_multipart(\n+            remote = remote.split(\":\", 1)[0]\n+        endpoint = f\"tcp://{remote}:{dst_port}\"\n+        self._connect(endpoint).send_multipart(\n             [\n                 str(room).encode(\"ascii\"),\n                 str(status).encode(\"ascii\"),\n@@ -432,7 +427,7 @@ class MooncakeKVManager(BaseKVManager):\n \n     def start_prefill_thread(self):\n         self.rank_port = get_free_port()\n-        self.server_socket.bind(f\"tcp://{get_local_ip_by_remote()}:{self.rank_port}\")\n+        self.server_socket.bind(f\"tcp://{self.local_ip}:{self.rank_port}\")\n \n         def bootstrap_thread():\n             \"\"\"This thread recvs pre-alloc notification from the decode engine\"\"\"\n@@ -471,7 +466,7 @@ class MooncakeKVManager(BaseKVManager):\n \n     def start_decode_thread(self):\n         self.rank_port = get_free_port()\n-        self.server_socket.bind(f\"tcp://{get_local_ip_by_remote()}:{self.rank_port}\")\n+        self.server_socket.bind(f\"tcp://{self.local_ip}:{self.rank_port}\")\n \n         def decode_thread():\n             while True:\n@@ -489,7 +484,7 @@ class MooncakeKVManager(BaseKVManager):\n             while True:\n                 time.sleep(self.heartbeat_interval)\n                 with self.connection_lock:\n-                    addresses = list(self.prefill_dp_size_table.keys())\n+                    addresses = tuple(self.prefill_dp_size_table.keys())\n \n                 for bootstrap_addr in addresses:\n                     session = None\n@@ -504,9 +499,9 @@ class MooncakeKVManager(BaseKVManager):\n                         if response.status_code == 200:\n                             self.heartbeat_failures[bootstrap_addr] = 0\n \n-                            current_rooms = self.addr_to_rooms_tracker[\n+                            current_rooms = tuple(self.addr_to_rooms_tracker[\n                                 bootstrap_addr\n-                            ].copy()\n+                            ])\n \n                             for bootstrap_room in current_rooms:\n                                 # Remove KVPoll.Success requests from the tracker\n@@ -518,20 +513,16 @@ class MooncakeKVManager(BaseKVManager):\n                             logger.info(\n                                 f\"Attempting to reconnect to {bootstrap_addr}...\"\n                             )\n-                            self.heartbeat_failures[bootstrap_addr] = (\n-                                self.heartbeat_failures.get(bootstrap_addr, 0) + 1\n-                            )\n+                            self.heartbeat_failures[bootstrap_addr] += 1\n                             with self.session_pool_lock:\n                                 if bootstrap_addr in self.session_pool:\n                                     del self.session_pool[bootstrap_addr]\n                     except Exception:\n                         logger.info(f\"Attempting to reconnect to {bootstrap_addr}...\")\n-                        self.heartbeat_failures[bootstrap_addr] = (\n-                            self.heartbeat_failures.get(bootstrap_addr, 0) + 1\n-                        )\n+                        self.heartbeat_failures[bootstrap_addr] += 1\n \n                     if (\n-                        self.heartbeat_failures.get(bootstrap_addr, 0)\n+                        self.heartbeat_failures[bootstrap_addr]\n                         >= self.max_failures\n                     ):\n                         self._handle_node_failure(bootstrap_addr)\n@@ -615,7 +606,7 @@ class MooncakeKVManager(BaseKVManager):\n             \"role\": \"Prefill\",\n             \"tp_size\": self.tp_size,\n             \"dp_size\": self.dp_size,\n-            \"rank_ip\": get_local_ip_by_remote(),\n+            \"rank_ip\": self.local_ip,\n             \"rank_port\": self.rank_port,\n             \"engine_rank\": self.kv_args.engine_rank,\n         }\n@@ -635,9 +626,9 @@ class MooncakeKVManager(BaseKVManager):\n \n     def _handle_node_failure(self, failed_bootstrap_addr):\n         with self.connection_lock:\n-            keys_to_remove = [\n+            keys_to_remove = tuple(\n                 k for k in self.connection_pool if k.startswith(failed_bootstrap_addr)\n-            ]\n+            )\n             for k in keys_to_remove:\n                 del self.connection_pool[k]\n             if failed_bootstrap_addr in self.prefill_tp_size_table:\n@@ -921,25 +912,33 @@ class MooncakeKVReceiver(BaseKVReceiver):\n             return None, None\n \n     def _register_kv_args(self):\n+        # Pre-pack data pointers once outside the loop\n+        packed_kv_data_ptrs = b\"\".join(\n+            struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.kv_data_ptrs\n+        )\n+        packed_aux_data_ptrs = b\"\".join(\n+            struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.aux_data_ptrs\n+        )\n+        \n+        # Cache encoded values\n+        local_ip_encoded = self.kv_mgr.local_ip.encode(\"ascii\")\n+        rank_port_encoded = str(self.kv_mgr.rank_port).encode(\"ascii\")\n+        session_id_encoded = self.session_id.encode(\"ascii\")\n+        none_encoded = b\"None\"\n+        \n         for bootstrap_info in self.bootstrap_infos:\n             self.prefill_server_url = (\n                 f\"{bootstrap_info['rank_ip']}:{bootstrap_info['rank_port']}\"\n             )\n-            packed_kv_data_ptrs = b\"\".join(\n-                struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.kv_data_ptrs\n-            )\n-            packed_aux_data_ptrs = b\"\".join(\n-                struct.pack(\"Q\", ptr) for ptr in self.kv_mgr.kv_args.aux_data_ptrs\n-            )\n \n             sock, lock = self._connect(\"tcp://\" + self.prefill_server_url)\n             with lock:\n                 sock.send_multipart(\n                     [\n-                        \"None\".encode(\"ascii\"),\n-                        get_local_ip_by_remote().encode(\"ascii\"),\n-                        str(self.kv_mgr.rank_port).encode(\"ascii\"),\n-                        self.session_id.encode(\"ascii\"),\n+                        none_encoded,\n+                        local_ip_encoded,\n+                        rank_port_encoded,\n+                        session_id_encoded,\n                         packed_kv_data_ptrs,\n                         packed_aux_data_ptrs,\n                     ]\n@@ -956,6 +955,14 @@ class MooncakeKVReceiver(BaseKVReceiver):\n             return cls._socket_cache[endpoint], cls._socket_locks[endpoint]\n \n     def init(self, kv_indices: npt.NDArray[np.int64], aux_index: Optional[int] = None):\n+        # Cache encoded values\n+        bootstrap_room_encoded = str(self.bootstrap_room).encode(\"ascii\")\n+        local_ip_encoded = self.kv_mgr.local_ip.encode(\"ascii\")\n+        rank_port_encoded = str(self.kv_mgr.rank_port).encode(\"ascii\")\n+        session_id_encoded = self.session_id.encode(\"ascii\")\n+        required_dst_info_num_encoded = str(self.required_dst_info_num).encode(\"ascii\")\n+        aux_index_encoded = str(aux_index).encode(\"ascii\") if aux_index is not None else b\"\"\n+        \n         for bootstrap_info in self.bootstrap_infos:\n             self.prefill_server_url = (\n                 f\"{bootstrap_info['rank_ip']}:{bootstrap_info['rank_port']}\"\n@@ -966,13 +973,13 @@ class MooncakeKVReceiver(BaseKVReceiver):\n             with lock:\n                 sock.send_multipart(\n                     [\n-                        str(self.bootstrap_room).encode(\"ascii\"),\n-                        get_local_ip_by_remote().encode(\"ascii\"),\n-                        str(self.kv_mgr.rank_port).encode(\"ascii\"),\n-                        self.session_id.encode(\"ascii\"),\n+                        bootstrap_room_encoded,\n+                        local_ip_encoded,\n+                        rank_port_encoded,\n+                        session_id_encoded,\n                         kv_indices.tobytes() if not is_dummy else b\"\",\n-                        str(aux_index).encode(\"ascii\") if not is_dummy else b\"\",\n-                        str(self.required_dst_info_num).encode(\"ascii\"),\n+                        aux_index_encoded if not is_dummy else b\"\",\n+                        required_dst_info_num_encoded,\n                     ]\n                 )\n \n", "model_name_or_path": "gpt-5-2025-08-07"}
