{"instance_id": "/home/ubuntu/OmniPerf-Bench/sglan__repo-e822e59", "model_patch": "diff --git a/python/sglang/lang/interpreter.py b/python/sglang/lang/interpreter.py\nindex 00691ca50..8e3ab0b04 100644\n--- a/python/sglang/lang/interpreter.py\n+++ b/python/sglang/lang/interpreter.py\n@@ -256,9 +256,18 @@ class StreamExecutor:\n         ret = self.meta_info.get(name, None)\n         return ret\n \n-    def fork(self, number: int, position_ids_offset: Optional[List[int]] = None):\n-        self.submit(SglCommitLazy())\n-        self.sync()\n+    def fork(\n+        self,\n+        number: int,\n+        position_ids_offset: Optional[List[int]] = None,\n+        copy: bool = False,\n+    ):\n+        # Commit and sync only when duplicating state for multiple branches\n+        # or explicitly requesting a deep copy. This avoids unnecessary\n+        # synchronization overhead for the common fork(1) case.\n+        if int(number) > 1 or copy:\n+            self.submit(SglCommitLazy())\n+            self.sync()\n \n         number = int(number)\n \n@@ -641,15 +650,23 @@ class ProgramState:\n         yield\n         self.stream_executor.submit(SglVarScopeEnd(name))\n \n-    def fork(self, number: int = 1, position_ids_offset: Optional[List[int]] = None):\n-        stream_executors = self.stream_executor.fork(number, position_ids_offset)\n+    def fork(\n+        self,\n+        number: int = 1,\n+        position_ids_offset: Optional[List[int]] = None,\n+        copy: bool = False,\n+    ):\n+        stream_executors = self.stream_executor.fork(\n+            number, position_ids_offset, copy=copy\n+        )\n         states = [ProgramState(x) for x in stream_executors]\n         state_group = ProgramStateGroup(states, self)\n         return state_group\n \n     @contextmanager\n     def copy(self, position_ids_offset: Optional[List[int]] = None):\n-        state_group = self.fork(1, position_ids_offset)\n+        # Explicit copy requires a commit to ensure child has an isolated snapshot.\n+        state_group = self.fork(1, position_ids_offset, copy=True)\n         try:\n             yield state_group[0]\n         finally:\ndiff --git a/python/sglang/srt/managers/router/radix_cache.py b/python/sglang/srt/managers/router/radix_cache.py\nindex 7bb8a4b2a..367d37789 100644\n--- a/python/sglang/srt/managers/router/radix_cache.py\n+++ b/python/sglang/srt/managers/router/radix_cache.py\n@@ -8,8 +8,18 @@ import torch\n \n \n class TreeNode:\n+    __slots__ = (\n+        \"children\",\n+        \"parent\",\n+        \"key\",\n+        \"value\",\n+        \"ref_counter\",\n+        \"last_access_time\",\n+    )\n+\n     def __init__(self):\n-        self.children = defaultdict(TreeNode)\n+        # Use a regular dict since default creation is not relied upon.\n+        self.children = {}\n         self.parent = None\n         self.key = None\n         self.value = None\n@@ -120,7 +130,7 @@ class RadixCache:\n         if len(key) == 0:\n             return\n \n-        if key[0] in node.children.keys():\n+        if key[0] in node.children:\n             child = node.children[key[0]]\n             prefix_len = match(child.key, key)\n             if prefix_len < len(child.key):\n@@ -151,7 +161,7 @@ class RadixCache:\n         if len(key) == 0:\n             return 0\n \n-        if key[0] in node.children.keys():\n+        if key[0] in node.children:\n             child = node.children[key[0]]\n             prefix_len = match(child.key, key)\n \n@@ -183,10 +193,9 @@ class RadixCache:\n             self._print_helper(child, indent=indent + 2)\n \n     def _delete_leaf(self, node):\n-        for k, v in node.parent.children.items():\n-            if v == node:\n-                break\n-        del node.parent.children[k]\n+        # Node keys are guaranteed to be non-empty for leaves created by insert,\n+        # and the first element is the edge label from parent to this node.\n+        del node.parent.children[node.key[0]]\n         self.evictable_size_ -= len(node.key)\n \n     def _total_size_helper(self, node):\n", "model_name_or_path": "gpt-5-2025-08-07"}
