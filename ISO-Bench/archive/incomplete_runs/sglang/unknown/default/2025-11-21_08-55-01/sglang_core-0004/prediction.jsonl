{"instance_id": "/home/ubuntu/OmniPerf-Bench/sglan__repo-60fdad7", "model_patch": "diff --git a/python/sglang/srt/disaggregation/mooncake/conn.py b/python/sglang/srt/disaggregation/mooncake/conn.py\nindex 824f76709..44ac41dec 100644\n--- a/python/sglang/srt/disaggregation/mooncake/conn.py\n+++ b/python/sglang/srt/disaggregation/mooncake/conn.py\n@@ -553,21 +553,28 @@ class MooncakeKVManager(BaseKVManager):\n         assert self.disaggregation_mode == DisaggregationMode.PREFILL\n         assert not is_last or (is_last and aux_index is not None)\n \n-        if (\n-            bootstrap_room not in self.request_status\n-            or self.check_status(bootstrap_room) == KVPoll.Failed\n-        ):\n+        # Fast-path: avoid extra lookups and work when request already failed\n+        status = self.request_status.get(bootstrap_room)\n+        if status is None or status == KVPoll.Failed:\n             logger.debug(\n                 \"Request with bootstrap_room=%s already failed\", bootstrap_room\n             )\n             return\n \n-        # NOTE(shangming): sharding according to the dst_infos to make sure\n-        # requests with the same dst_sessions will be added into the same\n-        # queue, which enables early abort with failed sessions.\n-        dst_infos = self.transfer_infos[bootstrap_room].keys()\n-        session_port_sum = sum(int(session.split(\":\")[1]) for session in dst_infos)\n-        shard_idx = session_port_sum % len(self.transfer_queues)\n+        # If there is no transfer info for this room, this rank is a dummy rank\n+        # and has been marked success already; skip adding to queues.\n+        if bootstrap_room not in self.transfer_infos:\n+            return\n+\n+        # Shard according to dst infos to ensure requests with the same\n+        # dst sessions land in the same queue for early abort on failures.\n+        infos = self.transfer_infos[bootstrap_room]\n+        # Use dst_port from TransferInfo directly to avoid parsing from string keys\n+        port_sum = 0\n+        for req in infos.values():\n+            port_sum += int(req.dst_port)\n+        num_queues = len(self.transfer_queues)\n+        shard_idx = port_sum % num_queues\n \n         self.transfer_queues[shard_idx].put(\n             TransferKVChunk(\n@@ -578,7 +585,7 @@ class MooncakeKVManager(BaseKVManager):\n                 prefill_aux_index=aux_index,\n             )\n         )\n-        self.update_status(bootstrap_room, KVPoll.WaitingForInput)\n+        # No need to update status here; it is already set during bootstrapping\n \n     def check_status(self, bootstrap_room: int):\n         return self.request_status[bootstrap_room]\n", "model_name_or_path": "gpt-5-2025-08-07"}
